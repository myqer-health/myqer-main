<script>
function readHashSnapshot() {
  // parse #s=...&p=...
  const hash = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
  if (!hash) return null;
  const params = new URLSearchParams(hash);
  const s = params.get('s');  // signature (base64)
  const p = params.get('p');  // payload (base64)
  if (!s || !p) return null;
  return { sig: s, payload: p };
}

// optional: verify signature client-side only if you want (needs public verifier).
// For now we’ll trust the server signed it. If you want verify, expose a read-only
// public key and switch to an asymmetric signature.

function decodePayload(base64Text) {
  try {
    const json = atob(base64Text);
    return JSON.parse(json);
  } catch { return null; }
}

async function loadCard() {
  const code = codeFromPath();
  if (!code) { /* existing error UI */ return; }

  $('code').textContent = code;
  new QRCode($('qr'), { text: location.href, width: 180, height: 180 });

  const useOfflineFirst = !navigator.onLine;
  const hashSnap = readHashSnapshot();

  if (useOfflineFirst && hashSnap) {
    const data = decodePayload(hashSnap.payload);
    if (data) {
      bind({
        full_name:      data.fn,
        date_of_birth:  data.dob,
        blood_type:     data.bt,
        organ_donor:    data.od,
        allergies:      data.al,
        conditions:     data.cd,
        meds:           data.md,
        implants:       data.im,
        ice_contacts:   data.ic,
        triage:         'GREEN' // or compute, or include in payload
      });
      $('offline').textContent = [
        'MYQER — Emergency Snapshot',
        `Name: ${data.fn ?? '—'}`,
        `DOB: ${data.dob ?? '—'}`,
        `Blood: ${data.bt ?? '—'}`,
        `Allergies: ${data.al ?? '—'}`,
        `Conditions: ${data.cd ?? '—'}`,
        `Medications: ${data.md ?? '—'}`,
        `ICE: ${data.ic ?? '—'}`
      ].join('\n');
      return; // done
    }
  }

  // ONLINE path (or fallback when offline decode not available)
  try {
    const { data, error } = await sb.rpc('emergency_card_by_code', { p_code: code });
    if (error) throw error;
    const row = data?.[0];
    if (!row) throw new Error('Code not found');

    bind(row);

    // also refresh device-local snapshot for this browser
    const snap = [
      'MYQER — Emergency Snapshot',
      `Name: ${row.full_name ?? '—'}`,
      `DOB: ${row.date_of_birth ?? '—'}`,
      `Blood: ${row.blood_type ?? '—'}`,
      `Allergies: ${row.allergies ?? '—'}`,
      `Conditions: ${row.conditions ?? '—'}`,
      `Medications: ${row.meds ?? '—'}`,
      `ICE: ${row.ice_contacts ?? '—'}`
    ].join('\n');
    $('offline').textContent = snap;
    localStorage.setItem('myqer:offline-snapshot', snap);
  } catch (err) {
    $('err').style.display = 'block';
    $('err').textContent = 'Live lookup failed: ' + (err.message || err);

    // last-ditch: device-local cache (if any)
    $('offline').textContent =
      localStorage.getItem('myqer:offline-snapshot') || 'No cached snapshot.';
  }
}
loadCard();
</script>
