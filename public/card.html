<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MYQER Emergency Card</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-red-50 min-h-screen">
  <div class="bg-red-600 text-white p-4">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div class="flex items-center">
        <div class="text-2xl mr-3">ğŸš¨</div>
        <div>
          <h1 class="text-xl font-bold">EMERGENCY MEDICAL CARD</h1>
          <p class="text-red-100 text-sm">MYQER - Medical Information System</p>
        </div>
      </div>
      <div class="text-right">
        <select id="languageSelect" class="bg-red-700 text-white border border-red-500 rounded px-2 py-1 text-sm">
          <option value="en">ğŸ‡ºğŸ‡¸ EN</option><option value="es">ğŸ‡ªğŸ‡¸ ES</option><option value="fr">ğŸ‡«ğŸ‡· FR</option><option value="de">ğŸ‡©ğŸ‡ª DE</option>
        </select>
      </div>
    </div>
  </div>

  <div id="loading" class="flex items-center justify-center min-h-96">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
      <p class="text-gray-600">Loading emergency information...</p>
    </div>
  </div>

  <div id="error" class="hidden max-w-4xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-lg p-8 text-center">
      <div class="text-red-600 text-6xl mb-4">âš ï¸</div>
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Card Not Found</h2>
      <p class="text-gray-600 mb-6">This emergency card could not be found or may have been deactivated.</p>
      <p class="text-sm text-gray-500">If this is an emergency, please contact local emergency services immediately.</p>
    </div>
  </div>

  <div id="content" class="hidden max-w-4xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-lg mb-6 overflow-hidden">
      <div class="bg-red-600 text-white p-4"><h2 class="text-xl font-bold"><span class="mr-2">ğŸ‘¤</span> <span id="personalInfoTitle">PERSONAL INFORMATION</span></h2></div>
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label class="block text-sm font-medium text-gray-500 mb-1" id="nameLabel">Full Name</label><p id="fullName" class="text-lg font-semibold text-gray-900">-</p></div>
        <div><label class="block text-sm font-medium text-gray-500 mb-1" id="dobLabel">Date of Birth</label><p id="dob" class="text-lg text-gray-900">-</p></div>
        <div><label class="block text-sm font-medium text-gray-500 mb-1" id="countryLabel">Country</label><p id="country" class="text-lg text-gray-900">-</p></div>
        <div><label class="block text-sm font-medium text-gray-500 mb-1" id="idLabel">National ID</label><p id="nid" class="text-lg text-gray-900">-</p></div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg mb-6 overflow-hidden">
      <div class="bg-red-600 text-white p-4"><h2 class="text-xl font-bold"><span class="mr-2">ğŸ¥</span> <span id="medicalInfoTitle">MEDICAL INFORMATION</span></h2></div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div><label class="block text-sm font-medium text-gray-500 mb-1" id="bloodTypeLabel">Blood Type</label><p id="blood" class="text-2xl font-bold text-red-600">-</p></div>
          <div><label class="block text-sm font-medium text-gray-500 mb-1" id="organDonorLabel">Organ Donor</label><p id="donor" class="text-lg text-gray-900">-</p></div>
        </div>
        <div class="mb-6"><label class="block text-sm font-medium text-gray-500 mb-1" id="lifeSupportLabel">Life Support Preference</label><p id="life" class="text-lg text-gray-900">-</p></div>
        <div class="grid grid-cols-1 gap-6">
          <div class="bg-red-50 p-4 rounded-lg"><label class="block text-sm font-medium text-red-700 mb-2" id="allergiesLabel">ğŸš« ALLERGIES</label><p id="allergies" class="text-gray-900">-</p></div>
          <div class="bg-blue-50 p-4 rounded-lg"><label class="block text-sm font-medium text-blue-700 mb-2" id="conditionsLabel">ğŸ©º MEDICAL CONDITIONS</label><p id="conditions" class="text-gray-900">-</p></div>
          <div class="bg-green-50 p-4 rounded-lg"><label class="block text-sm font-medium text-green-700 mb-2" id="medicationsLabel">ğŸ’Š CURRENT MEDICATIONS</label><p id="meds" class="text-gray-900">-</p></div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg mb-6 overflow-hidden">
      <div class="bg-red-600 text-white p-4"><h2 class="text-xl font-bold"><span class="mr-2">ğŸ“</span> <span id="emergencyContactsTitle">EMERGENCY CONTACTS (ICE)</span></h2></div>
      <div id="contacts" class="p-6"><p class="text-gray-500 text-center py-8">No emergency contacts available</p></div>
    </div>

    <div class="bg-gray-100 rounded-lg p-4 text-center">
      <p class="text-sm text-gray-600 mb-2"><span id="generatedByLabel">Generated by</span> <b>MYQER</b> â€” <span id="emergencySystemLabel">Emergency Medical Information System</span></p>
      <p class="text-xs text-gray-500" id="emergencyInstructionLabel">In case of emergency, contact local emergency services immediately</p>
    </div>
  </div>

  <script type="module">
    // ğŸ”§ Set your Supabase URL to call the edge function
    const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';

    const translations = {
      en:{personalInfoTitle:"PERSONAL INFORMATION",medicalInfoTitle:"MEDICAL INFORMATION",emergencyContactsTitle:"EMERGENCY CONTACTS (ICE)",nameLabel:"Full Name",dobLabel:"Date of Birth",countryLabel:"Country",idLabel:"National ID",bloodTypeLabel:"Blood Type",organDonorLabel:"Organ Donor",lifeSupportLabel:"Life Support Preference",allergiesLabel:"ğŸš« ALLERGIES",conditionsLabel:"ğŸ©º MEDICAL CONDITIONS",medicationsLabel:"ğŸ’Š CURRENT MEDICATIONS",generatedByLabel:"Generated by",emergencySystemLabel:"Emergency Medical Information System",emergencyInstructionLabel:"In case of emergency, contact local emergency services immediately",yes:"Yes",no:"No",none:"None reported",noContacts:"No emergency contacts available"},
      es:{personalInfoTitle:"INFORMACIÃ“N PERSONAL",medicalInfoTitle:"INFORMACIÃ“N MÃ‰DICA",emergencyContactsTitle:"CONTACTOS DE EMERGENCIA (ICE)",nameLabel:"Nombre Completo",dobLabel:"Fecha de Nacimiento",countryLabel:"PaÃ­s",idLabel:"ID Nacional",bloodTypeLabel:"Tipo de Sangre",organDonorLabel:"Donante de Ã“rganos",lifeSupportLabel:"Preferencia de Soporte Vital",allergiesLabel:"ğŸš« ALERGIAS",conditionsLabel:"ğŸ©º CONDICIONES MÃ‰DICAS",medicationsLabel:"ğŸ’Š MEDICAMENTOS ACTUALES",generatedByLabel:"Generado por",emergencySystemLabel:"Sistema de InformaciÃ³n MÃ©dica de Emergencia",emergencyInstructionLabel:"En caso de emergencia, contacte a los servicios locales",yes:"SÃ­",no:"No",none:"Ninguno reportado",noContacts:"No hay contactos de emergencia disponibles"},
      fr:{personalInfoTitle:"INFORMATIONS PERSONNELLES",medicalInfoTitle:"INFORMATIONS MÃ‰DICALES",emergencyContactsTitle:"CONTACTS D'URGENCE (ICE)",nameLabel:"Nom Complet",dobLabel:"Date de Naissance",countryLabel:"Pays",idLabel:"ID National",bloodTypeLabel:"Groupe Sanguin",organDonorLabel:"Donneur d'Organes",lifeSupportLabel:"PrÃ©fÃ©rence de Soins Intensifs",allergiesLabel:"ğŸš« ALLERGIES",conditionsLabel:"ğŸ©º CONDITIONS MÃ‰DICALES",medicationsLabel:"ğŸ’Š MÃ‰DICAMENTS ACTUELS",generatedByLabel:"GÃ©nÃ©rÃ© par",emergencySystemLabel:"SystÃ¨me d'Information MÃ©dicale d'Urgence",emergencyInstructionLabel:"En cas d'urgence, contactez les services d'urgence",yes:"Oui",no:"Non",none:"Aucun signalÃ©",noContacts:"Aucun contact d'urgence disponible"},
      de:{personalInfoTitle:"PERSÃ–NLICHE INFORMATIONEN",medicalInfoTitle:"MEDIZINISCHE INFORMATIONEN",emergencyContactsTitle:"NOTFALLKONTAKTE (ICE)",nameLabel:"VollstÃ¤ndiger Name",dobLabel:"Geburtsdatum",countryLabel:"Land",idLabel:"Nationale ID",bloodTypeLabel:"Blutgruppe",organDonorLabel:"Organspender",lifeSupportLabel:"Lebenserhaltungs-PrÃ¤ferenz",allergiesLabel:"ğŸš« ALLERGIEN",conditionsLabel:"ğŸ©º MEDIZINISCHE BEDINGUNGEN",medicationsLabel:"ğŸ’Š AKTUELLE MEDIKAMENTE",generatedByLabel:"Erstellt von",emergencySystemLabel:"Notfall-Medizinisches Informationssystem",emergencyInstructionLabel:"Im Notfall lokalen Rettungsdienst anrufen",yes:"Ja",no:"Nein",none:"Keine gemeldet",noContacts:"Keine Notfallkontakte verfÃ¼gbar"}
    };

    const el = id=>document.getElementById(id);
    const L = ()=>translations[el('languageSelect').value]||translations.en;
    const code = new URLSearchParams(location.search).get('code');

    function setText(){
      const t=L();
      el('personalInfoTitle').textContent=t.personalInfoTitle; el('medicalInfoTitle').textContent=t.medicalInfoTitle; el('emergencyContactsTitle').textContent=t.emergencyContactsTitle;
      el('nameLabel').textContent=t.nameLabel; el('dobLabel').textContent=t.dobLabel; el('countryLabel').textContent=t.countryLabel; el('idLabel').textContent=t.idLabel;
      el('bloodTypeLabel').textContent=t.bloodTypeLabel; el('organDonorLabel').textContent=t.organDonorLabel; el('lifeSupportLabel').textContent=t.lifeSupportLabel;
      el('allergiesLabel').textContent=t.allergiesLabel; el('conditionsLabel').textContent=t.conditionsLabel; el('medicationsLabel').textContent=t.medicationsLabel;
      el('generatedByLabel').textContent=t.generatedByLabel; el('emergencySystemLabel').textContent=t.emergencySystemLabel; el('emergencyInstructionLabel').textContent=t.emergencyInstructionLabel;
    }

    async function load(){
      if(!code) return showError();
      try{
        const lang = el('languageSelect').value;
        const res = await fetch(`${SUPABASE_URL}/functions/v1/myqer-card-public?code=${encodeURIComponent(code)}&lang=${lang}`);
        if(!res.ok) throw new Error('Not found');
        const json = await res.json();
        setFrom(json);
        showContent();
      }catch(e){ showError(); }
    }

    function setFrom(json){
      const p=json.profile||{}, s=json.sections||{}, tt=L();
      el('fullName').textContent = p.full_name||'-';
      el('dob').textContent = p.dob||'-';
      el('country').textContent = p.country||'-';
      el('nid').textContent = p.national_id||'-';
      el('blood').textContent = (s.blood?.value)||'-';
      el('donor').textContent = (s.blood?.donor?tt.yes:tt.no);
      el('life').textContent = s.prefs?.life_support_pref||'-';
      el('allergies').textContent = (s.allergies?.items||[]).join(', ') || tt.none;
      el('conditions').textContent = (s.conditions?.items||[]).join(', ') || tt.none;
      el('meds').textContent = (s.meds?.items||[]).join(', ') || tt.none;
      const c = s.ice?.contacts||[];
      el('contacts').innerHTML = c.length? c.map(x=>`
        <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:mb-0">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="block text-sm font-medium text-gray-500 mb-1">Name</label><p class="text-lg font-semibold text-gray-900">${x.name||'-'}</p></div>
            <div><label class="block text-sm font-medium text-gray-500 mb-1">Relationship</label><p class="text-lg text-gray-900">${x.relation||'-'}</p></div>
            <div><label class="block text-sm font-medium text-gray-500 mb-1">Phone</label><p class="text-lg font-mono text-gray-900"><a class="text-red-600 hover:text-red-700" href="tel:${x.phone||''}">${x.phone||'-'}</a></p></div>
          </div>
        </div>`).join('') : `<p class="text-gray-500 text-center py-8">${tt.noContacts}</p>`;
    }

    function showContent(){ el('loading').classList.add('hidden'); el('error').classList.add('hidden'); el('content').classList.remove('hidden'); }
    function showError(){ el('loading').classList.add('hidden'); el('content').classList.add('hidden'); el('error').classList.remove('hidden'); }

    el('languageSelect').addEventListener('change',()=>{ setText(); load(); });
    setText(); load();
  </script>
</body>
</html>
