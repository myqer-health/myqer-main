<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MYQER Emergency Card</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script type="module">
/* ========= MYQER PUBLIC CARD (Edge Function + i18n + Voice + Cache) =========
  - Reads ?code= and ?lang= (optional)
  - Fetches from: https://tgddpmxpbgrzrbzpomou.supabase.co/functions/v1/card
  - Caches the last good payload to localStorage (offline support)
  - 10 languages + speech synthesis summary
============================================================================ */

const EDGE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co/functions/v1/card';

// ---------- i18n: 10 languages ----------
const t = {
  en:{yes:'Yes',no:'No',none:'None reported',personal:'PERSONAL INFORMATION',medical:'MEDICAL INFORMATION',contacts:'EMERGENCY CONTACTS (ICE)',name:'Full Name',dob:'Date of Birth',country:'Country',id:'National ID',blood:'Blood Type',donor:'Organ Donor',life:'Life Support Preference',allergies:'🚫 ALLERGIES',conditions:'🩺 MEDICAL CONDITIONS',meds:'💊 CURRENT MEDICATIONS',noContacts:'No emergency contacts available',generatedBy:'Generated by',system:'Emergency Medical Information System',instruction:'In case of emergency, contact local emergency services immediately',summaryPrefix:'Emergency card for'},
  es:{yes:'Sí',no:'No',none:'Ninguno reportado',personal:'INFORMACIÓN PERSONAL',medical:'INFORMACIÓN MÉDICA',contacts:'CONTACTOS DE EMERGENCIA (ICE)',name:'Nombre Completo',dob:'Fecha de Nacimiento',country:'País',id:'ID Nacional',blood:'Tipo de Sangre',donor:'Donante de Órganos',life:'Preferencia de Soporte Vital',allergies:'🚫 ALERGIAS',conditions:'🩺 CONDICIONES MÉDICAS',meds:'💊 MEDICAMENTOS ACTUALES',noContacts:'No hay contactos de emergencia disponibles',generatedBy:'Generado por',system:'Sistema de Información Médica de Emergencia',instruction:'En caso de emergencia, contacte inmediatamente a los servicios de emergencia locales',summaryPrefix:'Tarjeta de emergencia de'},
  fr:{yes:'Oui',no:'Non',none:'Aucun signalé',personal:'INFORMATIONS PERSONNELLES',medical:'INFORMATIONS MÉDICALES',contacts:"CONTACTS D'URGENCE (ICE)",name:'Nom Complet',dob:'Date de Naissance',country:'Pays',id:'ID National',blood:'Groupe Sanguin',donor:"Donneur d'Organes",life:'Préférence de Soins Intensifs',allergies:'🚫 ALLERGIES',conditions:'🩺 CONDITIONS MÉDICALES',meds:'💊 MÉDICAMENTS ACTUELS',noContacts:"Aucun contact d'urgence disponible",generatedBy:'Généré par',system:"Système d'Information Médicale d'Urgence",instruction:"En cas d'urgence, contactez immédiatement les services d'urgence locaux",summaryPrefix:"Carte d'urgence pour"},
  de:{yes:'Ja',no:'Nein',none:'Keine gemeldet',personal:'PERSÖNLICHE INFORMATIONEN',medical:'MEDIZINISCHE INFORMATIONEN',contacts:'NOTFALLKONTAKTE (ICE)',name:'Vollständiger Name',dob:'Geburtsdatum',country:'Land',id:'Nationale ID',blood:'Blutgruppe',donor:'Organspender',life:'Lebenserhaltungs-Präferenz',allergies:'🚫 ALLERGIEN',conditions:'🩺 MEDIZINISCHE BEDINGUNGEN',meds:'💊 AKTUELLE MEDIKAMENTE',noContacts:'Keine Notfallkontakte verfügbar',generatedBy:'Erstellt von',system:'Notfall-Medizinisches Informationssystem',instruction:'Im Notfall wenden Sie sich sofort an die örtlichen Rettungsdienste',summaryPrefix:'Notfallkarte für'},
  it:{yes:'Sì',no:'No',none:'Nessuna segnalazione',personal:'INFORMAZIONI PERSONALI',medical:'INFORMAZIONI MEDICHE',contacts:'CONTATTI DI EMERGENZA (ICE)',name:'Nome Completo',dob:'Data di Nascita',country:'Paese',id:'ID Nazionale',blood:'Gruppo Sanguigno',donor:'Donatore di Organi',life:'Preferenza di Supporto Vitale',allergies:'🚫 ALLERGIE',conditions:'🩺 CONDIZIONI MEDICHE',meds:'💊 FARMACI ATTUALI',noContacts:'Nessun contatto di emergenza disponibile',generatedBy:'Generato da',system:'Sistema di Informazioni Mediche di Emergenza',instruction:'In caso di emergenza, contattare immediatamente i servizi di emergenza locali',summaryPrefix:'Scheda di emergenza per'},
  hi:{yes:'हाँ',no:'नहीं',none:'कोई रिपोर्ट नहीं',personal:'व्यक्तिगत जानकारी',medical:'चिकित्सा जानकारी',contacts:'आपातकालीन संपर्क (ICE)',name:'पूरा नाम',dob:'जन्म तिथि',country:'देश',id:'राष्ट्रीय आईडी',blood:'रक्त समूह',donor:'अंग दाता',life:'जीवन रक्षक प्राथमिकता',allergies:'🚫 एलर्जी',conditions:'🩺 चिकित्सा स्थितियाँ',meds:'💊 वर्तमान दवाएँ',noContacts:'कोई आपातकालीन संपर्क उपलब्ध नहीं',generatedBy:'द्वारा जनरेट',system:'आपातकालीन चिकित्सा सूचना प्रणाली',instruction:'आपातकाल में, तुरंत स्थानीय आपातकालीन सेवाओं से संपर्क करें',summaryPrefix:'के लिए आपातकालीन कार्ड'},
  ar:{yes:'نعم',no:'لا',none:'لا يوجد',personal:'المعلومات الشخصية',medical:'المعلومات الطبية',contacts:'جهات الاتصال للطوارئ (ICE)',name:'الاسم الكامل',dob:'تاريخ الميلاد',country:'البلد',id:'الهوية الوطنية',blood:'فصيلة الدم',donor:'متبرع بالأعضاء',life:'تفضيل دعم الحياة',allergies:'🚫 الحساسية',conditions:'🩺 الحالات الطبية',meds:'💊 الأدوية الحالية',noContacts:'لا توجد جهات اتصال للطوارئ',generatedBy:'تم الإنشاء بواسطة',system:'نظام معلومات طبية للطوارئ',instruction:'في حالة الطوارئ، تواصل فوراً مع خدمات الطوارئ المحلية',summaryPrefix:'بطاقة طوارئ لـ'},
  zh:{yes:'是',no:'否',none:'无报告',personal:'个人信息',medical:'医疗信息',contacts:'紧急联系人（ICE）',name:'姓名',dob:'出生日期',country:'国家',id:'身份证号',blood:'血型',donor:'器官捐献者',life:'生命支持偏好',allergies:'🚫 过敏',conditions:'🩺 医疗状况',meds:'💊 当前用药',noContacts:'暂无紧急联系人',generatedBy:'由以下生成',system:'紧急医疗信息系统',instruction:'紧急情况下，请立即联系当地急救服务',summaryPrefix:'紧急卡片：'},
  hu:{yes:'Igen',no:'Nem',none:'Nincs megadva',personal:'SZEMÉLYES ADATOK',medical:'ORVOSI INFORMÁCIÓK',contacts:'SÜRGŐSSÉGI KAPCSOLATOK (ICE)',name:'Teljes név',dob:'Születési dátum',country:'Ország',id:'Nemzeti azonosító',blood:'Vércsoport',donor:'Szervdonor',life:'Életjelekkel kapcsolatos preferencia',allergies:'🚫 ALLERGIÁK',conditions:'🩺 ORVOSI ÁLLAPOTOK',meds:'💊 JELENLEGI GYÓGYSZEREK',noContacts:'Nincs sürgősségi kontakt',generatedBy:'Készítette',system:'Sürgősségi Orvosi Információs Rendszer',instruction:'Vészhelyzetben azonnal hívja a helyi segélyhívót',summaryPrefix:'Vészhelyzeti kártya:'},
  ro:{yes:'Da',no:'Nu',none:'Nimic raportat',personal:'INFORMAȚII PERSONALE',medical:'INFORMAȚII MEDICALE',contacts:'CONTACTE DE URGENȚĂ (ICE)',name:'Nume Complet',dob:'Data Nașterii',country:'Țară',id:'ID Național',blood:'Grupa Sanguină',donor:'Donator de Organe',life:'Preferință Suport Vital',allergies:'🚫 ALERGII',conditions:'🩺 AFECȚIUNI MEDICALE',meds:'💊 MEDICAȚIE CURENTĂ',noContacts:'Nu există contacte de urgență',generatedBy:'Generat de',system:'Sistem de Informații Medicale de Urgență',instruction:'În caz de urgență, contactați imediat serviciile de urgență locale',summaryPrefix:'Card de urgență pentru'}
};

// ---------- DOM ----------
const qs = (id)=>document.getElementById(id);
const loadingState = qs('loadingState');
const errorState   = qs('errorState');
const cardContent  = qs('cardContent');
const languageSelect = qs('languageSelect');
// Labels
const personalInfoTitle=qs('personalInfoTitle'), medicalInfoTitle=qs('medicalInfoTitle'), emergencyContactsTitle=qs('emergencyContactsTitle');
const nameLabel=qs('nameLabel'), dobLabel=qs('dobLabel'), countryLabel=qs('countryLabel'), idLabel=qs('idLabel');
const bloodTypeLabel=qs('bloodTypeLabel'), organDonorLabel=qs('organDonorLabel'), lifeSupportLabel=qs('lifeSupportLabel');
const allergiesLabel=qs('allergiesLabel'), conditionsLabel=qs('conditionsLabel'), medicationsLabel=qs('medicationsLabel');
const generatedByLabel=qs('generatedByLabel'), emergencySystemLabel=qs('emergencySystemLabel'), emergencyInstructionLabel=qs('emergencyInstructionLabel');
// Values
const fullName=qs('fullName'), dateOfBirth=qs('dateOfBirth'), country=qs('country'), nationalId=qs('nationalId');
const bloodType=qs('bloodType'), organDonor=qs('organDonor'), lifeSupportPref=qs('lifeSupportPref');
const allergies=qs('allergies'), conditions=qs('conditions'), medications=qs('medications');
const contactsContainer=qs('emergencyContacts');

// Optional voice button (id="voiceBtn") from your header
const voiceBtn = qs('voiceBtn');

// ---------- utils ----------
const urlParams = new URLSearchParams(location.search);
const code = urlParams.get('code');
const urlLang = (urlParams.get('lang')||'').toLowerCase();
let lang = (urlLang || localStorage.getItem('myqer_lang') || 'en');
if(!t[lang]) lang = 'en';
if(languageSelect) languageSelect.value = lang;

function L(){ return t[lang] || t.en; }

function setTexts(){
  const l=L();
  personalInfoTitle.textContent = l.personal;
  medicalInfoTitle.textContent  = l.medical;
  emergencyContactsTitle.textContent = l.contacts;
  nameLabel.textContent=l.name; dobLabel.textContent=l.dob; countryLabel.textContent=l.country; idLabel.textContent=l.id;
  bloodTypeLabel.textContent=l.blood; organDonorLabel.textContent=l.donor; lifeSupportLabel.textContent=l.life;
  allergiesLabel.textContent=l.allergies; conditionsLabel.textContent=l.conditions; medicationsLabel.textContent=l.meds;
  generatedByLabel.textContent=l.generatedBy; emergencySystemLabel.textContent=l.system; emergencyInstructionLabel.textContent=l.instruction;
}

function showCard(){ loadingState?.classList.add('hidden'); errorState?.classList.add('hidden'); cardContent?.classList.remove('hidden'); }
function showError(){ loadingState?.classList.add('hidden'); cardContent?.classList.add('hidden'); errorState?.classList.remove('hidden'); }

// ---------- render ----------
function renderProfile(p={}){
  fullName.textContent = p.full_name || '-';
  dateOfBirth.textContent = p.date_of_birth || '-';
  country.textContent = p.country || '-';
  nationalId.textContent = p.national_id || '-';
}
function renderHealth(h={}){
  const l=L();
  bloodType.textContent = h.blood_type || '-';
  organDonor.textContent = h.organ_donor ? l.yes : l.no;
  lifeSupportPref.textContent = h.life_support_pref || '-';
  allergies.textContent = (h.allergies && h.allergies.trim()) ? h.allergies : l.none;
  conditions.textContent = (h.conditions && h.conditions.trim()) ? h.conditions : l.none;
  medications.textContent = (h.meds && h.meds.trim()) ? h.meds : l.none;
}
function renderContacts(list=[]){
  const l=L();
  if(!list.length){
    contactsContainer.innerHTML = `<p class="text-gray-500 text-center py-8">${l.noContacts}</p>`;
    return;
  }
  contactsContainer.innerHTML = list.map(c=>`
    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:mb-0">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Name</label>
          <p class="text-lg font-semibold text-gray-900">${c.name || '-'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Relationship</label>
          <p class="text-lg text-gray-900">${c.relation || '-'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Phone</label>
          <p class="text-lg font-mono text-gray-900">
            ${c.phone ? `<a class="text-red-600 hover:text-red-700" href="tel:${c.phone}">${c.phone}</a>` : '-'}
          </p>
        </div>
      </div>
    </div>
  `).join('');
}

// ---------- voice summary ----------
function speakSummary(payload){
  try{
    const l=L();
    const p = payload?.profile || {};
    const h = payload?.health || {};
    const parts = [
      `${l.summaryPrefix} ${p.full_name||''}.`,
      h.blood_type ? `${l.blood}: ${h.blood_type}.` : '',
      h.allergies ? `${l.allergies.replace('🚫 ','')}: ${h.allergies}.` : '',
      h.conditions ? `${l.conditions.replace('🩺 ','')}: ${h.conditions}.` : '',
      h.meds ? `${l.meds.replace('💊 ','')}: ${h.meds}.` : ''
    ].filter(Boolean);
    const u = new SpeechSynthesisUtterance(parts.join(' '));
    // Map BCP47 tags roughly
    const langMap = { en:'en-US', es:'es-ES', fr:'fr-FR', de:'de-DE', it:'it-IT', hi:'hi-IN', ar:'ar-SA', zh:'zh-CN', hu:'hu-HU', ro:'ro-RO' };
    u.lang = langMap[lang] || 'en-US';
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){ console.warn('Speech failed', e); }
}
if(voiceBtn){
  voiceBtn.addEventListener('click', ()=>{
    const key = `myqer_public_${code}`;
    const cached = localStorage.getItem(key);
    if(!cached) return;
    speakSummary(JSON.parse(cached));
  });
}

// ---------- cache keys ----------
function cacheKey(){ return `myqer_public_${code}`; }

// ---------- language handling ----------
languageSelect?.addEventListener('change', ()=>{
  lang = (languageSelect.value||'en').toLowerCase();
  if(!t[lang]) lang='en';
  localStorage.setItem('myqer_lang', lang);
  setTexts();
  // Re-render donor yes/no text using current payload if cached
  const cached = localStorage.getItem(cacheKey());
  if(cached){
    const payload = JSON.parse(cached);
    renderHealth(payload.health||{});
  }
});

// ---------- boot ----------
(async function init(){
  if(!code){ showError(); return; }
  setTexts();

  // Try network, then fall back to cache
  try{
    const res = await fetch(`${EDGE_URL}?code=${encodeURIComponent(code)}&lang=${encodeURIComponent(lang)}`, {
      headers:{ 'Accept':'application/json' }
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const payload = await res.json(); // { profile, health, contacts }
    localStorage.setItem(cacheKey(), JSON.stringify(payload));
    renderProfile(payload.profile||{});
    renderHealth(payload.health||{});
    renderContacts(payload.contacts||[]);
    showCard();
  }catch(err){
    console.warn('Network failed, using cache if any:', err);
    const cached = localStorage.getItem(cacheKey());
    if(cached){
      const payload = JSON.parse(cached);
      renderProfile(payload.profile||{});
      renderHealth(payload.health||{});
      renderContacts(payload.contacts||[]);
      showCard();
    }else{
      showError();
    }
  }
})();
</script>
</body>
</html>
