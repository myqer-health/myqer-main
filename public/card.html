<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MYQER Emergency Card</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script type="module">
/* ========= PUBLIC EMERGENCY CARD (via Edge Function) =========
   What this does:
   - Reads ?code= from the URL
   - Calls your Edge Function: /functions/v1/card?code=...
   - Renders profile, health, and contacts
   - Handles language switching (EN/ES/FR/DE for now â€” add more if you like)
============================================================== */

const EDGE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co/functions/v1/card';

// --- Basic i18n (extend as needed) ---
const t = {
  en: {
    yes: 'Yes', no: 'No', none: 'None reported',
    personal: 'PERSONAL INFORMATION', medical: 'MEDICAL INFORMATION', contacts: 'EMERGENCY CONTACTS (ICE)',
    name: 'Full Name', dob: 'Date of Birth', country: 'Country', id: 'National ID',
    blood: 'Blood Type', donor: 'Organ Donor', life: 'Life Support Preference',
    allergies: 'ðŸš« ALLERGIES', conditions: 'ðŸ©º MEDICAL CONDITIONS', meds: 'ðŸ’Š CURRENT MEDICATIONS',
    noContacts: 'No emergency contacts available',
    generatedBy: 'Generated by', system: 'Emergency Medical Information System',
    instruction: 'In case of emergency, contact local emergency services immediately'
  },
  es: {
    yes: 'SÃ­', no: 'No', none: 'Ninguno reportado',
    personal: 'INFORMACIÃ“N PERSONAL', medical: 'INFORMACIÃ“N MÃ‰DICA', contacts: 'CONTACTOS DE EMERGENCIA (ICE)',
    name: 'Nombre Completo', dob: 'Fecha de Nacimiento', country: 'PaÃ­s', id: 'ID Nacional',
    blood: 'Tipo de Sangre', donor: 'Donante de Ã“rganos', life: 'Preferencia de Soporte Vital',
    allergies: 'ðŸš« ALERGIAS', conditions: 'ðŸ©º CONDICIONES MÃ‰DICAS', meds: 'ðŸ’Š MEDICAMENTOS ACTUALES',
    noContacts: 'No hay contactos de emergencia disponibles',
    generatedBy: 'Generado por', system: 'Sistema de InformaciÃ³n MÃ©dica de Emergencia',
    instruction: 'En caso de emergencia, contacte inmediatamente a los servicios de emergencia locales'
  },
  fr: {
    yes: 'Oui', no: 'Non', none: 'Aucun signalÃ©',
    personal: 'INFORMATIONS PERSONNELLES', medical: 'INFORMATIONS MÃ‰DICALES', contacts: "CONTACTS D'URGENCE (ICE)",
    name: 'Nom Complet', dob: 'Date de Naissance', country: 'Pays', id: 'ID National',
    blood: 'Groupe Sanguin', donor: "Donneur d'Organes", life: 'PrÃ©fÃ©rence de Soins Intensifs',
    allergies: 'ðŸš« ALLERGIES', conditions: 'ðŸ©º CONDITIONS MÃ‰DICALES', meds: 'ðŸ’Š MÃ‰DICAMENTS ACTUELS',
    noContacts: "Aucun contact d'urgence disponible",
    generatedBy: 'GÃ©nÃ©rÃ© par', system: "SystÃ¨me d'Information MÃ©dicale d'Urgence",
    instruction: "En cas d'urgence, contactez immÃ©diatement les services d'urgence locaux"
  },
  de: {
    yes: 'Ja', no: 'Nein', none: 'Keine gemeldet',
    personal: 'PERSÃ–NLICHE INFORMATIONEN', medical: 'MEDIZINISCHE INFORMATIONEN', contacts: 'NOTFALLKONTAKTE (ICE)',
    name: 'VollstÃ¤ndiger Name', dob: 'Geburtsdatum', country: 'Land', id: 'Nationale ID',
    blood: 'Blutgruppe', donor: 'Organspender', life: 'Lebenserhaltungs-PrÃ¤ferenz',
    allergies: 'ðŸš« ALLERGIEN', conditions: 'ðŸ©º MEDIZINISCHE BEDINGUNGEN', meds: 'ðŸ’Š AKTUELLE MEDIKAMENTE',
    noContacts: 'Keine Notfallkontakte verfÃ¼gbar',
    generatedBy: 'Erstellt von', system: 'Notfall-Medizinisches Informationssystem',
    instruction: 'Im Notfall wenden Sie sich sofort an die Ã¶rtlichen Rettungsdienste'
  }
};
let lang = 'en';

// --- DOM references (use your existing IDs) ---
const loadingState = document.getElementById('loadingState');
const errorState   = document.getElementById('errorState');
const cardContent  = document.getElementById('cardContent');
const languageSelect = document.getElementById('languageSelect');

// Text nodes
const personalInfoTitle = document.getElementById('personalInfoTitle');
const medicalInfoTitle  = document.getElementById('medicalInfoTitle');
const emergencyContactsTitle = document.getElementById('emergencyContactsTitle');
const nameLabel = document.getElementById('nameLabel');
const dobLabel  = document.getElementById('dobLabel');
const countryLabel = document.getElementById('countryLabel');
const idLabel = document.getElementById('idLabel');
const bloodTypeLabel = document.getElementById('bloodTypeLabel');
const organDonorLabel = document.getElementById('organDonorLabel');
const lifeSupportLabel = document.getElementById('lifeSupportLabel');
const allergiesLabel = document.getElementById('allergiesLabel');
const conditionsLabel = document.getElementById('conditionsLabel');
const medicationsLabel = document.getElementById('medicationsLabel');
const generatedByLabel = document.getElementById('generatedByLabel');
const emergencySystemLabel = document.getElementById('emergencySystemLabel');
const emergencyInstructionLabel = document.getElementById('emergencyInstructionLabel');

// Value nodes
const fullName = document.getElementById('fullName');
const dateOfBirth = document.getElementById('dateOfBirth');
const country = document.getElementById('country');
const nationalId = document.getElementById('nationalId');
const bloodType = document.getElementById('bloodType');
const organDonor = document.getElementById('organDonor');
const lifeSupportPref = document.getElementById('lifeSupportPref');
const allergies = document.getElementById('allergies');
const conditions = document.getElementById('conditions');
const medications = document.getElementById('medications');
const contactsContainer = document.getElementById('emergencyContacts');

// --- Helpers ---
function setTexts() {
  const L = t[lang] || t.en;
  personalInfoTitle.textContent = L.personal;
  medicalInfoTitle.textContent  = L.medical;
  emergencyContactsTitle.textContent = L.contacts;
  nameLabel.textContent = L.name;
  dobLabel.textContent  = L.dob;
  countryLabel.textContent = L.country;
  idLabel.textContent = L.id;
  bloodTypeLabel.textContent = L.blood;
  organDonorLabel.textContent = L.donor;
  lifeSupportLabel.textContent = L.life;
  allergiesLabel.textContent = L.allergies;
  conditionsLabel.textContent = L.conditions;
  medicationsLabel.textContent = L.meds;
  generatedByLabel.textContent = L.generatedBy;
  emergencySystemLabel.textContent = L.system;
  emergencyInstructionLabel.textContent = L.instruction;
}

function showCard(){ loadingState.classList.add('hidden'); errorState.classList.add('hidden'); cardContent.classList.remove('hidden'); }
function showError(){ loadingState.classList.add('hidden'); cardContent.classList.add('hidden'); errorState.classList.remove('hidden'); }

// --- Renderers ---
function renderProfile(p) {
  fullName.textContent   = p?.full_name || '-';
  dateOfBirth.textContent= p?.date_of_birth || '-';
  country.textContent    = p?.country || '-';
  nationalId.textContent = p?.national_id || '-';
}
function renderHealth(h) {
  const L = t[lang] || t.en;
  bloodType.textContent  = h?.blood_type || '-';
  lifeSupportPref.textContent = h?.life_support_pref || '-';
  organDonor.textContent = h?.organ_donor ? L.yes : L.no;
  allergies.textContent  = h?.allergies || L.none;
  conditions.textContent = h?.conditions || L.none;
  medications.textContent= h?.meds || L.none;
}
function renderContacts(list) {
  const L = t[lang] || t.en;
  if (!list || list.length === 0) {
    contactsContainer.innerHTML = `<p class="text-gray-500 text-center py-8">${L.noContacts}</p>`;
    return;
  }
  contactsContainer.innerHTML = list.map(c => `
    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:mb-0">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Name</label>
          <p class="text-lg font-semibold text-gray-900">${c.name || '-'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Relationship</label>
          <p class="text-lg text-gray-900">${c.relation || '-'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Phone</label>
          <p class="text-lg font-mono text-gray-900">
            ${c.phone ? `<a class="text-red-600 hover:text-red-700" href="tel:${c.phone}">${c.phone}</a>` : '-'}
          </p>
        </div>
      </div>
    </div>
  `).join('');
}

// --- Boot ---
const params = new URLSearchParams(window.location.search);
const code = params.get('code');

languageSelect?.addEventListener('change', () => {
  lang = languageSelect.value || 'en';
  setTexts(); // re-apply labels
  // values remain; donor Yes/No text already set from L in renderHealth
});

(async function init(){
  // Require ?code=
  if (!code) { showError(); return; }
  setTexts();
  try {
    const res = await fetch(`${EDGE_URL}?code=${encodeURIComponent(code)}`, {
      headers: { Accept: 'application/json' }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const payload = await res.json(); // { profile, health, contacts }

    renderProfile(payload.profile || {});
    renderHealth(payload.health || {});
    renderContacts(payload.contacts || []);
    showCard();
  } catch (err){
    console.error('Card load failed:', err);
    showError();
  }
})();
</script>
</body>
</html>
