<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>MYQER — Emergency Card</title>

  <!-- Minimal styles (kept inline so the page still looks fine offline) -->
  <style>
    :root{
      --bg:#fafafa; --ink:#222; --muted:#6b7280;
      --red:#e53935; --amber:#fb8c00; --green:#43a047; --border:#e5e7eb;
      --pill:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:760px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:700;letter-spacing:0.5px}
    .status{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--pill);color:var(--muted);border:1px solid var(--border)}
    .status[data-state="ONLINE"]{color:#0ea5e9;border-color:#bae6fd;background:#e0f2fe}
    .status[data-state="OFFLINE"]{color:#ef4444;border-color:#fecaca;background:#fee2e2}
    .status[data-state="CACHED"]{color:#f59e0b;border-color:#fde68a;background:#fef3c7}
    .card{background:#fff;border:2px solid var(--border);border-radius:16px;overflow:hidden}
    .card[data-triage="RED"]{border-color:var(--red)}
    .card[data-triage="AMBER"]{border-color:var(--amber)}
    .card[data-triage="GREEN"]{border-color:var(--green)}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:#fff}
    .triage{font-weight:700;font-size:12px;border-radius:999px;padding:6px 10px;border:1px solid var(--border)}
    .card[data-triage="RED"] .triage{color:#fff;background:var(--red);border-color:var(--red)}
    .card[data-triage="AMBER"] .triage{color:#fff;background:var(--amber);border-color:var(--amber)}
    .card[data-triage="GREEN"] .triage{color:#fff;background:var(--green);border-color:var(--green)}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;color:var(--muted)}
    .body{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:8px;align-items:flex-start;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    .label{min-width:140px;font-weight:600;color:#374151}
    .val{flex:1}
    .muted{color:var(--muted)}
    .foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .tiny{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}
  </style>

  <!-- Supabase JS (v2) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MYQER™ — Emergency Card</div>
      <div id="netStatus" class="status" data-state="ONLINE">ONLINE</div>
    </header>

    <section id="cardRoot" class="card" data-triage="GREEN" aria-live="polite">
      <div class="bar">
        <span id="triagePill" class="triage">GREEN</span>
        <span class="code">Code: <span id="codeSpan">—</span></span>
      </div>

      <div class="body">
        <div class="grid">
          <div class="row"><div class="label">Name</div>             <div id="name"      class="val muted">—</div></div>
          <div class="row"><div class="label">Date of Birth</div>    <div id="dob"       class="val muted">—</div></div>
          <div class="row"><div class="label">Blood Type</div>       <div id="blood"     class="val muted">—</div></div>
          <div class="row"><div class="label">Organ Donor</div>      <div id="donor"     class="val muted">—</div></div>
          <div class="row"><div class="label">Allergies</div>        <div id="allergies" class="val muted">—</div></div>
          <div class="row"><div class="label">Medical Conditions</div><div id="conditions" class="val muted">—</div></div>
          <div class="row"><div class="label">Medications</div>      <div id="meds"      class="val muted">—</div></div>
          <div class="row"><div class="label">Implants & Devices</div><div id="implants" class="val muted">—</div></div>
          <div class="row"><div class="label">Emergency Contacts</div><div id="ice"      class="val muted">—</div></div>
        </div>
      </div>

      <div class="foot">
        <div class="tiny">Last updated: <span id="updated">—</span></div>
        <div class="actions">
          <button class="btn" id="refreshBtn">Refresh</button>
          <button class="btn" id="printBtn">Print</button>
          <button class="btn" id="copyBtn">Copy URL</button>
        </div>
      </div>
    </section>

    <p class="tiny" style="margin-top:12px">
      Read-only emergency info. Always verify clinically before treatment.
    </p>
  </div>

  <script>
    // ---- Supabase client (your project) ----
    const SUPABASE_URL = "https://dmntmhkncldgynufajei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- Helpers ----
    const $ = (id)=>document.getElementById(id);
    const cardRoot   = $("cardRoot");
    const triagePill = $("triagePill");
    const statusEl   = $("netStatus");

    function getCodeFromURL(){
      const u = new URL(window.location.href);
      // support /c/CODE AND ?code=CODE
      const q = u.searchParams.get("code");
      if (q) return q.trim();
      const parts = u.pathname.split("/").filter(Boolean);
      // e.g. /c/CODE or /card/CODE
      return (parts[0]==="c" || parts[0]==="card") ? (parts[1]||"").trim() : parts[parts.length-1] || "";
    }
    const CODE = getCodeFromURL();
    $("codeSpan").textContent = CODE || "—";

    const LS_KEY = (code)=>`myqer:snapshot:${(code||"").toUpperCase()}`;

    function renderCard(card, source){
      // Text fields
      $("name").textContent       = card?.full_name      ?? "—";
      $("dob").textContent        = card?.date_of_birth  ?? "—";
      $("blood").textContent      = card?.blood_type     ?? "—";
      $("donor").textContent      = card?.organ_donor ? "Yes" : "No";
      $("allergies").textContent  = card?.allergies      ?? "—";
      $("conditions").textContent = card?.conditions     ?? "—";
      $("meds").textContent       = card?.meds           ?? "—";
      $("implants").textContent   = card?.implants       ?? "—";
      $("ice").textContent        = (card?.ice_contacts || "").trim() || "No contacts available";

      // Triage
      const triage = (card?.triage || "GREEN").toUpperCase();
      cardRoot.dataset.triage = triage;
      triagePill.textContent = triage;

      // Updated at
      const ts = card?.updated_at ? new Date(card.updated_at) : null;
      $("updated").textContent = ts ? ts.toLocaleString() : "—";

      // Status badge
      if (source === "online"){
        statusEl.dataset.state = "ONLINE";
        statusEl.textContent = "ONLINE";
      } else if (source === "cache"){
        statusEl.dataset.state = "CACHED";
        statusEl.textContent = "CACHED (offline snapshot)";
      } else if (source === "offline"){
        statusEl.dataset.state = "OFFLINE";
        statusEl.textContent = "OFFLINE";
      }
      // mute placeholders vs real values
      document.querySelectorAll(".val").forEach(el=>{
        el.classList.toggle("muted", el.textContent.trim()==="—");
      });
    }

    function cacheSnapshot(code, payload){
      try{
        const data = { saved_at: Date.now(), payload };
        localStorage.setItem(LS_KEY(code), JSON.stringify(data));
      }catch(e){ /* ignore quota */ }
    }
    function readSnapshot(code){
      try{
        const raw = localStorage.getItem(LS_KEY(code));
        if (!raw) return null;
        return JSON.parse(raw)?.payload || null;
      }catch(_){ return null; }
    }

    async function fetchOnline(code){
      const { data, error } = await sb.rpc("emergency_card_by_code", { p_code: code });
      if (error) throw error;
      const card = data?.[0] || null;
      if (card) cacheSnapshot(code, card);
      return card;
    }

    async function load(){
      if (!CODE){
        renderCard(null, "offline");
        return;
      }
      // Try cache immediately so the page is not blank offline
      const cached = readSnapshot(CODE);
      if (cached){
        renderCard(cached, navigator.onLine ? "cache" : "offline");
      }

      // If we’re online, try to refresh from the backend
      if (navigator.onLine){
        try{
          const fresh = await fetchOnline(CODE);
          if (fresh) renderCard(fresh, "online");
        }catch(e){
          // if fetch fails but we had cache, keep showing cache
          if (!cached) renderCard(null, "offline");
          console.error("RPC error:", e);
          statusEl.dataset.state = "CACHED";
          statusEl.textContent = cached ? "CACHED (RPC error)" : "OFFLINE";
        }
      }else{
        statusEl.dataset.state = cached ? "CACHED" : "OFFLINE";
        statusEl.textContent = cached ? "CACHED (offline)" : "OFFLINE";
      }
    }

    // Buttons
    $("refreshBtn").addEventListener("click", async ()=>{
      statusEl.dataset.state = "ONLINE";
      statusEl.textContent = "ONLINE";
      try{
        const fresh = await fetchOnline(CODE);
        if (fresh) renderCard(fresh, "online");
      }catch(e){
        console.error(e);
        const cached = readSnapshot(CODE);
        renderCard(cached, cached ? "cache" : "offline");
      }
    });
    $("printBtn").addEventListener("click", ()=>window.print());
    $("copyBtn").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(window.location.href);
        $("copyBtn").textContent = "Copied!";
        setTimeout(()=> $("copyBtn").textContent = "Copy URL", 1200);
      }catch(_){ /* ignore */ }
    });

    // Online/offline events update the pill
    window.addEventListener("online",  ()=>{ statusEl.dataset.state="ONLINE";  statusEl.textContent="ONLINE";  });
    window.addEventListener("offline", ()=>{ statusEl.dataset.state="OFFLINE"; statusEl.textContent="OFFLINE"; });

    // Kick off
    load();

    // ---- Tiny service worker (inline) to cache this page for offline page-loads ----
    // This keeps things in one file. It caches the current URL and serves it when offline.
    if ("serviceWorker" in navigator) {
      const swCode = `
        const CACHE='myqer-card-v1';
        self.addEventListener('install', e=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll([self.location.href])));
          self.skipWaiting();
        });
        self.addEventListener('activate', e=>self.clients.claim());
        self.addEventListener('fetch', e=>{
          const req=e.request;
          // Network-first for everything; fallback to cache if offline.
          e.respondWith(
            fetch(req).catch(()=>caches.match(req,{ignoreSearch:true}).then(r=>r || caches.match(self.location.href)))
          );
        });
      `;
      const blob = new Blob([swCode], { type: "text/javascript" });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }
  </script>
</body>
</html>
