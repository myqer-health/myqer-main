<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MYQER Emergency Card</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script type="module">
/* ========= MYQER PUBLIC CARD (Edge Function + i18n + Voice + Cache) =========
  - Reads ?code= and ?lang= (optional)
  - Fetches from: https://tgddpmxpbgrzrbzpomou.supabase.co/functions/v1/card
  - Caches the last good payload to localStorage (offline support)
  - 10 languages + speech synthesis summary
============================================================================ */

const EDGE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co/functions/v1/card';

// ---------- i18n: 10 languages ----------
const t = {
  en:{yes:'Yes',no:'No',none:'None reported',personal:'PERSONAL INFORMATION',medical:'MEDICAL INFORMATION',contacts:'EMERGENCY CONTACTS (ICE)',name:'Full Name',dob:'Date of Birth',country:'Country',id:'National ID',blood:'Blood Type',donor:'Organ Donor',life:'Life Support Preference',allergies:'ðŸš« ALLERGIES',conditions:'ðŸ©º MEDICAL CONDITIONS',meds:'ðŸ’Š CURRENT MEDICATIONS',noContacts:'No emergency contacts available',generatedBy:'Generated by',system:'Emergency Medical Information System',instruction:'In case of emergency, contact local emergency services immediately',summaryPrefix:'Emergency card for'},
  es:{yes:'SÃ­',no:'No',none:'Ninguno reportado',personal:'INFORMACIÃ“N PERSONAL',medical:'INFORMACIÃ“N MÃ‰DICA',contacts:'CONTACTOS DE EMERGENCIA (ICE)',name:'Nombre Completo',dob:'Fecha de Nacimiento',country:'PaÃ­s',id:'ID Nacional',blood:'Tipo de Sangre',donor:'Donante de Ã“rganos',life:'Preferencia de Soporte Vital',allergies:'ðŸš« ALERGIAS',conditions:'ðŸ©º CONDICIONES MÃ‰DICAS',meds:'ðŸ’Š MEDICAMENTOS ACTUALES',noContacts:'No hay contactos de emergencia disponibles',generatedBy:'Generado por',system:'Sistema de InformaciÃ³n MÃ©dica de Emergencia',instruction:'En caso de emergencia, contacte inmediatamente a los servicios de emergencia locales',summaryPrefix:'Tarjeta de emergencia de'},
  fr:{yes:'Oui',no:'Non',none:'Aucun signalÃ©',personal:'INFORMATIONS PERSONNELLES',medical:'INFORMATIONS MÃ‰DICALES',contacts:"CONTACTS D'URGENCE (ICE)",name:'Nom Complet',dob:'Date de Naissance',country:'Pays',id:'ID National',blood:'Groupe Sanguin',donor:"Donneur d'Organes",life:'PrÃ©fÃ©rence de Soins Intensifs',allergies:'ðŸš« ALLERGIES',conditions:'ðŸ©º CONDITIONS MÃ‰DICALES',meds:'ðŸ’Š MÃ‰DICAMENTS ACTUELS',noContacts:"Aucun contact d'urgence disponible",generatedBy:'GÃ©nÃ©rÃ© par',system:"SystÃ¨me d'Information MÃ©dicale d'Urgence",instruction:"En cas d'urgence, contactez immÃ©diatement les services d'urgence locaux",summaryPrefix:"Carte d'urgence pour"},
  de:{yes:'Ja',no:'Nein',none:'Keine gemeldet',personal:'PERSÃ–NLICHE INFORMATIONEN',medical:'MEDIZINISCHE INFORMATIONEN',contacts:'NOTFALLKONTAKTE (ICE)',name:'VollstÃ¤ndiger Name',dob:'Geburtsdatum',country:'Land',id:'Nationale ID',blood:'Blutgruppe',donor:'Organspender',life:'Lebenserhaltungs-PrÃ¤ferenz',allergies:'ðŸš« ALLERGIEN',conditions:'ðŸ©º MEDIZINISCHE BEDINGUNGEN',meds:'ðŸ’Š AKTUELLE MEDIKAMENTE',noContacts:'Keine Notfallkontakte verfÃ¼gbar',generatedBy:'Erstellt von',system:'Notfall-Medizinisches Informationssystem',instruction:'Im Notfall wenden Sie sich sofort an die Ã¶rtlichen Rettungsdienste',summaryPrefix:'Notfallkarte fÃ¼r'},
  it:{yes:'SÃ¬',no:'No',none:'Nessuna segnalazione',personal:'INFORMAZIONI PERSONALI',medical:'INFORMAZIONI MEDICHE',contacts:'CONTATTI DI EMERGENZA (ICE)',name:'Nome Completo',dob:'Data di Nascita',country:'Paese',id:'ID Nazionale',blood:'Gruppo Sanguigno',donor:'Donatore di Organi',life:'Preferenza di Supporto Vitale',allergies:'ðŸš« ALLERGIE',conditions:'ðŸ©º CONDIZIONI MEDICHE',meds:'ðŸ’Š FARMACI ATTUALI',noContacts:'Nessun contatto di emergenza disponibile',generatedBy:'Generato da',system:'Sistema di Informazioni Mediche di Emergenza',instruction:'In caso di emergenza, contattare immediatamente i servizi di emergenza locali',summaryPrefix:'Scheda di emergenza per'},
  hi:{yes:'à¤¹à¤¾à¤',no:'à¤¨à¤¹à¥€à¤‚',none:'à¤•à¥‹à¤ˆ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤¨à¤¹à¥€à¤‚',personal:'à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤—à¤¤ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€',medical:'à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€',contacts:'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤• (ICE)',name:'à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®',dob:'à¤œà¤¨à¥à¤® à¤¤à¤¿à¤¥à¤¿',country:'à¤¦à¥‡à¤¶',id:'à¤°à¤¾à¤·à¥à¤Ÿà¥à¤°à¥€à¤¯ à¤†à¤ˆà¤¡à¥€',blood:'à¤°à¤•à¥à¤¤ à¤¸à¤®à¥‚à¤¹',donor:'à¤…à¤‚à¤— à¤¦à¤¾à¤¤à¤¾',life:'à¤œà¥€à¤µà¤¨ à¤°à¤•à¥à¤·à¤• à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾',allergies:'ðŸš« à¤à¤²à¤°à¥à¤œà¥€',conditions:'ðŸ©º à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¸à¥à¤¥à¤¿à¤¤à¤¿à¤¯à¤¾à¤',meds:'ðŸ’Š à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤¦à¤µà¤¾à¤à¤',noContacts:'à¤•à¥‹à¤ˆ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤¨à¤¹à¥€à¤‚',generatedBy:'à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤œà¤¨à¤°à¥‡à¤Ÿ',system:'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¸à¥‚à¤šà¤¨à¤¾ à¤ªà¥à¤°à¤£à¤¾à¤²à¥€',instruction:'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤² à¤®à¥‡à¤‚, à¤¤à¥à¤°à¤‚à¤¤ à¤¸à¥à¤¥à¤¾à¤¨à¥€à¤¯ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¥‡à¤µà¤¾à¤“à¤‚ à¤¸à¥‡ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤•à¤°à¥‡à¤‚',summaryPrefix:'à¤•à¥‡ à¤²à¤¿à¤ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤•à¤¾à¤°à¥à¤¡'},
  ar:{yes:'Ù†Ø¹Ù…',no:'Ù„Ø§',none:'Ù„Ø§ ÙŠÙˆØ¬Ø¯',personal:'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©',medical:'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©',contacts:'Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ (ICE)',name:'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„',dob:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯',country:'Ø§Ù„Ø¨Ù„Ø¯',id:'Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©',blood:'ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…',donor:'Ù…ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡',life:'ØªÙØ¶ÙŠÙ„ Ø¯Ø¹Ù… Ø§Ù„Ø­ÙŠØ§Ø©',allergies:'ðŸš« Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©',conditions:'ðŸ©º Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©',meds:'ðŸ’Š Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©',noContacts:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦',generatedBy:'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø©',system:'Ù†Ø¸Ø§Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø·Ø¨ÙŠØ© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦',instruction:'ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ØŒ ØªÙˆØ§ØµÙ„ ÙÙˆØ±Ø§Ù‹ Ù…Ø¹ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…Ø­Ù„ÙŠØ©',summaryPrefix:'Ø¨Ø·Ø§Ù‚Ø© Ø·ÙˆØ§Ø±Ø¦ Ù„Ù€'},
  zh:{yes:'æ˜¯',no:'å¦',none:'æ— æŠ¥å‘Š',personal:'ä¸ªäººä¿¡æ¯',medical:'åŒ»ç–—ä¿¡æ¯',contacts:'ç´§æ€¥è”ç³»äººï¼ˆICEï¼‰',name:'å§“å',dob:'å‡ºç”Ÿæ—¥æœŸ',country:'å›½å®¶',id:'èº«ä»½è¯å·',blood:'è¡€åž‹',donor:'å™¨å®˜æçŒ®è€…',life:'ç”Ÿå‘½æ”¯æŒåå¥½',allergies:'ðŸš« è¿‡æ•',conditions:'ðŸ©º åŒ»ç–—çŠ¶å†µ',meds:'ðŸ’Š å½“å‰ç”¨è¯',noContacts:'æš‚æ— ç´§æ€¥è”ç³»äºº',generatedBy:'ç”±ä»¥ä¸‹ç”Ÿæˆ',system:'ç´§æ€¥åŒ»ç–—ä¿¡æ¯ç³»ç»Ÿ',instruction:'ç´§æ€¥æƒ…å†µä¸‹ï¼Œè¯·ç«‹å³è”ç³»å½“åœ°æ€¥æ•‘æœåŠ¡',summaryPrefix:'ç´§æ€¥å¡ç‰‡ï¼š'},
  hu:{yes:'Igen',no:'Nem',none:'Nincs megadva',personal:'SZEMÃ‰LYES ADATOK',medical:'ORVOSI INFORMÃCIÃ“K',contacts:'SÃœRGÅSSÃ‰GI KAPCSOLATOK (ICE)',name:'Teljes nÃ©v',dob:'SzÃ¼letÃ©si dÃ¡tum',country:'OrszÃ¡g',id:'Nemzeti azonosÃ­tÃ³',blood:'VÃ©rcsoport',donor:'Szervdonor',life:'Ã‰letjelekkel kapcsolatos preferencia',allergies:'ðŸš« ALLERGIÃK',conditions:'ðŸ©º ORVOSI ÃLLAPOTOK',meds:'ðŸ’Š JELENLEGI GYÃ“GYSZEREK',noContacts:'Nincs sÃ¼rgÅ‘ssÃ©gi kontakt',generatedBy:'KÃ©szÃ­tette',system:'SÃ¼rgÅ‘ssÃ©gi Orvosi InformÃ¡ciÃ³s Rendszer',instruction:'VÃ©szhelyzetben azonnal hÃ­vja a helyi segÃ©lyhÃ­vÃ³t',summaryPrefix:'VÃ©szhelyzeti kÃ¡rtya:'},
  ro:{yes:'Da',no:'Nu',none:'Nimic raportat',personal:'INFORMAÈšII PERSONALE',medical:'INFORMAÈšII MEDICALE',contacts:'CONTACTE DE URGENÈšÄ‚ (ICE)',name:'Nume Complet',dob:'Data NaÈ™terii',country:'ÈšarÄƒ',id:'ID NaÈ›ional',blood:'Grupa SanguinÄƒ',donor:'Donator de Organe',life:'PreferinÈ›Äƒ Suport Vital',allergies:'ðŸš« ALERGII',conditions:'ðŸ©º AFECÈšIUNI MEDICALE',meds:'ðŸ’Š MEDICAÈšIE CURENTÄ‚',noContacts:'Nu existÄƒ contacte de urgenÈ›Äƒ',generatedBy:'Generat de',system:'Sistem de InformaÈ›ii Medicale de UrgenÈ›Äƒ',instruction:'ÃŽn caz de urgenÈ›Äƒ, contactaÈ›i imediat serviciile de urgenÈ›Äƒ locale',summaryPrefix:'Card de urgenÈ›Äƒ pentru'}
};

// ---------- DOM ----------
const qs = (id)=>document.getElementById(id);
const loadingState = qs('loadingState');
const errorState   = qs('errorState');
const cardContent  = qs('cardContent');
const languageSelect = qs('languageSelect');
// Labels
const personalInfoTitle=qs('personalInfoTitle'), medicalInfoTitle=qs('medicalInfoTitle'), emergencyContactsTitle=qs('emergencyContactsTitle');
const nameLabel=qs('nameLabel'), dobLabel=qs('dobLabel'), countryLabel=qs('countryLabel'), idLabel=qs('idLabel');
const bloodTypeLabel=qs('bloodTypeLabel'), organDonorLabel=qs('organDonorLabel'), lifeSupportLabel=qs('lifeSupportLabel');
const allergiesLabel=qs('allergiesLabel'), conditionsLabel=qs('conditionsLabel'), medicationsLabel=qs('medicationsLabel');
const generatedByLabel=qs('generatedByLabel'), emergencySystemLabel=qs('emergencySystemLabel'), emergencyInstructionLabel=qs('emergencyInstructionLabel');
// Values
const fullName=qs('fullName'), dateOfBirth=qs('dateOfBirth'), country=qs('country'), nationalId=qs('nationalId');
const bloodType=qs('bloodType'), organDonor=qs('organDonor'), lifeSupportPref=qs('lifeSupportPref');
const allergies=qs('allergies'), conditions=qs('conditions'), medications=qs('medications');
const contactsContainer=qs('emergencyContacts');

// Optional voice button (id="voiceBtn") from your header
const voiceBtn = qs('voiceBtn');

// ---------- utils ----------
const urlParams = new URLSearchParams(location.search);
const code = urlParams.get('code');
const urlLang = (urlParams.get('lang')||'').toLowerCase();
let lang = (urlLang || localStorage.getItem('myqer_lang') || 'en');
if(!t[lang]) lang = 'en';
if(languageSelect) languageSelect.value = lang;

function L(){ return t[lang] || t.en; }

function setTexts(){
  const l=L();
  personalInfoTitle.textContent = l.personal;
  medicalInfoTitle.textContent  = l.medical;
  emergencyContactsTitle.textContent = l.contacts;
  nameLabel.textContent=l.name; dobLabel.textContent=l.dob; countryLabel.textContent=l.country; idLabel.textContent=l.id;
  bloodTypeLabel.textContent=l.blood; organDonorLabel.textContent=l.donor; lifeSupportLabel.textContent=l.life;
  allergiesLabel.textContent=l.allergies; conditionsLabel.textContent=l.conditions; medicationsLabel.textContent=l.meds;
  generatedByLabel.textContent=l.generatedBy; emergencySystemLabel.textContent=l.system; emergencyInstructionLabel.textContent=l.instruction;
}

function showCard(){ loadingState?.classList.add('hidden'); errorState?.classList.add('hidden'); cardContent?.classList.remove('hidden'); }
function showError(){ loadingState?.classList.add('hidden'); cardContent?.classList.add('hidden'); errorState?.classList.remove('hidden'); }

// ---------- render ----------
function renderProfile(p={}){
  fullName.textContent = p.full_name || '-';
  dateOfBirth.textContent = p.date_of_birth || '-';
  country.textContent = p.country || '-';
  nationalId.textContent = p.national_id || '-';
}
function renderHealth(h={}){
  const l=L();
  bloodType.textContent = h.blood_type || '-';
  organDonor.textContent = h.organ_donor ? l.yes : l.no;
  lifeSupportPref.textContent = h.life_support_pref || '-';
  allergies.textContent = (h.allergies && h.allergies.trim()) ? h.allergies : l.none;
  conditions.textContent = (h.conditions && h.conditions.trim()) ? h.conditions : l.none;
  medications.textContent = (h.meds && h.meds.trim()) ? h.meds : l.none;
}
function renderContacts(list=[]){
  const l=L();
  if(!list.length){
    contactsContainer.innerHTML = `<p class="text-gray-500 text-center py-8">${l.noContacts}</p>`;
    return;
  }
  contactsContainer.innerHTML = list.map(c=>`
    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:mb-0">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Name</label>
          <p class="text-lg font-semibold text-gray-900">${c.name || '-'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Relationship</label>
          <p class="text-lg text-gray-900">${c.relation || '-'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-500 mb-1">Phone</label>
          <p class="text-lg font-mono text-gray-900">
            ${c.phone ? `<a class="text-red-600 hover:text-red-700" href="tel:${c.phone}">${c.phone}</a>` : '-'}
          </p>
        </div>
      </div>
    </div>
  `).join('');
}

// ---------- voice summary ----------
function speakSummary(payload){
  try{
    const l=L();
    const p = payload?.profile || {};
    const h = payload?.health || {};
    const parts = [
      `${l.summaryPrefix} ${p.full_name||''}.`,
      h.blood_type ? `${l.blood}: ${h.blood_type}.` : '',
      h.allergies ? `${l.allergies.replace('ðŸš« ','')}: ${h.allergies}.` : '',
      h.conditions ? `${l.conditions.replace('ðŸ©º ','')}: ${h.conditions}.` : '',
      h.meds ? `${l.meds.replace('ðŸ’Š ','')}: ${h.meds}.` : ''
    ].filter(Boolean);
    const u = new SpeechSynthesisUtterance(parts.join(' '));
    // Map BCP47 tags roughly
    const langMap = { en:'en-US', es:'es-ES', fr:'fr-FR', de:'de-DE', it:'it-IT', hi:'hi-IN', ar:'ar-SA', zh:'zh-CN', hu:'hu-HU', ro:'ro-RO' };
    u.lang = langMap[lang] || 'en-US';
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){ console.warn('Speech failed', e); }
}
if(voiceBtn){
  voiceBtn.addEventListener('click', ()=>{
    const key = `myqer_public_${code}`;
    const cached = localStorage.getItem(key);
    if(!cached) return;
    speakSummary(JSON.parse(cached));
  });
}

// ---------- cache keys ----------
function cacheKey(){ return `myqer_public_${code}`; }

// ---------- language handling ----------
languageSelect?.addEventListener('change', ()=>{
  lang = (languageSelect.value||'en').toLowerCase();
  if(!t[lang]) lang='en';
  localStorage.setItem('myqer_lang', lang);
  setTexts();
  // Re-render donor yes/no text using current payload if cached
  const cached = localStorage.getItem(cacheKey());
  if(cached){
    const payload = JSON.parse(cached);
    renderHealth(payload.health||{});
  }
});

// ---------- boot ----------
(async function init(){
  if(!code){ showError(); return; }
  setTexts();

  // Try network, then fall back to cache
  try{
    const res = await fetch(`${EDGE_URL}?code=${encodeURIComponent(code)}&lang=${encodeURIComponent(lang)}`, {
      headers:{ 'Accept':'application/json' }
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const payload = await res.json(); // { profile, health, contacts }
    localStorage.setItem(cacheKey(), JSON.stringify(payload));
    renderProfile(payload.profile||{});
    renderHealth(payload.health||{});
    renderContacts(payload.contacts||[]);
    showCard();
  }catch(err){
    console.warn('Network failed, using cache if any:', err);
    const cached = localStorage.getItem(cacheKey());
    if(cached){
      const payload = JSON.parse(cached);
      renderProfile(payload.profile||{});
      renderHealth(payload.health||{});
      renderContacts(payload.contacts||[]);
      showCard();
    }else{
      showError();
    }
  }
})();
</script>
</body>
</html>
