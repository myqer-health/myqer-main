<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MYQER™ — Emergency Card</title>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--red:#dc2626;--amber:#d97706;--green:#059669;--black:#111827;}
    body{font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif;margin:0;background:#f8fafc;color:var(--ink)}
    .wrap{max-width:720px;margin:24px auto;padding:24px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .brand{font-weight:800;letter-spacing:-.02em}
    .brand .er{color:var(--red)}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    h1{font-size:22px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;letter-spacing:.05em;margin-left:8px}
    .pill.green{background:#dcfce7;color:var(--green)}
    .pill.amber{background:#fef3c7;color:var(--amber)}
    .pill.red{background:#fee2e2;color:var(--red)}
    .pill.black{background:#e5e7eb;color:var(--black)}
    .section{margin-top:18px}
    .k{font-weight:600}
    .box{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    ul{margin:8px 0 0;padding-left:18px}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:10px;margin-top:16px;font-size:13px}
    .err{color:var(--red);margin-top:12px}
    .qr{display:flex;gap:16px;align-items:center;margin-top:16px}
    .qr img{width:120px;height:120px}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;color:var(--muted)}
    footer{margin-top:28px;color:#94a3b8;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MYQ<span class="er">ER</span><span style="font-size:.8em;vertical-align:super">™</span></div>
      <div class="muted">pronounced “my care”</div>
    </header>

    <div id="card" class="card">
      <h1>Emergency Profile <span id="triagePill" class="pill green">GREEN</span></h1>
      <div class="muted" id="updated"></div>

      <div class="row">
        <div class="section">
          <div><span class="k">Name:</span> <span id="fullName">—</span></div>
          <div><span class="k">Country:</span> <span id="country">—</span></div>
          <div><span class="k">Blood type:</span> <span id="blood">—</span></div>
          <div><span class="k">Organ donor:</span> <span id="donor">—</span></div>
        </div>
        <div class="section">
          <div class="k">Allergies</div>
          <div class="box" id="allergies">—</div>
        </div>
      </div>

      <div class="row">
        <div class="section">
          <div class="k">Conditions</div>
          <div class="box" id="conditions">—</div>
        </div>
        <div class="section">
          <div class="k">Medications</div>
          <div class="box" id="meds">—</div>
        </div>
      </div>

      <div class="section">
        <div class="k">Implants / Devices</div>
        <div class="box" id="implants">—</div>
      </div>

      <div class="section">
        <div class="k">Emergency contacts (ICE)</div>
        <div class="box" id="ice">—</div>
      </div>

      <div class="qr">
        <img id="qr" alt="QR"/>
        <div>
          <div class="k">Card URL</div>
          <div class="code" id="url">—</div>
        </div>
      </div>

      <div class="warn">Read-only emergency information. Verify clinically.</div>
      <div class="err" id="error" hidden></div>
    </div>

    <footer>© 2024 MYQER™</footer>
  </div>

<script>
(function () {
  const fnBase = 'https://dmntmhkncldgynufajei.functions.supabase.co/functions/v1/card';

  // read code from /c/XXXX-XXXX OR ?code=XXXX-XXXX
  const pathPart = location.pathname.split('/').filter(Boolean);
  let code = (pathPart[0] === 'c' && pathPart[1]) ? pathPart[1] : null;
  if (!code) {
    const u = new URL(location.href);
    code = (u.searchParams.get('code') || '').trim();
  }

  const byId = id => document.getElementById(id);
  const set = (id, val) => byId(id).textContent = val || '—';

  const pill = byId('triagePill');
  function setTriage(level) {
    const lv = (level || 'green').toLowerCase();
    pill.className = 'pill ' + (['green','amber','red','black'].includes(lv) ? lv : 'green');
    pill.textContent = pill.className.split(' ').pop().toUpperCase();
  }

  async function load() {
    if (!code) {
      byId('error').hidden = false;
      byId('error').textContent = 'Missing code in URL.';
      return;
    }

    const url = fnBase + '?code=' + encodeURIComponent(code);
    set('url', url);
    byId('qr').src = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent(url);

    try {
      const res = await fetch(url, { mode: 'cors' });
      const data = await res.json();

      if (!res.ok || data.error) {
        throw new Error(data.error || 'Failed to load card');
      }

      const p = data.profile || {};
      const h = data.health || {};
      const ice = Array.isArray(data.ice) ? data.ice : [];

      set('updated', 'Updated ' + new Date(data.meta?.generated_at || Date.now()).toLocaleString());
      set('fullName', p.full_name || '-');
      set('country', p.country || '-');
      set('blood', h.blood_type || '-');
      set('donor', h.organ_donor ? 'Yes' : 'No');
      set('allergies', (h.allergies || '').trim() || 'None listed');
      set('conditions', (h.conditions || '').trim() || 'None listed');
      set('meds', (h.meds || h.medications || '').trim() || 'None listed');
      set('implants', (h.implants || '').trim() || 'None listed');
      setTriage(p.triage || 'green');

      if (ice.length) {
        byId('ice').innerHTML = '<ul>' + ice.map(c =>
          `<li><strong>${(c.name||'').toString()}</strong> — ${(c.relation||'').toString()} — ${(c.phone||'').toString()}</li>`
        ).join('') + '</ul>';
      } else {
        set('ice', 'No emergency contacts on file');
      }
    } catch (e) {
      byId('error').hidden = false;
      byId('error').textContent = e.message || 'Error loading card.';
    }
  }

  load();
})();
</script>
</body>
</html>
