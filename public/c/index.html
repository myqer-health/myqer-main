<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MYQERâ„¢ â€” Emergency Card</title>
  <style>
    :root{
      --red:#dc2626; --red-light:#fef2f2;
      --text:#111827; --text-light:#6b7280;
      --green:#10b981; --surface:#ffffff; --border:#f3f4f6;
    }
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased}
    body{font-family:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,sans-serif;margin:0;background:#fff;color:var(--text);min-height:100vh;padding:8px}
    .wrap{max-width:340px;margin:0 auto}
    header{text-align:center;margin-bottom:12px}
    .brand{font-size:20px;font-weight:800;letter-spacing:-.02em}
    .brand .er{color:var(--red)}
    .tagline{color:var(--text-light);font-size:11px;margin-top:2px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 8px rgba(220,38,38,.08),0 1px 3px rgba(0,0,0,.06);overflow:hidden}
    .card-header{padding:12px 16px 6px;text-align:center;background:linear-gradient(135deg,var(--red-light) 0%,#fff 100%)}
    h1{font-size:16px;font-weight:700;margin:0}
    .status-pill{display:inline-block;padding:3px 8px;border-radius:10px;font-size:9px;font-weight:700;margin-top:4px;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .status-pill.green{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .status-pill.amber{background:linear-gradient(135deg,#f97316,#ea580c);color:#fff}
    .status-pill.red{background:linear-gradient(135deg,var(--red),#b91c1c);color:#fff}
    .status-pill.black{background:linear-gradient(135deg,#6b7280,#374151);color:#fff}
    .card-body{padding:8px 12px 12px}
    .info-grid{display:grid;gap:6px}
    .info-section{background:var(--surface);border-radius:8px;padding:8px;border:1px solid var(--border);box-shadow:0 1px 2px rgba(220,38,38,.04)}
    .section-title{font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
    .info-row{display:flex;justify-content:space-between;padding:2px 0}
    .info-label{font-size:11px;font-weight:500;color:var(--text-light)}
    .info-value{font-size:11px;font-weight:600;color:var(--text);text-align:right}
    .content-box{background:var(--red-light);border-radius:6px;padding:6px;font-size:10px;line-height:1.3;color:var(--text);min-height:24px;border:1px solid rgba(220,38,38,.1)}
    .qr-section{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:8px;padding:8px;text-align:center;margin-top:6px;border:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .qr-code{width:50px;height:50px;border-radius:6px;border:1px solid var(--border);margin:0 auto 6px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .qr-label{font-size:9px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
    .qr-url{font-family:ui-monospace,monospace;font-size:8px;color:var(--text-light);word-break:break-all;background:#fff;padding:3px 4px;border-radius:4px;border:1px solid var(--border)}
    .disclaimer{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);color:#92400e;border-radius:6px;padding:6px;margin-top:6px;font-size:9px;text-align:center;font-weight:500}
    .updated-time{color:var(--text-light);font-size:9px;text-align:center;margin-top:3px}
    footer{margin-top:12px;color:var(--text-light);font-size:9px;text-align:center}
    .snap{margin-top:8px}
    .snap .section-title{margin-bottom:6px}
    .snap-box{font-family:ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px dashed var(--border);border-radius:6px;padding:8px;font-size:10px;white-space:pre-wrap}
    .row-actions{display:flex;gap:6px;justify-content:center;margin-top:6px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:6px 10px;font-size:11px;font-weight:600;color:var(--text);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    @media (max-width:480px){.wrap{padding:0 16px}.card{border-radius:20px}.card-header,.card-body{padding:20px}h1{font-size:22px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MYQ<span class="er">ER</span><span style="font-size:.8em;vertical-align:super">â„¢</span></div>
      <div class="tagline">pronounced "my care"</div>
    </header>

    <div id="card" class="card">
      <div class="card-header">
        <h1>Emergency Profile</h1>
        <div id="triagePill" class="status-pill green">Standby</div>
        <div class="updated-time" id="updated">Accessed via QR scan</div>
      </div>

      <div class="card-body">
        <div class="info-grid">
          <div class="info-section">
            <div class="section-title">Personal Information</div>
            <div class="info-row"><span class="info-label">Name</span><span class="info-value" id="fullName">â€”</span></div>
            <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value" id="dob">â€”</span></div>
            <div class="info-row"><span class="info-label">Blood Type</span><span class="info-value" id="blood">â€”</span></div>
            <div class="info-row"><span class="info-label">Organ Donor</span><span class="info-value" id="donor">â€”</span></div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Allergies</div>
            <div class="content-box" id="allergies">No known allergies</div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Conditions</div>
            <div class="content-box" id="conditions">No known conditions</div>
          </div>

          <div class="info-section">
            <div class="section-title">Current Medications</div>
            <div class="content-box" id="medications">No current medications</div>
          </div>

          <div class="info-section">
            <div class="section-title">Implants & Devices</div>
            <div class="content-box" id="implants">None reported</div>
          </div>

          <div class="info-section">
            <div class="section-title">Emergency Contacts</div>
            <div class="content-box" id="emergencyContacts">No contacts available</div>
          </div>
        </div>

        <div class="qr-section">
          <div id="qr" class="qr-code" aria-label="QR code"></div>
          <div class="qr-label">Secure Card URL</div>
          <div class="qr-url" id="cardUrl">myqer.com/card/loading...</div>
          <div class="row-actions">
            <button class="btn" id="btnCopy">Copy snapshot</button>
            <button class="btn" id="btnPrint">Print</button>
          </div>
        </div>

        <div class="info-section snap">
          <div class="section-title">Offline Snapshot</div>
          <div class="snap-box" id="snapshotBox">MYQER â€” Emergency Snapshot</div>
        </div>

        <div class="disclaimer">ðŸ”’ Read-only emergency information. Always verify clinically before treatment.</div>
      </div>
    </div>

    <footer>Â© 2025 MYQERâ„¢</footer>
  </div>

  <!-- QR generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
  (function () {
    const fnBase = 'https://dmntmhkncldgynufajei.functions.supabase.co/functions/v1/card';

    // read code from /c/XXXX-XXXX OR ?code=XXXX-XXXX
    const parts = location.pathname.split('/').filter(Boolean);
    let code = (parts[0] === 'c' && parts[1]) ? parts[1] : null;
    if (!code) {
      const u = new URL(location.href);
      code = (u.searchParams.get('code') || '').trim();
    }

    const $ = id => document.getElementById(id);
    const setTxt = (id, v) => $(id).textContent = v ?? 'â€”';

    function setTriage(level) {
      const pill = $('triagePill');
      const lv = (level || 'green').toLowerCase();
      pill.className = 'status-pill ' + (['green','amber','red','black'].includes(lv) ? lv : 'green');
      pill.textContent = lv.toUpperCase();
    }

    function fmtDOB(dob) {
      if (!dob) return 'â€”';
      try { return new Date(dob).toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'}); }
      catch { return dob; }
    }

    function fmtYN(v){
      if (v === true || v === 'true' || v === 1) return 'Yes';
      if (v === false || v === 'false' || v === 0) return 'No';
      return 'â€”';
    }

    // Build the snapshot string (and keep it short)
    function buildSnapshot(p,h,ice) {
      const lines = [];
      lines.push('MYQER â€” Emergency Snapshot');
      if (p?.full_name) lines.push('Name: ' + p.full_name);
      if (p?.dob || p?.date_of_birth) lines.push('DOB: ' + fmtDOB(p.dob || p.date_of_birth));
      if (h?.blood_type) lines.push('Blood: ' + h.blood_type);
      if (h?.allergies)   lines.push('Allergies: ' + h.allergies);
      if (h?.conditions)  lines.push('Conditions: ' + h.conditions);
      if (h?.meds || h?.medications) lines.push('Medications: ' + (h.meds || h.medications));
      if (Array.isArray(ice) && ice.length) {
        const c = ice[0];
        const rel = (c.relation || c.relationship || '').toString().trim();
        lines.push('ICE: ' + [c.name, rel, c.phone].filter(Boolean).join(' â€” '));
      }
      let s = lines.join('\n').trim();
      if (s.length > 560) s = s.slice(0, 557) + 'â€¦'; // keep payload reasonable
      return s;
    }

    function renderSnapshot(text) {
      $('snapshotBox').textContent = text || 'MYQER â€” Emergency Snapshot';
      try { localStorage.setItem('myqer_snapshot', text); } catch {}
    }

    function makeQR(payload) {
      $('qr').innerHTML = '';
      new QRCode($('qr'), { text: payload, width: 50, height: 50, correctLevel: QRCode.CorrectLevel.M });
    }

    async function load() {
      if (!code) {
        setTxt('cardUrl', 'Missing code');
        renderSnapshot('MYQER â€” Emergency Snapshot\n(No code found)');
        makeQR('MYQER â€” Emergency Snapshot\n(No code found)');
        return;
      }

      const url = fnBase + '?code=' + encodeURIComponent(code);
      setTxt('cardUrl', url);

      try {
        const res = await fetch(url, { mode: 'cors' });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Failed to load card');

        const p = data.profile || {};                 // { full_name, country, dob/date_of_birth, triage }
        const h = (data.health || data.sections?.blood || {}) ? {
          blood_type: data.health?.blood_type ?? data.sections?.blood?.value ?? null,
          organ_donor: data.health?.organ_donor ?? data.sections?.blood?.donor ?? null,
          allergies: (data.health?.allergies ?? data.sections?.allergies?.items?.join(', ')) || '',
          conditions: (data.health?.conditions ?? data.sections?.conditions?.items?.join(', ')) || '',
          meds: (data.health?.meds ?? data.health?.medications ?? data.sections?.meds?.items?.join(', ')) || ''
        } : {};
        const ice = data.ice || data.sections?.ice?.contacts || [];

        // Fill UI
        setTxt('fullName', p.full_name || 'â€”');
        setTxt('dob', fmtDOB(p.dob || p.date_of_birth));
        setTxt('blood', h.blood_type || 'â€”');
        setTxt('donor', fmtYN(h.organ_donor));
        setTxt('allergies', h.allergies || 'No known allergies');
        setTxt('conditions', h.conditions || 'No known conditions');
        setTxt('medications', h.meds || 'No current medications');
        setTxt('implants', (data.health?.implants || 'None reported'));
        if (Array.isArray(ice) && ice.length) {
          const list = ice.map(c => [c.name, (c.relation||c.relationship), c.phone].filter(Boolean).join(' â€” ')).join('\n');
          $('emergencyContacts').textContent = list;
        } else {
          $('emergencyContacts').textContent = 'No contacts available';
        }
        setTriage(p.triage || data.profile?.triage || 'green');
        $('updated').textContent = 'Updated ' + new Date(data.meta?.generated_at || Date.now()).toLocaleString();

        // Build snapshot + encode hybrid QR (URL first, then snapshot)
        const snapshot = buildSnapshot(p, h, ice);
        renderSnapshot(snapshot);
        const hybridPayload = url + '\n\n' + snapshot;
        makeQR(hybridPayload);

      } catch (e) {
        // Offline / fetch failed â†’ fallback to last snapshot if any
        const cached = localStorage.getItem('myqer_snapshot');
        const minimal = 'MYQER â€” Emergency Snapshot\n(offline)\nCode: ' + code;
        const text = cached || minimal;
        renderSnapshot(text);
        makeQR((fnBase + '?code=' + code) + '\n\n' + text);
        setTriage('amber'); // hint to rescuer that this is limited
        $('updated').textContent = 'Offline snapshot';
      }
    }

    // Actions
    $('btnCopy').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText($('snapshotBox').textContent);
        $('btnCopy').textContent = 'Copied';
        setTimeout(()=>$('btnCopy').textContent='Copy snapshot',1200);
      } catch(e){ $('btnCopy').textContent='Copy failed'; setTimeout(()=>$('btnCopy').textContent='Copy snapshot',1200); }
    });

    $('btnPrint').addEventListener('click', () => {
      window.print();
    });

    load();
  })();
  </script>
</body>
</html>
