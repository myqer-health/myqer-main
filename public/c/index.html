<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYQER™ Emergency Card</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root{--ink:#0F172A;--slate:#475569;--red:#DC2626;--green:#059669;--border:#E5E7EB;}
    body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:var(--ink)}
    .wrap{max-width:840px;margin:0 auto;padding:24px}
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:20px;margin:0;font-weight:800}
    .pill{padding:.25rem .6rem;border-radius:999px;background:#DCFCE7;color:var(--green);font-size:12px;font-weight:700}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .lab{font-size:12px;color:var(--slate)}
    .val{font-size:16px;font-weight:600}
    .qrbox{display:flex;gap:24px;align-items:center;margin-top:12px}
    #qr{border:1px dashed #e5e7eb;border-radius:12px;padding:8px}
    footer{margin-top:24px;color:var(--slate);font-size:12px;text-align:center}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <h1>MYQER™ Emergency Card</h1>
    <span id="triagePill" class="pill">GREEN</span>
  </div>

  <div class="card">
    <div class="grid">
      <div><div class="lab">Full name</div><div id="v_name" class="val">—</div></div>
      <div><div class="lab">DOB</div><div id="v_dob" class="val">—</div></div>
      <div><div class="lab">Country</div><div id="v_country" class="val">—</div></div>
      <div><div class="lab">Health/National ID</div><div id="v_hid" class="val">—</div></div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div><div class="lab">Blood type</div><div id="v_bt" class="val">—</div></div>
      <div><div class="lab">Organ donor</div><div id="v_donor" class="val">—</div></div>
      <div style="grid-column:1/-1"><div class="lab">Critical allergies</div><div id="v_alg" class="val">—</div></div>
      <div style="grid-column:1/-1"><div class="lab">Conditions</div><div id="v_cond" class="val">—</div></div>
      <div style="grid-column:1/-1"><div class="lab">Medications</div><div id="v_meds" class="val">—</div></div>
      <div style="grid-column:1/-1"><div class="lab">Implants/Devices</div><div id="v_impl" class="val">—</div></div>
    </div>
    <div class="qrbox">
      <canvas id="qr" width="160" height="160" aria-label="QR"></canvas>
      <div>
        <div class="lab">Code</div>
        <div id="v_code" class="val">—</div>
        <div class="lab" style="margin-top:8px">URL</div>
        <a id="v_url" href="#" target="_blank" rel="noopener" class="val" style="font-weight:600;color:#1d4ed8">—</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="lab" style="margin-bottom:6px">Emergency contacts (ICE)</div>
    <div id="v_ice" class="val">—</div>
  </div>

  <footer>Informational only. Clinicians must confirm with official medical documents.</footer>
</div>

<script>
  // config (same as dashboard)
  const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // read code from /c/XXX-XXXX-XXX
  const code = (location.pathname.split('/').pop() || '').toUpperCase();
  const url  = location.origin + location.pathname;

  // triage helper (same logic as dashboard auto mode)
  function computeTriage(h) {
    let s=0;
    const alg=(h.allergies||'').toLowerCase();
    const cond=(h.conditions||'').toLowerCase();
    const meds=(h.medications||'').toLowerCase();
    if (alg.includes('anaphylaxis') || alg.includes('severe')) s+=3;
    if (cond.includes('heart') || cond.includes('cardiac'))    s+=2;
    if (cond.includes('diabetes') && meds.includes('insulin')) s+=2;
    if (cond.includes('epilepsy') || cond.includes('seizure')) s+=2;
    if (meds.includes('warfarin') || meds.includes('blood thinner')) s+=1;
    return s>=5?'RED':s>=3?'AMBER':'GREEN';
  }

  async function load() {
    if (!/^[A-HJ-NP-Z2-9]{3}-[A-HJ-NP-Z2-9]{4}-[A-HJ-NP-Z2-9]{3}$/.test(code)) {
      document.querySelector('.wrap').innerHTML = '<p>Invalid or missing code.</p>'; return;
    }

    // find profile by code → user_id
    const { data: prof, error: e1 } = await supabase
      .from('profiles').select('*').eq('code', code).maybeSingle();
    if (e1 || !prof) { document.querySelector('.wrap').innerHTML = '<p>Card not found.</p>'; return; }

    // load health + ice
    const [{ data: health }, { data: ice }] = await Promise.all([
      supabase.from('health_data').select('*').eq('user_id', prof.user_id).maybeSingle(),
      supabase.from('ice_contacts').select('*').eq('user_id', prof.user_id).order('contact_order', { ascending:true })
    ]);

    // fill UI
    const set = (id, v) => document.getElementById(id).textContent = v || '—';
    set('v_name', prof.fullName);
    set('v_dob', prof.dob);
    set('v_country', prof.country);
    set('v_hid', prof.healthId);
    set('v_bt', health?.bloodType);
    set('v_alg', health?.allergies);
    set('v_cond', health?.conditions);
    set('v_meds', health?.medications);
    set('v_impl', health?.implants);
    set('v_donor', health?.organDonor ? 'Yes' : 'No');

    // triage
    const level = (health?.triageOverride && health.triageOverride !== 'auto')
      ? health.triageOverride.toUpperCase()
      : computeTriage(health||{});
    const pill = document.getElementById('triagePill');
    pill.textContent = level;
    pill.style.background = level==='RED' ? '#FEE2E2'
                         : level==='AMBER' ? '#FEF3C7'
                         : '#DCFCE7';
    pill.style.color = level==='RED' ? '#DC2626'
                    : level==='AMBER' ? '#D97706'
                    : '#059669';

    // ice
    const iceStr = (ice||[]).map(r => [r.name, r.relationship, r.phone].filter(Boolean).join(' — ')).join(' | ');
    set('v_ice', iceStr || '—');

    // code + url + qr
    set('v_code', code);
    const a = document.getElementById('v_url'); a.textContent = url; a.href = url;
    QRCode.toCanvas(document.getElementById('qr'), url, { width:160, errorCorrectionLevel:'H', margin:1 });
  }

  load().catch(err => {
    console.error(err);
    document.querySelector('.wrap').innerHTML = '<p>Unexpected error loading card.</p>';
  });
</script>
</body>
</html>
