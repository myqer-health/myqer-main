<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MYQER™ Emergency Card</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
  :root{--ink:#0f172a;--slate:#475569;--green:#059669;--red:#dc2626;--border:#e2e8f0}
  body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:#fff;color:var(--ink)}
  .wrap{max-width:840px;margin:0 auto;padding:24px}
  h1{font-size:22px;margin:0 0 12px;font-weight:800}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#dcfce7;color:var(--green);font-size:12px;font-weight:700}
  .card{border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .lab{font-size:12px;color:var(--slate)}
  .val{font-size:16px;font-weight:600}
  .qrbox{display:flex;gap:24px;align-items:center;margin-top:12px}
  #qr{border:2px dashed #e5e7eb;border-radius:12px;padding:12px}
  footer{margin-top:24px;color:#64748b;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>MYQER™ Emergency Card</h1>
  <span id="triage" class="pill">GREEN</span>

  <div class="card grid">
    <div>
      <div class="lab">Full name</div><div id="v_name" class="val">—</div>
    </div>
    <div>
      <div class="lab">DOB</div><div id="v_dob" class="val">—</div>
    </div>
    <div>
      <div class="lab">Country</div><div id="v_country" class="val">—</div>
    </div>
    <div>
      <div class="lab">Health ID</div><div id="v_hid" class="val">—</div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <div class="lab">Blood type</div><div id="v_bt" class="val">—</div>
      </div>
      <div>
        <div class="lab">Organ donor</div><div id="v_donor" class="val">—</div>
      </div>
      <div style="grid-column:1/-1">
        <div class="lab">Critical allergies</div><div id="v_alg" class="val">—</div>
      </div>
      <div style="grid-column:1/-1">
        <div class="lab">Medical conditions</div><div id="v_cond" class="val">—</div>
      </div>
      <div style="grid-column:1/-1">
        <div class="lab">Medications</div><div id="v_meds" class="val">—</div>
      </div>
      <div style="grid-column:1/-1">
        <div class="lab">Implants/devices</div><div id="v_impl" class="val">—</div>
      </div>
    </div>

    <div class="qrbox">
      <canvas id="qr" width="160" height="160" aria-label="QR code"></canvas>
      <div>
        <div class="lab">Card URL</div>
        <div id="v_url" class="val" style="font-family:monospace"></div>
        <div class="lab" style="margin-top:8px">Scan for latest details</div>
      </div>
    </div>
  </div>

  <div class="card" id="iceCard">
    <div class="lab" style="margin-bottom:6px">Emergency contacts (ICE)</div>
    <div id="iceList" class="val">—</div>
  </div>

  <footer>© 2024 MYQER™</footer>
</div>

<script>
  // ---- config (same project as dashboard) ----
  const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---- helpers ----
  const $ = (id) => document.getElementById(id);
  const pathLast = (p) => (p || '').split('/').filter(Boolean).pop() || '';
  const fromQS = new URLSearchParams(location.search).get('code') || '';
  let code = (fromQS || pathLast(location.pathname)).toUpperCase();

  const CODE_RX = /^[A-HJ-NP-Z2-9]{3}-[A-HJ-NP-Z2-9]{4}-[A-HJ-NP-Z2-9]{3}$/;

  const showNotFound = (msg='Card not found.') => {
    document.body.innerHTML = `<div class="wrap"><p>${msg}</p></div>`;
  };

  (async () => {
    if (!CODE_RX.test(code)) return showNotFound('Card not found.');

    // 1) find the user by code
    const { data: prof, error } = await supabase
      .from('profiles')
      .select('user_id, fullName, dob, country, healthId, code')
      .eq('code', code)
      .maybeSingle();

    if (error || !prof) return showNotFound();

    // 2) load health + ice in parallel
    const [{ data: health }, { data: ice }] = await Promise.all([
      supabase.from('health_data').select('*').eq('user_id', prof.user_id).maybeSingle(),
      supabase.from('ice_contacts').select('*').eq('user_id', prof.user_id).order('contact_order', { ascending:true })
    ]);

    // 3) render profile
    $('v_name').textContent    = prof.fullName || '—';
    $('v_dob').textContent     = prof.dob || '—';
    $('v_country').textContent = prof.country || '—';
    $('v_hid').textContent     = prof.healthId || '—';

    // 4) render health + triage pill
    if (health) {
      $('v_bt').textContent    = health.bloodType || '—';
      $('v_donor').textContent = health.organDonor ? 'Yes' : 'No';
      $('v_alg').textContent   = health.allergies || '—';
      $('v_cond').textContent  = health.conditions || '—';
      $('v_meds').textContent  = health.medications || '—';
      $('v_impl').textContent  = health.implants || '—';

      const pill = $('triage');
      const lvl = (health.triageOverride && health.triageOverride !== 'auto') ? health.triageOverride : 'green';
      pill.textContent = lvl.toUpperCase();
      pill.style.background = lvl === 'red' ? '#fee2e2' : (lvl === 'amber' ? '#fef3c7' : '#dcfce7');
      pill.style.color      = lvl === 'red' ? '#dc2626' : (lvl === 'amber' ? '#d97706' : '#059669');
    }

    // 5) render ICE
    const list = (ice || []).map(c => [c.name, c.relationship, c.phone].filter(Boolean).join(' — ')).filter(Boolean);
    $('iceList').textContent = list.length ? list.join(' | ') : '—';

    // 6) self QR (short url)
    const url = `https://www.myqer.com/c/${code}`;
    $('v_url').textContent = url;
    if (window.QRCode && typeof QRCode.toCanvas === 'function') {
      try { QRCode.toCanvas($('qr'), url, { width: 160, margin: 1, errorCorrectionLevel: 'H' }); } catch {}
    }
  })();
</script>
</body>
</html>
