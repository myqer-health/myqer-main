<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MYQER Emergency Card</title>
  <meta name="theme-color" content="#ff3b30" />

  <!-- Supabase (read-only anon) + QRCode -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body{
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
      padding:20px; color:#fff;
    }
    .wrap{
      width:100%; max-width:980px; border-radius:24px; overflow:hidden;
      backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.2);
      box-shadow: 0 10px 40px rgba(0,0,0,.15);
      animation:up .6s ease-out both;
    }
    @keyframes up{from{opacity:0; transform:translateY(16px)}to{opacity:1; transform:none}}
    .head{
      padding:28px; text-align:center;
      background: linear-gradient(135deg, rgba(255,59,48,.95), rgba(255,45,85,.95));
      position:relative;
    }
    .title{font-weight:800; letter-spacing:.2px; font-size:24px}
    .sub{opacity:.9; margin-top:6px; font-size:14px}
    .pill{margin-top:12px; display:inline-block; padding:8px 16px; border-radius:999px; font-weight:800; font-size:12px; letter-spacing:.6px; border:1px solid rgba(255,255,255,.3)}
    .pill.GREEN{background:#34c759; color:#000}
    .pill.YELLOW{background:#ffcc00; color:#000}
    .pill.RED{background:#ff3b30; color:#fff}

    .body{display:grid; grid-template-columns: 1fr 280px; gap:28px; padding:28px}
    .card{
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.15);
      border-radius:16px; padding:18px; margin-bottom:16px;
    }
    .lab{font-size:12px; text-transform:uppercase; letter-spacing:.8px; opacity:.85; font-weight:700; margin-bottom:6px}
    .val{font-size:16px; line-height:1.5}
    .dim{opacity:.6; font-style:italic}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    .qrbox{position:sticky; top:20px; display:flex; flex-direction:column; align-items:center; gap:14px;
      background: rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:20px}
    #qr{background:#fff; padding:10px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.2)}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:rgba(0,0,0,.3);
      border:1px solid rgba(255,255,255,.2); padding:8px 12px; border-radius:10px; font-weight:700; letter-spacing:.6px}

    .err{
      display:none; margin:18px; padding:14px; text-align:center;
      background: rgba(255,59,48,.92); border:1px solid rgba(255,255,255,.2); border-radius:12px; font-weight:600;
    }
    .muted{opacity:.65}
    @media (max-width: 820px){ .body{grid-template-columns:1fr} .qrbox{position:static} .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">MYQER EMERGENCY CARD</div>
      <div class="sub">Medical Emergency Information System</div>
      <div id="tri" class="pill GREEN">GREEN</div>
    </div>

    <div id="err" class="err"></div>

    <div class="body">
      <div>
        <div class="grid2">
          <div class="card">
            <div class="lab">Full Name</div>
            <div id="v-name" class="val">—</div>
          </div>
          <div class="card">
            <div class="lab">Date of Birth</div>
            <div id="v-dob" class="val">—</div>
          </div>
          <div class="card">
            <div class="lab">Blood Type</div>
            <div id="v-blood" class="val">—</div>
          </div>
          <div class="card">
            <div class="lab">Organ Donor</div>
            <div id="v-donor" class="val">—</div>
          </div>
        </div>

        <div class="card">
          <div class="lab">Critical Allergies</div>
          <div id="v-all" class="val">No known allergies</div>
        </div>

        <div class="card">
          <div class="lab">Medical Conditions</div>
          <div id="v-cond" class="val">No known conditions</div>
        </div>

        <div class="card">
          <div class="lab">Current Medications</div>
          <div id="v-meds" class="val">No current medications</div>
        </div>

        <div class="card">
          <div class="lab">Medical Implants &amp; Devices</div>
          <div id="v-impl" class="val">None reported</div>
        </div>

        <div class="card">
          <div class="lab">Emergency Contacts (ICE)</div>
          <div id="v-ice" class="val">No contacts available</div>
        </div>
      </div>

      <div class="qrbox">
        <div class="lab">Live Medical Data</div>
        <div id="qr"></div>
        <div class="code">ID: <span id="code">—</span></div>
        <div class="val muted" style="text-align:center">Scan with any smartphone to view live medical information.</div>
      </div>
    </div>
  </div>

  <script>
    // ---- Config ----
    const SUPABASE_URL = "https://dmntmhkncldgynufajei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- Helpers ----
    const $ = (id) => document.getElementById(id);
    const setVal = (id, v, empty='—') => {
      const el = $(id);
      const t = (v==null || String(v).trim()==='') ? empty : String(v).trim();
      el.textContent = t;
      el.classList.toggle('dim', t === empty);
    };
    const toLines = (v) => Array.isArray(v) ? v.filter(Boolean).join('; ') : (v || '');

    function getCodeFromUrl(){
      // supports /c/CODE and /c/index.html?code=CODE and /c/?code=CODE
      const p = location.pathname.replace(/\/+$/,'').split('/');
      const q = new URLSearchParams(location.search).get('code');
      if (q) return q;
      const idx = p.lastIndexOf('c');
      return (idx>=0 && p[idx+1]) ? p[idx+1] : null;
    }

    function applyTriage(level){
      const L = (level || 'GREEN').toUpperCase();
      const tri = $('tri');
      tri.textContent = L;
      tri.className = 'pill ' + (['GREEN','YELLOW','RED'].includes(L) ? L : 'GREEN');
    }

    async function drawQR(url){
      const box = $('qr');
      box.innerHTML = '';
      const canvas = document.createElement('canvas');
      box.appendChild(canvas);
      await QRCode.toCanvas(canvas, url, {
        width: 220, margin: 1, errorCorrectionLevel: 'M',
        color: { dark: '#1d1d1f', light: '#ffffff' }
      });
    }

    function buildSnapshot(row){
      return [
        'MYQER — Emergency Medical Snapshot',
        `Name: ${row.full_name ?? '—'}`,
        `DOB: ${row.date_of_birth ?? '—'}`,
        `Blood Type: ${row.blood_type ?? '—'}`,
        `Organ Donor: ${row.organ_donor ? 'Yes' : 'No'}`,
        `Allergies: ${toLines(row.allergies) || 'No known allergies'}`,
        `Conditions: ${toLines(row.conditions) || 'No known conditions'}`,
        `Medications: ${toLines(row.meds) || 'No current medications'}`,
        `Implants: ${toLines(row.implants) || 'None reported'}`,
        `ICE: ${toLines(row.ice_contacts) || 'No contacts available'}`,
        `Triage: ${(row.triage || 'GREEN')}`
      ].join('\n');
    }

    async function boot(){
      const code = getCodeFromUrl();
      if(!code){
        const e=$('err'); e.style.display='block';
        e.textContent='No emergency code in URL. Use /c/CODE or ?code=CODE.';
        return;
      }
      $('code').textContent = code;

      // Build absolute link in case site is hosted under a subpath
      const base = location.origin + (document.baseURI?.replace(location.origin,'') || '');
      const viewUrl = location.origin + '/c/' + code;

      try{
        await drawQR(viewUrl);

        // Live fetch
        const { data, error } = await sb.rpc('emergency_card_by_code', { p_code: code });
        if (error) throw error;
        const row = data && data[0];
        if(!row) throw new Error('Card not found for this code.');

        // Bind UI
        setVal('v-name',  row.full_name);
        setVal('v-dob',   row.date_of_birth);
        setVal('v-blood', row.blood_type);
        setVal('v-donor', row.organ_donor ? 'Yes' : 'No');
        setVal('v-all',   toLines(row.allergies),  'No known allergies');
        setVal('v-cond',  toLines(row.conditions), 'No known conditions');
        setVal('v-meds',  toLines(row.meds),       'No current medications');
        setVal('v-impl',  toLines(row.implants),   'None reported');
        setVal('v-ice',   toLines(row.ice_contacts),'No contacts available');
        applyTriage(row.triage);

        // Cache for offline
        localStorage.setItem('myqer:offline-snapshot', buildSnapshot(row));
      }catch(err){
        const e=$('err'); e.style.display='block';
        e.textContent='Unable to load live medical data: ' + (err.message || err);

        // Offline fallback
        const cached = localStorage.getItem('myqer:offline-snapshot');
        if (cached){
          const lines = cached.split('\n');
          setVal('v-name',  lines[1]?.replace(/^Name:\s*/,''));
          setVal('v-dob',   lines[2]?.replace(/^DOB:\s*/,''));
          setVal('v-blood', lines[3]?.replace(/^Blood Type:\s*/,''));
          setVal('v-donor', lines[4]?.replace(/^Organ Donor:\s*/,''));
          setVal('v-all',   lines[5]?.replace(/^Allergies:\s*/,''));
          setVal('v-cond',  lines[6]?.replace(/^Conditions:\s*/,''));
          setVal('v-meds',  lines[7]?.replace(/^Medications:\s*/,''));
          setVal('v-impl',  lines[8]?.replace(/^Implants:\s*/,''));
          setVal('v-ice',   lines[9]?.replace(/^ICE:\s*/,''));
          applyTriage(lines[10]?.replace(/^Triage:\s*/,'') || 'GREEN');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
