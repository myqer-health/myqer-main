<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MYQER Emergency Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root {
      --myqer-red:#DC2626;--myqer-red-600:#B91C1C;--myqer-amber:#D97706;--myqer-green:#059669;--myqer-green-600:#047857;--myqer-blue:#2563EB;--myqer-rose:#E11D48;
      --ink:#0F172A;--slate-700:#334155;--slate-500:#64748B;--slate-200:#E2E8F0;--slate-100:#F1F5F9;--white:#FFFFFF;
      --glass-bg:rgba(255,255,255,.85);--glass-border:rgba(255,255,255,.30);
      --shadow-md:0 10px 30px rgba(15,23,42,.08);--shadow-lg:0 20px 50px rgba(15,23,42,.12);
      --r-lg:16px;--r-xl:24px;--r-2xl:28px;
      --space-2:8px;--space-3:12px;--space-4:16px;--space-6:24px;--space-8:32px;--space-12:48px;
      --t-fast:.15s ease-out;--t-slow:.30s ease;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#F8FAFC 0%,#E2E8F0 50%,#F1F5F9 100%);min-height:100vh;color:var(--ink)}

    /* Header */
    .header{position:sticky;top:0;z-index:1000;background:var(--glass-bg);backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-border);padding:var(--space-6) 2rem;margin-top:var(--space-6)}
    .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1400px;margin:0 auto}
    .logo-section{display:flex;align-items:center;gap:1rem}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,var(--myqer-red),var(--myqer-red-600));border-radius:var(--r-lg);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1.2rem}
    .system-name{color:var(--ink);font-weight:800;font-size:1.5rem}
    .user-section{display:flex;align-items:center;gap:1.5rem}
    .user-info{display:flex;align-items:center;gap:.75rem;color:var(--ink)}
    .user-avatar{width:32px;height:32px;background:var(--myqer-red);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.9rem}
    .user-details{display:flex;flex-direction:column;gap:.25rem}
    .user-email{font-size:.9rem;font-weight:500}
    .user-status{font-size:.75rem;display:flex;align-items:center;gap:.25rem}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--myqer-green)}
    .status-dot.offline{background:var(--myqer-amber)}
    .header-controls{display:flex;align-items:center;gap:1rem}

    /* Language Dropdown */
    .language-dropdown{position:relative}
    .language-trigger{background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:.5rem .75rem;color:var(--slate-700);cursor:pointer;display:flex;align-items:center;gap:.5rem;font-size:.9rem;transition:var(--t-fast)}
    .language-trigger:hover{border-color:var(--myqer-red);box-shadow:0 0 0 3px rgba(220,38,38,.1)}
    .language-menu{position:absolute;top:100%;right:0;margin-top:.5rem;background:#fff;border-radius:12px;box-shadow:var(--shadow-lg);min-width:150px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:var(--t-fast)}
    .language-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
    .language-option{padding:.75rem 1rem;cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--slate-700);transition:var(--t-fast)}
    .language-option:hover{background:var(--slate-100)}
    .language-option.active{background:var(--myqer-red);color:#fff}
    .language-option:first-child{border-radius:8px 8px 0 0}
    .language-option:last-child{border-radius:0 0 8px 8px}

    /* Logout Button */
    .logout-btn{background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:.5rem 1rem;color:var(--slate-700);cursor:pointer;display:flex;align-items:center;gap:.5rem;font-size:.9rem;transition:var(--t-fast)}
    .logout-btn:hover{background:var(--myqer-red);border-color:var(--myqer-red);color:#fff;transform:translateY(-2px)}

    /* Main */
    .main-content{padding:var(--space-12) 2rem;max-width:1400px;margin:0 auto}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(600px,1fr));gap:var(--space-12)}

    /* Cards */
    .card{background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:var(--r-2xl);padding:var(--space-12);position:relative;overflow:hidden;box-shadow:var(--shadow-lg)}
    .card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:6px;background:linear-gradient(180deg,var(--myqer-green),var(--myqer-green-600))}
    .card.critical::before{background:linear-gradient(180deg,var(--myqer-red),var(--myqer-red-600))}
    .card.ice::before{background:linear-gradient(180deg,var(--myqer-amber),#B45309)}
    .card.qr::before{background:linear-gradient(180deg,var(--myqer-rose),#BE185D)}
    .card.delete::before{background:linear-gradient(180deg,var(--myqer-red),#991B1B)}
    .card-header{display:flex;align-items:center;gap:var(--space-4);margin-bottom:var(--space-8)}
    .card-icon{width:32px;height:32px;background:var(--myqer-green);border-radius:var(--space-2);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem}
    .card.critical .card-icon{background:var(--myqer-red)}
    .card.ice .card-icon{background:var(--myqer-amber)}
    .card.qr .card-icon{background:var(--myqer-rose)}
    .card.delete .card-icon{background:var(--myqer-red)}
    .card-title{color:var(--ink);font-size:1.5rem;font-weight:800}
    .card-subtitle{color:var(--slate-500);font-size:.9rem;margin-top:.25rem}
    .card-header-actions{display:flex;align-items:center;gap:var(--space-4);margin-left:auto}

    /* Triage */
    .triage-selector{background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:.5rem .75rem;color:var(--slate-700);font-size:.9rem;transition:var(--t-fast)}
    .triage-selector:focus{outline:none;border-color:var(--myqer-red);box-shadow:0 0 0 3px rgba(220,38,38,.1)}
    .triage-pill{display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:9999px;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .triage-pill.triage-green{background:var(--myqer-green);color:#fff}
    .triage-pill.triage-amber{background:var(--myqer-amber);color:#fff}
    .triage-pill.triage-red{background:var(--myqer-red);color:#fff}
    .triage-pill.triage-black{background:#1F2937;color:#fff}
    .triage-dot{width:12px;height:12px;border-radius:50%;background:currentColor}

    /* Forms */
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:var(--space-6)}
    .form-group{display:flex;flex-direction:column;gap:var(--space-2)}
    .form-group.full-width{grid-column:1 / -1}
    .form-label{color:var(--slate-700);font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em}
    .form-input,.form-select{background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:.75rem 1rem;color:var(--ink);font-size:1rem;transition:var(--t-fast)}
    .form-input::placeholder{color:var(--slate-500)}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--myqer-red);box-shadow:0 0 0 3px rgba(220,38,38,.1)}
    .form-input.error{border-color:var(--myqer-red);background:rgba(220,38,38,.05)}
    .form-error{color:var(--myqer-red);font-size:.8rem;margin-top:.25rem;display:none}
    .form-error.show{display:block}
    .form-help{color:var(--slate-500);font-size:.8rem;margin-top:.25rem}
    .form-textarea{background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:.75rem 1rem;color:var(--ink);font-size:1rem;transition:var(--t-fast);resize:vertical;min-height:100px;font-family:inherit}
    .form-textarea::placeholder{color:var(--slate-500)}
    .form-textarea:focus{outline:none;border-color:var(--myqer-red);box-shadow:0 0 0 3px rgba(220,38,38,.1)}
    .form-checkbox-group{display:flex;align-items:center;gap:.75rem;margin-top:.5rem}
    .form-checkbox{width:20px;height:20px;border:2px solid var(--slate-200);border-radius:4px;background:#fff;cursor:pointer;position:relative;transition:var(--t-fast)}
    .form-checkbox:checked{background:var(--myqer-red);border-color:var(--myqer-red)}
    .form-checkbox:checked::after{content:'âœ“';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:14px;font-weight:bold}
    .checkbox-label{color:var(--ink);font-weight:500;cursor:pointer}

    .form-actions{display:flex;gap:1rem;margin-top:2rem;justify-content:flex-end}
    .btn{padding:.75rem 1.5rem;border-radius:12px;font-weight:600;cursor:pointer;transition:all .2s ease;border:none;font-size:.9rem;display:flex;align-items:center;gap:.5rem}
    .btn-primary{background:linear-gradient(135deg,var(--myqer-green),var(--myqer-green-600));color:#fff}
    .btn-primary:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(5,150,105,.3)}
    .btn-primary:disabled{opacity:.7;cursor:not-allowed}
    .btn-warning{background:linear-gradient(135deg,var(--myqer-red),var(--myqer-red-600));color:#fff}
    .btn-warning:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(220,38,38,.3)}
    .btn-danger{background:linear-gradient(135deg,#DC2626,#991B1B);color:#fff}
    .btn-danger:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(220,38,38,.4)}
    .btn-secondary{background:#fff;border:2px solid var(--slate-200);color:var(--slate-700)}
    .btn-secondary:hover:not(:disabled){background:var(--slate-100);transform:translateY(-1px)}
    .btn-rose{background:linear-gradient(135deg,var(--myqer-rose),#BE185D);color:#fff}
    .btn-rose:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(225,29,72,.3)}
    .btn-spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top:2px solid #fff;border-radius:50%;animation:spin 1s linear infinite}

    /* ICE */
    .ice-contact{background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:1rem;margin-bottom:1rem}
    .ice-contact-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .ice-contact-number{background:var(--myqer-amber);color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700}
    .ice-contact-remove{background:none;border:none;color:var(--myqer-red);cursor:pointer;padding:.25rem;border-radius:4px;transition:var(--t-fast)}
    .ice-contact-remove:hover{background:rgba(220,38,38,.1)}
    .ice-contact-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .ice-contact-grid .form-group:last-child{grid-column:1 / -1}
    .add-ice-contact{background:#fff;border:2px dashed var(--slate-200);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:var(--t-fast);color:var(--slate-500)}
    .add-ice-contact:hover{border-color:var(--myqer-amber);color:var(--myqer-amber)}

    /* QR */
    .qr-section{text-align:center}
    .qr-container{background:#fff;border-radius:16px;padding:2rem;margin:2rem 0;box-shadow:var(--shadow-md)}
    .qr-code{margin:0 auto 1rem}
    .qr-code-display{font-family:'Courier New',monospace;font-size:1.2rem;font-weight:bold;color:var(--ink);margin:1rem 0;letter-spacing:.2em}
    .qr-url{font-family:'Courier New',monospace;background:var(--slate-100);padding:.75rem 1rem;border-radius:8px;font-size:.9rem;color:var(--ink);margin:1rem 0;display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .qr-url-text{flex:1;text-align:left}
    .qr-url-actions{display:flex;gap:.5rem}
    .qr-url-btn{background:var(--myqer-rose);color:#fff;border:none;padding:.5rem;border-radius:6px;cursor:pointer;transition:var(--t-fast);font-size:.8rem}
    .qr-url-btn:hover{background:#BE185D}

    /* Delete */
    .delete-warning{background:rgba(220,38,38,.05);border:2px solid rgba(220,38,38,.2);border-radius:12px;padding:1.5rem;margin-bottom:2rem}
    .delete-warning-title{color:#DC2626;font-weight:700;font-size:1.1rem;margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}
    .delete-warning-text{color:var(--slate-700);font-size:.9rem;line-height:1.5}
    .delete-confirmation{margin:2rem 0}
    .delete-confirmation-label{color:var(--slate-700);font-weight:600;margin-bottom:.5rem;display:block}
    .delete-confirmation-input{width:100%;background:#fff;border:2px solid var(--slate-200);border-radius:12px;padding:.75rem 1rem;color:var(--ink);font-size:1rem;font-family:'Courier New',monospace;font-weight:600;text-align:center;transition:var(--t-fast)}
    .delete-confirmation-input:focus{outline:none;border-color:#DC2626;box-shadow:0 0 0 3px rgba(220,38,38,.1)}
    .delete-confirmation-input.valid{border-color:#DC2626;background:rgba(220,38,38,.05)}

    /* Responsive */
    @media (max-width:768px){
      .header{padding:1rem}
      .header-content{flex-direction:column;gap:1rem;align-items:stretch}
      .user-section{justify-content:space-between}
      .main-content{padding:1rem}
      .dashboard-grid{grid-template-columns:1fr}
      .form-grid{grid-template-columns:1fr}
      .ice-contact-grid{grid-template-columns:1fr}
      .qr-actions{flex-direction:column}
      .qr-url{flex-direction:column;gap:.5rem}
      .qr-url-text{text-align:center}
    }

    /* Loading, Toasts, Offline, Saving */
    .loading{display:flex;align-items:center;justify-content:center;min-height:200px;color:var(--slate-500)}
    .spinner{width:32px;height:32px;border:3px solid var(--slate-200);border-top:3px solid var(--myqer-red);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .toast-container{position:fixed;top:2rem;right:2rem;z-index:10000;display:flex;flex-direction:column;gap:.5rem}
    .toast{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:12px;padding:1rem 1.5rem;box-shadow:0 10px 25px rgba(0,0,0,.15);display:flex;align-items:center;gap:.75rem;min-width:300px;transform:translateX(100%);opacity:0;transition:all .3s ease}
    .toast.show{transform:translateX(0);opacity:1}
    .toast.success{border-left:4px solid var(--myqer-green)}
    .toast.error{border-left:4px solid var(--myqer-red)}
    .toast.info{border-left:4px solid var(--myqer-blue)}
    .toast.warning{border-left:4px solid var(--myqer-amber)}
    .toast-icon{font-size:1.2rem}
    .toast.success .toast-icon{color:var(--myqer-green)}
    .toast.error .toast-icon{color:var(--myqer-red)}
    .toast.info .toast-icon{color:var(--myqer-blue)}
    .toast.warning .toast-icon{color:var(--myqer-amber)}
    .toast-message{flex:1;color:var(--ink);font-weight:500}

    .offline-banner{position:fixed;top:0;left:0;right:0;background:var(--myqer-amber);color:#fff;padding:.75rem;text-align:center;font-weight:500;z-index:9999;transform:translateY(-100%);transition:transform .3s ease}
    .offline-banner.show{transform:translateY(0)}

    .saving-indicator{position:fixed;bottom:2rem;right:2rem;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:12px;padding:1rem 1.5rem;box-shadow:0 10px 25px rgba(0,0,0,.15);display:flex;align-items:center;gap:.75rem;z-index:9999;opacity:0;transform:translateY(20px);transition:all .3s ease}
    .saving-indicator.show{opacity:1;transform:translateY(0)}
    .saving-spinner{width:16px;height:16px;border:2px solid var(--slate-200);border-top:2px solid var(--myqer-red);border-radius:50%;animation:spin 1s linear infinite}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo">M</div>
        <div class="system-name" data-i18n="system-name">MYQER Emergency Dashboard</div>
      </div>

      <div class="user-section">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-email" id="userEmail">Loading...</div>
            <div class="user-status">
              <div class="status-dot" id="statusDot"></div>
              <span id="statusText" data-i18n="status-online">Online</span>
            </div>
          </div>
        </div>

        <div class="header-controls">
          <!-- Language Dropdown -->
          <div class="language-dropdown">
            <div class="language-trigger" id="languageTrigger">
              <span id="currentLanguage">ðŸ‡ºðŸ‡¸ EN</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="language-menu" id="languageMenu">
              <div class="language-option active" data-lang="en">ðŸ‡ºðŸ‡¸ <span data-i18n="lang-english">English</span></div>
              <div class="language-option" data-lang="es">ðŸ‡ªðŸ‡¸ <span data-i18n="lang-spanish">EspaÃ±ol</span></div>
              <div class="language-option" data-lang="fr">ðŸ‡«ðŸ‡· <span data-i18n="lang-french">FranÃ§ais</span></div>
            </div>
          </div>

          <!-- Logout Button -->
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span data-i18n="logout">Logout</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Offline Banner -->
  <div class="offline-banner" id="offlineBanner">
    <span data-i18n="offline_mode">You're offline. Changes will sync when connection is restored.</span>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Saving Indicator -->
  <div class="saving-indicator" id="savingIndicator">
    <div class="saving-spinner"></div>
    <span data-i18n="saving">Saving...</span>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="dashboard-grid">
      <!-- Identity -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-id-card"></i></div>
          <div>
            <h2 class="card-title" data-i18n="identity_title">Identity â€” Personal Information</h2>
            <p class="card-subtitle" data-i18n="identity_subtitle">Complete your personal information for emergency response</p>
          </div>
        </div>

        <form id="identityForm" class="form-grid">
          <div class="form-group">
            <label class="form-label" data-i18n="first_name">First Name</label>
            <input type="text" class="form-input" id="firstName" data-i18n-placeholder="first-name-placeholder" placeholder="Enter your first name" required>
            <div class="form-error" id="firstNameError" data-i18n="validation_error_first_name">First name is required</div>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="last_name">Last Name</label>
            <input type="text" class="form-input" id="lastName" data-i18n-placeholder="last-name-placeholder" placeholder="Enter your last name" required>
            <div class="form-error" id="lastNameError" data-i18n="validation_error_last_name">Last name is required</div>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="date_of_birth">Date of Birth</label>
            <input type="date" class="form-input" id="dob">
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="phone">Phone Number</label>
            <input type="tel" class="form-input" id="phone" data-i18n-placeholder="phone-placeholder" placeholder="Enter your phone number">
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="country">Country</label>
            <select class="form-select" id="country">
              <option value="" data-i18n="select-country">Select your country</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="emergency_contact">Emergency Contact</label>
            <input type="text" class="form-input" id="emergencyContact" data-i18n-placeholder="emergency-contact-placeholder" placeholder="Enter emergency contact name">
          </div>

          <div class="form-group full-width">
            <label class="form-label" data-i18n="medical_id">Medical/National ID (Optional)</label>
            <input type="text" class="form-input" id="medicalId" data-i18n-placeholder="medical-id-placeholder" placeholder="Enter your medical or national ID">
            <div class="form-help" data-i18n="medical_id_help">This information is optional and will be kept secure</div>
          </div>

          <div class="form-actions full-width">
            <button type="button" class="btn btn-secondary" id="resetBtn">
              <i class="fas fa-undo"></i><span data-i18n="reset">Reset</span>
            </button>
            <button type="submit" class="btn btn-primary" id="saveBtn">
              <i class="fas fa-save"></i><span data-i18n="save">Save Information</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Critical -->
      <div class="card critical">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-heartbeat"></i></div>
          <div>
            <h2 class="card-title" data-i18n="critical_title">CRITICAL â€” Medical & Health Details</h2>
            <p class="card-subtitle" data-i18n="critical_subtitle">Essential medical information for emergency responders</p>
          </div>
          <div class="card-header-actions">
            <select class="triage-selector" id="triageOverride">
              <option value="auto" data-i18n="triage_auto">Auto</option>
              <option value="green" data-i18n="triage_green">Green</option>
              <option value="amber" data-i18n="triage_amber">Amber</option>
              <option value="red" data-i18n="triage_red">Red</option>
              <option value="black" data-i18n="triage_black">Black</option>
            </select>
            <div class="triage-pill triage-green" id="triagePill">
              <div class="triage-dot"></div>
              <span id="triageText" data-i18n="green">Green</span>
            </div>
          </div>
        </div>

        <form id="healthForm" class="form-grid">
          <div class="form-group">
            <label class="form-label" data-i18n="blood_type">Blood Type</label>
            <select class="form-select" id="bloodType">
              <option value="" data-i18n="select_blood_type">Select blood type</option>
              <option value="A+">A+</option><option value="A-">A-</option>
              <option value="B+">B+</option><option value="B-">B-</option>
              <option value="AB+">AB+</option><option value="AB-">AB-</option>
              <option value="O+">O+</option><option value="O-">O-</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="organ_donor">Organ Donor</label>
            <div class="form-checkbox-group">
              <input type="checkbox" class="form-checkbox" id="organDonor">
              <label for="organDonor" class="checkbox-label" data-i18n="organ_donor_label">I consent to organ donation</label>
            </div>
          </div>

          <div class="form-group full-width">
            <label class="form-label" data-i18n="allergies">Critical Allergies</label>
            <textarea class="form-textarea" id="allergies" data-i18n-placeholder="allergies_placeholder" placeholder="e.g., Penicillin, Nuts, Shellfish, Latex"></textarea>
            <div class="form-help" data-i18n="allergies_help">List all life-threatening allergies, separated by commas</div>
          </div>

          <div class="form-group full-width">
            <label class="form-label" data-i18n="conditions">Medical Conditions</label>
            <textarea class="form-textarea" id="conditions" data-i18n-placeholder="conditions_placeholder" placeholder="e.g., Diabetes Type 2, Hypertension, Epilepsy, Asthma, Heart Disease"></textarea>
            <div class="form-help" data-i18n="conditions_help">Include chronic conditions, disabilities, and ongoing health issues</div>
          </div>

          <div class="form-group full-width">
            <label class="form-label" data-i18n="medications">Current Medications</label>
            <textarea class="form-textarea" id="medications" data-i18n-placeholder="medications_placeholder" placeholder="e.g., Metformin 500mg twice daily, Lisinopril 10mg once daily"></textarea>
            <div class="form-help" data-i18n="medications_help">Include medication name, dosage, and frequency</div>
          </div>

          <div class="form-group full-width">
            <label class="form-label" data-i18n="implants">Implants/Medical Devices</label>
            <textarea class="form-textarea" id="implants" data-i18n-placeholder="implants_placeholder" placeholder="e.g., Pacemaker, Stent, Hip replacement, Insulin pump"></textarea>
            <div class="form-help" data-i18n="implants_help">Medical devices, prosthetics, or surgical implants</div>
          </div>

          <div class="form-actions full-width">
            <button type="submit" class="btn btn-warning" id="saveHealthBtn">
              <i class="fas fa-save"></i><span data-i18n="save_health">Save Health Data</span>
            </button>
          </div>
        </form>
      </div>

      <!-- ICE Contacts -->
      <div class="card ice">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-phone"></i></div>
          <div>
            <h2 class="card-title" data-i18n="ice_title">ICE â€” Emergency Contacts</h2>
            <p class="card-subtitle" data-i18n="ice_subtitle">In Case of Emergency contacts (up to 3)</p>
          </div>
        </div>

        <div id="iceContactsContainer"></div>

        <div class="add-ice-contact" id="addIceContact" style="display:none;">
          <i class="fas fa-plus" style="font-size:2rem;margin-bottom:.5rem;"></i>
          <div data-i18n="add_ice_contact">Add Emergency Contact</div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-primary" id="saveIceBtn">
            <i class="fas fa-save"></i><span data-i18n="save_ice">Save Contacts</span>
          </button>
        </div>
      </div>

      <!-- QR -->
      <div class="card qr">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-qrcode"></i></div>
          <div>
            <h2 class="card-title" data-i18n="qr_title">QR â€” Emergency Access Code</h2>
            <p class="card-subtitle" data-i18n="qr_subtitle">Share this QR code for instant access to your emergency information</p>
          </div>
        </div>

        <div class="qr-section">
          <div class="qr-container">
            <div class="qr-code" id="qrCode">
              <div class="loading"><div class="spinner"></div></div>
            </div>
            <div class="qr-code-display" id="qrCodeDisplay">Loading...</div>
            <div class="qr-url">
              <div class="qr-url-text" id="qrUrl">Loading...</div>
              <div class="qr-url-actions">
                <button class="qr-url-btn" id="copyUrlBtn" title="Copy URL"><i class="fas fa-copy"></i></button>
                <button class="qr-url-btn" id="openUrlBtn" title="Open URL"><i class="fas fa-external-link-alt"></i></button>
              </div>
            </div>
            <div class="form-help" data-i18n="qr_help">Emergency responders can scan this code to access your medical information</div>
          </div>

          <div class="qr-actions" style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
            <button type="button" class="btn btn-rose" id="regenerateQrBtn">
              <i class="fas fa-sync"></i><span data-i18n="regenerate_qr">Regenerate QR</span>
            </button>
            <button type="button" class="btn btn-secondary" id="downloadPngBtn">
              <i class="fas fa-download"></i><span data-i18n="download_png">Download PNG</span>
            </button>
            <button type="button" class="btn btn-secondary" id="downloadSvgBtn">
              <i class="fas fa-download"></i><span data-i18n="download_svg">Download SVG</span>
            </button>
            <button type="button" class="btn btn-secondary" id="printQrBtn">
              <i class="fas fa-print"></i><span data-i18n="print_qr">Print QR Code</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Delete Account -->
      <div class="card delete">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-trash-alt"></i></div>
          <div>
            <h2 class="card-title" data-i18n="delete_title">Delete Account</h2>
            <p class="card-subtitle" data-i18n="delete_subtitle">Permanently remove your account and all associated data</p>
          </div>
        </div>

        <div class="delete-warning">
          <div class="delete-warning-title">
            <i class="fas fa-exclamation-triangle"></i>
            <span data-i18n="delete_warning_title">Warning: This action cannot be undone</span>
          </div>
          <div class="delete-warning-text" data-i18n="delete_warning_text">
            Deleting your account will permanently remove all your personal information, medical data, emergency contacts, and QR codes from our system. This action is irreversible and cannot be undone.
          </div>
        </div>

        <div class="delete-confirmation">
          <label class="delete-confirmation-label" data-i18n="delete_confirmation_label">To confirm deletion, type "DELETE MY ACCOUNT" in the field below:</label>
          <input type="text" class="delete-confirmation-input" id="deleteConfirmation" data-i18n-placeholder="delete_confirmation_placeholder" placeholder="Type DELETE MY ACCOUNT">
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-danger" id="deleteAccountBtn" disabled>
            <i class="fas fa-trash-alt"></i><span data-i18n="delete_account">Delete My Account</span>
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Supabase config (kept as provided) ---
    const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage }
    });

    // --- i18n strings (as provided, trimmed) ---
    const I18N = {
      en: {
        'system-name':'MYQER Emergency Dashboard','status-online':'Online','status-offline':'Offline',
        'lang-english':'English','lang-spanish':'EspaÃ±ol','lang-french':'FranÃ§ais','logout':'Logout',
        'identity_title':'Identity â€” Personal Information','identity_subtitle':'Complete your personal information for emergency response',
        'first_name':'First Name','last_name':'Last Name','date_of_birth':'Date of Birth','phone':'Phone Number','country':'Country','emergency_contact':'Emergency Contact',
        'medical_id':'Medical/National ID (Optional)','save':'Save Information','reset':'Reset','saving':'Saving...','saved':'Information saved successfully','synced':'Synced to cloud',
        'validation_error_first_name':'First name is required','validation_error_last_name':'Last name is required',
        'offline_mode':"You're offline. Changes will sync when connection is restored.",
        'first-name-placeholder':'Enter your first name','last-name-placeholder':'Enter your last name','phone-placeholder':'Enter your phone number','emergency-contact-placeholder':'Enter emergency contact name','medical-id-placeholder':'Enter your medical or national ID','medical_id_help':'This information is optional and will be kept secure','select-country':'Select your country',
        'critical_title':'CRITICAL â€” Medical & Health Details','critical_subtitle':'Essential medical information for emergency responders','blood_type':'Blood Type',
        'allergies':'Critical Allergies','allergies_help':'List all life-threatening allergies, separated by commas','conditions':'Medical Conditions','conditions_help':'Include chronic conditions, disabilities, and ongoing health issues','medications':'Current Medications','medications_help':'Include medication name, dosage, and frequency','implants':'Implants/Medical Devices','implants_help':'Medical devices, prosthetics, or surgical implants',
        'organ_donor':'Organ Donor','triage_auto':'Auto','triage_green':'Green','triage_amber':'Amber','triage_red':'Red','triage_black':'Black','auto':'Auto','green':'Green','amber':'Amber','red':'Red','black':'Black','save_health':'Save Health Data','health_saved':'Health data saved successfully',
        'allergies_placeholder':'e.g., Penicillin, Nuts, Shellfish, Latex','conditions_placeholder':'e.g., Diabetes Type 2, Hypertension, Epilepsy, Asthma, Heart Disease','medications_placeholder':'e.g., Metformin 500mg twice daily, Lisinopril 10mg once daily','implants_placeholder':'e.g., Pacemaker, Stent, Hip replacement, Insulin pump',
        'ice_title':'ICE â€” Emergency Contacts','ice_subtitle':'In Case of Emergency contacts (up to 3)','add_ice_contact':'Add Emergency Contact','ice_name':'Full Name','ice_relationship':'Relationship','ice_phone':'Phone Number','ice_name_placeholder':'Enter contact name','ice_relationship_placeholder':'e.g., Spouse, Parent, Sibling','ice_phone_placeholder':'Enter phone number','save_ice':'Save Contacts','ice_saved':'Emergency contacts saved successfully',
        'qr_title':'QR â€” Emergency Access Code','qr_subtitle':'Share this QR code for instant access to your emergency information','qr_help':'Emergency responders can scan this code to access your medical information','regenerate_qr':'Regenerate QR','download_png':'Download PNG','download_svg':'Download SVG','print_qr':'Print QR Code','sync_pending':'Sync pending...','url_copied':'URL copied to clipboard','copy_failed':'Failed to copy URL',
        'delete_title':'Delete Account','delete_subtitle':'Permanently remove your account and all associated data','delete_warning_title':'Warning: This action cannot be undone','delete_warning_text':'Deleting your account will permanently remove all your personal information, medical data, emergency contacts, and QR codes from our system. This action is irreversible and cannot be undone.','delete_confirmation_label':'To confirm deletion, type "DELETE MY ACCOUNT" in the field below:','delete_confirmation_placeholder':'Type DELETE MY ACCOUNT','delete_account':'Delete My Account','account_deleted':'Account deleted successfully','delete_error':'Error deleting account. Please try again.'
      },
      es: {/* ... (kept same as your post) ... */},
      fr: {/* ... (kept same as your post) ... */}
    };

    const COUNTRIES = {
      en:[{code:'US',name:'United States'},{code:'CA',name:'Canada'},{code:'GB',name:'United Kingdom'},{code:'DE',name:'Germany'},{code:'FR',name:'France'},{code:'ES',name:'Spain'},{code:'IT',name:'Italy'},{code:'AU',name:'Australia'},{code:'JP',name:'Japan'},{code:'CN',name:'China'},{code:'IN',name:'India'},{code:'BR',name:'Brazil'},{code:'MX',name:'Mexico'},{code:'ZA',name:'South Africa'},{code:'NG',name:'Nigeria'},{code:'EG',name:'Egypt'},{code:'TR',name:'Turkey'},{code:'SA',name:'Saudi Arabia'}],
      es:[{code:'US',name:'Estados Unidos'},{code:'CA',name:'CanadÃ¡'},{code:'GB',name:'Reino Unido'},{code:'DE',name:'Alemania'},{code:'FR',name:'Francia'},{code:'ES',name:'EspaÃ±a'},{code:'IT',name:'Italia'},{code:'AU',name:'Australia'},{code:'JP',name:'JapÃ³n'},{code:'CN',name:'China'},{code:'IN',name:'India'},{code:'BR',name:'Brasil'},{code:'MX',name:'MÃ©xico'},{code:'ZA',name:'SudÃ¡frica'},{code:'NG',name:'Nigeria'},{code:'EG',name:'Egipto'},{code:'TR',name:'TurquÃ­a'},{code:'SA',name:'Arabia Saudita'}],
      fr:[{code:'US',name:'Ã‰tats-Unis'},{code:'CA',name:'Canada'},{code:'GB',name:'Royaume-Uni'},{code:'DE',name:'Allemagne'},{code:'FR',name:'France'},{code:'ES',name:'Espagne'},{code:'IT',name:'Italie'},{code:'AU',name:'Australie'},{code:'JP',name:'Japon'},{code:'CN',name:'Chine'},{code:'IN',name:'Inde'},{code:'BR',name:'BrÃ©sil'},{code:'MX',name:'Mexique'},{code:'ZA',name:'Afrique du Sud'},{code:'NG',name:'Nigeria'},{code:'EG',name:'Ã‰gypte'},{code:'TR',name:'Turquie'},{code:'SA',name:'Arabie Saoudite'}]
    };

    // --- Globals ---
    let currentUser = null;
    let currentLanguage = localStorage.getItem('myqer_language') || 'en';
    let userCode = null;
    let autosaveTimeout = null;
    let healthAutosaveTimeout = null;
    let iceAutosaveTimeout = null;
    let syncQueue = JSON.parse(localStorage.getItem('myqer_sync_queue') || '[]');
    let iceContacts = [];

    // --- Tiny DOM helpers ---
    const $ = (id) => document.getElementById(id);

    // --- Toasts & Saving indicator ---
    function showToast(type='info', message='') {
      const container = $('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icon = {
        success:'fa-circle-check', error:'fa-circle-exclamation',
        info:'fa-circle-info', warning:'fa-triangle-exclamation'
      }[type] || 'fa-circle-info';
      toast.innerHTML = `
        <i class="toast-icon fas ${icon}"></i>
        <div class="toast-message">${message}</div>
      `;
      container.appendChild(toast);
      requestAnimationFrame(()=>toast.classList.add('show'));
      setTimeout(()=>{
        toast.classList.remove('show');
        setTimeout(()=>toast.remove(),300);
      }, 3000);
    }

    function showSavingIndicator(){ $('savingIndicator').classList.add('show'); }
    function hideSavingIndicator(){ $('savingIndicator').classList.remove('show'); }

    // --- Language ---
    function changeLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('myqer_language', lang);
      updateLanguage(lang);
      updateLanguageUI(lang);
    }

    function updateLanguage(lang) {
      const elements = document.querySelectorAll('[data-i18n]');
      elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (I18N[lang] && I18N[lang][key]) el.textContent = I18N[lang][key];
      });
      const placeholderEls = document.querySelectorAll('[data-i18n-placeholder]');
      placeholderEls.forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        if (I18N[lang] && I18N[lang][key]) el.placeholder = I18N[lang][key];
      });
      populateCountryDropdown();
    }

    function updateLanguageUI(lang){
      const flags = { en:'ðŸ‡ºðŸ‡¸', es:'ðŸ‡ªðŸ‡¸', fr:'ðŸ‡«ðŸ‡·' };
      const codes = { en:'EN', es:'ES', fr:'FR' };
      $('currentLanguage').textContent = `${flags[lang]} ${codes[lang]}`;
      document.querySelectorAll('.language-option').forEach(opt=>{
        opt.classList.toggle('active', opt.dataset.lang===lang);
      });
    }

    // --- Online/offline ---
    function checkOnlineStatus(){ updateOnlineStatus(navigator.onLine); }
    function updateOnlineStatus(isOnline){
      const statusDot = $('statusDot');
      const statusText = $('statusText');
      const offlineBanner = $('offlineBanner');
      if (isOnline) {
        statusDot.classList.remove('offline');
        statusText.setAttribute('data-i18n','status-online');
        offlineBanner.classList.remove('show');
      } else {
        statusDot.classList.add('offline');
        statusText.setAttribute('data-i18n','status-offline');
        offlineBanner.classList.add('show');
      }
      updateLanguage(currentLanguage);
    }

    // --- Country dropdown ---
    function populateCountryDropdown() {
      const countrySelect = $('country');
      const currentValue = countrySelect.value;
      while (countrySelect.children.length > 1) countrySelect.removeChild(countrySelect.lastChild);
      (COUNTRIES[currentLanguage] || COUNTRIES.en).forEach(country=>{
        const opt = document.createElement('option');
        opt.value = country.code; opt.textContent = country.name;
        countrySelect.appendChild(opt);
      });
      if (currentValue) countrySelect.value = currentValue;
    }

    // --- Auth / UI Setup ---
    async function initializeApp() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) {
          window.location.href = 'index.html';
          return;
        }
        currentUser = session.user;

        // Top-right info
        $('userEmail').textContent = currentUser.email;
        $('userAvatar').textContent = (currentUser.email || 'U').charAt(0).toUpperCase();

        setupEventListeners();
        populateCountryDropdown();
        await ensureUserCode();
        await loadUserProfile();
        await loadHealthData();
        await loadIceContacts();
        await generateQRCode();
        updateLanguage(currentLanguage);
        checkOnlineStatus();
        await processSyncQueue();
        updateTriage();

        // react to auth changes
        supabase.auth.onAuthStateChange((_evt, newSession) => {
          if (!newSession) {
            try { localStorage.clear(); sessionStorage.clear(); } catch {}
            location.href = 'index.html';
          }
        });
      } catch (e) {
        console.error('Initialization error:', e);
        window.location.href = 'index.html';
      }
    }

    function setupEventListeners(){
      // Logout
      $('logoutBtn').addEventListener('click', handleLogout);

      // Language dropdown
      const trigger = $('languageTrigger');
      const menu = $('languageMenu');
      trigger.addEventListener('click', e=>{ e.stopPropagation(); menu.classList.toggle('active'); });
      document.addEventListener('click', ()=>menu.classList.remove('active'));
      document.querySelectorAll('.language-option').forEach(opt=>{
        opt.addEventListener('click', e=>{
          changeLanguage(e.currentTarget.dataset.lang);
          menu.classList.remove('active');
        });
      });

      // Identity
      $('identityForm').addEventListener('submit', handleSaveIdentity);
      $('resetBtn').addEventListener('click', handleResetIdentity);
      ['firstName','lastName','dob','phone','country','emergencyContact','medicalId'].forEach(id=>{
        const el = $(id);
        el.addEventListener('input', handleIdentityAutoSave);
        el.addEventListener('change', handleIdentityAutoSave);
      });

      // Health
      $('healthForm').addEventListener('submit', handleSaveHealth);
      ['bloodType','allergies','conditions','medications','implants','organDonor','triageOverride'].forEach(id=>{
        const el=$(id);
        el.addEventListener('input', handleHealthAutoSave);
        el.addEventListener('change', handleHealthAutoSave);
      });

      // ICE
      $('saveIceBtn').addEventListener('click', handleSaveIce);
      $('addIceContact').addEventListener('click', addIceContact);

      // QR
      $('regenerateQrBtn').addEventListener('click', regenerateQRCode);
      $('downloadPngBtn').addEventListener('click', downloadQRPNG);
      $('downloadSvgBtn').addEventListener('click', downloadQRSVG);
      $('printQrBtn').addEventListener('click', printQRCode);
      $('copyUrlBtn').addEventListener('click', copyQRUrl);
      $('openUrlBtn').addEventListener('click', openQRUrl);

      // Delete
      $('deleteConfirmation').addEventListener('input', handleDeleteConfirmationInput);
      $('deleteAccountBtn').addEventListener('click', handleDeleteAccount);

      // Online/offline
      window.addEventListener('online', async ()=>{ updateOnlineStatus(true); await processSyncQueue(); });
      window.addEventListener('offline', ()=>updateOnlineStatus(false));
    }

    async function handleLogout(){
      try {
        await supabase.auth.signOut();
      } catch(e){ console.warn('Signout error (ignored):', e); }
      try { localStorage.clear(); sessionStorage.clear(); } catch {}
      location.href = 'index.html';
    }

    // --- User Code ---
    async function ensureUserCode(){
      if (!currentUser) return;
      try {
        if (navigator.onLine){
          const { data, error } = await supabase.rpc('get_or_set_code');
          if (error) throw error;
          userCode = data;
          localStorage.setItem('myqer_code', userCode);
        } else {
          userCode = localStorage.getItem('myqer_code') || generateTempCode();
          localStorage.setItem('myqer_code', userCode);
        }
      } catch(e){
        console.error('ensureUserCode error:', e);
        userCode = localStorage.getItem('myqer_code') || generateTempCode();
        localStorage.setItem('myqer_code', userCode);
      }
    }
    function generateTempCode(){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let code='';
      for(let i=0;i<6;i++) code += chars.charAt(Math.floor(Math.random()*chars.length));
      return code;
    }

    // --- Identity ---
    async function loadUserProfile(){
      if (!currentUser) return;
      let profileData = null;
      if (navigator.onLine){
        try{
          const { data, error } = await supabase.rpc('get_profile');
          if (!error && data && data.length>0){
            profileData = data[0];
            localStorage.setItem('myqer_profile', JSON.stringify(profileData));
          }
        } catch{ /* fall back */ }
      }
      if (!profileData){
        const local = localStorage.getItem('myqer_profile');
        if (local) profileData = JSON.parse(local);
      }
      if (profileData) populateIdentityForm(profileData);
    }
    function populateIdentityForm(data){
      const map = {firstName:'first_name',lastName:'last_name',dob:'dob',phone:'phone',country:'country',emergencyContact:'emergency_contact',medicalId:'medical_id'};
      Object.entries(map).forEach(([elId, key])=>{
        const el = $(elId);
        if (el && data[key] !== undefined && data[key] !== null) el.value = data[key];
      });
    }
    function validateIdentityForm(){
      const firstName = $('firstName'), lastName = $('lastName');
      const firstNameError = $('firstNameError'), lastNameError = $('lastNameError');
      let ok = true;
      if (!firstName.value.trim()){ firstName.classList.add('error'); firstNameError.classList.add('show'); ok=false; } else { firstName.classList.remove('error'); firstNameError.classList.remove('show'); }
      if (!lastName.value.trim()){ lastName.classList.add('error'); lastNameError.classList.add('show'); ok=false; } else { lastName.classList.remove('error'); lastNameError.classList.remove('show'); }
      return ok;
    }
    function getIdentityFormData(){
      return {
        first_name:$('firstName').value.trim(),
        last_name:$('lastName').value.trim(),
        dob:$('dob').value || null,
        phone:$('phone').value.trim() || null,
        country:$('country').value || null,
        emergency_contact:$('emergencyContact').value.trim() || null,
        medical_id:$('medicalId').value.trim() || null
      };
    }
    async function saveIdentityToServer(data){
      const { error } = await supabase.rpc('save_profile', { profile_data: data });
      if (error) throw error;
    }
    function saveIdentityToLocal(data){ localStorage.setItem('myqer_profile', JSON.stringify(data)); }
    function addIdentityToSyncQueue(data){ syncQueue.push({ type:'profile', data, timestamp:Date.now() }); localStorage.setItem('myqer_sync_queue', JSON.stringify(syncQueue)); }

    async function handleSaveIdentity(e){
      e.preventDefault();
      if (!validateIdentityForm()) return;
      const btn=$('saveBtn'), icon=btn.querySelector('i'), text=btn.querySelector('span'), orig=text.textContent;
      btn.disabled=true; icon.className='btn-spinner'; text.textContent=I18N[currentLanguage].saving; showSavingIndicator();
      try{
        const formData = getIdentityFormData();
        if (navigator.onLine){ await saveIdentityToServer(formData); saveIdentityToLocal(formData); showToast('success', I18N[currentLanguage].saved); }
        else { saveIdentityToLocal(formData); addIdentityToSyncQueue(formData); showToast('warning', I18N[currentLanguage].sync_pending); }
      } catch(err){ console.error('Save identity error:', err); showToast('error','Error saving data. Please try again.'); }
      finally{
        setTimeout(()=>{ btn.disabled=false; icon.className='fas fa-save'; text.textContent=orig; hideSavingIndicator(); }, 800);
      }
    }
    async function handleResetIdentity(){
      if (navigator.onLine) await loadUserProfile(); else $('identityForm').reset();
    }
    function handleIdentityAutoSave(){
      if (autosaveTimeout) clearTimeout(autosaveTimeout);
      autosaveTimeout = setTimeout(async ()=>{
        if (!validateIdentityForm()) return;
        showSavingIndicator();
        try{
          const formData = getIdentityFormData();
          if (navigator.onLine){ await saveIdentityToServer(formData); saveIdentityToLocal(formData); showToast('success', I18N[currentLanguage].synced); }
          else { saveIdentityToLocal(formData); addIdentityToSyncQueue(formData); showToast('warning', I18N[currentLanguage].sync_pending); }
        } catch(e){ console.error('Identity autosave error:', e); }
        finally{ hideSavingIndicator(); }
      }, 900);
    }

    // --- Health ---
    async function loadHealthData(){
      if (!currentUser) return;
      let healthData = null;
      if (navigator.onLine){
        try {
          const { data, error } = await supabase.rpc('get_health');
          if (!error && data && data.length>0){ healthData = data[0]; localStorage.setItem('myqer_health', JSON.stringify(healthData)); }
        } catch{ /* fallback */ }
      }
      if (!healthData){
        const local = localStorage.getItem('myqer_health');
        if (local) healthData = JSON.parse(local);
      }
      if (healthData) populateHealthForm(healthData);
    }
    function populateHealthForm(data){
      const map = {bloodType:'blood_type',allergies:'allergies',conditions:'conditions',medications:'medications',implants:'implants',organDonor:'organ_donor',triageOverride:'triage_override'};
      Object.entries(map).forEach(([elId,key])=>{
        const el=$(elId);
        if (!el) return;
        if (el.type==='checkbox') el.checked = !!data[key];
        else el.value = data[key] || '';
      });
    }
    function getHealthFormData(){
      return {
        blood_type:$('bloodType').value || null,
        allergies:$('allergies').value.trim() || null,
        conditions:$('conditions').value.trim() || null,
        medications:$('medications').value.trim() || null,
        implants:$('implants').value.trim() || null,
        organ_donor:$('organDonor').checked,
        triage_override:$('triageOverride').value
      };
    }
    async function saveHealthToServer(data){
      const { error } = await supabase.rpc('save_health', { health_data: data });
      if (error) throw error;
    }
    function saveHealthToLocal(data){ localStorage.setItem('myqer_health', JSON.stringify(data)); }
    function addHealthToSyncQueue(data){ syncQueue.push({ type:'health', data, timestamp:Date.now() }); localStorage.setItem('myqer_sync_queue', JSON.stringify(syncQueue)); }

    async function handleSaveHealth(e){
      e.preventDefault();
      const btn=$('saveHealthBtn'), icon=btn.querySelector('i'), text=btn.querySelector('span'), orig=text.textContent;
      btn.disabled=true; icon.className='btn-spinner'; text.textContent=I18N[currentLanguage].saving; showSavingIndicator();
      try{
        const formData = getHealthFormData();
        if (navigator.onLine){ await saveHealthToServer(formData); saveHealthToLocal(formData); showToast('success', I18N[currentLanguage].health_saved); }
        else { saveHealthToLocal(formData); addHealthToSyncQueue(formData); showToast('warning', I18N[currentLanguage].sync_pending); }
        updateTriage();
      } catch(err){ console.error('Save health error:', err); showToast('error', 'Error saving health data. Please try again.'); }
      finally{
        setTimeout(()=>{ btn.disabled=false; icon.className='fas fa-save'; text.textContent=orig; hideSavingIndicator(); }, 800);
      }
    }
    function handleHealthAutoSave(){
      if (healthAutosaveTimeout) clearTimeout(healthAutosaveTimeout);
      healthAutosaveTimeout = setTimeout(async ()=>{
        showSavingIndicator();
        try{
          const formData = getHealthFormData();
          if (navigator.onLine){ await saveHealthToServer(formData); saveHealthToLocal(formData); showToast('success', I18N[currentLanguage].synced); }
          else { saveHealthToLocal(formData); addHealthToSyncQueue(formData); showToast('warning', I18N[currentLanguage].sync_pending); }
          updateTriage();
        } catch(e){ console.error('Health autosave error:', e); }
        finally{ hideSavingIndicator(); }
      }, 900);
    }

    // --- Triage ---
    function updateTriage(){
      const override = $('triageOverride').value;
      const pill=$('triagePill'), text=$('triageText');
      let level = override !== 'auto' ? override : calculateAutoTriage();
      pill.className = `triage-pill triage-${level}`;
      text.setAttribute('data-i18n', level);
      if (I18N[currentLanguage] && I18N[currentLanguage][level]) text.textContent = I18N[currentLanguage][level];
    }

    function calculateAutoTriage(){
      const allergies = $('allergies').value.toLowerCase();
      const conditions = $('conditions').value.toLowerCase();
      const medications = $('medications').value.toLowerCase();
      const implants = $('implants').value.toLowerCase();
      const bloodType = $('bloodType').value;
      const allText = `${allergies} ${conditions} ${medications} ${implants}`;
      const hardRed = [
        'anaphylaxis','epipen','shock','myocardial infarction','heart attack',
        'stroke','seizure','status epilepticus','respiratory failure',
        'airway compromise','insulin pump','dialysis','transplant',
        'pacemaker','defibrillator','anticoagulant','hemophilia',
        'severe asthma','oxygen dependent','malignant','metastatic',
        'midazolam','chemo','chemotherapy'
      ];
      for (const k of hardRed) if (allText.includes(k)) return 'red';
      if (allergies.trim() || conditions.trim() || medications.trim() || implants.trim() || bloodType) return 'amber';
      return 'green';
    }

    // --- ICE Contacts ---
    async function loadIceContacts(){
      if (!currentUser) return;
      let iceData = null;
      if (navigator.onLine){
        try {
          const { data, error } = await supabase.rpc('get_ice_contacts');
          if (!error && data){ iceData = data; localStorage.setItem('myqer_ice', JSON.stringify(iceData)); }
        } catch { /* fallback */ }
      }
      if (!iceData){
        const local = localStorage.getItem('myqer_ice');
        if (local) iceData = JSON.parse(local);
      }
      iceContacts = Array.isArray(iceData) ? iceData : [];
      renderIceContacts();
    }

    function renderIceContacts(){
      const container = $('iceContactsContainer');
      const addBtn = $('addIceContact');
      container.innerHTML = '';
      iceContacts.forEach((contact, index)=>{
        const div = document.createElement('div');
        div.className = 'ice-contact';
        div.innerHTML = `
          <div class="ice-contact-header">
            <div class="ice-contact-number">${index+1}</div>
            <button type="button" class="ice-contact-remove" data-index="${index}">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="ice-contact-grid">
            <div class="form-group">
              <label class="form-label" data-i18n="ice_name">Full Name</label>
              <input type="text" class="form-input" value="${contact.name || ''}" data-field="name" data-index="${index}" data-i18n-placeholder="ice_name_placeholder" placeholder="Enter contact name">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="ice_relationship">Relationship</label>
              <input type="text" class="form-input" value="${contact.relationship || ''}" data-field="relationship" data-index="${index}" data-i18n-placeholder="ice_relationship_placeholder" placeholder="e.g., Spouse, Parent, Sibling">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="ice_phone">Phone Number</label>
              <input type="tel" class="form-input" value="${contact.phone || ''}" data-field="phone" data-index="${index}" data-i18n-placeholder="ice_phone_placeholder" placeholder="Enter phone number">
            </div>
          </div>
        `;
        container.appendChild(div);
      });

      // wire remove + inputs
      container.querySelectorAll('.ice-contact-remove').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = parseInt(btn.getAttribute('data-index'), 10);
          removeIceContact(idx);
        });
      });
      container.querySelectorAll('input[data-field]').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const idx = parseInt(inp.getAttribute('data-index'), 10);
          const field = inp.getAttribute('data-field');
          updateIceContact(idx, field, inp.value);
        });
      });

      addBtn.style.display = iceContacts.length < 3 ? 'block' : 'none';
      updateLanguage(currentLanguage);
    }

    function addIceContact(){
      if (iceContacts.length >= 3) return;
      iceContacts.push({ name:'', relationship:'', phone:'', contact_order: iceContacts.length + 1 });
      renderIceContacts();
      handleIceAutoSave();
    }
    function removeIceContact(index){
      iceContacts.splice(index, 1);
      iceContacts.forEach((c, i)=> c.contact_order = i+1);
      renderIceContacts();
      handleIceAutoSave();
    }
    function updateIceContact(index, field, value){
      if (iceContacts[index]) {
        iceContacts[index][field] = value;
        handleIceAutoSave();
      }
    }
    function getIceFormData(){
      return iceContacts.filter(c => (c.name||'').trim() || (c.relationship||'').trim() || (c.phone||'').trim());
    }
    async function saveIceToServer(data){
      const { error } = await supabase.rpc('save_ice_contacts', { contacts_data: data });
      if (error) throw error;
    }
    function saveIceToLocal(data){ localStorage.setItem('myqer_ice', JSON.stringify(data)); }
    function addIceToSyncQueue(data){ syncQueue.push({ type:'ice', data, timestamp:Date.now() }); localStorage.setItem('myqer_sync_queue', JSON.stringify(syncQueue)); }

    async function handleSaveIce(){
      const btn=$('saveIceBtn'), icon=btn.querySelector('i'), text=btn.querySelector('span'), orig=text.textContent;
      btn.disabled=true; icon.className='btn-spinner'; text.textContent=I18N[currentLanguage].saving; showSavingIndicator();
      try{
        const formData = getIceFormData();
        if (navigator.onLine){ await saveIceToServer(formData); saveIceToLocal(formData); showToast('success', I18N[currentLanguage].ice_saved); }
        else { saveIceToLocal(formData); addIceToSyncQueue(formData); showToast('warning', I18N[currentLanguage].sync_pending); }
      } catch(err){ console.error('Save ICE error:', err); showToast('error', 'Error saving ICE contacts. Please try again.'); }
      finally{
        setTimeout(()=>{ btn.disabled=false; icon.className='fas fa-save'; text.textContent=orig; hideSavingIndicator(); }, 800);
      }
    }
    function handleIceAutoSave(){
      if (iceAutosaveTimeout) clearTimeout(iceAutosaveTimeout);
      iceAutosaveTimeout = setTimeout(async ()=>{
        showSavingIndicator();
        try{
          const formData = getIceFormData();
          if (navigator.onLine){ await saveIceToServer(formData); saveIceToLocal(formData); showToast('success', I18N[currentLanguage].synced); }
          else { saveIceToLocal(formData); addIceToSyncQueue(formData); showToast('warning', I18N[currentLanguage].sync_pending); }
        } catch(e){ console.error('ICE autosave error:', e); }
        finally{ hideSavingIndicator(); }
      }, 900);
    }

    // --- Sync queue ---
    async function processSyncQueue(){
      if (!navigator.onLine || !syncQueue.length) return;
      const queue = [...syncQueue];
      for (const item of queue){
        try{
          if (item.type==='profile') await saveIdentityToServer(item.data);
          if (item.type==='health') await saveHealthToServer(item.data);
          if (item.type==='ice') await saveIceToServer(item.data);
          // remove item
          syncQueue = syncQueue.filter(q => q !== item);
          localStorage.setItem('myqer_sync_queue', JSON.stringify(syncQueue));
        } catch(e){
          // stop on first failure to retry later
          console.warn('Sync item failed, will retry later:', e);
          break;
        }
      }
      if (queue.length) showToast('success', I18N[currentLanguage].synced || 'Synced to cloud');
    }

    // --- QR Code ---
    async function generateQRCode(){
      if (!userCode) return;
      const container = $('qrCode');
      const display = $('qrCodeDisplay');
      const urlEl = $('qrUrl');
      const qrUrl = `https://www.myqer.com/c/${userCode}`;
      try{
        container.innerHTML = '';
        const canvas = document.createElement('canvas');
        await QRCode.toCanvas(canvas, qrUrl, { width:260, margin:2, color:{ dark:'#0F172A', light:'#FFFFFF' } });
        container.appendChild(canvas);
        display.textContent = userCode;
        urlEl.textContent = qrUrl;
      } catch(e){
        console.error('QR generation error:', e);
        container.innerHTML = '<div class="loading">Error generating QR code</div>';
      }
    }
    function regenerateQRCode(){ generateQRCode(); }
    async function copyQRUrl(){
      if (!userCode) return;
      const qrUrl = `https://www.myqer.com/c/${userCode}`;
      try{ await navigator.clipboard.writeText(qrUrl); showToast('success', I18N[currentLanguage].url_copied); }
      catch{ showToast('error', I18N[currentLanguage].copy_failed); }
    }
    function openQRUrl(){ if (userCode) window.open(`https://www.myqer.com/c/${userCode}`,'_blank'); }

    async function downloadQRPNG(){
      if (!userCode) return;
      try{
        const qrUrl = `https://www.myqer.com/c/${userCode}`;
        const canvas = document.createElement('canvas');
        await QRCode.toCanvas(canvas, qrUrl, { width:400, margin:4, color:{ dark:'#0F172A', light:'#FFFFFF' } });
        const link = document.createElement('a');
        link.download = `myqer-emergency-qr-${userCode}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch(e){ console.error('PNG download error:', e); showToast('error','Error downloading PNG'); }
    }

    async function downloadQRSVG(){
      if (!userCode) return;
      try{
        const qrUrl = `https://www.myqer.com/c/${userCode}`;
        const svg = await QRCode.toString(qrUrl, { type:'svg', width:400, margin:4, color:{ dark:'#0F172A', light:'#FFFFFF' } });
        const blob = new Blob([svg], { type:'image/svg+xml' });
        const link = document.createElement('a');
        link.download = `myqer-emergency-qr-${userCode}.svg`;
        link.href = URL.createObjectURL(blob);
        link.click();
        setTimeout(()=>URL.revokeObjectURL(link.href), 2000);
      } catch(e){ console.error('SVG download error:', e); showToast('error','Error downloading SVG'); }
    }

    function printQRCode(){
      if (!userCode) return;
      const qrUrl = `https://www.myqer.com/c/${userCode}`;
      const w = window.open('', '_blank');
      w.document.write(`
        <!DOCTYPE html><html><head><title>MYQER Emergency QR Code - ${userCode}</title>
          <meta charset="utf-8">
          <style>
            body{font-family:Arial,sans-serif;text-align:center;padding:2rem}
            .qr-container{margin:2rem auto;max-width:420px}
            .qr-code{margin:1rem 0}
            .qr-code-display{font-family:monospace;font-size:1.5rem;font-weight:bold;margin:1rem 0;letter-spacing:.2em}
            .qr-url{font-family:monospace;font-size:1.1rem;margin:1rem 0;word-break:break-all}
            .instructions{margin-top:2rem;font-size:.9rem;color:#666}
          </style>
        </head><body>
          <h1>MYQER Emergency QR Code</h1>
          <div class="qr-container">
            <div class="qr-code" id="printQrCode"></div>
            <div class="qr-code-display">${userCode}</div>
            <div class="qr-url">${qrUrl}</div>
            <div class="instructions">
              <p>Emergency responders can scan this QR code to access your medical information.</p>
              <p>Keep this code accessible in case of emergency.</p>
            </div>
          </div>
          <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
          <script>
            (async function(){
              const target = document.getElementById('printQrCode');
              const canvas = document.createElement('canvas');
              await QRCode.toCanvas(canvas, '${qrUrl}', { width:300, margin:2, color:{dark:'#0F172A', light:'#FFFFFF'} });
              target.appendChild(canvas);
              setTimeout(()=>{ window.print(); window.close(); }, 250);
            })();
          </script>
        </body></html>
      `);
      w.document.close();
    }

    // --- Delete Account ---
    function handleDeleteConfirmationInput(){
      const input=$('deleteConfirmation'), btn=$('deleteAccountBtn');
      if (input.value === 'DELETE MY ACCOUNT'){ input.classList.add('valid'); btn.disabled=false; }
      else { input.classList.remove('valid'); btn.disabled=true; }
    }
    async function handleDeleteAccount(){
      const btn=$('deleteAccountBtn'), icon=btn.querySelector('i'), text=btn.querySelector('span'), orig=text.textContent;
      btn.disabled=true; icon.className='btn-spinner'; text.textContent=I18N[currentLanguage].saving; showSavingIndicator();
      try {
        if (navigator.onLine){
          const { error } = await supabase.rpc('delete_account'); // your RPC exists already
          if (error) throw error;
        }
        try { localStorage.clear(); sessionStorage.clear(); } catch {}
        await supabase.auth.signOut();
        showToast('success', I18N[currentLanguage].account_deleted);
        setTimeout(()=>{ location.href='index.html'; }, 600);
      } catch(e){
        console.error('Delete account error:', e);
        showToast('error', I18N[currentLanguage].delete_error);
        btn.disabled=false; icon.className='fas fa-trash-alt'; text.textContent=orig;
      } finally {
        hideSavingIndicator();
      }
    }

    // --- Boot ---
    document.addEventListener('DOMContentLoaded', ()=>{
      // set initial language UI
      updateLanguage(currentLanguage);
      updateLanguageUI(currentLanguage);
      initializeApp();
    });
  </script>
</body>
</html>
