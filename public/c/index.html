<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MYQERâ„¢ â€” Emergency Card</title>
  <style>
    :root{
      --red:#dc2626;
      --red-light:#fef2f2;
      --text:#111827;
      --text-light:#6b7280;
      --green:#10b981;
      --amber:#f59e0b;
      --surface:#ffffff;
      --border:#e5e7eb;
    }
    *{-webkit-font-smoothing:antialiased;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,Inter,system-ui,Segoe UI,Roboto,sans-serif;
      margin:0;background:#fff;color:var(--text);min-height:100vh;padding:8px
    }
    .wrap{max-width:340px;margin:0 auto}
    header{text-align:center;margin-bottom:12px}
    .brand{font-size:20px;font-weight:800;letter-spacing:-.02em;color:var(--text)}
    .brand .er{color:var(--red)}
    .tagline{color:var(--text-light);font-size:11px;margin-top:2px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;
      box-shadow:0 2px 8px rgba(220,38,38,.08),0 1px 3px rgba(0,0,0,.06);overflow:hidden}
    .card-header{padding:12px 16px 6px;text-align:center;background:linear-gradient(135deg,var(--red-light) 0%,#ffffff 100%)}
    h1{font-size:16px;font-weight:700;margin:0;color:var(--text)}
    .status-pill{display:inline-block;padding:3px 8px;border-radius:10px;font-size:9px;font-weight:700;margin-top:4px;
      text-transform:uppercase;letter-spacing:.5px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .status-pill.green{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .status-pill.amber{background:linear-gradient(135deg,#f97316,#ea580c);color:#fff}
    .status-pill.red{background:linear-gradient(135deg,var(--red),#b91c1c);color:#fff}
    .status-pill.black{background:linear-gradient(135deg,#4b5563,#111827);color:#fff}
    .updated-time{color:var(--text-light);font-size:9px;text-align:center;margin-top:3px}
    .card-body{padding:8px 12px 12px}
    .info-grid{display:grid;gap:6px}
    .info-section{background:var(--surface);border-radius:8px;padding:8px;border:1px solid var(--border);
      box-shadow:0 1px 2px rgba(220,38,38,.04)}
    .section-title{font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
    .info-row{display:flex;justify-content:space-between;padding:2px 0}
    .info-label{font-size:11px;font-weight:500;color:var(--text-light)}
    .info-value{font-size:11px;font-weight:600;color:var(--text);text-align:right}
    .content-box{background:var(--red-light);border-radius:6px;padding:6px;font-size:10px;line-height:1.3;color:var(--text);
      min-height:24px;border:1px solid rgba(220,38,38,.1);white-space:pre-wrap}
    .qr-section{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:8px;padding:8px;text-align:center;margin-top:6px;
      border:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,.05);display:grid;gap:10px}
    .qr-code{width:50px;height:50px;border-radius:6px;border:1px solid var(--border);margin:0 auto 6px;background:white;
      box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .qr-label{font-size:9px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
    .qr-url{font-family:ui-monospace,monospace;font-size:8px;color:var(--text-light);word-break:break-all;background:#fff;
      padding:3px 4px;border-radius:4px;border:1px solid var(--border)}
    .btn-row{display:flex;gap:6px;justify-content:center}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .disclaimer{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);color:#92400e;border-radius:6px;padding:6px;margin-top:6px;
      font-size:9px;text-align:center;font-weight:500}
    .err{color:var(--red);font-size:11px;margin-top:8px;text-align:center;display:none}
    footer{margin-top:12px;color:var(--text-light);font-size:9px;text-align:center}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111827;color:#fff;font-size:12px;padding:8px 12px;
      border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.2);opacity:0;transition:.25s;pointer-events:none}
    .toast.show{opacity:1}
    @media print{
      .btn-row, .tagline, footer { display:none !important; }
      .qr-code{width:90px;height:90px}
      .wrap{max-width:420px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MYQ<span class="er">ER</span><span style="font-size:.8em;vertical-align:super">â„¢</span></div>
      <div class="tagline">pronounced "my care"</div>
    </header>

    <div id="card" class="card">
      <div class="card-header">
        <h1>Emergency Profile</h1>
        <div id="triagePill" class="status-pill green">GREEN</div>
        <div class="updated-time" id="updated">Accessed via QR scan</div>
      </div>

      <div class="card-body">
        <div class="info-grid">
          <div class="info-section">
            <div class="section-title">Personal Information</div>
            <div class="info-row"><span class="info-label">Name</span><span class="info-value" id="fullName">â€”</span></div>
            <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value" id="dob">â€”</span></div>
            <div class="info-row"><span class="info-label">Blood Type</span><span class="info-value" id="blood">â€”</span></div>
            <div class="info-row"><span class="info-label">Organ Donor</span><span class="info-value" id="donor">â€”</span></div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Allergies</div>
            <div class="content-box" id="allergies">No known allergies</div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Conditions</div>
            <div class="content-box" id="conditions">No known conditions</div>
          </div>

          <div class="info-section">
            <div class="section-title">Current Medications</div>
            <div class="content-box" id="medications">No current medications</div>
          </div>

          <div class="info-section">
            <div class="section-title">Implants & Devices</div>
            <div class="content-box" id="implants">None reported</div>
          </div>

          <div class="info-section">
            <div class="section-title">Emergency Contacts</div>
            <div class="content-box" id="emergencyContacts">No contacts available</div>
          </div>
        </div>

        <div class="qr-section">
          <div>
            <div class="qr-label">Live Card (URL)</div>
            <img id="qrLive" class="qr-code" alt="Live QR (URL)" width="50" height="50">
            <div class="qr-url" id="cardUrl">myqer.com/c/â€¦</div>
          </div>

          <div class="info-section" style="margin-top:4px">
            <div class="section-title">Offline Snapshot (print/read)</div>
            <pre id="offlineSnapshot"
                 style="white-space:pre-wrap;margin:0;font-size:10px;line-height:1.3;background:#fef2f2;border:1px solid rgba(220,38,38,.12);border-radius:6px;padding:6px;color:#111827;">
Loadingâ€¦
            </pre>
          </div>

          <div class="btn-row">
            <button class="btn" id="copySnapshot">Copy Snapshot</button>
            <button class="btn" onclick="window.print()">Print Card</button>
          </div>
        </div>

        <div class="disclaimer">ðŸ”’ Read-only emergency information. Always verify clinically before treatment.</div>
        <div class="err" id="errBox"></div>
      </div>
    </div>

    <footer>Â© 2025 MYQERâ„¢</footer>
  </div>

  <div id="toast" class="toast">Copied</div>

<script>
(function(){
  // ---- Config
  const FN_BASE = 'https://dmntmhkncldgynufajei.functions.supabase.co/functions/v1/card';

  // ---- Helpers
  const $ = id => document.getElementById(id);
  const setText = (id, val, fallback='â€”') => $(id).textContent = (val && String(val).trim()) || fallback;

  function showToast(msg='Done'){
    const t = $('toast'); t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1200);
  }

  function fmtDOB(iso){
    if(!iso) return 'â€”';
    try{
      const d = new Date(iso);
      return d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
    }catch{ return String(iso); }
  }

  // very light, best-effort phone normalization based on country
  function formatPhone(num, country){
    if(!num) return '';
    const raw = String(num).replace(/[^\d+]/g,'');
    if(raw.startsWith('+')) return raw;
    if(raw.startsWith('00')) return '+'+raw.slice(2);

    const cc = (country||'').toUpperCase();
    const drop0 = s => s.replace(/^0+/, '');

    if(cc === 'GB' || cc === 'UK') return '+44 ' + drop0(raw);
    if(cc === 'US' || cc === 'CA') return '+1 ' + drop0(raw);
    if(cc === 'RO') return '+40 ' + drop0(raw);
    if(cc === 'DE') return '+49 ' + drop0(raw);
    if(cc === 'FR') return '+33 ' + drop0(raw);
    if(cc === 'ES') return '+34 ' + drop0(raw);
    if(cc === 'IT') return '+39 ' + drop0(raw);
    if(cc === 'PT') return '+351 ' + drop0(raw);
    if(cc === 'IN') return '+91 ' + drop0(raw);
    if(cc === 'AU') return '+61 ' + drop0(raw);
    if(cc === 'BR') return '+55 ' + drop0(raw);
    // fallback: just return digits
    return raw;
  }

  function clip(text, max){
    if(!text) return '';
    const s = String(text).trim();
    return s.length > max ? s.slice(0, max-1) + 'â€¦' : s;
  }

  function setTriage(level){
    const pill = $('triagePill');
    const lv = (level||'green').toLowerCase();
    const ok = ['green','amber','red','black'].includes(lv) ? lv : 'green';
    pill.className = 'status-pill ' + ok;
    pill.textContent = ok.toUpperCase();
  }

  // ---- Read the short code from /c/XXXX-XXXX or ?code=
  const parts = location.pathname.split('/').filter(Boolean);
  let code = (parts[0] === 'c' && parts[1]) ? parts[1] : null;
  if(!code){
    const u = new URL(location.href);
    code = (u.searchParams.get('code') || '').trim();
  }

  async function load(){
    if(!code){
      const e = $('errBox');
      e.textContent = 'Missing code in URL.'; e.style.display = 'block';
      return;
    }

    const cardUrl = `${FN_BASE}?code=${encodeURIComponent(code)}`;
    setText('cardUrl', cardUrl);
    // crisp QR (rendered 100px, displayed 50px)
    $('qrLive').src = 'https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=' + encodeURIComponent(cardUrl);

    try{
      const res = await fetch(cardUrl, { mode:'cors' });
      const data = await res.json();
      if(!res.ok || data.error){ throw new Error(data.error || 'Failed to load card'); }

      // structure from your Edge Function
      const p = data.profile || {};
      const s = data.sections || {};
      const h = {
        blood_type: s.blood?.value || data.health?.blood_type || '',
        organ_donor: !!(s.blood?.donor ?? data.health?.organ_donor),
        allergies: (Array.isArray(s.allergies?.items) ? s.allergies.items.join(', ') : (data.health?.allergies || '')) || '',
        conditions: (Array.isArray(s.conditions?.items) ? s.conditions.items.join(', ') : (data.health?.conditions || '')) || '',
        medications: (Array.isArray(s.meds?.items) ? s.meds.items.join(', ') : (data.health?.meds || data.health?.medications || '')) || '',
        implants: data.health?.implants || ''
      };
      const ice = (s.ice?.contacts || data.ice || []);

      // Fill fields
      setText('fullName', p.full_name || '-');
      setText('dob', fmtDOB(p.dob || p.date_of_birth));
      setText('blood', h.blood_type || '-');
      setText('donor', h.organ_donor ? 'Yes' : 'No');
      setText('allergies', clip(h.allergies || 'None listed', 240));
      setText('conditions', clip(h.conditions || 'None listed', 260));
      setText('medications', clip(h.medications || 'None listed', 260));
      setText('implants', clip(h.implants || 'None reported', 220));
      setTriage(p.triage || p.triage_override || p.triage_auto || 'green');

      // ICE section (show up to three)
      if(Array.isArray(ice) && ice.length){
        const country = p.country || '';
        const lines = ice.slice(0,3).map(c=>{
          const name = (c.name||'').toString().trim();
          const rel  = (c.relation||c.relationship||'').toString().trim();
          const ph   = formatPhone(c.phone||'', country);
          const segs = [name, rel && `â€” ${rel}`, ph && `â€” ${ph}`].filter(Boolean);
          return segs.join(' ');
        }).join('\n');
        setText('emergencyContacts', clip(lines, 260));
      }else{
        setText('emergencyContacts', 'No contacts available');
      }

      // Timestamp
      const ts = data.meta?.generated_at ? new Date(data.meta.generated_at) : new Date();
      $('updated').textContent = 'Updated ' + ts.toLocaleString();

      // Offline Snapshot (always present for printing)
      const primary = (Array.isArray(ice) && ice.length) ? ice[0] : {};
      const iceLine = [
        (primary.name||'').toString().trim(),
        primary.relation ? ` â€” ${primary.relation}` : '',
        primary.phone ? ` â€” ${formatPhone(primary.phone, p.country)}` : ''
      ].join('').trim();

      const snapshot = [
        'MYQER â€” Emergency Snapshot',
        `Name: ${p.full_name || 'â€”'}`,
        `DOB: ${fmtDOB(p.dob || p.date_of_birth)}`,
        `Blood: ${h.blood_type || 'â€”'}`,
        `Allergies: ${clip(h.allergies || 'None', 120)}`,
        `Conditions: ${clip(h.conditions || 'None', 160)}`,
        `Medications: ${clip(h.medications || 'None', 160)}`,
        `ICE: ${iceLine || 'â€”'}`
      ].join('\n');

      $('offlineSnapshot').textContent = snapshot;

      // Copy button
      $('copySnapshot').onclick = async () => {
        try{
          await navigator.clipboard.writeText(snapshot);
          showToast('Snapshot copied');
        }catch{
          showToast('Copy failed');
        }
      };

    }catch(err){
      const e = $('errBox');
      e.textContent = err.message || 'Error loading card.'; e.style.display = 'block';
      // Still provide an offline scaffold so the print works with minimal info
      const fallback = [
        'MYQER â€” Emergency Snapshot',
        'Name: â€”',
        'DOB: â€”',
        'Blood: â€”',
        'Allergies: â€”',
        'Conditions: â€”',
        'Medications: â€”',
        'ICE: â€”'
      ].join('\n');
      $('offlineSnapshot').textContent = fallback;
      setTriage('green');
    }
  }

  load();
})();
</script>
</body>
</html>
