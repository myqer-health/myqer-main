<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MYQERâ„¢ â€” Emergency Card</title>
  <style>
    :root{
      --red:#dc2626;
      --red-light:#fef2f2;
      --text:#111827;
      --text-light:#6b7280;
      --green:#10b981;
      --surface:#ffffff;
      --border:#f3f4f6;
    }
    *{ -webkit-font-smoothing:antialiased; box-sizing:border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      margin:0; background:#ffffff; color:var(--text);
      min-height:100vh; padding:8px;
    }
    .wrap{ max-width:340px; margin:0 auto; }
    header{ text-align:center; margin-bottom:12px; }
    .brand{ font-size:20px; font-weight:800; letter-spacing:-.02em; color:var(--text); }
    .brand .er{ color:var(--red); }
    .tagline{ color:var(--text-light); font-size:11px; margin-top:2px; }
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 2px 8px rgba(220,38,38,.08), 0 1px 3px rgba(0,0,0,.06); overflow:hidden;
    }
    .card-header{ padding:12px 16px 6px; text-align:center;
      background:linear-gradient(135deg, var(--red-light) 0%, #ffffff 100%); }
    h1{ font-size:16px; font-weight:700; margin:0; color:var(--text); }
    .status-pill{
      display:inline-block; padding:3px 8px; border-radius:10px; font-size:9px; font-weight:700;
      margin-top:4px; text-transform:uppercase; letter-spacing:.5px; box-shadow:0 1px 3px rgba(0,0,0,.1);
    }
    .status-pill.green{ background:linear-gradient(135deg,#10b981,#059669); color:#fff; }
    .status-pill.amber{ background:linear-gradient(135deg,#f97316,#ea580c); color:#fff; }
    .status-pill.red{ background:linear-gradient(135deg,var(--red),#b91c1c); color:#fff; }

    .card-body{ padding:8px 12px 12px; }
    .info-grid{ display:grid; gap:6px; }
    .info-section{
      background:var(--surface); border-radius:8px; padding:8px; border:1px solid var(--border);
      box-shadow:0 1px 2px rgba(220,38,38,.04);
    }
    .section-title{ font-size:10px; font-weight:700; color:var(--red); text-transform:uppercase;
      letter-spacing:.5px; margin-bottom:4px; }
    .info-row{ display:flex; justify-content:space-between; padding:2px 0; }
    .info-label{ font-size:11px; font-weight:500; color:var(--text-light); }
    .info-value{ font-size:11px; font-weight:600; color:var(--text); text-align:right; }

    .content-box{
      background:var(--red-light); border-radius:6px; padding:6px; font-size:10px; line-height:1.3;
      color:var(--text); min-height:24px; border:1px solid rgba(220,38,38,.1);
    }

    .qr-section{
      background:linear-gradient(135deg,#f8fafc 0%, #e2e8f0 100%); border-radius:8px; padding:8px; text-align:center;
      margin-top:6px; border:1px solid var(--border); box-shadow:0 1px 3px rgba(0,0,0,.05);
    }
    .qr-code{ width:50px; height:50px; border-radius:6px; border:1px solid var(--border); margin:0 auto 6px;
      background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .qr-label{ font-size:9px; font-weight:700; color:var(--red); text-transform:uppercase; letter-spacing:.5px; margin-bottom:3px; }
    .qr-url{ font-family:ui-monospace,monospace; font-size:8px; color:var(--text-light);
      word-break:break-all; background:#fff; padding:3px 4px; border-radius:4px; border:1px solid var(--border); }

    .disclaimer{ background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.2); color:#92400e;
      border-radius:6px; padding:6px; margin-top:6px; font-size:9px; text-align:center; font-weight:500; }
    .updated-time{ color:var(--text-light); font-size:9px; text-align:center; margin-top:3px; }
    footer{ margin-top:12px; color:var(--text-light); font-size:9px; text-align:center; }

    @media (max-width:480px){
      .wrap{padding:0 16px}
      .card{border-radius:20px}
      .card-header,.card-body{padding:20px}
      h1{font-size:22px}
    }
    .err { color:#b91c1c; font-size:11px; text-align:center; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MYQ<span class="er">ER</span><span style="font-size:.8em;vertical-align:super">â„¢</span></div>
      <div class="tagline">pronounced "my care"</div>
    </header>

    <div id="card" class="card">
      <div class="card-header">
        <h1>Emergency Profile</h1>
        <div id="triagePill" class="status-pill green">Standby</div>
        <div class="updated-time" id="updated">Accessed via QR scan</div>
      </div>

      <div class="card-body">
        <div class="info-grid">
          <div class="info-section">
            <div class="section-title">Personal Information</div>
            <div class="info-row"><span class="info-label">Name</span><span class="info-value" id="fullName">â€”</span></div>
            <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value" id="dob">â€”</span></div>
            <div class="info-row"><span class="info-label">Blood Type</span><span class="info-value" id="blood">â€”</span></div>
            <div class="info-row"><span class="info-label">Organ Donor</span><span class="info-value" id="donor">â€”</span></div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Allergies</div>
            <div class="content-box" id="allergies">No known allergies</div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Conditions</div>
            <div class="content-box" id="conditions">No known conditions</div>
          </div>

          <div class="info-section">
            <div class="section-title">Current Medications</div>
            <div class="content-box" id="medications">No current medications</div>
          </div>

          <div class="info-section">
            <div class="section-title">Implants & Devices</div>
            <div class="content-box" id="implants">None reported</div>
          </div>

          <div class="info-section">
            <div class="section-title">Emergency Contacts</div>
            <div class="content-box" id="emergencyContacts">No contacts available</div>
          </div>
        </div>

        <div class="qr-section">
          <img id="qr" class="qr-code" alt="QR"/>
          <div class="qr-label">Secure Card URL</div>
          <div class="qr-url" id="cardUrl">myqer.com/card/loading...</div>
        </div>

        <div class="disclaimer">ðŸ”’ Read-only emergency information. Always verify clinically before treatment.</div>
        <div id="err" class="err" hidden></div>
      </div>
    </div>

    <footer>Â© 2025 MYQERâ„¢</footer>
  </div>

<script>
const FN_BASE = 'https://dmtnhmkncldgnufa jei.functions.supabase.co/functions/v1/card';

function setText(id, val, fallback = 'â€”') {
  const el = document.getElementById(id);
  if (el) el.textContent = (val ?? '').toString().trim() || fallback;
}

function fmtDOB(d) {
  if (!d) return 'â€”';
  try {
    const date = new Date(d);
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  } catch {
    return d;
  }
}

function setTriage(p, h) {
  let level = "green";

  // override always wins
  if (p.triage_override === "red") {
    level = "red";
  } else if (h.allergies || h.conditions) {
    level = "amber";
  }

  const pill = document.getElementById("triagePill");
  pill.className = `status-pill ${level}`;
  pill.textContent = level.toUpperCase();
}

async function loadCard() {
  try {
    const pathParts = location.pathname.split('/').filter(Boolean);
    const code = (pathParts[0] === 'c' && pathParts[1]) || null;
    if (!code) throw new Error("Missing code in URL");

    const res = await fetch(`${FN_BASE}?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    if (!res.ok || data.error) throw new Error(data.error || 'Failed to load');

    // meta
    const generated = new Date(data.meta.generated_at);
    document.getElementById('updated').textContent =
      'Accessed today at ' + generated.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

    // profile & health
    const p = data.profile || {};
    const h = data.health || {};
    const ice = Array.isArray(data.ice) ? data.ice : [];

    setText('fullName', p.full_name);
    setText('dob', fmtDOB(p.dob));
    setText('blood', h.blood_type);
    setText('donor', h.organ_donor ? 'Yes' : 'No');

    setText('allergies', h.allergies, 'No known allergies');
    setText('conditions', h.conditions, 'No known conditions');
    setText('medications', h.medications, 'No current medications');
    setText('implants', h.implants, 'None reported');

    // triage pill
    setTriage(p, h);

    // ICE contacts
    if (ice.length) {
      document.getElementById('emergencyContacts').innerHTML = 
        ice.map(c => `<strong>${c.name||''}</strong> â€” ${c.relation||''} â€” ${c.phone||''}`).join('<br>');
    } else {
      setText('emergencyContacts', null, 'No contacts available');
    }

    // QR URL
    setText('cardUrl', `https://www.myqer.com/c/${code}`);
  } catch (e) {
    console.error(e);
    document.getElementById('emergencyContacts').textContent = 'Error loading card.';
  }
}

document.addEventListener('DOMContentLoaded', loadCard);
</script>
</body>
</html>
