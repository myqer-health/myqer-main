<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  // ---- Supabase (same project as dashboard) ----
  const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---- helpers ----
  const $ = (id) => document.getElementById(id);
  const normalizeDashes = (s) => (s || '').replace(/[\u2010-\u2015\u2212]/g, '-').toUpperCase();
  const pathLast = (p) => (p || '').split('/').filter(Boolean).pop() || '';

  // accept BOTH: 6-char (no dashes) OR old 3-4-3
  const RX_6     = /^[A-HJ-NP-Z2-9]{6}$/; 
  const RX_3_4_3 = /^[A-HJ-NP-Z2-9]{3}-[A-HJ-NP-Z2-9]{4}-[A-HJ-NP-Z2-9]{3}$/;

  const showNotFound = (msg='Card not found.') => {
    document.body.innerHTML = `<div class="wrap"><p>${msg}</p></div>`;
  };

  (async () => {
    // read from querystring or path and sanitize
    let raw = new URLSearchParams(location.search).get('code') || pathLast(location.pathname);
    raw = normalizeDashes(raw);

    // validate against either pattern
    if (!(RX_6.test(raw) || RX_3_4_3.test(raw))) return showNotFound();

    // 1) find the user by code
    const { data: prof, error: perr } = await supabase
      .from('profiles')
      .select('user_id, fullName, full_name, dob, date_of_birth, country, healthId, national_id, code')
      .eq('code', raw)
      .maybeSingle();

    if (perr || !prof) return showNotFound();

    // normalize fields (camel/snake)
    const name = prof.full_name ?? prof.fullName ?? '';
    const dob  = prof.date_of_birth ?? prof.dob ?? '';
    const hid  = prof.national_id ?? prof.healthId ?? '';
    const ctry = prof.country ?? '';

    // 2) fetch health + ICE
    const [{ data: health }, { data: ice }] = await Promise.all([
      supabase.from('health_data').select('*').eq('user_id', prof.user_id).maybeSingle(),
      supabase.from('ice_contacts').select('*').eq('user_id', prof.user_id).order('contact_order', { ascending:true })
    ]);

    // 3) fill UI
    $('v_name').textContent    = name || '—';
    $('v_dob').textContent     = dob || '—';
    $('v_country').textContent = ctry || '—';
    $('v_hid').textContent     = hid || '—';

    if (health) {
      const bt  = health.bloodType      ?? health.blood_type      ?? '';
      const alg = health.allergies      ?? health.allergy_list    ?? '';
      const con = health.conditions     ?? health.medical_conditions ?? '';
      const med = health.medications    ?? health.meds            ?? '';
      const imp = health.implants       ?? health.implants_devices ?? '';
      const don = (health.organDonor ?? health.organ_donor) ? 'Yes' : 'No';
      const tri = (health.triageOverride ?? health.triage_override ?? 'green').toLowerCase();

      $('v_bt').textContent    = bt || '—';
      $('v_donor').textContent = don;
      $('v_alg').textContent   = alg || '—';
      $('v_cond').textContent  = con || '—';
      $('v_meds').textContent  = med || '—';
      $('v_impl').textContent  = imp || '—';

      const pill = $('triage');
      pill.textContent = tri.toUpperCase();
      pill.style.background = tri==='red' ? '#fee2e2' : tri==='amber' ? '#fef3c7' : '#dcfce7';
      pill.style.color      = tri==='red' ? '#dc2626' : tri==='amber' ? '#d97706' : '#059669';
    }

    const list = (ice || [])
      .map(c => [c.name, c.relationship, c.phone].filter(Boolean).join(' — '))
      .filter(Boolean);
    $('iceList').textContent = list.length ? list.join(' | ') : '—';

    // 4) mirror URL on page and draw QR of this page itself (optional)
    const url = `https://${location.hostname.replace(/^www\./,'')}/c/${raw}`;
    $('v_url').textContent = url;
    if (window.QRCode && typeof QRCode.toCanvas === 'function') {
      try { QRCode.toCanvas($('qr'), url, { width: 160, margin: 1, errorCorrectionLevel: 'H' }); } catch {}
    }
  })();
</script>
