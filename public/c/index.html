<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER — Emergency Info</title>
  <meta name="color-scheme" content="light only" />
  <meta name="theme-color" content="#d32f2f">
  <style>
    :root { 
      --primary: #d32f2f; 
      --primary-amber: #f59e0b;
      --primary-green: #059669;
      --primary-black: #111827;
      --primary-light: rgba(211, 47, 47, 0.08);
      --ink: #0f172a; 
      --slate: #475569; 
      --muted: #6b7280;
      --border: #e5e7eb; 
      --card: rgba(255, 255, 255, 0.95); 
      --bg: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap { max-width: 820px; margin: 2rem auto; padding: 0 1rem; }
    .header { text-align: center; margin-bottom: 2rem; padding: 1rem 0; }
    .logo {
      font-size: 2rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: .25rem;
      background: linear-gradient(135deg, var(--primary) 0%, #b71c1c 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .subtitle { color: var(--muted); font-weight: 500; }

    .code {
      display:inline-block; margin-top:.75rem;
      background: var(--primary-light); border: 2px solid var(--primary);
      border-radius: 999px; padding: 6px 12px; font-weight: 700; letter-spacing: .08em;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 16px 32px rgba(0,0,0,.06), 0 6px 20px rgba(211,47,47,.05);
      padding: 1.5rem;
      backdrop-filter: blur(18px);
    }

    h1 { font-size: 1.8rem; margin: 0 0 .25rem; }
    .muted { color: var(--muted); }
    .sub { margin: 0 0 .35rem; color: var(--slate); font-weight: 500; }

    .patient-details {
      margin: 1rem 0 1rem;
      padding: .75rem 1rem;
      background: rgba(211,47,47,.05);
      border: 1px solid rgba(211,47,47,.12);
      border-radius: 12px;
    }

    .row { display:flex; flex-wrap:wrap; gap:.75rem; }
    .chip {
      background: rgba(255,255,255,.85);
      border: 1px solid var(--border);
      padding: .6rem .8rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .pill {
      display:inline-flex; align-items:center; gap:.5rem;
      padding: .4rem .65rem; border-radius: 999px; font-size:.8rem; font-weight:700;
      border: 1px solid transparent;
      margin:.25rem 0 .75rem;
    }
    .pill.green  { background: rgba(5,150,105,.1);  color: var(--primary-green); border-color: rgba(5,150,105,.25); }
    .pill.amber  { background: rgba(245,158,11,.12); color: var(--primary-amber); border-color: rgba(245,158,11,.28); }
    .pill.red    { background: rgba(211,47,47,.12); color: var(--primary); border-color: rgba(211,47,47,.28); }
    .pill.black  { background: rgba(17,24,39,.12);  color: var(--primary-black); border-color: rgba(17,24,39,.28); }

    .glass {
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(255,255,255,.3);
      border-radius: 14px;
      padding: 1rem;
      margin:.75rem 0;
      box-shadow: 0 8px 24px rgba(211,47,47,.08);
    }

    .disclaimer { font-size:.95rem; }
    .error, .loading {
      margin: 1rem 0 1.25rem; text-align:center; font-weight:700; border-radius:14px; padding:1rem;
    }
    .error   { background: rgba(211,47,47,.1);  color: #b71c1c; border: 1px solid rgba(211,47,47,.3); }
    .loading { background: rgba(211,47,47,.06); color: #b71c1c; border: 1px solid rgba(211,47,47,.18); }

    .grid { display:grid; grid-template-columns: 120px 1fr; gap: 1rem; align-items:start; }
    .avatar {
      width:110px; height:110px; border-radius: 12px; background:#f1f5f9; border:1px dashed #e5e7eb;
      display:flex; align-items:center; justify-content:center; color:#9ca3af; font-weight:700;
    }

    @media (max-width: 640px){
      .wrap { padding: 0 .75rem; }
      .grid { grid-template-columns: 1fr; }
      .avatar { width:100%; height:140px; }
    }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">MYQER™</div>
      <div class="subtitle">Emergency Medical Information</div>
      <div id="codePill" class="code" aria-live="polite">— — — — — —</div>
    </div>

    <div id="msg" class="error" style="display:none"></div>
    <div id="loading" class="loading" role="status">Loading emergency card…</div>

    <div id="card" class="card" style="display:none">
      <div class="grid">
        <div class="avatar" aria-hidden="true">PHOTO</div>
        <div>
          <h1 id="name">—</h1>
          <div id="triagePill" class="pill green">TRIAGE: GREEN</div>

          <div class="patient-details" id="patientDetails">
            <p class="sub" id="meta">—</p>
            <p class="sub" id="dobRow" style="display:none"><strong>DOB:</strong> <span id="dob">—</span></p>
            <p class="sub" id="healthIdRow" style="display:none"><strong>Health ID:</strong> <span id="healthId">—</span></p>
          </div>

          <div class="glass">
            <div class="row">
              <div class="chip"><strong>Blood:</strong> <span id="blood">—</span></div>
              <div class="chip"><strong>Donor:</strong> <span id="donor">—</span></div>
            </div>
          </div>

          <div class="glass" id="allergiesRow" style="display:none">
            <div><strong>Allergies:</strong> <span id="allergies">—</span></div>
          </div>

          <div class="glass" id="conditionsRow" style="display:none">
            <div><strong>Conditions:</strong> <span id="conditions">—</span></div>
          </div>

          <div class="glass" id="medsRow" style="display:none">
            <div><strong>Medications:</strong> <span id="meds">—</span></div>
          </div>

          <div class="glass" id="implantsRow" style="display:none">
            <div><strong>Implants/Devices:</strong> <span id="implants">—</span></div>
          </div>

          <div class="glass" id="iceRow" style="display:none">
            <div><strong>ICE:</strong> <span id="iceList">—</span></div>
          </div>

          <div class="glass disclaimer">
            <p class="muted" style="margin:0;">If information is unclear, verify with official medical records.</p>
          </div>
        </div>
      </div>
    </div>

    <p class="muted" style="margin:1rem 0 0;text-align:center">© 2024 MYQER™</p>
  </div>

  <!-- Supabase (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function(){
      // --- canonical host (avoid www) ---
      if (location.hostname.startsWith('www.')) {
        location.replace(location.href.replace('//www.', '//'));
        return;
      }

      // --- tiny helpers ---
      const $ = id => document.getElementById(id);
      const show = el => el && (el.style.display = '');
      const hide = el => el && (el.style.display = 'none');
      const setText = (id, v) => { const el=$(id); if (el) el.textContent = (v || '').toString(); };
      const ageFromDob = (yyyy_mm_dd) => {
        if (!/^\d{4}-\d{2}-\d{2}$/.test(yyyy_mm_dd||'')) return null;
        const [Y,M,D]=yyyy_mm_dd.split('-').map(n=>+n);
        const dob=new Date(Date.UTC(Y,M-1,D));
        const now=new Date();
        let a=now.getUTCFullYear()-dob.getUTCFullYear();
        const m=now.getUTCMonth()-dob.getUTCMonth();
        if (m<0 || (m===0 && now.getUTCDate()<dob.getUTCDate())) a--;
        return a;
      };
      const title = s => s ? (s[0].toUpperCase()+s.slice(1)) : s;

      // --- parse code from /c/XXXXXX (or ?code=) ---
      const codeFromPath = () => {
        const seg = location.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
        // .../c/<code>
        const idx = seg.findIndex(s => s.toLowerCase()==='c');
        if (idx>=0 && seg[idx+1]) return seg[idx+1].toUpperCase();
        const q = new URLSearchParams(location.search).get('code');
        return (q||'').toUpperCase();
      };

      const CODE = codeFromPath();
      setText('codePill', CODE || '— — — — — —');

      const msg = $('msg');
      function showError(t){ msg.textContent = t; show(msg); hide($('loading')); hide($('card')); }
      function showCard(){ hide($('loading')); hide(msg); show($('card')); }

      if (!CODE || !/^[A-HJ-NP-Z2-9]{6}$/.test(CODE)) {
        showError('No card found for this code.');
        return;
      }

      // --- Supabase init (same project as dashboard) ---
      const SB_URL = 'https://dmntmhkncldgynufajei.supabase.co';
      const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
      const supabase = window.supabase.createClient(SB_URL, SB_KEY);

      // --- triage logic (same spirit as dashboard) ---
      function computeTriage(allergies, conditions){
        const a = (allergies||'').toLowerCase();
        const c = (conditions||'').toLowerCase();
        if (a.includes('anaphylaxis') || a.includes('severe')) return 'red';
        if (a || c) return 'amber';
        return 'green';
      }
      function paintTriage(level){
        const pill = $('triagePill');
        ['green','amber','red','black'].forEach(k=>pill.classList.remove(k));
        pill.classList.add(level);
        pill.textContent = 'TRIAGE: ' + level.toUpperCase();
      }

      // --- fetch & render ---
      (async function load(){
        try{
          // 1) profiles by code (snake or camel support)
          let prof = null;
          let r = await supabase.from('profiles').select('*').eq('code', CODE).maybeSingle();
          if (r.error && /column "user_id" of relation "profiles" does not exist/i.test(r.error.message)){
            // try camel case variant
            r = await supabase.from('profiles').select('*').eq('code', CODE).maybeSingle();
          }
          prof = r.data || null;

          if (!prof) { showError('No card found for this code.'); return; }

          // normalize profile keys
          const p = {
            user_id:      prof.user_id ?? prof.userId,
            full_name:    prof.full_name ?? prof.fullName ?? '',
            dob:          prof.date_of_birth ?? prof.dob ?? '',
            country:      prof.country ?? '',
            health_id:    prof.national_id ?? prof.healthId ?? ''
          };

          // 2) health
          const rh = await supabase.from('health_data').select('*').eq('user_id', p.user_id).maybeSingle();
          const raw = rh.data || {};
          const h = {
            bloodType:      raw.bloodType      ?? raw.blood_type      ?? '',
            allergies:      raw.allergies      ?? raw.allergy_list    ?? '',
            conditions:     raw.conditions     ?? raw.medical_conditions ?? '',
            medications:    raw.medications    ?? raw.meds            ?? '',
            implants:       raw.implants       ?? raw.implants_devices?? '',
            organDonor:    (raw.organDonor     ?? raw.organ_donor) ? true : false
          };

          // 3) ICE contacts
          const ri = await supabase.from('ice_contacts').select('*').eq('user_id', p.user_id).order('contact_order', { ascending: true });
          const ice = (ri.data || []).map(r => `${r.name || '—'} — ${r.relationship || ''} — ${r.phone || ''}`.replace(/\s+—\s+—\s*$/,'').trim()).filter(Boolean);

          // render
          setText('name', p.full_name || '—');

          const age = ageFromDob(p.dob);
          const country = p.country || '—';
          const metaBits = [];
          if (age!=null) metaBits.push(`${age} years old`);
          if (country && country !== '—') metaBits.push(country);
          setText('meta', metaBits.join(' • ') || '—');

          if (p.dob) { setText('dob', p.dob); show($('dobRow')); }
          if (p.health_id) { setText('healthId', p.health_id); show($('healthIdRow')); }

          setText('blood', h.bloodType || '—');
          setText('donor', h.organDonor ? 'Y' : 'N');

          const place = (rowId, spanId, value) => {
            if (value && String(value).trim()) { setText(spanId, value); show($(rowId)); }
            else hide($(rowId));
          };

          place('allergiesRow','allergies', h.allergies);
          place('conditionsRow','conditions', h.conditions);
          place('medsRow','meds', h.medications);
          place('implantsRow','implants', h.implants);

          if (ice.length){ setText('iceList', ice.join(' | ')); show($('iceRow')); } else hide($('iceRow'));

          paintTriage(computeTriage(h.allergies, h.conditions));
          showCard();
        } catch(e){
          console.error(e);
          showError('We couldn’t load this card right now.');
        }
      })();
    })();
  </script>
</body>
</html>
