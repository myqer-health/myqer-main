<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MYQERâ„¢ â€” Emergency Card</title>
  <style>
    :root{
      --red:#dc2626; --red-light:#fef2f2; --gold:#f59e0b;
      --text:#111827; --text-light:#6b7280; --green:#10b981;
      --surface:#ffffff; --border:#f3f4f6;
    }
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased}
    body{font-family:-apple-system,BlinkMacSystemFont,Inter,system-ui,sans-serif;margin:0;background:#fff;color:var(--text);min-height:100vh;padding:8px}
    .wrap{max-width:340px;margin:0 auto}
    header{text-align:center;margin-bottom:12px}
    .brand{font-size:20px;font-weight:800;letter-spacing:-.02em}
    .brand .er{color:var(--red)} .tagline{color:var(--text-light);font-size:11px;margin-top:2px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 8px rgba(220,38,38,.08),0 1px 3px rgba(0,0,0,.06);overflow:hidden}
    .card-header{padding:12px 16px 6px;text-align:center;background:linear-gradient(135deg,var(--red-light),#fff)}
    h1{font-size:16px;font-weight:700;margin:0}
    .status-pill{display:inline-block;padding:3px 8px;border-radius:10px;font-size:9px;font-weight:700;margin-top:4px;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .status-pill.green{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .status-pill.amber{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
    .status-pill.red{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
    .status-pill.black{background:linear-gradient(135deg,#6b7280,#374151);color:#fff}
    .card-body{padding:8px 12px 12px}
    .info-grid{display:grid;gap:6px}
    .info-section{background:#fff;border-radius:8px;padding:8px;border:1px solid var(--border);box-shadow:0 1px 2px rgba(220,38,38,.04)}
    .section-title{font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
    .info-row{display:flex;justify-content:space-between;padding:2px 0}
    .info-label{font-size:11px;font-weight:500;color:var(--text-light)}
    .info-value{font-size:11px;font-weight:600;color:var(--text);text-align:right}
    .content-box{background:var(--red-light);border-radius:6px;padding:6px;font-size:10px;line-height:1.3;color:var(--text);min-height:24px;border:1px solid rgba(220,38,38,.1)}
    .qr-section{background:linear-gradient(135deg,var(--gold) 10%,#fbbf24 90%);border-radius:8px;padding:8px;text-align:center;margin-top:6px;box-shadow:0 1px 3px rgba(245,158,11,.3)}
    .qr-code{width:50px;height:50px;border-radius:6px;border:1px solid rgba(255,255,255,.3);margin:0 auto 6px;background:#fff;object-fit:contain}
    .qr-label{font-size:9px;font-weight:700;color:#fff;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
    .qr-url{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:8px;color:#fff;word-break:break-all;background:rgba(255,255,255,.2);padding:3px 4px;border-radius:4px;border:1px solid rgba(255,255,255,.2)}
    .disclaimer{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);color:#92400e;border-radius:6px;padding:6px;margin-top:6px;font-size:9px;text-align:center;font-weight:500}
    .updated-time{color:var(--text-light);font-size:9px;text-align:center;margin-top:3px}
    .err{color:#b91c1c;font-size:11px;margin:8px 12px 0;text-align:center}
    footer{margin-top:12px;color:var(--text-light);font-size:9px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MYQ<span class="er">ER</span><span style="font-size:.8em;vertical-align:super">â„¢</span></div>
      <div class="tagline">pronounced "my care"</div>
    </header>

    <div id="card" class="card">
      <div class="card-header">
        <h1>Emergency Profile</h1>
        <div id="triagePill" class="status-pill green">READY</div>
        <div class="updated-time" id="updated">Accessed via QR scan</div>
      </div>

      <div class="card-body">
        <div class="info-grid">
          <div class="info-section">
            <div class="section-title">Personal Information</div>
            <div class="info-row"><span class="info-label">Name</span>       <span class="info-value" id="fullName">â€”</span></div>
            <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value" id="dob">â€”</span></div>
            <div class="info-row"><span class="info-label">Blood Type</span> <span class="info-value" id="blood">â€”</span></div>
            <div class="info-row"><span class="info-label">Organ Donor</span><span class="info-value" id="donor">â€”</span></div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Allergies</div>
            <div class="content-box" id="allergies">No known allergies</div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Conditions</div>
            <div class="content-box" id="conditions">No known conditions</div>
          </div>

          <div class="info-section">
            <div class="section-title">Current Medications</div>
            <div class="content-box" id="medications">No current medications</div>
          </div>

          <div class="info-section">
            <div class="section-title">Implants & Devices</div>
            <div class="content-box" id="implants">None reported</div>
          </div>

          <div class="info-section">
            <div class="section-title">Emergency Contacts</div>
            <div class="content-box" id="emergencyContacts">No contacts available</div>
          </div>
        </div>

        <div class="qr-section">
          <img id="qr" class="qr-code" alt="QR"/>
          <div class="qr-label">Secure Card URL</div>
          <div class="qr-url" id="cardUrl">myqer.com/card/loadingâ€¦</div>
        </div>

        <div class="disclaimer">ðŸ”’ Read-only emergency information. Always verify clinically before treatment.</div>
        <div id="error" class="err" hidden></div>
      </div>
    </div>

    <footer>Â© 2025 MYQERâ„¢</footer>
  </div>

<script>
(function () {
  // ---- CONFIG ----
  const FN_BASE = 'https://dmntmhkncldgynufajei.functions.supabase.co/functions/v1/card';
  const CANONICAL = 'https://www.myqer.com/c/';

  // ---- helpers ----
  const $ = id => document.getElementById(id);
  const set = (id, val, fallback='â€”') => $(id).textContent = (val ?? '').toString().trim() || fallback;

  function setTriage(level) {
    const pill = $('triagePill');
    const lv = (level || 'green').toLowerCase();
    pill.className = 'status-pill ' + (['green','amber','red','black'].includes(lv) ? lv : 'green');
    pill.textContent = (['green','amber','red','black'].includes(lv) ? lv : 'green').toUpperCase();
  }

  function parseCodeFromUrl() {
    const parts = location.pathname.split('/').filter(Boolean);
    if (parts[0] === 'c' && parts[1]) return parts[1];
    const u = new URL(location.href);
    return (u.searchParams.get('code') || '').trim();
  }

  async function loadCard() {
    const code = parseCodeFromUrl();
    if (!code) {
      showError('Missing code in URL.');
      return;
    }

    const cardUrl = CANONICAL + encodeURIComponent(code);
    $('cardUrl').textContent = cardUrl;
    $('qr').src = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent(cardUrl);

    try {
      const res = await fetch(FN_BASE + '?code=' + encodeURIComponent(code), { mode: 'cors' });
      const data = await res.json();

      if (!res.ok || data.error) throw new Error(data.error || 'Failed to load card');

      // meta
      const generated = data.meta?.generated_at ? new Date(data.meta.generated_at) : new Date();
      $('updated').textContent = 'Accessed today at ' + generated.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

      // profile & health
      const p = data.profile || {};
      const h = data.health  || {};
      const ice = Array.isArray(data.ice) ? data.ice : [];

      set('fullName', p.full_name);
      set('dob', p.dob);
      set('blood', h.blood_type);
      set('donor', h.organ_donor ? 'Yes' : 'No');

      set('allergies', h.allergies, 'No known allergies');
      set('conditions', h.conditions, 'No known conditions');
      set('medications', h.meds ?? h.medications, 'No current medications');
      set('implants', h.implants, 'None reported');

      // triage from profile.triage or health.triage_override
      setTriage(p.triage || h.triage_override || 'green');

      if (ice.length) {
        $('emergencyContacts').innerHTML =
          '<ul style="margin:0;padding-left:16px">'
          + ice.map(c => `<li><strong>${(c.name||'').toString()}</strong> â€” ${(c.relation||'').toString()} â€” ${(c.phone||'').toString()}</li>`).join('')
          + '</ul>';
      } else {
        set('emergencyContacts', 'No contacts available');
      }
    } catch (e) {
      showError(e.message || 'Error loading card.');
    }
  }

  function showError(msg) {
    const el = $('error');
    el.hidden = false;
    el.textContent = msg;
  }

  document.addEventListener('DOMContentLoaded', loadCard);
})();
</script>
</body>
</html>
