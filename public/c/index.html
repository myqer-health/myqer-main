<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MYQER™ — Emergency Card</title>
<style>
  :root{
    --red:#dc2626; --red-2:#b91c1c; --red-light:#fef2f2;
    --amber:#f59e0b; --ink:#111827; --muted:#6b7280;
    --green:#10b981; --border:#f3f4f6; --surface:#fff;
  }
  *{box-sizing:border-box;-webkit-font-smoothing:antialiased}
  body{margin:0;background:#fff;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,sans-serif}
  .wrap{max-width:360px;margin:16px auto;padding:0 12px}
  header{text-align:center;margin-bottom:12px}
  .brand{font-weight:800;letter-spacing:-.02em}
  .brand .er{color:var(--red)}
  .tag{color:var(--muted);font-size:11px;margin-top:2px}

  .card{border:1px solid var(--border);border-radius:16px;background:var(--surface);
        box-shadow:0 2px 8px rgba(220,38,38,.08),0 1px 3px rgba(0,0,0,.06);overflow:hidden}
  .card-hd{padding:12px 16px 6px;text-align:center;background:linear-gradient(135deg,var(--red-light),#fff)}
  h1{margin:0;font-size:16px}
  .pill{display:inline-block;margin-top:4px;padding:3px 8px;border-radius:10px;font:700 9px/1 sans-serif;letter-spacing:.5px;color:#fff;text-transform:uppercase;box-shadow:0 1px 3px rgba(0,0,0,.1)}
  .pill.green{background:linear-gradient(135deg,#10b981,#059669)}
  .pill.amber{background:linear-gradient(135deg,#f97316,#ea580c)}
  .pill.red{background:linear-gradient(135deg,#dc2626,#b91c1c)}
  .pill.black{background:linear-gradient(135deg,#111827,#000)}
  .ts{color:var(--muted);font-size:10px;margin-top:4px}

  .card-bd{padding:10px 12px}
  .sec{border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:6px;background:#fff;box-shadow:0 1px 2px rgba(220,38,38,.04)}
  .ttl{font:700 10px/1.1 sans-serif;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
  .row{display:flex;justify-content:space-between;padding:2px 0}
  .k{font-size:11px;color:var(--muted)}
  .v{font-size:11px;font-weight:600;text-align:right}
  .box{background:var(--red-light);border:1px solid rgba(220,38,38,.1);border-radius:6px;padding:6px;font-size:10px;color:var(--ink)}

  .qrpanel{margin-top:8px;border:1px solid var(--border);background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-radius:8px;padding:10px;text-align:center}
  .qr{width:88px;height:88px;border-radius:8px;background:#fff;border:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,.1);margin:4px auto}
  .lbl{font:700 9px/1 sans-serif;color:var(--red);text-transform:uppercase;margin:6px 0 4px}
  .mono{font:12px ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid var(--border);border-radius:6px;padding:6px;white-space:nowrap;overflow:auto}
  .btns{display:flex;gap:6px;justify-content:center;margin-top:6px}
  button{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 10px;font:600 12px/1 system-ui;cursor:pointer}
  button:hover{border-color:#e5e7eb}
  .warn{margin-top:8px;background:#fff7ed;border:1px solid #fed7aa;color:#92400e;border-radius:8px;padding:8px;font:500 10px/1.3 system-ui;text-align:center}

  .snap{margin-top:8px;border:1px dashed #fca5a5;background:#fff7f7;border-radius:8px;padding:10px}
  .snap .ttl{color:#ef4444}
  .snap pre{margin:6px 0 0;white-space:pre-wrap;word-break:break-word;font:12px/1.35 ui-monospace,monospace}
  footer{margin:12px 0 20px;text-align:center;color:#94a3b8;font-size:10px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">MYQ<span class="er">ER</span><span style="font-size:.8em;vertical-align:super">™</span></div>
    <div class="tag">pronounced “my care”</div>
  </header>

  <div class="card">
    <div class="card-hd">
      <h1>Emergency Profile</h1>
      <div id="triagePill" class="pill green">STANDBY</div>
      <div id="updated" class="ts">Accessed via QR scan</div>
    </div>

    <div class="card-bd">
      <div class="sec">
        <div class="ttl">Personal Information</div>
        <div class="row"><div class="k">Name</div><div class="v" id="fullName">—</div></div>
        <div class="row"><div class="k">Date of Birth</div><div class="v" id="dob">—</div></div>
        <div class="row"><div class="k">Blood Type</div><div class="v" id="blood">—</div></div>
        <div class="row"><div class="k">Organ Donor</div><div class="v" id="donor">—</div></div>
      </div>

      <div class="sec"><div class="ttl">Medical Allergies</div><div id="allergies" class="box">No known allergies</div></div>
      <div class="sec"><div class="ttl">Medical Conditions</div><div id="conditions" class="box">No known conditions</div></div>
      <div class="sec"><div class="ttl">Current Medications</div><div id="medications" class="box">No current medications</div></div>
      <div class="sec"><div class="ttl">Implants &amp; Devices</div><div id="implants" class="box">None reported</div></div>
      <div class="sec"><div class="ttl">Emergency Contacts</div><div id="iceBox" class="box">No contacts available</div></div>

      <div class="qrpanel">
        <div class="lbl">Live Card (URL)</div>
        <img id="qr" class="qr" alt="QR">
        <div class="mono" id="cardUrl">https://myqer.com/c/XXXX-XXXX</div>
        <div class="btns">
          <button id="copyUrl">Copy URL</button>
          <button id="printBtn">Print</button>
        </div>
      </div>

      <div class="snap">
        <div class="ttl">Offline Snapshot (print/read)</div>
        <pre id="snapshot">MYQER — Emergency Snapshot
Name: —
DOB: —
Blood: —
Allergies: —
Conditions: —
Medications: —
ICE: —</pre>
        <div class="btns">
          <button id="copySnap">Copy snapshot</button>
        </div>
      </div>

      <div class="warn">Read-only emergency information. Always verify clinically before treatment.</div>
    </div>
  </div>

  <footer>© 2025 MYQER™</footer>
</div>

<script>
(function(){
  // --- CONFIG ---
  const FN_BASE = 'https://dmntmhkncldgynufajei.functions.supabase.co/functions/v1/card';

  // --- helpers ---
  const $ = id => document.getElementById(id);
  const set = (id, v, fallback='—') => { const el=$(id); if(el) el.textContent=(v??'').toString().trim() || fallback; };
  const fmtDOB = iso => {
    if(!iso) return '—';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '—';
    return new Intl.DateTimeFormat('en-GB',{day:'2-digit',month:'short',year:'numeric'}).format(d);
  };
  const setTriage = raw => {
    const pill = $('triagePill'); if(!pill) return;
    const map = { standby:'green', yellow:'amber' };
    const lv = (raw||'green').toString().trim().toLowerCase();
    const cls = ['green','amber','red','black'].includes(lv) ? lv : (map[lv]||'green');
    pill.className = 'pill ' + cls;
    pill.textContent = cls.toUpperCase();
  };
  const e164 = (phone, country) => {
    if(!phone) return '';
    const p = phone.replace(/\s+/g,'');
    if(/^(\+|\d{2,})/.test(p)) return p; // already intl-ish
    if(country === 'GB' && /^0\d{9,}$/.test(p)) return '+44' + p.slice(1);
    return p;
  };
  const truncate = (s, n=140) => (s && s.length>n) ? (s.slice(0,n-1)+'…') : (s||'');

  // --- read code from /c/XXXX-XXXX or ?code= ---
  const parts = location.pathname.split('/').filter(Boolean);
  let code = (parts[0]==='c' && parts[1]) ? parts[1] : (new URL(location.href)).searchParams.get('code');
  code = (code||'').trim();

  async function loadCard(){
    // set branded URL + QR immediately (so print works even before fetch)
    const brandedUrl = code ? `https://myqer.com/c/${encodeURIComponent(code)}` : 'https://myqer.com/c/XXXX-XXXX';
    set('cardUrl', brandedUrl);
    $('qr').src = 'https://api.qrserver.com/v1/create-qr-code/?size=176x176&data=' + encodeURIComponent(brandedUrl);

    if(!code){
      set('snapshot', buildSnapshot({}));
      return;
    }

    try{
      const res = await fetch(`${FN_BASE}?code=${encodeURIComponent(code)}`, {mode:'cors'});
      const data = await res.json();
      if(!res.ok || data.error){ throw new Error(data.error || 'Failed to load card'); }

      // meta
      const gen = data?.meta?.generated_at;
      set('updated', gen ? ('Accessed today at ' + new Date(gen).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})) : 'Accessed via QR scan');

      // profile + health
      const p = data.profile || {};
      const h = data.health || {};
      const ice = Array.isArray(data.ice) ? data.ice : [];

      set('fullName', p.full_name);
      set('dob', fmtDOB(p.dob));
      set('blood', h.blood_type);
      set('donor', h.organ_donor ? 'Yes' : 'No');

      set('allergies', (h.allergies||'').trim() || 'No known allergies');
      set('conditions', (h.conditions||'').trim() || 'No known conditions');
      set('medications', (h.meds||h.medications||'').trim() || 'No current medications');
      set('implants', (h.implants||'').trim() || 'None reported');

      // triage from health_profiles.triage_override (server returns in health.triage_override)
      setTriage(h.triage_override || 'green');

      // ICE box
      if(ice.length){
        $('iceBox').innerHTML = ice.map(c=>{
          const nm = (c.name||'').toString();
          const rel = (c.relation||'').toString();
          const ph = e164((c.phone||'').toString(), p.country);
          return `<div><strong>${nm}</strong> — ${rel} — ${ph}</div>`;
        }).join('');
      } else {
        set('iceBox','No contacts available');
      }

      // snapshot
      set('snapshot', buildSnapshot({p,h,ice}));

    }catch(err){
      console.warn(err);
      set('snapshot', buildSnapshot({}));
      setTriage('green');
    }
  }

  function buildSnapshot({p={}, h={}, ice=[]}={}){
    const name = p.full_name || '—';
    const dob  = fmtDOB(p.dob);
    const blood = h.blood_type || '—';
    const allergies = truncate((h.allergies||'').trim() || '—');
    const cond = truncate((h.conditions||'').trim() || '—');
    const meds = truncate(((h.meds||h.medications||'').trim()) || '—');
    let iceLine = '—';
    if(ice && ice.length){
      const c = ice[0];
      const ph = e164(c.phone||'', p.country);
      iceLine = `${(c.name||'—')} — ${c.relation||'—'} — ${ph||'—'}`;
    }
    return `MYQER — Emergency Snapshot
Name: ${name}
DOB: ${dob}
Blood: ${blood}
Allergies: ${allergies}
Conditions: ${cond}
Medications: ${meds}
ICE: ${iceLine}`;
  }

  // buttons
  $('copyUrl').addEventListener('click', async ()=> {
    await navigator.clipboard.writeText($('cardUrl').textContent.trim());
    $('copyUrl').textContent='Copied'; setTimeout(()=>$('copyUrl').textContent='Copy URL',1200);
  });
  $('copySnap').addEventListener('click', async ()=> {
    await navigator.clipboard.writeText($('snapshot').textContent);
    $('copySnap').textContent='Copied'; setTimeout(()=>$('copySnap').textContent='Copy snapshot',1200);
  });
  $('printBtn').addEventListener('click', ()=> window.print());

  document.addEventListener('DOMContentLoaded', loadCard);
})();
</script>
</body>
</html>
