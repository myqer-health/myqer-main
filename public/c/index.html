<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER‚Ñ¢ Emergency Card</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .card{opacity:0;transform:translateY(20px);transition:all .5s ease-out}
    .card.show{opacity:1;transform:translateY(0)}
    .triage-pill{transition:all .25s ease}
    .triage-pill.green{background:#059669;color:#fff}
    .triage-pill.amber{background:#f59e0b;color:#fff}
    .triage-pill.red{background:#dc2626;color:#fff}
    .triage-pill.black{background:#111827;color:#fff}
    .emergency-header{background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);color:#fff;text-align:center;padding:20px;border-radius:12px 12px 0 0}
    .info-section{border-left:4px solid #e5e7eb;padding:16px;margin:8px 0;background:#f9fafb;border-radius:0 8px 8px 0}
    .info-section.identity{border-left-color:#10b981}
    .info-section.health{border-left-color:#dc2626}
    .info-section.care{border-left-color:#6b7280}
    .loading-spinner{border:3px solid #f3f4f6;border-top:3px solid #dc2626;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .hidden{display:none}
    .ice-contact{background:#fff;border:2px solid #10b981;border-radius:8px;padding:12px;margin:8px 0}
    .medical-alert{background:#fef2f2;border:2px solid #fca5a5;border-radius:8px;padding:12px;margin:8px 0}
    .verified-badge{display:inline-flex;align-items:center;justify-content:center;width:1.05em;height:1.05em;margin-left:.35rem;background:#3b82f6;color:#fff;border-radius:999px;font-size:.75em;font-weight:800;line-height:1}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Supabase (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <div class="max-w-2xl mx-auto p-4">
    <!-- Loading -->
    <div id="loading" class="text-center py-12">
      <div class="loading-spinner"></div>
      <p class="text-gray-600 mt-4">Loading emergency card‚Ä¶</p>
    </div>

    <!-- Error -->
    <div id="msg" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 text-center">
      <div class="text-red-600 text-lg font-medium">Card not found</div>
      <p class="text-red-500 mt-2">Please check the code and try again.</p>
    </div>

    <!-- Card -->
    <div id="card" class="card bg-white rounded-lg shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="emergency-header">
        <h1 class="text-2xl font-bold">üö® EMERGENCY MEDICAL CARD</h1>
        <div class="mt-2">
          <span class="text-sm opacity-90">MYQER‚Ñ¢ Code: </span>
          <span id="codePill" class="bg-white/20 px-3 py-1 rounded-full text-sm font-mono">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</span>
        </div>
        <div id="triagePill" class="triage-pill green inline-block px-4 py-2 rounded-full text-sm font-bold mt-3">
          TRIAGE: GREEN
        </div>
      </div>

      <!-- Identity -->
      <div class="info-section identity">
        <h2 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          üë§ Identity
          <span class="inline-flex items-center justify-center w-5 h-5 bg-blue-500 rounded-full">
            <svg class="w-3 h-3 text-white" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
          </span>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div class="flex items-center gap-2">
            <span class="font-medium text-gray-700">Name:</span>
            <div class="text-gray-900 font-semibold flex items-center">
              <span id="fullName">‚Äî</span>
            </div>
          </div>
          <div>
            <span class="font-medium text-gray-700">Date of Birth:</span>
            <div id="dob" class="text-gray-900">‚Äî</div>
          </div>
          <div>
            <span class="font-medium text-gray-700">Country:</span>
            <div id="country" class="text-gray-900">‚Äî</div>
          </div>
          <div>
            <span class="font-medium text-gray-700">Health ID:</span>
            <div id="healthId" class="text-gray-900 font-mono">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Health -->
      <div class="info-section health">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">ü©∫ Critical Health Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
          <div>
            <span class="font-medium text-gray-700">Blood Type:</span>
            <div id="bloodType" class="text-red-600 font-bold text-lg">‚Äî</div>
          </div>
          <div>
            <span class="font-medium text-gray-700">Organ Donor:</span>
            <div id="organDonor" class="text-gray-900 font-semibold">‚Äî</div>
          </div>
        </div>

        <div id="allergiesSection" class="medical-alert hidden">
          <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Allergies & Reactions</h3>
          <div id="allergies" class="text-red-700">‚Äî</div>
        </div>

        <div id="conditionsSection" class="mb-4 hidden">
          <h3 class="font-medium text-gray-700 mb-2">Medical Conditions:</h3>
          <div id="conditions" class="text-gray-900">‚Äî</div>
        </div>

        <div id="medicationsSection" class="mb-4 hidden">
          <h3 class="font-medium text-gray-700 mb-2">Current Medications:</h3>
          <div id="medications" class="text-gray-900">‚Äî</div>
        </div>

        <div id="implantsSection" class="mb-4 hidden">
          <h3 class="font-medium text-gray-700 mb-2">Implants/Devices:</h3>
          <div id="implants" class="text-gray-900">‚Äî</div>
        </div>
      </div>

      <!-- ICE -->
      <div class="info-section identity">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">üìû Emergency Contacts</h2>
        <div id="iceContacts"></div>
      </div>

      <!-- My Care (only if any directive exists) -->
      <div id="careSection" class="info-section care hidden">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">üè• Care Preferences</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div id="lifeSupportRow" class="hidden"><span class="font-medium text-gray-700">Life Support:</span> <div id="lifeSupport" class="text-gray-900"></div></div>
          <div id="intubationRow"  class="hidden"><span class="font-medium text-gray-700">Intubation:</span>   <div id="intubation"  class="text-gray-900"></div></div>
          <div id="comaCareRow"    class="hidden"><span class="font-medium text-gray-700">Coma Care:</span>    <div id="comaCare"   class="text-gray-900"></div></div>
          <div id="burialRow"      class="hidden"><span class="font-medium text-gray-700">Burial Preference:</span> <div id="burial" class="text-gray-900"></div></div>
          <div id="religionRow"    class="hidden md:col-span-2"><span class="font-medium text-gray-700">Religion/Beliefs:</span> <div id="religion" class="text-gray-900"></div></div>
        </div>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 p-4 text-center text-xs text-gray-500">
        <p>MYQER‚Ñ¢ Emergency Medical Scannable QR Triage Aid ID</p>
        <p class="mt-1">For medical emergencies only ‚Ä¢ Data encrypted & secure</p>
        <p class="mt-1">Last updated: <span id="lastUpdated">‚Äî</span></p>
      </div>
    </div>
  </div>

  <script>
    /* helpers */
    const $  = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.remove('hidden');
    const hide = (el) => el && el.classList.add('hidden');
    const setText = (id, v) => { const el=$(id); if (el) el.textContent = v; };

    /* code from /c/{CODE} or ?code= */
    function codeFromPath(){
      const seg = location.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
      const i = seg.findIndex(s => s.toLowerCase()==='c');
      if (i>=0 && seg[i+1]) return seg[i+1].toUpperCase();
      const q = new URLSearchParams(location.search).get('code');
      return (q||'').toUpperCase();
    }

    /* triage helpers */
    function computeTriage(allergies, conditions, override){
      if (override && override !== 'auto') return override;
      const a=(allergies||'').toLowerCase(), c=(conditions||'').toLowerCase();
      if (a.includes('anaphylaxis') || a.includes('severe')) return 'red';
      if (a || c) return 'amber';
      return 'green';
    }
    function paintTriage(level){
      const pill=$('triagePill');
      ['green','amber','red','black'].forEach(k=>pill.classList.remove(k));
      pill.classList.add(level);
      pill.textContent='TRIAGE: '+level.toUpperCase();
    }
    const labelMap = {
      yes:'Yes, use life support',
      no:'No life support',
      limited:'Limited intervention',
      full:'Full care',
      comfort:'Comfort care only',
      family:'Family decision',
      burial:'Burial',
      cremation:'Cremation'
    };

    /* render ICE list */
    function renderICE(rows){
      const box = $('iceContacts');
      if (!box) return;
      if (!Array.isArray(rows) || !rows.length){
        box.innerHTML = '<div class="text-gray-500">‚Äî</div>';
        return;
      }
      box.innerHTML = rows.map(r => `
        <div class="ice-contact">
          <div class="font-semibold text-green-800">${(r.name||'').toString()}</div>
          <div class="text-sm text-gray-600">${(r.relationship||'').toString()}</div>
          <div class="font-mono text-green-700 font-medium">${(r.phone||'').toString()}</div>
        </div>
      `).join('');
    }

    /* main */
    document.addEventListener('DOMContentLoaded', async () => {
      const CODE = codeFromPath();
      setText('codePill', CODE || '‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî');

      hide($('loading'));
      $('card').classList.add('show');

      if (!CODE || !/^[A-HJ-NP-Z2-9]{6}$/.test(CODE)){ show($('msg')); return; }

      const SB_URL = 'https://dmntmhkncldgynufajei.supabase.co';
      const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
      const supabase = window.supabase.createClient(SB_URL, SB_KEY);

      try {
        /* profile by code */
        let rp = await supabase.from('profiles').select('*').eq('code', CODE).maybeSingle();
        if (rp.error || !rp.data){ show($('msg')); return; }
        const prof = rp.data;
        const userId = prof.user_id ?? prof.userId;

        /* parallel fetches with snake/camel fallbacks where needed */
        const [rh, ri, rc] = await Promise.all([
          (async () => {
            let r = await supabase.from('health_data').select('*').eq('user_id', userId).maybeSingle();
            if (!r.data) r = await supabase.from('health_data').select('*').eq('userId', userId).maybeSingle();
            return r;
          })(),
          supabase.from('ice_contacts').select('*').eq('user_id', userId).order('contact_order', { ascending:true }),
          (async () => {
            let r = await supabase.from('care_directives').select('*').eq('user_id', userId).maybeSingle();
            if (!r.data) r = await supabase.from('care_directives').select('*').eq('userId', userId).maybeSingle();
            return r;
          })()
        ]);

        /* normalize */
        const rawH = rh.data || {};
        const rawI = ri.data || [];
        const rawC = rc.data || null;

        const health = {
          bloodType:      rawH.bloodType      ?? rawH.blood_type      ?? '',
          organDonor:     (rawH.organDonor ?? rawH.organ_donor) ? true : false,
          allergies:      rawH.allergies      ?? rawH.allergy_list    ?? '',
          conditions:     rawH.conditions     ?? rawH.medical_conditions ?? '',
          medications:    rawH.medications    ?? rawH.meds            ?? '',
          implants:       rawH.implants       ?? rawH.implants_devices ?? '',
          triageOverride: rawH.triageOverride ?? rawH.triage_override ?? 'auto'
        };

        const care = rawC ? {
          lifeSupport: rawC.lifeSupport ?? rawC.life_support ?? '',
          intubation:  rawC.intubation  ?? '',
          comaCare:    rawC.comaCare    ?? rawC.coma_care ?? '',
          burial:      rawC.burial      ?? '',
          religion:    rawC.religion    ?? ''
        } : {};

        /* paint identity */
        const fullName = (prof.full_name ?? prof.fullName ?? '').toString();
        const dob      = prof.date_of_birth ?? prof.dob ?? '';
        const country  = prof.country ?? '';
        const healthID = prof.national_id ?? prof.healthId ?? '';

        setText('fullName', fullName || '‚Äî');
        show($('verifiedBadge'));        /* show blue check once loaded */
        setText('dob', dob ? new Date(dob).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}) : '‚Äî');
        setText('country', country || '‚Äî');
        setText('healthId', healthID || '‚Äî');

        /* health */
        setText('bloodType', health.bloodType || '‚Äî');
        setText('organDonor', health.organDonor ? '‚ù§Ô∏è YES' : 'No');
        if (health.allergies){ setText('allergies', health.allergies); show($('allergiesSection')); }
        if (health.conditions){ setText('conditions', health.conditions); show($('conditionsSection')); }
        if (health.medications){ setText('medications', health.medications); show($('medicationsSection')); }
        if (health.implants){ setText('implants', health.implants); show($('implantsSection')); }

        /* ICE */
        const ice = rawI.map(r=>({name:r.name||'',relationship:r.relationship||'',phone:r.phone||''}))
                        .filter(x=>x.name||x.phone);
        renderICE(ice);

        /* My Care: only show rows that have values, and reveal section if any exist */
        let careCount = 0;
        function place(rowId, spanId, val){
          if (val && String(val).trim()){
            setText(spanId, labelMap[val] || val);
            show($(rowId));
            careCount++;
          } else {
            hide($(rowId));
          }
        }
        place('lifeSupportRow','lifeSupport', care.lifeSupport);
        place('intubationRow','intubation',   care.intubation);
        place('comaCareRow','comaCare',       care.comaCare);
        place('burialRow','burial',           care.burial);
        place('religionRow','religion',       care.religion);
        if (careCount > 0) show($('careSection')); else hide($('careSection'));

        /* triage */
        paintTriage(computeTriage(health.allergies, health.conditions, health.triageOverride));

        setText('lastUpdated', new Date().toLocaleDateString());
      } catch (err){
        console.error(err);
        show($('msg'));
      }
    });
  </script>
</body>
</html>
