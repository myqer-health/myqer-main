<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MYQER — Emergency Card</title>
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:24px; }
  .wrap{ max-width:840px; margin:0 auto; }
  .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#dcfce7; color:#065f46; font-weight:600 }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .lab{ font-size:12px; color:#64748b }
  .val{ font-weight:600 }
</style>
</head>
<body>
<div class="wrap">
  <h1>MYQER — Emergency Card <span id="triage" class="pill">AUTO</span></h1>

  <div class="grid">
    <div><div class="lab">Full name</div><div id="v_name" class="val">—</div></div>
    <div><div class="lab">DOB</div><div id="v_dob" class="val">—</div></div>
    <div><div class="lab">Country</div><div id="v_country" class="val">—</div></div>
    <div><div class="lab">Health ID</div><div id="v_hid" class="val">—</div></div>
  </div>

  <div style="margin-top:12px" class="grid">
    <div><div class="lab">Blood type</div><div id="v_bt" class="val">—</div></div>
    <div><div class="lab">Organ donor</div><div id="v_donor" class="val">—</div></div>
    <div style="grid-column:1/-1"><div class="lab">Allergies</div><div id="v_alg" class="val">—</div></div>
    <div style="grid-column:1/-1"><div class="lab">Conditions</div><div id="v_cond" class="val">—</div></div>
    <div style="grid-column:1/-1"><div class="lab">Medications</div><div id="v_meds" class="val">—</div></div>
    <div style="grid-column:1/-1"><div class="lab">Implants/devices</div><div id="v_impl" class="val">—</div></div>
  </div>

  <div style="margin-top:12px">
    <div class="lab">Card URL</div>
    <div id="v_url" class="val" style="font-family:monospace"></div>
  </div>

  <div style="margin-top:12px">
    <div class="lab">ICE</div>
    <div id="v_ice" class="val">—</div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const CODE_VALID = /^[A-HJ-NP-Z2-9]{3}-[A-HJ-NP-Z2-9]{3}$/;
const clean = s => (s||'').toUpperCase().replace(/[\u2010-\u2015\u2212]/g,'-');
const code = clean(location.pathname.split('/').filter(Boolean).pop());
if (!CODE_VALID.test(code)) document.body.innerHTML='<div class="wrap"><p>Card not found.</p></div>';

(async () => {
  const prof = await sb.from('profiles')
    .select('user_id, full_name, date_of_birth, country, national_id, code, fullName, dob, healthId')
    .eq('code', code).maybeSingle();

  const row = prof.data;
  if (!row) { document.body.innerHTML='<div class="wrap"><p>Card not found.</p></div>'; return; }

  const uid = row.user_id;
  const health = await sb.from('health_data').select('*').eq('user_id', uid).maybeSingle();
  const ice = await sb.from('ice_contacts').select('*').eq('user_id', uid).order('contact_order', {ascending:true});

  const p = row;
  const get = (a,b) => a ?? b ?? '—';
  document.getElementById('v_name').textContent    = get(p.full_name, p.fullName);
  document.getElementById('v_dob').textContent     = get(p.date_of_birth, p.dob);
  document.getElementById('v_country').textContent = get(p.country);
  document.getElementById('v_hid').textContent     = get(p.national_id, p.healthId);

  const h = health.data || {};
  document.getElementById('v_bt').textContent    = get(h.blood_type, h.bloodType);
  document.getElementById('v_donor').textContent = (h.organ_donor || h.organDonor) ? 'Yes' : 'No';
  document.getElementById('v_alg').textContent   = get(h.allergies);
  document.getElementById('v_cond').textContent  = get(h.conditions);
  document.getElementById('v_meds').textContent  = get(h.medications);
  document.getElementById('v_impl').textContent  = get(h.implants);

  const lvl = (h.triage_override || h.triageOverride || 'auto').toUpperCase();
  document.getElementById('triage').textContent = lvl;

  const base = `https://${location.hostname.replace(/^www\./,'')}`;
  const url = `${base}/c/${code}`;
  document.getElementById('v_url').textContent = url;

  const list = (ice.data || []).map(c => [c.name, c.relationship, c.phone].filter(Boolean).join(' — '));
  document.getElementById('v_ice').textContent = list.length ? list.join(' | ') : '—';
})();
</script>
</body>
</html>
