<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MYQERâ„¢ â€” Emergency Card</title>
  <style>
    :root{
      --red:#dc2626;
      --red-light:#fef2f2;
      --text:#111827;
      --text-light:#6b7280;
      --green:#10b981;
      --surface:#ffffff;
      --border:#f3f4f6;
    }
    *{ -webkit-font-smoothing:antialiased; box-sizing:border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      margin:0; background:#ffffff; color:var(--text);
      min-height:100vh; padding:8px;
    }
    .wrap{ max-width:340px; margin:0 auto; }
    header{ text-align:center; margin-bottom:12px; }
    .brand{ font-size:20px; font-weight:800; letter-spacing:-.02em; color:var(--text); }
    .brand .er{ color:var(--red); }
    .tagline{ color:var(--text-light); font-size:11px; margin-top:2px; }
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 2px 8px rgba(220,38,38,.08), 0 1px 3px rgba(0,0,0,.06); overflow:hidden;
    }
    .card-header{ padding:12px 16px 6px; text-align:center;
      background:linear-gradient(135deg, var(--red-light) 0%, #ffffff 100%); }
    h1{ font-size:16px; font-weight:700; margin:0; color:var(--text); }
    .status-pill{
      display:inline-block; padding:3px 8px; border-radius:10px; font-size:9px; font-weight:700;
      margin-top:4px; text-transform:uppercase; letter-spacing:.5px; box-shadow:0 1px 3px rgba(0,0,0,.1);
    }
    .status-pill.green{ background:linear-gradient(135deg,#10b981,#059669); color:#fff; }
    .status-pill.amber{ background:linear-gradient(135deg,#f97316,#ea580c); color:#fff; }
    .status-pill.red{ background:linear-gradient(135deg,var(--red),#b91c1c); color:#fff; }

    .card-body{ padding:8px 12px 12px; }
    .info-grid{ display:grid; gap:6px; }
    .info-section{
      background:var(--surface); border-radius:8px; padding:8px; border:1px solid var(--border);
      box-shadow:0 1px 2px rgba(220,38,38,.04);
    }
    .section-title{ font-size:10px; font-weight:700; color:var(--red); text-transform:uppercase;
      letter-spacing:.5px; margin-bottom:4px; }
    .info-row{ display:flex; justify-content:space-between; padding:2px 0; }
    .info-label{ font-size:11px; font-weight:500; color:var(--text-light); }
    .info-value{ font-size:11px; font-weight:600; color:var(--text); text-align:right; }

    .content-box{
      background:var(--red-light); border-radius:6px; padding:6px; font-size:10px; line-height:1.3;
      color:var(--text); min-height:24px; border:1px solid rgba(220,38,38,.1);
    }

    .qr-section{
      background:linear-gradient(135deg,#f8fafc 0%, #e2e8f0 100%); border-radius:8px; padding:8px; text-align:center;
      margin-top:6px; border:1px solid var(--border); box-shadow:0 1px 3px rgba(0,0,0,.05);
    }
    .qr-code{ width:50px; height:50px; border-radius:6px; border:1px solid var(--border); margin:0 auto 6px;
      background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .qr-label{ font-size:9px; font-weight:700; color:var(--red); text-transform:uppercase; letter-spacing:.5px; margin-bottom:3px; }
    .qr-url{ font-family:ui-monospace,monospace; font-size:8px; color:var(--text-light);
      word-break:break-all; background:#fff; padding:3px 4px; border-radius:4px; border:1px solid var(--border); }

    .disclaimer{ background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.2); color:#92400e;
      border-radius:6px; padding:6px; margin-top:6px; font-size:9px; text-align:center; font-weight:500; }
    .updated-time{ color:var(--text-light); font-size:9px; text-align:center; margin-top:3px; }
    footer{ margin-top:12px; color:var(--text-light); font-size:9px; text-align:center; }

    @media (max-width:480px){
      .wrap{padding:0 16px}
      .card{border-radius:20px}
      .card-header,.card-body{padding:20px}
      h1{font-size:22px}
    }
    .err { color:#b91c1c; font-size:11px; text-align:center; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">MYQ<span class="er">ER</span><span style="font-size:.8em;vertical-align:super">â„¢</span></div>
      <div class="tagline">pronounced "my care"</div>
    </header>

    <div id="card" class="card">
      <div class="card-header">
        <h1>Emergency Profile</h1>
        <div id="triagePill" class="status-pill green">Standby</div>
        <div class="updated-time" id="updated">Accessed via QR scan</div>
      </div>

      <div class="card-body">
        <div class="info-grid">
          <div class="info-section">
            <div class="section-title">Personal Information</div>
            <div class="info-row"><span class="info-label">Name</span><span class="info-value" id="fullName">â€”</span></div>
            <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value" id="dob">â€”</span></div>
            <div class="info-row"><span class="info-label">Blood Type</span><span class="info-value" id="blood">â€”</span></div>
            <div class="info-row"><span class="info-label">Organ Donor</span><span class="info-value" id="donor">â€”</span></div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Allergies</div>
            <div class="content-box" id="allergies">No known allergies</div>
          </div>

          <div class="info-section">
            <div class="section-title">Medical Conditions</div>
            <div class="content-box" id="conditions">No known conditions</div>
          </div>

          <div class="info-section">
            <div class="section-title">Current Medications</div>
            <div class="content-box" id="medications">No current medications</div>
          </div>

          <div class="info-section">
            <div class="section-title">Implants & Devices</div>
            <div class="content-box" id="implants">None reported</div>
          </div>

          <div class="info-section">
            <div class="section-title">Emergency Contacts</div>
            <div class="content-box" id="emergencyContacts">No contacts available</div>
          </div>
        </div>

        <div class="qr-section">
          <img id="qr" class="qr-code" alt="QR"/>
          <div class="qr-label">Secure Card URL</div>
          <div class="qr-url" id="cardUrl">myqer.com/card/loading...</div>
        </div>

        <div class="disclaimer">ðŸ”’ Read-only emergency information. Always verify clinically before treatment.</div>
        <div id="err" class="err" hidden></div>
      </div>
    </div>

    <footer>Â© 2025 MYQERâ„¢</footer>
  </div>

  <script>
    (function(){
      // 1) Edge function base
      const FN_BASE = 'https://dmntmhkncldgynufajei.functions.supabase.co/functions/v1/card';

      // 2) Read short code from /c/XXXX-XXXX
      const parts = location.pathname.split('/').filter(Boolean);
      const code = (parts[0] === 'c' && parts[1]) ? parts[1] : '';

      const $ = id => document.getElementById(id);
      const set = (id, v, fallback='â€”') => { $(id).textContent = (v ?? '').toString().trim() || fallback; };

      const pill = $('triagePill');
      function setTriage(level){
        const lv = (level || 'green').toLowerCase();
        const ok = ['green','amber','red'].includes(lv) ? lv : 'green';
        pill.className = 'status-pill ' + ok;
        pill.textContent = ok.toUpperCase();
      }
      function fmtDOB(d){
        if(!d) return 'â€”';
        return new Date(d+'T00:00:00Z').toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
      }

      // Show link + QR regardless so the card looks complete
      if(!code){
        const e = $('err'); e.hidden = false; e.textContent = 'Missing code in URL.';
        return;
      }
      const prettyUrl = `https://www.myqer.com/c/${code}`;
      $('cardUrl').textContent = prettyUrl;
      $('qr').src = 'https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=' + encodeURIComponent(prettyUrl);

      // 3) Load data
      fetch(`${FN_BASE}?code=${encodeURIComponent(code)}`, { mode: 'cors' })
        .then(r => r.json().then(j => ({ok:r.ok, j})))
        .then(({ok, j}) => {
          if(!ok || j.error) throw new Error(j.error || 'Failed to load card');

          const p = j.profile || {};
          const h = j.health || {};
          const ice = Array.isArray(j.ice) ? j.ice : [];

          // meta time
          const when = new Date(j.meta?.generated_at || Date.now())
            .toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
          set('updated', 'Accessed today at ' + when);

          // personal
          set('fullName', p.full_name);
          set('dob', fmtDOB(p.dob));
          set('blood', h.blood_type);
          set('donor', h.organ_donor ? 'Yes' : 'No');

          // blocks
          set('allergies',   h.allergies   || 'No known allergies');
          set('conditions',  h.conditions  || 'No known conditions');
          set('medications', h.medications || 'No current medications');
          set('implants',    h.implants    || 'None reported');

          // triage (override first)
          setTriage(h.triage_override || p.triage || 'green');

          // ICE
          $('emergencyContacts').innerHTML = ice.length
            ? '<ul style="margin:0;padding-left:16px">'+ ice.map(c =>
                `<li><strong>${(c.name||'')}</strong> â€” ${(c.relation||'')} â€” ${(c.phone||'')}</li>`
              ).join('') + '</ul>'
            : 'No contacts available';
        })
        .catch(err => { const e=$('err'); e.hidden=false; e.textContent = err.message; });
    })();
  </script>
</body>
</html>
