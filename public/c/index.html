<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER — Emergency Info</title>
  <meta name="color-scheme" content="light only" />
  <meta name="theme-color" content="#d32f2f" />
  <style>
    :root{
      --primary:#d32f2f; --amber:#f59e0b; --green:#059669; --black:#111827;
      --muted:#6b7280; --slate:#475569; --ink:#0f172a; --border:#e5e7eb;
      --card:rgba(255,255,255,.95);
      --bg:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

    .wrap{max-width:820px;margin:2rem auto;padding:0 1rem}
    .header{text-align:center;margin-bottom:2rem;padding:1rem 0;transform:translateZ(0)}
    .logo{font-size:2rem;font-weight:800;letter-spacing:-.02em;margin-bottom:.25rem;
      background:linear-gradient(135deg,var(--primary) 0%,#b71c1c 100%);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{color:var(--muted);font-weight:500}
    .code{display:inline-block;margin-top:.75rem;background:#fdecec;border:2px solid var(--primary);
      border-radius:999px;padding:6px 12px;font-weight:700;letter-spacing:.08em}

    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;
      box-shadow:0 16px 32px rgba(0,0,0,.06),0 6px 20px rgba(211,47,47,.05);
      padding:1.5rem;-webkit-backdrop-filter: blur(18px);backdrop-filter: blur(18px);
      transform:translateZ(0);contain:content;opacity:0;transition:opacity .18s ease-out}
    .card.show{opacity:1}

    h1{font-size:1.8rem;margin:0 0 .25rem;display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .sub{margin:0 0 .35rem;color:var(--slate);font-weight:500}
    .patient-details{margin:1rem 0 1rem;padding:.75rem 1rem;background:#fff4f4;border:1px solid #f9d6d6;border-radius:12px}
    .row{display:flex;flex-wrap:wrap;gap:.75rem}
    .chip{background:rgba(255,255,255,.9);border:1px solid var(--border);padding:.6rem .8rem;border-radius:12px;font-weight:600}

    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem .65rem;border-radius:999px;
      font-size:.8rem;font-weight:700;border:1px solid transparent;margin:.25rem 0 .75rem}
    .pill.green{background:rgba(5,150,105,.1);color:var(--green);border-color:rgba(5,150,105,.25)}
    .pill.amber{background:rgba(245,158,11,.12);color:var(--amber);border-color:rgba(245,158,11,.28)}
    .pill.red{background:rgba(211,47,47,.12);color:var(--primary);border-color:rgba(211,47,47,.28)}
    .pill.black{background:rgba(17,24,39,.12);color:var(--black);border-color:rgba(17,24,39,.28)}

    .glass{background:rgba(255,255,255,.75);border:1px solid rgba(255,255,255,.3);border-radius:14px;
      padding:1rem;margin:.75rem 0;box-shadow:0 8px 24px rgba(211,47,47,.08)}
    .card,.glass{-webkit-transform:translateZ(0)}

    .section-title{margin:.25rem 0 .75rem;font-weight:700;color:#1f2937}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:.4rem .8rem;font-size:.98rem}
    .kv .k{color:#6b7280}
    .kv .v{color:#111827}

    .disclaimer{font-size:.95rem}
    .error,.loading{margin:1rem 0 1.25rem;text-align:center;font-weight:700;border-radius:14px;padding:1rem}
    .error{background:#fdecec;color:#b71c1c;border:1px solid #f6b2b2}
    .loading{background:#fff6f6;color:#b71c1c;border:1px solid #f8d6d6}

    /* Blue verified badge */
    .verified{
      display:inline-flex;align-items:center;justify-content:center;
      width:1.15em;height:1.15em;margin-left:.2rem;
      background:#3b82f6;color:#fff;border-radius:50%;
      font-size:.7em;font-weight:800;line-height:1;vertical-align:middle;
    }

    @media (max-width:640px){
      .wrap{padding:0 .75rem}
      .kv{grid-template-columns:1fr}
      .kv .k{font-weight:600}
    }

    @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
      .card{background:#ffffff; box-shadow:0 8px 16px rgba(0,0,0,.06)}
      .glass{background:#ffffff}
    }

    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.001ms !important;animation-iteration-count:1 !important;
        transition-duration:.001ms !important;scroll-behavior:auto !important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">MYQER™</div>
      <div class="subtitle">Emergency Medical Information</div>
      <div id="codePill" class="code" aria-live="polite">— — — — — —</div>
    </div>

    <div id="msg" class="error" style="display:none"></div>
    <div id="loading" class="loading" role="status">Loading emergency card…</div>

    <div id="card" class="card" aria-live="polite" aria-busy="true">
      <h1 id="nameWrap">
        <span id="name">—</span>
        <span class="verified" id="verifiedBadge" aria-label="verified" style="display:none">&#10004;</span>
      </h1>
      <div id="triagePill" class="pill green">TRIAGE: GREEN</div>

      <div class="patient-details" id="patientDetails">
        <p class="sub" id="meta">—</p>
        <div class="kv">
          <div id="dobRow" class="k">DOB</div><div id="dobVal" class="v">—</div>
          <div id="healthIdRow" class="k">Health ID</div><div id="healthIdVal" class="v">—</div>
        </div>
      </div>

      <!-- Quick facts -->
      <div class="glass">
        <div class="row">
          <div class="chip"><strong>Blood:</strong> <span id="blood">—</span></div>
          <div class="chip"><strong>Donor:</strong> <span id="donor">—</span></div>
        </div>
      </div>

      <!-- Allergies / Conditions / Meds / Implants (only if present) -->
      <div class="glass" id="allergiesRow" style="display:none">
        <div class="section-title">Allergies & Reactions</div>
        <div id="allergies">—</div>
      </div>

      <div class="glass" id="conditionsRow" style="display:none">
        <div class="section-title">Medical Conditions</div>
        <div id="conditions">—</div>
      </div>

      <div class="glass" id="medsRow" style="display:none">
        <div class="section-title">Medications</div>
        <div id="meds">—</div>
      </div>

      <div class="glass" id="implantsRow" style="display:none">
        <div class="section-title">Implants / Devices</div>
        <div id="implants">—</div>
      </div>

      <!-- ICE (only if present) -->
      <div class="glass" id="iceRow" style="display:none">
        <div class="section-title">In Case of Emergency</div>
        <div id="iceList">—</div>
      </div>

      <!-- My Care (only if any directive present) -->
      <div class="glass" id="careRow" style="display:none">
        <div class="section-title">My Care</div>
        <div class="kv" id="careKV"></div>
      </div>

      <div class="glass disclaimer">
        <p class="muted" style="margin:0;">
          If information is unclear, verify with official medical records. This card reflects the person’s last saved data.
        </p>
      </div>
    </div>

    <p class="muted" style="margin:1rem 0 0;text-align:center">© 2025 MYQER™</p>
  </div>

  <!-- Supabase (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function(){
      /* Strip www once for canonical URLs */
      try{
        var host = location.hostname;
        if (host.startsWith('www.') && !sessionStorage.getItem('strip_www_once')) {
          var bare = host.replace(/^www\./,'');
          var target = location.protocol + '//' + bare + location.pathname + location.search + location.hash;
          if (target !== location.href) {
            sessionStorage.setItem('strip_www_once','1');
            location.replace(target);
            return;
          }
        }
      }catch(_){} 

      const $ = id => document.getElementById(id);
      const show = el => el && (el.style.display = '');
      const hide = el => el && (el.style.display = 'none');
      const setText = (id, v) => { const el=$(id); if (el) el.textContent = (v ?? '').toString(); };

      const ageFromDob = (d)=> {
        if (!/^\d{4}-\d{2}-\d{2}$/.test(d||'')) return null;
        const [Y,M,D]=d.split('-').map(Number);
        const dob=new Date(Date.UTC(Y,M-1,D)), now=new Date();
        let a=now.getUTCFullYear()-dob.getUTCFullYear();
        const m=now.getUTCMonth()-dob.getUTCMonth();
        if (m<0 || (m===0 && now.getUTCDate()<dob.getUTCDate())) a--;
        return a;
      };

      const codeFromPath = () => {
        const seg = location.pathname.replace(/\/+$/,'').split('/').filter(Boolean);
        const i = seg.findIndex(s => s.toLowerCase()==='c');
        if (i>=0 && seg[i+1]) return seg[i+1].toUpperCase();
        const q = new URLSearchParams(location.search).get('code');
        return (q||'').toUpperCase();
      };

      const CODE = codeFromPath();
      setText('codePill', CODE || '— — — — — —');

      const msg = $('msg');
      const loading = $('loading');
      const card = $('card');

      function showError(t){
        msg.textContent=t;
        show(msg); hide(loading);
        card.classList.remove('show'); card.setAttribute('aria-busy','false');
      }
      function showCard(){
        hide(loading); hide(msg);
        if (!card.classList.contains('show')) {
          requestAnimationFrame(()=> { card.classList.add('show'); card.setAttribute('aria-busy','false'); });
        }
      }

      if (!CODE || !/^[A-HJ-NP-Z2-9]{6}$/.test(CODE)) { showError('No card found for this code.'); return; }

      const SB_URL = 'https://dmntmhkncldgynufajei.supabase.co';
      const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
      const supabase = window.supabase.createClient(SB_URL, SB_KEY);

      function computeTriage(allergies, conditions, override){
        if (override && override !== 'auto') return override;
        const a=(allergies||'').toLowerCase(), c=(conditions||'').toLowerCase();
        if (a.includes('anaphylaxis') || a.includes('severe')) return 'red';
        if (a || c) return 'amber';
        return 'green';
      }
      function paintTriage(level){
        const pill=$('triagePill');
        ['green','amber','red','black'].forEach(k=>pill.classList.remove(k));
        pill.classList.add(level);
        pill.textContent='TRIAGE: '+level.toUpperCase();
      }

      (async function load(){
        try{
          // 1) Profile by code
          let r = await supabase.from('profiles').select('*').eq('code', CODE).maybeSingle();
          if (r.error) console.warn('profiles error', r.error);
          const prof = r.data || null;
          if (!prof) { showError('No card found for this code.'); return; }

          const p = {
            user_id:   prof.user_id ?? prof.userId,
            full_name: prof.full_name ?? prof.fullName ?? '',
            dob:       prof.date_of_birth ?? prof.dob ?? '',
            country:   prof.country ?? '',
            health_id: prof.national_id ?? prof.healthId ?? ''
          };

          // 2) Health + ICE (+ Care directives if table exists)
          const [rh, ri, rc] = await Promise.allSettled([
            supabase.from('health_data').select('*').eq('user_id', p.user_id).maybeSingle(),
            supabase.from('ice_contacts').select('*').eq('user_id', p.user_id).order('contact_order', { ascending:true }),
            supabase.from('care_directives').select('*').eq('user_id', p.user_id).maybeSingle()
          ]);

          const rawH = (rh.status==='fulfilled' ? (rh.value.data||{}) : {});
          const rawI = (ri.status==='fulfilled' ? (ri.value.data||[]) : []);
          const rawC = (rc.status==='fulfilled' ? (rc.value.data||null) : null);

          const h = {
            bloodType:      rawH.bloodType      ?? rawH.blood_type      ?? '',
            allergies:      rawH.allergies      ?? rawH.allergy_list    ?? '',
            conditions:     rawH.conditions     ?? rawH.medical_conditions ?? '',
            medications:    rawH.medications    ?? rawH.meds            ?? '',
            implants:       rawH.implants       ?? rawH.implants_devices ?? '',
            organDonor:     (rawH.organDonor ?? rawH.organ_donor) ? true : false,
            triageOverride: rawH.triageOverride ?? rawH.triage_override ?? 'auto'
          };

          const ice = rawI.map(r => {
            const bits=[r.name||'', r.relationship?`(${r.relationship})`:'', r.phone||''].filter(Boolean).join(' ');
            return bits.trim();
          }).filter(Boolean);

          const care = rawC ? {
            lifeSupport: rawC.lifeSupport ?? rawC.life_support ?? '',
            intubation:  rawC.intubation  ?? '',
            comaCare:    rawC.comaCare    ?? rawC.coma_care ?? '',
            burial:      rawC.burial      ?? '',
            religion:    rawC.religion    ?? ''
          } : {};

          // 3) Paint UI
          requestAnimationFrame(() => {
            // Header / meta
            const metaBits=[];
            const age = ageFromDob(p.dob);
            if (age!=null) metaBits.push(`${age} years old`);
            if (p.country) metaBits.push(p.country);

            setText('name', p.full_name || '—');
            show($('verifiedBadge')); /* show the blue check after successful load */
            setText('meta', metaBits.join(' • ') || '—');

            if (p.dob){ setText('dobVal', p.dob); show($('dobRow')); }
            else hide($('dobRow'));

            if (p.health_id){ setText('healthIdVal', p.health_id); show($('healthIdRow')); }
            else hide($('healthIdRow'));

            // Quick facts
            setText('blood', h.bloodType || '—');
            setText('donor', h.organDonor ? 'Y' : 'N');

            // Optional sections
            const place=(rowId,spanId,val)=>{
              const row=$(rowId);
              if (val && String(val).trim()){ setText(spanId,val); show(row); } else hide(row);
            };
            place('allergiesRow','allergies', h.allergies);
            place('conditionsRow','conditions', h.conditions);
            place('medsRow','meds', h.medications);
            place('implantsRow','implants', h.implants);

            if (ice.length){ setText('iceList', ice.join(' • ')); show($('iceRow')); } else hide($('iceRow'));

            // My Care (only filled keys)
            const kv=$('careKV');
            kv.innerHTML='';
            const careEntries = [
              ['Life support', care.lifeSupport],
              ['Intubation',   care.intubation],
              ['Coma care',    care.comaCare],
              ['Burial',       care.burial],
              ['Religion',     care.religion]
            ].filter(([_,v]) => v && String(v).trim());
            if (careEntries.length){
              for (const [k,v] of careEntries){
                const kEl=document.createElement('div'); kEl.className='k'; kEl.textContent=k;
                const vEl=document.createElement('div'); vEl.className='v'; vEl.textContent=v;
                kv.appendChild(kEl); kv.appendChild(vEl);
              }
              show($('careRow'));
            } else {
              hide($('careRow'));
            }

            // Triage
            paintTriage(computeTriage(h.allergies, h.conditions, h.triageOverride));

            // Finalize
            showCard();
          });

        }catch(e){
          console.error(e);
          showError('We couldn’t load this card right now.');
        }
      })();
    })();
  </script>
</body>
</html>
