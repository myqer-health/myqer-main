<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password — MYQER</title>
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png" />
  <link rel="apple-touch-icon" href="/assets/icon-192.png" />
  <link rel="stylesheet" href="/styles/app.css" />
  <style>
    :root { --brand:#c62828; --glass:rgba(255,255,255,.55); --stroke:rgba(0,0,0,.08); --blur:22px; }
    body{margin:0;background:linear-gradient(135deg,#f7f8fb,#e9eef6);font:16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{width:min(560px,92vw);background:var(--glass);backdrop-filter:blur(var(--blur));
      border:1px solid var(--stroke);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:24px}
    h1{margin:0 0 .5rem;font-size:28px;letter-spacing:-.02em}
    .sub{margin:0 0 16px;color:#555}
    label{display:block;margin:.6rem 0 .35rem;font-weight:600}
    input{width:100%;padding:.8rem 1rem;border-radius:12px;border:1px solid var(--stroke);
      background:#fff}
    .row{display:flex;gap:10px;align-items:center}
    .btn{border:1px solid var(--stroke);background:#fff;border-radius:999px;padding:.7rem 1.1rem;cursor:pointer}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn-ghost{background:#fff}
    .alert{border-radius:12px;padding:.7rem 1rem;margin:0 0 12px}
    .alert.error{background:#fff3f3;border:1px solid #ffd0d0;color:#8b0000}
    .alert.success{background:#f1fff3;border:1px solid #cfe8d5;color:#0a6b2d}
    [hidden]{display:none !important}
  </style>
</head>
<body>
  <main class="wrap">
    <!-- Step A: request reset email -->
    <section id="stepRequest" class="card">
      <h1>Reset your password</h1>
      <p class="sub">Enter your email to receive a reset link.</p>

      <div id="msg1" class="alert" style="display:none"></div>

      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />

      <div class="row" style="margin-top:14px">
        <button id="btnSend" class="btn btn-primary">Send reset email</button>
        <a class="btn btn-ghost" href="/login.html">Back to sign in</a>
      </div>
    </section>

    <!-- Step B: arriving from email (type=recovery) – set new password -->
    <section id="stepUpdate" class="card" hidden>
      <h1>Set a new password</h1>
      <p class="sub">Enter your new password below.</p>

      <div id="msg2" class="alert" style="display:none"></div>

      <label for="newpw">New password</label>
      <input id="newpw" type="password" autocomplete="new-password" placeholder="••••••••" />
      <label for="confpw">Confirm password</label>
      <input id="confpw" type="password" autocomplete="new-password" placeholder="••••••••" />

      <div class="row" style="margin-top:14px">
        <button id="btnUpdate" class="btn btn-primary">Update password</button>
        <a class="btn btn-ghost" href="/login.html">Back to sign in</a>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/scripts/config.js';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qs = new URLSearchParams(location.hash.replace('#','?')); // Supabase adds tokens in hash
    const isRecovery = qs.get('type') === 'recovery' || new URLSearchParams(location.search).get('type') === 'recovery';

    const stepRequest = document.getElementById('stepRequest');
    const stepUpdate = document.getElementById('stepUpdate');

    // Show the correct step
    if (isRecovery) {
      stepRequest.hidden = true;
      stepUpdate.hidden = false;
    }

    const show1 = (type, text) => {
      const el = document.getElementById('msg1');
      el.className = 'alert ' + (type === 'error' ? 'error' : 'success');
      el.textContent = text; el.style.display = 'block';
    };
    const show2 = (type, text) => {
      const el = document.getElementById('msg2');
      el.className = 'alert ' + (type === 'error' ? 'error' : 'success');
      el.textContent = text; el.style.display = 'block';
    };

    // A) Send reset email
    document.getElementById('btnSend').addEventListener('click', async () => {
      document.getElementById('msg1').style.display = 'none';
      const email = document.getElementById('email').value.trim();
      if (!email) return show1('error','Enter your email first.');
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: 'https://myqer.com/reset.html'
      });
      if (error) return show1('error', error.message);
      show1('success', 'Check your inbox for a reset link. Open it on this device.');
    });

    // B) Update password when we arrived from the email
    document.getElementById('btnUpdate').addEventListener('click', async () => {
      document.getElementById('msg2').style.display = 'none';
      const a = document.getElementById('newpw').value;
      const b = document.getElementById('confpw').value;
      if (!a || a !== b) return show2('error','Passwords don’t match.');
      const { data, error } = await supabase.auth.updateUser({ password: a });
      if (error) return show2('error', error.message);
      show2('success','Password updated. Redirecting to app…');
      setTimeout(()=> location.replace('/app.html'), 900);
    });
  </script>
</body>
</html>
