<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password — MYQER</title>
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png" />
  <link rel="stylesheet" href="/styles/app.css" />
  <style>
    :root{ --er:#c62828; --line:#e7ebf0; }
    body{margin:0;background:linear-gradient(140deg,#f7f9fc,#ffffff);}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{
      width:min(720px,92vw); background:#fff; border:1px solid var(--line); border-radius:18px;
      box-shadow:0 10px 28px rgba(17,18,20,.08); padding:24px 22px 22px;
    }
    .brand{font-weight:800;letter-spacing:.4px}
    .brand .er{color:var(--er)}
    h1{margin:.2rem 0 10px;font-size:clamp(24px,4.8vw,34px);line-height:1.1}
    p{margin:0 0 12px;color:#555}
    label{display:block;font-size:14px;margin:8px 0 6px;color:#222}
    input{width:100%;height:48px;border-radius:12px;border:1px solid var(--line);padding:12px 14px;font-size:16px}
    input:focus{outline:none;border-color:var(--er);box-shadow:0 0 0 3px rgba(198,40,40,.12)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{height:44px;padding:0 16px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:650}
    .btn-primary{background:var(--er);color:#fff;border-color:var(--er)}
    .btn-ghost{background:#fff}
    .alert{display:none;margin-top:12px;padding:12px 14px;border-radius:12px;font-weight:600;border:1px solid}
    .ok{background:#e9f8ee;color:#0f7a2a;border-color:#bfe8cd}
    .err{background:#fff5e6;color:#9a4a00;border-color:#f4d3a8}
    .hint{font-size:13px;color:#6b7076;margin-top:8px}
    .frame{border:1px dashed #e8edf3;border-radius:12px;padding:12px;margin-top:14px;background:#fafcff}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="step-request">
      <div class="brand">MYQ<span class="er">ER</span><sup>™</sup></div>
      <h1>Reset your password</h1>
      <p>Enter your email and we’ll send a secure link to choose a new password.</p>
      <form id="reset-form">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required />
        <div class="row">
          <button class="btn btn-primary" type="submit">Send reset email</button>
          <a class="btn btn-ghost" href="/login.html">Back to sign in</a>
        </div>
      </form>
      <div id="ok1" class="alert ok">✅ Email sent! Check your inbox.</div>
      <div id="err1" class="alert err">⚠️ Could not send reset email. Please try again.</div>
      <p class="hint">Tip: the link will redirect back to this page to set your new password.</p>
    </div>

    <div class="card hidden" id="step-update">
      <div class="brand">MYQ<span class="er">ER</span><sup>™</sup></div>
      <h1>Choose a new password</h1>
      <p>Enter and confirm your new password.</p>
      <form id="update-form">
        <label for="pw">New password</label>
        <input id="pw" type="password" minlength="8" required />
        <label for="pw2">Confirm password</label>
        <input id="pw2" type="password" minlength="8" required />
        <div class="row">
          <button class="btn btn-primary" type="submit">Update password</button>
          <a class="btn btn-ghost" href="/login.html">Back to sign in</a>
        </div>
      </form>
      <div id="ok2" class="alert ok">✅ Password updated. You can now sign in.</div>
      <div id="err2" class="alert err">⚠️ Could not update password. Please try again.</div>
      <div class="frame"><strong>Security note:</strong> This step only appears after you open the emailed link.</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    // --- your config (same as /scripts/config.js) ---
    const SUPABASE_URL = 'https://tgddpmxpbgzrbrzpomuon.supabase.co';   // <-- your real URL
    const SUPABASE_ANON_KEY = 'eyJh...Bk2Qm';                           // <-- your real anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const stepRequest = document.getElementById('step-request');
    const stepUpdate  = document.getElementById('step-update');
    const ok1 = document.getElementById('ok1'), err1 = document.getElementById('err1');
    const ok2 = document.getElementById('ok2'), err2 = document.getElementById('err2');

    // 1) REQUEST RESET EMAIL
    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault(); ok1.style.display='none'; err1.style.display='none';
      const email = (document.getElementById('email').value || '').trim();
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: 'https://myqer.com/reset.html'
      });
      if (error) { console.error(error); err1.style.display='block'; }
      else { ok1.style.display='block'; }
    });

    // 2) WHEN USER COMES BACK VIA EMAIL LINK -> SHOW "SET NEW PASSWORD" FORM
    // Supabase sets a "type=recovery" and access token; we just show the 2nd form.
    const params = new URLSearchParams(location.hash.slice(1) || location.search);
    const type = params.get('type');
    if (type === 'recovery') {
      stepRequest.classList.add('hidden');
      stepUpdate.classList.remove('hidden');
    }

    // 3) UPDATE PASSWORD
    document.getElementById('update-form').addEventListener('submit', async (e) => {
      e.preventDefault(); ok2.style.display='none'; err2.style.display='none';
      const pw  = document.getElementById('pw').value;
      const pw2 = document.getElementById('pw2').value;
      if (pw !== pw2) { err2.textContent = '⚠️ Passwords do not match.'; err2.style.display='block'; return; }
      const { data: { user }, error } = await supabase.auth.updateUser({ password: pw });
      if (error) { console.error(error); err2.style.display='block'; }
      else { ok2.style.display='block'; }
    });
  </script>
</body>
</html>
