<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reset Password — MYQER</title>
  <link rel="canonical" href="https://myqer.com/reset.html">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="stylesheet" href="styles/app.css">
  <link rel="stylesheet" href="styles/site.css">
</head>
<body>

<header class="site-header" role="banner">
  <div class="container bar">
    <a class="brand" href="/" aria-label="MYQER Home">
      <span>MYQ</span><span class="er">ER</span><sup>™</sup>
    </a>
  </div>
</header>

<section class="wide">
  <div class="container" style="max-width:560px">
    <div class="card" style="padding:24px">
      <h1 style="margin:0 0 12px">Reset your password</h1>
      <p id="desc" class="note" style="margin:0 0 16px">Enter your email to receive a reset link.</p>

      <div id="msg" class="alert" style="display:none"></div>

      <!-- Step A: Ask for email (request link) -->
      <form id="requestForm" class="section" style="gap:.8rem">
        <label>Email
          <input id="reqEmail" type="email" autocomplete="email" required>
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button type="submit" class="btn btn-primary">Send reset email</button>
          <a href="login.html" class="btn btn-ghost">Back to sign in</a>
        </div>
      </form>

      <!-- Step B: Set new password (after clicking email link) -->
      <form id="resetForm" class="section" style="gap:.8rem;display:none">
        <label>New password
          <input id="newPwd" type="password" autocomplete="new-password" required>
        </label>
        <label>Confirm password
          <input id="newPwd2" type="password" autocomplete="new-password" required>
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button type="submit" class="btn btn-primary">Update password</button>
          <a href="login.html" class="btn btn-ghost">Back to sign in</a>
        </div>
      </form>
    </div>
  </div>
</section>

<footer class="footer">
  <div class="container"><div class="foot-row">
    <div>© 2025 MYQER — Emergency Response QR</div>
  </div></div>
</footer>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from './scripts/config.js';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const requestForm = document.getElementById('requestForm');
  const resetForm   = document.getElementById('resetForm');
  const desc        = document.getElementById('desc');
  const msg         = document.getElementById('msg');

  function flash(text, type='info') {
    msg.textContent = text;
    msg.className = 'alert ' + (type === 'error' ? 'error' : (type === 'success' ? 'success' : ''));
    msg.style.display = 'block';
  }
  function clearFlash(){ msg.style.display='none'; }

  // If user arrived via the email link (type=recovery in URL), show the new-password form
  const hash = new URLSearchParams(location.hash.replace(/^#/, ''));
  const isRecovery = hash.get('type') === 'recovery' || new URLSearchParams(location.search).get('type') === 'recovery';

  if (isRecovery) {
    // When the recovery link is used, Supabase creates a session already.
    requestForm.style.display = 'none';
    resetForm.style.display   = 'grid';
    desc.textContent = 'Enter a new password for your MYQER account.';
  }

  // Step A: send reset email
  requestForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearFlash();
    const email = (document.getElementById('reqEmail').value || '').trim();
    if (!email) { flash('Enter your email.', 'error'); return; }

    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: 'https://myqer.com/reset.html'
    });
    if (error) { flash(error.message || 'Could not send reset email. Try again.', 'error'); return; }

    flash('Check your inbox for a reset link. Open it on this device.', 'success');
  });

  // Step B: update password
  resetForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearFlash();
    const p1 = document.getElementById('newPwd').value;
    const p2 = document.getElementById('newPwd2').value;
    if (!p1 || !p2) { flash('Enter and confirm your new password.', 'error'); return; }
    if (p1 !== p2) { flash('Passwords do not match.', 'error'); return; }

    const { error } = await supabase.auth.updateUser({ password: p1 });
    if (error) { flash(error.message || 'Could not update password.', 'error'); return; }

    flash('Password updated. Redirecting to sign in…', 'success');
    setTimeout(()=> location.href = '/login.html', 1200);
  });
</script>
</body>
</html>
