<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reset Password — MYQER</title>
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png"/>
  <link rel="stylesheet" href="/styles/app.css"/>
  <style>
    :root{ --brand:#c62828; --ink:#1a1a1a; --muted:#6b6f76; --line:#e6e9ee; --glass:rgba(255,255,255,.6); }
    body{ margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(135deg,#f6f7fb,#ffffff);}
    .wrap{ min-height:100vh; display:grid; place-items:center; padding:24px; }
    .card{
      width:min(640px,92vw); background:var(--glass); backdrop-filter: blur(14px) saturate(140%);
      border:1px solid var(--line); border-radius:20px; padding:26px 24px;
      box-shadow: 0 10px 28px rgba(0,0,0,.08);
    }
    h1{ margin:0 0 6px; font-size:clamp(24px,4vw,32px); color:var(--ink);}
    p.muted{ margin:0 0 14px; color:var(--muted);}
    label{ display:block; font-size:14px; color:#242628; margin:10px 0 6px;}
    input{ width:100%; height:48px; border:1px solid var(--line); border-radius:12px; padding:0 14px; font-size:16px; background:#fff;}
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;}
    .btn{ height:46px; padding:0 18px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:650;}
    .btn-primary{ background:var(--brand); border-color:var(--brand); color:#fff;}
    .alert{ display:none; margin-top:12px; padding:12px 14px; border-radius:12px; font-weight:600; }
    .ok{ background:#e9f8ee; color:#0f7a2a; }
    .err{ background:#fff5f5; color:#a21a1a; }
    .brand{ display:inline-flex; gap:0; align-items:baseline; margin-bottom:6px; text-decoration:none; color:var(--ink);}
    .brand .er{ color:var(--brand); }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <a class="brand" href="/"><span>MYQ</span><span class="er">ER</span><sup>™</sup></a>
      <h1 id="title">Reset your password</h1>
      <p id="subtitle" class="muted">Enter your email to receive a reset link.</p>

      <!-- Request reset -->
      <form id="requestForm">
        <label>Email</label>
        <input id="reqEmail" type="email" placeholder="you@example.com" required/>
        <div class="row">
          <button class="btn btn-primary" type="submit">Send reset email</button>
          <a class="btn" href="/login.html">Back to sign in</a>
        </div>
        <div id="reqOk"  class="alert ok">✅ Check your inbox for the reset link.</div>
        <div id="reqErr" class="alert err">⚠️ Could not send reset email. Try again.</div>
      </form>

      <!-- Set new password -->
      <form id="changeForm" style="display:none">
        <label>New password</label>
        <input id="newPass" type="password" minlength="8" placeholder="••••••••" required/>
        <div class="row">
          <button class="btn btn-primary" type="submit">Update password</button>
          <a class="btn" href="/login.html">Back to sign in</a>
        </div>
        <div id="chgOk"  class="alert ok">✅ Password updated. You can sign in now.</div>
        <div id="chgErr" class="alert err">⚠️ Could not update password. Try again.</div>
      </form>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ---- match your config.js values ----
    const SUPABASE_URL = 'https://tgddpmxpgbrzrbpomou.supabase.co';   // <— your actual URL
    const SUPABASE_ANON_KEY = 'eyJh…(your long anon)…';               // <— your anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const requestForm = document.getElementById('requestForm');
    const changeForm  = document.getElementById('changeForm');
    const reqOk  = document.getElementById('reqOk');
    const reqErr = document.getElementById('reqErr');
    const chgOk  = document.getElementById('chgOk');
    const chgErr = document.getElementById('chgErr');

    // If the magic link brings us here with a token, show "set new password"
    const hash = window.location.hash || '';
    const hasToken = hash.includes('access_token');

    if (hasToken) {
      // Supabase will already have a session from the hash. Show change form.
      document.getElementById('title').textContent = 'Choose a new password';
      document.getElementById('subtitle').textContent = 'Set a new password to finish resetting.';
      requestForm.style.display = 'none';
      changeForm.style.display  = 'block';
    }

    requestForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      reqOk.style.display = reqErr.style.display = 'none';
      const email = document.getElementById('reqEmail').value.trim();
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${location.origin}/reset.html`
      });
      if (error) { reqErr.style.display = 'block'; console.error(error); }
      else { reqOk.style.display = 'block'; }
    });

    changeForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      chgOk.style.display = chgErr.style.display = 'none';
      const password = document.getElementById('newPass').value;
      const { error } = await supabase.auth.updateUser({ password });
      if (error) { chgErr.style.display = 'block'; console.error(error); }
      else { chgOk.style.display = 'block'; setTimeout(()=>location.href='/login.html', 1200); }
    });
  </script>
</body>
</html>
