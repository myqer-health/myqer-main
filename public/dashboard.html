<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MYQER Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root {
      --brand: #c62828;
      --radius: 18px;
      --shadow: 0 18px 42px rgba(2,8,23,.12), 0 2px 6px rgba(2,8,23,.06);
    }
    body {
      background: linear-gradient(135deg,#f8fafc 0%, #e6ecf5 100%);
    }
    .glass-card {
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(12px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body class="min-h-screen text-gray-900">

  <!-- NAV -->
  <nav class="bg-white/80 backdrop-blur-md shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center h-16 px-4">
      <h1 class="text-xl font-bold">MYQ<span class="text-red-600">ER</span> Dashboard</h1>
      <div class="flex gap-3">
        <button id="logout" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Logout</button>
        <button id="deleteAccount" class="px-4 py-2 rounded-lg border border-red-600 text-red-600 hover:bg-red-50">Delete</button>
      </div>
    </div>
  </nav>

  <!-- LOADING -->
  <div id="loadingState" class="flex items-center justify-center min-h-[60vh]">
    <div class="text-center">
      <div class="animate-spin h-12 w-12 border-b-2 border-red-600 mx-auto mb-4 rounded-full"></div>
      <p>Loading your dashboard…</p>
    </div>
  </div>

  <!-- DASHBOARD -->
  <main id="dashboardContent" class="hidden max-w-5xl mx-auto p-6 space-y-8">

    <!-- WELCOME -->
    <div class="glass-card p-6">
      <h2 class="text-2xl font-bold">Welcome to your Emergency Dashboard</h2>
      <p class="text-gray-600">Manage your profile, medical info, and ICE contacts.</p>
    </div>

    <!-- PROFILE -->
    <section class="glass-card p-6">
      <h3 class="text-xl font-semibold mb-4">👤 Profile</h3>
      <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input name="full_name" placeholder="Full Name" class="border p-2 rounded"/>
        <input name="country" placeholder="Country" class="border p-2 rounded"/>
        <input name="date_of_birth" type="date" class="border p-2 rounded"/>
        <input name="national_id" placeholder="National ID" class="border p-2 rounded"/>
        <button class="col-span-2 bg-red-600 text-white px-4 py-2 rounded">💾 Save Profile</button>
      </form>
    </section>

    <!-- HEALTH -->
    <section class="glass-card p-6">
      <h3 class="text-xl font-semibold mb-4">🏥 Health Information</h3>
      <form id="healthForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select name="blood_type" class="border p-2 rounded">
          <option value="">Blood Type</option><option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option><option>O+</option><option>O-</option>
          <option>AB+</option><option>AB-</option>
        </select>
        <select name="life_support_pref" class="border p-2 rounded">
          <option value="">Life Support Pref</option>
          <option>Full support</option><option>Limited support</option>
          <option>Comfort only</option><option>No preference</option>
        </select>
        <label class="col-span-2 flex gap-2"><input type="checkbox" name="organ_donor"/> Organ Donor</label>
        <textarea name="allergies" placeholder="Allergies" class="col-span-2 border p-2 rounded"></textarea>
        <textarea name="conditions" placeholder="Conditions" class="col-span-2 border p-2 rounded"></textarea>
        <textarea name="meds" placeholder="Medications" class="col-span-2 border p-2 rounded"></textarea>
        <button class="col-span-2 bg-red-600 text-white px-4 py-2 rounded">💾 Save Health</button>
      </form>
    </section>

    <!-- ICE -->
    <section class="glass-card p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">📞 Emergency Contacts (ICE)</h3>
        <button id="addIce" class="bg-red-600 text-white px-3 py-1 rounded">➕ Add</button>
      </div>
      <div id="iceContactsList" class="space-y-3"></div>
    </section>

    <!-- QR -->
    <section class="glass-card p-6">
      <h3 class="text-xl font-semibold mb-4">📱 Your Emergency QR</h3>
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <div id="qrCode" class="text-center"></div>
        <div>
          <p class="mb-2 text-sm text-gray-600">Scan or share this link:</p>
          <a id="cardLink" href="#" target="_blank" class="text-red-600 break-all"></a>
        </div>
      </div>
    </section>
  </main>

<script type="module">
  const SUPABASE_URL = "https://tgddpmxpbgrzrbzpomou.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser, profile, health, contacts=[];

  const els = {
    loading: document.getElementById("loadingState"),
    dash: document.getElementById("dashboardContent"),
    qr: document.getElementById("qrCode"),
    link: document.getElementById("cardLink"),
    profileForm: document.getElementById("profileForm"),
    healthForm: document.getElementById("healthForm"),
    iceList: document.getElementById("iceContactsList")
  };

  document.addEventListener("DOMContentLoaded", init);

  async function init(){
    const { data:{ session } } = await client.auth.getSession();
    if(!session) return location.replace("/");
    currentUser = session.user;
    await loadData();
    render();
    els.loading.classList.add("hidden");
    els.dash.classList.remove("hidden");
  }

  async function loadData(){
    const { data:p } = await client.from("profiles").select("*").eq("id",currentUser.id).single();
    profile = p || {};
    const { data:h } = await client.from("health_profiles").select("*").eq("user_id",currentUser.id).single();
    health = h || {};
    const { data:c } = await client.from("ice_contacts").select("*").eq("user_id",currentUser.id);
    contacts = c || [];
  }

  function render(){
    // QR
    if(profile.code){
      const url = `${location.origin}/card.html?code=${profile.code}`;
      els.link.textContent = url;
      els.link.href = url;
      els.qr.innerHTML="";
      QRCode.toCanvas(url,{width:200},(err,canvas)=>{ if(!err) els.qr.appendChild(canvas); });
    }
    // ICE
    els.iceList.innerHTML = contacts.map(x=>`
      <div class="p-3 border rounded flex justify-between">
        <div><b>${x.name||"—"}</b><br/><span class="text-sm">${x.phone||""}</span></div>
        <button onclick="deleteContact(${x.id})" class="text-red-600">🗑</button>
      </div>`).join("");
  }

  // Save handlers
  els.profileForm.addEventListener("submit",async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const data=Object.fromEntries(fd.entries());
    data.id=currentUser.id;
    data.code=profile.code||crypto.randomUUID();
    await client.from("profiles").upsert(data);
    profile=data; render();
  });
  els.healthForm.addEventListener("submit",async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const data=Object.fromEntries(fd.entries());
    data.user_id=currentUser.id;
    data.organ_donor=fd.has("organ_donor");
    await client.from("health_profiles").upsert(data);
    health=data;
  });

  document.getElementById("addIce").onclick=async()=>{
    const { data } = await client.from("ice_contacts").insert({user_id:currentUser.id,name:"",phone:""}).select().single();
    contacts.push(data); render();
  };

  window.deleteContact=async id=>{
    await client.from("ice_contacts").delete().eq("id",id);
    contacts=contacts.filter(x=>x.id!==id); render();
  };

  document.getElementById("logout").onclick=async()=>{
    await client.auth.signOut(); location.replace("/");
  };
  document.getElementById("deleteAccount").onclick=async()=>{
    if(confirm("Delete account permanently?")){
      await client.from("profiles").delete().eq("id",currentUser.id);
      await client.from("health_profiles").delete().eq("user_id",currentUser.id);
      await client.from("ice_contacts").delete().eq("user_id",currentUser.id);
      await client.auth.signOut();
      location.replace("/");
    }
  };
</script>
</body>
</html>
