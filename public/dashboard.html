<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MYQER™ Dashboard - Your Emergency Profile</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Supabase SDK -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <!-- QR Code Library -->
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Your styles -->
  <style>
    /* custom CSS will go here */
  </style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --red: #DC2626;
            --green: #059669;
            --orange: #EA580C;
            --ink: #0F172A;
            --slate: #475569;
            --light-slate: #94A3B8;
            --bg: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            --white: #FFFFFF;
            --glass: rgba(255, 255, 255, 0.95);
            --border: rgba(148, 163, 184, 0.15);
            --shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 20px 64px rgba(15, 23, 42, 0.12);
            --shadow-xl: 0 32px 80px rgba(15, 23, 42, 0.15);
            --gradient-red: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            --gradient-green: linear-gradient(135deg, #059669 0%, #047857 100%);
            --gradient-orange: linear-gradient(135deg, #EA580C 0%, #C2410C 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--ink);
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Loading State */
        #loadingState {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.125rem;
            color: var(--slate);
            font-weight: 500;
        }

        /* Error Box */
        #errorBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border: 2px solid #EF4444;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
            z-index: 9998;
            display: none;
        }

        #errorBox h3 {
            color: #EF4444;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        #errorMsg {
            color: var(--slate);
            margin-bottom: 1.5rem;
        }

        .error-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Toast Area */
        #toastArea {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9997;
            pointer-events: none;
        }

        .toast {
            background: var(--white);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--green);
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 320px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #EF4444;
            color: #991B1B;
        }

        .toast.success {
            border-left-color: var(--green);
            color: #166534;
        }

        /* Header */
        header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .logo-myq {
            color: var(--ink);
        }

        .logo-er {
            color: var(--red);
        }

        .logo-tm {
            color: var(--ink);
            font-size: 0.8em;
            vertical-align: super;
        }

        .logo-hint {
            font-size: 0.75rem;
            color: var(--light-slate);
            font-style: italic;
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #langSelector {
            position: relative;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1001;
            min-width: 120px;
            display: none;
        }

        .lang-dropdown button {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .lang-dropdown button:hover {
            background: var(--bg);
        }

        #netStatus {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #netStatus.online {
            background: #DCFCE7;
            color: var(--green);
        }

        #netStatus.offline {
            background: #FEF3C7;
            color: #D97706;
        }

        #btnSignOut {
            background: var(--red);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        #btnSignOut:hover {
            background: #B71C1C;
            transform: translateY(-1px);
        }

        /* Offline Banner */
        #offlineBanner {
            background: #FEF3C7;
            color: #92400E;
            padding: 0.75rem 2rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom: 1px solid #F59E0B;
            display: none;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            gap: 2rem;
        }

        /* Ultra-Premium Glass Cards with Left Ribbons */
        .card {
            background: var(--glass);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 3rem 3rem 3rem 4rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 1rem;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 6px;
            background: var(--gradient-green);
            border-radius: 0 4px 4px 0;
        }

        .card.ice::before {
            background: var(--gradient-orange);
        }

        .card.critical::before {
            background: var(--gradient-red);
        }

        .card.emergency::before {
            background: var(--gradient-red);
        }

        /* Left Ribbon */
        .ribbon {
            position: absolute;
            top: 2rem;
            left: -0.5rem;
            background: var(--gradient-green);
            color: var(--white);
            padding: 0.75rem 1.5rem 0.75rem 2rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 0 12px 12px 0;
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
            z-index: 10;
        }

        .ribbon::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -8px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid rgba(5, 150, 105, 0.8);
            border-top: 8px solid rgba(5, 150, 105, 0.8);
        }

        .ribbon.ice {
            background: var(--gradient-orange);
            box-shadow: 0 4px 16px rgba(234, 88, 12, 0.3);
        }

        .ribbon.ice::after {
            border-right-color: rgba(234, 88, 12, 0.8);
            border-top-color: rgba(234, 88, 12, 0.8);
        }

        .ribbon.critical {
            background: var(--gradient-red);
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .ribbon.critical::after {
            border-right-color: rgba(220, 38, 38, 0.8);
            border-top-color: rgba(220, 38, 38, 0.8);
        }

        .ribbon.emergency {
            background: var(--gradient-red);
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .ribbon.emergency::after {
            border-right-color: rgba(220, 38, 38, 0.8);
            border-top-color: rgba(220, 38, 38, 0.8);
        }

        /* Card Headers */
        .card-header {
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ink);
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            color: var(--slate);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            gap: 1.5rem;
        }

        .form-grid.two-col {
            grid-template-columns: 1fr 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--ink);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--white);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--red);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--light-slate);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--red);
        }

        /* Save Buttons */
        .save-button {
            background: var(--red);
            color: var(--white);
            border: none;
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        .save-button:hover:not(:disabled) {
            background: #B71C1C;
            transform: translateY(-1px);
        }

        .save-button:disabled {
            background: var(--light-slate);
            cursor: not-allowed;
        }

        /* Status Messages */
        .status-msg {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            display: none;
        }

        .status-msg.success {
            background: #DCFCE7;
            color: var(--green);
        }

        .status-msg.error {
            background: #FEE2E2;
            color: #DC2626;
        }

        /* Triage Section */
        .triage-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .triage-label {
            font-weight: 600;
            color: var(--ink);
        }

        #triagePill {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #triagePill.green {
            background: #DCFCE7;
            color: var(--green);
        }

        #triagePill.amber {
            background: #FEF3C7;
            color: #D97706;
        }

        #triagePill.red {
            background: #FEE2E2;
            color: #DC2626;
        }

        #triagePill.black {
            background: #F1F5F9;
            color: var(--slate);
        }

        #triageOverride {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--white);
        }

        /* Premium Emergency Card & QR Section */
        .emergency-card {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.03) 0%, rgba(220, 38, 38, 0.08) 100%);
            border: 1px solid rgba(220, 38, 38, 0.15);
        }

        .qr-section {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 3rem;
            margin-top: 2rem;
            align-items: start;
        }

        #qrSlot {
            position: relative;
            width: 240px;
            height: 240px;
            background: var(--white);
            border: 3px solid rgba(220, 38, 38, 0.1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(220, 38, 38, 0.1);
        }

        #qrSlot::before {
            content: '';
            position: absolute;
            inset: -8px;
            background: conic-gradient(from 0deg, transparent, rgba(220, 38, 38, 0.2), transparent);
            border-radius: 24px;
            z-index: -1;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #qrCanvas {
            border-radius: 12px;
        }

        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: rgba(220, 38, 38, 0.05);
            border: 2px dashed rgba(220, 38, 38, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate);
            font-size: 0.875rem;
            text-align: center;
            font-weight: 500;
        }

        #codeUnderQR {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            color: var(--slate);
            text-align: center;
            margin-top: 1rem;
            font-weight: 600;
            letter-spacing: 0.1em;
        }

        #qrStatus {
            background: rgba(220, 38, 38, 0.1);
            color: var(--red);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 1rem;
        }

        .qr-controls {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .qr-url-section {
            background: rgba(220, 38, 38, 0.03);
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .qr-url-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #cardUrl {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            background: var(--white);
            color: var(--slate);
            margin-bottom: 1rem;
        }

        .url-actions {
            display: flex;
            gap: 0.75rem;
        }

        .qr-downloads {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .qr-downloads h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .download-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--red);
            border: 2px solid var(--red);
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--red);
            color: var(--white);
        }

        /* Premium ICE Contacts */
        .ice-row {
            background: rgba(234, 88, 12, 0.03);
            border: 1px solid rgba(234, 88, 12, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .ice-row:hover {
            background: rgba(234, 88, 12, 0.05);
            border-color: rgba(234, 88, 12, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(234, 88, 12, 0.1);
        }

        .ice-contact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .contact-number {
            background: var(--gradient-orange);
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .ice-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .iceSaveBtn {
            background: var(--gradient-orange);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .iceSaveBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .iceDeleteBtn {
            background: none;
            border: none;
            color: #DC2626;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .iceDeleteBtn:hover {
            background: rgba(220, 38, 38, 0.1);
            color: #B91C1C;
        }

        .ice-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .ice-form-grid .form-group:nth-child(3) {
            grid-column: 1 / -1;
        }

        #addIce {
            background: rgba(234, 88, 12, 0.1);
            color: var(--orange);
            border: 2px dashed rgba(234, 88, 12, 0.3);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            width: 100%;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #addIce:hover:not(:disabled) {
            background: rgba(234, 88, 12, 0.15);
            border-color: rgba(234, 88, 12, 0.5);
            transform: translateY(-2px);
        }

        #addIce:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .header-controls {
                justify-content: space-between;
            }

            main {
                padding: 1rem;
                gap: 1.5rem;
            }

            .card {
                padding: 1.5rem 1.5rem 1.5rem 2rem;
                margin-left: 0.5rem;
            }

            .form-grid.two-col {
                grid-template-columns: 1fr;
            }

            .qr-section {
                grid-template-columns: 1fr;
                gap: 2rem;
                text-align: center;
            }

            .qr-placeholder {
                width: 150px;
                height: 150px;
            }

            #qrSlot {
                width: 200px;
                height: 200px;
                margin: 0 auto;
            }

            .download-grid {
                grid-template-columns: 1fr;
            }

            .ice-form-grid {
                grid-template-columns: 1fr;
            }

            .disclaimers {
                padding: 0 1rem;
            }

            .disclaimer-content {
                padding: 1.5rem;
            }

            .footer {
                padding: 1.5rem 1rem;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }

            .footer-links {
                justify-content: center;
            }
        }

        /* RTL Support */
        [dir="rtl"] .ribbon {
            right: auto;
            left: -30px;
            transform: rotate(-45deg);
        }

        [dir="rtl"] .lang-dropdown {
            right: auto;
            left: 0;
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--red);
            outline-offset: 2px;
        }

        /* Auto-save indicators */
        .field-saved {
            position: relative;
        }

        .field-saved::after {
            content: '✓';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--green);
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .field-saved.show-check::after {
            opacity: 1;
        }

        /* Delete Account Section */
        .delete-account {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.03) 0%, rgba(220, 38, 38, 0.08) 100%);
            border: 1px solid rgba(220, 38, 38, 0.15);
            margin-top: 3rem;
        }

        .delete-form {
            background: rgba(220, 38, 38, 0.05);
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 1.5rem;
        }

        .delete-button {
            background: #DC2626;
            color: var(--white);
            border: none;
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
            width: 100%;
        }

        .delete-button:hover:not(:disabled) {
            background: #B91C1C;
            transform: translateY(-1px);
        }

        .delete-button:disabled {
            background: var(--light-slate);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Disclaimers */
        .disclaimers {
            max-width: 1200px;
            margin: 3rem auto 2rem;
            padding: 0 2rem;
        }

        .disclaimer-content {
            background: rgba(148, 163, 184, 0.05);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
        }

        .disclaimer-content p {
            color: var(--slate);
            font-size: 0.875rem;
            line-height: 1.6;
            margin: 0;
        }

        .disclaimer-content p:first-child {
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            background: var(--white);
            border-top: 1px solid var(--border);
            padding: 2rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-links {
            display: flex;
            gap: 2rem;
        }

        .footer-links a {
            color: var(--slate);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: var(--red);
        }

        .footer-copyright {
            color: var(--light-slate);
            font-size: 0.75rem;
        }

        /* Hidden state */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingState">
        <div class="spinner"></div>
        <div class="loading-text" data-i18n="loading.dashboard">Loading your dashboard…</div>
    </div>

    <!-- Error Box -->
    <div id="errorBox">
        <h3 data-i18n="error.title">Something went wrong</h3>
        <div id="errorMsg"></div>
        <div class="error-actions">
            <button class="btn-secondary" onclick="location.reload()" data-i18n="error.retry">Try Again</button>
        </div>
    </div>

    <!-- Toast Area -->
    <div id="toastArea" aria-live="polite"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <h1><span class="logo-myq">MYQ</span><span class="logo-er">ER</span><span class="logo-tm">™</span></h1>
                <span class="logo-hint" data-i18n="logo.hint">pronounced "my care"</span>
            </div>
            <div class="header-controls">
                <div style="position: relative;">
                    <button id="langSelector" aria-haspopup="true" aria-expanded="false">EN</button>
                    <div class="lang-dropdown" id="langDropdown">
                        <button data-lang="en">English</button>
                        <button data-lang="es">Español</button>
                        <button data-lang="fr">Français</button>
                        <button data-lang="de">Deutsch</button>
                        <button data-lang="it">Italiano</button>
                        <button data-lang="pt">Português</button>
                        <button data-lang="ro">Română</button>
                        <button data-lang="ar">العربية</button>
                        <button data-lang="hi">हिन्दी</button>
                        <button data-lang="zh">中文</button>
                    </div>
                </div>
                <div id="netStatus" class="online" data-i18n="status.online">Online</div>
                <button id="btnSignOut" data-i18n="header.logout">Logout</button>
            </div>
        </div>
    </header>

    <!-- Offline Banner -->
    <div id="offlineBanner">
        <span data-i18n="offline.message">You're offline — QR still works with cached data.</span>
    </div>

    <!-- Main Content -->
    <main>
        <!-- Identity Section -->
        <section class="card identity">
            <div class="ribbon">Identity</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="identity.title">Identity — Personal Information</h2>
                <p class="card-subtitle" data-i18n="identity.hint">These details help responders confirm who you are.</p>
            </div>
            <form class="form-grid two-col">
                <div class="form-group">
                    <label for="profileFullName" data-i18n="identity.fullName">Full Name</label>
                    <input type="text" id="profileFullName" data-i18n-placeholder="identity.fullNamePlaceholder" placeholder="Enter your full legal name" required>
                </div>
                <div class="form-group">
                    <label for="profileDob" data-i18n="identity.dob">Date of Birth</label>
                    <input type="date" id="profileDob" required>
                    <span class="form-hint" data-i18n="identity.dobHint">Format: YYYY-MM-DD</span>
                </div>
                <div class="form-group">
                    <label for="profileCountry" data-i18n="identity.country">Country</label>
                    <select id="profileCountry" required>
                        <option value="" data-i18n="identity.selectCountry">Select your country</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="GB">United Kingdom</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="ES">Spain</option>
                        <option value="IT">Italy</option>
                        <option value="PT">Portugal</option>
                        <option value="RO">Romania</option>
                        <option value="IN">India</option>
                        <option value="CN">China</option>
                        <option value="AU">Australia</option>
                        <option value="BR">Brazil</option>
                        <option value="MX">Mexico</option>
                        <option value="JP">Japan</option>
                        <option value="KR">South Korea</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="profileHealthId" data-i18n="identity.healthId">National/Health ID (Optional)</label>
                    <input type="text" id="profileHealthId" data-i18n-placeholder="identity.healthIdPlaceholder" placeholder="e.g., NHS number, SSN, etc.">
                    <span class="form-hint" data-i18n="identity.healthIdHint">Only visible to medical professionals</span>
                </div>
            </form>
            <button class="save-button" id="saveProfile" data-i18n="common.saveProfile">Save Profile</button>
            <div class="status-msg" id="profileMsg"></div>
        </section>

        <!-- Critical Health Section -->
        <section class="card critical">
            <div class="ribbon critical">Critical</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="critical.title">CRITICAL — Medical & Health Details</h2>
                <p class="card-subtitle" data-i18n="critical.hint">Keep this current. It appears on your emergency card.</p>
            </div>
            <form class="form-grid">
                <div class="form-group">
                    <label for="hfBloodType" data-i18n="critical.bloodType">Blood Type</label>
                    <select id="hfBloodType">
                        <option value="" data-i18n="critical.selectBloodType">Select blood type</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="Unknown" data-i18n="critical.unknown">Unknown</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hfAllergies" data-i18n="critical.allergies">Critical Allergies</label>
                    <textarea id="hfAllergies" data-i18n-placeholder="critical.allergiesPlaceholder" placeholder="List any life-threatening allergies (medications, foods, etc.)"></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="hfDonor">
                    <label for="hfDonor" data-i18n="critical.organDonor">I am an organ donor</label>
                </div>
                <div class="form-group">
                    <label for="hfConditions" data-i18n="critical.conditions">Medical Conditions</label>
                    <textarea id="hfConditions" data-i18n-placeholder="critical.conditionsPlaceholder" placeholder="Diabetes, heart disease, epilepsy, etc."></textarea>
                </div>
                <div class="form-group">
                    <label for="hfMeds" data-i18n="critical.medications">Current Medications</label>
                    <textarea id="hfMeds" data-i18n-placeholder="critical.medicationsPlaceholder" placeholder="List all current medications and dosages"></textarea>
                </div>
                <div class="form-group">
                    <label for="hfImplants" data-i18n="critical.implants">Implants/Medical Devices</label>
                    <textarea id="hfImplants" data-i18n-placeholder="critical.implantsPlaceholder" placeholder="Pacemaker, insulin pump, metal implants, etc."></textarea>
                </div>
            </form>
            
            <!-- Triage Section -->
            <div class="triage-section">
                <span class="triage-label" data-i18n="triage.label">Triage:</span>
                <div id="triagePill" class="green">GREEN</div>
                <select id="triageOverride">
                    <option value="auto" data-i18n="triage.useAuto">Use auto</option>
                    <option value="green" data-i18n="triage.green">Green</option>
                    <option value="amber" data-i18n="triage.amber">Amber</option>
                    <option value="red" data-i18n="triage.red">Red</option>
                    <option value="black" data-i18n="triage.black">Black</option>
                </select>
            </div>

            <button class="save-button" id="saveHealth" data-i18n="common.saveHealth">Save Health</button>
            <div class="status-msg" id="healthMsg"></div>
        </section>

        <!-- ICE Contacts Section -->
        <section class="card ice">
            <div class="ribbon ice">ICE</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="iceTitle">Emergency Contacts (ICE)</h2>
                <p class="card-subtitle" data-i18n="iceHint">Add up to 3 trusted contacts.</p>
            </div>
            
            <div id="iceContactsList">
                <!-- ICE contacts will be dynamically added here -->
            </div>
            
            <button id="addIce" data-i18n="ice.addContact">+ Add Emergency Contact</button>
            <button class="save-button" id="saveIce" data-i18n="common.saveIce">Save ICE Contacts</button>
            <div class="status-msg" id="iceMsg"></div>
        </section>
        
        <!-- Emergency Card & QR Section -->
<section class="card emergency emergency-card">
  <div class="ribbon emergency">Emergency</div>

  <div class="card-header">
    <h2 class="card-title" id="qrTitle">Emergency Card & QR</h2>
    <p class="card-subtitle" id="qrExplain">QR never changes; it always opens your latest info.</p>
  </div>

  <!-- two-column wrapper -->
  <div class="qr-section">
    <!-- LEFT: QR slot -->
    <div>
      <div id="qrSlot">
        <canvas id="qrCanvas" width="200" height="200" aria-label="QR Code" style="display:none;"></canvas>
        <div class="qr-placeholder" id="qrPlaceholder">
          <span>QR Code will appear here<br>after saving your profile</span>
        </div>
      </div>
      <p id="codeUnderQR" class="text-mono text-muted"></p>
      <p id="qrStatus" role="alert" hidden></p>
    </div>

    <!-- RIGHT: controls -->
    <div class="qr-controls">
      <!-- Card URL -->
      <div class="qr-url-section">
        <h4>Card URL</h4>
        <input type="text" id="cardUrl" readonly placeholder="https://www.myqer.com/c/XXXX-XXX">
        <div class="url-actions">
          <button class="btn-secondary" id="copyLink">Copy Link</button>
          <button class="btn-secondary" id="openLink">Open Link</button>
        </div>
      </div>

      <!-- Offline text -->
      <div class="qr-offline">
        <h4>Offline QR Text</h4>
        <div class="offline-actions" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <button class="btn-secondary" id="copyOffline">Copy Offline Text</button>
          <button class="btn-secondary" id="dlOffline">Download Offline</button>
        </div>
        <textarea id="offlineText" rows="4" readonly
          placeholder="Offline emergency summary will appear here after generating QR"
          style="width:100%; resize:vertical;"></textarea>
      </div>

      <!-- Downloads -->
      <div class="qr-downloads">
        <h4>Downloads</h4>
        <div class="download-grid">
          <button class="btn-secondary" id="dlPNG">PNG</button>
          <button class="btn-secondary" id="dlSVG">SVG</button>
          <button class="btn-secondary" id="printQR">Print</button>
        </div>
      </div>
    </div> <!-- /qr-controls -->
  </div> <!-- /qr-section -->
</section>

        <!-- Delete Account Section -->
        <section class="card delete-account">
            <div class="ribbon critical">Danger</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="delete.title">Delete Account</h2>
                <p class="card-subtitle" data-i18n="delete.warning">This action cannot be undone. All your data will be permanently deleted.</p>
            </div>
            <div class="delete-form">
                <div class="form-group">
                    <label for="deletePhrase" data-i18n="delete.confirmLabel">Type "DELETE MY ACCOUNT" to confirm:</label>
                    <input type="text" id="deletePhrase" data-i18n-placeholder="delete.confirmPlaceholder" placeholder="DELETE MY ACCOUNT" autocomplete="off">
                    <span class="form-hint" data-i18n="delete.confirmHint">This phrase must match exactly</span>
                </div>
                <button class="delete-button" id="deleteBtn" disabled data-i18n="delete.button">Delete My Account</button>
                <div class="status-msg" id="deleteMsg"></div>
            </div>
        </section>
    </main>

    <!-- Disclaimers -->
    <div class="disclaimers">
        <div class="disclaimer-content">
            <p data-i18n="disclaimer.medical">Informational only. Clinicians must confirm with official medical documents.</p>
            <p data-i18n="disclaimer.privacy">Data stays on your device unless you choose to share.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="/privacy.html" data-i18n="footer.privacy">Privacy Policy</a>
                <a href="/terms.html" data-i18n="footer.terms">Terms of Service</a>
            </div>
            <div class="footer-copyright">
                <span data-i18n="footer.copyright">© 2024 MYQER™. All rights reserved.</span>
            </div>
        </div>
    </footer>
 <script>
  // =========================
  // Global state
  // =========================
  let currentLang = 'en';
  let isOnline = navigator.onLine;
  let userData = {};
  let iceContacts = [];
  let autoSaveTimeouts = {};

  // =========================
  // Supabase setup
  // =========================
  const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';

  let supabase = null;
  let isSupabaseAvailable = false;

  try {
    if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      isSupabaseAvailable = true;
      console.log('✅ Supabase initialized successfully');
    }
  } catch (error) {
    console.warn('⚠️ Supabase initialization failed, running in demo mode:', error);
    isSupabaseAvailable = false;
  }

  // Helper: current user id
  const getUserId = async () => {
    const { data, error } = await supabase.auth.getUser();
    if (error) throw error;
    return data?.user?.id || null;
  };

  // =========================
  // i18n
  // =========================
  const LOCALES = {
    en: {
      "loading.dashboard":"Loading your dashboard…","error.title":"Something went wrong","error.retry":"Try Again","logo.hint":"pronounced \"my care\"","header.logout":"Logout","status.online":"Online","status.offline":"Offline","offline.message":"You're offline — QR still works with cached data.","identity.title":"Identity — Personal Information","identity.hint":"These details help responders confirm who you are.","identity.fullName":"Full Name","identity.fullNamePlaceholder":"Enter your full legal name","identity.dob":"Date of Birth","identity.dobHint":"Format: YYYY-MM-DD","identity.country":"Country","identity.selectCountry":"Select your country","identity.healthId":"National/Health ID (Optional)","identity.healthIdPlaceholder":"e.g., NHS number, SSN, etc.","identity.healthIdHint":"Only visible to medical professionals","critical.title":"CRITICAL — Medical & Health Details","critical.hint":"Keep this current. It appears on your emergency card.","critical.bloodType":"Blood Type","critical.selectBloodType":"Select blood type","critical.unknown":"Unknown","critical.allergies":"Critical Allergies","critical.allergiesPlaceholder":"List any life-threatening allergies (medications, foods, etc.)","critical.organDonor":"I am an organ donor","critical.conditions":"Medical Conditions","critical.conditionsPlaceholder":"Diabetes, heart disease, epilepsy, etc.","critical.medications":"Current Medications","critical.medicationsPlaceholder":"List all current medications and dosages","critical.implants":"Implants/Medical Devices","critical.implantsPlaceholder":"Pacemaker, insulin pump, metal implants, etc.","triage.label":"Triage:","triage.useAuto":"Use auto","triage.green":"Green","triage.amber":"Amber","triage.red":"Red","triage.black":"Black","iceTitle":"Emergency Contacts (ICE)","iceHint":"Add up to 3 trusted contacts.","ice.title":"ICE — Emergency Contacts","ice.hint":"In Case of Emergency contacts. Add up to 3 people.","ice.addContact":"+ Add Emergency Contact","ice.contactName":"Contact Name","ice.contactNamePlaceholder":"Full name","ice.relationship":"Relationship","ice.relationshipPlaceholder":"Spouse, Parent, Sibling, etc.","ice.phone":"Phone Number","ice.phonePlaceholder":"Primary phone number","ice.altPhone":"Alternative Phone (Optional)","ice.altPhonePlaceholder":"Secondary phone number","emergency.title":"Your Emergency Card & QR Code","emergency.hint":"This QR code contains your emergency information. Print it or save it to your phone.","emergency.qrPlaceholder":"QR Code will appear here\nafter saving your profile","emergency.download":"Download QR Code","emergency.print":"Print Emergency Card","emergency.share":"Share QR Code","emergency.preview":"Preview Card","common.saveProfile":"Save Profile","common.saveHealth":"Save Health","common.saveIce":"Save ICE Contacts","common.remove":"Remove","toast.profileSaved":"Profile saved successfully","toast.healthSaved":"Health information saved","toast.iceSaved":"Emergency contacts saved","toast.autoSaved":"Changes saved automatically","toast.offlineMode":"Working offline - changes saved locally","toast.backOnline":"Back online - syncing changes","delete.title":"Delete Account","delete.warning":"This action cannot be undone. All your data will be permanently deleted.","delete.confirmLabel":"Type \"DELETE MY ACCOUNT\" to confirm:","delete.confirmPlaceholder":"DELETE MY ACCOUNT","delete.confirmHint":"This phrase must match exactly","delete.button":"Delete My Account","disclaimer.medical":"Informational only. Clinicians must confirm with official medical documents.","disclaimer.privacy":"Data stays on your device unless you choose to share.","footer.privacy":"Privacy Policy","footer.terms":"Terms of Service","footer.copyright":"© 2024 MYQER™. All rights reserved."
    },
    es: {
      "loading.dashboard":"Cargando tu panel…","error.title":"Algo salió mal","error.retry":"Intentar de nuevo","logo.hint":"pronunciado \"my care\"","header.logout":"Cerrar sesión","status.online":"En línea","status.offline":"Sin conexión","offline.message":"Estás sin conexión — el QR sigue funcionando con datos guardados.","identity.title":"Identidad — Información Personal","identity.hint":"Estos detalles ayudan a los socorristas a confirmar quién eres.","identity.fullName":"Nombre Completo","identity.fullNamePlaceholder":"Ingresa tu nombre legal completo","identity.dob":"Fecha de Nacimiento","identity.dobHint":"Formato: AAAA-MM-DD","identity.country":"País","identity.selectCountry":"Selecciona tu país","identity.healthId":"ID Nacional/de Salud (Opcional)","identity.healthIdPlaceholder":"ej., número NHS, SSN, etc.","identity.healthIdHint":"Solo visible para profesionales médicos","critical.title":"CRÍTICO — Detalles Médicos y de Salud","critical.hint":"Mantén esto actualizado. Aparece en tu tarjeta de emergencia.","critical.bloodType":"Tipo de Sangre","critical.selectBloodType":"Seleccionar tipo de sangre","critical.unknown":"Desconocido","critical.allergies":"Alergias Críticas","critical.allergiesPlaceholder":"Lista cualquier alergia mortal (medicamentos, alimentos, etc.)","critical.organDonor":"Soy donante de órganos","critical.conditions":"Condiciones Médicas","critical.conditionsPlaceholder":"Diabetes, enfermedad cardíaca, epilepsia, etc.","critical.medications":"Medicamentos Actuales","critical.medicationsPlaceholder":"Lista todos los medicamentos actuales y dosis","critical.implants":"Implantes/Dispositivos Médicos","critical.implantsPlaceholder":"Marcapasos, bomba de insulina, implantes metálicos, etc.","triage.label":"Triaje:","triage.useAuto":"Usar automático","triage.green":"Verde","triage.amber":"Ámbar","triage.red":"Rojo","triage.black":"Negro","iceTitle":"Contactos de Emergencia (ICE)","iceHint":"Agrega hasta 3 contactos de confianza.","delete.title":"Eliminar Cuenta","delete.warning":"Esta acción no se puede deshacer. Todos tus datos serán eliminados permanentemente.","delete.confirmLabel":"Escribe \"DELETE MY ACCOUNT\" para confirmar:","delete.confirmPlaceholder":"DELETE MY ACCOUNT","delete.confirmHint":"Esta frase debe coincidir exactamente","delete.button":"Eliminar Mi Cuenta","disclaimer.medical":"Solo informativo. Los médicos deben confirmar con documentos médicos oficiales.","disclaimer.privacy":"Los datos permanecen en tu dispositivo a menos que elijas compartirlos.","footer.privacy":"Política de Privacidad","footer.terms":"Términos de Servicio","footer.copyright":"© 2024 MYQER™. Todos los derechos reservados."
    },
    fr: {
      "loading.dashboard":"Chargement de votre tableau de bord…","error.title":"Quelque chose s'est mal passé","error.retry":"Réessayer","logo.hint":"prononcé \"my care\"","header.logout":"Déconnexion","status.online":"En ligne","status.offline":"Hors ligne","offline.message":"Vous êtes hors ligne — le QR fonctionne toujours avec les données mises en cache.","identity.title":"Identité — Informations Personnelles","identity.hint":"Ces détails aident les secours à confirmer qui vous êtes.","identity.fullName":"Nom Complet","identity.fullNamePlaceholder":"Entrez votre nom légal complet","identity.dob":"Date de Naissance","identity.dobHint":"Format: AAAA-MM-JJ","identity.country":"Pays","identity.selectCountry":"Sélectionnez votre pays","identity.healthId":"ID National/Santé (Optionnel)","identity.healthIdPlaceholder":"ex., numéro NHS, SSN, etc.","identity.healthIdHint":"Visible uniquement aux professionnels médicaux","critical.title":"CRITIQUE — Détails Médicaux et de Santé","critical.hint":"Gardez ceci à jour. Cela apparaît sur votre carte d'urgence.","critical.bloodType":"Groupe Sanguin","critical.selectBloodType":"Sélectionner le groupe sanguin","critical.unknown":"Inconnu","critical.allergies":"Allergies Critiques","critical.allergiesPlaceholder":"Listez toute allergie mortelle (médicaments, aliments, etc.)","critical.organDonor":"Je suis donneur d'organes","critical.conditions":"Conditions Médicales","critical.conditionsPlaceholder":"Diabète, maladie cardiaque, épilepsie, etc.","critical.medications":"Médicaments Actuels","critical.medicationsPlaceholder":"Listez tous les médicaments actuels et dosages","critical.implants":"Implants/Dispositifs Médicaux","critical.implantsPlaceholder":"Stimulateur cardiaque, pompe à insuline, implants métalliques, etc.","triage.label":"Triage:","triage.useAuto":"Utiliser auto","triage.green":"Vert","triage.amber":"Ambre","triage.red":"Rouge","triage.black":"Noir","ice.title":"ICE — Contacts d'Urgence","ice.hint":"Contacts En Cas d'Urgence. Ajoutez jusqu'à 3 personnes.","ice.addContact":"+ Ajouter Contact d'Urgence","ice.contactName":"Nom du Contact","ice.contactNamePlaceholder":"Nom complet","ice.relationship":"Relation","ice.relationshipPlaceholder":"Époux, Parent, Frère/Sœur, etc.","ice.phone":"Numéro de Téléphone","ice.phonePlaceholder":"Numéro de téléphone principal","ice.altPhone":"Téléphone Alternatif (Optionnel)","ice.altPhonePlaceholder":"Numéro de téléphone secondaire","emergency.title":"Votre Carte d'Urgence et Code QR","emergency.hint":"Ce code QR contient vos informations d'urgence. Imprimez-le ou sauvegardez-le sur votre téléphone.","emergency.qrPlaceholder":"Le code QR apparaîtra ici\naprès avoir sauvegardé votre profil","emergency.download":"Télécharger le Code QR","emergency.print":"Imprimer la Carte d'Urgence","emergency.share":"Partager le Code QR","emergency.preview":"Aperçu de la Carte","common.saveProfile":"Sauvegarder le Profil","common.saveHealth":"Sauvegarder la Santé","common.saveIce":"Sauvegarder les Contacts ICE","common.remove":"Supprimer","toast.profileSaved":"Profil sauvegardé avec succès","toast.healthSaved":"Informations de santé sauvegardées","toast.iceSaved":"Contacts d'urgence sauvegardés","toast.autoSaved":"Changements sauvegardés automatiquement","toast.offlineMode":"Travail hors ligne - changements sauvegardés localement","toast.backOnline":"De retour en ligne - synchronisation des changements","iceTitle":"Contacts d'Urgence (ICE)","iceHint":"Ajoutez jusqu'à 3 contacts de confiance.","delete.title":"Supprimer le Compte","delete.warning":"Cette action ne peut pas être annulée. Toutes vos données seront définitivement supprimées.","delete.confirmLabel":"Tapez \"DELETE MY ACCOUNT\" pour confirmer:","delete.confirmPlaceholder":"DELETE MY ACCOUNT","delete.confirmHint":"Cette phrase doit correspondre exactement","delete.button":"Supprimer Mon Compte","disclaimer.medical":"À titre informatif seulement. Les cliniciens doivent confirmer avec les documents médicaux officiels.","disclaimer.privacy":"Les données restent sur votre appareil sauf si vous choisissez de les partager.","footer.privacy":"Politique de Confidentialité","footer.terms":"Conditions d'Utilisation","footer.copyright":"© 2024 MYQER™. Tous droits réservés."
    },
    de: {
      "loading.dashboard":"Dashboard wird geladen…","error.title":"Etwas ist schiefgelaufen","error.retry":"Erneut versuchen","logo.hint":"ausgesprochen \"my care\"","header.logout":"Abmelden","status.online":"Online","status.offline":"Offline","offline.message":"Sie sind offline — QR funktioniert weiterhin mit zwischengespeicherten Daten.","identity.title":"Identität — Persönliche Informationen","identity.hint":"Diese Details helfen Rettungskräften, Ihre Identität zu bestätigen.","identity.fullName":"Vollständiger Name","identity.fullNamePlaceholder":"Geben Sie Ihren vollständigen rechtlichen Namen ein","identity.dob":"Geburtsdatum","identity.dobHint":"Format: JJJJ-MM-TT","identity.country":"Land","identity.selectCountry":"Wählen Sie Ihr Land","identity.healthId":"Nationale/Gesundheits-ID (Optional)","identity.healthIdPlaceholder":"z.B. NHS-Nummer, SSN, etc.","identity.healthIdHint":"Nur für medizinisches Fachpersonal sichtbar","critical.title":"KRITISCH — Medizinische & Gesundheitsdetails","critical.hint":"Halten Sie dies aktuell. Es erscheint auf Ihrer Notfallkarte.","critical.bloodType":"Blutgruppe","critical.selectBloodType":"Blutgruppe auswählen","critical.unknown":"Unbekannt","critical.allergies":"Kritische Allergien","critical.allergiesPlaceholder":"Listen Sie lebensbedrohliche Allergien auf (Medikamente, Lebensmittel, etc.)","critical.organDonor":"Ich bin Organspender","critical.conditions":"Medizinische Bedingungen","critical.conditionsPlaceholder":"Diabetes, Herzkrankheit, Epilepsie, etc.","critical.medications":"Aktuelle Medikamente","critical.medicationsPlaceholder":"Listen Sie alle aktuellen Medikamente und Dosierungen auf","critical.implants":"Implantate/Medizinische Geräte","critical.implantsPlaceholder":"Herzschrittmacher, Insulinpumpe, Metallimplantate, etc.","triage.label":"Triage:","triage.useAuto":"Auto verwenden","triage.green":"Grün","triage.amber":"Gelb","triage.red":"Rot","triage.black":"Schwarz","iceTitle":"Notfallkontakte (ICE)","iceHint":"Fügen Sie bis zu 3 vertrauenswürdige Kontakte hinzu.","ice.title":"ICE — Notfallkontakte","ice.hint":"Im Notfall Kontakte. Fügen Sie bis zu 3 Personen hinzu.","ice.addContact":"+ Notfallkontakt hinzufügen","ice.contactName":"Kontaktname","ice.contactNamePlaceholder":"Vollständiger Name","ice.relationship":"Beziehung","ice.relationshipPlaceholder":"Ehepartner, Elternteil, Geschwister, etc.","ice.phone":"Telefonnummer","ice.phonePlaceholder":"Primäre Telefonnummer","ice.altPhone":"Alternative Telefonnummer (Optional)","ice.altPhonePlaceholder":"Sekundäre Telefonnummer","emergency.title":"Ihre Notfallkarte & QR-Code","emergency.hint":"Dieser QR-Code enthält Ihre Notfallinformationen. Drucken Sie ihn aus oder speichern Sie ihn auf Ihrem Telefon.","emergency.qrPlaceholder":"QR-Code wird hier angezeigt\nnach dem Speichern Ihres Profils","emergency.download":"QR-Code herunterladen","emergency.print":"Notfallkarte drucken","emergency.share":"QR-Code teilen","emergency.preview":"Karte vorschau","common.saveProfile":"Profil speichern","common.saveHealth":"Gesundheit speichern","common.saveIce":"ICE-Kontakte speichern","common.remove":"Entfernen","toast.profileSaved":"Profil erfolgreich gespeichert","toast.healthSaved":"Gesundheitsinformationen gespeichert","toast.iceSaved":"Notfallkontakte gespeichert","toast.autoSaved":"Änderungen automatisch gespeichert","toast.offlineMode":"Offline arbeiten - Änderungen lokal gespeichert","toast.backOnline":"Wieder online - Änderungen synchronisieren","delete.title":"Konto löschen","delete.warning":"Diese Aktion kann nicht rückgängig gemacht werden. Alle Ihre Daten werden dauerhaft gelöscht.","delete.confirmLabel":"Geben Sie \"DELETE MY ACCOUNT\" zur Bestätigung ein:","delete.confirmPlaceholder":"DELETE MY ACCOUNT","delete.confirmHint":"Diese Phrase muss genau übereinstimmen","delete.button":"Mein Konto löschen","disclaimer.medical":"Nur zur Information. Kliniker müssen mit offiziellen medizinischen Dokumenten bestätigen.","disclaimer.privacy":"Daten bleiben auf Ihrem Gerät, es sei denn, Sie wählen das Teilen.","footer.privacy":"Datenschutzrichtlinie","footer.terms":"Nutzungsbedingungen","footer.copyright":"© 2024 MYQER™. Alle Rechte vorbehalten."
    }
  };

  const t = (key) => LOCALES[currentLang]?.[key] || LOCALES.en[key] || key;

  const updateTranslations = () => {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      el.textContent = t(key);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
      const key = el.getAttribute('data-i18n-placeholder');
      el.placeholder = t(key);
    });
    document.querySelectorAll('.ribbon').forEach(ribbon => {
      if (ribbon.textContent === 'Identity') ribbon.textContent = t('identity.title').split(' — ')[0];
      if (ribbon.textContent === 'Critical') ribbon.textContent = t('critical.title').split(' — ')[0];
      if (ribbon.textContent === 'ICE') ribbon.textContent = 'ICE';
      if (ribbon.textContent === 'Emergency') ribbon.textContent = t('emergency.title').split(' ')[0];
    });
  };

  const updateLanguage = (lang) => {
    currentLang = lang;
    document.documentElement.setAttribute('lang', lang);
    document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
    updateTranslations();
    const langMap = { en:'EN',es:'ES',fr:'FR',de:'DE',it:'IT',pt:'PT',ro:'RO',ar:'AR',hi:'HI',zh:'ZH' };
    document.getElementById('langSelector').textContent = langMap[lang] || 'EN';
    console.log(`🌐 Language updated to: ${lang.toUpperCase()}`);
  };
     // =========================
// UI helpers (safe guards)
// =========================
const showToast = (message, type = 'success', duration = 4000) => {
  let toastArea = document.getElementById('toastArea');
  if (!toastArea) {
    toastArea = document.createElement('div');
    toastArea.id = 'toastArea';
    toastArea.setAttribute('aria-live', 'polite');
    document.body.appendChild(toastArea);
  }
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  toastArea.appendChild(toast);

  setTimeout(() => toast.classList.add('show'), 50);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toastArea.contains(toast) && toast.remove(), 300);
  }, duration);
};

const updateNetworkStatus = () => {
  const netStatus = document.getElementById('netStatus');
  const offlineBanner = document.getElementById('offlineBanner');

  if (navigator.onLine) {
    if (netStatus) { netStatus.textContent = t('status.online'); netStatus.className = 'online'; }
    if (offlineBanner) offlineBanner.style.display = 'none';
    if (!isOnline) { showToast(t('toast.backOnline'), 'success'); isOnline = true; }
  } else {
    if (netStatus) { netStatus.textContent = t('status.offline'); netStatus.className = 'offline'; }
    if (offlineBanner) offlineBanner.style.display = 'block';
    if (isOnline) { showToast(t('toast.offlineMode'), 'info'); isOnline = false; }
  }
};

const setupAutoSave = (fieldId, saveFunction) => {
  const field = document.getElementById(fieldId);
  if (!field) return;
  field.addEventListener('input', () => {
    if (autoSaveTimeouts[fieldId]) clearTimeout(autoSaveTimeouts[fieldId]);
    autoSaveTimeouts[fieldId] = setTimeout(async () => {
      try {
        await saveFunction();
        showFieldSaved(fieldId);
        showToast(t?.('toast.autoSaved') || 'Changes saved automatically', 'success', 2000);
      } catch (error) {
        console.error('Auto-save error:', error);
        showToast('Auto-save failed', 'error');
      }
    }, 500);
  });
};

const showFieldSaved = (fieldId) => {
  const field = document.getElementById(fieldId);
  if (!field) return;
  field.classList.add('field-saved', 'show-check');
  setTimeout(() => field.classList.remove('show-check'), 2000);
};

// Make sure these are wired once somewhere after DOMContentLoaded:
window.addEventListener('online',  updateNetworkStatus);
window.addEventListener('offline', updateNetworkStatus);

  // =========================
// ICE Contacts
// =========================
const renderIceContacts = () => {
  const container = document.getElementById('iceContactsList');
  if (!container) return;

  container.innerHTML = '';

  if (!Array.isArray(iceContacts)) {
    console.warn('⚠️ iceContacts is not an array');
    return;
  }

  iceContacts.forEach((contact, index) => {
    const contactDiv = document.createElement('div');
    contactDiv.className = 'ice-row';
    contactDiv.setAttribute('data-index', index);

    contactDiv.innerHTML = `
      <div class="ice-contact-header">
        <div class="contact-number">#${index + 1}</div>
        <div class="ice-actions">
          <button class="iceSaveBtn" onclick="saveIndividualIceContact(${index})">Save</button>
          <button class="iceDeleteBtn" onclick="removeIceContact(${index})" aria-label="Delete contact">✖</button>
        </div>
      </div>
      <div class="ice-form-grid">
        <div class="form-group">
          <label>Name</label>
          <input type="text" class="iceName" 
            value="${contact.name || ''}" 
            onchange="updateIceContact(${index}, 'name', this.value)" 
            placeholder="Name">
        </div>
        <div class="form-group">
          <label>Relationship</label>
          <input type="text" class="iceRelation" 
            value="${contact.relationship || ''}" 
            onchange="updateIceContact(${index}, 'relationship', this.value)" 
            placeholder="Spouse, Parent, Friend">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" class="icePhone" 
            value="${contact.phone || ''}" 
            onchange="updateIceContact(${index}, 'phone', this.value)" 
            placeholder="+1 (555) 123-4567">
        </div>
      </div>
    `;

    container.appendChild(contactDiv);
  });

  // Control add button (max 3 contacts)
  const addButton = document.getElementById('addIce');
  if (addButton) {
    if (iceContacts.length >= 3) {
      addButton.disabled = true;
      addButton.textContent = 'Maximum 3 contacts reached';
    } else {
      addButton.disabled = false;
      addButton.textContent = 'Add Emergency Contact';
    }
  }
};

 // Add a blank ICE row (max 3)
const addIceContact = () => {
  if (!Array.isArray(iceContacts)) iceContacts = [];
  if (iceContacts.length >= 3) {
    showToast('Maximum 3 emergency contacts allowed', 'error');
    return;
  }
  iceContacts.push({ name: '', relationship: '', phone: '' });
  localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
  renderIceContacts();
};

// Save ONE ICE contact (actually rewrites all rows server-side to keep order)
const saveIndividualIceContact = async (index) => {
  try {
    const contact = iceContacts[index];
    if (!contact || !contact.name || !contact.phone) {
      showToast('Name and phone are required', 'error');
      return;
    }

    // persist local first
    localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));

    // best-effort server sync
    if (isSupabaseAvailable && isOnline) {
      const userId = await getUserId();
      if (!userId) throw new Error('No authenticated user');

      // Rewrite the set to preserve order
      await supabase.from('ice_contacts').delete().eq('user_id', userId);

      const rows = iceContacts.map((c, i) => ({
        user_id: userId,
        contact_order: i,
        name: c.name || '',
        relationship: c.relationship || '',
        phone: c.phone || ''
      }));

      const { error } = await supabase.from('ice_contacts').insert(rows);
      if (error) throw error;
    }

    showToast('Emergency contacts saved', 'success');
  } catch (error) {
    console.error('Save ICE contact error:', error);
    showToast('Error saving contact', 'error');
  }
};

// Remove one ICE contact and keep everything in sync
const removeIceContact = async (index) => {
  if (!Array.isArray(iceContacts)) return;
  iceContacts.splice(index, 1);
  localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
  renderIceContacts();

  // best-effort server sync
  try {
    if (isSupabaseAvailable && isOnline) {
      const userId = await getUserId();
      if (!userId) return;

      await supabase.from('ice_contacts').delete().eq('user_id', userId);

      if (iceContacts.length) {
        const rows = iceContacts.map((c, i) => ({
          user_id: userId,
          contact_order: i,
          name: c.name || '',
          relationship: c.relationship || '',
          phone: c.phone || ''
        }));
        const { error } = await supabase.from('ice_contacts').insert(rows);
        if (error) throw error;
      }
    }
  } catch (err) {
    console.warn('Remove ICE sync error:', err);
  }
};

// Update in-memory field (lightweight) and persist locally
const updateIceContact = (index, field, value) => {
  if (!Array.isArray(iceContacts) || !iceContacts[index]) return;
  iceContacts[index][field] = value;
  localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
};
// =========================
// Triage
// =========================
const calculateTriage = () => {
  const overrideSel = document.getElementById('triageOverride');
  const override = overrideSel ? overrideSel.value : 'auto';
  if (override !== 'auto') return updateTriagePill(override);

  // normalize helper
  const norm = (s) => (s || '').toString().toLowerCase().trim().replace(/\s+/g, ' ');

  let score = 0;
  const allergies  = norm(document.getElementById('hfAllergies')?.value);
  const conditions = norm(document.getElementById('hfConditions')?.value);
  const meds       = norm(document.getElementById('hfMeds')?.value);

  if (allergies.includes('anaphylaxis') || allergies.includes('severe')) score += 3;
  if (conditions.includes('heart') || conditions.includes('cardiac'))     score += 2;
  if (conditions.includes('diabetes') && meds.includes('insulin'))        score += 2;
  if (conditions.includes('epilepsy') || conditions.includes('seizure'))  score += 2;
  if (meds.includes('warfarin') || meds.includes('blood thinner'))        score += 1;

  let level = 'green';
  if (score >= 5) level = 'red';
  else if (score >= 3) level = 'amber';
  updateTriagePill(level);
};

const TRIAGE_CLASSES = ['green','amber','red','black'];
const updateTriagePill = (level) => {
  const pill = document.getElementById('triagePill');
  if (!pill) return;
  // remove old color classes, then add the new one
  TRIAGE_CLASSES.forEach(c => pill.classList.remove(c));
  pill.classList.add(level);
  pill.textContent = (level || 'GREEN').toUpperCase();
};

// =========================
// Save: Profile + Health
// =========================
const saveProfile = async () => {
  const profileData = {
    fullName: document.getElementById('profileFullName')?.value || '',
    dob:      document.getElementById('profileDob')?.value || '',
    country:  document.getElementById('profileCountry')?.value || '',
    healthId: document.getElementById('profileHealthId')?.value || ''
  };

  // light validation
  const dobOK = !profileData.dob || /^\d{4}-\d{2}-\d{2}$/.test(profileData.dob);
  if (!dobOK) {
    showToast('Please use YYYY-MM-DD for Date of Birth', 'error');
    return;
  }
  if (!profileData.fullName) {
    showToast('Full name is required', 'error');
    return;
  }

  try {
    // local-first
    localStorage.setItem('myqer_profile', JSON.stringify(profileData));
    userData.profile = profileData;

    // best-effort server sync
    if (isSupabaseAvailable && isOnline) {
      const userId = await getUserId();
      if (!userId) throw new Error('No authenticated user');

      const code = await ensureShortCode(); // XXX-XXXX-XXX
      const row  = { user_id: userId, code, ...profileData };

      const { error } = await supabase
        .from('profiles')
        .upsert(row, { onConflict: 'user_id' });

      if (error) throw error;
    }

    showToast(t('toast.profileSaved'), 'success');
    const msg = document.getElementById('profileMsg');
    if (msg) {
      msg.textContent = '✓ ' + t('toast.profileSaved');
      msg.className = 'status-msg success';
      msg.style.display = 'block';
    }

    try { await generateQRCode(); } catch (_) { /* non-fatal */ }
  } catch (error) {
    console.error('Save profile error:', error);
    showToast('Error saving profile: ' + error.message, 'error');
  }
};

const saveHealth = async () => {
  const healthData = {
    bloodType:      document.getElementById('hfBloodType')?.value || '',
    allergies:      document.getElementById('hfAllergies')?.value || '',
    organDonor:     !!document.getElementById('hfDonor')?.checked,
    conditions:     document.getElementById('hfConditions')?.value || '',
    medications:    document.getElementById('hfMeds')?.value || '',
    implants:       document.getElementById('hfImplants')?.value || '',
    triageOverride: document.getElementById('triageOverride')?.value || 'auto'
  };

  try {
    localStorage.setItem('myqer_health', JSON.stringify(healthData));
    userData.health = healthData;

    if (isSupabaseAvailable && isOnline) {
      const userId = await getUserId();
      if (!userId) throw new Error('No authenticated user');

      const row = { user_id: userId, ...healthData };
      const { error } = await supabase.from('health_data').upsert(row, { onConflict: 'user_id' });
      if (error) throw error;
    }

    calculateTriage();

    showToast(t('toast.healthSaved'), 'success');
    const msg = document.getElementById('healthMsg');
    if (msg) {
      msg.textContent = '✓ ' + t('toast.healthSaved');
      msg.className = 'status-msg success';
      msg.style.display = 'block';
    }

    try { await generateQRCode(); } catch (_) { /* non-fatal */ }
  } catch (error) {
    console.error('Save health error:', error);
    showToast('Error saving health data: ' + error.message, 'error');
  }
};
const saveIce = async () => {
  try {
    // Normalize + keep only non-empty rows
    const cleaned = (iceContacts || []).map(c => ({
      name: (c?.name || '').trim(),
      relationship: (c?.relationship || '').trim(),
      phone: (c?.phone || '').trim()
    }));
    const entries = cleaned.filter(c => c.name || c.phone);

    // Rules
    if (entries.length > 3) {
      showToast('Maximum 3 emergency contacts allowed', 'error');
      return;
    }
    const invalid = entries.find(c => !(c.name && c.phone));
    if (invalid) {
      showToast('Each contact needs a name and phone', 'error');
      return;
    }

    // Commit to in-memory + local
    iceContacts = entries;
    localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
    userData.ice = iceContacts;

    // Best-effort server sync
    if (isSupabaseAvailable && isOnline) {
      const userId = await getUserId();
      if (!userId) throw new Error('No authenticated user');

      // Replace user's rows atomically
      await supabase.from('ice_contacts').delete().eq('user_id', userId);

      if (iceContacts.length) {
        const rows = iceContacts.map((c, i) => ({
          user_id: userId,
          contact_order: i,
          name: c.name,
          relationship: c.relationship || null,
          phone: c.phone
        }));
        const { error } = await supabase.from('ice_contacts').insert(rows);
        if (error) throw error;
      }
    }

    // UI feedback
    renderIceContacts?.();
    showToast(t('toast.iceSaved'), 'success');
    const msg = document.getElementById('iceMsg');
    if (msg) {
      msg.textContent = '✓ ' + t('toast.iceSaved');
      msg.className = 'status-msg success';
      msg.style.display = 'block';
    }

    try { await generateQRCode?.(); } catch { /* non-fatal */ }
  } catch (error) {
    console.error('Save ICE error:', error);
    showToast('Error saving emergency contacts: ' + (error.message || error), 'error');
  }
};
  // =========================
// Data load (local-first, non-blocking server sync)
// =========================
const loadUserData = async () => {
  const hideSpinner = () => {
    const loading = document.getElementById('loadingState');
    if (loading) loading.style.display = 'none';
  };

  const fillFromLocal = () => {
    try {
      // PROFILE
      const lp = localStorage.getItem('myqer_profile');
      if (lp) {
        userData.profile = JSON.parse(lp) || {};
        const pf = userData.profile;
        const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
        set('profileFullName', pf.fullName);
        set('profileDob', pf.dob);
        set('profileCountry', pf.country);
        set('profileHealthId', pf.healthId);
      }

      // HEALTH
      const lh = localStorage.getItem('myqer_health');
      if (lh) {
        userData.health = JSON.parse(lh) || {};
        const hd = userData.health;
        const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
        set('hfBloodType', hd.bloodType);
        set('hfAllergies', hd.allergies);
        set('hfConditions', hd.conditions);
        set('hfMeds', hd.medications);
        set('hfImplants', hd.implants);
        const donor = document.getElementById('hfDonor');
        if (donor) donor.checked = !!hd.organDonor;
        const triSel = document.getElementById('triageOverride');
        if (triSel) triSel.value = hd.triageOverride || 'auto';
        calculateTriage();
      }

      // ICE
      const li = localStorage.getItem('myqer_ice');
      if (li) {
        iceContacts = JSON.parse(li) || [];
        renderIceContacts?.();
      }

      // Kick QR (non-fatal if it fails)
      try { generateQRCode?.(); } catch {}
    } catch (e) {
      console.warn('Local load failed:', e);
    }
  };

  // Always populate UI from local first
  fillFromLocal();

  // If we can’t/shouldn’t hit Supabase, stop here
  if (!isSupabaseAvailable || !isOnline) {
    console.log('ℹ️ Working local-only (no Supabase / offline).');
    hideSpinner();
    return;
  }

  // Helper: promise timeout to avoid infinite spinner
  const withTimeout = (p, ms, label) =>
    Promise.race([
      p,
      new Promise((_, rej) => setTimeout(() => rej(new Error(`${label} timed out`)), ms))
    ]);

  try {
    // Ensure session
    const { data: { session } } = await withTimeout(
      supabase.auth.getSession(), 3000, 'getSession'
    );
    if (!session) {
      // Show a friendly message instead of spinning forever
      const box = document.getElementById('errorBox');
      const msg = document.getElementById('errorMsg');
      if (msg) msg.textContent = 'Please sign in first, then return to the dashboard.';
      if (box) box.style.display = 'block';
      return;
    }

    // Get user id
    const userId = await withTimeout(getUserId(), 3000, 'getUserId');
    if (!userId) throw new Error('No authenticated user');

    // PROFILE
    const { data: serverProfile } = await withTimeout(
      supabase.from('profiles').select('*').eq('user_id', userId).maybeSingle(),
      4000, 'profiles.select'
    ).catch(() => ({ data: null }));

    if (serverProfile) {
      userData.profile = { ...(userData.profile || {}), ...serverProfile };
      localStorage.setItem('myqer_profile', JSON.stringify(userData.profile));
      const pf = userData.profile;
      const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
      set('profileFullName', pf.fullName);
      set('profileDob', pf.dob);
      set('profileCountry', pf.country);
      set('profileHealthId', pf.healthId);
    }

    // HEALTH
    const { data: serverHealth } = await withTimeout(
      supabase.from('health_data').select('*').eq('user_id', userId).maybeSingle(),
      4000, 'health_data.select'
    ).catch(() => ({ data: null }));

    if (serverHealth) {
      userData.health = { ...(userData.health || {}), ...serverHealth };
      localStorage.setItem('myqer_health', JSON.stringify(userData.health));
      const hd = userData.health;
      const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
      set('hfBloodType', hd.bloodType);
      set('hfAllergies', hd.allergies);
      set('hfConditions', hd.conditions);
      set('hfMeds', hd.medications);
      set('hfImplants', hd.implants);
      const donor = document.getElementById('hfDonor');
      if (donor) donor.checked = !!hd.organDonor;
      const triSel = document.getElementById('triageOverride');
      if (triSel) triSel.value = hd.triageOverride || 'auto';
      calculateTriage();
    }

    // ICE
    const { data: serverIce } = await withTimeout(
      supabase.from('ice_contacts')
        .select('*')
        .eq('user_id', userId)
        .order('contact_order', { ascending: true }),
      4000, 'ice_contacts.select'
    ).catch(() => ({ data: [] }));

    if (serverIce && serverIce.length) {
      iceContacts = serverIce.map(r => ({
        name: r.name || '',
        relationship: r.relationship || '',
        phone: r.phone || ''
      }));
      localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
      renderIceContacts?.();
    }

    // QR refresh (non-blocking)
    try { await generateQRCode?.(); } catch {}

    console.log('✅ User data loaded (local-first, server-synced).');
  } catch (err) {
    console.warn('⚠️ Non-fatal load error:', err);
  } finally {
    hideSpinner();
  }
};

    // Small helper: timeout wrapper to avoid spins
    const withTimeout = (p, ms, label) =>
      Promise.race([ p, new Promise((_, rej) => setTimeout(() => rej(new Error(`${label} timed out`)), ms)) ]);

    try {
      const { data: { session } } = await withTimeout(supabase.auth.getSession(), 3000, 'getSession');
      if (!session) {
        console.log('❌ No Supabase session; showing sign-in note.');
        const box = document.getElementById('errorBox');
        const msg = document.getElementById('errorMsg');
        if (msg) msg.textContent = 'Please sign in first, then return to the dashboard.';
        if (box) box.style.display = 'block';
        hideSpinner();
        return;
      }

      const userId = await withTimeout(getUserId(), 3000, 'getUserId');
      if (userId) {
        const { data: serverProfile } = await withTimeout(
          supabase.from('profiles').select('*').eq('user_id', userId).maybeSingle(),
          4000, 'profiles'
        ).catch(() => ({ data: null }));
        if (serverProfile) {
          userData.profile = { ...userData.profile, ...serverProfile };
          localStorage.setItem('myqer_profile', JSON.stringify(userData.profile));
          const pf = userData.profile || {};
          const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || '' };
          set('profileFullName', pf.fullName);
          set('profileDob', pf.dob);
          set('profileCountry', pf.country);
          set('profileHealthId', pf.healthId);
        }

        const { data: serverHealth } = await withTimeout(
          supabase.from('health_data').select('*').eq('user_id', userId).maybeSingle(),
          4000, 'health_data'
        ).catch(() => ({ data: null }));
        if (serverHealth) {
          userData.health = { ...userData.health, ...serverHealth };
          localStorage.setItem('myqer_health', JSON.stringify(userData.health));
          const hd = userData.health || {};
          const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || '' };
          set('hfBloodType', hd.bloodType);
          set('hfAllergies', hd.allergies);
          set('hfConditions', hd.conditions);
          set('hfMeds', hd.medications);
          set('hfImplants', hd.implants);
          const donor = document.getElementById('hfDonor');
          if (donor) donor.checked = !!hd.organDonor;
          const triSel = document.getElementById('triageOverride');
          if (triSel) triSel.value = hd.triageOverride || 'auto';
          calculateTriage();
        }

        const { data: serverIce } = await withTimeout(
          supabase.from('ice_contacts').select('*').eq('user_id', userId).order('contact_order', { ascending: true }),
          4000, 'ice_contacts'
        ).catch(() => ({ data: [] }));
        if (serverIce && serverIce.length) {
          iceContacts = serverIce.map(r => ({ name: r.name || '', relationship: r.relationship || '', phone: r.phone || '' }));
          localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
          renderIceContacts();
        }
      }

      console.log('✅ User data loaded (local first, server synced).');
    } catch (err) {
      console.warn('⚠️ Non-fatal load error:', err);
    } finally {
      hideSpinner();
    }
  };

  // =========================
  // Event listeners / init
  // =========================
  document.addEventListener('DOMContentLoaded', async () => {
    updateLanguage('en');
    updateNetworkStatus();

    await loadUserData();

    // Smooth loading transition
    setTimeout(() => {
      const loadingState = document.getElementById('loadingState');
      loadingState.style.opacity = '0';
      loadingState.style.transition = 'opacity 0.5s ease';
      setTimeout(() => {
        loadingState.style.display = 'none';
        document.body.style.opacity = '0';
        document.body.style.transition = 'opacity 0.5s ease';
        setTimeout(() => { document.body.style.opacity = '1'; }, 100);
      }, 500);
    }, 800);

    // Language selector
    const langSelector = document.getElementById('langSelector');
    const langDropdown = document.getElementById('langDropdown');
    langSelector.addEventListener('click', () => {
      const isOpen = langDropdown.style.display === 'block';
      langDropdown.style.display = isOpen ? 'none' : 'block';
      langSelector.setAttribute('aria-expanded', (!isOpen).toString());
    });
    langDropdown.addEventListener('click', (e) => {
      if (e.target.dataset.lang) {
        updateLanguage(e.target.dataset.lang);
        langDropdown.style.display = 'none';
        langSelector.setAttribute('aria-expanded', 'false');
      }
    });
    document.addEventListener('click', (e) => {
      if (!langSelector.contains(e.target) && !langDropdown.contains(e.target)) {
        langDropdown.style.display = 'none';
        langSelector.setAttribute('aria-expanded', 'false');
      }
    });

    // Buttons
    document.getElementById('saveProfile').addEventListener('click', saveProfile);
    document.getElementById('saveHealth').addEventListener('click', saveHealth);
    document.getElementById('saveIce').addEventListener('click', saveIce);
    document.getElementById('addIce').addEventListener('click', addIceContact);
    document.getElementById('triageOverride').addEventListener('change', calculateTriage);

    // Auto-save fields
    setupAutoSave('profileFullName', saveProfile);
    setupAutoSave('profileDob', saveProfile);
    setupAutoSave('profileCountry', saveProfile);
    setupAutoSave('profileHealthId', saveProfile);
    setupAutoSave('hfBloodType', saveHealth);
    setupAutoSave('hfAllergies', saveHealth);
    setupAutoSave('hfConditions', saveHealth);
    setupAutoSave('hfMeds', saveHealth);
    setupAutoSave('hfImplants', saveHealth);

  // ===== QR actions (safe + print + SVG) =====
(function () {
  const $ = (id) => document.getElementById(id);

  // Copy link
  $('copyLink')?.addEventListener('click', async () => {
    const url = $('cardUrl')?.value?.trim();
    if (!url) return showToast('No link to copy', 'error');
    try {
      await navigator.clipboard.writeText(url);
      showToast('Link copied to clipboard', 'success');
    } catch {
      showToast('Failed to copy link', 'error');
    }
  });

  // Open link
  $('openLink')?.addEventListener('click', () => {
    const url = $('cardUrl')?.value?.trim();
    if (!url) return showToast('No link to open', 'error');
    window.open(url, '_blank', 'noopener');
  });

  // Download PNG
  $('dlPNG')?.addEventListener('click', () => {
    const canvas = $('qrCanvas');
    if (!canvas || canvas.style.display === 'none')
      return showToast('Generate QR code first', 'error');
    const link = document.createElement('a');
    link.download = 'myqer-emergency-qr.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    showToast('PNG downloaded', 'success');
  });

  // Download SVG (real)
  $('dlSVG')?.addEventListener('click', async () => {
    const url = $('cardUrl')?.value?.trim();
    if (!url) return showToast('Generate QR code first', 'error');
    try {
      // Ensure QRCode lib is present
      if (!(window.QRCode && typeof window.QRCode.toString === 'function')) {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";
        await new Promise((res, rej) => { s.onload = res; s.onerror = rej; document.head.appendChild(s); });
      }
      const svgText = await new Promise((resolve, reject) => {
        QRCode.toString(url, { type: 'svg', errorCorrectionLevel: 'H', margin: 1 }, (err, s) => err ? reject(err) : resolve(s));
      });
      const blob = new Blob([svgText], { type: 'image/svg+xml' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'myqer-emergency-qr.svg';
      link.click();
      setTimeout(() => URL.revokeObjectURL(link.href), 1000);
      showToast('SVG downloaded', 'success');
    } catch (e) {
      console.error(e);
      showToast('SVG download failed', 'error');
    }
  });

  // Print (uses current QR as image so it actually prints)
  $('printQR')?.addEventListener('click', () => {
    const canvas = $('qrCanvas');
    const shortCode = $('codeUnderQR')?.textContent?.trim();
    if (!canvas || canvas.style.display === 'none' || !shortCode)
      return showToast('Generate QR code first', 'error');

    const dataUrl = canvas.toDataURL('image/png');
    const w = window.open('', '_blank', 'noopener');
    if (!w) return showToast('Pop-up blocked. Allow pop-ups to print.', 'error');

    w.document.write(`
      <html>
        <head>
          <title>MYQER Emergency Card - ${shortCode}</title>
          <meta charset="utf-8">
          <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
            .code { font-weight: 700; letter-spacing: 0.06em; }
            img { width: 300px; height: 300px; image-rendering: pixelated; }
            @media print { @page { size: auto; margin: 12mm; } }
          </style>
        </head>
        <body>
          <h1>MYQER™ Emergency Card</h1>
          <p class="code">Code: ${shortCode}</p>
          <img id="qrImg" alt="QR Code" src="${dataUrl}">
          <p>Scan this QR code for emergency information</p>
          <p style="font-size: 0.8em; color: #666;">www.myqer.com</p>
          <script>
            window.onload = function(){ setTimeout(function(){ window.print(); }, 200); };
          <\/script>
        </body>
      </html>
    `);
    w.document.close();
  });

  // Copy offline text
  $('copyOffline')?.addEventListener('click', async () => {
    const txt = $('offlineText')?.value || '';
    if (!txt.trim()) return showToast('No offline text to copy', 'error');
    try {
      await navigator.clipboard.writeText(txt);
      showToast('Offline text copied', 'success');
    } catch {
      showToast('Failed to copy offline text', 'error');
    }
  });
// =========================
// Download offline text
// =========================
document.getElementById('dlOffline')?.addEventListener('click', () => {
  const txt = document.getElementById('offlineText')?.value || '';
  if (!txt.trim()) return showToast('No offline text to download', 'error');

  const blob = new Blob([txt], { type: 'text/plain' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'myqer-offline.txt';
  link.click();
  setTimeout(() => URL.revokeObjectURL(link.href), 1000);

  showToast('Offline text downloaded', 'success');
});

// =========================
// Delete account
// =========================
const deletePhrase = document.getElementById('deletePhrase');
const deleteBtn = document.getElementById('deleteBtn');

if (deletePhrase && deleteBtn) {
  deletePhrase.addEventListener('input', () => {
    const isMatch = deletePhrase.value.trim().toUpperCase() === 'DELETE MY ACCOUNT';
    deleteBtn.disabled = !isMatch;
    deleteBtn.style.background = isMatch ? '#DC2626' : 'var(--light-slate)';
    deleteBtn.style.cursor = isMatch ? 'pointer' : 'not-allowed';
  });

  deleteBtn.addEventListener('click', async () => {
    if (deletePhrase.value.trim().toUpperCase() !== 'DELETE MY ACCOUNT') {
      return showToast('Please type the confirmation phrase exactly', 'error');
    }
    if (!confirm('Are you absolutely sure you want to delete your account? This action cannot be undone and all your data will be permanently lost.')) {
      return;
    }

    try {
      if (isSupabaseAvailable && isOnline) {
        const userId = await getUserId();
        if (!userId) throw new Error('No authenticated user');

        await supabase.from('ice_contacts').delete().eq('user_id', userId);
        await supabase.from('health_data').delete().eq('user_id', userId);
        await supabase.from('profiles').delete().eq('user_id', userId);
      }

      localStorage.clear();
      sessionStorage.clear();
      showToast('Account deleted successfully. Redirecting...', 'success');
      setTimeout(() => { window.location.href = '/'; }, 2000);
    } catch (error) {
      console.error('Delete account error:', error);
      showToast('Error deleting account: ' + error.message, 'error');
    }
  });
}

    // Sign out
    document.getElementById('btnSignOut').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to logout?')) return;
      try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        localStorage.clear(); sessionStorage.clear();
        window.location.href = '/';
      } catch (err) {
        console.error('Logout error:', err);
        alert('Logout failed, please try again');
      }
    });

    console.log('🚀 MYQER Dashboard Initialized');
  });
  // =========================
  // Fatal error traps (no infinite spinner)
  // =========================
  window.addEventListener('error', (e) => {
    const loading = document.getElementById('loadingState');
    if (loading) loading.style.display = 'none';
    const box = document.getElementById('errorBox');
    const msg = document.getElementById('errorMsg');
    if (msg) msg.textContent = 'JavaScript error: ' + (e.message || 'Unknown error');
    if (box) box.style.display = 'block';
    console.error('Uncaught error:', e.error || e.message);
  });

  window.addEventListener('unhandledrejection', (e) => {
    const loading = document.getElementById('loadingState');
    if (loading) loading.style.display = 'none';
    const box = document.getElementById('errorBox');
    const msg = document.getElementById('errorMsg');
    if (msg) msg.textContent = 'Promise error: ' + (e.reason?.message || String(e.reason));
    if (box) box.style.display = 'block';
    console.error('Unhandled promise rejection:', e.reason);
  });

  // Network status listeners
  window.addEventListener('online', updateNetworkStatus);
  window.addEventListener('offline', updateNetworkStatus);

  // Expose some functions (used by inline handlers in ICE section)
  window.addIceContact = addIceContact;
  window.removeIceContact = removeIceContact;
  window.updateIceContact = updateIceContact;
  window.saveIndividualIceContact = saveIndividualIceContact;

  // ====== QR: permanent code + real QR rendering ======
  const CODE_CHARS = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // excludes O/0/I/1

  function makeShortCode_3_4_3() {
    const pick = n => Array.from({ length: n }, () =>
      CODE_CHARS[Math.floor(Math.random() * CODE_CHARS.length)]
    ).join('');
    return `${pick(3)}-${pick(4)}-${pick(3)}`;
  }

  function generateShortCode() {
    const valid = /^[A-HJ-NP-Z2-9]{3}-[A-HJ-NP-Z2-9]{4}-[A-HJ-NP-Z2-9]{3}$/;
    let code = localStorage.getItem('myqer_shortcode');
    if (!valid.test(code || '')) {
      code = makeShortCode_3_4_3();
      localStorage.setItem('myqer_shortcode', code);
    }
    return code;
  }

  async function ensureShortCode() {
    let code = localStorage.getItem('myqer_shortcode');
    if (!code) code = generateShortCode();

    if (isSupabaseAvailable && isOnline) {
      try {
        const userId = await getUserId();
        if (userId) {
          for (let attempt = 0; attempt < 5; attempt++) {
            const { error } = await supabase
              .from('profiles')
              .upsert({ user_id: userId, code }, { onConflict: 'user_id' });
            if (!error) break;

            const msg = `${error.message || ''} ${error.details || ''}`.toLowerCase();
            if (msg.includes('duplicate')) {
              code = makeShortCode_3_4_3();
              localStorage.setItem('myqer_shortcode', code);
              continue;
            }
            console.warn('profiles.code upsert error:', error);
            break;
          }
        }
      } catch (e) {
        console.warn('ensureShortCode() best-effort persist failed:', e);
      }
    }
    return code;
  }

  function buildOfflineText(shortUrl) {
    const pf = userData?.profile || {};
    const hd = userData?.health  || {};
    const donor = hd.organDonor ? 'Y' : 'N';

    const lines = [];
    const line1 = [
      pf.fullName ? `Name: ${pf.fullName}` : null,
      pf.dob ? `DOB: ${pf.dob}` : null,
      pf.country ? `C: ${pf.country}` : null
    ].filter(Boolean).join(' | ');
    if (line1) lines.push(line1);

    const line2 = [
      hd.bloodType ? `BT: ${hd.bloodType}` : null,
      hd.allergies ? `ALG: ${hd.allergies}` : null
    ].filter(Boolean).join(' | ');
    if (line2) lines.push(line2);

    const line3 = [
      hd.conditions ? `COND: ${hd.conditions}` : null,
      hd.medications ? `MED: ${hd.medications}` : null,
      hd.implants ? `IMP: ${hd.implants}` : null,
      `DONOR:${donor}`
    ].filter(Boolean).join(' | ');
    if (line3) lines.push(line3);

    lines.push(`URL:${shortUrl}`);
    let text = lines.join('\n');
    if (text.length > 1200) text = text.slice(0, 1200);
    return text;
  }

  async function generateQRCode() {
    const qrCanvas      = document.getElementById('qrCanvas');
    const qrPlaceholder = document.getElementById('qrPlaceholder');
    const codeUnderQR   = document.getElementById('codeUnderQR');
    const cardUrlInput  = document.getElementById('cardUrl');
    const qrStatus      = document.getElementById('qrStatus');

    const hasProfile = !!(userData?.profile && userData.profile.fullName);
    const hasHealth  = !!(userData?.health && (userData.health.bloodType || userData.health.allergies));
    const hasIce     = Array.isArray(iceContacts) && iceContacts.length > 0;

    if (!(hasProfile || hasHealth || hasIce)) {
      if (qrPlaceholder) qrPlaceholder.style.display = 'flex';
      if (qrCanvas)      qrCanvas.style.display = 'none';
      if (codeUnderQR)   codeUnderQR.textContent = '';
      if (cardUrlInput)  cardUrlInput.value = '';
      if (qrStatus)      qrStatus.hidden = true;
      return;
    }

    const code = await ensureShortCode();
    const shortUrl = `https://www.myqer.com/c/${code}`;

    if (codeUnderQR)  codeUnderQR.textContent = code;
    if (cardUrlInput) cardUrlInput.value = shortUrl;

    if (qrCanvas) {
      const ctx = qrCanvas.getContext('2d');
      ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);

      await new Promise((resolve, reject) => {
        QRCode.toCanvas(
          qrCanvas,
          shortUrl,
          { width: 200, errorCorrectionLevel: 'H', margin: 1 },
          err => err ? reject(err) : resolve()
        );
      });

      qrCanvas.style.display = 'block';
    }
    if (qrPlaceholder) qrPlaceholder.style.display = 'none';

    if (qrStatus) {
      qrStatus.textContent = 'QR Code generated successfully';
      qrStatus.style.background = 'rgba(5, 150, 105, 0.1)';
      qrStatus.style.color = 'var(--green)';
      qrStatus.hidden = false;
    }

    const offlineEl = document.getElementById('offlineText');
    if (offlineEl) offlineEl.value = buildOfflineText(shortUrl);

    console.log('🔗 QR ready:', shortUrl);
  }
  // ====== /QR overrides ======
</script>

<!-- Spinner failsafe: always hide after load/errors -->
<script>
(function () {
  function hideSpinner() {
    var el = document.getElementById('loadingState');
    if (el) el.style.display = 'none';
  }
  document.addEventListener('DOMContentLoaded', hideSpinner);
  window.addEventListener('load', hideSpinner);
  window.addEventListener('error', hideSpinner);
  window.addEventListener('unhandledrejection', hideSpinner);
  setTimeout(hideSpinner, 4000);
})();
</script>

<!-- Cloudflare bot-protection snippet (unchanged) -->
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97984376b004496e',t:'MTc1NjkzNDEzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>

</body>
</html>
