<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER Dashboard - Emergency Medical Information System</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::before,
        *::after {
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #1e293b;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* CSS Custom Properties */
        :root {
            --primary-red: #dc2626;
            --primary-red-hover: #b91c1c;
            --primary-red-light: #fecaca;
            --success-green: #059669;
            --success-green-hover: #047857;
            --success-green-light: #a7f3d0;
            --warning-amber: #d97706;
            --warning-amber-hover: #b45309;
            --warning-amber-light: #fde68a;
            --info-blue: #2563eb;
            --info-blue-hover: #1d4ed8;
            --info-blue-light: #bfdbfe;
            --ink-dark: #0f172a;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --white: #ffffff;
            --background-primary: #ffffff;
            --background-secondary: #f8fafc;
            --background-tertiary: #f1f5f9;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-dark: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 24px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --spacing-3xl: 64px;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.2s ease-out;
            --transition-slow: 0.3s ease-out;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --ink-dark: #f8fafc;
                --slate-900: #f8fafc;
                --slate-800: #f1f5f9;
                --slate-700: #e2e8f0;
                --slate-600: #cbd5e1;
                --slate-500: #94a3b8;
                --slate-400: #64748b;
                --slate-300: #475569;
                --slate-200: #334155;
                --slate-100: #1e293b;
                --slate-50: #0f172a;
                --background-primary: #0f172a;
                --background-secondary: #1e293b;
                --background-tertiary: #334155;
                --border-light: #334155;
                --border-medium: #475569;
                --border-dark: #64748b;
                --glass-bg: rgba(15, 23, 42, 0.85);
                --glass-border: rgba(255, 255, 255, 0.1);
            }
            
            body {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
                color: var(--slate-100);
            }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity var(--transition-slow), visibility var(--transition-slow);
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            background: var(--white);
            border-radius: var(--radius-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 900;
            color: var(--primary-red);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-2xl);
            animation: pulse 2s infinite;
        }

        .loading-text {
            color: var(--white);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 400;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: var(--spacing-lg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-lg) var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: var(--spacing-lg);
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 900;
            font-size: 20px;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-normal);
        }

        .logo-icon:hover {
            transform: scale(1.05);
        }

        .logo-text {
            font-size: 28px;
            font-weight: 900;
            color: var(--ink-dark);
            letter-spacing: -0.5px;
        }

        .logo-subtitle {
            font-size: 12px;
            color: var(--slate-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: -4px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 14px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-email {
            font-size: 14px;
            font-weight: 500;
            color: var(--slate-700);
        }

        .user-status {
            font-size: 12px;
            color: var(--success-green);
            font-weight: 500;
        }

        /* Language Selector */
        .language-selector {
            position: relative;
        }

        .language-btn {
            background: var(--white);
            border: 1px solid var(--border-light);
            color: var(--slate-700);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 100px;
        }

        .language-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            box-shadow: var(--shadow-sm);
        }

        .language-dropdown {
            position: absolute;
            top: calc(100% + var(--spacing-sm));
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            min-width: 220px;
            max-height: 320px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-normal);
        }

        .language-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .language-option {
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .language-option:hover {
            background-color: var(--slate-50);
        }

        .language-option.active {
            background-color: var(--primary-red);
            color: var(--white);
        }

        .language-option:first-child {
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .language-option:last-child {
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        /* Logout Button */
        .logout-btn {
            background: none;
            border: 1px solid var(--border-light);
            color: var(--slate-600);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logout-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            background: var(--primary-red-light);
        }

        /* Offline Banner */
        .offline-banner {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
            color: var(--white);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
            display: none;
            align-items: center;
            gap: var(--spacing-md);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            animation: slideDown 0.3s ease-out;
        }

        .offline-banner.show {
            display: flex;
        }

        .offline-icon {
            font-size: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Styles */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: var(--radius-2xl) 0 0 var(--radius-2xl);
        }

        .card.identity::before {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
        }

        .card.critical::before {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
        }

        .card.ice::before {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
        }

        .card.emergency::before {
            background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));
        }

        .card.delete {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.03), rgba(239, 68, 68, 0.03));
            border: 2px solid rgba(220, 38, 38, 0.1);
        }

        .card.delete::before {
            background: linear-gradient(135deg, var(--primary-red), #ef4444);
        }

        /* Card Header */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-2xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .card-title-section {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .card-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--ink-dark);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            letter-spacing: -0.5px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--slate-500);
            font-weight: 500;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--white);
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        /* Triage System */
        .triage-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .triage-pill {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-2xl);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .triage-pill:hover {
            transform: scale(1.05);
        }

        .triage-green {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
            color: var(--white);
        }

        .triage-amber {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
            color: var(--white);
        }

        .triage-red {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            color: var(--white);
        }

        .triage-black {
            background: linear-gradient(135deg, #374151, #1f2937);
            color: var(--white);
        }

        .triage-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-label-required::after {
            content: '*';
            color: var(--primary-red);
            font-weight: 700;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 400;
            background: var(--white);
            transition: all var(--transition-normal);
            font-family: inherit;
            color: var(--slate-700);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            background: var(--white);
        }

        .form-input:invalid,
        .form-select:invalid,
        .form-textarea:invalid {
            border-color: var(--primary-red);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right var(--spacing-md) center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: var(--spacing-2xl);
        }

        .form-help {
            font-size: 12px;
            color: var(--slate-500);
            font-style: italic;
        }

        .form-error {
            font-size: 12px;
            color: var(--primary-red);
            font-weight: 500;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) 0;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-red);
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--slate-700);
            cursor: pointer;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: none;
            text-decoration: none;
            font-family: inherit;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary-red);
            border: 2px solid var(--primary-red);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--primary-red);
            color: var(--white);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--primary-red), #ef4444);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-ghost {
            background: transparent;
            color: var(--slate-600);
            border: 1px solid var(--border-light);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--slate-50);
            border-color: var(--slate-300);
        }

        .btn-sm {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 12px;
        }

        .btn-lg {
            padding: var(--spacing-lg) var(--spacing-xl);
            font-size: 16px;
        }

        /* ICE Contacts */
        .ice-contacts-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .ice-contact {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            transition: all var(--transition-normal);
            position: relative;
        }

        .ice-contact:hover {
            border-color: var(--warning-amber);
            box-shadow: var(--shadow-md);
        }

        .ice-contact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
        }

        .ice-contact-title {
            font-weight: 700;
            font-size: 18px;
            color: var(--ink-dark);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .ice-contact-number {
            background: var(--warning-amber);
            color: var(--white);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .ice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }

        .no-contacts {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--slate-500);
            font-style: italic;
            background: var(--slate-50);
            border-radius: var(--radius-xl);
            border: 2px dashed var(--border-medium);
        }

        .no-contacts-icon {
            font-size: 48px;
            color: var(--slate-400);
            margin-bottom: var(--spacing-md);
        }

        /* QR Code Section */
        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xl);
            text-align: center;
        }

        .qr-box {
            width: 280px;
            height: 280px;
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-xl);
            border: 3px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .qr-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--primary-red), var(--warning-amber), var(--success-green), var(--info-blue));
            border-radius: var(--radius-xl);
            z-index: -1;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .qr-code-text {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--ink-dark);
            letter-spacing: 3px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .qr-label {
            font-size: 14px;
            color: var(--primary-red);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: var(--spacing-sm);
        }

        .qr-url-section {
            width: 100%;
            max-width: 600px;
        }

        .url-group {
            display: flex;
            gap: var(--spacing-md);
            width: 100%;
        }

        .url-input {
            flex: 1;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 14px;
            background: var(--slate-50);
            border: 2px solid var(--border-light);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            color: var(--slate-700);
        }

        .qr-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Delete Section */
        .delete-section {
            text-align: center;
            padding: var(--spacing-3xl);
        }

        .delete-title {
            font-size: 32px;
            font-weight: 900;
            color: var(--primary-red);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .delete-warning {
            color: var(--slate-600);
            margin-bottom: var(--spacing-2xl);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            font-size: 16px;
            line-height: 1.6;
        }

        .confirm-input {
            max-width: 400px;
            margin: 0 auto var(--spacing-xl);
            text-align: center;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-radius: var(--radius-lg);
            color: var(--white);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform var(--transition-slow);
            box-shadow: var(--shadow-2xl);
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
        }

        .toast.error {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
        }

        .toast.info {
            background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 18px;
            margin-left: auto;
            padding: var(--spacing-xs);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-slow);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-3xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-2xl);
            transform: scale(0.9);
            transition: transform var(--transition-slow);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-red);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .modal-text {
            color: var(--slate-600);
            margin-bottom: var(--spacing-2xl);
            font-size: 16px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Footer */
        .footer {
            margin-top: var(--spacing-3xl);
            padding: var(--spacing-3xl) 0;
            border-top: 2px solid var(--border-light);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }

        .footer-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .footer-logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 800;
            font-size: 14px;
        }

        .footer-logo-text {
            font-size: 18px;
            font-weight: 800;
            color: var(--ink-dark);
        }

        .footer-links {
            display: flex;
            gap: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--slate-500);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color var(--transition-normal);
        }

        .footer-link:hover {
            color: var(--primary-red);
        }

        .footer-copyright {
            color: var(--slate-400);
            font-size: 12px;
            text-align: center;
            width: 100%;
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-light);
        }

        /* Saving Indicator */
        .saving-indicator {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-700);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all var(--transition-slow);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
        }

        .saving-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .saving-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-container {
                padding: var(--spacing-md);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .ice-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-actions {
                justify-content: space-between;
            }
            
            .card {
                padding: var(--spacing-lg);
            }
            
            .card-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-lg);
            }
            
            .card-actions {
                justify-content: stretch;
            }
            
            .card-actions .btn {
                flex: 1;
            }
            
            .qr-actions {
                flex-direction: column;
            }
            
            .url-group {
                flex-direction: column;
            }
            
            .triage-container {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-md);
            }
            
            .modal-content {
                margin: var(--spacing-lg);
                width: auto;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            
            .footer-links {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: var(--spacing-sm);
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .qr-box {
                width: 240px;
                height: 240px;
            }
            
            .qr-code-text {
                font-size: 20px;
                letter-spacing: 1px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-sm {
            gap: var(--spacing-sm);
        }

        .gap-md {
            gap: var(--spacing-md);
        }

        .gap-lg {
            gap: var(--spacing-lg);
        }

        .mt-sm {
            margin-top: var(--spacing-sm);
        }

        .mt-md {
            margin-top: var(--spacing-md);
        }

        .mt-lg {
            margin-top: var(--spacing-lg);
        }

        .mb-sm {
            margin-bottom: var(--spacing-sm);
        }

        .mb-md {
            margin-bottom: var(--spacing-md);
        }

        .mb-lg {
            margin-bottom: var(--spacing-lg);
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .header,
            .footer,
            .btn,
            .modal,
            .toast,
            .saving-indicator,
            .offline-banner {
                display: none !important;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .qr-box {
                border: 2px solid #000;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --border-light: #000000;
                --border-medium: #000000;
                --border-dark: #000000;
            }
            
            .card {
                border: 2px solid #000000;
            }
            
            .btn {
                border: 2px solid #000000;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">M</div>
        <div class="loading-text">MYQER Dashboard</div>
        <div class="loading-subtext">Loading your emergency medical information...</div>
        <div class="spinner"></div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="main-container hidden">
        <!-- Offline Banner -->
        <div id="offlineBanner" class="offline-banner">
            <i class="fas fa-wifi-slash offline-icon"></i>
            <span data-i18n="offline_mode">You're offline. Changes will sync when connection is restored.</span>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <div class="logo-text">MYQER</div>
                        <div class="logo-subtitle">Emergency Medical System</div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <div class="user-email" id="userEmail">user@example.com</div>
                            <div class="user-status" data-i18n="online_status">Online</div>
                        </div>
                    </div>
                    
                    <div class="language-selector">
                        <button class="language-btn" onclick="toggleLanguageDropdown()">
                            <span id="currentLanguage">üá∫üá∏ EN</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="languageDropdown" class="language-dropdown">
                            <div class="language-option active" onclick="changeLanguage('en')">üá∫üá∏ English</div>
                            <div class="language-option" onclick="changeLanguage('es')">üá™üá∏ Espa√±ol</div>
                            <div class="language-option" onclick="changeLanguage('fr')">üá´üá∑ Fran√ßais</div>
                            <div class="language-option" onclick="changeLanguage('de')">üá©üá™ Deutsch</div>
                            <div class="language-option" onclick="changeLanguage('it')">üáÆüáπ Italiano</div>
                            <div class="language-option" onclick="changeLanguage('pt')">üáµüáπ Portugu√™s</div>
                            <div class="language-option" onclick="changeLanguage('ro')">üá∑üá¥ Rom√¢nƒÉ</div>
                            <div class="language-option" onclick="changeLanguage('ar')">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                            <div class="language-option" onclick="changeLanguage('hi')">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                            <div class="language-option" onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</div>
                        </div>
                    </div>
                    
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-i18n="logout">Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Identity Card -->
        <div class="card identity fade-in">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <span data-i18n="identity_title">Identity ‚Äî Personal Information</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="identity_subtitle">Your basic personal and identification details</p>
                </div>
                <div class="card-actions">
                    <button class="btn btn-success" onclick="saveProfile()">
                        <i class="fas fa-save"></i>
                        <span data-i18n="save">Save</span>
                    </button>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label form-label-required" data-i18n="full_name">Full Name</label>
                    <input type="text" id="fullName" class="form-input" placeholder="Enter your full legal name" required>
                    <div class="form-help" data-i18n="full_name_help">Enter your complete legal name as it appears on official documents</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="date_of_birth">Date of Birth</label>
                    <input type="date" id="dob" class="form-input">
                    <div class="form-help" data-i18n="dob_help">Used for age verification in medical emergencies</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="country">Country</label>
                    <select id="country" class="form-select">
                        <option value="">Select Country</option>
                        <option value="United States">üá∫üá∏ United States</option>
                        <option value="Canada">üá®üá¶ Canada</option>
                        <option value="United Kingdom">üá¨üáß United Kingdom</option>
                        <option value="Germany">üá©üá™ Germany</option>
                        <option value="France">üá´üá∑ France</option>
                        <option value="Spain">üá™üá∏ Spain</option>
                        <option value="Italy">üáÆüáπ Italy</option>
                        <option value="Australia">üá¶üá∫ Australia</option>
                        <option value="Japan">üáØüáµ Japan</option>
                        <option value="China">üá®üá≥ China</option>
                        <option value="India">üáÆüá≥ India</option>
                        <option value="Brazil">üáßüá∑ Brazil</option>
                        <option value="Mexico">üá≤üáΩ Mexico</option>
                        <option value="Argentina">üá¶üá∑ Argentina</option>
                        <option value="South Africa">üáøüá¶ South Africa</option>
                        <option value="Nigeria">üá≥üá¨ Nigeria</option>
                        <option value="Egypt">üá™üá¨ Egypt</option>
                        <option value="Russia">üá∑üá∫ Russia</option>
                        <option value="Turkey">üáπüá∑ Turkey</option>
                        <option value="Saudi Arabia">üá∏üá¶ Saudi Arabia</option>
                    </select>
                    <div class="form-help" data-i18n="country_help">Helps emergency responders understand local medical systems</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="health_id">National/Health ID (Optional)</label>
                    <input type="text" id="healthId" class="form-input" placeholder="e.g., SSN, NHS Number, Health Card">
                    <div class="form-help" data-i18n="health_id_help">National health identifier for faster medical record access</div>
                </div>
            </div>
        </div>

        <!-- Critical Medical Information Card -->
        <div class="card critical slide-up">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <span data-i18n="critical_title">CRITICAL ‚Äî Medical & Health Details</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="critical_subtitle">Life-saving medical information for emergency responders</p>
                </div>
                
                <div class="card-actions">
                    <div class="triage-container">
                        <select id="triageOverride" class="form-select" style="width: auto; min-width: 140px;" onchange="updateTriage()">
                            <option value="auto" data-i18n="auto">Auto</option>
                            <option value="green" data-i18n="green">Green</option>
                            <option value="amber" data-i18n="amber">Amber</option>
                            <option value="red" data-i18n="red">Red</option>
                            <option value="black" data-i18n="black">Black</option>
                        </select>
                        
                        <div id="triagePill" class="triage-pill triage-green">
                            <div class="triage-indicator"></div>
                            <span data-i18n="green">Green</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning" onclick="saveHealth()">
                        <i class="fas fa-save"></i>
                        <span data-i18n="save">Save</span>
                    </button>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" data-i18n="blood_type">Blood Type</label>
                    <select id="bloodType" class="form-select" onchange="updateTriage()">
                        <option value="">Select Blood Type</option>
                        <option value="A+">ü©∏ A+ (A Positive)</option>
                        <option value="A-">ü©∏ A- (A Negative)</option>
                        <option value="B+">ü©∏ B+ (B Positive)</option>
                        <option value="B-">ü©∏ B- (B Negative)</option>
                        <option value="AB+">ü©∏ AB+ (AB Positive)</option>
                        <option value="AB-">ü©∏ AB- (AB Negative)</option>
                        <option value="O+">ü©∏ O+ (O Positive)</option>
                        <option value="O-">ü©∏ O- (O Negative)</option>
                    </select>
                    <div class="form-help" data-i18n="blood_type_help">Critical for blood transfusions and medical procedures</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="allergies">Critical Allergies</label>
                    <input type="text" id="allergies" class="form-input" placeholder="e.g., Penicillin, Nuts, Shellfish, Latex" onchange="updateTriage()">
                    <div class="form-help" data-i18n="allergies_help">List all known allergies that could cause severe reactions</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="conditions">Medical Conditions</label>
                    <textarea id="conditions" class="form-textarea" placeholder="List any chronic conditions, diseases, or ongoing medical issues (e.g., Diabetes, Hypertension, Epilepsy)" onchange="updateTriage()"></textarea>
                    <div class="form-help" data-i18n="conditions_help">Include chronic diseases, mental health conditions, and ongoing treatments</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="medications">Current Medications</label>
                    <textarea id="medications" class="form-textarea" placeholder="List all current medications with dosages (e.g., Metformin 500mg twice daily, Lisinopril 10mg once daily)" onchange="updateTriage()"></textarea>
                    <div class="form-help" data-i18n="medications_help">Include prescription drugs, over-the-counter medications, and supplements</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="implants">Implants/Medical Devices</label>
                    <input type="text" id="implants" class="form-input" placeholder="e.g., Pacemaker, Hip replacement, Insulin pump, Cochlear implant" onchange="updateTriage()">
                    <div class="form-help" data-i18n="implants_help">Medical devices that could affect treatment or require special consideration</div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="organDonor" class="checkbox">
                        <label for="organDonor" class="checkbox-label" data-i18n="organ_donor">I am an organ donor</label>
                    </div>
                    <div class="form-help" data-i18n="organ_donor_help">Indicates your consent for organ donation in case of brain death</div>
                </div>
            </div>
        </div>

        <!-- Emergency Contacts (ICE) Card -->
        <div class="card ice bounce-in">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <span data-i18n="ice_title">Emergency Contacts (ICE)</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="ice_subtitle">People to contact in case of emergency (maximum 3 contacts)</p>
                </div>
                
                <div class="card-actions">
                    <button class="btn btn-secondary" onclick="addContact()" id="addContactBtn">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="add_contact">Add Contact</span>
                    </button>
                    <button class="btn btn-warning" onclick="saveICE()">
                        <i class="fas fa-save"></i>
                        <span data-i18n="save_all">Save All</span>
                    </button>
                </div>
            </div>
            
            <div id="iceContacts" class="ice-contacts-container">
                <div class="no-contacts">
                    <div class="no-contacts-icon">
                        <i class="fas fa-address-book"></i>
                    </div>
                    <div data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>
                </div>
            </div>
        </div>

        <!-- Emergency Card & QR Code -->
        <div class="card emergency fade-in">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <span data-i18n="qr_title">Emergency Card & QR Code</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="qr_subtitle">Your unique emergency medical information access code</p>
                </div>
            </div>
            
            <div class="qr-container">
                <div class="qr-box">
                    <div id="qrcode"></div>
                </div>
                
                <div class="qr-code-text" id="qrCodeText">MQ7X9K</div>
                <div class="qr-label">MYQER‚Ñ¢ EMERGENCY ACCESS</div>
                
                <div class="qr-url-section">
                    <div class="url-group">
                        <input type="text" id="cardUrl" class="url-input" readonly value="https://www.myqer.com/c/MQ7X9K">
                        <button class="btn btn-secondary" onclick="copyUrl()">
                            <i class="fas fa-copy"></i>
                            <span data-i18n="copy">Copy</span>
                        </button>
                        <button class="btn btn-secondary" onclick="openUrl()">
                            <i class="fas fa-external-link-alt"></i>
                            <span data-i18n="open">Open</span>
                        </button>
                    </div>
                </div>
                
                <div class="qr-actions">
                    <button class="btn btn-ghost" onclick="downloadQR('png')">
                        <i class="fas fa-download"></i>
                        <span data-i18n="download_png">Download PNG</span>
                    </button>
                    <button class="btn btn-ghost" onclick="downloadQR('svg')">
                        <i class="fas fa-download"></i>
                        <span data-i18n="download_svg">Download SVG</span>
                    </button>
                    <button class="btn btn-ghost" onclick="printQR()">
                        <i class="fas fa-print"></i>
                        <span data-i18n="print">Print Card</span>
                    </button>
                    <button class="btn btn-primary" onclick="generateQRCode()">
                        <i class="fas fa-sync-alt"></i>
                        <span data-i18n="regenerate">Regenerate</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Account Card -->
        <div class="card delete slide-up">
            <div class="delete-section">
                <h2 class="delete-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span data-i18n="delete_title">Delete Account</span>
                </h2>
                <p class="delete-warning" data-i18n="delete_warning">
                    This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers. Your emergency contacts will no longer be able to access your medical information.
                </p>
                <div class="form-group">
                    <label class="form-label" data-i18n="delete_confirm_label">Type "DELETE MY ACCOUNT" to confirm:</label>
                    <input type="text" id="deleteConfirm" class="form-input confirm-input" placeholder="DELETE MY ACCOUNT">
                </div>
                <button class="btn btn-danger btn-lg" onclick="deleteAccount()">
                    <i class="fas fa-trash-alt"></i>
                    <span data-i18n="delete_account">Delete My Account Permanently</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-logo">
                    <div class="footer-logo-icon">M</div>
                    <div class="footer-logo-text">MYQER</div>
                </div>
                
                <div class="footer-links">
                    <a href="#" class="footer-link" data-i18n="privacy_policy">Privacy Policy</a>
                    <a href="#" class="footer-link" data-i18n="terms_of_service">Terms of Service</a>
                    <a href="#" class="footer-link" data-i18n="support">Support</a>
                    <a href="#" class="footer-link" data-i18n="about">About MYQER</a>
                </div>
                
                <div class="footer-copyright" data-i18n="copyright">
                    ¬© 2024 MYQER. All rights reserved. Saving lives through technology.
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-icon"></div>
        <div class="toast-message"></div>
        <button class="toast-close" onclick="hideToast()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Saving Indicator -->
    <div id="savingIndicator" class="saving-indicator">
        <div class="saving-spinner"></div>
        <span data-i18n="saving">Saving...</span>
    </div>

    <!-- Session Expiry Modal -->
    <div id="idleModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">
                <i class="fas fa-clock"></i>
                <span data-i18n="session_expiring">Session Expiring</span>
            </h3>
            <p class="modal-text">
                <span data-i18n="session_expire_text">Your session will expire in</span> 
                <strong><span id="countdown">60</span></strong> 
                <span data-i18n="seconds">seconds due to inactivity.</span>
            </p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="resetIdleTimer()">
                    <i class="fas fa-refresh"></i>
                    <span data-i18n="stay_logged_in">Stay Logged In</span>
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="logout">Logout</span>
                </button>
            </div>
        </div>
    </div>
    <script>
/* =========================
   MYQER Dashboard Brain (v5)
   =========================
   - Supabase Auth + CRUD
   - Autosave (debounced 600ms)
   - Online/Offline hybrid QR (live + text)
   - i18n (en, es, fr, de, it, pt, ro, ar, hi, zh)
   - Triage scoring + override
   - Resilient error handling (no infinite spinners/toast spam)
   - Works on Safari/iPad (localStorage auth, clipboard, print)
*/
(() => {
  // ---- Supabase config (given) ----
  const SUPABASE_URL  = "https://dmntmhkncldgynufajei.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY";

  // ---- Create client (localStorage persistence by default) ----
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { persistSession: true, storage: window.localStorage, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // ---- DOM helpers (support both new required IDs and your older ones) ----
  const $ = (sel) => document.querySelector(sel);
  const byId = (id, fallbackIds=[]) => {
    let el = document.getElementById(id);
    if (el) return el;
    for (const fb of fallbackIds) { el = document.getElementById(fb); if (el) return el; }
    return null;
  };

  // Field map: new IDs (spec) -> fallbacks used in your earlier template
  const F = {
    fullName:  () => byId("profileFullName", ["fullName"]),
    dob:       () => byId("profileDob", ["dob"]),
    country:   () => byId("profileCountry", ["country"]),
    healthId:  () => byId("profileHealthId", ["healthId"]),
    bloodType: () => byId("hfBloodType", ["bloodType"]),
    allergies: () => byId("hfAllergies", ["allergies"]),
    donor:     () => byId("hfDonor", ["organDonor"]),
    conditions:() => byId("hfConditions", ["conditions"]),
    meds:      () => byId("hfMeds", ["medications"]),
    implants:  () => byId("hfImplants", ["implants"]),
    triage:    () => byId("triageOverride", ["triageOverride"]),
    iceList:   () => byId("iceContactsList", ["iceContacts"]),
    addIce:    () => byId("addIce", ["addContactBtn"]),
    // Buttons
    btnSaveProfile: () => byId("saveProfile"),
    btnSaveHealth:  () => byId("saveHealth"),
    btnSaveIce:     () => byId("saveIce"),
    btnSignOut:     () => byId("btnSignOut"),
    btnCopy:        () => byId("copyLink", ["copyLinkBtn", "copyUrl"]),
    btnOpen:        () => byId("openLink", ["openUrl"]),
    btnDlPNG:       () => byId("dlPNG"),
    btnDlSVG:       () => byId("dlSVG"),
    btnPrint:       () => byId("printQR"),
    btnSaveOffline: () => byId("btnSaveOfflineQR"),
    // Delete
    deletePhrase:   () => byId("deletePhrase", ["deleteConfirm"]),
    deleteBtn:      () => byId("deleteBtn", ["deleteAccountBtn", "deleteAccount"]),
    // QR + labels
    qrCanvas:       () => byId("qrCanvas", ["qrcode"]),
    qrPlaceholder:  () => byId("qrPlaceholder"),
    codeUnderQR:    () => byId("codeUnderQR", ["qrCodeText"]),
    cardUrl:        () => byId("cardUrl", ["cardUrl"]),
    qrStatus:       () => byId("qrStatus"),
    offlineQRwrap:  () => byId("offlineQRwrap"),
    offlineQRbox:   () => byId("offlineQRbox"),
    // Language
    langBtn:        () => byId("currentLanguage"),
    offlineBanner:  () => byId("offlineBanner")
  };

  // ---- i18n ----
  const t = {
    en:{online:"Online",offline:"Offline",save:"Save",saved:"Saved",autosaved:"Changes saved automatically",autoSaveFail:"Auto-save failed",profileSaved:"Profile saved",healthSaved:"Health saved",iceSaved:"Emergency contacts saved",copy:"Copy",copied:"URL copied",open:"Open",download:"Download",downloaded:"Downloaded",print:"Print",qrLiveReady:"QR ready",qrOfflineReady:"Offline QR ready",loginRequired:"Please log in",deleteConfirm:"Type \"DELETE MY ACCOUNT\"",deleted:"Account deleted",deleteFail:"Failed to delete",logout:"Signing out...",fatal:"Critical error",tryAgain:"Try again",green:"Green",amber:"Amber",red:"Red",black:"Black"},
    es:{online:"En l√≠nea",offline:"Sin conexi√≥n",save:"Guardar",saved:"Guardado",autosaved:"Cambios guardados autom√°ticamente",autoSaveFail:"Auto-guardado fall√≥",profileSaved:"Perfil guardado",healthSaved:"Salud guardada",iceSaved:"Contactos guardados",copy:"Copiar",copied:"URL copiada",open:"Abrir",download:"Descargar",downloaded:"Descargado",print:"Imprimir",qrLiveReady:"QR listo",qrOfflineReady:"QR sin conexi√≥n listo",loginRequired:"Inicia sesi√≥n",deleteConfirm:"Escribe \"DELETE MY ACCOUNT\"",deleted:"Cuenta eliminada",deleteFail:"Error al eliminar",logout:"Cerrando sesi√≥n...",fatal:"Error cr√≠tico",tryAgain:"Reintentar",green:"Verde",amber:"√Åmbar",red:"Rojo",black:"Negro"},
    fr:{online:"En ligne",offline:"Hors ligne",save:"Enregistrer",saved:"Enregistr√©",autosaved:"Modifications enregistr√©es",autoSaveFail:"√âchec de l'auto-enregistrement",profileSaved:"Profil enregistr√©",healthSaved:"Donn√©es sant√© enregistr√©es",iceSaved:"Contacts d'urgence enregistr√©s",copy:"Copier",copied:"URL copi√©e",open:"Ouvrir",download:"T√©l√©charger",downloaded:"T√©l√©charg√©",print:"Imprimer",qrLiveReady:"QR pr√™t",qrOfflineReady:"QR hors ligne pr√™t",loginRequired:"Veuillez vous connecter",deleteConfirm:"Tapez \"DELETE MY ACCOUNT\"",deleted:"Compte supprim√©",deleteFail:"√âchec de suppression",logout:"D√©connexion‚Ä¶",fatal:"Erreur critique",tryAgain:"R√©essayer",green:"Vert",amber:"Ambre",red:"Rouge",black:"Noir"},
    de:{online:"Online",offline:"Offline",save:"Speichern",saved:"Gespeichert",autosaved:"Automatisch gespeichert",autoSaveFail:"Auto-Speichern fehlgeschlagen",profileSaved:"Profil gespeichert",healthSaved:"Gesundheit gespeichert",iceSaved:"Notfallkontakte gespeichert",copy:"Kopieren",copied:"URL kopiert",open:"√ñffnen",download:"Herunterladen",downloaded:"Heruntergeladen",print:"Drucken",qrLiveReady:"QR bereit",qrOfflineReady:"Offline-QR bereit",loginRequired:"Bitte anmelden",deleteConfirm:"Tippe \"DELETE MY ACCOUNT\"",deleted:"Konto gel√∂scht",deleteFail:"L√∂schen fehlgeschlagen",logout:"Abmelden‚Ä¶",fatal:"Kritischer Fehler",tryAgain:"Erneut versuchen",green:"Gr√ºn",amber:"Gelb",red:"Rot",black:"Schwarz"},
    it:{online:"Online",offline:"Offline",save:"Salva",saved:"Salvato",autosaved:"Modifiche salvate",autoSaveFail:"Salvataggio automatico fallito",profileSaved:"Profilo salvato",healthSaved:"Salute salvata",iceSaved:"Contatti salvati",copy:"Copia",copied:"URL copiata",open:"Apri",download:"Scarica",downloaded:"Scaricato",print:"Stampa",qrLiveReady:"QR pronto",qrOfflineReady:"QR offline pronto",loginRequired:"Accedi",deleteConfirm:"Scrivi \"DELETE MY ACCOUNT\"",deleted:"Account eliminato",deleteFail:"Eliminazione fallita",logout:"Disconnessione‚Ä¶",fatal:"Errore critico",tryAgain:"Riprova",green:"Verde",amber:"Ambra",red:"Rosso",black:"Nero"},
    pt:{online:"Online",offline:"Offline",save:"Salvar",saved:"Salvo",autosaved:"Altera√ß√µes salvas",autoSaveFail:"Falha no auto-salvar",profileSaved:"Perfil salvo",healthSaved:"Sa√∫de salva",iceSaved:"Contatos salvos",copy:"Copiar",copied:"URL copiada",open:"Abrir",download:"Baixar",downloaded:"Baixado",print:"Imprimir",qrLiveReady:"QR pronto",qrOfflineReady:"QR offline pronto",loginRequired:"Fa√ßa login",deleteConfirm:"Digite \"DELETE MY ACCOUNT\"",deleted:"Conta exclu√≠da",deleteFail:"Falha ao excluir",logout:"Saindo‚Ä¶",fatal:"Erro cr√≠tico",tryAgain:"Tentar novamente",green:"Verde",amber:"√Çmbar",red:"Vermelho",black:"Preto"},
    ro:{online:"Online",offline:"Offline",save:"SalveazƒÉ",saved:"Salvat",autosaved:"SchimbƒÉri salvate",autoSaveFail:"Salvare automatƒÉ e»ôuatƒÉ",profileSaved:"Profil salvat",healthSaved:"Date medicale salvate",iceSaved:"Contacte ICE salvate",copy:"CopiazƒÉ",copied:"URL copiat",open:"Deschide",download:"DescarcƒÉ",downloaded:"DescƒÉrcat",print:"PrinteazƒÉ",qrLiveReady:"QR gata",qrOfflineReady:"QR offline gata",loginRequired:"AutentificƒÉ-te",deleteConfirm:"TasteazƒÉ \"DELETE MY ACCOUNT\"",deleted:"Cont »ôters",deleteFail:"»òtergere e»ôuatƒÉ",logout:"Deconectare‚Ä¶",fatal:"Eroare criticƒÉ",tryAgain:"Re√ÆncearcƒÉ",green:"Verde",amber:"Chihlimbar",red:"Ro»ôu",black:"Negru"},
    ar:{online:"ŸÖÿ™ÿµŸÑ",offline:"ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ",save:"ÿ≠ŸÅÿ∏",saved:"ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏",autosaved:"ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß",autoSaveFail:"ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä",profileSaved:"ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ",healthSaved:"ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿµÿ≠ÿ©",iceSaved:"ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ",copy:"ŸÜÿ≥ÿÆ",copied:"ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",open:"ŸÅÿ™ÿ≠",download:"ÿ™ŸÜÿ≤ŸäŸÑ",downloaded:"ÿ™ŸÖ ÿßŸÑÿ™ŸÜÿ≤ŸäŸÑ",print:"ÿ∑ÿ®ÿßÿπÿ©",qrLiveReady:"ÿ¨ÿßŸáÿ≤ QR",qrOfflineReady:"QR ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ÿ¨ÿßŸáÿ≤",loginRequired:"ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",deleteConfirm:"ÿßŸÉÿ™ÿ® \"DELETE MY ACCOUNT\"",deleted:"ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®",deleteFail:"ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ",logout:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨‚Ä¶",fatal:"ÿÆÿ∑ÿ£ ÿÆÿ∑Ÿäÿ±",tryAgain:"ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ",green:"ÿ£ÿÆÿ∂ÿ±",amber:"ŸÉŸáÿ±ŸÖÿßŸÜŸä",red:"ÿ£ÿ≠ŸÖÿ±",black:"ÿ£ÿ≥ŸàÿØ"},
    hi:{online:"‡§ë‡§®‡§≤‡§æ‡§á‡§®",offline:"‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§®",save:"‡§∏‡•á‡§µ",saved:"‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ",autosaved:"‡§¨‡§¶‡§≤‡§æ‡§µ ‡§∏‡•ç‡§µ‡§§‡§É ‡§∏‡•á‡§µ",autoSaveFail:"‡§ë‡§ü‡•ã-‡§∏‡•á‡§µ ‡§µ‡§ø‡§´‡§≤",profileSaved:"‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡•á‡§µ",healthSaved:"‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ",iceSaved:"‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡•á‡§µ",copy:"‡§ï‡•â‡§™‡•Ä",copied:"URL ‡§ï‡•â‡§™‡•Ä",open:"‡§ñ‡•ã‡§≤‡•á‡§Ç",download:"‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°",downloaded:"‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ",print:"‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü",qrLiveReady:"QR ‡§§‡•à‡§Ø‡§æ‡§∞",qrOfflineReady:"‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® QR ‡§§‡•à‡§Ø‡§æ‡§∞",loginRequired:"‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç",deleteConfirm:"\"DELETE MY ACCOUNT\" ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç",deleted:"‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ",deleteFail:"‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤",logout:"‡§∏‡§æ‡§á‡§® ‡§Ü‡§â‡§ü‚Ä¶",fatal:"‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø",tryAgain:"‡§´‡§ø‡§∞ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç",green:"‡§π‡§∞‡§æ",amber:"‡§Ö‡§Æ‡•ç‡§¨‡§∞",red:"‡§≤‡§æ‡§≤",black:"‡§ï‡§æ‡§≤‡§æ"},
    zh:{online:"Âú®Á∫ø",offline:"Á¶ªÁ∫ø",save:"‰øùÂ≠ò",saved:"Â∑≤‰øùÂ≠ò",autosaved:"Â∑≤Ëá™Âä®‰øùÂ≠òÊõ¥Êîπ",autoSaveFail:"Ëá™Âä®‰øùÂ≠òÂ§±Ë¥•",profileSaved:"ËµÑÊñôÂ∑≤‰øùÂ≠ò",healthSaved:"ÂÅ•Â∫∑Êï∞ÊçÆÂ∑≤‰øùÂ≠ò",iceSaved:"Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫Â∑≤‰øùÂ≠ò",copy:"Â§çÂà∂",copied:"URL Â∑≤Â§çÂà∂",open:"ÊâìÂºÄ",download:"‰∏ãËΩΩ",downloaded:"Â∑≤‰∏ãËΩΩ",print:"ÊâìÂç∞",qrLiveReady:"‰∫åÁª¥Á†ÅÂ∞±Áª™",qrOfflineReady:"Á¶ªÁ∫ø‰∫åÁª¥Á†ÅÂ∞±Áª™",loginRequired:"ËØ∑ÁôªÂΩï",deleteConfirm:"ËæìÂÖ• \"DELETE MY ACCOUNT\"",deleted:"Ë¥¶Âè∑Â∑≤Âà†Èô§",deleteFail:"Âà†Èô§Â§±Ë¥•",logout:"Ê≠£Âú®ÈÄÄÂá∫‚Ä¶",fatal:"‰∏•ÈáçÈîôËØØ",tryAgain:"ÈáçËØï",green:"ÁªøËâ≤",amber:"Ê©ôËâ≤",red:"Á∫¢Ëâ≤",black:"ÈªëËâ≤"}
  };
  const LANGS = Object.keys(t);
  const getBrowserLang = () => {
    const l = (navigator.language || "en").slice(0,2);
    const map = { "zh":"zh","es":"es","fr":"fr","de":"de","it":"it","pt":"pt","ro":"ro","ar":"ar","hi":"hi","en":"en" };
    return map[l] || "en";
  };
  let LANG = localStorage.getItem("myqer_language") || getBrowserLang();

  // ---- Toasts (rate-limited) ----
  let lastErrorToastAt = 0;
  const showToast = (msg, type="info") => {
    // Use your existing #toast if present, else simple fallback
    const toast = document.getElementById("toast");
    if (toast) {
      toast.className = `toast ${type} show`;
      const icon = toast.querySelector(".toast-icon");
      const msgEl= toast.querySelector(".toast-message");
      if (icon) icon.className = "toast-icon " + ({success:"fas fa-check-circle",error:"fas fa-exclamation-circle",warning:"fas fa-exclamation-triangle",info:"fas fa-info-circle"}[type] || "fas fa-info-circle");
      if (msgEl) msgEl.textContent = msg;
      setTimeout(() => toast.classList.remove("show"), 4000);
    } else {
      // minimal fallback
      console.log(`[${type.toUpperCase()}] ${msg}`);
    }
  };
  const errorToast = (msg) => {
    const now = Date.now();
    if (now - lastErrorToastAt > 5000) {
      lastErrorToastAt = now;
      showToast(msg, "error");
    }
  };

  // ---- Online/Offline banner ----
  const updateOnlineBanner = () => {
    const el = F.offlineBanner();
    if (!el) return;
    if (navigator.onLine) { el.classList.remove("show"); }
    else { el.classList.add("show"); }
  };
  window.addEventListener("online", updateOnlineBanner);
  window.addEventListener("offline", updateOnlineBanner);

  // ---- Auth gate ----
  async function requireSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      const next = encodeURIComponent("/dashboard.html");
      window.location.replace(`/login.html?next=${next}`);
      throw new Error("No session");
    }
    return session;
  }

  // ---- Local mirrors ----
  const LS_KEYS = {
    profile: "myqer_profile",
    health : "myqer_health",
    ice    : "myqer_ice",
    code   : "myqer_shortcode"
  };

  // ---- Data gatherers ----
  const getProfileData = () => ({
    full_name: (F.fullName()?.value || "").trim() || null,
    dob:        F.dob()?.value || null,
    country:    F.country()?.value || null,
    health_id: (F.healthId()?.value || "").trim() || null
  });
  const getHealthData = () => ({
    blood_type: F.bloodType()?.value || null,
    allergies:  (F.allergies()?.value || "").trim() || null,
    organ_donor: !!F.donor()?.checked,
    conditions: (F.conditions()?.value || "").trim() || null,
    medications:(F.meds()?.value || "").trim() || null,
    implants:   (F.implants()?.value || "").trim() || null,
    triage_override: (F.triage()?.value || "auto")
  });

  // ---- ICE rendering (list with up to 3 entries) ----
  let ice = []; // [{contact_order,name,relation,phone}]
  function renderICE() {
    const container = F.iceList();
    if (!container) return;
    if (!ice || ice.length === 0) {
      container.innerHTML = `
        <div class="no-contacts">
          <div class="no-contacts-icon"><i class="fas fa-address-book"></i></div>
          <div data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>
        </div>`;
      return;
    }
    container.innerHTML = ice
      .sort((a,b)=>a.contact_order-b.contact_order)
      .map((c,idx) => `
        <div class="ice-contact">
          <div class="ice-contact-header">
            <h4 class="ice-contact-title">
              <div class="ice-contact-number">${idx+1}</div>
              Emergency Contact ${idx+1}
            </h4>
            <button class="btn btn-danger btn-sm" data-remove="${c.contact_order}">
              <i class="fas fa-trash"></i> <span data-i18n="remove">Remove</span>
            </button>
          </div>
          <div class="ice-grid">
            <div class="form-group">
              <label class="form-label" data-i18n="contact_name">Name</label>
              <input class="form-input" data-field="name" data-order="${c.contact_order}" value="${c.name||""}" placeholder="Full name">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="contact_relationship">Relationship</label>
              <input class="form-input" data-field="relation" data-order="${c.contact_order}" value="${c.relation||""}" placeholder="e.g., Spouse">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="contact_phone">Phone</label>
              <input class="form-input" data-field="phone" data-order="${c.contact_order}" value="${c.phone||""}" placeholder="+1 (555) 123-4567">
            </div>
          </div>
        </div>`
      ).join("");

    // Hook change/remove
    container.querySelectorAll("[data-field]").forEach(inp=>{
      inp.addEventListener("input", debounce(e=>{
        const order = +e.target.dataset.order;
        const field = e.target.dataset.field;
        const row = ice.find(r=>r.contact_order===order);
        if (row) row[field] = e.target.value;
        localStorage.setItem(LS_KEYS.ice, JSON.stringify(ice));
        // Debounced autosave ICE (non-spam)
        scheduleAutoSave("ice");
      },600));
    });
    container.querySelectorAll("[data-remove]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const order = +btn.dataset.remove;
        ice = ice.filter(r=>r.contact_order !== order);
        // Re-compact orders 0..2
        ice = ice.map((r,i)=>({...r,contact_order:i})).slice(0,3);
        localStorage.setItem(LS_KEYS.ice, JSON.stringify(ice));
        renderICE();
      });
    });
  }

  // ---- Debounce helpers ----
  const timers = new Map();
  function debounce(fn, wait) {
    let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
  }
  function scheduleAutoSave(section) {
    const key = `auto:${section}`;
    clearTimeout(timers.get(key));
    const h = setTimeout(()=>autoSave(section), 600);
    timers.set(key, h);
  }

  async function autoSave(section) {
    try {
      if (section === "profile") { await saveProfile(true); }
      else if (section === "health"){ await saveHealth(true); }
      else if (section === "ice")   { await saveICE(true); }
      if (navigator.onLine) showToast(t[LANG].autosaved, "success");
    } catch (e) {
      errorToast(t[LANG].autoSaveFail);
      console.warn(e);
    }
  }

  // ---- Code generation (immutable once on server) ----
  const CODE_ALPHABET = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  const genCode = () => {
    let s = "";
    for (let i=0;i<8;i++) s += CODE_ALPHABET[Math.floor(Math.random()*CODE_ALPHABET.length)];
    return (s.slice(0,4)+"-"+s.slice(4)).toUpperCase();
  };
  async function ensureUserCode(uid) {
    let code = localStorage.getItem(LS_KEYS.code);
    if (!code) {
      // try read from server first
      try {
        const { data, error } = await supabase.from("profiles").select("code").eq("id", uid).single();
        if (!error && data && data.code) code = data.code;
      } catch{}
    }
    if (!code) code = genCode();

    // attempt to set server if null only
    try {
      const { error } = await supabase
        .from("profiles")
        .update({ code })
        .eq("id", uid)
        .is("code", null);
      // ignore uniqueness/immutability errors; read back
      const { data } = await supabase.from("profiles").select("code").eq("id", uid).single();
      if (data && data.code) code = data.code.toUpperCase();
    } catch (e) {
      console.warn("Code update/read failed, using local", e);
    }
    localStorage.setItem(LS_KEYS.code, code);
    return code;
  }

  // ---- QR rendering (Live + Offline) ----
  function clearQR(el) { if (!el) return; el.innerHTML = ""; }
  function makeQR(el, text, size=240, level="M") {
    if (!el) return;
    clearQR(el);
    // Supports qrcodejs v1 or the newer QRCode lib
    const CorrectLevel = (window.QRCode && window.QRCode.CorrectLevel) ? window.QRCode.CorrectLevel : {L:1,M:2,Q:3,H:4};
    new window.QRCode(el, {
      text, width: size, height: size, correctLevel: CorrectLevel[level] || CorrectLevel.M
    });
  }
  function bytesLen(s){ return new TextEncoder().encode(s).length; }

  function buildOfflinePayload(code, p, h, iceRows) {
    const none = (s)=> (s && s.trim()) ? s.trim() : "None";
    // Start with full
    let payload = [
      "MYQER\u2122 EMERGENCY CARD",
      `Code: ${code}`,
      `Name: ${none(p.full_name)}`,
      `DOB: ${p.dob || ""}`,
      `Blood: ${h.blood_type || ""}`,
      `Allergies: ${none(h.allergies)}`,
      `Conditions: ${none(h.conditions)}`,
      `Meds: ${none(h.medications)}`,
      `Implants: ${none(h.implants)}`,
      `Donor: ${h.organ_donor ? "Yes":"No"}`,
      `ICE1: ${iceRows[0] ? `${iceRows[0].name||""} ‚Äî ${iceRows[0].phone||""}` : ""}`,
      `ICE2: ${iceRows[1] ? `${iceRows[1].name||""} ‚Äî ${iceRows[1].phone||""}` : ""}`,
      `ICE3: ${iceRows[2] ? `${iceRows[2].name||""} ‚Äî ${iceRows[2].phone||""}` : ""}`,
      `URL: https://www.myqer.com/c/${code}`
    ];

    // Compaction strategy
    const limitsM = 900, limitsL = 1100;
    const shrink = (label, caps) => {
      const i = payload.findIndex(line=>line.startsWith(label));
      if (i<0) return;
      let v = payload[i].slice(label.length);
      const trimTo = (n)=>{ v = (v || "").slice(0, Math.max(n,0)); payload[i] = label + v; };
      for (const n of caps) {
        if (bytesLen(payload.join("\n")) <= limitsM) break;
        trimTo(n);
      }
    };
    const dropLine = (label) => {
      const i = payload.findIndex(line=>line.startsWith(label));
      if (i>=0) payload.splice(i,1);
    };

    // 1) Trim whitespace
    payload = payload.map(s=>s.replace(/\s+/g,' ').trim());

    // 2) Shrink long fields
    shrink("Allergies: ", [220,160,120]);
    shrink("Conditions: ",[300,180,120]);
    shrink("Meds: ",      [300,180,120]);
    shrink("Implants: ",  [220,160,120]);

    // 3) Drop fields in order while >900
    const dropOrder = ["Implants:", "Meds:", "Conditions:", "ICE3:", "ICE2:", "ICE1:"];
    for (const lbl of dropOrder) {
      if (bytesLen(payload.join("\n")) <= limitsM) break;
      dropLine(lbl);
    }

    // 4) Shorten URL to bare domain if needed
    if (bytesLen(payload.join("\n")) > limitsM) {
      const i = payload.findIndex(l=>l.startsWith("URL: "));
      if (i>=0) payload[i] = "URL: myqer.com";
    }

    // 5) If still too big at M, allow L (1100). If still >1100, reduce to minimal lines
    if (bytesLen(payload.join("\n")) > limitsL) {
      payload = [
        "MYQER\u2122 EMERGENCY CARD",
        `Code: ${code}`,
        `Name: ${none(p.full_name)}`,
        `DOB: ${p.dob || ""}`,
        `Blood: ${h.blood_type || ""}`,
        `Allergies: ${none(h.allergies)}`,
        `Donor: ${h.organ_donor ? "Yes":"No"}`,
        `ICE1: ${iceRows[0] ? `${iceRows[0].name||""} ‚Äî ${iceRows[0].phone||""}` : ""}`,
        `URL: https://www.myqer.com/c/${code}`
      ];
    }
    return { text: payload.join("\n"), level: (bytesLen(payload.join("\n"))<=limitsM?"M":"L") };
  }

  function renderLiveQR(code) {
    const url = `https://www.myqer.com/c/${code}`;
    const qrBox = F.qrCanvas();
    if (!qrBox) return;
    makeQR(qrBox, url, 240, "M");
    if (F.codeUnderQR()) F.codeUnderQR().textContent = code;
    if (F.cardUrl()) { F.cardUrl().value = url; F.cardUrl().setAttribute("value", url); }
    if (F.qrStatus()) F.qrStatus().textContent = t[LANG].qrLiveReady;
  }

  let offlineQRInstanceImgData = null;
  function renderOfflineQR(code, profile, health, iceRows) {
    const wrap = F.offlineQRwrap() || F.offlineQRbox();
    if (!wrap) return;
    clearQR(wrap);
    const { text, level } = buildOfflinePayload(code, profile, health, iceRows);
    makeQR(wrap, text, 240, level);
    try {
      // capture PNG from canvas (qrcodejs renders a <canvas> child)
      const canvas = wrap.querySelector("canvas");
      offlineQRInstanceImgData = canvas ? canvas.toDataURL("image/png") : null;
    } catch { offlineQRInstanceImgData = null; }
    showToast(t[LANG].qrOfflineReady, "success");
  }

  // ---- Triage scoring ----
  const TRIAGE_WORDS = [
    {k:/\banaphylaxis|anaphylactic|epi[-\s]?pen|epinephrine\b/i, s:3},
    {k:/\bheart attack|\bMI\b|myocardial infarction|vfib|vtach|cardiac arrest|ICD|defibrillator|pacemaker\b/i, s:3},
    {k:/\btransplant|immunosuppress|immunosuppression\b/i, s:2},
    {k:/\bsevere asthma|status asthmaticus|respiratory failure|COPD exacerbation\b/i, s:2},
    {k:/\bwarfarin|coumadin|anticoagulant|apixaban|rivaroxaban|heparin|dabigatran\b/i, s:2},
    {k:/\bseizure|epilep/i, s:2},
    {k:/\bdialysis|chemotherapy|metastatic|malignant cancer\b/i, s:2}
  ];
  function computeTriage(health) {
    if (!health) return "green";
    const override = (health.triage_override || "auto");
    if (override !== "auto") return override;
    const hay = [health.allergies, health.conditions, health.medications].join(" ").toLowerCase();
    let score = 0;
    TRIAGE_WORDS.forEach(r => { if (r.k.test(hay)) score += r.s; });
    return (score >= 6) ? "red" : (score >= 3) ? "amber" : "green";
  }
  function applyTriagePill(tr) {
    const pill = document.getElementById("triagePill");
    if (!pill) return;
    pill.className = `triage-pill triage-${tr}`;
    const span = pill.querySelector("span");
    if (span) span.textContent = t[LANG][tr] || tr;
  }

  // ---- CRUD ----
  let UID = null;
  let PROFILE = {};
  let HEALTH  = {};
  async function loadFromLocal() {
    try {
      const p = JSON.parse(localStorage.getItem(LS_KEYS.profile) || "null");
      const h = JSON.parse(localStorage.getItem(LS_KEYS.health) || "null");
      const i = JSON.parse(localStorage.getItem(LS_KEYS.ice) || "null");
      if (p) fillProfile(p);
      if (h) fillHealth(h);
      if (i) { ice = i; renderICE(); }
    } catch {}
  }
  function fillProfile(p) {
    PROFILE = p || {};
    if (F.fullName())  F.fullName().value  = p.full_name || "";
    if (F.dob())       F.dob().value       = p.dob || "";
    if (F.country())   F.country().value   = p.country || "";
    if (F.healthId())  F.healthId().value  = p.health_id || "";
  }
  function fillHealth(h) {
    HEALTH = h || {};
    if (F.bloodType()) F.bloodType().value = h.blood_type || "";
    if (F.allergies()) F.allergies().value = h.allergies || "";
    if (F.donor())     F.donor().checked   = !!h.organ_donor;
    if (F.conditions())F.conditions().value= h.conditions || "";
    if (F.meds())      F.meds().value      = h.medications || "";
    if (F.implants())  F.implants().value  = h.implants || "";
    if (F.triage())    F.triage().value    = h.triage_override || "auto";
    applyTriagePill(computeTriage(h));
  }

  async function fetchServer() {
    // profiles
    try {
      const { data: p } = await supabase.from("profiles").select("*").eq("id", UID).single();
      if (p) { fillProfile(p); localStorage.setItem(LS_KEYS.profile, JSON.stringify(p)); }
    } catch (e) { errorToast("profiles: " + (e?.message||"error")); }
    // health_data
    try {
      const { data: h } = await supabase.from("health_data").select("*").eq("user_id", UID).single();
      if (h) { fillHealth(h); localStorage.setItem(LS_KEYS.health, JSON.stringify(h)); }
    } catch (e) { /* table might be empty */ }
    // ice_contacts (0..2)
    try {
      const { data: rows } = await supabase.from("ice_contacts").select("*").eq("user_id", UID).order("contact_order");
      if (rows && Array.isArray(rows)) { ice = rows.slice(0,3); renderICE(); localStorage.setItem(LS_KEYS.ice, JSON.stringify(ice)); }
    } catch (e) { /* continue */ }
  }

  async function saveProfile(silent=false) {
    const data = getProfileData();
    try {
      const payload = { id: UID, ...data };
      const { error } = await supabase.from("profiles").upsert(payload).select().single();
      if (error) throw error;
      localStorage.setItem(LS_KEYS.profile, JSON.stringify(payload));
      if (!silent) showToast(t[LANG].profileSaved, "success");
      // If code missing on server, ensure it now
      const code = await ensureUserCode(UID);
      renderLiveQR(code);
    } catch (e) {
      if (!silent) errorToast(t[LANG].autoSaveFail);
      console.error(e);
    }
  }
  async function saveHealth(silent=false) {
    const data = getHealthData();
    try {
      const payload = { user_id: UID, ...data };
      const { error } = await supabase.from("health_data").upsert(payload, { onConflict:"user_id" });
      if (error) throw error;
      localStorage.setItem(LS_KEYS.health, JSON.stringify(payload));
      if (!silent) showToast(t[LANG].healthSaved, "success");
      applyTriagePill(computeTriage(payload));
    } catch (e) {
      if (!silent) errorToast(t[LANG].autoSaveFail);
      console.error(e);
    }
  }
  async function saveICE(silent=false) {
    try {
      // Upsert each row with composite PK (user_id, contact_order)
      for (let i=0;i<Math.min(3, ice.length);i++) {
        const r = { user_id: UID, contact_order: i, name: ice[i].name||null, relation: ice[i].relation||null, phone: ice[i].phone||null };
        const { error } = await supabase.from("ice_contacts").upsert(r, { onConflict:"user_id,contact_order" });
        if (error) throw error;
      }
      localStorage.setItem(LS_KEYS.ice, JSON.stringify(ice));
      if (!silent) showToast(t[LANG].iceSaved, "success");
    } catch (e) {
      if (!silent) errorToast(t[LANG].autoSaveFail);
      console.error(e);
    }
  }

  // ---- Delete cascade ----
  async function deleteAccountFlow() {
    const phrase = (F.deletePhrase()?.value || "").trim();
    if (phrase !== "DELETE MY ACCOUNT") {
      errorToast(t[LANG].deleteConfirm);
      return;
    }
    try {
      // Best-effort deletes; ignore missing tables
      await supabase.from("ice_contacts").delete().eq("user_id", UID);
      await supabase.from("health_data").delete().eq("user_id", UID);
      await supabase.from("profiles").delete().eq("id", UID);
      showToast(t[LANG].deleted, "success");
    } catch(e) {
      errorToast(t[LANG].deleteFail);
      console.error(e);
    } finally {
      await supabase.auth.signOut();
      localStorage.clear(); sessionStorage.clear();
      window.location.replace("/");
    }
  }

  // ---- Clipboard + Print ----
  async function copyCardUrl() {
    try {
      const url = F.cardUrl()?.value || "";
      await navigator.clipboard.writeText(url);
      showToast(t[LANG].copied, "success");
    } catch {
      // Safari fallback
      const input = F.cardUrl();
      if (input) { input.select(); document.execCommand("copy"); showToast(t[LANG].copied, "success"); }
      else errorToast("Copy failed");
    }
  }
  function openCardUrl() {
    const url = F.cardUrl()?.value || "";
    if (url) window.open(url, "_blank");
  }
  function downloadOfflinePNG() {
    if (offlineQRInstanceImgData) {
      const a = document.createElement("a");
      a.download = "myqer-offline-qr.png";
      a.href = offlineQRInstanceImgData;
      a.click();
      showToast(t[LANG].downloaded, "success");
    } else {
      errorToast("QR not ready");
    }
  }
  async function downloadLiveSVG() {
    // Fallback: re-generate SVG via qrcodejs doesn't export SVG; if your page includes another lib, wire here.
    // We provide a PNG download by printing; otherwise, skip SVG gracefully.
    errorToast("SVG export not supported by QR library in use");
  }
  function printCard() {
    const code = localStorage.getItem(LS_KEYS.code) || "";
    const url  = F.cardUrl()?.value || "";
    const liveQRCanvas = (F.qrCanvas() || document).querySelector("canvas");
    const imgData = liveQRCanvas ? liveQRCanvas.toDataURL("image/png") : "";
    const win = window.open("", "_blank");
    win.document.write(`
      <html><head><title>MYQER ‚Äî ${code}</title>
      <style>
      body{font-family:Inter,Arial,sans-serif;text-align:center;padding:40px;background:#fff}
      .card{border:3px solid #dc2626;border-radius:20px;padding:40px;max-width:520px;margin:0 auto}
      .logo{font-size:28px;font-weight:900;color:#dc2626;margin-bottom:16px;letter-spacing:2px}
      .code{font-family:monospace;font-size:22px;font-weight:900;margin:16px 0;letter-spacing:3px}
      .url{font-size:14px;color:#666;word-break:break-all;margin-top:10px;font-family:monospace}
      </style></head><body>
      <div class="card">
        <div class="logo">MYQER‚Ñ¢ EMERGENCY CARD</div>
        <div><img src="${imgData}" width="250" height="250" style="border:2px solid #e2e8f0;border-radius:12px"/></div>
        <div class="code">${code}</div>
        <div class="url">${url}</div>
      </div>
      </body></html>`);
    win.document.close();
    win.print();
  }

  // ---- i18n apply (labels present in your DOM already) ----
  function applyI18N() {
    localStorage.setItem("myqer_language", LANG);
    // Update online pill text if any
    updateOnlineBanner();
  }

  // ---- Init flow (spinner assumed present in your UI) ----
  async function init() {
    try {
      // Gate
      const session = await requireSession();
      UID = session.user.id;

      updateOnlineBanner();

      // Load local first
      await loadFromLocal();

      // Server wins
      await fetchServer();

      // Short code + QRs
      const code = await ensureUserCode(UID);
      renderLiveQR(code);
      renderOfflineQR(code, PROFILE || getProfileData(), HEALTH || getHealthData(), ice || []);

      // Wire buttons
      F.btnSaveProfile()?.addEventListener("click", ()=>saveProfile(false));
      F.btnSaveHealth()?.addEventListener("click", ()=>saveHealth(false));
      F.btnSaveIce()?.addEventListener("click",    ()=>saveICE(false));
      F.btnSignOut()?.addEventListener("click", async ()=>{
        showToast(t[LANG].logout, "info");
        await supabase.auth.signOut();
        localStorage.clear(); sessionStorage.clear();
        window.location.replace("/");
      });
      F.btnCopy()?.addEventListener("click", copyCardUrl);
      F.btnOpen()?.addEventListener("click", openCardUrl);
      F.btnDlPNG()?.addEventListener("click", downloadOfflinePNG);
      F.btnDlSVG()?.addEventListener("click", downloadLiveSVG);
      F.btnPrint()?.addEventListener("click", printCard);
      F.deleteBtn()?.addEventListener("click", deleteAccountFlow);

      // Add ICE
      F.addIce()?.addEventListener("click", ()=>{
        if (ice.length >= 3) { errorToast("Max 3 contacts"); return; }
        ice.push({ user_id: UID, contact_order: ice.length, name:"", relation:"", phone:"" });
        renderICE();
      });

      // Inputs autosave
      [F.fullName(),F.dob(),F.country(),F.healthId()].forEach(el=>{
        el && el.addEventListener("input", ()=>{ scheduleAutoSave("profile"); });
      });
      [F.bloodType(),F.allergies(),F.donor(),F.conditions(),F.meds(),F.implants(),F.triage()].forEach(el=>{
        if (!el) return;
        const ev = (el.type==="checkbox")?"change":"input";
        el.addEventListener(ev, ()=>{
          if (el===F.triage()) applyTriagePill(computeTriage(getHealthData()));
          scheduleAutoSave("health");
        });
      });

      // Language switcher (if you have a dropdown, just set LANG then apply)
      document.querySelectorAll('.language-option')?.forEach(opt=>{
        opt.addEventListener("click", ()=>{
          const lang = (opt.getAttribute("onclick")||"").match(/changeLanguage\('(.+?)'\)/);
          LANG = lang ? lang[1] : (opt.dataset.lang || "en");
          applyI18N();
        });
      });

      applyI18N();
      // Spinner off if you have one
      const loading = document.getElementById("loadingScreen");
      const dashboard= document.getElementById("dashboard");
      if (loading && dashboard) { loading.classList.add("hidden"); dashboard.classList.remove("hidden"); }

    } catch (e) {
      console.error(e);
      const loading = document.getElementById("loadingScreen");
      const dashboard= document.getElementById("dashboard");
      if (loading && dashboard) { loading.classList.add("hidden"); dashboard.classList.remove("hidden"); }
      errorToast(t[LANG].fatal + ": " + (e?.message || "init"));
    }
  }

  // ---- Re-generate QR on demand if you keep a "Regenerate" button ----
  window.generateQRCode = async function() {
    const code = await ensureUserCode(UID); // keep same immutable code (do NOT change per requirements)
    renderLiveQR(code);
    renderOfflineQR(code, getProfileData(), getHealthData(), ice || []);
  };

  // Expose for inline logout if your old markup uses onclick="logout()"
  window.logout = async function(){
    await supabase.auth.signOut();
    localStorage.clear(); sessionStorage.clear();
    window.location.replace("/");
  };

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
        // Global Variables
        let currentUser = { email: 'user@example.com', id: 'demo-user-123' };
        let iceContacts = [];
        let idleTimer = null;
        let warningTimer = null;
        let countdownTimer = null;
        let countdownSeconds = 60;
        let debounceTimers = {};
        let isOnline = navigator.onLine;
        let currentLanguage = 'en';
        let userCode = 'MQ7X9K';
        let isGeneratingQR = false;

        // Fatal Keywords for Triage
        const FATAL_KEYWORDS = [
            'anaphylaxis', 'anaphylactic', 'epi-pen', 'epipen', 'epinephrine', 'shock', 'cardiac arrest',
            'heart attack', 'stroke', 'seizure', 'epilepsy', 'pacemaker', 'defibrillator', 'insulin pump',
            'severe asthma', 'hemophilia', 'blood clotting', 'bleeding disorder', 'life threatening',
            'critical', 'emergency', 'fatal', 'deadly', 'aneurysm', 'transplant', 'dialysis',
            'chemotherapy', 'radiation', 'cancer', 'tumor', 'malignant', 'metastatic'
        ];

        // Translations Object
        const translations = {
            en: {
                offline_mode: "You're offline. Changes will sync when connection is restored.",
                online_status: "Online",
                logout: "Logout",
                identity_title: "Identity ‚Äî Personal Information",
                identity_subtitle: "Your basic personal and identification details",
                save: "Save",
                full_name: "Full Name",
                full_name_help: "Enter your complete legal name as it appears on official documents",
                date_of_birth: "Date of Birth",
                dob_help: "Used for age verification in medical emergencies",
                country: "Country",
                country_help: "Helps emergency responders understand local medical systems",
                health_id: "National/Health ID (Optional)",
                health_id_help: "National health identifier for faster medical record access",
                critical_title: "CRITICAL ‚Äî Medical & Health Details",
                critical_subtitle: "Life-saving medical information for emergency responders",
                auto: "Auto",
                green: "Green",
                amber: "Amber",
                red: "Red",
                black: "Black",
                blood_type: "Blood Type",
                blood_type_help: "Critical for blood transfusions and medical procedures",
                allergies: "Critical Allergies",
                allergies_help: "List all known allergies that could cause severe reactions",
                conditions: "Medical Conditions",
                conditions_help: "Include chronic diseases, mental health conditions, and ongoing treatments",
                medications: "Current Medications",
                medications_help: "Include prescription drugs, over-the-counter medications, and supplements",
                implants: "Implants/Medical Devices",
                implants_help: "Medical devices that could affect treatment or require special consideration",
                organ_donor: "I am an organ donor",
                organ_donor_help: "Indicates your consent for organ donation in case of brain death",
                ice_title: "Emergency Contacts (ICE)",
                ice_subtitle: "People to contact in case of emergency (maximum 3 contacts)",
                add_contact: "Add Contact",
                save_all: "Save All",
                qr_title: "Emergency Card & QR Code",
                qr_subtitle: "Your unique emergency medical information access code",
                copy: "Copy",
                open: "Open",
                download_png: "Download PNG",
                download_svg: "Download SVG",
                print: "Print Card",
                regenerate: "Regenerate",
                delete_title: "Delete Account",
                delete_warning: "This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers. Your emergency contacts will no longer be able to access your medical information.",
                delete_confirm_label: "Type \"DELETE MY ACCOUNT\" to confirm:",
                delete_account: "Delete My Account Permanently",
                copyright: "¬© 2024 MYQER. All rights reserved. Saving lives through technology.",
                privacy_policy: "Privacy Policy",
                terms_of_service: "Terms of Service",
                support: "Support",
                about: "About MYQER",
                saving: "Saving...",
                session_expiring: "Session Expiring",
                session_expire_text: "Your session will expire in",
                seconds: "seconds due to inactivity.",
                stay_logged_in: "Stay Logged In",
                contact_name: "Name",
                contact_relationship: "Relationship",
                contact_phone: "Phone",
                remove: "Remove",
                no_contacts: "No emergency contacts added yet. Click \"Add Contact\" to get started.",
                profile_saved: "Profile saved successfully",
                health_saved: "Health data saved successfully",
                ice_saved: "Emergency contacts saved successfully",
                url_copied: "URL copied to clipboard",
                qr_downloaded: "QR code downloaded successfully",
                account_deleted: "Account deleted successfully",
                save_error: "Failed to save data",
                network_error: "Network error. Please check your connection.",
                validation_error: "Please fill in all required fields",
                max_contacts: "Maximum 3 emergency contacts allowed",
                confirm_delete: "Please type \"DELETE MY ACCOUNT\" exactly to confirm"
            },
            es: {
                offline_mode: "Est√°s desconectado. Los cambios se sincronizar√°n cuando se restaure la conexi√≥n.",
                online_status: "En l√≠nea",
                logout: "Cerrar Sesi√≥n",
                identity_title: "Identidad ‚Äî Informaci√≥n Personal",
                identity_subtitle: "Tus datos personales b√°sicos y de identificaci√≥n",
                save: "Guardar",
                full_name: "Nombre Completo",
                full_name_help: "Ingresa tu nombre legal completo como aparece en documentos oficiales",
                date_of_birth: "Fecha de Nacimiento",
                dob_help: "Usado para verificaci√≥n de edad en emergencias m√©dicas",
                country: "Pa√≠s",
                country_help: "Ayuda a los socorristas a entender los sistemas m√©dicos locales",
                health_id: "ID Nacional/Salud (Opcional)",
                health_id_help: "Identificador nacional de salud para acceso m√°s r√°pido a registros m√©dicos",
                critical_title: "CR√çTICO ‚Äî Detalles M√©dicos y de Salud",
                critical_subtitle: "Informaci√≥n m√©dica vital para socorristas de emergencia",
                auto: "Auto",
                green: "Verde",
                amber: "√Åmbar",
                red: "Rojo",
                black: "Negro",
                blood_type: "Tipo de Sangre",
                blood_type_help: "Cr√≠tico para transfusiones de sangre y procedimientos m√©dicos",
                allergies: "Alergias Cr√≠ticas",
                allergies_help: "Lista todas las alergias conocidas que podr√≠an causar reacciones severas",
                conditions: "Condiciones M√©dicas",
                conditions_help: "Incluye enfermedades cr√≥nicas, condiciones de salud mental y tratamientos en curso",
                medications: "Medicamentos Actuales",
                medications_help: "Incluye medicamentos recetados, de venta libre y suplementos",
                implants: "Implantes/Dispositivos M√©dicos",
                implants_help: "Dispositivos m√©dicos que podr√≠an afectar el tratamiento o requerir consideraci√≥n especial",
                organ_donor: "Soy donante de √≥rganos",
                organ_donor_help: "Indica tu consentimiento para donaci√≥n de √≥rganos en caso de muerte cerebral",
                ice_title: "Contactos de Emergencia (ICE)",
                ice_subtitle: "Personas a contactar en caso de emergencia (m√°ximo 3 contactos)",
                add_contact: "Agregar Contacto",
                save_all: "Guardar Todo",
                qr_title: "Tarjeta de Emergencia y C√≥digo QR",
                qr_subtitle: "Tu c√≥digo √∫nico de acceso a informaci√≥n m√©dica de emergencia",
                copy: "Copiar",
                open: "Abrir",
                download_png: "Descargar PNG",
                download_svg: "Descargar SVG",
                print: "Imprimir Tarjeta",
                regenerate: "Regenerar",
                delete_title: "Eliminar Cuenta",
                delete_warning: "Esta acci√≥n no se puede deshacer. Todos tus datos m√©dicos de emergencia, c√≥digos QR e informaci√≥n de perfil ser√°n eliminados permanentemente de nuestros servidores. Tus contactos de emergencia ya no podr√°n acceder a tu informaci√≥n m√©dica.",
                delete_confirm_label: "Escribe \"DELETE MY ACCOUNT\" para confirmar:",
                delete_account: "Eliminar Mi Cuenta Permanentemente",
                copyright: "¬© 2024 MYQER. Todos los derechos reservados. Salvando vidas a trav√©s de la tecnolog√≠a.",
                privacy_policy: "Pol√≠tica de Privacidad",
                terms_of_service: "T√©rminos de Servicio",
                support: "Soporte",
                about: "Acerca de MYQER",
                saving: "Guardando...",
                session_expiring: "Sesi√≥n Expirando",
                session_expire_text: "Tu sesi√≥n expirar√° en",
                seconds: "segundos debido a inactividad.",
                stay_logged_in: "Mantener Sesi√≥n",
                contact_name: "Nombre",
                contact_relationship: "Relaci√≥n",
                contact_phone: "Tel√©fono",
                remove: "Eliminar",
                no_contacts: "No se han agregado contactos de emergencia a√∫n. Haz clic en \"Agregar Contacto\" para comenzar.",
                profile_saved: "Perfil guardado exitosamente",
                health_saved: "Datos de salud guardados exitosamente",
                ice_saved: "Contactos de emergencia guardados exitosamente",
                url_copied: "URL copiada al portapapeles",
                qr_downloaded: "C√≥digo QR descargado exitosamente",
                account_deleted: "Cuenta eliminada exitosamente",
                save_error: "Error al guardar datos",
                network_error: "Error de red. Por favor verifica tu conexi√≥n.",
                validation_error: "Por favor completa todos los campos requeridos",
                max_contacts: "M√°ximo 3 contactos de emergencia permitidos",
                confirm_delete: "Por favor escribe \"DELETE MY ACCOUNT\" exactamente para confirmar"
            }
        };

        // Initialize Application
        async function init() {
            try {
                // Update UI with user info
                updateUserInfo();
                
                // Setup event listeners
                setupOnlineDetection();
                setupEventListeners();
                
                // Load saved language
                const savedLanguage = localStorage.getItem('myqer_language') || 'en';
                changeLanguage(savedLanguage);
                
                // Load all data
                await loadAll();
                
                // Setup auto-save and idle timer
                setupAutosave();
                setupIdleTimer();
                
                // Hide loading screen and show dashboard
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    // Add entrance animations
                    document.querySelectorAll('.card').forEach((card, index) => {
                        setTimeout(() => {
                            card.style.opacity = '0';
                            card.style.transform = 'translateY(30px)';
                            card.style.transition = 'all 0.6s ease-out';
                            setTimeout(() => {
                                card.style.opacity = '1';
                                card.style.transform = 'translateY(0)';
                            }, 50);
                        }, index * 150);
                    });
                }, 2000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to load dashboard', 'error');
            }
        }

        // Update user information in header
        function updateUserInfo() {
            const email = currentUser.email;
            document.getElementById('userEmail').textContent = email;
            
            // Set user avatar initial
            const initial = email.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = initial;
        }

        // Generate random code
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Data getter functions
        function getProfileData() {
            return {
                fullName: document.getElementById('fullName').value.trim() || null,
                dob: document.getElementById('dob').value || null,
                country: document.getElementById('country').value || null,
                healthId: document.getElementById('healthId').value.trim() || null
            };
        }

        function getHealthData() {
            return {
                bloodType: document.getElementById('bloodType').value || null,
                allergies: document.getElementById('allergies').value.trim() || null,
                conditions: document.getElementById('conditions').value.trim() || null,
                medications: document.getElementById('medications').value.trim() || null,
                implants: document.getElementById('implants').value.trim() || null,
                organDonor: document.getElementById('organDonor').checked,
                triageOverride: document.getElementById('triageOverride').value || 'auto'
            };
        }

        function getICEData() {
            return iceContacts.map(contact => ({
                name: contact.name?.trim() || null,
                relation: contact.relation?.trim() || null,
                phone: contact.phone?.trim() || null
            }));
        }

        // QR Code generation
        async function generateQRCode() {
            if (isGeneratingQR) return;
            isGeneratingQR = true;
            
            try {
                userCode = generateRandomCode();
                const liveUrl = `https://www.myqer.com/c/${userCode}`;
                const box = document.getElementById('qrcode');
                box.innerHTML = '';
                
                await QRCode.toCanvas(box, liveUrl, { 
                    width: 240, 
                    margin: 1,
                    color: {
                        dark: '#0f172a',
                        light: '#ffffff'
                    }
                });
                
                document.getElementById('qrCodeText').textContent = userCode;
                document.getElementById('cardUrl').value = liveUrl;
                
                showToast('QR code generated successfully', 'success');
            } catch (error) {
                console.error('QR generation error:', error);
                showToast('Failed to generate QR code', 'error');
            } finally {
                isGeneratingQR = false;
            }
        }

        // Load all data
        async function loadAll() {
            try {
                // Load data from localStorage
                await loadFromLocalStorage();
                
                // Generate QR code
                await generateQRCode();
                
            } catch (error) {
                console.error('Load error:', error);
                showToast('Failed to load data', 'error');
            }
        }

        // Load data from localStorage to UI
        async function loadFromLocalStorage() {
            // Load profile data
            const profileData = localStorage.getItem('myqer_profile');
            if (profileData) {
                const data = JSON.parse(profileData);
                document.getElementById('fullName').value = data.fullName || '';
                document.getElementById('dob').value = data.dob || '';
                document.getElementById('country').value = data.country || '';
                document.getElementById('healthId').value = data.healthId || '';
            }

            // Load health data
            const healthData = localStorage.getItem('myqer_health');
            if (healthData) {
                const data = JSON.parse(healthData);
                document.getElementById('bloodType').value = data.bloodType || '';
                document.getElementById('allergies').value = data.allergies || '';
                document.getElementById('conditions').value = data.conditions || '';
                document.getElementById('medications').value = data.medications || '';
                document.getElementById('implants').value = data.implants || '';
                document.getElementById('organDonor').checked = !!data.organDonor;
                document.getElementById('triageOverride').value = data.triageOverride || 'auto';
            }

            // Load ICE contacts
            const iceData = localStorage.getItem('myqer_ice');
            if (iceData) {
                iceContacts = JSON.parse(iceData);
                renderICE();
            }

            // Update triage
            updateTriage();
        }

        // Auto-triage system
        function updateTriage() {
            const override = document.getElementById('triageOverride').value;
            const pill = document.getElementById('triagePill');
            const pillText = pill.querySelector('span');
            
            if (override !== 'auto') {
                pill.className = `triage-pill triage-${override}`;
                pillText.textContent = translations[currentLanguage][override];
                return;
            }
            
            const allergies = document.getElementById('allergies').value.toLowerCase();
            const conditions = document.getElementById('conditions').value.toLowerCase();
            const medications = document.getElementById('medications').value.toLowerCase();
            const implants = document.getElementById('implants').value.toLowerCase();
            
            // Check for fatal keywords
            let isFatal = false;
            const allText = `${allergies} ${conditions} ${medications} ${implants}`;
            FATAL_KEYWORDS.forEach(keyword => {
                if (allText.includes(keyword.toLowerCase())) {
                    isFatal = true;
                }
            });
            
            if (isFatal) {
                pill.className = 'triage-pill triage-red';
                pillText.textContent = translations[currentLanguage]['red'];
            } else if (allergies.trim() || conditions.trim() || implants.trim()) {
                pill.className = 'triage-pill triage-amber';
                pillText.textContent = translations[currentLanguage]['amber'];
            } else {
                pill.className = 'triage-pill triage-green';
                pillText.textContent = translations[currentLanguage]['green'];
            }
        }

        // Save functions
        async function saveProfile() {
            try {
                showSavingIndicator();
                
                const profileData = getProfileData();
                
                // Validation
                if (!profileData.fullName) {
                    showToast(translations[currentLanguage]['validation_error'], 'error');
                    return;
                }
                
                localStorage.setItem('myqer_profile', JSON.stringify(profileData));
                showToast(translations[currentLanguage]['profile_saved'], 'success');
                await generateQRCode();
                
            } catch (error) {
                console.error('Save profile error:', error);
                showToast(translations[currentLanguage]['save_error'], 'error');
            } finally {
                hideSavingIndicator();
            }
        }

        async function saveHealth() {
            try {
                showSavingIndicator();
                
                const healthData = getHealthData();
                localStorage.setItem('myqer_health', JSON.stringify(healthData));
                
                showToast(translations[currentLanguage]['health_saved'], 'success');
                updateTriage();
                await generateQRCode();
                
            } catch (error) {
                console.error('Save health error:', error);
                showToast(translations[currentLanguage]['save_error'], 'error');
            } finally {
                hideSavingIndicator();
            }
        }

        async function saveICE() {
            try {
                showSavingIndicator();
                
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                showToast(translations[currentLanguage]['ice_saved'], 'success');
                await generateQRCode();
                
            } catch (error) {
                console.error('Save ICE error:', error);
                showToast(translations[currentLanguage]['save_error'], 'error');
            } finally {
                hideSavingIndicator();
            }
        }

        // ICE Contact Management
        function addContact() {
            if (iceContacts.length >= 3) {
                showToast(translations[currentLanguage]['max_contacts'], 'error');
                return;
            }
            
            const newContact = {
                id: Date.now().toString(),
                name: '',
                relation: '',
                phone: ''
            };
            
            iceContacts.push(newContact);
            renderICE();
            updateAddContactButton();
        }

        function removeContact(id) {
            iceContacts = iceContacts.filter(contact => contact.id !== id);
            renderICE();
            updateAddContactButton();
        }

        function updateContact(id, field, value) {
            const contact = iceContacts.find(c => c.id === id);
            if (contact) {
                contact[field] = value;
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
            }
        }

        function updateAddContactButton() {
            const btn = document.getElementById('addContactBtn');
            if (iceContacts.length >= 3) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-ban"></i> <span>Maximum Reached</span>';
            } else {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-plus"></i> <span data-i18n="add_contact">${translations[currentLanguage]['add_contact']}</span>`;
            }
        }

        function renderICE() {
            const container = document.getElementById('iceContacts');
            
            if (iceContacts.length === 0) {
                container.innerHTML = `
                    <div class="no-contacts">
                        <div class="no-contacts-icon">
                            <i class="fas fa-address-book"></i>
                        </div>
                        <div data-i18n="no_contacts">${translations[currentLanguage]['no_contacts']}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = iceContacts.map((contact, index) => `
                <div class="ice-contact">
                    <div class="ice-contact-header">
                        <h4 class="ice-contact-title">
                            <div class="ice-contact-number">${index + 1}</div>
                            Emergency Contact ${index + 1}
                        </h4>
                        <button class="btn btn-danger btn-sm" onclick="removeContact('${contact.id}')">
                            <i class="fas fa-trash"></i>
                            <span data-i18n="remove">${translations[currentLanguage]['remove']}</span>
                        </button>
                    </div>
                    <div class="ice-grid">
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_name">${translations[currentLanguage]['contact_name']}</label>
                            <input type="text" class="form-input" value="${contact.name || ''}" 
                                   onchange="updateContact('${contact.id}', 'name', this.value)"
                                   placeholder="Full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_relationship">${translations[currentLanguage]['contact_relationship']}</label>
                            <input type="text" class="form-input" value="${contact.relation || ''}" 
                                   onchange="updateContact('${contact.id}', 'relation', this.value)"
                                   placeholder="e.g., Spouse, Parent, Sibling">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_phone">${translations[currentLanguage]['contact_phone']}</label>
                            <input type="tel" class="form-input" value="${contact.phone || ''}" 
                                   onchange="updateContact('${contact.id}', 'phone', this.value)"
                                   placeholder="+1 (555) 123-4567">
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateAddContactButton();
        }

        // QR Code Actions
        function copyUrl() {
            const urlInput = document.getElementById('cardUrl');
            urlInput.select();
            document.execCommand('copy');
            showToast(translations[currentLanguage]['url_copied'], 'success');
        }

        function openUrl() {
            const url = document.getElementById('cardUrl').value;
            window.open(url, '_blank');
        }

        async function downloadQR(format) {
            try {
                const canvas = document.querySelector('#qrcode canvas');
                if (!canvas) {
                    showToast('QR code not generated yet', 'error');
                    return;
                }
                
                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = `myqer-${userCode || 'emergency'}-card.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else if (format === 'svg') {
                    const liveUrl = `https://www.myqer.com/c/${userCode}`;
                    const svg = await QRCode.toString(liveUrl, { type: 'svg' });
                    const blob = new Blob([svg], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `myqer-${userCode || 'emergency'}-card.svg`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }
                
                showToast(translations[currentLanguage]['qr_downloaded'], 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download QR code', 'error');
            }
        }

        function printQR() {
            const canvas = document.querySelector('#qrcode canvas');
            const code = document.getElementById('qrCodeText').textContent;
            const url = document.getElementById('cardUrl').value;
            
            if (!canvas) {
                showToast('QR code not generated yet', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>MYQER Emergency Card - ${code}</title>
                    <style>
                        body { 
                            font-family: 'Inter', Arial, sans-serif; 
                            text-align: center; 
                            padding: 40px; 
                            background: white;
                        }
                        .card { 
                            border: 3px solid #dc2626; 
                            border-radius: 20px; 
                            padding: 40px; 
                            max-width: 500px; 
                            margin: 0 auto; 
                            background: white;
                        }
                        .logo { 
                            font-size: 32px; 
                            font-weight: 900; 
                            color: #dc2626; 
                            margin-bottom: 20px; 
                            letter-spacing: 2px;
                        }
                        .code { 
                            font-family: 'Monaco', monospace; 
                            font-size: 24px; 
                            font-weight: 900; 
                            margin: 20px 0; 
                            letter-spacing: 3px;
                        }
                        .url { 
                            font-size: 14px; 
                            color: #666; 
                            word-break: break-all; 
                            margin-top: 20px; 
                            font-family: 'Monaco', monospace;
                        }
                        .qr { 
                            margin: 30px 0; 
                        }
                        .instructions {
                            font-size: 14px; 
                            color: #666; 
                            margin-top: 30px; 
                            line-height: 1.6;
                        }
                        @media print { 
                            body { margin: 0; } 
                            .card { box-shadow: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <div class="logo">MYQER‚Ñ¢ EMERGENCY CARD</div>
                        <div class="qr">
                            <img src="${canvas.toDataURL()}" alt="QR Code" style="width: 250px; height: 250px; border: 2px solid #e2e8f0; border-radius: 12px;">
                        </div>
                        <div class="code">${code}</div>
                        <div class="url">${url}</div>
                        <div class="instructions">
                            <strong>EMERGENCY ACCESS INSTRUCTIONS:</strong><br>
                            1. Scan QR code with any smartphone camera<br>
                            2. Or visit the URL above in any web browser<br>
                            3. Access critical medical information instantly<br><br>
                            <em>Keep this card in your wallet, purse, or vehicle for emergency access to your medical information.</em>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Language Management
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('show');
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.language-selector')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('myqer_language', lang);
            
            const flags = {
                en: 'üá∫üá∏ EN', es: 'üá™üá∏ ES', fr: 'üá´üá∑ FR', de: 'üá©üá™ DE',
                it: 'üáÆüáπ IT', pt: 'üáµüáπ PT', ro: 'üá∑üá¥ RO', ar: 'üá∏üá¶ AR',
                hi: 'üáÆüá≥ HI', zh: 'üá®üá≥ ZH'
            };
            
            document.getElementById('currentLanguage').textContent = flags[lang];
            
            // Update active language option
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[onclick="changeLanguage('${lang}')"]`).classList.add('active');
            
            document.getElementById('languageDropdown').classList.remove('show');
            
            applyTranslations();
            renderICE();
        }

        function applyTranslations() {
            const t = translations[currentLanguage];
            
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
        }

        // Online/Offline Detection
        function setupOnlineDetection() {
            function updateOnlineStatus() {
                isOnline = navigator.onLine;
                const banner = document.getElementById('offlineBanner');
                const statusElement = document.querySelector('[data-i18n="online_status"]');
                
                if (isOnline) {
                    banner.classList.remove('show');
                    if (statusElement) statusElement.textContent = translations[currentLanguage]['online_status'] || 'Online';
                } else {
                    banner.classList.add('show');
                    if (statusElement) statusElement.textContent = 'Offline';
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        // Auto-save Setup
        function setupAutosave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const section = getInputSection(input.id);
                    if (section) {
                        debounceAutosave(section);
                    }
                    
                    // Update triage for health inputs
                    if (['allergies', 'conditions', 'medications', 'implants', 'bloodType', 'triageOverride'].includes(input.id)) {
                        updateTriage();
                    }
                });
            });
        }

        function getInputSection(inputId) {
            const profileInputs = ['fullName', 'dob', 'country', 'healthId'];
            const healthInputs = ['bloodType', 'allergies', 'conditions', 'medications', 'implants', 'organDonor', 'triageOverride'];
            
            if (profileInputs.includes(inputId)) return 'profile';
            if (healthInputs.includes(inputId)) return 'health';
            return null;
        }

        function debounceAutosave(section) {
            if (debounceTimers[section]) {
                clearTimeout(debounceTimers[section]);
            }
            
            debounceTimers[section] = setTimeout(() => {
                if (section === 'profile') saveProfile();
                else if (section === 'health') saveHealth();
            }, 2000);
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            saveProfile();
                            break;
                        case 'q':
                            e.preventDefault();
                            generateQRCode();
                            break;
                    }
                }
            });
            
            // Form validation
            document.querySelectorAll('input[required]').forEach(input => {
                input.addEventListener('blur', validateInput);
            });
        }

        function validateInput(e) {
            const input = e.target;
            const value = input.value.trim();
            
            if (input.hasAttribute('required') && !value) {
                input.classList.add('error');
                showFieldError(input, 'This field is required');
            } else {
                input.classList.remove('error');
                hideFieldError(input);
            }
        }

        function showFieldError(input, message) {
            let errorElement = input.parentNode.querySelector('.form-error');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'form-error';
                input.parentNode.appendChild(errorElement);
            }
            errorElement.textContent = message;
        }

        function hideFieldError(input) {
            const errorElement = input.parentNode.querySelector('.form-error');
            if (errorElement) {
                errorElement.remove();
            }
        }

        // Idle Timer Setup
        function setupIdleTimer() {
            const IDLE_TIME = 30 * 60 * 1000; // 30 minutes
            const WARNING_TIME = 60 * 1000; // 1 minute warning
            
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                clearTimeout(warningTimer);
                clearInterval(countdownTimer);
                document.getElementById('idleModal').classList.remove('show');
                
                idleTimer = setTimeout(() => {
                    showIdleWarning();
                }, IDLE_TIME - WARNING_TIME);
            }
            
            function showIdleWarning() {
                document.getElementById('idleModal').classList.add('show');
                countdownSeconds = 60;
                document.getElementById('countdown').textContent = countdownSeconds;
                
                countdownTimer = setInterval(() => {
                    countdownSeconds--;
                    document.getElementById('countdown').textContent = countdownSeconds;
                    
                    if (countdownSeconds <= 0) {
                        logout();
                    }
                }, 1000);
                
                warningTimer = setTimeout(() => {
                    logout();
                }, WARNING_TIME);
            }
            
            // Make resetIdleTimer globally accessible
            window.resetIdleTimer = resetIdleTimer;
            
            // Activity event listeners
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetIdleTimer, true);
            });
            
            resetIdleTimer();
        }

        // Account Deletion
        async function deleteAccount() {
            const confirmText = document.getElementById('deleteConfirm').value;
            
            if (confirmText !== 'DELETE MY ACCOUNT') {
                showToast(translations[currentLanguage]['confirm_delete'], 'error');
                return;
            }
            
            try {
                showSavingIndicator();
                
                // Clear local storage
                localStorage.clear();
                
                showToast(translations[currentLanguage]['account_deleted'], 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Delete account error:', error);
                showToast('Failed to delete account', 'error');
            } finally {
                hideSavingIndicator();
            }
        }

        // Logout Function
        async function logout() {
            try {
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'index.html';
            }
        }

        // UI Helper Functions
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const messageEl = toast.querySelector('.toast-message');
            const iconEl = toast.querySelector('.toast-icon');
            
            messageEl.textContent = message;
            
            // Set icon based on type
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            iconEl.className = `toast-icon ${icons[type] || icons.info}`;
            toast.className = `toast ${type} show`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideToast();
            }, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('show');
        }

        function showSavingIndicator() {
            document.getElementById('savingIndicator').classList.add('show');
        }

        function hideSavingIndicator() {
            document.getElementById('savingIndicator').classList.remove('show');
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
