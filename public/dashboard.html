<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #0f172a;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #c62828, #d32f2f);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 18px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 800;
            color: #0f172a;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: #475569;
            font-size: 14px;
        }

        .logout-btn {
            background: none;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            border-color: #c62828;
            color: #c62828;
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: 24px 0 0 24px;
        }

        .card.identity::before {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .card.critical::before {
            background: linear-gradient(135deg, #c62828, #d32f2f);
        }

        .card.ice::before {
            background: linear-gradient(135deg, #ea580c, #f97316);
        }

        .card.emergency {
            background: linear-gradient(135deg, rgba(198, 40, 40, 0.05), rgba(211, 47, 47, 0.05));
        }

        .card.emergency::before {
            background: linear-gradient(135deg, #c62828, #d32f2f);
        }

        .card.delete {
            background: linear-gradient(135deg, rgba(198, 40, 40, 0.02), rgba(211, 47, 47, 0.02));
            border: 2px solid rgba(198, 40, 40, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .triage-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .triage-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .triage-green {
            background: #059669;
            color: white;
        }

        .triage-amber {
            background: #ea580c;
            color: white;
        }

        .triage-red {
            background: #c62828;
            color: white;
        }

        .triage-black {
            background: #1f2937;
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #c62828;
            box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 16px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #c62828;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #c62828, #d32f2f);
            color: white;
            box-shadow: 0 4px 16px rgba(198, 40, 40, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(198, 40, 40, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #c62828;
            border: 2px solid #c62828;
        }

        .btn-secondary:hover {
            background: #c62828;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ea580c, #f97316);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
        }

        .ice-contact {
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .ice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            text-align: center;
        }

        .qr-box {
            width: 240px;
            height: 240px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .qr-code {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 24px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: 2px;
        }

        .qr-label {
            font-size: 12px;
            color: #c62828;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .url-group {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .url-input {
            flex: 1;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 8px;
        }

        .qr-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .delete-section {
            text-align: center;
            padding: 40px;
        }

        .delete-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 16px;
        }

        .delete-warning {
            color: #6b7280;
            margin-bottom: 32px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .confirm-input {
            max-width: 300px;
            margin: 0 auto 24px;
            text-align: center;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .toast.error {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 16px;
        }

        .modal-text {
            color: #6b7280;
            margin-bottom: 32px;
        }

        .modal-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .footer {
            margin-top: 80px;
            padding: 40px 0;
            border-top: 1px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
        }

        .footer-links {
            display: flex;
            gap: 32px;
        }

        .footer-link {
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: #c62828;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #c62828;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 24px;
            }

            .qr-actions {
                flex-direction: column;
            }

            .url-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="container">
            <header class="header">
                <div class="logo">
                    <div class="logo-icon">M</div>
                    <div class="logo-text">MYQER</div>
                </div>
                <div class="user-info">
                    <span id="userEmail">Loading...</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </header>

            <!-- Identity Section -->
            <div class="card identity">
                <div class="card-header">
                    <h2 class="card-title">Identity — Personal Information</h2>
                    <button class="btn btn-success" onclick="saveProfile()">Save</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="fullName" class="form-input" placeholder="Enter your full legal name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" id="dob" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <select id="country" class="form-select">
                            <option value="">Select Country</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">National/Health ID (Optional)</label>
                        <input type="text" id="healthId" class="form-input" placeholder="e.g., SSN, NHS Number">
                    </div>
                </div>
            </div>

            <!-- Critical Medical Section -->
            <div class="card critical">
                <div class="card-header">
                    <h2 class="card-title">CRITICAL — Medical & Health Details</h2>
                    <div class="triage-container">
                        <select id="triageOverride" class="form-select" style="width: auto; min-width: 120px;" onchange="updateTriage()">
                            <option value="auto">Auto</option>
                            <option value="green">Green</option>
                            <option value="amber">Amber</option>
                            <option value="red">Red</option>
                            <option value="black">Black</option>
                        </select>
                        <div id="triagePill" class="triage-pill triage-green">
                            <span>●</span> Green
                        </div>
                        <button class="btn btn-warning" onclick="saveHealth()">Save</button>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Blood Type</label>
                        <select id="bloodType" class="form-select">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+ (A Positive)</option>
                            <option value="A-">A- (A Negative)</option>
                            <option value="B+">B+ (B Positive)</option>
                            <option value="B-">B- (B Negative)</option>
                            <option value="AB+">AB+ (AB Positive)</option>
                            <option value="AB-">AB- (AB Negative)</option>
                            <option value="O+">O+ (O Positive)</option>
                            <option value="O-">O- (O Negative)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Critical Allergies</label>
                        <input type="text" id="allergies" class="form-input" placeholder="e.g., Penicillin, Nuts, Shellfish">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Medical Conditions</label>
                        <textarea id="conditions" class="form-textarea" placeholder="List any chronic conditions, diseases, or ongoing medical issues"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Medications</label>
                        <textarea id="medications" class="form-textarea" placeholder="List all current medications with dosages"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Implants/Medical Devices</label>
                        <input type="text" id="implants" class="form-input" placeholder="e.g., Pacemaker, Hip replacement, Insulin pump">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="organDonor" class="checkbox">
                            <label for="organDonor" class="form-label">I am an organ donor</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ICE Contacts Section -->
            <div class="card ice">
                <div class="card-header">
                    <h2 class="card-title">Emergency Contacts (ICE)</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="addContact()">Add Contact</button>
                        <button class="btn btn-warning" onclick="saveICE()">Save All</button>
                    </div>
                </div>
                <div id="iceContacts"></div>
            </div>

            <!-- Emergency Card & QR Section -->
            <div class="card emergency">
                <div class="card-header">
                    <h2 class="card-title">Emergency Card & QR Code</h2>
                </div>
                <div class="qr-container">
                    <div class="qr-box">
                        <canvas id="qrCanvas" width="200" height="200"></canvas>
                    </div>
                    <div class="qr-code" id="qrCode">XXXX-XXXX</div>
                    <div class="qr-label">MYQER™</div>
                    
                    <div class="url-group">
                        <input type="text" id="cardUrl" class="url-input" readonly>
                        <button class="btn btn-secondary" onclick="copyUrl()">Copy</button>
                        <button class="btn btn-secondary" onclick="openUrl()">Open</button>
                    </div>
                    
                    <div class="qr-actions">
                        <button class="btn btn-secondary" onclick="downloadQR('png')">Download PNG</button>
                        <button class="btn btn-secondary" onclick="downloadQR('svg')">Download SVG</button>
                        <button class="btn btn-secondary" onclick="printQR()">Print</button>
                    </div>
                </div>
            </div>

            <!-- Delete Account Section -->
            <div class="card delete">
                <div class="delete-section">
                    <h2 class="delete-title">⚠️ Delete Account</h2>
                    <p class="delete-warning">
                        This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Type "DELETE MY ACCOUNT" to confirm:</label>
                        <input type="text" id="deleteConfirm" class="form-input confirm-input" placeholder="DELETE MY ACCOUNT">
                    </div>
                    <button class="btn btn-danger" onclick="deleteAccount()">Delete My Account</button>
                </div>
            </div>

            <footer class="footer">
                <div class="footer-content">
                    <div style="color: #6b7280; font-size: 14px;">
                        © 2024 MYQER. All rights reserved.
                    </div>
                    <div class="footer-links">
                        <a href="#" class="footer-link">Privacy Policy</a>
                        <a href="#" class="footer-link">Terms of Service</a>
                        <a href="#" class="footer-link">Support</a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Idle Warning Modal -->
    <div id="idleModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Session Expiring</h3>
            <p class="modal-text">Your session will expire in <span id="countdown">60</span> seconds due to inactivity.</p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="resetIdleTimer()">Stay Logged In</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let supabase;
        let currentUser = null;
        let iceContacts = [];
        let idleTimer = null;
        let warningTimer = null;
        let countdownTimer = null;
        let countdownSeconds = 60;
        let debounceTimers = {};

        // Initialize Supabase (replace with your credentials)
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

        // Countries list
        const COUNTRIES = [
            'Afghanistan', 'Albania', 'Algeria', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan',
            'Bahrain', 'Bangladesh', 'Belarus', 'Belgium', 'Bolivia', 'Bosnia and Herzegovina', 'Brazil', 'Bulgaria',
            'Cambodia', 'Canada', 'Chile', 'China', 'Colombia', 'Croatia', 'Czech Republic',
            'Denmark', 'Ecuador', 'Egypt', 'Estonia', 'Finland', 'France', 'Georgia', 'Germany', 'Ghana', 'Greece',
            'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy',
            'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kuwait', 'Latvia', 'Lebanon', 'Lithuania', 'Luxembourg',
            'Malaysia', 'Mexico', 'Morocco', 'Netherlands', 'New Zealand', 'Nigeria', 'Norway',
            'Pakistan', 'Peru', 'Philippines', 'Poland', 'Portugal', 'Qatar', 'Romania', 'Russia',
            'Saudi Arabia', 'Singapore', 'Slovakia', 'Slovenia', 'South Africa', 'South Korea', 'Spain', 'Sweden', 'Switzerland',
            'Thailand', 'Turkey', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Venezuela', 'Vietnam'
        ];

        // Initialize app
        async function init() {
            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Check authentication
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    window.location.href = '/login.html?next=/dashboard.html';
                    return;
                }
                
                currentUser = session.user;
                document.getElementById('userEmail').textContent = currentUser.email;
                
                // Load data
                await loadProfile();
                await loadHealth();
                await loadICE();
                
                // Setup UI
                populateCountries();
                setupAutosave();
                setupIdleTimer();
                generateQR();
                
                // Show dashboard
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to load dashboard', 'error');
            }
        }

        // Populate countries dropdown
        function populateCountries() {
            const select = document.getElementById('country');
            COUNTRIES.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                select.appendChild(option);
            });
        }

        // Setup autosave for all inputs
        function setupAutosave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const section = getInputSection(input.id);
                    if (section) {
                        debounceAutosave(section);
                    }
                });
            });
        }

        // Get section for input
        function getInputSection(inputId) {
            const profileInputs = ['fullName', 'dob', 'country', 'healthId'];
            const healthInputs = ['bloodType', 'allergies', 'conditions', 'medications', 'implants', 'organDonor', 'triageOverride'];
            
            if (profileInputs.includes(inputId)) return 'profile';
            if (healthInputs.includes(inputId)) return 'health';
            return null;
        }

        // Debounced autosave
        function debounceAutosave(section) {
            if (debounceTimers[section]) {
                clearTimeout(debounceTimers[section]);
            }
            
            debounceTimers[section] = setTimeout(() => {
                if (section === 'profile') saveProfile(true);
                else if (section === 'health') saveHealth(true);
            }, 500);
        }

        // Load profile data
        async function loadProfile() {
            try {
                // Load from localStorage first
                const cached = localStorage.getItem('myqer_profile');
                if (cached) {
                    const data = JSON.parse(cached);
                    fillProfileForm(data);
                }
                
                // Load from server
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                if (data) {
                    fillProfileForm(data);
                    localStorage.setItem('myqer_profile', JSON.stringify(data));
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        // Fill profile form
        function fillProfileForm(data) {
            document.getElementById('fullName').value = data.full_name || '';
            document.getElementById('dob').value = data.dob || '';
            document.getElementById('country').value = data.country || '';
            document.getElementById('healthId').value = data.health_id || '';
        }

        // Load health data
        async function loadHealth() {
            try {
                // Load from localStorage first
                const cached = localStorage.getItem('myqer_health');
                if (cached) {
                    const data = JSON.parse(cached);
                    fillHealthForm(data);
                }
                
                // Load from server
                const { data, error } = await supabase
                    .from('health_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                if (data) {
                    fillHealthForm(data);
                    localStorage.setItem('myqer_health', JSON.stringify(data));
                }
                
                updateTriage();
            } catch (error) {
                console.error('Load health error:', error);
            }
        }

        // Fill health form
        function fillHealthForm(data) {
            document.getElementById('bloodType').value = data.blood_type || '';
            document.getElementById('allergies').value = data.allergies || '';
            document.getElementById('conditions').value = data.conditions || '';
            document.getElementById('medications').value = data.medications || '';
            document.getElementById('implants').value = data.implants || '';
            document.getElementById('organDonor').checked = data.organ_donor || false;
            document.getElementById('triageOverride').value = data.triage_override || 'auto';
        }

        // Load ICE contacts
        async function loadICE() {
            try {
                // Load from localStorage first
                const cached = localStorage.getItem('myqer_ice');
                if (cached) {
                    iceContacts = JSON.parse(cached);
                    renderICE();
                }
                
                // Load from server
                const { data, error } = await supabase
                    .from('ice_contacts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('contact_order');
                
                if (error) throw error;
                
                iceContacts = data || [];
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                renderICE();
            } catch (error) {
                console.error('Load ICE error:', error);
            }
        }

        // Save profile
        async function saveProfile(isAutosave = false) {
            try {
                const profileData = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value || null,
                    health_id: document.getElementById('healthId').value || null,
                    code: await generateCode()
                };
                
                const { error } = await supabase
                    .from('profiles')
                    .upsert(profileData);
                
                if (error) throw error;
                
                localStorage.setItem('myqer_profile', JSON.stringify(profileData));
                
                if (!isAutosave) {
                    showToast('Profile saved successfully', 'success');
                }
                
                generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save profile error:', error);
                showToast('Failed to save profile', 'error');
            }
        }

        // Save health data
        async function saveHealth(isAutosave = false) {
            try {
                const healthData = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value || null,
                    allergies: document.getElementById('allergies').value || null,
                    conditions: document.getElementById('conditions').value || null,
                    medications: document.getElementById('medications').value || null,
                    implants: document.getElementById('implants').value || null,
                    organ_donor: document.getElementById('organDonor').checked,
                    triage_override: document.getElementById('triageOverride').value
                };
                
                const { error } = await supabase
                    .from('health_data')
                    .upsert(healthData);
                
                if (error) throw error;
                
                localStorage.setItem('myqer_health', JSON.stringify(healthData));
                
                if (!isAutosave) {
                    showToast('Health data saved successfully', 'success');
                }
                
                updateTriage();
                generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save health error:', error);
                showToast('Failed to save health data', 'error');
            }
        }

        // Save ICE contacts
        async function saveICE() {
            try {
                // Delete existing contacts
                await supabase
                    .from('ice_contacts')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                // Insert new contacts
                const validContacts = iceContacts.filter(contact => 
                    contact.name && contact.name.trim() && 
                    contact.phone && contact.phone.trim()
                );
                
                if (validContacts.length > 0) {
                    const contactsData = validContacts.map((contact, index) => ({
                        user_id: currentUser.id,
                        contact_order: index + 1,
                        name: contact.name,
                        relation: contact.relation || null,
                        phone: contact.phone
                    }));
                    
                    const { error } = await supabase
                        .from('ice_contacts')
                        .insert(contactsData);
                    
                    if (error) throw error;
                }
                
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                showToast('Emergency contacts saved successfully', 'success');
                generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save ICE error:', error);
                showToast('Failed to save emergency contacts', 'error');
            }
        }

        // Generate unique code
        async function generateCode() {
            try {
                // Check if user already has a code
                const { data: existing } = await supabase
                    .from('profiles')
                    .select('code')
                    .eq('id', currentUser.id)
                    .single();
                
                if (existing && existing.code) {
                    return existing.code;
                }
                
                // Generate new code
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code;
                let isUnique = false;
                
                while (!isUnique) {
                    const part1 = Array.from({length: 4}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
                    const part2 = Array.from({length: 4}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
                    code = `${part1}-${part2}`;
                    
                    const { data } = await supabase
                        .from('profiles')
                        .select('code')
                        .eq('code', code)
                        .single();
                    
                    if (!data) isUnique = true;
                }
                
                return code;
            } catch (error) {
                console.error('Generate code error:', error);
                return 'XXXX-XXXX';
            }
        }

        // Update triage display
        function updateTriage() {
            const override = document.getElementById('triageOverride').value;
            const pill = document.getElementById('triagePill');
            
            let level = override;
            if (override === 'auto') {
                level = calculateTriage();
            }
            
            pill.className = `triage-pill triage-${level}`;
            pill.innerHTML = `<span>●</span> ${level.charAt(0).toUpperCase() + level.slice(1)}`;
        }

        // Calculate automatic triage
        function calculateTriage() {
            const allergies = document.getElementById('allergies').value.toLowerCase();
            const conditions = document.getElementById('conditions').value.toLowerCase();
            const medications = document.getElementById('medications').value.toLowerCase();
            
            const criticalKeywords = ['penicillin', 'anaphylaxis', 'severe', 'life-threatening', 'critical'];
            const warningKeywords = ['diabetes', 'heart', 'cardiac', 'epilepsy', 'asthma'];
            
            const hasCritical = criticalKeywords.some(keyword => 
                allergies.includes(keyword) || conditions.includes(keyword) || medications.includes(keyword)
            );
            
            const hasWarning = warningKeywords.some(keyword => 
                allergies.includes(keyword) || conditions.includes(keyword) || medications.includes(keyword)
            );
            
            if (hasCritical) return 'red';
            if (hasWarning) return 'amber';
            return 'green';
        }

        // Add ICE contact
        function addContact() {
            if (iceContacts.length >= 3) {
                showToast('Maximum 3 emergency contacts allowed', 'error');
                return;
            }
            
            iceContacts.push({
                name: '',
                relation: '',
                phone: ''
            });
            
            renderICE();
        }

        // Remove ICE contact
        function removeContact(index) {
            iceContacts.splice(index, 1);
            renderICE();
        }

        // Update ICE contact
        function updateContact(index, field, value) {
            if (iceContacts[index]) {
                iceContacts[index][field] = value;
            }
        }

        // Render ICE contacts
        function renderICE() {
            const container = document.getElementById('iceContacts');
            
            if (iceContacts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No emergency contacts added yet. Click "Add Contact" to get started.</p>';
                return;
            }
            
            container.innerHTML = iceContacts.map((contact, index) => `
                <div class="ice-contact">
                    <div class="ice-header">
                        <h4 style="font-weight: 600; color: #374151;">Contact ${index + 1}</h4>
                        <button class="btn btn-danger" onclick="removeContact(${index})" style="padding: 6px 12px; font-size: 12px;">Remove</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" value="${contact.name}" onchange="updateContact(${index}, 'name', this.value)" class="form-input" placeholder="Full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Relationship</label>
                            <input type="text" value="${contact.relation}" onchange="updateContact(${index}, 'relation', this.value)" class="form-input" placeholder="e.g., Spouse, Parent">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" value="${contact.phone}" onchange="updateContact(${index}, 'phone', this.value)" class="form-input" placeholder="+1 (555) 123-4567">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Generate QR code
        async function generateQR() {
            try {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('code')
                    .eq('id', currentUser.id)
                    .single();
                
                if (!profile || !profile.code) return;
                
                const code = profile.code;
                const url = `https://www.myqer.com/c/${code}`;
                
                // Create hybrid QR content (offline text + online URL)
                const qrContent = `MYQER Emergency Profile
Name: ${document.getElementById('fullName').value || 'Not provided'}
Blood: ${document.getElementById('bloodType').value || 'Unknown'}
Allergies: ${document.getElementById('allergies').value || 'None listed'}
URL: ${url}`;
                
                const canvas = document.getElementById('qrCanvas');
                await QRCode.toCanvas(canvas, qrContent, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                document.getElementById('qrCode').textContent = code;
                document.getElementById('cardUrl').value = url;
                
            } catch (error) {
                console.error('Generate QR error:', error);
            }
        }

        // Copy URL to clipboard
        function copyUrl() {
            const input = document.getElementById('cardUrl');
            input.select();
            document.execCommand('copy');
            showToast('URL copied to clipboard', 'success');
        }

        // Open URL in new tab
        function openUrl() {
            const url = document.getElementById('cardUrl').value;
            if (url) {
                window.open(url, '_blank');
            }
        }

        // Download QR code
        function downloadQR(format) {
            const canvas = document.getElementById('qrCanvas');
            const code = document.getElementById('qrCode').textContent;
            
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = `myqer-${code}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } else if (format === 'svg') {
                // SVG download stub
                showToast('SVG download coming soon', 'error');
            }
        }

        // Print QR code
        function printQR() {
            const printWindow = window.open('', '_blank');
            const canvas = document.getElementById('qrCanvas');
            const code = document.getElementById('qrCode').textContent;
            
            printWindow.document.write(`
                <html>
                    <head><title>MYQER Emergency QR - ${code}</title></head>
                    <body style="text-align: center; font-family: Arial;">
                        <h2>MYQER Emergency Profile</h2>
                        <img src="${canvas.toDataURL()}" style="border: 2px solid #ccc; padding: 20px;">
                        <p><strong>${code}</strong></p>
                        <p>MYQER™</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Save snapshot
        async function saveSnapshot() {
            try {
                const snapshot = {
                    user_id: currentUser.id,
                    profile_data: {
                        full_name: document.getElementById('fullName').value,
                        dob: document.getElementById('dob').value,
                        country: document.getElementById('country').value,
                        health_id: document.getElementById('healthId').value
                    },
                    health_data: {
                        blood_type: document.getElementById('bloodType').value,
                        allergies: document.getElementById('allergies').value,
                        conditions: document.getElementById('conditions').value,
                        medications: document.getElementById('medications').value,
                        implants: document.getElementById('implants').value,
                        organ_donor: document.getElementById('organDonor').checked
                    },
                    ice_contacts: iceContacts,
                    created_at: new Date().toISOString()
                };
                
                // Non-blocking insert
                supabase.from('profile_snapshots').insert(snapshot);
            } catch (error) {
                console.error('Save snapshot error:', error);
            }
        }

        // Delete account
        async function deleteAccount() {
            const confirmText = document.getElementById('deleteConfirm').value;
            
            if (confirmText !== 'DELETE MY ACCOUNT') {
                showToast('Please type the exact phrase to confirm', 'error');
                return;
            }
            
            try {
                // Delete all user data
                await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
                await supabase.from('health_data').delete().eq('user_id', currentUser.id);
                await supabase.from('profile_snapshots').delete().eq('user_id', currentUser.id);
                await supabase.from('profiles').delete().eq('id', currentUser.id);
                
                // Clear localStorage
                localStorage.removeItem('myqer_profile');
                localStorage.removeItem('myqer_health');
                localStorage.removeItem('myqer_ice');
                
                showToast('Account deleted successfully', 'success');
                
                // Sign out and redirect
                setTimeout(async () => {
                    await supabase.auth.signOut();
                    window.location.href = '/';
                }, 2000);
                
            } catch (error) {
                console.error('Delete account error:', error);
                showToast('Failed to delete account', 'error');
            }
        }

        // Logout
        async function logout() {
            try {
                await supabase.auth.signOut();
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Setup idle timer
        function setupIdleTimer() {
            const IDLE_TIME = 15 * 60 * 1000; // 15 minutes
            const WARNING_TIME = 14 * 60 * 1000; // 14 minutes
            
            function resetTimers() {
                clearTimeout(idleTimer);
                clearTimeout(warningTimer);
                
                warningTimer = setTimeout(showIdleWarning, WARNING_TIME);
                idleTimer = setTimeout(logout, IDLE_TIME);
            }
            
            function showIdleWarning() {
                const modal = document.getElementById('idleModal');
                modal.classList.add('show');
                
                countdownSeconds = 60;
                updateCountdown();
                
                countdownTimer = setInterval(() => {
                    countdownSeconds--;
                    updateCountdown();
                    
                    if (countdownSeconds <= 0) {
                        clearInterval(countdownTimer);
                        logout();
                    }
                }, 1000);
            }
            
            function updateCountdown() {
                document.getElementById('countdown').textContent = countdownSeconds;
            }
            
            // Reset timer on user activity
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetTimers, true);
            });
            
            resetTimers();
            
            // Make resetIdleTimer global
            window.resetIdleTimer = function() {
                const modal = document.getElementById('idleModal');
                modal.classList.remove('show');
                clearInterval(countdownTimer);
                resetTimers();
            };
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97afbfa290ffc9aa',t:'MTc1NzE4MDM5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
