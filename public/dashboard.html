<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER‚Ñ¢ Dashboard - Privacy-first Emergency Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-red: #C62828;
            --ink-black: #0F172A;
            --soft-gray: #F5F7FB;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #F5F7FB 0%, #E2E8F0 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 18px 40px rgba(2, 8, 23, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 50px rgba(2, 8, 23, 0.1);
        }
        
        .card-ribbon {
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: 16px 0 0 16px;
        }
        
        .ribbon-identity { background: #10B981; }
        .ribbon-health { background: #C62828; }
        .ribbon-ice { background: #F59E0B; }
        .ribbon-qr { background: #3B82F6; }
        .ribbon-reference { background: #6B7280; }
        .ribbon-coming { background: #8B5CF6; }
        .ribbon-family { background: #EC4899; }
        .ribbon-danger { background: #EF4444; }
        .ribbon-triage { background: #EAB308; }
        
        .brand-red { color: var(--brand-red); }
        .bg-brand-red { background-color: var(--brand-red); }
        .ink-black { color: var(--ink-black); }
        .bg-ink-black { background-color: var(--ink-black); }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { background: #10B981; color: white; }
        .toast.warning { background: #F59E0B; color: white; }
        .toast.error { background: #EF4444; color: white; }
        
        .grid-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        
        @media (min-width: 768px) {
            .grid-dashboard {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        @media (min-width: 1024px) {
            .grid-dashboard {
                grid-template-columns: repeat(8, 1fr);
            }
            
            .main-content {
                grid-column: span 5;
            }
            
            .sidebar-content {
                grid-column: span 3;
            }
        }
        
        .triage-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .triage-green { background: #DCFCE7; color: #166534; }
        .triage-amber { background: #FEF3C7; color: #92400E; }
        .triage-red { background: #FEE2E2; color: #991B1B; }
        .triage-black { background: #F3F4F6; color: #374151; }
        
        .qr-code {
            width: 120px;
            height: 120px;
            background: #000;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-align: center;
            border-radius: 8px;
        }
        
        input, textarea, select {
            transition: all 0.2s ease;
            min-height: 48px;
            font-size: 16px;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
            padding: 12px 16px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--brand-red);
            box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
        }
        
        .input-group {
            position: relative;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .required::after {
            content: "*";
            color: #EF4444;
        }
        
        .save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .saving-dot {
            width: 6px;
            height: 6px;
            background: #F59E0B;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .saved-check {
            color: #10B981;
            animation: fadeOut 1.8s forwards;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .pill-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .pill {
            background: #F3F4F6;
            color: #374151;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .pill-remove {
            cursor: pointer;
            color: #6B7280;
            font-weight: bold;
        }
        
        .pill-remove:hover {
            color: #EF4444;
        }
        
        .offline-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #F59E0B;
            font-size: 12px;
        }
        
        .help-tooltip {
            position: relative;
            cursor: help;
            color: #6B7280;
        }
        
        .help-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1F2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        .btn-primary {
            background: var(--brand-red);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #B71C1C;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: var(--ink-black);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #E5E7EB;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }
        
        .btn-danger {
            background: transparent;
            color: #EF4444;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 2px solid #EF4444;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #EF4444;
            color: white;
        }
        
        .coming-soon-card {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .coming-soon-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .document-tile {
            background: #F8FAFC;
            border: 2px dashed #CBD5E1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: not-allowed;
        }
        
        .document-tile:hover {
            border-color: #94A3B8;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal.show .modal-content {
            transform: scale(1);
        }
        
        .footer-links {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .disclaimer {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 8px;
            padding: 16px;
            margin: 24px 0;
        }
        
        .disclaimer-title {
            font-weight: 600;
            color: #92400E;
            margin-bottom: 8px;
        }
        
        .disclaimer-text {
            font-size: 14px;
            color: #78350F;
            line-height: 1.5;
        }
        
        @media (max-width: 640px) {
            .footer-links {
                flex-direction: column;
                gap: 12px;
            }
        }
        
        /* RTL Support */
        [dir="rtl"] .card-ribbon {
            left: auto;
            right: 0;
            border-radius: 0 16px 16px 0;
        }
        
        [dir="rtl"] .help-tooltip:hover::after {
            left: auto;
            right: 50%;
            transform: translateX(50%);
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- Delete Account Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-red-600 mb-4" data-i18n="danger.title">Delete Account</h3>
            <p class="text-gray-600 mb-6" data-i18n="danger.warning">
                This will permanently delete your MYQER account and all associated data. This action cannot be undone.
            </p>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="danger.type_delete">
                    Type "DELETE" to confirm:
                </label>
                <input type="text" id="deleteConfirmInput" class="w-full" placeholder="DELETE">
            </div>
            <div class="mb-6">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="deleteUnderstand">
                    <span class="text-sm" data-i18n="danger.understand">I understand this action cannot be undone</span>
                </label>
            </div>
            <div class="flex gap-3">
                <button id="cancelDeleteBtn" class="btn-secondary flex-1" data-i18n="common.cancel">Cancel</button>
                <button id="confirmDeleteBtn" class="btn-danger flex-1" disabled data-i18n="danger.confirm">Delete Account</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    <div class="text-2xl font-bold ink-black">
                        MYQ<span class="brand-red">ER</span>‚Ñ¢
                    </div>
                    <div class="text-xs text-gray-500 hidden sm:block" data-i18n="app.tagline">
                        Privacy-first. Works offline.
                    </div>
                </div>
                
                <!-- Center Link -->
                <div class="hidden md:block">
                    <div class="flex items-center gap-4">
                        <a href="about.html" class="text-sm text-gray-600 hover:text-gray-900 transition-colors" data-i18n="app.pronounce">
                            MYQER (pronounced 'my care')
                        </a>
                        <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">
                            DEMO MODE
                        </div>
                    </div>
                </div>
                
                <!-- Right Controls -->
                <div class="flex items-center space-x-4">
                    <div id="offlineIndicator" class="offline-indicator" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23 12l-2.44-2.78.34-3.68-3.61-.82-1.89-3.18L12 3 8.6 1.54 6.71 4.72l-3.61.81.34 3.68L1 12l2.44 2.78-.34 3.68 3.61.82 1.89 3.18L12 21l3.4 1.46 1.89-3.18 3.61-.81-.34-3.68L23 12zM13 17h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                        <span data-i18n="status.offline">Offline</span>
                        <span id="queueCount" class="bg-amber-500 text-white text-xs px-2 py-1 rounded-full" style="display: none;">0</span>
                    </div>
                    <select id="languageSelect" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="pt">Portugu√™s</option>
                        <option value="nl">Nederlands</option>
                        <option value="sv">Svenska</option>
                        <option value="no">Norsk</option>
                        <option value="da">Dansk</option>
                        <option value="fi">Suomi</option>
                        <option value="pl">Polski</option>
                        <option value="cs">ƒåe≈°tina</option>
                        <option value="hu">Magyar</option>
                        <option value="ro">Rom√¢nƒÉ</option>
                    </select>
                    <button id="logoutBtn" class="btn-secondary text-sm" data-i18n="nav.logout">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Medical Disclaimer -->
    <div class="max-w-6xl mx-auto px-4 pt-6">
        <div class="disclaimer">
            <div class="disclaimer-title" data-i18n="disclaimer.title">Medical Disclaimer</div>
            <div class="disclaimer-text" data-i18n="disclaimer.text">
                This information is for emergency reference only and does not constitute medical advice. Healthcare professionals must independently verify all medical information and make their own clinical assessments. MYQER‚Ñ¢ is not responsible for medical decisions made based on this data.
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="grid-dashboard">
            <!-- Main Content -->
            <div class="main-content space-y-6">
                <!-- Identity Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-identity"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="identity.title">Identity</h2>
                        <div class="help-tooltip" data-tooltip="These details help responders confirm who you are">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="identity.subtitle">These details help responders confirm who you are.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label class="input-label required" data-i18n="identity.name">Full Name
                                <span id="fullNameIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="fullName" class="w-full" data-i18n-placeholder="identity.name_placeholder" placeholder="Enter your full name" aria-required="true">
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="identity.dob">Date of Birth
                                <span id="dobIndicator" class="save-indicator"></span>
                            </label>
                            <input type="date" id="dob" class="w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="identity.country">Country
                                <span id="countryIndicator" class="save-indicator"></span>
                            </label>
                            <select id="country" class="w-full">
                                <option value="" data-i18n="identity.select_country">Select country</option>
                                <option value="US">United States</option>
                                <option value="GB">United Kingdom</option>
                                <option value="CA">Canada</option>
                                <option value="AU">Australia</option>
                                <option value="DE">Germany</option>
                                <option value="FR">France</option>
                                <option value="ES">Spain</option>
                                <option value="IT">Italy</option>
                                <option value="NL">Netherlands</option>
                                <option value="BE">Belgium</option>
                                <option value="CH">Switzerland</option>
                                <option value="AT">Austria</option>
                                <option value="SE">Sweden</option>
                                <option value="NO">Norway</option>
                                <option value="DK">Denmark</option>
                                <option value="FI">Finland</option>
                                <option value="IE">Ireland</option>
                                <option value="PT">Portugal</option>
                                <option value="PL">Poland</option>
                                <option value="CZ">Czech Republic</option>
                                <option value="HU">Hungary</option>
                                <option value="RO">Romania</option>
                                <option value="BG">Bulgaria</option>
                                <option value="HR">Croatia</option>
                                <option value="SI">Slovenia</option>
                                <option value="SK">Slovakia</option>
                                <option value="LT">Lithuania</option>
                                <option value="LV">Latvia</option>
                                <option value="EE">Estonia</option>
                                <option value="GR">Greece</option>
                                <option value="CY">Cyprus</option>
                                <option value="MT">Malta</option>
                                <option value="LU">Luxembourg</option>
                                <option value="IS">Iceland</option>
                                <option value="LI">Liechtenstein</option>
                                <option value="MC">Monaco</option>
                                <option value="SM">San Marino</option>
                                <option value="VA">Vatican City</option>
                                <option value="AD">Andorra</option>
                                <option value="JP">Japan</option>
                                <option value="KR">South Korea</option>
                                <option value="SG">Singapore</option>
                                <option value="HK">Hong Kong</option>
                                <option value="TW">Taiwan</option>
                                <option value="NZ">New Zealand</option>
                                <option value="IL">Israel</option>
                                <option value="AE">United Arab Emirates</option>
                                <option value="SA">Saudi Arabia</option>
                                <option value="QA">Qatar</option>
                                <option value="KW">Kuwait</option>
                                <option value="BH">Bahrain</option>
                                <option value="OM">Oman</option>
                                <option value="JO">Jordan</option>
                                <option value="LB">Lebanon</option>
                                <option value="TR">Turkey</option>
                                <option value="RU">Russia</option>
                                <option value="UA">Ukraine</option>
                                <option value="BY">Belarus</option>
                                <option value="MD">Moldova</option>
                                <option value="GE">Georgia</option>
                                <option value="AM">Armenia</option>
                                <option value="AZ">Azerbaijan</option>
                                <option value="KZ">Kazakhstan</option>
                                <option value="UZ">Uzbekistan</option>
                                <option value="KG">Kyrgyzstan</option>
                                <option value="TJ">Tajikistan</option>
                                <option value="TM">Turkmenistan</option>
                                <option value="MN">Mongolia</option>
                                <option value="CN">China</option>
                                <option value="IN">India</option>
                                <option value="PK">Pakistan</option>
                                <option value="BD">Bangladesh</option>
                                <option value="LK">Sri Lanka</option>
                                <option value="MV">Maldives</option>
                                <option value="NP">Nepal</option>
                                <option value="BT">Bhutan</option>
                                <option value="MM">Myanmar</option>
                                <option value="TH">Thailand</option>
                                <option value="LA">Laos</option>
                                <option value="KH">Cambodia</option>
                                <option value="VN">Vietnam</option>
                                <option value="MY">Malaysia</option>
                                <option value="BN">Brunei</option>
                                <option value="ID">Indonesia</option>
                                <option value="TL">East Timor</option>
                                <option value="PH">Philippines</option>
                                <option value="MX">Mexico</option>
                                <option value="GT">Guatemala</option>
                                <option value="BZ">Belize</option>
                                <option value="SV">El Salvador</option>
                                <option value="HN">Honduras</option>
                                <option value="NI">Nicaragua</option>
                                <option value="CR">Costa Rica</option>
                                <option value="PA">Panama</option>
                                <option value="CU">Cuba</option>
                                <option value="JM">Jamaica</option>
                                <option value="HT">Haiti</option>
                                <option value="DO">Dominican Republic</option>
                                <option value="PR">Puerto Rico</option>
                                <option value="TT">Trinidad and Tobago</option>
                                <option value="BB">Barbados</option>
                                <option value="GD">Grenada</option>
                                <option value="LC">Saint Lucia</option>
                                <option value="VC">Saint Vincent and the Grenadines</option>
                                <option value="AG">Antigua and Barbuda</option>
                                <option value="KN">Saint Kitts and Nevis</option>
                                <option value="DM">Dominica</option>
                                <option value="BS">Bahamas</option>
                                <option value="CO">Colombia</option>
                                <option value="VE">Venezuela</option>
                                <option value="GY">Guyana</option>
                                <option value="SR">Suriname</option>
                                <option value="GF">French Guiana</option>
                                <option value="BR">Brazil</option>
                                <option value="EC">Ecuador</option>
                                <option value="PE">Peru</option>
                                <option value="BO">Bolivia</option>
                                <option value="PY">Paraguay</option>
                                <option value="UY">Uruguay</option>
                                <option value="AR">Argentina</option>
                                <option value="CL">Chile</option>
                                <option value="FK">Falkland Islands</option>
                                <option value="ZA">South Africa</option>
                                <option value="NA">Namibia</option>
                                <option value="BW">Botswana</option>
                                <option value="ZW">Zimbabwe</option>
                                <option value="ZM">Zambia</option>
                                <option value="MW">Malawi</option>
                                <option value="MZ">Mozambique</option>
                                <option value="SZ">Eswatini</option>
                                <option value="LS">Lesotho</option>
                                <option value="MG">Madagascar</option>
                                <option value="MU">Mauritius</option>
                                <option value="SC">Seychelles</option>
                                <option value="KM">Comoros</option>
                                <option value="YT">Mayotte</option>
                                <option value="RE">R√©union</option>
                                <option value="TZ">Tanzania</option>
                                <option value="KE">Kenya</option>
                                <option value="UG">Uganda</option>
                                <option value="RW">Rwanda</option>
                                <option value="BI">Burundi</option>
                                <option value="DJ">Djibouti</option>
                                <option value="SO">Somalia</option>
                                <option value="ET">Ethiopia</option>
                                <option value="ER">Eritrea</option>
                                <option value="SD">Sudan</option>
                                <option value="SS">South Sudan</option>
                                <option value="CF">Central African Republic</option>
                                <option value="TD">Chad</option>
                                <option value="CM">Cameroon</option>
                                <option value="GQ">Equatorial Guinea</option>
                                <option value="GA">Gabon</option>
                                <option value="CG">Republic of the Congo</option>
                                <option value="CD">Democratic Republic of the Congo</option>
                                <option value="AO">Angola</option>
                                <option value="ST">S√£o Tom√© and Pr√≠ncipe</option>
                                <option value="GH">Ghana</option>
                                <option value="TG">Togo</option>
                                <option value="BJ">Benin</option>
                                <option value="NG">Nigeria</option>
                                <option value="NE">Niger</option>
                                <option value="BF">Burkina Faso</option>
                                <option value="ML">Mali</option>
                                <option value="SN">Senegal</option>
                                <option value="GM">Gambia</option>
                                <option value="GW">Guinea-Bissau</option>
                                <option value="GN">Guinea</option>
                                <option value="SL">Sierra Leone</option>
                                <option value="LR">Liberia</option>
                                <option value="CI">C√¥te d'Ivoire</option>
                                <option value="EG">Egypt</option>
                                <option value="LY">Libya</option>
                                <option value="TN">Tunisia</option>
                                <option value="DZ">Algeria</option>
                                <option value="MA">Morocco</option>
                                <option value="EH">Western Sahara</option>
                                <option value="MR">Mauritania</option>
                                <option value="CV">Cape Verde</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="identity.health_id">Health ID (NHS, etc.)
                                <span id="healthIdIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="healthId" class="w-full" data-i18n-placeholder="identity.health_id_placeholder" placeholder="Optional - never shown publicly">
                            <p class="text-xs text-gray-500 mt-1" data-i18n="identity.health_id_note">Health ID is optional and never shown on your public card.</p>
                        </div>
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="identity.code">Your Card Code
                                <span id="cardCodeIndicator" class="save-indicator"></span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="cardCode" class="flex-1" readonly data-i18n-placeholder="identity.code_placeholder" placeholder="Will be generated automatically">
                                <button id="generateCodeBtn" class="btn-secondary" data-i18n="identity.generate">Generate Code</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-xs text-gray-500" data-i18n="common.autosave">
                            Auto-saves as you type
                        </div>
                        <button id="saveProfileBtn" class="btn-primary" data-i18n="identity.save">Save Profile</button>
                    </div>
                </div>

                <!-- Health Profile Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-health"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="health.title">Health Profile</h2>
                        <div class="help-tooltip" data-tooltip="Keep this current. It appears on your emergency card">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="health.subtitle">Keep this current. It appears on your emergency card.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.blood">Blood Type
                                <span id="bloodTypeIndicator" class="save-indicator"></span>
                            </label>
                            <select id="bloodType" class="w-full">
                                <option value="‚Äî" data-i18n="health.unknown">Unknown</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.donor">Organ Donor
                                <span id="organDonorIndicator" class="save-indicator"></span>
                            </label>
                            <select id="organDonor" class="w-full">
                                <option value="‚Äî" data-i18n="health.not_specified">Not specified</option>
                                <option value="Yes" data-i18n="common.yes">Yes</option>
                                <option value="No" data-i18n="common.no">No</option>
                            </select>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.allergies">Critical Allergies
                                <span id="allergiesIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="allergiesInput" class="w-full" data-i18n-placeholder="health.allergies_placeholder" placeholder="Type allergy and press Enter (e.g., Penicillin, Nuts)">
                            <div id="allergiesPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.conditions">Medical Conditions
                                <span id="conditionsIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="conditionsInput" class="w-full" data-i18n-placeholder="health.conditions_placeholder" placeholder="Type condition and press Enter (e.g., Diabetes, Hypertension)">
                            <div id="conditionsPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.meds">Current Medications
                                <span id="medicationsIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="medicationsInput" class="w-full" data-i18n-placeholder="health.meds_placeholder" placeholder="Type medication and press Enter (e.g., Insulin, Aspirin)">
                            <div id="medicationsPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.implants">Implants & Devices
                                <span id="implantsIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="implantsInput" class="w-full" data-i18n-placeholder="health.implants_placeholder" placeholder="Include model/MRI info (e.g., Pacemaker MRI-unsafe, Hip replacement)">
                            <div id="implantsPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.life_support">Life Support Preference
                                <span id="lifeSupportIndicator" class="save-indicator"></span>
                            </label>
                            <select id="lifeSupportPref" class="w-full">
                                <option value="Full" data-i18n="health.full_support">Full Life Support</option>
                                <option value="Comfort" data-i18n="health.comfort_care">Comfort Care Only</option>
                                <option value="DNR" data-i18n="health.dnr">Do Not Resuscitate</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.burial">Burial Preference
                                <span id="burialIndicator" class="save-indicator"></span>
                            </label>
                            <select id="burialPref" class="w-full">
                                <option value="Burial" data-i18n="health.burial_option">Burial</option>
                                <option value="Cremation" data-i18n="health.cremation">Cremation</option>
                                <option value="Other" data-i18n="health.other">Other</option>
                            </select>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.religion">Religious/Cultural Preference
                                <span id="religionIndicator" class="save-indicator"></span>
                            </label>
                            <select id="religionPref" class="w-full">
                                <option value="None" data-i18n="health.none">None</option>
                                <option value="Catholic">Catholic</option>
                                <option value="Protestant">Protestant</option>
                                <option value="Orthodox">Orthodox</option>
                                <option value="Muslim">Muslim</option>
                                <option value="Jewish">Jewish</option>
                                <option value="Hindu">Hindu</option>
                                <option value="Buddhist">Buddhist</option>
                                <option value="Sikh">Sikh</option>
                                <option value="Other" data-i18n="health.other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-xs text-gray-500" data-i18n="common.autosave">
                            Auto-saves as you type
                        </div>
                        <button id="saveHealthBtn" class="btn-primary" data-i18n="health.save">Save Health Profile</button>
                    </div>
                </div>

                <!-- ICE Contacts Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-ice"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="ice.title">Emergency Contacts (ICE)</h2>
                        <div class="help-tooltip" data-tooltip="In Case of Emergency - who should we call?">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="ice.subtitle">Add up to 3 trusted contacts.</p>
                    
                    <div id="iceContacts" class="space-y-4">
                        <!-- ICE contacts will be populated here -->
                    </div>
                    <button id="addIceContact" class="btn-secondary mt-4" data-i18n="ice.add">
                        Add Contact (Max 3)
                    </button>
                </div>

                <!-- Document Vault Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-coming"></div>
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <h2 class="text-xl font-bold ink-black" data-i18n="docs.title">Document Vault</h2>
                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-semibold" data-i18n="docs.coming">Coming Soon</span>
                        </div>
                        <div class="help-tooltip" data-tooltip="Launching after clinical review and security audit">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="docs.subtitle">Secure, client-side encrypted storage for critical documents.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="document-tile">
                            <div class="text-2xl mb-2">üìã</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.dnr">DNR Orders</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.dnr_desc">Do Not Resuscitate documents</p>
                        </div>
                        <div class="document-tile">
                            <div class="text-2xl mb-2">üìú</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.living_will">Living Will</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.living_will_desc">End-of-life care preferences</p>
                        </div>
                        <div class="document-tile">
                            <div class="text-2xl mb-2">‚öñÔ∏è</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.power_attorney">Medical Power of Attorney</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.power_attorney_desc">Healthcare decision authority</p>
                        </div>
                        <div class="document-tile">
                            <div class="text-2xl mb-2">üè•</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.insurance">Insurance Documents</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.insurance_desc">Health insurance cards & info</p>
                        </div>
                    </div>
                </div>

                <!-- Family Dashboard Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-family"></div>
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <h2 class="text-xl font-bold ink-black" data-i18n="family.title">Family Dashboard</h2>
                            <span class="bg-pink-100 text-pink-800 px-2 py-1 rounded text-xs font-semibold" data-i18n="family.coming">Coming Soon</span>
                        </div>
                        <div class="help-tooltip" data-tooltip="Coming soon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="family.subtitle">Manage dependents and household emergency info in one place.</p>
                    
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <button class="btn-secondary" disabled data-i18n="family.invite">
                            Invite Family Members
                        </button>
                        <p class="text-sm text-gray-500 mt-2" data-i18n="family.invite_desc">Create and manage emergency profiles for your loved ones</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content space-y-6">
                <!-- Automated Triage Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-triage"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="triage.title">Automated Triage</h2>
                        <div class="help-tooltip" data-tooltip="AI-powered emergency priority assessment">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-2" data-i18n="triage.auto">Auto-computed from your health profile.</p>
                    
                    <div class="text-center mb-4">
                        <div id="triageStatus" class="triage-status triage-green">
                            GREEN - Standard
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="input-label" data-i18n="triage.override">Manual Override</label>
                        <select id="triageOverride" class="w-full">
                            <option value="" data-i18n="triage.auto_recommended">Auto (Recommended)</option>
                            <option value="Green" data-i18n="triage.green">Green - Standard</option>
                            <option value="Amber" data-i18n="triage.amber">Amber - Urgent</option>
                            <option value="Red" data-i18n="triage.red">Red - Immediate</option>
                            <option value="Black" data-i18n="triage.black">Black - Comfort</option>
                        </select>
                    </div>
                    <p class="text-xs text-gray-500 mb-4" data-i18n="triage.control">You control what responders see first.</p>
                    <div class="space-y-2">
                        <button id="speakTriageBtn" class="btn-secondary w-full text-sm" data-i18n="triage.speak">
                            Speak Summary
                        </button>
                        <button id="stopSpeechBtn" class="btn-secondary w-full text-sm" style="display: none;" data-i18n="triage.stop">
                            Stop
                        </button>
                    </div>
                </div>

                <!-- Emergency Card & QR -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-qr"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="qr.title">Emergency Card & QR</h2>
                        <div class="help-tooltip" data-tooltip="Your emergency information accessible via QR code">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4" data-i18n="qr.subtitle">Scan to view your emergency information.</p>
                    
                    <div class="text-center mb-4">
                        <div class="relative">
                            <canvas id="qrCanvas" width="120" height="120" class="mx-auto border-2 border-gray-200 rounded-lg"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="bg-white rounded-full p-2 shadow-sm">
                                    <div class="text-xs font-bold ink-black">MYQ<span class="brand-red">ER</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <input type="text" id="cardLink" class="w-full text-xs text-center border border-gray-300 rounded px-2 py-1" readonly>
                            <button id="copyLinkBtn" class="text-xs text-blue-600 hover:text-blue-800 mt-1" data-i18n="qr.copy">Copy Link</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <button id="viewCardBtn" class="btn-primary w-full" data-i18n="qr.view">
                            View Emergency Card
                        </button>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="exportPngBtn" class="btn-secondary text-sm" data-i18n="qr.png">PNG</button>
                            <button id="exportSvgBtn" class="btn-secondary text-sm" data-i18n="qr.svg">SVG</button>
                        </div>
                        <button id="printCardBtn" class="btn-secondary w-full" data-i18n="qr.print">
                            Print Card
                        </button>
                        <button id="shareQrBtn" class="btn-secondary w-full" data-i18n="qr.share">
                            Share QR Code
                        </button>
                        <button id="speakCardBtn" class="btn-secondary w-full text-sm" data-i18n="qr.speak">
                            Speak Summary
                        </button>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-xs text-gray-500" id="qrStatus" data-i18n="qr.status">
                            QR library loaded
                        </p>
                    </div>
                </div>

                <!-- Triage Reference -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-reference"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="triage.legend.title">Triage Reference</h2>
                        <div class="help-tooltip" data-tooltip="Emergency priority color coding system">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4" data-i18n="triage.legend.subtitle">Emergency priority color coding system.</p>
                    
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-green text-xs">GREEN</div>
                            <span class="text-sm" data-i18n="triage.legend.green">Mild allergies, no major conditions</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-amber text-xs">AMBER</div>
                            <span class="text-sm" data-i18n="triage.legend.amber">Stable chronic conditions</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-red text-xs">RED</div>
                            <span class="text-sm" data-i18n="triage.legend.red">Severe allergies / life-threatening conditions</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-black text-xs">BLACK</div>
                            <span class="text-sm" data-i18n="triage.legend.black">DNR / Comfort care set</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-xs text-gray-500 mb-2" data-i18n="qr.persistent">
                            Your QR code stays the same ‚Äî it always opens your latest information.
                        </p>
                        <p class="text-xs text-gray-500" data-i18n="qr.privacy">
                            Works offline; your data stays private until you choose to share.
                        </p>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="glass-card p-6 border-red-200">
                    <div class="card-ribbon ribbon-danger"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold text-red-600" data-i18n="danger.title">Danger Zone</h2>
                        <div class="help-tooltip" data-tooltip="Permanently delete your account and all data">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4" data-i18n="danger.subtitle">
                        This permanently deletes your account and all data.
                    </p>
                    <button id="deleteAccountBtn" class="btn-danger w-full" data-i18n="danger.delete">
                        Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 mt-16">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="text-sm text-gray-600 mb-4 md:mb-0" data-i18n="footer.copyright">
                    ¬© 2025 MYQER ‚Äî Emergency Response QR ¬∑ GDPR/HIPAA-minded.
                </div>
                <div class="footer-links text-sm">
                    <a href="/privacy.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.privacy">Privacy</a>
                    <a href="/terms.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.terms">Terms</a>
                    <a href="/about.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.about">About</a>
                    <a href="/support.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.support">Support</a>
                    <a href="mailto:support@myqer.com" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.contact">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Internationalization (i18n) System
        const T = {
            en: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (pronounced 'my care')",
                    tagline: "Privacy-first. Works offline."
                },
                nav: {
                    logout: "Logout"
                },
                disclaimer: {
                    title: "Medical Disclaimer",
                    text: "This information is for emergency reference only and does not constitute medical advice. Healthcare professionals must independently verify all medical information and make their own clinical assessments. MYQER‚Ñ¢ is not responsible for medical decisions made based on this data."
                },
                identity: {
                    title: "Identity",
                    subtitle: "These details help responders confirm who you are.",
                    name: "Full Name",
                    name_placeholder: "Enter your full name",
                    dob: "Date of Birth",
                    country: "Country",
                    select_country: "Select country",
                    health_id: "Health ID (NHS, etc.)",
                    health_id_placeholder: "Optional - never shown publicly",
                    health_id_note: "Health ID is optional and never shown on your public card.",
                    code: "Your Card Code",
                    code_placeholder: "Will be generated automatically",
                    generate: "Generate Code",
                    save: "Save Profile"
                },
                health: {
                    title: "Health Profile",
                    subtitle: "Keep this current. It appears on your emergency card.",
                    blood: "Blood Type",
                    unknown: "Unknown",
                    donor: "Organ Donor",
                    not_specified: "Not specified",
                    allergies: "Critical Allergies",
                    allergies_placeholder: "Type allergy and press Enter (e.g., Penicillin, Nuts)",
                    conditions: "Medical Conditions",
                    conditions_placeholder: "Type condition and press Enter (e.g., Diabetes, Hypertension)",
                    meds: "Current Medications",
                    meds_placeholder: "Type medication and press Enter (e.g., Insulin, Aspirin)",
                    implants: "Implants & Devices",
                    implants_placeholder: "Include model/MRI info (e.g., Pacemaker MRI-unsafe, Hip replacement)",
                    life_support: "Life Support Preference",
                    full_support: "Full Life Support",
                    comfort_care: "Comfort Care Only",
                    dnr: "Do Not Resuscitate",
                    burial: "Burial Preference",
                    burial_option: "Burial",
                    cremation: "Cremation",
                    other: "Other",
                    religion: "Religious/Cultural Preference",
                    none: "None",
                    save: "Save Health Profile"
                },
                ice: {
                    title: "Emergency Contacts (ICE)",
                    subtitle: "Add up to 3 trusted contacts.",
                    add: "Add Contact (Max 3)",
                    name: "Name",
                    rel: "Relationship",
                    phone: "Phone",
                    delete: "Remove Contact",
                    limit: "Maximum 3 emergency contacts allowed"
                },
                triage: {
                    title: "Automated Triage",
                    auto: "Auto-computed from your health profile.",
                    override: "Manual Override",
                    auto_recommended: "Auto (Recommended)",
                    green: "Green - Standard",
                    amber: "Amber - Urgent",
                    red: "Red - Immediate",
                    black: "Black - Comfort",
                    control: "You control what responders see first.",
                    speak: "Speak Summary",
                    stop: "Stop",
                    legend: {
                        title: "Triage Reference",
                        subtitle: "Emergency priority color coding system.",
                        green: "Mild allergies, no major conditions",
                        amber: "Stable chronic conditions",
                        red: "Severe allergies / life-threatening conditions",
                        black: "DNR / Comfort care set"
                    }
                },
                qr: {
                    title: "Emergency Card & QR",
                    subtitle: "Scan to view your emergency information.",
                    copy: "Copy Link",
                    copied: "Card link copied!",
                    view: "View Emergency Card",
                    png: "PNG",
                    svg: "SVG",
                    print: "Print Card",
                    share: "Share QR Code",
                    speak: "Speak Summary",
                    status: "QR library loaded",
                    persistent: "Your QR code stays the same ‚Äî it always opens your latest information.",
                    privacy: "Works offline; your data stays private until you choose to share."
                },
                docs: {
                    title: "Document Vault",
                    subtitle: "Secure, client-side encrypted storage for critical documents.",
                    coming: "Coming Soon",
                    dnr: "DNR Orders",
                    dnr_desc: "Do Not Resuscitate documents",
                    living_will: "Living Will",
                    living_will_desc: "End-of-life care preferences",
                    power_attorney: "Medical Power of Attorney",
                    power_attorney_desc: "Healthcare decision authority",
                    insurance: "Insurance Documents",
                    insurance_desc: "Health insurance cards & info"
                },
                family: {
                    title: "Family Dashboard",
                    subtitle: "Manage dependents and household emergency info in one place.",
                    coming: "Coming Soon",
                    invite: "Invite Family Members",
                    invite_desc: "Create and manage emergency profiles for your loved ones"
                },
                danger: {
                    title: "Danger Zone",
                    subtitle: "This permanently deletes your account and all data.",
                    delete: "Delete My Account",
                    warning: "This will permanently delete your MYQER account and all associated data. This action cannot be undone.",
                    type_delete: "Type \"DELETE\" to confirm:",
                    understand: "I understand this action cannot be undone",
                    confirm: "Delete Account"
                },
                common: {
                    autosave: "Auto-saves as you type",
                    yes: "Yes",
                    no: "No",
                    cancel: "Cancel",
                    save: "Save",
                    delete: "Delete"
                },
                status: {
                    offline: "Offline"
                },
                toasts: {
                    saving: "Saving...",
                    saved: "Saved",
                    offline: "No network - queued for sync",
                    network_restored: "Back online - syncing data",
                    sync_complete: "All changes synced successfully"
                },
                errors: {
                    network: "Network error",
                    save: "Couldn't save",
                    not_found: "Not found",
                    duplicate_contact: "You already added this person"
                },
                footer: {
                    copyright: "¬© 2025 MYQER ‚Äî Emergency Response QR ¬∑ GDPR/HIPAA-minded.",
                    privacy: "Privacy",
                    terms: "Terms",
                    about: "About",
                    support: "Support",
                    contact: "Contact"
                }
            },
            es: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (se pronuncia 'mi cuidado')",
                    tagline: "Privacidad primero. Funciona sin conexi√≥n."
                },
                nav: {
                    logout: "Cerrar sesi√≥n"
                },
                disclaimer: {
                    title: "Descargo de responsabilidad m√©dica",
                    text: "Esta informaci√≥n es solo para referencia de emergencia y no constituye consejo m√©dico. Los profesionales de la salud deben verificar independientemente toda la informaci√≥n m√©dica y hacer sus propias evaluaciones cl√≠nicas. MYQER‚Ñ¢ no es responsable de las decisiones m√©dicas tomadas bas√°ndose en estos datos."
                },
                identity: {
                    title: "Identidad",
                    subtitle: "Estos detalles ayudan a los socorristas a confirmar qui√©n eres.",
                    name: "Nombre completo",
                    name_placeholder: "Ingresa tu nombre completo",
                    dob: "Fecha de nacimiento",
                    country: "Pa√≠s",
                    select_country: "Seleccionar pa√≠s",
                    health_id: "ID de salud (NHS, etc.)",
                    health_id_placeholder: "Opcional - nunca se muestra p√∫blicamente",
                    health_id_note: "El ID de salud es opcional y nunca se muestra en tu tarjeta p√∫blica.",
                    code: "Tu c√≥digo de tarjeta",
                    code_placeholder: "Se generar√° autom√°ticamente",
                    generate: "Generar c√≥digo",
                    save: "Guardar perfil"
                },
                health: {
                    title: "Perfil de salud",
                    subtitle: "Mant√©n esto actualizado. Aparece en tu tarjeta de emergencia.",
                    blood: "Tipo de sangre",
                    unknown: "Desconocido",
                    donor: "Donante de √≥rganos",
                    not_specified: "No especificado",
                    allergies: "Alergias cr√≠ticas",
                    allergies_placeholder: "Escribe alergia y presiona Enter (ej., Penicilina, Nueces)",
                    conditions: "Condiciones m√©dicas",
                    conditions_placeholder: "Escribe condici√≥n y presiona Enter (ej., Diabetes, Hipertensi√≥n)",
                    meds: "Medicamentos actuales",
                    meds_placeholder: "Escribe medicamento y presiona Enter (ej., Insulina, Aspirina)",
                    implants: "Implantes y dispositivos",
                    implants_placeholder: "Incluye info de modelo/MRI (ej., Marcapasos no compatible con MRI)",
                    life_support: "Preferencia de soporte vital",
                    full_support: "Soporte vital completo",
                    comfort_care: "Solo cuidados paliativos",
                    dnr: "No resucitar",
                    burial: "Preferencia de entierro",
                    burial_option: "Entierro",
                    cremation: "Cremaci√≥n",
                    other: "Otro",
                    religion: "Preferencia religiosa/cultural",
                    none: "Ninguna",
                    save: "Guardar perfil de salud"
                },
                common: {
                    autosave: "Se guarda autom√°ticamente mientras escribes",
                    yes: "S√≠",
                    no: "No",
                    cancel: "Cancelar",
                    save: "Guardar",
                    delete: "Eliminar"
                }
            },
            fr: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (se prononce 'mes soins')",
                    tagline: "Confidentialit√© d'abord. Fonctionne hors ligne."
                },
                nav: {
                    logout: "Se d√©connecter"
                },
                disclaimer: {
                    title: "Avertissement m√©dical",
                    text: "Ces informations sont uniquement √† des fins de r√©f√©rence d'urgence et ne constituent pas un conseil m√©dical. Les professionnels de la sant√© doivent v√©rifier ind√©pendamment toutes les informations m√©dicales et faire leurs propres √©valuations cliniques. MYQER‚Ñ¢ n'est pas responsable des d√©cisions m√©dicales prises sur la base de ces donn√©es."
                },
                identity: {
                    title: "Identit√©",
                    subtitle: "Ces d√©tails aident les secouristes √† confirmer qui vous √™tes.",
                    name: "Nom complet",
                    name_placeholder: "Entrez votre nom complet",
                    dob: "Date de naissance",
                    country: "Pays",
                    select_country: "S√©lectionner le pays",
                    health_id: "ID sant√© (NHS, etc.)",
                    health_id_placeholder: "Optionnel - jamais affich√© publiquement",
                    health_id_note: "L'ID sant√© est optionnel et n'est jamais affich√© sur votre carte publique.",
                    code: "Votre code de carte",
                    code_placeholder: "Sera g√©n√©r√© automatiquement",
                    generate: "G√©n√©rer le code",
                    save: "Sauvegarder le profil"
                },
                common: {
                    autosave: "Sauvegarde automatique pendant que vous tapez",
                    yes: "Oui",
                    no: "Non",
                    cancel: "Annuler",
                    save: "Sauvegarder",
                    delete: "Supprimer"
                }
            },
            de: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (ausgesprochen 'meine Pflege')",
                    tagline: "Datenschutz zuerst. Funktioniert offline."
                },
                nav: {
                    logout: "Abmelden"
                },
                disclaimer: {
                    title: "Medizinischer Haftungsausschluss",
                    text: "Diese Informationen dienen nur als Notfallreferenz und stellen keine medizinische Beratung dar. Medizinische Fachkr√§fte m√ºssen alle medizinischen Informationen unabh√§ngig √ºberpr√ºfen und ihre eigenen klinischen Bewertungen vornehmen. MYQER‚Ñ¢ ist nicht verantwortlich f√ºr medizinische Entscheidungen, die auf diesen Daten basieren."
                },
                identity: {
                    title: "Identit√§t",
                    subtitle: "Diese Details helfen Rettungskr√§ften zu best√§tigen, wer Sie sind.",
                    name: "Vollst√§ndiger Name",
                    name_placeholder: "Geben Sie Ihren vollst√§ndigen Namen ein",
                    dob: "Geburtsdatum",
                    country: "Land",
                    select_country: "Land ausw√§hlen",
                    health_id: "Gesundheits-ID (NHS, etc.)",
                    health_id_placeholder: "Optional - wird nie √∂ffentlich angezeigt",
                    health_id_note: "Die Gesundheits-ID ist optional und wird nie auf Ihrer √∂ffentlichen Karte angezeigt.",
                    code: "Ihr Kartencode",
                    code_placeholder: "Wird automatisch generiert",
                    generate: "Code generieren",
                    save: "Profil speichern"
                },
                common: {
                    autosave: "Speichert automatisch w√§hrend der Eingabe",
                    yes: "Ja",
                    no: "Nein",
                    cancel: "Abbrechen",
                    save: "Speichern",
                    delete: "L√∂schen"
                }
            },
            it: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (pronunciato 'le mie cure')",
                    tagline: "Privacy prima di tutto. Funziona offline."
                },
                nav: {
                    logout: "Disconnetti"
                },
                disclaimer: {
                    title: "Disclaimer medico",
                    text: "Queste informazioni sono solo per riferimento di emergenza e non costituiscono consigli medici. I professionisti sanitari devono verificare indipendentemente tutte le informazioni mediche e fare le proprie valutazioni cliniche. MYQER‚Ñ¢ non √® responsabile per le decisioni mediche prese sulla base di questi dati."
                },
                identity: {
                    title: "Identit√†",
                    subtitle: "Questi dettagli aiutano i soccorritori a confermare chi sei.",
                    name: "Nome completo",
                    name_placeholder: "Inserisci il tuo nome completo",
                    dob: "Data di nascita",
                    country: "Paese",
                    select_country: "Seleziona paese",
                    health_id: "ID sanitario (NHS, ecc.)",
                    health_id_placeholder: "Opzionale - mai mostrato pubblicamente",
                    health_id_note: "L'ID sanitario √® opzionale e non viene mai mostrato sulla tua carta pubblica.",
                    code: "Il tuo codice carta",
                    code_placeholder: "Sar√† generato automaticamente",
                    generate: "Genera codice",
                    save: "Salva profilo"
                },
                common: {
                    autosave: "Salva automaticamente mentre digiti",
                    yes: "S√¨",
                    no: "No",
                    cancel: "Annulla",
                    save: "Salva",
                    delete: "Elimina"
                }
            },
            pt: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (pronuncia-se 'meus cuidados')",
                    tagline: "Privacidade em primeiro lugar. Funciona offline."
                },
                nav: {
                    logout: "Sair"
                },
                disclaimer: {
                    title: "Aviso m√©dico",
                    text: "Esta informa√ß√£o √© apenas para refer√™ncia de emerg√™ncia e n√£o constitui aconselhamento m√©dico. Os profissionais de sa√∫de devem verificar independentemente todas as informa√ß√µes m√©dicas e fazer suas pr√≥prias avalia√ß√µes cl√≠nicas. MYQER‚Ñ¢ n√£o √© respons√°vel por decis√µes m√©dicas tomadas com base nestes dados."
                },
                identity: {
                    title: "Identidade",
                    subtitle: "Estes detalhes ajudam os socorristas a confirmar quem voc√™ √©.",
                    name: "Nome completo",
                    name_placeholder: "Digite seu nome completo",
                    dob: "Data de nascimento",
                    country: "Pa√≠s",
                    select_country: "Selecionar pa√≠s",
                    health_id: "ID de sa√∫de (NHS, etc.)",
                    health_id_placeholder: "Opcional - nunca mostrado publicamente",
                    health_id_note: "O ID de sa√∫de √© opcional e nunca √© mostrado no seu cart√£o p√∫blico.",
                    code: "Seu c√≥digo do cart√£o",
                    code_placeholder: "Ser√° gerado automaticamente",
                    generate: "Gerar c√≥digo",
                    save: "Salvar perfil"
                },
                common: {
                    autosave: "Salva automaticamente enquanto voc√™ digita",
                    yes: "Sim",
                    no: "N√£o",
                    cancel: "Cancelar",
                    save: "Salvar",
                    delete: "Excluir"
                }
            }
        };
        
        // i18n Functions
        function getCurrentLanguage() {
            return localStorage.getItem('myqer_lang') || navigator.language.split('-')[0] || 'en';
        }
        
        function t(key) {
            const lang = getCurrentLanguage();
            const keys = key.split('.');
            let value = T[lang] || T.en;
            
            for (const k of keys) {
                value = value?.[k];
                if (!value) break;
            }
            
            // Fallback to English if translation not found
            if (!value && lang !== 'en') {
                value = T.en;
                for (const k of keys) {
                    value = value?.[k];
                    if (!value) break;
                }
            }
            
            return value || key;
        }
        
        function updateLanguage() {
            const lang = getCurrentLanguage();
            
            // Update document direction for RTL languages
            if (['ar', 'he'].includes(lang)) {
                document.dir = 'rtl';
            } else {
                document.dir = 'ltr';
            }
            
            // Update all elements with data-i18n attributes
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
            
            // Update language selector
            document.getElementById('languageSelect').value = lang;
        }
        
        // Supabase Configuration (Demo mode - replace with your actual values)
        const SUPABASE_URL = "https://demo.supabase.co";
        const SUPABASE_ANON_KEY = "demo-key";
        
        // Initialize Supabase client (with error handling for demo)
        let sb;
        try {
            sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.log('Supabase not configured, running in demo mode');
            // Mock Supabase client for demo
            sb = {
                auth: {
                    getSession: () => Promise.resolve({ data: { session: null } }),
                    signOut: () => Promise.resolve()
                },
                from: () => ({
                    select: () => ({ eq: () => ({ single: () => Promise.resolve({ data: null }) }) }),
                    insert: () => ({ select: () => ({ single: () => Promise.resolve({ data: { id: 'demo-id' } }) }) }),
                    upsert: () => Promise.resolve({ data: null }),
                    delete: () => ({ eq: () => Promise.resolve() })
                }),
                functions: {
                    invoke: () => Promise.resolve({ data: null })
                }
            };
        }
        
        // Global state
        let currentUser = null;
        let iceContactCount = 0;
        let saveTimeouts = {};
        let offlineQueue = [];
        let pillData = {
            allergies: [],
            conditions: [],
            medications: [],
            implants: []
        };
        let currentSpeech = null;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            updateLanguage();
            await checkAuth();
            setupEventListeners();
            setupPillInputs();
            loadUserData();
            registerServiceWorker();
            updateOfflineStatus();
            checkSpeechSupport();
        });
        
        // Check speech synthesis support
        function checkSpeechSupport() {
            if (!('speechSynthesis' in window)) {
                document.getElementById('speakTriageBtn').style.display = 'none';
                document.getElementById('speakCardBtn').style.display = 'none';
                document.getElementById('stopSpeechBtn').style.display = 'none';
            }
        }
        
        // Authentication check
        async function checkAuth() {
            try {
                const { data: { session } } = await sb.auth.getSession();
                if (!session) {
                    // For demo purposes, create a mock user session
                    console.log('No session found, creating demo session');
                    currentUser = {
                        id: 'demo-user-' + Math.random().toString(36).substr(2, 9),
                        email: 'demo@myqer.com'
                    };
                    return;
                }
                currentUser = session.user;
            } catch (error) {
                console.log('Auth check failed, using demo mode:', error);
                // Create demo user for testing
                currentUser = {
                    id: 'demo-user-' + Math.random().toString(36).substr(2, 9),
                    email: 'demo@myqer.com'
                };
            }
        }
        
        // Event listeners
        function setupEventListeners() {
            // Language selector
            document.getElementById('languageSelect').addEventListener('change', (e) => {
                localStorage.setItem('myqer_lang', e.target.value);
                updateLanguage();
                showToast('Language updated', 'success');
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await sb.auth.signOut();
                } catch (error) {
                    console.log('Demo logout');
                }
                showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            });
            
            // Auto-save inputs
            setupAutoSave();
            
            // ICE contacts
            document.getElementById('addIceContact').addEventListener('click', addIceContact);
            
            // Delete account modal
            document.getElementById('deleteAccountBtn').addEventListener('click', showDeleteModal);
            document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteAccount);
            document.getElementById('deleteConfirmInput').addEventListener('input', validateDeleteInput);
            document.getElementById('deleteUnderstand').addEventListener('change', validateDeleteInput);
            
            // Triage override
            document.getElementById('triageOverride').addEventListener('change', updateTriageStatus);
            
            // Generate code button
            document.getElementById('generateCodeBtn').addEventListener('click', generateEmergencyCode);
            
            // Save buttons
            document.getElementById('saveProfileBtn').addEventListener('click', () => saveUserData(true));
            document.getElementById('saveHealthBtn').addEventListener('click', () => saveUserData(true));
            
            // Speech buttons
            document.getElementById('speakTriageBtn').addEventListener('click', speakTriage);
            document.getElementById('speakCardBtn').addEventListener('click', speakEmergencyCard);
            document.getElementById('stopSpeechBtn').addEventListener('click', stopSpeech);
            
            // QR and card buttons
            document.getElementById('viewCardBtn').addEventListener('click', viewEmergencyCard);
            document.getElementById('printCardBtn').addEventListener('click', printEmergencyCard);
            document.getElementById('shareQrBtn').addEventListener('click', shareQrCode);
            document.getElementById('copyLinkBtn').addEventListener('click', copyCardLink);
            document.getElementById('exportPngBtn').addEventListener('click', () => exportQR('png'));
            document.getElementById('exportSvgBtn').addEventListener('click', () => exportQR('svg'));
        }
        
        // Delete account modal functions
        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('show');
        }
        
        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('deleteUnderstand').checked = false;
            validateDeleteInput();
        }
        
        function validateDeleteInput() {
            const input = document.getElementById('deleteConfirmInput').value;
            const checkbox = document.getElementById('deleteUnderstand').checked;
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            confirmBtn.disabled = !(input === 'DELETE' && checkbox);
        }
        
        // Enhanced delete account handling
        async function handleDeleteAccount() {
            try {
                showToast('Deleting account...', 'warning');
                
                // Call secured Edge Function for account deletion
                const { data, error } = await sb.functions.invoke('delete-account', {
                    body: { userId: currentUser.id }
                });
                
                if (error) {
                    throw error;
                }
                
                // Success - sign out and redirect
                showToast('Account deleted successfully', 'success');
                
                setTimeout(async () => {
                    await sb.auth.signOut();
                    window.location.href = '/?deleted=true';
                }, 2000);
                
            } catch (error) {
                console.error('Delete account error:', error);
                
                // Show guidance for manual deletion
                showToast('Delete failed - please contact support', 'error');
                setTimeout(() => {
                    alert('Please contact support@myqer.com for manual account deletion');
                }, 1000);
            }
            
            hideDeleteModal();
        }
        
        // Pill input setup
        function setupPillInputs() {
            const pillInputs = ['allergies', 'conditions', 'medications', 'implants'];
            
            pillInputs.forEach(type => {
                const input = document.getElementById(`${type}Input`);
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && input.value.trim()) {
                            e.preventDefault();
                            addPill(type, input.value.trim());
                            input.value = '';
                            debouncedSave(type);
                        }
                        if (e.key === 'Backspace' && !input.value && pillData[type].length > 0) {
                            removePill(type, pillData[type].length - 1);
                            debouncedSave(type);
                        }
                    });
                }
            });
        }
        
        // Pill management with validation
        function addPill(type, value) {
            // Trim and validate
            value = value.trim();
            if (!value || pillData[type].includes(value)) return;
            
            // Validation warnings (non-blocking)
            if (type === 'medications' && (value.toLowerCase().includes('many') || value.toLowerCase().includes('various'))) {
                showToast('Please be specific with medication names', 'warning');
            }
            
            pillData[type].push(value);
            renderPills(type);
        }
        
        function removePill(type, index) {
            pillData[type].splice(index, 1);
            renderPills(type);
        }
        
        function renderPills(type) {
            const container = document.getElementById(`${type}Pills`);
            if (!container) return;
            
            container.innerHTML = pillData[type].map((pill, index) => `
                <div class="pill">
                    ${pill}
                    <span class="pill-remove" onclick="removePillByIndex('${type}', ${index})">√ó</span>
                </div>
            `).join('');
        }
        
        function removePillByIndex(type, index) {
            removePill(type, index);
            debouncedSave(type);
        }
        
        // Auto-save functionality
        function setupAutoSave() {
            const autoSaveFields = [
                'fullName', 'dob', 'country', 'healthId', 'cardCode',
                'bloodType', 'organDonor', 'lifeSupportPref', 'burialPref', 'religionPref'
            ];
            
            autoSaveFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', () => debouncedSave(fieldId));
                    element.addEventListener('change', () => debouncedSave(fieldId));
                    element.addEventListener('blur', () => saveUserData(false, fieldId));
                }
            });
        }
        
        // Debounced save
        function debouncedSave(fieldId) {
            showSavingIndicator(fieldId);
            clearTimeout(saveTimeouts[fieldId]);
            saveTimeouts[fieldId] = setTimeout(() => {
                saveUserData(false, fieldId);
            }, 600);
        }
        
        // Save indicators
        function showSavingIndicator(fieldId) {
            const indicator = document.getElementById(`${fieldId}Indicator`);
            if (indicator) {
                indicator.innerHTML = `<div class="saving-dot"></div><span>Saving...</span>`;
            }
        }
        
        function showSavedIndicator(fieldId) {
            const indicator = document.getElementById(`${fieldId}Indicator`);
            if (indicator) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                indicator.innerHTML = `<span class="saved-check">‚úì Saved ${timestamp}</span>`;
            }
        }
        
        // Save user data
        async function saveUserData(immediate = false, specificField = null) {
            if (!currentUser) return;
            
            try {
                // Prepare profile data
                const profileData = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value,
                    health_id: maskHealthId(document.getElementById('healthId').value),
                    code: document.getElementById('cardCode').value,
                    updated_at: new Date().toISOString()
                };
                
                // Prepare health profile data
                const healthData = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value,
                    organ_donor: document.getElementById('organDonor').value === 'Yes',
                    allergies: pillData.allergies.join(', '),
                    conditions: pillData.conditions.join(', '),
                    meds: pillData.medications.join(', '),
                    implants: pillData.implants.join(', '),
                    life_support_pref: document.getElementById('lifeSupportPref').value,
                    burial_pref: document.getElementById('burialPref').value,
                    religion_pref: document.getElementById('religionPref').value,
                    triage_override: document.getElementById('triageOverride').value || null,
                    updated_at: new Date().toISOString()
                };
                
                // Save to Supabase with idempotent upserts
                await Promise.all([
                    sb.from('profiles').upsert(profileData, { onConflict: 'id' }),
                    sb.from('health_profiles').upsert(healthData, { onConflict: 'user_id' })
                ]);
                
                if (immediate) {
                    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    showToast(`Saved ${timestamp}`, 'success');
                } else if (specificField) {
                    showSavedIndicator(specificField);
                } else {
                    showToast('Saved', 'success');
                }
                
                updateTriageStatus();
                
            } catch (error) {
                console.error('Save error:', error);
                if (!navigator.onLine) {
                    // Queue for offline
                    offlineQueue.push({ profileData, healthData });
                    updateOfflineQueue();
                    showToast('No network - queued for sync', 'warning');
                } else {
                    showToast('Couldn\'t save', 'error');
                }
            }
        }
        
        // Health ID masking
        function maskHealthId(healthId) {
            if (!healthId || healthId.length <= 3) return healthId;
            return '*'.repeat(healthId.length - 3) + healthId.slice(-3);
        }
        
        // Load user data
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const [profileResult, healthResult, iceResult] = await Promise.all([
                    sb.from('profiles').select('*').eq('id', currentUser.id).single(),
                    sb.from('health_profiles').select('*').eq('user_id', currentUser.id).single(),
                    sb.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at')
                ]);
                
                // Populate profile data
                if (profileResult.data) {
                    const profile = profileResult.data;
                    document.getElementById('fullName').value = profile.full_name || '';
                    document.getElementById('dob').value = profile.dob || '';
                    document.getElementById('country').value = profile.country || '';
                    document.getElementById('healthId').value = profile.health_id || '';
                    document.getElementById('cardCode').value = profile.code || '';
                }
                
                // Populate health data
                if (healthResult.data) {
                    const health = healthResult.data;
                    document.getElementById('bloodType').value = health.blood_type || '‚Äî';
                    document.getElementById('organDonor').value = health.organ_donor ? 'Yes' : (health.organ_donor === false ? 'No' : '‚Äî');
                    
                    // Load pill data
                    pillData.allergies = health.allergies ? health.allergies.split(', ').filter(Boolean) : [];
                    pillData.conditions = health.conditions ? health.conditions.split(', ').filter(Boolean) : [];
                    pillData.medications = health.meds ? health.meds.split(', ').filter(Boolean) : [];
                    pillData.implants = health.implants ? health.implants.split(', ').filter(Boolean) : [];
                    
                    // Render pills
                    renderPills('allergies');
                    renderPills('conditions');
                    renderPills('medications');
                    renderPills('implants');
                    
                    document.getElementById('lifeSupportPref').value = health.life_support_pref || 'Full';
                    document.getElementById('burialPref').value = health.burial_pref || 'Burial';
                    document.getElementById('religionPref').value = health.religion_pref || 'None';
                    document.getElementById('triageOverride').value = health.triage_override || '';
                }
                
                // Populate ICE contacts
                if (iceResult.data) {
                    iceResult.data.forEach(contact => {
                        addIceContact(contact);
                    });
                }
                
                // Generate code if missing
                if (!document.getElementById('cardCode').value) {
                    generateEmergencyCode();
                } else {
                    // Update existing code display
                    const code = document.getElementById('cardCode').value;
                    updateCardLink(code);
                    generateQRCode(code);
                }
                
                updateTriageStatus();
                
            } catch (error) {
                console.error('Load error:', error);
                showToast('Error loading data', 'error');
            }
        }
        
        // ICE Contact management
        function addIceContact(existingContact = null) {
            if (iceContactCount >= 3) {
                showToast('Maximum 3 emergency contacts allowed', 'warning');
                return;
            }
            
            const container = document.getElementById('iceContacts');
            const contactId = existingContact?.id || `ice_${Date.now()}`;
            
            const contactDiv = document.createElement('div');
            contactDiv.className = 'border border-gray-200 rounded-lg p-4';
            contactDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" 
                               value="${existingContact?.name || ''}" data-field="name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Relationship</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" 
                               value="${existingContact?.relation || ''}" data-field="relation" placeholder="Spouse, Parent, etc.">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Phone</label>
                        <input type="tel" class="w-full px-2 py-1 border border-gray-300 rounded" 
                               value="${existingContact?.phone || ''}" data-field="phone" placeholder="+1234567890" required>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <button class="text-red-600 text-sm hover:text-red-800" onclick="removeIceContact('${contactId}')">
                        Remove Contact
                    </button>
                    <div class="text-xs text-gray-500">Auto-saves on blur</div>
                </div>
            `;
            
            contactDiv.dataset.contactId = contactId;
            container.appendChild(contactDiv);
            iceContactCount++;
            
            // Add auto-save listeners with blur trigger
            contactDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('blur', () => saveIceContact(contactId));
                input.addEventListener('input', () => debouncedSaveIce(contactId));
            });
            
            updateAddButtonState();
        }
        
        function removeIceContact(contactId) {
            if (!confirm('Remove this emergency contact?')) return;
            
            const contactDiv = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactDiv) {
                contactDiv.remove();
                iceContactCount--;
                updateAddButtonState();
                
                // Delete from database if it exists
                if (contactId.startsWith('ice_') === false) {
                    sb.from('ice_contacts').delete().eq('id', contactId);
                    showToast('Contact removed', 'success');
                }
            }
        }
        
        // Debounced ICE save
        function debouncedSaveIce(contactId) {
            clearTimeout(saveTimeouts[`ice_${contactId}`]);
            saveTimeouts[`ice_${contactId}`] = setTimeout(() => {
                saveIceContact(contactId);
            }, 600);
        }
        
        function updateAddButtonState() {
            const addBtn = document.getElementById('addIceContact');
            addBtn.disabled = iceContactCount >= 3;
            addBtn.textContent = iceContactCount >= 3 ? 'Maximum reached (3/3)' : `Add Contact (${iceContactCount}/3)`;
        }
        
        async function saveIceContact(contactId) {
            const contactDiv = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (!contactDiv) return;
            
            const name = contactDiv.querySelector('[data-field="name"]').value.trim();
            const relation = contactDiv.querySelector('[data-field="relation"]').value.trim();
            const phone = contactDiv.querySelector('[data-field="phone"]').value.trim();
            
            if (!name || !phone) return;
            
            try {
                // Normalize phone to E.164 format (basic)
                const normalizedPhone = phone.replace(/[^\d+]/g, '');
                
                const contactData = {
                    user_id: currentUser.id,
                    name,
                    relation,
                    phone: normalizedPhone
                };
                
                if (contactId.startsWith('ice_')) {
                    // New contact
                    const { data, error } = await sb.from('ice_contacts').insert(contactData).select().single();
                    if (error) throw error;
                    contactDiv.dataset.contactId = data.id;
                } else {
                    // Update existing
                    const { error } = await sb.from('ice_contacts').update(contactData).eq('id', contactId);
                    if (error) throw error;
                }
                
                showToast('Contact saved', 'success');
            } catch (error) {
                console.error('ICE save error:', error);
                
                // Handle duplicate constraint error
                if (error.message.includes('duplicate key value')) {
                    showToast('You already added this person', 'warning');
                } else {
                    showToast('Error saving contact', 'error');
                }
            }
        }
        
        // Enhanced triage status calculation
        function updateTriageStatus() {
            const override = document.getElementById('triageOverride').value;
            const statusElement = document.getElementById('triageStatus');
            
            if (override) {
                const statusMap = {
                    'Green': { class: 'triage-green', text: 'GREEN - Standard' },
                    'Amber': { class: 'triage-amber', text: 'AMBER - Urgent' },
                    'Red': { class: 'triage-red', text: 'RED - Immediate' },
                    'Black': { class: 'triage-black', text: 'BLACK - Comfort' }
                };
                
                const status = statusMap[override];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            } else {
                // Auto-calculate based on enhanced logic
                let calculatedStatus = 'Green';
                
                // Check life support preference first
                const lifeSupportPref = document.getElementById('lifeSupportPref').value;
                if (lifeSupportPref === 'DNR') {
                    calculatedStatus = 'Black';
                } else {
                    // Check for severe allergies
                    const allergies = pillData.allergies.join(' ').toLowerCase();
                    const severeAllergyKeywords = ['anaphylaxis', 'epipen', 'epinephrine', 'severe'];
                    
                    // Check conditions
                    const conditions = pillData.conditions.join(' ').toLowerCase();
                    const criticalConditions = ['cardiac', 'heart attack', 'stroke', 'epilepsy', 'seizure'];
                    
                    // Check medications
                    const medications = pillData.medications.join(' ').toLowerCase();
                    const criticalMeds = ['anticoagulant', 'warfarin', 'heparin', 'insulin'];
                    
                    // Determine status
                    if (severeAllergyKeywords.some(keyword => allergies.includes(keyword)) ||
                        criticalConditions.some(condition => conditions.includes(condition)) ||
                        criticalMeds.some(med => medications.includes(med))) {
                        calculatedStatus = 'Red';
                    } else if (pillData.conditions.length > 2 || pillData.medications.length > 3 ||
                               conditions.includes('diabetes') || conditions.includes('hypertension') ||
                               conditions.includes('chronic')) {
                        calculatedStatus = 'Amber';
                    }
                }
                
                const statusMap = {
                    'Green': { class: 'triage-green', text: 'GREEN - Standard (Auto)' },
                    'Amber': { class: 'triage-amber', text: 'AMBER - Urgent (Auto)' },
                    'Red': { class: 'triage-red', text: 'RED - Immediate (Auto)' },
                    'Black': { class: 'triage-black', text: 'BLACK - Comfort (Auto)' }
                };
                
                const status = statusMap[calculatedStatus];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            }
        }
        
        // Speech synthesis functionality
        function getVoice() {
            const voices = speechSynthesis.getVoices();
            const lang = getCurrentLanguage();
            
            // Try to find a female voice for the current language
            let voice = voices.find(v => v.lang.startsWith(lang) && v.name.toLowerCase().includes('female'));
            if (!voice) {
                voice = voices.find(v => v.lang.startsWith(lang));
            }
            if (!voice) {
                voice = voices.find(v => v.default);
            }
            
            return voice;
        }
        
        function speakText(text) {
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            const voice = getVoice();
            
            if (voice) {
                utterance.voice = voice;
            }
            
            utterance.rate = 0.95;
            utterance.pitch = 1.05;
            
            currentSpeech = utterance;
            speechSynthesis.speak(utterance);
            
            // Show/hide stop button
            document.getElementById('stopSpeechBtn').style.display = 'block';
            document.getElementById('speakTriageBtn').style.display = 'none';
            document.getElementById('speakCardBtn').style.display = 'none';
            
            utterance.onend = () => {
                currentSpeech = null;
                document.getElementById('stopSpeechBtn').style.display = 'none';
                document.getElementById('speakTriageBtn').style.display = 'block';
                document.getElementById('speakCardBtn').style.display = 'block';
            };
        }
        
        function stopSpeech() {
            if (currentSpeech) {
                speechSynthesis.cancel();
                currentSpeech = null;
                document.getElementById('stopSpeechBtn').style.display = 'none';
                document.getElementById('speakTriageBtn').style.display = 'block';
                document.getElementById('speakCardBtn').style.display = 'block';
            }
        }
        
        function speakTriage() {
            const name = document.getElementById('fullName').value || 'Patient';
            const triageStatus = document.getElementById('triageStatus').textContent;
            
            const text = `Triage status for ${name}: ${triageStatus}`;
            speakText(text);
        }
        
        function speakEmergencyCard() {
            const name = document.getElementById('fullName').value || 'Patient';
            const dob = document.getElementById('dob').value;
            const country = document.getElementById('country').value;
            const bloodType = document.getElementById('bloodType').value;
            const organDonor = document.getElementById('organDonor').value;
            const topAllergies = pillData.allergies.slice(0, 2).join(', ');
            const criticalMeds = pillData.medications.slice(0, 2).join(', ');
            const implants = pillData.implants.length > 0 ? pillData.implants[0] : '';
            const triageColor = document.getElementById('triageStatus').textContent.split(' ')[0];<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9776ac7384eabd98',t:'MTc1NjU4MTkyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
