<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MYQER Dashboard - Emergency Medical Information System</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* ========= Base / Theme ========= */
    *{margin:0;padding:0;box-sizing:border-box}
    html{font-size:16px;scroll-behavior:smooth}
    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      line-height:1.6;color:#1e293b;min-height:100vh;font-weight:400;
      background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 50%,#f1f5f9 100%);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    :root{
      --primary-red:#dc2626;--primary-red-hover:#b91c1c;--primary-red-light:#fecaca;
      --success-green:#059669;--success-green-hover:#047857;--warning-amber:#d97706;--warning-amber-hover:#b45309;
      --info-blue:#2563eb;--info-blue-hover:#1d4ed8;--ink-dark:#0f172a;
      --slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;
      --slate-200:#e2e8f0;--slate-100:#f1f5f9;--slate-50:#f8fafc;--white:#fff;
      --glass-bg:rgba(255,255,255,.85);--glass-border:rgba(255,255,255,.3);
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);--shadow-md:0 4px 6px rgba(0,0,0,.08);
      --shadow-lg:0 10px 15px rgba(0,0,0,.08);--shadow-xl:0 20px 25px rgba(0,0,0,.08);
      --shadow-2xl:0 25px 50px rgba(0,0,0,.25);
      --radius-lg:12px;--radius-xl:16px;--radius-2xl:24px;
      --spacing-sm:8px;--spacing-md:16px;--spacing-lg:24px;--spacing-xl:32px;--spacing-2xl:48px;--spacing-3xl:64px;
      --transition-normal:.2s ease-out;--transition-slow:.3s ease-out;
    }
    @media (prefers-color-scheme:dark){
      :root{
        --ink-dark:#f8fafc;--slate-700:#e2e8f0;--slate-600:#cbd5e1;--slate-500:#94a3b8;--slate-400:#64748b;--slate-300:#475569;--slate-200:#334155;--slate-100:#1e293b;--slate-50:#0f172a;
        --glass-bg:rgba(15,23,42,.85);--glass-border:rgba(255,255,255,.1);
      }
      body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#334155 100%);color:var(--slate-100)}
    }

    /* ========= Loading ========= */
    .loading-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity var(--transition-slow),visibility var(--transition-slow)}
    .loading-screen.hidden{opacity:0;visibility:hidden}
    .loading-logo{width:80px;height:80px;background:#fff;border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;color:var(--primary-red);margin-bottom:var(--spacing-lg);box-shadow:var(--shadow-2xl);animation:pulse 2s infinite}
    .loading-text{color:#fff;font-size:18px;font-weight:600;margin-bottom:6px}
    .loading-subtext{color:rgba(255,255,255,.85);font-size:14px}
    .spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top:4px solid #fff;border-radius:50%;animation:spin 1s linear infinite;margin-top:var(--spacing-lg)}
    @keyframes spin{to{transform:rotate(360deg)}}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    /* ========= Layout ========= */
    .main-container{max-width:1400px;margin:0 auto;padding:var(--spacing-lg);min-height:100vh}
    .header{background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:var(--radius-2xl);padding:var(--spacing-lg) var(--spacing-xl);margin-bottom:var(--spacing-2xl);box-shadow:var(--shadow-lg);position:sticky;top:24px;z-index:100}
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:var(--spacing-md);flex-wrap:wrap}
    .logo-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover));border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:20px;box-shadow:var(--shadow-md)}
    .logo-text{font-size:28px;font-weight:900;color:var(--ink-dark);letter-spacing:-.5px}
    .logo-subtitle{font-size:12px;color:var(--slate-500);font-weight:500;text-transform:uppercase;letter-spacing:1px;margin-top:-4px}
    .user-info{display:flex;align-items:center;gap:var(--spacing-md);padding:6px var(--spacing-md);background:rgba(255,255,255,.5);border-radius:12px;border:1px solid var(--slate-200)}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--info-blue),var(--info-blue-hover));border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}
    .user-email{font-size:14px;font-weight:500;color:#1f2937}
    .user-status{font-size:12px;color:var(--success-green);font-weight:600}
    .language-btn,.logout-btn{background:#fff;border:1px solid var(--slate-200);color:#334155;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
    .language-dropdown{position:absolute;top:calc(100% + 8px);right:0;background:#fff;border:1px solid var(--slate-200);border-radius:14px;box-shadow:var(--shadow-xl);z-index:1000;min-width:220px;max-height:320px;overflow:auto;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all .2s}
    .language-dropdown.show{opacity:1;visibility:visible;transform:translateY(0)}
    .language-option{padding:14px 18px;cursor:pointer;font-size:14px;font-weight:600}
    .language-option:hover{background:var(--slate-50)}.language-option.active{background:var(--primary-red);color:#fff}

    .offline-banner{background:linear-gradient(135deg,var(--warning-amber),var(--warning-amber-hover));color:#fff;padding:12px 16px;border-radius:12px;margin-bottom:16px;display:none;align-items:center;gap:12px;font-weight:700;box-shadow:var(--shadow-md)}
    .offline-banner.show{display:flex}

    /* ========= Cards ========= */
    .card{background:var(--glass-bg);backdrop-filter:blur(20px);border-radius:24px;padding:32px;margin-bottom:32px;box-shadow:var(--shadow-lg);border:1px solid var(--glass-border);position:relative;overflow:hidden;transition:all .2s}
    .card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:6px}
    .card.identity::before{background:linear-gradient(135deg,var(--success-green),var(--success-green-hover))}
    .card.critical::before{background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover))}
    .card.ice::before{background:linear-gradient(135deg,var(--warning-amber),var(--warning-amber-hover))}
    .card.emergency::before{background:linear-gradient(135deg,var(--info-blue),var(--info-blue-hover))}
    .card.delete{background:linear-gradient(135deg,rgba(220,38,38,.03),rgba(239,68,68,.03));border:2px solid rgba(220,38,38,.1)}
    .card.delete::before{background:linear-gradient(135deg,var(--primary-red),#ef4444)}
    .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--slate-200);gap:16px;flex-wrap:wrap}
    .card-title{font-size:24px;font-weight:800;color:var(--ink-dark);display:flex;align-items:center;gap:12px}
    .card-subtitle{font-size:14px;color:var(--slate-500);font-weight:500}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:24px}
    .form-group{display:flex;flex-direction:column;gap:8px}
    .form-label{font-size:14px;font-weight:700;color:#334155;text-transform:uppercase;letter-spacing:.5px}
    .form-label-required::after{content:'*';color:var(--primary-red);margin-left:4px}
    .form-input,.form-select,.form-textarea{
      padding:14px 16px;border:2px solid var(--slate-200);border-radius:12px;font-size:16px;background:#fff;color:#334155;transition:border .2s,box-shadow .2s
    }
    .form-textarea{min-height:120px;resize:vertical}
    .form-select{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");background-position:right 12px center;background-repeat:no-repeat;background-size:16px;padding-right:40px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer;border:none}
    .btn-primary{background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover));color:#fff}
    .btn-secondary{background:#fff;color:var(--primary-red);border:2px solid var(--primary-red)}
    .btn-success{background:linear-gradient(135deg,var(--success-green),var(--success-green-hover));color:#fff}
    .btn-warning{background:linear-gradient(135deg,var(--warning-amber),var(--warning-amber-hover));color:#fff}
    .btn-danger{background:linear-gradient(135deg,var(--primary-red),#ef4444);color:#fff}
    .btn-ghost{background:transparent;color:#475569;border:1px solid var(--slate-200)}

    /* Triage */
    .triage-container{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .triage-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:24px;font-size:12px;font-weight:900;text-transform:uppercase;box-shadow:var(--shadow-sm);color:#fff}
    .triage-green{background:linear-gradient(135deg,var(--success-green),var(--success-green-hover))}
    .triage-amber{background:linear-gradient(135deg,var(--warning-amber),var(--warning-amber-hover))}
    .triage-red{background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover))}
    .triage-black{background:linear-gradient(135deg,#374151,#1f2937)}
    .triage-indicator{width:8px;height:8px;border-radius:50%;background:currentColor}

    /* ICE */
    .ice-contacts-container{display:flex;flex-direction:column;gap:24px}
    .ice-contact{background:rgba(255,255,255,.7);border:2px solid var(--slate-200);border-radius:16px;padding:20px}
    .ice-contact-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--slate-200)}
    .ice-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}
    .no-contacts{text-align:center;padding:40px;color:var(--slate-500);background:var(--slate-50);border-radius:16px;border:2px dashed var(--slate-300)}

    /* QR */
    .qr-container{display:flex;flex-direction:column;align-items:center;gap:24px;text-align:center}
    .qr-box{width:280px;height:280px;background:#fff;border-radius:16px;padding:16px;box-shadow:var(--shadow-xl);border:3px solid var(--slate-200);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .qr-code-text{font-family:'Monaco','Menlo','Courier New',monospace;font-size:28px;font-weight:900;color:var(--ink-dark);letter-spacing:3px}
    .qr-label{font-size:14px;color:var(--primary-red);font-weight:900;letter-spacing:2px;text-transform:uppercase}

    /* Footer / Toast / Saving / Modal */
    .footer{margin-top:64px;padding:48px 0;border-top:2px solid var(--slate-200);background:var(--glass-bg);backdrop-filter:blur(20px);border-radius:24px 24px 0 0}
    .footer-content{display:flex;justify-content:space-between;align-items:center;gap:24px;flex-wrap:wrap}
    .footer-link{color:var(--slate-500);text-decoration:none;font-size:14px;font-weight:600}
    .toast{position:fixed;top:24px;right:24px;padding:16px 18px;border-radius:12px;color:#fff;font-weight:800;z-index:1000;transform:translateX(400px);transition:transform .3s;display:flex;align-items:center;gap:10px;max-width:420px}
    .toast.show{transform:translateX(0)}.toast.success{background:linear-gradient(135deg,var(--success-green),var(--success-green-hover))}.toast.error{background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover))}.toast.info{background:linear-gradient(135deg,var(--info-blue),var(--info-blue-hover))}.toast.warning{background:linear-gradient(135deg,var(--warning-amber),var(--warning-amber-hover))}
    .saving-indicator{position:fixed;bottom:24px;right:24px;background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--slate-200);border-radius:12px;padding:10px 14px;font-size:14px;font-weight:800;color:#334155;z-index:1000;opacity:0;transform:translateY(20px);transition:all .3s;display:flex;gap:8px;align-items:center}
    .saving-indicator.show{opacity:1;transform:translateY(0)}
    .saving-spinner{width:16px;height:16px;border:2px solid var(--slate-200);border-top:2px solid var(--primary-red);border-radius:50%;animation:spin 1s linear infinite}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:all .3s}
    .modal.show{opacity:1;visibility:visible}
    .modal-content{background:#fff;border-radius:24px;padding:36px;max-width:520px;width:90%;text-align:center;box-shadow:var(--shadow-2xl)}
    .hidden{display:none!important}

    /* Responsive */
    @media (max-width:768px){.main-container{padding:16px}.card{padding:20px}.qr-box{width:240px;height:240px}}
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-logo">M</div>
    <div class="loading-text">MYQER Dashboard</div>
    <div class="loading-subtext">Loading your emergency medical information...</div>
    <div class="spinner"></div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="main-container hidden">
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
      <i class="fas fa-wifi-slash"></i>
      <span data-i18n="offline_mode">You're offline. Changes will sync when connection is restored.</span>
    </div>

    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo-section" style="display:flex;align-items:center;gap:12px">
          <div class="logo-icon">M</div>
          <div>
            <div class="logo-text">MYQER</div>
            <div class="logo-subtitle">Emergency Medical System</div>
          </div>
        </div>

        <div class="header-actions" style="display:flex;align-items:center;gap:12px">
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-details">
              <div class="user-email" id="userEmail">user@example.com</div>
              <div class="user-status" data-i18n="online_status">Online</div>
            </div>
          </div>

          <div class="language-selector" style="position:relative">
            <button class="language-btn" onclick="toggleLanguageDropdown()">
              <span id="currentLanguage">🇺🇸 EN</span><i class="fas fa-chevron-down"></i>
            </button>
            <div id="languageDropdown" class="language-dropdown">
              <div class="language-option active" onclick="changeLanguage('en')">🇺🇸 English</div>
              <div class="language-option" onclick="changeLanguage('es')">🇪🇸 Español</div>
              <div class="language-option" onclick="changeLanguage('fr')">🇫🇷 Français</div>
              <div class="language-option" onclick="changeLanguage('de')">🇩🇪 Deutsch</div>
              <div class="language-option" onclick="changeLanguage('it')">🇮🇹 Italiano</div>
              <div class="language-option" onclick="changeLanguage('pt')">🇵🇹 Português</div>
              <div class="language-option" onclick="changeLanguage('ro')">🇷🇴 Română</div>
              <div class="language-option" onclick="changeLanguage('ar')">🇸🇦 العربية</div>
              <div class="language-option" onclick="changeLanguage('hi')">🇮🇳 हिन्दी</div>
              <div class="language-option" onclick="changeLanguage('zh')">🇨🇳 中文</div>
            </div>
          </div>

          <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span data-i18n="logout">Logout</span></button>
        </div>
      </div>
    </header>
          <!-- Identity Card -->
    <div class="card identity">
      <div class="card-header">
        <div>
          <h2 class="card-title"><span class="card-icon" style="width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--success-green),var(--success-green-hover));display:flex;align-items:center;justify-content:center;color:#fff"><i class="fas fa-id-card"></i></span><span data-i18n="identity_title">Identity — Personal Information</span></h2>
          <p class="card-subtitle" data-i18n="identity_subtitle">Your basic personal and identification details</p>
        </div>
        <div class="card-actions">
          <button class="btn btn-success" onclick="saveProfile()"><i class="fas fa-save"></i><span data-i18n="save">Save</span></button>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label form-label-required" data-i18n="full_name">Full Name</label>
          <input type="text" id="fullName" class="form-input" placeholder="Enter your full legal name" required>
          <div class="form-help" data-i18n="full_name_help">Enter your complete legal name as it appears on official documents</div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="date_of_birth">Date of Birth</label>
          <input type="date" id="dob" class="form-input">
          <div class="form-help" data-i18n="dob_help">Used for age verification in medical emergencies</div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="country">Country</label>
          <select id="country" class="form-select">
            <option value="">Select Country</option>
            <option>United States</option><option>Canada</option><option>United Kingdom</option>
            <option>Germany</option><option>France</option><option>Spain</option><option>Italy</option>
            <option>Australia</option><option>Japan</option><option>China</option><option>India</option>
            <option>Brazil</option><option>Mexico</option><option>Argentina</option><option>South Africa</option>
            <option>Nigeria</option><option>Egypt</option><option>Russia</option><option>Turkey</option><option>Saudi Arabia</option>
          </select>
          <div class="form-help" data-i18n="country_help">Helps emergency responders understand local medical systems</div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="health_id">National/Health ID (Optional)</label>
          <input type="text" id="healthId" class="form-input" placeholder="e.g., SSN, NHS Number, Health Card">
          <div class="form-help" data-i18n="health_id_help">National health identifier for faster medical record access</div>
        </div>
      </div>
    </div>

    <!-- Critical Medical Information -->
    <div class="card critical">
      <div class="card-header">
        <div>
          <h2 class="card-title"><span class="card-icon" style="width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover));display:flex;align-items:center;justify-content:center;color:#fff"><i class="fas fa-heartbeat"></i></span><span data-i18n="critical_title">CRITICAL — Medical & Health Details</span></h2>
          <p class="card-subtitle" data-i18n="critical_subtitle">Life-saving medical information for emergency responders</p>
        </div>
        <div class="card-actions">
          <div class="triage-container">
            <select id="triageOverride" class="form-select" style="min-width:140px" onchange="updateTriage()">
              <option value="auto" data-i18n="auto">Auto</option>
              <option value="green" data-i18n="green">Green</option>
              <option value="amber" data-i18n="amber">Amber</option>
              <option value="red" data-i18n="red">Red</option>
              <option value="black" data-i18n="black">Black</option>
            </select>
            <div id="triagePill" class="triage-pill triage-green"><div class="triage-indicator"></div><span data-i18n="green">Green</span></div>
          </div>
          <button class="btn btn-warning" onclick="saveHealth()"><i class="fas fa-save"></i><span data-i18n="save">Save</span></button>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label" data-i18n="blood_type">Blood Type</label>
          <select id="bloodType" class="form-select" onchange="updateTriage()">
            <option value="">Select Blood Type</option>
            <option value="A+">A+</option><option value="A-">A-</option>
            <option value="B+">B+</option><option value="B-">B-</option>
            <option value="AB+">AB+</option><option value="AB-">AB-</option>
            <option value="O+">O+</option><option value="O-">O-</option>
          </select>
          <div class="form-help" data-i18n="blood_type_help">Critical for blood transfusions and medical procedures</div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="allergies">Critical Allergies</label>
          <input type="text" id="allergies" class="form-input" placeholder="e.g., Penicillin, Nuts, Shellfish, Latex" onchange="updateTriage()">
          <div class="form-help" data-i18n="allergies_help">List all known allergies that could cause severe reactions</div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="conditions">Medical Conditions</label>
          <textarea id="conditions" class="form-textarea" placeholder="Chronic conditions (e.g., Diabetes, Hypertension, Epilepsy)" onchange="updateTriage()"></textarea>
          <div class="form-help" data-i18n="conditions_help">Include chronic diseases, mental health conditions, and ongoing treatments</div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="medications">Current Medications</label>
          <textarea id="medications" class="form-textarea" placeholder="List all current medications with dosages" onchange="updateTriage()"></textarea>
          <div class="form-help" data-i18n="medications_help">Include prescriptions, OTC meds, and supplements</div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="implants">Implants/Medical Devices</label>
          <input type="text" id="implants" class="form-input" placeholder="e.g., Pacemaker, Insulin pump" onchange="updateTriage()">
          <div class="form-help" data-i18n="implants_help">Devices that could affect treatment or require special consideration</div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="organDonor" class="checkbox">
            <label for="organDonor" class="checkbox-label" data-i18n="organ_donor">I am an organ donor</label>
          </div>
          <div class="form-help" data-i18n="organ_donor_help">Indicates your consent for organ donation in case of brain death</div>
        </div>
      </div>
    </div>

    <!-- Emergency Contacts (ICE) -->
    <div class="card ice">
      <div class="card-header">
        <div>
          <h2 class="card-title"><span class="card-icon" style="width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--warning-amber),var(--warning-amber-hover));display:flex;align-items:center;justify-content:center;color:#fff"><i class="fas fa-phone-alt"></i></span><span data-i18n="ice_title">Emergency Contacts (ICE)</span></h2>
          <p class="card-subtitle" data-i18n="ice_subtitle">People to contact in case of emergency (maximum 3 contacts)</p>
        </div>
        <div class="card-actions">
          <button class="btn btn-secondary" onclick="addContact()" id="addContactBtn"><i class="fas fa-plus"></i><span data-i18n="add_contact">Add Contact</span></button>
          <button class="btn btn-warning" onclick="saveICE()"><i class="fas fa-save"></i><span data-i18n="save_all">Save All</span></button>
        </div>
      </div>
      <div id="iceContacts" class="ice-contacts-container">
        <div class="no-contacts">
          <div class="no-contacts-icon"><i class="fas fa-address-book" style="font-size:48px"></i></div>
          <div data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>
        </div>
      </div>
    </div>

    <!-- Emergency Card & QR -->
    <div class="card emergency">
      <div class="card-header">
        <div>
          <h2 class="card-title"><span class="card-icon" style="width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--info-blue),var(--info-blue-hover));display:flex;align-items:center;justify-content:center;color:#fff"><i class="fas fa-qrcode"></i></span><span data-i18n="qr_title">Emergency Card & QR Code</span></h2>
          <p class="card-subtitle" data-i18n="qr_subtitle">Your unique emergency medical information access code</p>
        </div>
      </div>

      <div class="qr-container">
        <div class="qr-box"><div id="qrcode"></div></div>
        <div class="qr-code-text" id="qrCodeText">MQ7X9K</div>
        <div class="qr-label">MYQER™ EMERGENCY ACCESS</div>

        <div class="qr-url-section" style="width:100%;max-width:600px">
          <div class="url-group" style="display:flex;gap:12px">
            <input type="text" id="cardUrl" class="form-input" readonly value="https://www.myqer.com/c/MQ7X9K" style="flex:1;font-family:'Monaco','Menlo',monospace">
            <button class="btn btn-secondary" onclick="copyUrl()"><i class="fas fa-copy"></i><span data-i18n="copy">Copy</span></button>
            <button class="btn btn-secondary" onclick="openUrl()"><i class="fas fa-external-link-alt"></i><span data-i18n="open">Open</span></button>
          </div>
        </div>

        <div class="qr-actions" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
          <button class="btn btn-ghost" onclick="downloadQR('png')"><i class="fas fa-download"></i><span data-i18n="download_png">Download PNG</span></button>
          <button class="btn btn-ghost" onclick="downloadQR('svg')"><i class="fas fa-download"></i><span data-i18n="download_svg">Download SVG</span></button>
          <button class="btn btn-ghost" onclick="printQR()"><i class="fas fa-print"></i><span data-i18n="print">Print Card</span></button>
          <button class="btn btn-primary" onclick="generateQRCode()"><i class="fas fa-sync-alt"></i><span data-i18n="regenerate">Regenerate</span></button>
        </div>
      </div>
    </div>

    <!-- Delete Account -->
    <div class="card delete">
      <div class="delete-section" style="text-align:center">
        <h2 class="delete-title" style="color:var(--primary-red);font-weight:900"><i class="fas fa-exclamation-triangle"></i> <span data-i18n="delete_title">Delete Account</span></h2>
        <p class="delete-warning" data-i18n="delete_warning">This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers. Your emergency contacts will no longer be able to access your medical information.</p>
        <div class="form-group" style="max-width:420px;margin:0 auto 16px">
          <label class="form-label" data-i18n="delete_confirm_label">Type "DELETE MY ACCOUNT" to confirm:</label>
          <input type="text" id="deleteConfirm" class="form-input" placeholder="DELETE MY ACCOUNT">
        </div>
        <button class="btn btn-danger" onclick="deleteAccount()"><i class="fas fa-trash-alt"></i> <span data-i18n="delete_account">Delete My Account Permanently</span></button>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-logo" style="display:flex;align-items:center;gap:10px">
          <div class="footer-logo-icon" style="width:32px;height:32px;background:linear-gradient(135deg,var(--primary-red),var(--primary-red-hover));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800">M</div>
          <div class="footer-logo-text" style="font-weight:800">MYQER</div>
        </div>
        <div class="footer-links" style="display:flex;gap:24px;flex-wrap:wrap">
          <a href="#" class="footer-link" data-i18n="privacy_policy">Privacy Policy</a>
          <a href="#" class="footer-link" data-i18n="terms_of_service">Terms of Service</a>
          <a href="#" class="footer-link" data-i18n="support">Support</a>
          <a href="#" class="footer-link" data-i18n="about">About MYQER</a>
        </div>
        <div class="footer-copyright" data-i18n="copyright" style="width:100%;text-align:center;color:var(--slate-400)">© 2024 MYQER. All rights reserved. Saving lives through technology.</div>
      </div>
    </footer>
  </div><!-- /#dashboard -->

  <!-- Toast -->
  <div id="toast" class="toast">
    <div class="toast-icon"></div>
    <div class="toast-message"></div>
    <button class="btn btn-ghost" style="padding:4px 8px" onclick="hideToast()"><i class="fas fa-times"></i></button>
  </div>

  <!-- Saving Indicator -->
  <div id="savingIndicator" class="saving-indicator">
    <div class="saving-spinner"></div>
    <span data-i18n="saving">Saving...</span>
  </div>

  <!-- Idle Modal -->
  <div id="idleModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title" style="font-size:28px;font-weight:900;color:var(--primary-red)">
        <i class="fas fa-clock"></i> <span data-i18n="session_expiring">Session Expiring</span>
      </h3>
      <p class="modal-text"><span data-i18n="session_expire_text">Your session will expire in</span> <strong><span id="countdown">60</span></strong> <span data-i18n="seconds">seconds due to inactivity.</span></p>
      <div class="modal-actions" style="display:flex;gap:12px;justify-content:center">
        <button class="btn btn-primary" onclick="resetIdleTimer()"><i class="fas fa-refresh"></i> <span data-i18n="stay_logged_in">Stay Logged In</span></button>
        <button class="btn btn-secondary" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
      </div>
    </div>
  </div>
      <script>
    /* ======= State ======= */
    let currentUser = { email: 'user@example.com', id: 'demo-user-123' };
    let iceContacts = [];
    let idleTimer = null, warningTimer = null, countdownTimer = null;
    let countdownSeconds = 60, debounceTimers = {}, isOnline = navigator.onLine;
    let currentLanguage = 'en', userCode = 'MQ7X9K', isGeneratingQR = false;

    const FATAL_KEYWORDS = [
      'anaphylaxis','anaphylactic','epi-pen','epipen','epinephrine','shock','cardiac arrest',
      'heart attack','stroke','seizure','epilepsy','pacemaker','defibrillator','insulin pump',
      'severe asthma','hemophilia','blood clotting','bleeding disorder','aneurysm','transplant','dialysis',
      'chemotherapy','radiation','cancer','tumor','malignant','metastatic','life threatening','critical','emergency','fatal','deadly'
    ];

    const translations = {
      en:{offline_mode:"You're offline. Changes will sync when connection is restored.",online_status:"Online",logout:"Logout",
          identity_title:"Identity — Personal Information",identity_subtitle:"Your basic personal and identification details",save:"Save",
          full_name:"Full Name",full_name_help:"Enter your complete legal name as it appears on official documents",
          date_of_birth:"Date of Birth",dob_help:"Used for age verification in medical emergencies",
          country:"Country",country_help:"Helps emergency responders understand local medical systems",
          health_id:"National/Health ID (Optional)",health_id_help:"National health identifier for faster medical record access",
          critical_title:"CRITICAL — Medical & Health Details",critical_subtitle:"Life-saving medical information for emergency responders",
          auto:"Auto",green:"Green",amber:"Amber",red:"Red",black:"Black",blood_type:"Blood Type",
          blood_type_help:"Critical for blood transfusions and medical procedures",
          allergies:"Critical Allergies",allergies_help:"List all known allergies that could cause severe reactions",
          conditions:"Medical Conditions",conditions_help:"Include chronic diseases, mental health conditions, and ongoing treatments",
          medications:"Current Medications",medications_help:"Include prescription drugs, over-the-counter medications, and supplements",
          implants:"Implants/Medical Devices",implants_help:"Medical devices that could affect treatment or require special consideration",
          organ_donor:"I am an organ donor",organ_donor_help:"Indicates your consent for organ donation in case of brain death",
          ice_title:"Emergency Contacts (ICE)",ice_subtitle:"People to contact in case of emergency (maximum 3 contacts)",
          add_contact:"Add Contact",save_all:"Save All",
          qr_title:"Emergency Card & QR Code",qr_subtitle:"Your unique emergency medical information access code",
          copy:"Copy",open:"Open",download_png:"Download PNG",download_svg:"Download SVG",print:"Print Card",regenerate:"Regenerate",
          delete_title:"Delete Account",delete_warning:"This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers. Your emergency contacts will no longer be able to access your medical information.",
          delete_confirm_label:'Type "DELETE MY ACCOUNT" to confirm:',delete_account:"Delete My Account Permanently",
          copyright:"© 2024 MYQER. All rights reserved. Saving lives through technology.",
          privacy_policy:"Privacy Policy",terms_of_service:"Terms of Service",support:"Support",about:"About MYQER",saving:"Saving...",
          session_expiring:"Session Expiring",session_expire_text:"Your session will expire in",seconds:"seconds due to inactivity.",
          stay_logged_in:"Stay Logged In",contact_name:"Name",contact_relationship:"Relationship",contact_phone:"Phone",remove:"Remove",
          no_contacts:'No emergency contacts added yet. Click "Add Contact" to get started.',
          profile_saved:"Profile saved successfully",health_saved:"Health data saved successfully",ice_saved:"Emergency contacts saved successfully",
          url_copied:"URL copied to clipboard",qr_downloaded:"QR code downloaded successfully",account_deleted:"Account deleted successfully",
          save_error:"Failed to save data",network_error:"Network error. Please check your connection.",
          validation_error:"Please fill in all required fields",max_contacts:"Maximum 3 emergency contacts allowed",
          confirm_delete:'Please type "DELETE MY ACCOUNT" exactly to confirm'},
      es:{ /* short set just to prove fallback exists; keep en for others */ 
          offline_mode:"Estás desconectado. Los cambios se sincronizarán cuando se restaure la conexión.",
          online_status:"En línea",logout:"Cerrar Sesión",
          identity_title:"Identidad — Información Personal",identity_subtitle:"Tus datos personales básicos y de identificación",
          save:"Guardar",full_name:"Nombre Completo",full_name_help:"Ingresa tu nombre legal completo",
          date_of_birth:"Fecha de Nacimiento",dob_help:"Usado para verificación de edad",
          country:"País",country_help:"Ayuda a entender sistemas médicos locales",
          health_id:"ID Nacional/Salud (Opcional)",health_id_help:"Identificador de salud",
          critical_title:"CRÍTICO — Detalles Médicos y de Salud",critical_subtitle:"Información vital para socorristas",
          auto:"Auto",green:"Verde",amber:"Ámbar",red:"Rojo",black:"Negro",
          blood_type:"Tipo de Sangre",blood_type_help:"Crítico para transfusiones",
          allergies:"Alergias Críticas",allergies_help:"Lista alergias severas",
          conditions:"Condiciones Médicas",conditions_help:"Incluye enfermedades crónicas",
          medications:"Medicamentos Actuales",medications_help:"Incluye recetados y OTC",
          implants:"Implantes/Dispositivos Médicos",implants_help:"Dispositivos relevantes",
          organ_donor:"Soy donante de órganos",organ_donor_help:"Consentimiento para donación",
          ice_title:"Contactos de Emergencia (ICE)",ice_subtitle:"Máximo 3 contactos",
          add_contact:"Agregar Contacto",save_all:"Guardar Todo",
          qr_title:"Tarjeta de Emergencia y Código QR",qr_subtitle:"Tu código único",
          copy:"Copiar",open:"Abrir",download_png:"Descargar PNG",download_svg:"Descargar SVG",print:"Imprimir Tarjeta",regenerate:"Regenerar",
          delete_title:"Eliminar Cuenta",delete_warning:"Esta acción no se puede deshacer.",
          delete_confirm_label:'Escribe "DELETE MY ACCOUNT" para confirmar:',delete_account:"Eliminar Mi Cuenta Permanentemente",
          copyright:"© 2024 MYQER. Todos los derechos reservados.",privacy_policy:"Política de Privacidad",
          terms_of_service:"Términos de Servicio",support:"Soporte",about:"Acerca de MYQER",saving:"Guardando...",
          session_expiring:"Sesión Expirando",session_expire_text:"Tu sesión expirará en",seconds:"segundos por inactividad.",
          stay_logged_in:"Mantener Sesión",contact_name:"Nombre",contact_relationship:"Relación",contact_phone:"Teléfono",remove:"Eliminar",
          no_contacts:'No hay contactos. Pulsa "Agregar Contacto".',
          profile_saved:"Perfil guardado",health_saved:"Salud guardada",ice_saved:"Contactos guardados",
          url_copied:"URL copiada",qr_downloaded:"QR descargado",account_deleted:"Cuenta eliminada",
          save_error:"Error al guardar",network_error:"Error de red",validation_error:"Completa los campos requeridos",
          max_contacts:"Máximo 3 contactos",confirm_delete:'Escribe "DELETE MY ACCOUNT" exactamente'}
    };

    /* ======= Init ======= */
    document.addEventListener('DOMContentLoaded', init);

    async function init(){
      try{
        updateUserInfo();
        setupOnlineDetection();
        setupEventListeners();

        const savedLanguage = localStorage.getItem('myqer_language') || 'en';
        changeLanguage(savedLanguage);

        await loadAll();
        setupAutosave();
        setupIdleTimer();
      }catch(err){
        console.error('Initialization error:', err);
        showToast('Failed to load dashboard','error');
      }finally{
        // Always show UI
        setTimeout(()=>{
          document.getElementById('loadingScreen').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
        },200);
      }
    }

    /* ======= Helpers / User ======= */
    function updateUserInfo(){
      const email = currentUser.email;
      document.getElementById('userEmail').textContent = email;
      document.getElementById('userAvatar').textContent = (email[0]||'U').toUpperCase();
    }
    function generateRandomCode(){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let r=''; for(let i=0;i<6;i++) r+=chars[Math.floor(Math.random()*chars.length)];
      return r;
    }

    function getProfileData(){ return {
      fullName: (document.getElementById('fullName').value || '').trim() || null,
      dob: document.getElementById('dob').value || null,
      country: document.getElementById('country').value || null,
      healthId: (document.getElementById('healthId').value || '').trim() || null
    };}

    function getHealthData(){ return {
      bloodType: document.getElementById('bloodType').value || null,
      allergies: (document.getElementById('allergies').value || '').trim() || null,
      conditions: (document.getElementById('conditions').value || '').trim() || null,
      medications: (document.getElementById('medications').value || '').trim() || null,
      implants: (document.getElementById('implants').value || '').trim() || null,
      organDonor: document.getElementById('organDonor').checked,
      triageOverride: document.getElementById('triageOverride').value || 'auto'
    };}

    /* ======= QR ======= */
    async function generateQRCode(){
      if (isGeneratingQR) return;
      isGeneratingQR = true;
      try{
        userCode = generateRandomCode();
        const liveUrl = `https://www.myqer.com/c/${userCode}`;
        const holder = document.getElementById('qrcode');
        holder.innerHTML = '';
        const canvas = document.createElement('canvas');   // create a canvas (fix)
        holder.appendChild(canvas);
        await QRCode.toCanvas(canvas, liveUrl, {
          width:240, margin:1, color:{dark:'#0f172a', light:'#ffffff'}
        });
        document.getElementById('qrCodeText').textContent = userCode;
        document.getElementById('cardUrl').value = liveUrl;
        showToast('QR code generated successfully','success');
      }catch(e){
        console.error('QR generation error:', e);
        showToast('Failed to generate QR code','error');
      }finally{ isGeneratingQR = false; }
    }

    /* ======= Load / Save ======= */
    async function loadAll(){
      await loadFromLocalStorage();
      await generateQRCode();
    }

    async function loadFromLocalStorage(){
      const p = localStorage.getItem('myqer_profile');
      if(p){ const d=JSON.parse(p); fullName.value=d.fullName||''; dob.value=d.dob||''; country.value=d.country||''; healthId.value=d.healthId||''; }
      const h = localStorage.getItem('myqer_health');
      if(h){ const d=JSON.parse(h);
        bloodType.value=d.bloodType||''; allergies.value=d.allergies||''; conditions.value=d.conditions||'';
        medications.value=d.medications||''; implants.value=d.implants||''; organDonor.checked=!!d.organDonor;
        triageOverride.value=d.triageOverride||'auto';
      }
      const ice = localStorage.getItem('myqer_ice');
      if(ice){ iceContacts = JSON.parse(ice); renderICE(); }
      updateTriage();
    }

    function updateTriage(){
      const override = document.getElementById('triageOverride').value;
      const pill = document.getElementById('triagePill'); const pillText = pill.querySelector('span');
      const t = translations[currentLanguage] || translations.en;

      if(override !== 'auto'){ pill.className = `triage-pill triage-${override}`; pillText.textContent = t[override]; return; }

      const allText = `${allergies.value} ${conditions.value} ${medications.value} ${implants.value}`.toLowerCase();
      let fatal = FATAL_KEYWORDS.some(k => allText.includes(k.toLowerCase()));
      if(fatal){ pill.className='triage-pill triage-red'; pillText.textContent=t.red; }
      else if(allergies.value.trim() || conditions.value.trim() || implants.value.trim()){
        pill.className='triage-pill triage-amber'; pillText.textContent=t.amber;
      }else{ pill.className='triage-pill triage-green'; pillText.textContent=t.green; }
    }

    async function saveProfile(){
      try{
        showSavingIndicator();
        const data = getProfileData();
        if(!data.fullName){ showToast((translations[currentLanguage]||translations.en).validation_error,'error'); return; }
        localStorage.setItem('myqer_profile', JSON.stringify(data));
        showToast((translations[currentLanguage]||translations.en).profile_saved,'success');
        await generateQRCode();
      }catch(e){ console.error(e); showToast((translations[currentLanguage]||translations.en).save_error,'error'); }
      finally{ hideSavingIndicator(); }
    }

    async function saveHealth(){
      try{
        showSavingIndicator();
        const data = getHealthData();
        localStorage.setItem('myqer_health', JSON.stringify(data));
        showToast((translations[currentLanguage]||translations.en).health_saved,'success');
        updateTriage(); await generateQRCode();
      }catch(e){ console.error(e); showToast((translations[currentLanguage]||translations.en).save_error,'error'); }
      finally{ hideSavingIndicator(); }
    }

    async function saveICE(){
      try{
        showSavingIndicator();
        localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
        showToast((translations[currentLanguage]||translations.en).ice_saved,'success');
        await generateQRCode();
      }catch(e){ console.error(e); showToast((translations[currentLanguage]||translations.en).save_error,'error'); }
      finally{ hideSavingIndicator(); }
    }

    /* ======= ICE Contacts ======= */
    function addContact(){
      if(iceContacts.length>=3){ showToast((translations[currentLanguage]||translations.en).max_contacts,'error'); return; }
      iceContacts.push({id:Date.now().toString(),name:'',relation:'',phone:''});
      renderICE(); updateAddContactButton();
    }
    function removeContact(id){ iceContacts = iceContacts.filter(c=>c.id!==id); renderICE(); updateAddContactButton(); }
    function updateContact(id, field, value){
      const c = iceContacts.find(x=>x.id===id); if(c){ c[field]=value; localStorage.setItem('myqer_ice', JSON.stringify(iceContacts)); }
    }
    function updateAddContactButton(){
      const btn = document.getElementById('addContactBtn');
      if(iceContacts.length>=3){ btn.disabled=true; btn.innerHTML='<i class="fas fa-ban"></i> <span>Maximum Reached</span>'; }
      else{ btn.disabled=false; btn.innerHTML=`<i class="fas fa-plus"></i> <span data-i18n="add_contact">${(translations[currentLanguage]||translations.en).add_contact}</span>`; }
    }
    function renderICE(){
      const t = translations[currentLanguage]||translations.en;
      const container = document.getElementById('iceContacts');
      if(iceContacts.length===0){
        container.innerHTML = `<div class="no-contacts"><div class="no-contacts-icon"><i class="fas fa-address-book" style="font-size:48px"></i></div><div data-i18n="no_contacts">${t.no_contacts}</div></div>`;
        return;
      }
      container.innerHTML = iceContacts.map((c,i)=>`
        <div class="ice-contact">
          <div class="ice-contact-header">
            <h4 class="ice-contact-title" style="display:flex;align-items:center;gap:8px">
              <span class="ice-contact-number" style="background:var(--warning-amber);color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900">${i+1}</span>
              Emergency Contact ${i+1}
            </h4>
            <button class="btn btn-danger btn-sm" onclick="removeContact('${c.id}')"><i class="fas fa-trash"></i> <span data-i18n="remove">${t.remove}</span></button>
          </div>
          <div class="ice-grid">
            <div class="form-group">
              <label class="form-label" data-i18n="contact_name">${t.contact_name}</label>
              <input type="text" class="form-input" value="${c.name||''}" onchange="updateContact('${c.id}','name',this.value)" placeholder="Full name">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="contact_relationship">${t.contact_relationship}</label>
              <input type="text" class="form-input" value="${c.relation||''}" onchange="updateContact('${c.id}','relation',this.value)" placeholder="e.g., Spouse, Parent">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="contact_phone">${t.contact_phone}</label>
              <input type="tel" class="form-input" value="${c.phone||''}" onchange="updateContact('${c.id}','phone',this.value)" placeholder="+1 (555) 123-4567">
            </div>
          </div>
        </div>
      `).join('');
      updateAddContactButton();
    }

    /* ======= QR Actions ======= */
    async function copyUrl(){
      const val = document.getElementById('cardUrl').value;
      try{
        await navigator.clipboard.writeText(val);
        showToast((translations[currentLanguage]||translations.en).url_copied,'success');
      }catch{
        const input = document.getElementById('cardUrl'); input.select(); document.execCommand('copy');
        showToast((translations[currentLanguage]||translations.en).url_copied,'success');
      }
    }
    function openUrl(){ window.open(document.getElementById('cardUrl').value,'_blank'); }
    async function downloadQR(format){
      try{
        const canvas=document.querySelector('#qrcode canvas'); if(!canvas){ showToast('QR code not generated yet','error'); return; }
        if(format==='png'){
          const a=document.createElement('a'); a.download=`myqer-${userCode||'emergency'}-card.png`; a.href=canvas.toDataURL(); a.click();
        }else{
          const liveUrl=`https://www.myqer.com/c/${userCode}`;
          const svg=await QRCode.toString(liveUrl,{type:'svg'}); const blob=new Blob([svg],{type:'image/svg+xml'});
          const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.download=`myqer-${userCode||'emergency'}-card.svg`; a.href=url; a.click(); URL.revokeObjectURL(url);
        }
        showToast((translations[currentLanguage]||translations.en).qr_downloaded,'success');
      }catch(e){ console.error(e); showToast('Failed to download QR code','error'); }
    }
    function printQR(){
      const canvas=document.querySelector('#qrcode canvas'); if(!canvas){ showToast('QR code not generated yet','error'); return; }
      const code=document.getElementById('qrCodeText').textContent; const url=document.getElementById('cardUrl').value;
      const w=window.open('','_blank'); w.document.write(`
        <!DOCTYPE html><html><head><title>MYQER Emergency Card - ${code}</title>
        <style>body{font-family:Inter,Arial,sans-serif;text-align:center;padding:40px;background:#fff}
          .card{border:3px solid #dc2626;border-radius:20px;padding:40px;max-width:500px;margin:0 auto;background:#fff}
          .logo{font-size:32px;font-weight:900;color:#dc2626;margin-bottom:20px;letter-spacing:2px}
          .code{font-family:Monaco,monospace;font-size:24px;font-weight:900;margin:20px 0;letter-spacing:3px}
          .url{font-size:14px;color:#666;word-break:break-all;margin-top:20px;font-family:Monaco,monospace}
          .qr{margin:30px 0}</style></head><body>
          <div class="card"><div class="logo">MYQER™ EMERGENCY CARD</div>
          <div class="qr"><img src="${canvas.toDataURL()}" alt="QR" style="width:250px;height:250px;border:2px solid #e2e8f0;border-radius:12px"></div>
          <div class="code">${code}</div><div class="url">${url}</div></div></body></html>`); w.document.close(); w.print();
    }

    /* ======= Language ======= */
    function toggleLanguageDropdown(){
      const dd = document.getElementById('languageDropdown'); dd.classList.toggle('show');
      document.addEventListener('click', function close(e){ if(!e.target.closest('.language-selector')){ dd.classList.remove('show'); document.removeEventListener('click', close);} });
    }
    function changeLanguage(lang){
      if(!translations[lang]) lang='en';               // fallback (fix)
      currentLanguage = lang; localStorage.setItem('myqer_language', lang);
      const flags={en:'🇺🇸 EN',es:'🇪🇸 ES',fr:'🇫🇷 FR',de:'🇩🇪 DE',it:'🇮🇹 IT',pt:'🇵🇹 PT',ro:'🇷🇴 RO',ar:'🇸🇦 AR',hi:'🇮🇳 HI',zh:'🇨🇳 ZH'};
      document.getElementById('currentLanguage').textContent = flags[lang] || flags.en;
      document.querySelectorAll('.language-option').forEach(o=>o.classList.remove('active'));
      const opt=document.querySelector(`[onclick="changeLanguage('${lang}')"]`); if(opt) opt.classList.add('active');
      document.getElementById('languageDropdown').classList.remove('show');
      applyTranslations(); renderICE();
    }
    function applyTranslations(){
      const t = translations[currentLanguage] || translations.en; // fallback (fix)
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n'); if(t[k] || translations.en[k]) el.textContent = t[k] || translations.en[k];
      });
    }

    /* ======= Online / Autosave / Validation ======= */
    function setupOnlineDetection(){
      function update(){ isOnline = navigator.onLine; const b=document.getElementById('offlineBanner'); const s=document.querySelector('[data-i18n="online_status"]');
        if(isOnline){ b.classList.remove('show'); if(s) s.textContent=(translations[currentLanguage]||translations.en).online_status; }
        else{ b.classList.add('show'); if(s) s.textContent='Offline'; }
      }
      window.addEventListener('online',update); window.addEventListener('offline',update); update();
    }
    function setupAutosave(){
      document.querySelectorAll('input,select,textarea').forEach(input=>{
        input.addEventListener('input',()=>{
          const id=input.id; const profile=['fullName','dob','country','healthId']; const health=['bloodType','allergies','conditions','medications','implants','organDonor','triageOverride'];
          const section = profile.includes(id)?'profile':(health.includes(id)?'health':null);
          if(section){ if(debounceTimers[section]) clearTimeout(debounceTimers[section]);
            debounceTimers[section]=setTimeout(()=>{ if(section==='profile') saveProfile(); else saveHealth(); },2000);
          }
          if(['allergies','conditions','medications','implants','bloodType','triageOverride'].includes(id)) updateTriage();
        });
      });
    }
    function setupEventListeners(){
      document.addEventListener('keydown',e=>{
        if(e.ctrlKey||e.metaKey){ if(e.key==='s'){ e.preventDefault(); saveProfile(); } if(e.key==='q'){ e.preventDefault(); generateQRCode(); } }
      });
      document.querySelectorAll('input[required]').forEach(i=>i.addEventListener('blur',e=>{
        const v=e.target.value.trim(); if(!v){ showFieldError(e.target,'This field is required'); } else hideFieldError(e.target);
      }));
    }
    function showFieldError(input,msg){ let el=input.parentNode.querySelector('.form-error'); if(!el){ el=document.createElement('div'); el.className='form-error'; input.parentNode.appendChild(el); } el.textContent=msg; el.style.color='var(--primary-red)'; el.style.fontWeight='700'; el.style.fontSize='12px'; }
    function hideFieldError(input){ const el=input.parentNode.querySelector('.form-error'); if(el) el.remove(); }

    /* ======= Idle Timer ======= */
    function setupIdleTimer(){
      const IDLE=30*60*1000, WARN=60*1000;
      function _reset(){
        clearTimeout(idleTimer); clearTimeout(warningTimer); clearInterval(countdownTimer);
        document.getElementById('idleModal').classList.remove('show');
        idleTimer=setTimeout(()=>{ showWarning(); }, IDLE-WARN);
      }
      function showWarning(){
        document.getElementById('idleModal').classList.add('show');
        countdownSeconds=60; document.getElementById('countdown').textContent=countdownSeconds;
        countdownTimer=setInterval(()=>{ countdownSeconds--; document.getElementById('countdown').textContent=countdownSeconds; if(countdownSeconds<=0) logout(); },1000);
        warningTimer=setTimeout(()=>logout(), WARN);
      }
      window.resetIdleTimer=_reset;
      ['mousedown','mousemove','keypress','scroll','touchstart','click'].forEach(ev=>document.addEventListener(ev,_reset,true));
      _reset();
    }

    /* ======= Account ======= */
    async function deleteAccount(){
      const confirmText=document.getElementById('deleteConfirm').value;
      if(confirmText!=='DELETE MY ACCOUNT'){ showToast((translations[currentLanguage]||translations.en).confirm_delete,'error'); return; }
      try{
        showSavingIndicator(); localStorage.clear(); showToast((translations[currentLanguage]||translations.en).account_deleted,'success');
        setTimeout(()=>{ window.location.href='index.html'; },1500);
      }catch(e){ console.error(e); showToast('Failed to delete account','error'); }
      finally{ hideSavingIndicator(); }
    }
    function logout(){ try{ localStorage.clear(); }catch{} window.location.href='index.html'; }

    /* ======= UI Toast / Saving ======= */
    function showToast(message,type='info'){
      const toast=document.getElementById('toast'); const msg=toast.querySelector('.toast-message'); const icon=toast.querySelector('.toast-icon');
      msg.textContent=message;
      const icons={success:'fas fa-check-circle',error:'fas fa-exclamation-circle',warning:'fas fa-exclamation-triangle',info:'fas fa-info-circle'};
      icon.className=`toast-icon ${icons[type]||icons.info}`; toast.className=`toast ${type} show`;
      setTimeout(hideToast,5000);
    }
    function hideToast(){ document.getElementById('toast').classList.remove('show'); }
    function showSavingIndicator(){ document.getElementById('savingIndicator').classList.add('show'); }
    function hideSavingIndicator(){ document.getElementById('savingIndicator').classList.remove('show'); }
  </script>
</body>
</html>
    
