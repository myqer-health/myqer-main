<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
 <!-- Content Security Policy (tuned for MYQER dashboard) -->
  <meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
  connect-src 'self' https://*.supabase.co https://*.supabase.io;
  img-src     'self' data: blob:;
  style-src   'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src    'self' https://fonts.gstatic.com data:;
  object-src  'none';
  base-uri    'self';
  form-action 'self';
  frame-ancestors 'self';
">

  <!-- Viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>MYQER™ Dashboard — Your Emergency Profile</title>

  <!-- Google Fonts (Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Supabase SDK (UMD build) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Your styles -->
  <style>
    /* custom CSS will go here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --red: #DC2626;
            --green: #059669;
            --orange: #EA580C;
            --ink: #0F172A;
            --slate: #475569;
            --light-slate: #94A3B8;
            --bg: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            --white: #FFFFFF;
            --glass: rgba(255, 255, 255, 0.95);
            --border: rgba(148, 163, 184, 0.15);
            --shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 20px 64px rgba(15, 23, 42, 0.12);
            --shadow-xl: 0 32px 80px rgba(15, 23, 42, 0.15);
            --gradient-red: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            --gradient-green: linear-gradient(135deg, #059669 0%, #047857 100%);
            --gradient-orange: linear-gradient(135deg, #EA580C 0%, #C2410C 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--ink);
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Loading State */
        #loadingState {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.125rem;
            color: var(--slate);
            font-weight: 500;
        }

        /* Error Box */
        #errorBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border: 2px solid #EF4444;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
            z-index: 9998;
            display: none;
        }

        #errorBox h3 {
            color: #EF4444;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        #errorMsg {
            color: var(--slate);
            margin-bottom: 1.5rem;
        }

        .error-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Toast Area */
        #toastArea {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9997;
            pointer-events: none;
        }

        .toast {
            background: var(--white);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--green);
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 320px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #EF4444;
            color: #991B1B;
        }

        .toast.success {
            border-left-color: var(--green);
            color: #166534;
        }

        /* Header */
        header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .logo-myq {
            color: var(--ink);
        }

        .logo-er {
            color: var(--red);
        }

        .logo-tm {
            color: var(--ink);
            font-size: 0.8em;
            vertical-align: super;
        }

        .logo-hint {
            font-size: 0.75rem;
            color: var(--light-slate);
            font-style: italic;
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #langSelector {
            position: relative;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1001;
            min-width: 120px;
            display: none;
        }

        .lang-dropdown button {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .lang-dropdown button:hover {
            background: var(--bg);
        }

        #netStatus {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #netStatus.online {
            background: #DCFCE7;
            color: var(--green);
        }

        #netStatus.offline {
            background: #FEF3C7;
            color: #D97706;
        }

        #btnSignOut {
            background: var(--red);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        #btnSignOut:hover {
            background: #B71C1C;
            transform: translateY(-1px);
        }

        /* Offline Banner */
        #offlineBanner {
            background: #FEF3C7;
            color: #92400E;
            padding: 0.75rem 2rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom: 1px solid #F59E0B;
            display: none;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            gap: 2rem;
        }

        /* Ultra-Premium Glass Cards with Left Ribbons */
        .card {
            background: var(--glass);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 3rem 3rem 3rem 4rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 1rem;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 6px;
            background: var(--gradient-green);
            border-radius: 0 4px 4px 0;
        }

        .card.ice::before {
            background: var(--gradient-orange);
        }

        .card.critical::before {
            background: var(--gradient-red);
        }

        .card.emergency::before {
            background: var(--gradient-red);
        }

        /* Left Ribbon */
        .ribbon {
            position: absolute;
            top: 2rem;
            left: -0.5rem;
            background: var(--gradient-green);
            color: var(--white);
            padding: 0.75rem 1.5rem 0.75rem 2rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 0 12px 12px 0;
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
            z-index: 10;
        }

        .ribbon::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -8px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid rgba(5, 150, 105, 0.8);
            border-top: 8px solid rgba(5, 150, 105, 0.8);
        }

        .ribbon.ice {
            background: var(--gradient-orange);
            box-shadow: 0 4px 16px rgba(234, 88, 12, 0.3);
        }

        .ribbon.ice::after {
            border-right-color: rgba(234, 88, 12, 0.8);
            border-top-color: rgba(234, 88, 12, 0.8);
        }

        .ribbon.critical {
            background: var(--gradient-red);
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .ribbon.critical::after {
            border-right-color: rgba(220, 38, 38, 0.8);
            border-top-color: rgba(220, 38, 38, 0.8);
        }

        .ribbon.emergency {
            background: var(--gradient-red);
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .ribbon.emergency::after {
            border-right-color: rgba(220, 38, 38, 0.8);
            border-top-color: rgba(220, 38, 38, 0.8);
        }

        /* Card Headers */
        .card-header {
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ink);
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            color: var(--slate);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            gap: 1.5rem;
        }

        .form-grid.two-col {
            grid-template-columns: 1fr 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--ink);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--white);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--red);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--light-slate);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--red);
        }

        /* Save Buttons */
        .save-button {
            background: var(--red);
            color: var(--white);
            border: none;
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        .save-button:hover:not(:disabled) {
            background: #B71C1C;
            transform: translateY(-1px);
        }

        .save-button:disabled {
            background: var(--light-slate);
            cursor: not-allowed;
        }

        /* Status Messages */
        .status-msg {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            display: none;
        }

        .status-msg.success {
            background: #DCFCE7;
            color: var(--green);
        }

        .status-msg.error {
            background: #FEE2E2;
            color: #DC2626;
        }

        /* Triage Section */
        .triage-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .triage-label {
            font-weight: 600;
            color: var(--ink);
        }

        #triagePill {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #triagePill.green {
            background: #DCFCE7;
            color: var(--green);
        }

        #triagePill.amber {
            background: #FEF3C7;
            color: #D97706;
        }

        #triagePill.red {
            background: #FEE2E2;
            color: #DC2626;
        }

        #triagePill.black {
            background: #F1F5F9;
            color: var(--slate);
        }

        #triageOverride {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--white);
        }

        /* Premium Emergency Card & QR Section */
        .emergency-card {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.03) 0%, rgba(220, 38, 38, 0.08) 100%);
            border: 1px solid rgba(220, 38, 38, 0.15);
        }

        .qr-section {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 3rem;
            margin-top: 2rem;
            align-items: start;
        }

        #qrSlot {
            position: relative;
            width: 240px;
            height: 240px;
            background: var(--white);
            border: 3px solid rgba(220, 38, 38, 0.1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(220, 38, 38, 0.1);
        }

        #qrSlot::before {
            content: '';
            position: absolute;
            inset: -8px;
            background: conic-gradient(from 0deg, transparent, rgba(220, 38, 38, 0.2), transparent);
            border-radius: 24px;
            z-index: -1;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #qrCanvas {
            border-radius: 12px;
        }

        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: rgba(220, 38, 38, 0.05);
            border: 2px dashed rgba(220, 38, 38, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate);
            font-size: 0.875rem;
            text-align: center;
            font-weight: 500;
        }

        #codeUnderQR {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            color: var(--slate);
            text-align: center;
            margin-top: 1rem;
            font-weight: 600;
            letter-spacing: 0.1em;
        }

        #qrStatus {
            background: rgba(220, 38, 38, 0.1);
            color: var(--red);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 1rem;
        }

        .qr-controls {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .qr-url-section {
            background: rgba(220, 38, 38, 0.03);
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .qr-url-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #cardUrl {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            background: var(--white);
            color: var(--slate);
            margin-bottom: 1rem;
        }

        .url-actions {
            display: flex;
            gap: 0.75rem;
        }

        .qr-downloads {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .qr-downloads h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .download-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--red);
            border: 2px solid var(--red);
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--red);
            color: var(--white);
        }

        /* Premium ICE Contacts */
        .ice-row {
            background: rgba(234, 88, 12, 0.03);
            border: 1px solid rgba(234, 88, 12, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .ice-row:hover {
            background: rgba(234, 88, 12, 0.05);
            border-color: rgba(234, 88, 12, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(234, 88, 12, 0.1);
        }

        .ice-contact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .contact-number {
            background: var(--gradient-orange);
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .ice-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .iceSaveBtn {
            background: var(--gradient-orange);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .iceSaveBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .iceDeleteBtn {
            background: none;
            border: none;
            color: #DC2626;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .iceDeleteBtn:hover {
            background: rgba(220, 38, 38, 0.1);
            color: #B91C1C;
        }

        .ice-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .ice-form-grid .form-group:nth-child(3) {
            grid-column: 1 / -1;
        }

        #addIce {
            background: rgba(234, 88, 12, 0.1);
            color: var(--orange);
            border: 2px dashed rgba(234, 88, 12, 0.3);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            width: 100%;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #addIce:hover:not(:disabled) {
            background: rgba(234, 88, 12, 0.15);
            border-color: rgba(234, 88, 12, 0.5);
            transform: translateY(-2px);
        }

        #addIce:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .header-controls {
                justify-content: space-between;
            }

            main {
                padding: 1rem;
                gap: 1.5rem;
            }

            .card {
                padding: 1.5rem 1.5rem 1.5rem 2rem;
                margin-left: 0.5rem;
            }

            .form-grid.two-col {
                grid-template-columns: 1fr;
            }

            .qr-section {
                grid-template-columns: 1fr;
                gap: 2rem;
                text-align: center;
            }

            .qr-placeholder {
                width: 150px;
                height: 150px;
            }

            #qrSlot {
                width: 200px;
                height: 200px;
                margin: 0 auto;
            }

            .download-grid {
                grid-template-columns: 1fr;
            }

            .ice-form-grid {
                grid-template-columns: 1fr;
            }

            .disclaimers {
                padding: 0 1rem;
            }

            .disclaimer-content {
                padding: 1.5rem;
            }

            .footer {
                padding: 1.5rem 1rem;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }

            .footer-links {
                justify-content: center;
            }
        }

        /* RTL Support */
        [dir="rtl"] .ribbon {
            right: auto;
            left: -30px;
            transform: rotate(-45deg);
        }

        [dir="rtl"] .lang-dropdown {
            right: auto;
            left: 0;
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--red);
            outline-offset: 2px;
        }

        /* Auto-save indicators */
        .field-saved {
            position: relative;
        }

        .field-saved::after {
            content: '✓';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--green);
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .field-saved.show-check::after {
            opacity: 1;
        }

        /* Delete Account Section */
        .delete-account {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.03) 0%, rgba(220, 38, 38, 0.08) 100%);
            border: 1px solid rgba(220, 38, 38, 0.15);
            margin-top: 3rem;
        }

        .delete-form {
            background: rgba(220, 38, 38, 0.05);
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 1.5rem;
        }

        .delete-button {
            background: #DC2626;
            color: var(--white);
            border: none;
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
            width: 100%;
        }

        .delete-button:hover:not(:disabled) {
            background: #B91C1C;
            transform: translateY(-1px);
        }

        .delete-button:disabled {
            background: var(--light-slate);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Disclaimers */
        .disclaimers {
            max-width: 1200px;
            margin: 3rem auto 2rem;
            padding: 0 2rem;
        }

        .disclaimer-content {
            background: rgba(148, 163, 184, 0.05);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
        }

        .disclaimer-content p {
            color: var(--slate);
            font-size: 0.875rem;
            line-height: 1.6;
            margin: 0;
        }

        .disclaimer-content p:first-child {
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            background: var(--white);
            border-top: 1px solid var(--border);
            padding: 2rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-links {
            display: flex;
            gap: 2rem;
        }

        .footer-links a {
            color: var(--slate);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: var(--red);
        }

        .footer-copyright {
            color: var(--light-slate);
            font-size: 0.75rem;
        }

        /* Hidden state */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingState">
        <div class="spinner"></div>
        <div class="loading-text" data-i18n="loading.dashboard">Loading your dashboard…</div>
    </div>

    <!-- Error Box -->
    <div id="errorBox">
        <h3 data-i18n="error.title">Something went wrong</h3>
        <div id="errorMsg"></div>
        <div class="error-actions">
            <button class="btn-secondary" onclick="location.reload()" data-i18n="error.retry">Try Again</button>
        </div>
    </div>

    <!-- Toast Area -->
    <div id="toastArea" aria-live="polite"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <h1><span class="logo-myq">MYQ</span><span class="logo-er">ER</span><span class="logo-tm">™</span></h1>
                <span class="logo-hint" data-i18n="logo.hint">pronounced "my care"</span>
            </div>
            <div class="header-controls">
                <div style="position: relative;">
                    <button id="langSelector" aria-haspopup="true" aria-expanded="false">EN</button>
                    <div class="lang-dropdown" id="langDropdown">
                        <button data-lang="en">English</button>
                        <button data-lang="es">Español</button>
                        <button data-lang="fr">Français</button>
                        <button data-lang="de">Deutsch</button>
                        <button data-lang="it">Italiano</button>
                        <button data-lang="pt">Português</button>
                        <button data-lang="ro">Română</button>
                        <button data-lang="ar">العربية</button>
                        <button data-lang="hi">हिन्दी</button>
                        <button data-lang="zh">中文</button>
                    </div>
                </div>
                <div id="netStatus" class="online" data-i18n="status.online">Online</div>
                <button id="btnSignOut" data-i18n="header.logout">Logout</button>
            </div>
        </div>
    </header>

    <!-- Offline Banner -->
    <div id="offlineBanner">
        <span data-i18n="offline.message">You're offline — QR still works with cached data.</span>
    </div>

    <!-- Main Content -->
    <main>
        <!-- Identity Section -->
        <section class="card identity">
            <div class="ribbon">Identity</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="identity.title">Identity — Personal Information</h2>
                <p class="card-subtitle" data-i18n="identity.hint">These details help responders confirm who you are.</p>
            </div>
            <form class="form-grid two-col">
                <div class="form-group">
                    <label for="profileFullName" data-i18n="identity.fullName">Full Name</label>
                    <input type="text" id="profileFullName" data-i18n-placeholder="identity.fullNamePlaceholder" placeholder="Enter your full legal name" required>
                </div>
                <div class="form-group">
                    <label for="profileDob" data-i18n="identity.dob">Date of Birth</label>
                    <input type="date" id="profileDob" required>
                    <span class="form-hint" data-i18n="identity.dobHint">Format: YYYY-MM-DD</span>
                </div>
                <div class="form-group">
                    <label for="profileCountry" data-i18n="identity.country">Country</label>
                    <select id="profileCountry" required>
                        <option value="" data-i18n="identity.selectCountry">Select your country</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="GB">United Kingdom</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="ES">Spain</option>
                        <option value="IT">Italy</option>
                        <option value="PT">Portugal</option>
                        <option value="RO">Romania</option>
                        <option value="IN">India</option>
                        <option value="CN">China</option>
                        <option value="AU">Australia</option>
                        <option value="BR">Brazil</option>
                        <option value="MX">Mexico</option>
                        <option value="JP">Japan</option>
                        <option value="KR">South Korea</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="profileHealthId" data-i18n="identity.healthId">National/Health ID (Optional)</label>
                    <input type="text" id="profileHealthId" data-i18n-placeholder="identity.healthIdPlaceholder" placeholder="e.g., NHS number, SSN, etc.">
                    <span class="form-hint" data-i18n="identity.healthIdHint">Only visible to medical professionals</span>
                </div>
            </form>
            <button class="save-button" id="saveProfile" data-i18n="common.saveProfile">Save Profile</button>
            <div class="status-msg" id="profileMsg"></div>
        </section>

        <!-- Critical Health Section -->
        <section class="card critical">
            <div class="ribbon critical">Critical</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="critical.title">CRITICAL — Medical & Health Details</h2>
                <p class="card-subtitle" data-i18n="critical.hint">Keep this current. It appears on your emergency card.</p>
            </div>
            <form class="form-grid">
                <div class="form-group">
                    <label for="hfBloodType" data-i18n="critical.bloodType">Blood Type</label>
                    <select id="hfBloodType">
                        <option value="" data-i18n="critical.selectBloodType">Select blood type</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="Unknown" data-i18n="critical.unknown">Unknown</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hfAllergies" data-i18n="critical.allergies">Critical Allergies</label>
                    <textarea id="hfAllergies" data-i18n-placeholder="critical.allergiesPlaceholder" placeholder="List any life-threatening allergies (medications, foods, etc.)"></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="hfDonor">
                    <label for="hfDonor" data-i18n="critical.organDonor">I am an organ donor</label>
                </div>
                <div class="form-group">
                    <label for="hfConditions" data-i18n="critical.conditions">Medical Conditions</label>
                    <textarea id="hfConditions" data-i18n-placeholder="critical.conditionsPlaceholder" placeholder="Diabetes, heart disease, epilepsy, etc."></textarea>
                </div>
                <div class="form-group">
                    <label for="hfMeds" data-i18n="critical.medications">Current Medications</label>
                    <textarea id="hfMeds" data-i18n-placeholder="critical.medicationsPlaceholder" placeholder="List all current medications and dosages"></textarea>
                </div>
                <div class="form-group">
                    <label for="hfImplants" data-i18n="critical.implants">Implants/Medical Devices</label>
                    <textarea id="hfImplants" data-i18n-placeholder="critical.implantsPlaceholder" placeholder="Pacemaker, insulin pump, metal implants, etc."></textarea>
                </div>
            </form>
            
            <!-- Triage Section -->
            <div class="triage-section">
                <span class="triage-label" data-i18n="triage.label">Triage:</span>
                <div id="triagePill" class="green">GREEN</div>
                <select id="triageOverride">
                    <option value="auto" data-i18n="triage.useAuto">Use auto</option>
                    <option value="green" data-i18n="triage.green">Green</option>
                    <option value="amber" data-i18n="triage.amber">Amber</option>
                    <option value="red" data-i18n="triage.red">Red</option>
                    <option value="black" data-i18n="triage.black">Black</option>
                </select>
            </div>

            <button class="save-button" id="saveHealth" data-i18n="common.saveHealth">Save Health</button>
            <div class="status-msg" id="healthMsg"></div>
        </section>

        <!-- ICE Contacts Section -->
        <section class="card ice">
            <div class="ribbon ice">ICE</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="iceTitle">Emergency Contacts (ICE)</h2>
                <p class="card-subtitle" data-i18n="iceHint">Add up to 3 trusted contacts.</p>
            </div>
            
            <div id="iceContactsList">
                <!-- ICE contacts will be dynamically added here -->
            </div>
            
            <button id="addIce" data-i18n="ice.addContact">+ Add Emergency Contact</button>
            <button class="save-button" id="saveIce" data-i18n="common.saveIce">Save ICE Contacts</button>
            <div class="status-msg" id="iceMsg"></div>
        </section>
        
        <!-- Emergency Card & QR Section -->
<section class="card emergency emergency-card">
  <div class="ribbon emergency">Emergency</div>

  <div class="card-header">
    <h2 class="card-title" id="qrTitle">Emergency Card & QR</h2>
    <p class="card-subtitle" id="qrExplain">QR never changes; it always opens your latest info.</p>
  </div>

  <!-- two-column wrapper -->
  <div class="qr-section">
    <!-- LEFT: QR slot -->
    <div>
      <div id="qrSlot">
        <canvas id="qrCanvas" width="200" height="200" aria-label="QR Code" style="display:none;"></canvas>
        <div class="qr-placeholder" id="qrPlaceholder">
          <span>QR Code will appear here<br>after saving your profile</span>
        </div>
      </div>
      <p id="codeUnderQR" class="text-mono text-muted"></p>
      <p id="qrStatus" role="alert" hidden></p>
    </div>

    <!-- RIGHT: controls -->
    <div class="qr-controls">
      <!-- Card URL -->
      <div class="qr-url-section">
        <h4>Card URL</h4>
        <input type="text" id="cardUrl" readonly placeholder="https://www.myqer.com/c/XXXX-XXX">
        <div class="url-actions">
          <button class="btn-secondary" id="copyLink">Copy Link</button>
          <button class="btn-secondary" id="openLink">Open Link</button>
        </div>
      </div>

      <!-- Offline text -->
      <div class="qr-offline">
        <h4>Offline QR Text</h4>
        <div class="offline-actions" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <button class="btn-secondary" id="copyOffline">Copy Offline Text</button>
          <button class="btn-secondary" id="dlOffline">Download Offline</button>
        </div>
        <textarea id="offlineText" rows="4" readonly
          placeholder="Offline emergency summary will appear here after generating QR"
          style="width:100%; resize:vertical;"></textarea>
      </div>

      <!-- Downloads -->
      <div class="qr-downloads">
        <h4>Downloads</h4>
        <div class="download-grid">
          <button class="btn-secondary" id="dlPNG">PNG</button>
          <button class="btn-secondary" id="dlSVG">SVG</button>
          <button class="btn-secondary" id="printQR">Print</button>
        </div>
      </div>
    </div> <!-- /qr-controls -->
  </div> <!-- /qr-section -->
</section>

        <!-- Delete Account Section -->
        <section class="card delete-account">
            <div class="ribbon critical">Danger</div>
            <div class="card-header">
                <h2 class="card-title" data-i18n="delete.title">Delete Account</h2>
                <p class="card-subtitle" data-i18n="delete.warning">This action cannot be undone. All your data will be permanently deleted.</p>
            </div>
            <div class="delete-form">
                <div class="form-group">
                    <label for="deletePhrase" data-i18n="delete.confirmLabel">Type "DELETE MY ACCOUNT" to confirm:</label>
                    <input type="text" id="deletePhrase" data-i18n-placeholder="delete.confirmPlaceholder" placeholder="DELETE MY ACCOUNT" autocomplete="off">
                    <span class="form-hint" data-i18n="delete.confirmHint">This phrase must match exactly</span>
                </div>
                <button class="delete-button" id="deleteBtn" disabled data-i18n="delete.button">Delete My Account</button>
                <div class="status-msg" id="deleteMsg"></div>
            </div>
        </section>
    </main>

    <!-- Disclaimers -->
    <div class="disclaimers">
        <div class="disclaimer-content">
            <p data-i18n="disclaimer.medical">Informational only. Clinicians must confirm with official medical documents.</p>
            <p data-i18n="disclaimer.privacy">Data stays on your device unless you choose to share.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="/privacy.html" data-i18n="footer.privacy">Privacy Policy</a>
                <a href="/terms.html" data-i18n="footer.terms">Terms of Service</a>
            </div>
            <div class="footer-copyright">
                <span data-i18n="footer.copyright">© 2024 MYQER™. All rights reserved.</span>
            </div>
        </div>
    </footer>
<script>
/* =========================
   MYQER — Clean Dashboard Script (patched)
   ========================= */

/* ---------- Globals ---------- */
const $  = (id) => document.getElementById(id);
const on = (el, ev, fn) => el && el.addEventListener(ev, fn);

let supabase, isSupabaseAvailable = false;
let isOnline = navigator.onLine;
let userData = { profile: {}, health: {} };
let iceContacts = [];
const autoSaveTimers = {};
const CODE_CHARS = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no O/0/I/1

/* ---------- Supabase ---------- */
(() => {
  try {
    const URL  = 'https://dmntmhkncldgynufajei.supabase.co';
    const KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';
    if (window.supabase && URL && KEY) {
      supabase = window.supabase.createClient(URL, KEY);
      isSupabaseAvailable = true;
      console.log('✅ Supabase ready');
    }
  } catch (e) {
    console.warn('⚠️ Supabase init failed:', e);
  }
})();
const getUserId = async () => {
  const { data, error } = await supabase.auth.getUser();
  if (error) throw error;
  return data?.user?.id || null;
};
const withTimeout = (p, ms, label='promise') =>
  Promise.race([ p, new Promise((_, rej) => setTimeout(() => rej(new Error(`${label} timed out`)), ms)) ]);

/* ---------- Toasts ---------- */
const toast = (msg, type='success', ms=3500) => {
  let area = $('toastArea');
  if (!area) {
    area = document.createElement('div');
    area.id = 'toastArea';
    area.setAttribute('aria-live','polite');
    document.body.appendChild(area);
  }
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  area.appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 250); }, ms);
};

/* ---------- Net status ---------- */
const updateNetworkStatus = () => {
  const badge = $('netStatus'), banner = $('offlineBanner');
  if (navigator.onLine) {
    badge && (badge.textContent = 'Online', badge.className='online');
    banner && (banner.style.display='none');
    if (!isOnline) toast('Back online - syncing changes', 'success');
    isOnline = true;
  } else {
    badge && (badge.textContent = 'Offline', badge.className='offline');
    banner && (banner.style.display='block');
    if (isOnline) toast('Working offline - changes saved locally', 'info');
    isOnline = false;
  }
};

/* ---------- Autosave helper ---------- */
const setupAutoSave = (id, fn, delay=600) => {
  const el = $(id);
  if (!el) return;
  on(el, 'input', () => {
    clearTimeout(autoSaveTimers[id]);
    autoSaveTimers[id] = setTimeout(async () => {
      try { await fn(); showFieldSaved(id); toast('Changes saved automatically','success',2000); }
      catch (e) { console.error('Autosave error', e); toast('Auto-save failed','error'); }
    }, delay);
  });
};
const showFieldSaved = (id) => {
  const el = $(id);
  if (!el) return;
  el.classList.add('field-saved','show-check');
  setTimeout(() => el.classList.remove('show-check'), 1500);
};

/* ---------- TRIAGE ---------- */
const TRIAGE = ['green','amber','red','black'];
const updateTriagePill = (level='green') => {
  const pill = $('triagePill'); if (!pill) return;
  TRIAGE.forEach(c => pill.classList.remove(c));
  pill.classList.add(level);
  pill.textContent = level.toUpperCase();
};
/* Auto triage:
   - If override != 'auto' -> use override
   - If allergies/conditions non-empty -> at least AMBER
   - If severe keywords in allergies -> RED
   - Else (no content) -> GREEN
*/
const calculateTriage = () => {
  const overSel = $('triageOverride');
  const override = overSel ? overSel.value : 'auto';
  if (override && override !== 'auto') return updateTriagePill(override);

  const a = ($('hfAllergies')?.value || '').toLowerCase().trim();
  const c = ($('hfConditions')?.value || '').toLowerCase().trim();
  const severe = a.includes('anaphylaxis') || a.includes('severe');

  if (severe) return updateTriagePill('red');
  if (a || c)  return updateTriagePill('amber');
  return updateTriagePill('green');
};

/* ---------- QR + Short Code ---------- */
const makeShort_3_4_3 = () => {
  const pick = n => Array.from({length:n},()=>CODE_CHARS[Math.floor(Math.random()*CODE_CHARS.length)]).join('');
  return `${pick(3)}-${pick(4)}-${pick(3)}`;
};
const generateShortCode = () => {
  const valid = /^[A-HJ-NP-Z2-9]{3}-[A-HJ-NP-Z2-9]{4}-[A-HJ-NP-Z2-9]{3}$/;
  let code = localStorage.getItem('myqer_shortcode');
  if (!valid.test(code || '')) { code = makeShort_3_4_3(); localStorage.setItem('myqer_shortcode', code); }
  return code;
};
const ensureShortCode = async () => {
  let code = localStorage.getItem('myqer_shortcode') || generateShortCode();
  if (!(isSupabaseAvailable && isOnline)) return code;

  try {
    const uid = await getUserId();
    if (!uid) return code;

    for (let i=0;i<5;i++){
      const { error } = await supabase.from('profiles').upsert({ user_id: uid, code }, { onConflict: 'user_id' });
      if (!error) break;
      const msg = `${error.message||''} ${error.details||''}`.toLowerCase();
      if (msg.includes('duplicate')) { code = makeShort_3_4_3(); localStorage.setItem('myqer_shortcode', code); continue; }
      console.warn('ensureShortCode upsert err:', error); break;
    }
  } catch(e){ console.warn('ensureShortCode failed', e); }
  return code;
};
/* Ensure QR lib is present before drawing (works even if CDN script didn't load yet) */
const ensureQRCodeLib = async () => {
  if (window.QRCode && typeof window.QRCode.toCanvas === 'function') return;
  await new Promise((res, rej) => {
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
    s.onload=res; s.onerror=()=>rej(new Error('QRCode lib failed to load'));
    document.head.appendChild(s);
  });
};
const buildOfflineText = (shortUrl) => {
  const pf = userData?.profile || {}, hd = userData?.health || {};
  const donor = hd.organDonor ? 'Y' : 'N';
  const L = [];
  const L1 = [pf.fullName && `Name: ${pf.fullName}`, pf.dob && `DOB: ${pf.dob}`, pf.country && `C: ${pf.country}`].filter(Boolean).join(' | ');
  if (L1) L.push(L1);
  const L2 = [hd.bloodType && `BT: ${hd.bloodType}`, hd.allergies && `ALG: ${hd.allergies}`].filter(Boolean).join(' | ');
  if (L2) L.push(L2);
  const L3 = [hd.conditions && `COND: ${hd.conditions}`, hd.medications && `MED: ${hd.medications}`, hd.implants && `IMP: ${hd.implants}`, `DONOR:${donor}`].filter(Boolean).join(' | ');
  if (L3) L.push(L3);
  L.push(`URL:${shortUrl}`);
  let text = L.join('\n');
  if (text.length > 1200) text = text.slice(0,1200);
  return text;
};
const generateQRCode = async () => {
  const qrCanvas = $('qrCanvas'), qrPlaceholder = $('qrPlaceholder'), codeEl = $('codeUnderQR'), urlEl = $('cardUrl'), status = $('qrStatus');

  const hasProfile = !!userData?.profile?.fullName;
  const hasHealth  = !!(userData?.health?.bloodType || userData?.health?.allergies);
  const hasICE     = Array.isArray(iceContacts) && iceContacts.length > 0;

  if (!(hasProfile || hasHealth || hasICE)) {
    qrPlaceholder && (qrPlaceholder.style.display='flex');
    qrCanvas && (qrCanvas.style.display='none');
    codeEl && (codeEl.textContent='');
    urlEl && (urlEl.value='');
    status && (status.hidden=true);
    return;
  }

  const code = await ensureShortCode();
  const shortUrl = `https://www.myqer.com/c/${code}`;

  codeEl && (codeEl.textContent = code);
  urlEl  && (urlEl.value = shortUrl);

  try {
    await ensureQRCodeLib(); // ← ensure lib is ready
    if (!qrCanvas) throw new Error('QR canvas missing');
    const ctx = qrCanvas.getContext('2d'); ctx.clearRect(0,0,qrCanvas.width,qrCanvas.height);
    await new Promise((res,rej)=> QRCode.toCanvas(qrCanvas, shortUrl, { width: 200, errorCorrectionLevel:'H', margin:1 }, e=> e?rej(e):res()));
    qrCanvas.style.display = 'block';
    qrPlaceholder && (qrPlaceholder.style.display='none');

    status && (status.textContent='QR Code generated successfully', status.style.background='rgba(5,150,105,.1)', status.style.color='var(--green)', status.hidden=false);

    const off = $('offlineText'); off && (off.value = buildOfflineText(shortUrl));
    console.log('🔗 QR ready:', shortUrl);
  } catch(e){
    console.error('QR render failed:', e);
    status && (status.textContent='QR generation failed', status.style.background='rgba(239,68,68,.1)', status.style.color='var(--red)', status.hidden=false);
  }
};

/* ---------- ICE Contacts ---------- */
const renderIceContacts = () => {
  const box = $('iceContactsList'); if (!box) return;
  box.innerHTML = '';
  (iceContacts || []).forEach((contact, idx) => {
    const row = document.createElement('div');
    row.className = 'ice-row'; row.dataset.index = idx;
    row.innerHTML = `
      <div class="ice-contact-header">
        <div class="contact-number">${idx+1}</div>
        <div class="ice-actions">
          <button class="iceSaveBtn" data-act="save" data-idx="${idx}">Save</button>
          <button class="iceDeleteBtn" data-act="del" data-idx="${idx}" aria-label="Delete contact">✖</button>
        </div>
      </div>
      <div class="ice-form-grid">
        <div class="form-group">
          <label>Name</label>
          <input type="text" class="iceName" data-field="name" data-idx="${idx}" value="${contact.name||''}" placeholder="Name">
        </div>
        <div class="form-group">
          <label>Relationship</label>
          <input type="text" class="iceRelation" data-field="relationship" data-idx="${idx}" value="${contact.relationship||''}" placeholder="Spouse, Parent">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" class="icePhone" data-field="phone" data-idx="${idx}" value="${contact.phone||''}" placeholder="+1 555 123 4567">
        </div>
      </div>`;
    box.appendChild(row);
  });

  const addBtn = $('addIce');
  if (addBtn) {
    if ((iceContacts||[]).length >= 3) { addBtn.disabled = true; addBtn.textContent = 'Maximum 3 contacts reached'; }
    else { addBtn.disabled = false; addBtn.textContent = 'Add Emergency Contact'; }
  }
};
const persistIceLocally = () => { localStorage.setItem('myqer_ice', JSON.stringify(iceContacts || [])); };
const addIceContact = () => {
  iceContacts = Array.isArray(iceContacts) ? iceContacts : [];
  if (iceContacts.length >= 3) return toast('Maximum 3 emergency contacts allowed','error');
  iceContacts.push({ name:'', relationship:'', phone:'' });
  persistIceLocally(); renderIceContacts();
};
const updateIceContact = (idx, field, value) => {
  if (!iceContacts[idx]) return;
  iceContacts[idx][field] = value;
  persistIceLocally();
};
const saveICEToServer = async () => {
  if (!(isSupabaseAvailable && isOnline)) return;
  const uid = await getUserId(); if (!uid) return;

  // Replace all rows for this user
  const { error: delErr } = await supabase.from('ice_contacts').delete().eq('user_id', uid);
  if (delErr) throw delErr;

  const rows = (iceContacts || []).filter(c => c.name || c.phone).map((c,i)=>({
    user_id: uid, contact_order: i, name: c.name || '', relationship: c.relationship || '', phone: c.phone || ''
  }));
  if (!rows.length) return;

  const { error } = await supabase.from('ice_contacts').insert(rows);
  if (error) throw error;
};
const saveICE = async () => {
  // Validate
  const entries = (iceContacts||[]).map(c => ({ name:(c.name||'').trim(), relationship:(c.relationship||'').trim(), phone:(c.phone||'').trim() }))
                                  .filter(c => c.name || c.phone);
  if (entries.length > 3) return toast('Maximum 3 emergency contacts allowed','error');
  const invalid = entries.find(c => !(c.name && c.phone));
  if (invalid) return toast('Each contact needs a name and phone','error');

  iceContacts = entries;
  persistIceLocally();
  try { await saveICEToServer(); toast('Emergency contacts saved','success'); }
  catch (e) { console.error(e); toast('Error saving emergency contacts','error'); }
  renderIceContacts(); generateQRCode();
};

/* ---------- Profile & Health ---------- */
const saveProfile = async () => {
  const profile = {
    fullName: $('profileFullName')?.value?.trim() || '',
    dob:      $('profileDob')?.value?.trim() || '',
    country:  $('profileCountry')?.value?.trim() || '',
    healthId: $('profileHealthId')?.value?.trim() || ''
  };
  if (!profile.fullName) return toast('Full name is required','error');
  if (profile.dob && !/^\d{4}-\d{2}-\d{2}$/.test(profile.dob)) return toast('Use YYYY-MM-DD for Date of Birth','error');

  userData.profile = profile;
  localStorage.setItem('myqer_profile', JSON.stringify(profile));

  try {
    if (isSupabaseAvailable && isOnline) {
      const uid = await getUserId(); if (!uid) throw new Error('No authenticated user');
      const code = await ensureShortCode();
      const row  = { user_id: uid, code, ...profile };
      const { error } = await supabase.from('profiles').upsert(row, { onConflict: 'user_id' });
      if (error) throw error;
    }
    toast('Profile saved successfully','success');
    $('profileMsg') && ($('profileMsg').textContent = '✓ Profile saved successfully', $('profileMsg').className='status-msg success', $('profileMsg').style.display='block'));
    generateQRCode();
  } catch (e) {
    console.error(e); toast('Error saving profile: ' + e.message,'error');
  }
};
const saveHealth = async () => {
  const health = {
    bloodType:      $('hfBloodType')?.value || '',
    allergies:      $('hfAllergies')?.value || '',
    conditions:     $('hfConditions')?.value || '',
    medications:    $('hfMeds')?.value || '',
    implants:       $('hfImplants')?.value || '',
    organDonor:     !!$('hfDonor')?.checked,
    triageOverride: $('triageOverride')?.value || 'auto'
  };
  userData.health = health;
  localStorage.setItem('myqer_health', JSON.stringify(health));

  try {
    if (isSupabaseAvailable && isOnline) {
      const uid = await getUserId(); if (!uid) throw new Error('No authenticated user');
      const row = { user_id: uid, ...health };
      const { error } = await supabase.from('health_data').upsert(row, { onConflict: 'user_id' });
      if (error) throw error;
    }
    calculateTriage();
    toast('Health information saved','success');
    $('healthMsg') && ($('healthMsg').textContent='✓ Health information saved', $('healthMsg').className='status-msg success', $('healthMsg').style.display='block'));
    generateQRCode();
  } catch (e) {
    console.error(e); toast('Error saving health data: ' + e.message,'error');
  }
};

/* ---------- Load (local-first, server-sync) ---------- */
const fillFromLocal = () => {
  try {
    // profile
    const lp = localStorage.getItem('myqer_profile');
    if (lp) {
      userData.profile = JSON.parse(lp) || {};
      const p = userData.profile, set = (id,v)=>{ const el=$(id); if (el) el.value=v||''; };
      set('profileFullName', p.fullName); set('profileDob', p.dob); set('profileCountry', p.country); set('profileHealthId', p.healthId);
    }
    // health
    const lh = localStorage.getItem('myqer_health');
    if (lh) {
      userData.health = JSON.parse(lh) || {};
      const h = userData.health, set=(id,v)=>{ const el=$(id); if (el) el.value=v||''; };
      set('hfBloodType', h.bloodType); set('hfAllergies', h.allergies); set('hfConditions', h.conditions);
      set('hfMeds', h.medications); set('hfImplants', h.implants);
      $('hfDonor') && ($('hfDonor').checked = !!h.organDonor);
      $('triageOverride') && ($('triageOverride').value = h.triageOverride || 'auto');
      calculateTriage();
    }
    // ice
    const li = localStorage.getItem('myqer_ice');
    iceContacts = li ? (JSON.parse(li) || []) : [];
    renderIceContacts();
    generateQRCode();
  } catch(e){ console.warn('Local fill failed', e); }
};
const loadUserData = async () => {
  // local immediately
  fillFromLocal();

  // server optional
  if (!(isSupabaseAvailable && isOnline)) return hideSpinner();

  try {
    const { data: { session } } = await withTimeout(supabase.auth.getSession(), 3000, 'getSession');
    if (!session) { showSignInNote(); return; }
    const uid = await withTimeout(getUserId(), 3000, 'getUserId'); if (!uid) { showSignInNote(); return; }

    // profiles
    const { data: prof } = await withTimeout(
      supabase.from('profiles').select('*').eq('user_id', uid).maybeSingle(),
      4000, 'profiles.select'
    ).catch(() => ({ data:null }));
    if (prof) {
      userData.profile = { ...userData.profile, ...prof };
      localStorage.setItem('myqer_profile', JSON.stringify(userData.profile));
      const p = userData.profile, set = (id,v)=>{ const el=$(id); if (el) el.value=v||''; };
      set('profileFullName', p.fullName); set('profileDob', p.dob); set('profileCountry', p.country); set('profileHealthId', p.healthId);
    }

    // health
    const { data: health } = await withTimeout(
      supabase.from('health_data').select('*').eq('user_id', uid).maybeSingle(),
      4000, 'health_data.select'
    ).catch(()=>({ data:null }));
    if (health) {
      userData.health = { ...userData.health, ...health };
      localStorage.setItem('myqer_health', JSON.stringify(userData.health));
      const h = userData.health, set=(id,v)=>{ const el=$(id); if (el) el.value=v||''; };
      set('hfBloodType', h.bloodType); set('hfAllergies', h.allergies); set('hfConditions', h.conditions);
      set('hfMeds', h.medications); set('hfImplants', h.implants);
      $('hfDonor') && ($('hfDonor').checked = !!h.organDonor);
      $('triageOverride') && ($('triageOverride').value = h.triageOverride || 'auto');
      calculateTriage();
    }

    // ice
    const { data: ice } = await withTimeout(
      supabase.from('ice_contacts').select('*').eq('user_id', uid).order('contact_order', { ascending: true }),
      4000, 'ice_contacts.select'
    ).catch(()=>({ data:[] }));
    if (Array.isArray(ice)) {
      iceContacts = ice.map(r => ({ name:r.name||'', relationship:r.relationship||'', phone:r.phone||'' }));
      localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
      renderIceContacts();
    }

    await ensureShortCode();
    await generateQRCode();
  } catch (e) {
    console.warn('Load (server) non-fatal:', e);
  } finally {
    hideSpinner();
  }
};
const showSignInNote = () => {
  const box=$('errorBox'), msg=$('errorMsg');
  msg && (msg.textContent='Please sign in first, then return to the dashboard.');
  box && (box.style.display='block');
  hideSpinner();
};

/* ---------- Delete account ---------- */
const deleteAccount = async () => {
  const phrase = ($('deletePhrase')?.value || '').trim().toUpperCase();
  if (phrase !== 'DELETE MY ACCOUNT') return toast('Type the confirmation phrase exactly','error');
  if (!confirm('Are you absolutely sure? This permanently deletes your data.')) return;

  try {
    if (isSupabaseAvailable && isOnline) {
      const uid = await getUserId(); if (!uid) throw new Error('No authenticated user');
      await supabase.from('ice_contacts').delete().eq('user_id', uid);
      await supabase.from('health_data').delete().eq('user_id', uid);
      await supabase.from('profiles').delete().eq('user_id', uid);
    }
    localStorage.clear(); sessionStorage.clear();
    toast('Account deleted. Redirecting…','success');
    setTimeout(()=> location.href='index.html', 1200);
  } catch(e) {
    console.error(e); toast('Error deleting account: ' + e.message, 'error');
  }
};

/* ---------- QR / Buttons ---------- */
const wireQRButtons = () => {
  on($('copyLink'), 'click', async () => {
    const url = $('cardUrl')?.value?.trim();
    if (!url) return toast('No link to copy','error');
    try { await navigator.clipboard.writeText(url); toast('Link copied to clipboard','success'); }
    catch { toast('Copy failed','error'); }
  });
  on($('openLink'), 'click', () => {
    const url = $('cardUrl')?.value?.trim();
    if (!url) return toast('No link to open','error');
    window.open(url, '_blank', 'noopener');
  });
  on($('dlPNG'), 'click', () => {
    const canvas = $('qrCanvas'); if (!canvas || canvas.style.display==='none') return toast('Generate QR first','error');
    const a = document.createElement('a'); a.download='myqer-emergency-qr.png'; a.href = canvas.toDataURL('image/png'); a.click();
    toast('PNG downloaded','success');
  });
  on($('dlSVG'), 'click', async () => {
    const url = $('cardUrl')?.value?.trim(); if (!url) return toast('Generate QR first','error');
    try {
      await ensureQRCodeLib();
      const svg = await new Promise((res,rej)=> QRCode.toString(url, {type:'svg', errorCorrectionLevel:'H', margin:1}, (e,s)=> e?rej(e):res(s)));
      const blob = new Blob([svg], {type:'image/svg+xml'}), a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'myqer-emergency-qr.svg'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      toast('SVG downloaded','success');
    } catch(e){ console.error(e); toast('SVG download failed','error'); }
  });
  on($('printQR'), 'click', () => {
    const canvas = $('qrCanvas'); const code = $('codeUnderQR')?.textContent?.trim();
    if (!canvas || canvas.style.display==='none' || !code) return toast('Generate QR first','error');
    const dataUrl = canvas.toDataURL('image/png'); const w = window.open('', '_blank', 'noopener'); if (!w) return toast('Pop-up blocked','error');
    w.document.write(`
      <html><head><title>MYQER Emergency Card - ${code}</title>
      <meta charset="utf-8"><style>
        body{font-family:Arial,sans-serif;text-align:center;padding:2rem}
        .code{font-weight:700;letter-spacing:.06em}
        img{width:300px;height:300px;image-rendering:pixelated}
        @media print{@page{size:auto;margin:12mm}}
      </style></head>
      <body>
        <h1>MYQER™ Emergency Card</h1>
        <p class="code">Code: ${code}</p>
        <img alt="QR Code" src="${dataUrl}">
        <p>Scan this QR code for emergency information</p>
        <p style="font-size:.8em;color:#666">www.myqer.com</p>
        <script>window.onload=()=>setTimeout(()=>window.print(),200);<\/script>
      </body></html>`);
    w.document.close();
  });
  on($('copyOffline'), 'click', async () => {
    const txt = $('offlineText')?.value || '';
    if (!txt.trim()) return toast('No offline text to copy','error');
    try { await navigator.clipboard.writeText(txt); toast('Offline text copied','success'); }
    catch { toast('Copy failed','error'); }
  });
  on($('dlOffline'), 'click', () => {
    const txt = $('offlineText')?.value || '';
    if (!txt.trim()) return toast('No offline text to download','error');
    const blob = new Blob([txt], {type:'text/plain'}), a=document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download='myqer-offline.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    toast('Offline text downloaded','success');
  });
};

/* ---------- Spinner + Errors ---------- */
const hideSpinner = () => { const el=$('loadingState'); el && (el.style.display='none'); };
const showError = (msg) => { const box=$('errorBox'), m=$('errorMsg'); m && (m.textContent=msg); box && (box.style.display='block'); };

/* ---------- DOM Ready ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  // Net status
  updateNetworkStatus();
  window.addEventListener('online',  updateNetworkStatus);
  window.addEventListener('offline', updateNetworkStatus);

  // Bind buttons
  on($('saveProfile'), 'click', saveProfile);
  on($('saveHealth'),  'click', saveHealth);
  on($('saveIce'),     'click', saveICE);
  on($('addIce'),      'click', addIceContact);

  // Live triage while typing (no extra autosave bindings here)
  ['hfAllergies','hfConditions'].forEach(id => on($(id), 'input', calculateTriage));

  // ICE delegated events (inputs + buttons)
  on($('iceContactsList'), 'input', (e) => {
    const t = e.target, idx = +t.dataset.idx, field = t.dataset.field;
    if (Number.isInteger(idx) && field) updateIceContact(idx, field, t.value);
  });
  on($('iceContactsList'), 'click', async (e) => {
    const btn = e.target.closest('[data-act]'); if (!btn) return;
    const idx = +btn.dataset.idx;
    if (btn.dataset.act === 'del') {
      iceContacts.splice(idx,1); persistIceLocally(); renderIceContacts(); try { await saveICEToServer(); } catch {}
      generateQRCode(); toast('Contact removed','success');
    } else if (btn.dataset.act === 'save') {
      await saveICE();
    }
  });

  // Triage override
  on($('triageOverride'), 'change', () => { calculateTriage(); saveHealth(); });

  // Autosaves
  ['profileFullName','profileDob','profileCountry','profileHealthId']
    .forEach(id => setupAutoSave(id, saveProfile));
  ['hfBloodType','hfAllergies','hfConditions','hfMeds','hfImplants','hfDonor']
    .forEach(id => setupAutoSave(id, saveHealth));

  // Delete account flow
  on($('deletePhrase'), 'input', () => {
    const ok = ($('deletePhrase').value || '').trim().toUpperCase() === 'DELETE MY ACCOUNT';
    const btn = $('deleteBtn'); if (!btn) return;
    btn.disabled = !ok; btn.style.background = ok ? '#DC2626' : 'var(--light-slate)'; btn.style.cursor = ok ? 'pointer' : 'not-allowed';
  });
  on($('deleteBtn'), 'click', deleteAccount);

  // Sign out (always go to index.html)
  on($('btnSignOut'), 'click', async () => {
    try { const { error } = await supabase.auth.signOut(); if (error) throw error; }
    catch(e){ console.warn('Sign out fallback', e); }
    localStorage.clear(); sessionStorage.clear();
    location.href='index.html';
  });

  // QR buttons
  wireQRButtons();

  // Load data
  await loadUserData();

  // Smooth loading transition
  setTimeout(() => {
    const loading = $('loadingState');
    if (loading) { loading.style.opacity='0'; loading.style.transition='opacity .4s'; setTimeout(()=>loading.style.display='none', 400); }
  }, 600);
});

/* ---------- Global traps (never-stuck loader) ---------- */
window.addEventListener('error', (e) => { hideSpinner(); showError('JavaScript error: ' + (e.message || 'Unknown error')); console.error('Uncaught error:', e.error || e.message); });
window.addEventListener('unhandledrejection', (e) => { hideSpinner(); showError('Promise error: ' + (e.reason?.message || String(e.reason))); console.error('Unhandled rejection:', e.reason); });
setTimeout(hideSpinner, 4000);
</script>
<!-- Cloudflare bot-protection snippet (leave as-is) -->
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97984376b004496e',t:'MTc1NjkzNDEzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
