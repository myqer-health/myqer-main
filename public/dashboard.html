<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER Dashboard v9.0 - Complete Brain Preserved</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            --myqer-red: #C62828;
            --myqer-red-dark: #b71c1c;
            --myqer-red-light: rgba(198, 40, 40, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 16px 48px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 24px 64px rgba(0, 0, 0, 0.12);
            --gradient-bg: linear-gradient(135deg, #f8f9fc 0%, #ffffff 50%, #f1f5f9 100%);
            --card-radius: 20px;
            --input-radius: 12px;
            --button-radius: 12px;
        }
        
        body {
            background: var(--gradient-bg);
            background-attachment: fixed;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Enhanced Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(198, 40, 40, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(17, 17, 17, 0.02) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(59, 130, 246, 0.015) 0%, transparent 50%);
            pointer-events: none;
            z-index: -2;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.01) 50%, transparent 51%),
                linear-gradient(-45deg, transparent 49%, rgba(255,255,255,0.01) 50%, transparent 51%);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
        }
        
        /* Perfect Square Grid System */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 24px;
            aspect-ratio: 1;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                aspect-ratio: auto;
                gap: 20px;
                padding: 0 16px;
            }
        }
        
        /* Premium Card System with Perfect Squares */
        .premium-card {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            box-shadow: 
                var(--shadow-medium),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(255, 255, 255, 0.2);
            border-radius: var(--card-radius);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            aspect-ratio: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .premium-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 
                var(--shadow-heavy),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                0 0 0 1px rgba(198, 40, 40, 0.1);
        }
        
        .premium-card:active {
            transform: translateY(-2px) scale(1.01);
        }
        
        @media (max-width: 768px) {
            .premium-card {
                aspect-ratio: auto;
                min-height: 450px;
            }
        }
        
        /* Card Ribbon System */
        .card-ribbon {
            position: absolute;
            top: 0;
            left: 0;
            padding: 10px 20px;
            font-weight: 800;
            font-size: 0.75rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: white;
            border-radius: 0 0 16px 0;
            z-index: 20;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .ribbon-identity { 
            background: linear-gradient(135deg, #10b981, #059669, #047857); 
        }
        .ribbon-health { 
            background: linear-gradient(135deg, #f59e0b, #d97706, #b45309); 
        }
        .ribbon-qr { 
            background: linear-gradient(135deg, #C62828, #b71c1c, #a71e1e); 
        }
        .ribbon-danger { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9); 
        }
        
        /* Card Icons */
        .card-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.75rem;
            opacity: 0.7;
            z-index: 15;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        /* Card Content Layout */
        .card-content {
            padding: 24px;
            padding-top: 56px;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .card-header {
            margin-bottom: 16px;
            flex-shrink: 0;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 800;
            color: #111827;
            margin-bottom: 6px;
            line-height: 1.2;
        }
        
        .card-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            font-weight: 500;
        }
        
        .card-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            margin-bottom: 12px;
        }
        
        .card-body::-webkit-scrollbar {
            width: 4px;
        }
        
        .card-body::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 2px;
        }
        
        .card-body::-webkit-scrollbar-thumb {
            background: rgba(198, 40, 40, 0.3);
            border-radius: 2px;
        }
        
        .card-body::-webkit-scrollbar-thumb:hover {
            background: rgba(198, 40, 40, 0.5);
        }
        
        .card-footer {
            flex-shrink: 0;
            margin-top: auto;
        }
        
        /* Premium Input System */
        .premium-input {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(229, 231, 235, 0.5);
            border-radius: var(--input-radius);
            padding: 12px 16px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            color: #374151;
        }
        
        .premium-input:focus {
            background: rgba(255, 255, 255, 1);
            border-color: var(--myqer-red);
            box-shadow: 
                0 0 0 4px var(--myqer-red-light),
                0 4px 12px rgba(198, 40, 40, 0.15);
            outline: none;
            transform: translateY(-1px);
        }
        
        .premium-input:hover:not(:focus) {
            border-color: rgba(198, 40, 40, 0.3);
            background: rgba(255, 255, 255, 1);
        }
        
        .premium-input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }
        
        /* Compact inputs for square cards */
        .compact-input {
            padding: 10px 14px;
            font-size: 0.85rem;
        }
        
        /* Premium Button System */
        .premium-btn {
            background: linear-gradient(135deg, var(--myqer-red), var(--myqer-red-dark));
            color: white;
            border: none;
            border-radius: var(--button-radius);
            padding: 14px 24px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .premium-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .premium-btn:hover::before {
            left: 100%;
        }
        
        .premium-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(198, 40, 40, 0.4);
        }
        
        .premium-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
        }
        
        .compact-btn {
            padding: 10px 16px;
            font-size: 0.85rem;
        }
        
        /* Danger Button Variant */
        .danger-btn {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .danger-btn:hover {
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }
        
        /* Secondary Button Variant */
        .secondary-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        .secondary-btn:hover {
            box-shadow: 0 8px 20px rgba(107, 114, 128, 0.4);
        }
        
        /* Form Field System */
        .field-group {
            margin-bottom: 14px;
        }
        
        .field-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 480px) {
            .field-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        /* Save Indicator System */
        .save-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .save-indicator.show {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .save-indicator::before {
            content: '✓';
            margin-right: 6px;
            font-weight: 900;
        }
        
        /* Auto-save Notice */
        .auto-save-notice {
            font-size: 0.7rem;
            color: #9ca3af;
            text-align: center;
            font-style: italic;
            padding: 8px;
            background: rgba(249, 250, 251, 0.8);
            border-radius: 6px;
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        
        /* QR Code System */
        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        
        .qr-placeholder {
            width: 180px;
            height: 180px;
            background: rgba(248, 250, 252, 0.9);
            border: 3px dashed rgba(198, 40, 40, 0.3);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .qr-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(198, 40, 40, 0.1), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .qr-placeholder:hover {
            border-color: rgba(198, 40, 40, 0.5);
            background: rgba(248, 250, 252, 1);
        }
        
        .qr-display {
            width: 180px;
            height: 180px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 
                0 12px 24px rgba(0, 0, 0, 0.15),
                0 4px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(198, 40, 40, 0.2);
        }
        
        .emergency-link {
            background: rgba(248, 250, 252, 0.95);
            border: 1px solid rgba(229, 231, 235, 0.6);
            border-radius: 10px;
            padding: 12px 16px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Courier New', monospace;
            font-size: 0.8rem;
            color: #374151;
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
            word-break: break-all;
        }
        
        /* QR Actions */
        .qr-actions {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        
        .qr-actions button {
            flex: 1;
        }
        
        /* Triage System */
        .triage-container {
            text-align: center;
            margin: 16px 0;
        }
        
        .triage-pill {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .triage-pill:hover {
            transform: scale(1.05);
        }
        
        .triage-green { 
            background: rgba(16, 185, 129, 0.15); 
            color: #059669; 
            border-color: rgba(16, 185, 129, 0.3);
        }
        .triage-amber { 
            background: rgba(245, 158, 11, 0.15); 
            color: #d97706; 
            border-color: rgba(245, 158, 11, 0.3);
        }
        .triage-red { 
            background: rgba(220, 38, 38, 0.15); 
            color: #dc2626; 
            border-color: rgba(220, 38, 38, 0.3);
        }
        .triage-black { 
            background: rgba(107, 114, 128, 0.15); 
            color: #374151; 
            border-color: rgba(107, 114, 128, 0.3);
        }
        
        .triage-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Warning Box System */
        .warning-box {
            background: rgba(239, 68, 68, 0.08);
            border: 2px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .warning-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #dc2626;
        }
        
        .warning-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .warning-icon {
            color: #dc2626;
            font-size: 1.25rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .warning-text {
            flex: 1;
        }
        
        .warning-title {
            font-weight: 700;
            color: #b91c1c;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        
        .warning-description {
            font-size: 0.8rem;
            color: #7f1d1d;
            line-height: 1.4;
        }
        
        /* Floating Header System */
        .floating-header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.4);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 24px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo-text {
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: -0.5px;
        }
        
        .logo-myq {
            color: #000;
        }
        
        .logo-er {
            color: var(--myqer-red);
        }
        
        .logo-subtitle {
            font-size: 0.8rem;
            color: #6b7280;
            font-style: italic;
            font-weight: 500;
        }
        
        /* Language Selector */
        .language-selector {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(229, 231, 235, 0.6);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .language-selector:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(198, 40, 40, 0.3);
        }
        
        .language-selector:focus {
            outline: none;
            border-color: var(--myqer-red);
            box-shadow: 0 0 0 3px var(--myqer-red-light);
        }
        
        /* Sign Out Button */
        .sign-out-btn {
            background: #111827;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sign-out-btn:hover {
            background: #1f2937;
            transform: translateY(-1px);
        }
        
        /* Toast System */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }
        
        .toast {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 231, 235, 0.4);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success::before {
            background: #10b981;
        }
        
        .toast.success {
            color: #059669;
            border-left: 4px solid #10b981;
        }
        
        .toast.error::before {
            background: #dc2626;
        }
        
        .toast.error {
            color: #b91c1c;
            border-left: 4px solid #dc2626;
        }
        
        .toast.info::before {
            background: #3b82f6;
        }
        
        .toast.info {
            color: #1d4ed8;
            border-left: 4px solid #3b82f6;
        }
        
        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .header-content {
                padding: 12px 16px;
                flex-direction: column;
                gap: 16px;
            }
            
            .header-left {
                gap: 16px;
            }
            
            .header-right {
                margin-left: 0;
                gap: 12px;
            }
            
            .logo-text {
                font-size: 1.75rem;
            }
            
            .toast-container {
                top: 16px;
                right: 16px;
                left: 16px;
                max-width: none;
            }
            
            .card-content {
                padding: 20px;
                padding-top: 52px;
            }
            
            .qr-placeholder,
            .qr-display {
                width: 160px;
                height: 160px;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-grid {
                padding: 0 12px;
                gap: 16px;
            }
            
            .card-content {
                padding: 16px;
                padding-top: 48px;
            }
            
            .field-group {
                margin-bottom: 12px;
            }
            
            .compact-input {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .compact-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
        }
        
        /* RTL Support for Arabic */
        [dir="rtl"] .card-ribbon {
            left: auto;
            right: 0;
            border-radius: 0 0 0 16px;
        }
        
        [dir="rtl"] .card-icon {
            right: auto;
            left: 20px;
        }
        
        [dir="rtl"] .warning-box::before {
            left: auto;
            right: 0;
        }
        
        [dir="rtl"] .warning-content {
            flex-direction: row-reverse;
        }
        
        [dir="rtl"] .header-left {
            flex-direction: row-reverse;
        }
        
        [dir="rtl"] .header-right {
            margin-left: 0;
            margin-right: auto;
        }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--myqer-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Focus Management */
        .premium-input:focus,
        .premium-btn:focus,
        .language-selector:focus,
        .sign-out-btn:focus {
            outline: 2px solid var(--myqer-red);
            outline-offset: 2px;
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .premium-card {
                border: 2px solid #000;
            }
            
            .premium-input {
                border: 2px solid #000;
            }
            
            .premium-btn {
                border: 2px solid #000;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Print Styles */
        @media print {
            .floating-header,
            .toast-container {
                display: none;
            }
            
            .premium-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #000;
            }
            
            body {
                background: white;
            }
        }
        
        /* Dark Mode Preparation (for future versions) */
        @media (prefers-color-scheme: dark) {
            :root {
                --glass-bg: rgba(17, 24, 39, 0.85);
                --glass-border: rgba(75, 85, 99, 0.3);
            }
        }
        
        /* Additional Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .hidden { display: none; }
        .block { display: block; }
        .inline-block { display: inline-block; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .top-0 { top: 0; }
        .left-0 { left: 0; }
        .right-0 { right: 0; }
        .bottom-0 { bottom: 0; }
        .z-10 { z-index: 10; }
        .z-20 { z-index: 20; }
        .z-30 { z-index: 30; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .cursor-pointer { cursor: pointer; }
        .cursor-not-allowed { cursor: not-allowed; }
        .select-none { user-select: none; }
        .pointer-events-none { pointer-events: none; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .truncate { 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        
        /* Color Utilities */
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-900 { color: #111827; }
        .text-red-500 { color: #ef4444; }
        .text-red-600 { color: #dc2626; }
        .text-red-700 { color: #b91c1c; }
        .text-red-800 { color: #991b1b; }
        .text-green-500 { color: #10b981; }
        .text-green-600 { color: #059669; }
        .text-green-700 { color: #047857; }
        .text-blue-500 { color: #3b82f6; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-yellow-500 { color: #eab308; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-purple-500 { color: #a855f7; }
        .text-purple-600 { color: #9333ea; }
        .text-purple-700 { color: #7c3aed; }
        
        .bg-white { background-color: #ffffff; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-red-100 { background-color: #fee2e2; }
        .bg-green-50 { background-color: #ecfdf5; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-yellow-100 { background-color: #fef3c7; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-100 { background-color: #f3e8ff; }
        
        /* Border Utilities */
        .border { border: 1px solid #e5e7eb; }
        .border-2 { border: 2px solid #e5e7eb; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-red-200 { border-color: #fecaca; }
        .border-red-300 { border-color: #fca5a5; }
        .border-green-200 { border-color: #bbf7d0; }
        .border-green-300 { border-color: #86efac; }
        .border-blue-200 { border-color: #bfdbfe; }
        .border-blue-300 { border-color: #93c5fd; }
        
        .rounded { border-radius: 0.25rem; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        /* Shadow Utilities */
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        /* Transition Utilities */
        .transition { transition: all 0.15s ease-in-out; }
        .transition-colors { transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out; }
        .transition-transform { transition: transform 0.15s ease-in-out; }
        .transition-opacity { transition: opacity 0.15s ease-in-out; }
        
        .duration-75 { transition-duration: 75ms; }
        .duration-100 { transition-duration: 100ms; }
        .duration-150 { transition-duration: 150ms; }
        .duration-200 { transition-duration: 200ms; }
        .duration-300 { transition-duration: 300ms; }
        .duration-500 { transition-duration: 500ms; }
        .duration-700 { transition-duration: 700ms; }
        .duration-1000 { transition-duration: 1000ms; }
        
        .ease-linear { transition-timing-function: linear; }
        .ease-in { transition-timing-function: cubic-bezier(0.4, 0, 1, 1); }
        .ease-out { transition-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        .ease-in-out { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Transform Utilities */
        .transform { transform: translateX(0) translateY(0) rotate(0) skewX(0) skewY(0) scaleX(1) scaleY(1); }
        .scale-95 { transform: scale(0.95); }
        .scale-100 { transform: scale(1); }
        .scale-105 { transform: scale(1.05); }
        .scale-110 { transform: scale(1.1); }
        .rotate-45 { transform: rotate(45deg); }
        .rotate-90 { transform: rotate(90deg); }
        .rotate-180 { transform: rotate(180deg); }
        .-rotate-45 { transform: rotate(-45deg); }
        .-rotate-90 { transform: rotate(-90deg); }
        .-rotate-180 { transform: rotate(-180deg); }
        
        /* Hover States */
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .hover\:bg-red-50:hover { background-color: #fef2f2; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        .hover\:bg-green-50:hover { background-color: #ecfdf5; }
        .hover\:bg-blue-50:hover { background-color: #eff6ff; }
        
        .hover\:text-gray-700:hover { color: #374151; }
        .hover\:text-gray-900:hover { color: #111827; }
        .hover\:text-red-600:hover { color: #dc2626; }
        .hover\:text-red-700:hover { color: #b91c1c; }
        
        .hover\:border-gray-300:hover { border-color: #d1d5db; }
        .hover\:border-red-300:hover { border-color: #fca5a5; }
        
        .hover\:shadow-md:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .hover\:shadow-lg:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        .hover\:scale-105:hover { transform: scale(1.05); }
        .hover\:-translate-y-1:hover { transform: translateY(-0.25rem); }
        
        /* Focus States */
        .focus\:outline-none:focus { outline: none; }
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
        .focus\:ring-red-500:focus { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5); }
        .focus\:ring-offset-2:focus { box-shadow: 0 0 0 2px #fff, 0 0 0 4px rgba(59, 130, 246, 0.5); }
        
        /* Active States */
        .active\:bg-gray-200:active { background-color: #e5e7eb; }
        .active\:bg-red-700:active { background-color: #b91c1c; }
        .active\:scale-95:active { transform: scale(0.95); }
        
        /* Disabled States */
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
        .disabled\:bg-gray-300:disabled { background-color: #d1d5db; }
        
        /* Group Hover States */
        .group:hover .group-hover\:opacity-100 { opacity: 1; }
        .group:hover .group-hover\:translate-x-1 { transform: translateX(0.25rem); }
        .group:hover .group-hover\:scale-110 { transform: scale(1.1); }
    </style>
</head>
<body class="min-h-screen">
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Premium Floating Header -->
    <header class="floating-header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">
                    <div>
                        <h1 class="logo-text">
                            <span class="logo-myq">MYQ</span><span class="logo-er">ER</span>
                        </h1>
                        <p class="logo-subtitle">pronounced "my care"</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <!-- Enhanced Language Selector -->
                <select id="language-selector" class="language-selector">
                    <option value="en">🇺🇸 English</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="fr">🇫🇷 Français</option>
                    <option value="de">🇩🇪 Deutsch</option>
                    <option value="it">🇮🇹 Italiano</option>
                    <option value="hi">🇮🇳 हिन्दी</option>
                    <option value="ar">🇸🇦 العربية</option>
                    <option value="zh">🇨🇳 中文</option>
                    <option value="hu">🇭🇺 Magyar</option>
                    <option value="ro">🇷🇴 Română</option>
                </select>
                <button onclick="signOut()" class="sign-out-btn">
                    <span data-translate="sign_out">Sign Out</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Dashboard with Perfect 2x2 Grid -->
    <main class="py-12">
        <div class="dashboard-grid">
            
            <!-- Card 1: Identity & Personal Information (Top Left) -->
            <div class="premium-card" id="identityCard">
                <div class="card-ribbon ribbon-identity">Identity</div>
                <div class="card-icon">🧑</div>
                <div class="card-content">
                    <div class="card-header">
                        <h2 class="card-title">Personal Information</h2>
                        <p class="card-subtitle">Essential details that confirm your identity in emergency situations.</p>
                    </div>
                    
                    <div class="card-body">
                        <div class="field-group">
                            <label class="field-label" for="i_name">Full Legal Name</label>
                            <input type="text" id="i_name" class="premium-input compact-input" 
                                   placeholder="Enter your complete legal name" 
                                   autocomplete="name">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="i_dob">Date of Birth</label>
                            <input type="date" id="i_dob" class="premium-input compact-input" 
                                   autocomplete="bday">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="i_country">Country of Residence</label>
                            <select id="i_country" class="premium-input compact-input" autocomplete="country">
                                <option value="">Select Your Country</option>
                                <option value="US">🇺🇸 United States</option>
                                <option value="CA">🇨🇦 Canada</option>
                                <option value="GB">🇬🇧 United Kingdom</option>
                                <option value="AU">🇦🇺 Australia</option>
                                <option value="DE">🇩🇪 Germany</option>
                                <option value="FR">🇫🇷 France</option>
                                <option value="IT">🇮🇹 Italy</option>
                                <option value="ES">🇪🇸 Spain</option>
                                <option value="NL">🇳🇱 Netherlands</option>
                                <option value="SE">🇸🇪 Sweden</option>
                                <option value="NO">🇳🇴 Norway</option>
                                <option value="DK">🇩🇰 Denmark</option>
                                <option value="FI">🇫🇮 Finland</option>
                                <option value="CH">🇨🇭 Switzerland</option>
                                <option value="AT">🇦🇹 Austria</option>
                                <option value="BE">🇧🇪 Belgium</option>
                                <option value="IE">🇮🇪 Ireland</option>
                                <option value="PT">🇵🇹 Portugal</option>
                                <option value="JP">🇯🇵 Japan</option>
                                <option value="KR">🇰🇷 South Korea</option>
                                <option value="SG">🇸🇬 Singapore</option>
                                <option value="NZ">🇳🇿 New Zealand</option>
                                <option value="BR">🇧🇷 Brazil</option>
                                <option value="MX">🇲🇽 Mexico</option>
                                <option value="AR">🇦🇷 Argentina</option>
                                <option value="CL">🇨🇱 Chile</option>
                                <option value="IN">🇮🇳 India</option>
                                <option value="CN">🇨🇳 China</option>
                                <option value="TH">🇹🇭 Thailand</option>
                                <option value="MY">🇲🇾 Malaysia</option>
                                <option value="PH">🇵🇭 Philippines</option>
                                <option value="ID">🇮🇩 Indonesia</option>
                                <option value="VN">🇻🇳 Vietnam</option>
                                <option value="ZA">🇿🇦 South Africa</option>
                                <option value="EG">🇪🇬 Egypt</option>
                                <option value="MA">🇲🇦 Morocco</option>
                                <option value="NG">🇳🇬 Nigeria</option>
                                <option value="KE">🇰🇪 Kenya</option>
                                <option value="IL">🇮🇱 Israel</option>
                                <option value="AE">🇦🇪 UAE</option>
                                <option value="SA">🇸🇦 Saudi Arabia</option>
                                <option value="TR">🇹🇷 Turkey</option>
                                <option value="RU">🇷🇺 Russia</option>
                                <option value="UA">🇺🇦 Ukraine</option>
                                <option value="PL">🇵🇱 Poland</option>
                                <option value="CZ">🇨🇿 Czech Republic</option>
                                <option value="HU">🇭🇺 Hungary</option>
                                <option value="RO">🇷🇴 Romania</option>
                                <option value="BG">🇧🇬 Bulgaria</option>
                                <option value="HR">🇭🇷 Croatia</option>
                                <option value="SI">🇸🇮 Slovenia</option>
                                <option value="SK">🇸🇰 Slovakia</option>
                                <option value="LT">🇱🇹 Lithuania</option>
                                <option value="LV">🇱🇻 Latvia</option>
                                <option value="EE">🇪🇪 Estonia</option>
                            </select>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="i_nhid">National Health ID / Insurance Number</label>
                            <input type="text" id="i_nhid" class="premium-input compact-input" 
                                   placeholder="Enter your health ID or insurance number">
                        </div>
                        
                        <div class="field-row">
                            <div class="field-group">
                                <label class="field-label" for="i_phone">Emergency Phone</label>
                                <input type="tel" id="i_phone" class="premium-input compact-input" 
                                       placeholder="+1 (555) 123-4567" 
                                       autocomplete="tel">
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="i_email">Email Address</label>
                                <input type="email" id="i_email" class="premium-input compact-input" 
                                       placeholder="your@email.com" 
                                       autocomplete="email">
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="i_address">Home Address</label>
                            <input type="text" id="i_address" class="premium-input compact-input" 
                                   placeholder="Street address, city, postal code" 
                                   autocomplete="street-address">
                        </div>
                        
                        <div class="field-row">
                            <div class="field-group">
                                <label class="field-label" for="i_ec_name">Emergency Contact Name</label>
                                <input type="text" id="i_ec_name" class="premium-input compact-input" 
                                       placeholder="Contact person name">
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="i_ec_phone">Emergency Contact Phone</label>
                                <input type="tel" id="i_ec_phone" class="premium-input compact-input" 
                                       placeholder="+1 (555) 987-6543">
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="i_ec_relation">Relationship to Emergency Contact</label>
                            <select id="i_ec_relation" class="premium-input compact-input">
                                <option value="">Select Relationship</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Partner">Partner</option>
                                <option value="Parent">Parent</option>
                                <option value="Child">Child</option>
                                <option value="Sibling">Sibling</option>
                                <option value="Friend">Friend</option>
                                <option value="Relative">Other Relative</option>
                                <option value="Guardian">Legal Guardian</option>
                                <option value="Caregiver">Caregiver</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="save-indicator" id="identity-save">
                            Saved
                        </div>
                        <div class="auto-save-notice">
                            All changes are automatically saved as you type.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2: Health Profile & Medical Information (Top Right) -->
            <div class="premium-card" id="healthCard">
                <div class="card-ribbon ribbon-health">Health Profile</div>
                <div class="card-icon">❤️</div>
                <div class="card-content">
                    <div class="card-header">
                        <h2 class="card-title">Medical Information</h2>
                        <p class="card-subtitle">Critical health data for emergency medical responders and healthcare providers.</p>
                    </div>
                    
                    <div class="card-body">
                        <div class="field-row">
                            <div class="field-group">
                                <label class="field-label" for="h_bt">Blood Type</label>
                                <select id="h_bt" class="premium-input compact-input">
                                    <option value="">Unknown</option>
                                    <option value="A+">A+ (A Positive)</option>
                                    <option value="A-">A- (A Negative)</option>
                                    <option value="B+">B+ (B Positive)</option>
                                    <option value="B-">B- (B Negative)</option>
                                    <option value="AB+">AB+ (AB Positive)</option>
                                    <option value="AB-">AB- (AB Negative)</option>
                                    <option value="O+">O+ (O Positive)</option>
                                    <option value="O-">O- (O Negative)</option>
                                </select>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="h_donor">Organ Donor Status</label>
                                <select id="h_donor" class="premium-input compact-input">
                                    <option value="">Not Specified</option>
                                    <option value="Yes">Yes - Registered Donor</option>
                                    <option value="No">No - Not a Donor</option>
                                    <option value="Family">Family Decision</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_life">Life Support & Resuscitation Preferences</label>
                            <select id="h_life" class="premium-input compact-input">
                                <option value="">No Preference Specified</option>
                                <option value="Full">Full Life Support - All Measures</option>
                                <option value="Limited">Limited Support - Basic Care Only</option>
                                <option value="Comfort">Comfort Care Only - Pain Management</option>
                                <option value="DNR">Do Not Resuscitate (DNR)</option>
                                <option value="DNI">Do Not Intubate (DNI)</option>
                                <option value="POLST">POLST/MOLST on File</option>
                                <option value="Living Will">Living Will Available</option>
                            </select>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_all">Allergies & Adverse Reactions</label>
                            <input type="text" id="h_all" class="premium-input compact-input" 
                                   placeholder="e.g., Penicillin, Peanuts, Latex, Shellfish, Bee stings">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_cond">Medical Conditions & Diagnoses</label>
                            <input type="text" id="h_cond" class="premium-input compact-input" 
                                   placeholder="e.g., Diabetes, Heart Disease, Asthma, Epilepsy, Cancer">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_meds">Current Medications</label>
                            <input type="text" id="h_meds" class="premium-input compact-input" 
                                   placeholder="e.g., Metformin 500mg, Lisinopril 10mg, Albuterol inhaler">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_impl">Medical Devices & Implants</label>
                            <input type="text" id="h_impl" class="premium-input compact-input" 
                                   placeholder="e.g., Pacemaker, Hip replacement, Insulin pump, Hearing aid">
                        </div>
                        
                        <div class="field-row">
                            <div class="field-group">
                                <label class="field-label" for="h_height">Height</label>
                                <input type="text" id="h_height" class="premium-input compact-input" 
                                       placeholder="e.g., 5'8&quot; or 173cm">
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="h_weight">Weight</label>
                                <input type="text" id="h_weight" class="premium-input compact-input" 
                                       placeholder="e.g., 150 lbs or 68 kg">
                            </div>
                        </div>
                        
                        <div class="field-row">
                            <div class="field-group">
                                <label class="field-label" for="h_bur">Burial/Final Wishes</label>
                                <select id="h_bur" class="premium-input compact-input">
                                    <option value="">Not Specified</option>
                                    <option value="Burial">Traditional Burial</option>
                                    <option value="Cremation">Cremation</option>
                                    <option value="Donation">Body Donation to Science</option>
                                    <option value="Green">Green/Natural Burial</option>
                                    <option value="Family">Family Decision</option>
                                </select>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="h_rel">Religious/Cultural Preferences</label>
                                <input type="text" id="h_rel" class="premium-input compact-input" 
                                       placeholder="e.g., Catholic, Jewish, Muslim, Hindu, Buddhist">
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_physician">Primary Care Physician</label>
                            <input type="text" id="h_physician" class="premium-input compact-input" 
                                   placeholder="Dr. Name, Clinic/Hospital, Phone Number">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_insurance">Health Insurance Provider</label>
                            <input type="text" id="h_insurance" class="premium-input compact-input" 
                                   placeholder="Insurance company name and policy number">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label" for="h_notes">Additional Medical Notes</label>
                            <textarea id="h_notes" class="premium-input compact-input" rows="2" 
                                      placeholder="Any other important medical information for emergency responders"></textarea>
                        </div>
                        
                        <div class="triage-container">
                            <div id="triage-pill" class="triage-pill triage-green">
                                <span class="triage-indicator"></span>
                                Priority: Green (Stable)
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="auto-save-notice">
                            Medical information is encrypted and auto-saved. Triage priority is calculated in real-time.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 3: Emergency QR Code Generator (Bottom Left) -->
            <div class="premium-card">
                <div class="card-ribbon ribbon-qr">QR Code</div>
                <div class="card-icon">🔳</div>
                <div class="card-content">
                    <div class="card-header">
                        <h2 class="card-title">Emergency QR Code</h2>
                        <p class="card-subtitle">Instant access to your medical profile for first responders and healthcare providers.</p>
                    </div>
                    
                    <div class="card-body">
                        <div class="qr-container">
                            <div id="qr-placeholder" class="qr-placeholder">
                                <div class="text-center">
                                    <div class="text-4xl mb-3 opacity-40">📱</div>
                                    <p class="text-sm text-gray-500 font-semibold">QR Code Not Generated</p>
                                    <p class="text-xs text-gray-400 mt-1">Click below to create your emergency code</p>
                                </div>
                            </div>
                            
                            <div id="qr-display" class="qr-display hidden">
                                <canvas id="qr-canvas" width="180" height="180"></canvas>
                            </div>
                            
                            <div id="qr-link-section" class="hidden w-full">
                                <div class="emergency-link" id="emergency-link">
                                    www.myqer.com/c/xxxxxx
                                </div>
                            </div>
                            
                            <button onclick="generateQRCode()" id="generate-btn" class="premium-btn compact-btn w-full">
                                🔄 Generate Emergency QR Code
                            </button>
                            
                            <div id="qr-actions" class="qr-actions hidden">
                                <button onclick="copyLink()" class="premium-btn compact-btn">
                                    📋 Copy Link
                                </button>
                                <button onclick="printQR()" class="premium-btn compact-btn">
                                    🖨️ Print Card
                                </button>
                                <button onclick="downloadQR()" class="premium-btn compact-btn">
                                    💾 Download
                                </button>
                            </div>
                            
                            <div class="text-center mt-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <p class="text-xs text-blue-700 font-medium">
                                        🔒 <strong>Privacy Protected:</strong> Your QR code provides secure, read-only access to essential medical information only.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="auto-save-notice">
                            QR codes are unique, secure, and GDPR/HIPAA compliant. Print and carry for emergencies.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 4: Account Management & Danger Zone (Bottom Right) -->
            <div class="premium-card">
                <div class="card-ribbon ribbon-danger">Danger Zone</div>
                <div class="card-icon">⚠️</div>
                <div class="card-content">
                    <div class="card-header">
                        <h2 class="card-title text-red-600">Account Management</h2>
                        <p class="card-subtitle">Manage your account settings and data. These actions are permanent and cannot be undone.</p>
                    </div>
                    
                    <div class="card-body">
                        <div class="warning-box">
                            <div class="warning-content">
                                <span class="warning-icon">⚠️</span>
                                <div class="warning-text">
                                    <div class="warning-title">Permanent Data Deletion</div>
                                    <div class="warning-description">
                                        Deleting your account will permanently remove all personal information, medical data, 
                                        emergency contacts, and QR codes from our secure servers. This action cannot be reversed 
                                        and all data will be lost forever.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-red-800 mb-2 text-sm">Before You Delete:</h3>
                            <ul class="text-xs text-red-700 space-y-1">
                                <li>• Download or print your emergency card</li>
                                <li>• Inform emergency contacts of the change</li>
                                <li>• Update any medical alert devices</li>
                                <li>• Consider exporting your medical data</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="exportData()" class="secondary-btn compact-btn w-full">
                                📤 Export My Data (JSON)
                            </button>
                            
                            <button onclick="clearAllData()" class="secondary-btn compact-btn w-full">
                                🗑️ Clear All Form Data
                            </button>
                            
                            <div class="border-t border-gray-200 pt-4 mt-4">
                                <button onclick="deleteAccount()" class="danger-btn compact-btn w-full">
                                    🗑️ Delete Account Permanently
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mt-4">
                            <p class="text-xs text-gray-600 text-center">
                                <strong>Security Notice:</strong> Account deletion requires double confirmation and 
                                immediate sign-out for your protection.
                            </p>
                        </div>
                        
                        <div class="text-center mt-4">
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <p class="text-xs text-purple-700 font-medium">
                                    💜 <strong>Need Help?</strong> Contact our support team before deleting your account. 
                                    We're here to help resolve any issues.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="auto-save-notice">
                            All account actions are logged for security. Data deletion is immediate and irreversible.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced JavaScript with Full Functionality -->
    <script>
        // ===== SUPABASE CONFIGURATION & INITIALIZATION =====
        const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const sb = supabase; // Alias for consistency
        
        // ===== GLOBAL STATE MANAGEMENT =====
        let currentUser = null;
        let currentLanguage = 'en';
        let profile = null;
        let health = null;
        let isLoading = false;
        let saveTimeouts = {};
        
        // ===== ENHANCED MULTI-LANGUAGE SUPPORT =====
        const translations = {
            en: {
                sign_out: "Sign Out",
                loading: "Loading...",
                saving: "Saving...",
                saved: "Saved",
                error: "Error",
                success: "Success",
                delete_confirm: "DELETE",
                export_success: "Data exported successfully",
                clear_success: "All form data cleared",
                qr_generated: "Emergency QR Code generated successfully!",
                qr_copied: "Emergency link copied to clipboard!",
                qr_print_ready: "Emergency medical card ready to print!",
                account_deleted: "Account deleted successfully",
                session_expired: "Session expired. Please sign in again.",
                network_error: "Network error. Please check your connection.",
                validation_error: "Please check your input and try again."
            },
            es: {
                sign_out: "Cerrar Sesión",
                loading: "Cargando...",
                saving: "Guardando...",
                saved: "Guardado",
                error: "Error",
                success: "Éxito",
                delete_confirm: "ELIMINAR",
                export_success: "Datos exportados exitosamente",
                clear_success: "Todos los datos del formulario eliminados",
                qr_generated: "¡Código QR de emergencia generado exitosamente!",
                qr_copied: "¡Enlace de emergencia copiado al portapapeles!",
                qr_print_ready: "¡Tarjeta médica de emergencia lista para imprimir!",
                account_deleted: "Cuenta eliminada exitosamente",
                session_expired: "Sesión expirada. Por favor inicie sesión nuevamente.",
                network_error: "Error de red. Por favor verifique su conexión.",
                validation_error: "Por favor verifique su entrada e intente nuevamente."
            },
            fr: {
                sign_out: "Se Déconnecter",
                loading: "Chargement...",
                saving: "Sauvegarde...",
                saved: "Sauvegardé",
                error: "Erreur",
                success: "Succès",
                delete_confirm: "SUPPRIMER",
                export_success: "Données exportées avec succès",
                clear_success: "Toutes les données du formulaire effacées",
                qr_generated: "Code QR d'urgence généré avec succès!",
                qr_copied: "Lien d'urgence copié dans le presse-papiers!",
                qr_print_ready: "Carte médicale d'urgence prête à imprimer!",
                account_deleted: "Compte supprimé avec succès",
                session_expired: "Session expirée. Veuillez vous reconnecter.",
                network_error: "Erreur réseau. Veuillez vérifier votre connexion.",
                validation_error: "Veuillez vérifier votre saisie et réessayer."
            },
            de: {
                sign_out: "Abmelden",
                loading: "Laden...",
                saving: "Speichern...",
                saved: "Gespeichert",
                error: "Fehler",
                success: "Erfolg",
                delete_confirm: "LÖSCHEN",
                export_success: "Daten erfolgreich exportiert",
                clear_success: "Alle Formulardaten gelöscht",
                qr_generated: "Notfall-QR-Code erfolgreich generiert!",
                qr_copied: "Notfall-Link in die Zwischenablage kopiert!",
                qr_print_ready: "Notfall-Medizinkarte druckbereit!",
                account_deleted: "Konto erfolgreich gelöscht",
                session_expired: "Sitzung abgelaufen. Bitte melden Sie sich erneut an.",
                network_error: "Netzwerkfehler. Bitte überprüfen Sie Ihre Verbindung.",
                validation_error: "Bitte überprüfen Sie Ihre Eingabe und versuchen Sie es erneut."
            },
            it: {
                sign_out: "Disconnetti",
                loading: "Caricamento...",
                saving: "Salvataggio...",
                saved: "Salvato",
                error: "Errore",
                success: "Successo",
                delete_confirm: "ELIMINA",
                export_success: "Dati esportati con successo",
                clear_success: "Tutti i dati del modulo cancellati",
                qr_generated: "Codice QR di emergenza generato con successo!",
                qr_copied: "Link di emergenza copiato negli appunti!",
                qr_print_ready: "Carta medica di emergenza pronta per la stampa!",
                account_deleted: "Account eliminato con successo",
                session_expired: "Sessione scaduta. Effettua nuovamente l'accesso.",
                network_error: "Errore di rete. Controlla la tua connessione.",
                validation_error: "Controlla il tuo input e riprova."
            },
            hi: {
                sign_out: "साइन आउट",
                loading: "लोड हो रहा है...",
                saving: "सेव हो रहा है...",
                saved: "सेव हो गया",
                error: "त्रुटि",
                success: "सफलता",
                delete_confirm: "हटाएं",
                export_success: "डेटा सफलतापूर्वक निर्यात किया गया",
                clear_success: "सभी फॉर्म डेटा साफ़ किया गया",
                qr_generated: "आपातकालीन QR कोड सफलतापूर्वक जेनरेट किया गया!",
                qr_copied: "आपातकालीन लिंक क्लिपबोर्ड में कॉपी किया गया!",
                qr_print_ready: "आपातकालीन मेडिकल कार्ड प्रिंट के लिए तैयार!",
                account_deleted: "खाता सफलतापूर्वक हटा दिया गया",
                session_expired: "सत्र समाप्त हो गया। कृपया फिर से साइन इन करें।",
                network_error: "नेटवर्क त्रुटि। कृपया अपना कनेक्शन जांचें।",
                validation_error: "कृपया अपना इनपुट जांचें और फिर से कोशिश करें।"
            },
            ar: {
                sign_out: "تسجيل الخروج",
                loading: "جاري التحميل...",
                saving: "جاري الحفظ...",
                saved: "تم الحفظ",
                error: "خطأ",
                success: "نجح",
                delete_confirm: "حذف",
                export_success: "تم تصدير البيانات بنجاح",
                clear_success: "تم مسح جميع بيانات النموذج",
                qr_generated: "تم إنشاء رمز QR للطوارئ بنجاح!",
                qr_copied: "تم نسخ رابط الطوارئ إلى الحافظة!",
                qr_print_ready: "بطاقة الطوارئ الطبية جاهزة للطباعة!",
                account_deleted: "تم حذف الحساب بنجاح",
                session_expired: "انتهت صلاحية الجلسة. يرجى تسجيل الدخول مرة أخرى.",
                network_error: "خطأ في الشبكة. يرجى التحقق من اتصالك.",
                validation_error: "يرجى التحقق من إدخالك والمحاولة مرة أخرى."
            },
            zh: {
                sign_out: "退出登录",
                loading: "加载中...",
                saving: "保存中...",
                saved: "已保存",
                error: "错误",
                success: "成功",
                delete_confirm: "删除",
                export_success: "数据导出成功",
                clear_success: "所有表单数据已清除",
                qr_generated: "紧急二维码生成成功！",
                qr_copied: "紧急链接已复制到剪贴板！",
                qr_print_ready: "紧急医疗卡准备打印！",
                account_deleted: "账户删除成功",
                session_expired: "会话已过期。请重新登录。",
                network_error: "网络错误。请检查您的连接。",
                validation_error: "请检查您的输入并重试。"
            },
            hu: {
                sign_out: "Kijelentkezés",
                loading: "Betöltés...",
                saving: "Mentés...",
                saved: "Mentve",
                error: "Hiba",
                success: "Siker",
                delete_confirm: "TÖRLÉS",
                export_success: "Adatok sikeresen exportálva",
                clear_success: "Minden űrlapadat törölve",
                qr_generated: "Vészhelyzeti QR kód sikeresen generálva!",
                qr_copied: "Vészhelyzeti link vágólapra másolva!",
                qr_print_ready: "Vészhelyzeti orvosi kártya nyomtatásra kész!",
                account_deleted: "Fiók sikeresen törölve",
                session_expired: "Munkamenet lejárt. Kérjük, jelentkezzen be újra.",
                network_error: "Hálózati hiba. Kérjük, ellenőrizze a kapcsolatot.",
                validation_error: "Kérjük, ellenőrizze a bevitelt és próbálja újra."
            },
            ro: {
                sign_out: "Deconectare",
                loading: "Se încarcă...",
                saving: "Se salvează...",
                saved: "Salvat",
                error: "Eroare",
                success: "Succes",
                delete_confirm: "ȘTERGE",
                export_success: "Datele au fost exportate cu succes",
                clear_success: "Toate datele formularului au fost șterse",
                qr_generated: "Codul QR de urgență a fost generat cu succes!",
                qr_copied: "Linkul de urgență a fost copiat în clipboard!",
                qr_print_ready: "Cardul medical de urgență este gata pentru printare!",
                account_deleted: "Contul a fost șters cu succes",
                session_expired: "Sesiunea a expirat. Vă rugăm să vă conectați din nou.",
                network_error: "Eroare de rețea. Vă rugăm să verificați conexiunea.",
                validation_error: "Vă rugăm să verificați datele introduse și să încercați din nou."
            }
        };
        
        // ===== UTILITY FUNCTIONS =====
        
        // Enhanced debounce function with immediate execution option
        function debounce(func, wait, immediate = false) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }
        
        // Enhanced toast notification system
        function toast(message, type = 'success', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Add icon based on type
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">${icons[type] || icons.success}</span>
                    <span class="flex-1">${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400);
            }, duration);
            
            // Click to dismiss
            toast.addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400);
            });
        }
        
        // Enhanced save indicator with animation
        function showSaveIndicator(elementId, message = 'saved') {
            const indicator = document.getElementById(elementId);
            if (!indicator) return;
            
            const translatedMessage = translations[currentLanguage]?.[message] || message;
            indicator.textContent = translatedMessage;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2500);
        }
        
        // Enhanced loading state management
        function setLoadingState(element, isLoading, originalText = '') {
            if (!element) return;
            
            if (isLoading) {
                element.classList.add('loading');
                element.disabled = true;
                if (originalText) {
                    element.dataset.originalText = originalText;
                    element.textContent = translations[currentLanguage]?.loading || 'Loading...';
                }
            } else {
                element.classList.remove('loading');
                element.disabled = false;
                if (element.dataset.originalText) {
                    element.textContent = element.dataset.originalText;
                    delete element.dataset.originalText;
                }
            }
        }
        
        // ===== LANGUAGE MANAGEMENT =====
        
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('myqer_language', lang);
            
            // Set document attributes for RTL languages
            if (lang === 'ar') {
                document.documentElement.setAttribute('dir', 'rtl');
                document.documentElement.setAttribute('lang', 'ar');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
                document.documentElement.setAttribute('lang', lang);
            }
            
            // Update all translatable elements
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update placeholders and other dynamic content
            updateDynamicTranslations(lang);
        }
        
        function updateDynamicTranslations(lang) {
            // Update form placeholders based on language
            const placeholderMappings = {
                en: {
                    'i_name': 'Enter your complete legal name',
                    'i_phone': '+1 (555) 123-4567',
                    'i_email': 'your@email.com',
                    'i_address': 'Street address, city, postal code',
                    'i_ec_name': 'Contact person name',
                    'i_ec_phone': '+1 (555) 987-6543',
                    'h_all': 'e.g., Penicillin, Peanuts, Latex, Shellfish, Bee stings',
                    'h_cond': 'e.g., Diabetes, Heart Disease, Asthma, Epilepsy, Cancer',
                    'h_meds': 'e.g., Metformin 500mg, Lisinopril 10mg, Albuterol inhaler',
                    'h_impl': 'e.g., Pacemaker, Hip replacement, Insulin pump, Hearing aid'
                },
                es: {
                    'i_name': 'Ingrese su nombre legal completo',
                    'i_phone': '+34 123 456 789',
                    'i_email': 'su@email.com',
                    'i_address': 'Dirección, ciudad, código postal',
                    'i_ec_name': 'Nombre de la persona de contacto',
                    'i_ec_phone': '+34 987 654 321',
                    'h_all': 'ej., Penicilina, Cacahuetes, Látex, Mariscos, Picaduras de abeja',
                    'h_cond': 'ej., Diabetes, Enfermedad Cardíaca, Asma, Epilepsia, Cáncer',
                    'h_meds': 'ej., Metformina 500mg, Lisinopril 10mg, Inhalador Albuterol',
                    'h_impl': 'ej., Marcapasos, Reemplazo de cadera, Bomba de insulina, Audífono'
                },
                fr: {
                    'i_name': 'Entrez votre nom légal complet',
                    'i_phone': '+33 1 23 45 67 89',
                    'i_email': 'votre@email.com',
                    'i_address': 'Adresse, ville, code postal',
                    'i_ec_name': 'Nom de la personne de contact',
                    'i_ec_phone': '+33 9 87 65 43 21',
                    'h_all': 'ex., Pénicilline, Arachides, Latex, Fruits de mer, Piqûres d\'abeille',
                    'h_cond': 'ex., Diabète, Maladie Cardiaque, Asthme, Épilepsie, Cancer',
                    'h_meds': 'ex., Metformine 500mg, Lisinopril 10mg, Inhalateur Albutérol',
                    'h_impl': 'ex., Stimulateur cardiaque, Prothèse de hanche, Pompe à insuline, Aide auditive'
                }
                // Add more languages as needed
            };
            
            const currentMappings = placeholderMappings[lang] || placeholderMappings.en;
            Object.keys(currentMappings).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.placeholder = currentMappings[id];
                }
            });
        }
        
        // ===== SESSION MANAGEMENT =====
        
        async function checkSession() {
            try {
                setLoadingState(document.body, true);
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session check error:', error);
                    toast(translations[currentLanguage]?.session_expired || 'Session expired', 'error');
                    redirectToLogin();
                    return;
                }
                
                if (!session) {
                    redirectToLogin();
                    return;
                }
                
                currentUser = session.user;
                await loadAllData();
                
            } catch (error) {
                console.error('Session check failed:', error);
                toast(translations[currentLanguage]?.network_error || 'Network error', 'error');
                redirectToLogin();
            } finally {
                setLoadingState(document.body, false);
            }
        }
        
        function redirectToLogin() {
            // Clear any stored data
            localStorage.removeItem('myqer_session');
            // Redirect to login page
            window.location.href = '/index.html';
        }
        
        async function signOut() {
            try {
                setLoadingState(document.querySelector('.sign-out-btn'), true, 'Sign Out');
                
                await supabase.auth.signOut();
                localStorage.removeItem('myqer_session');
                
                toast(translations[currentLanguage]?.success || 'Signed out successfully');
                
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 1000);
                
            } catch (error) {
                console.error('Sign out error:', error);
                toast(translations[currentLanguage]?.error || 'Sign out failed', 'error');
                // Force redirect anyway
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 2000);
            }
        }
        
        // ===== DATA MANAGEMENT =====
        
        async function loadAllData() {
            if (!currentUser) return;
            
            try {
                // Load profile data
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                // Load health data
                const { data: healthData, error: healthError } = await supabase
                    .from('health_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                // Set defaults if no data exists
                profile = profileData || { id: currentUser.id, email: currentUser.email };
                health = healthData || { user_id: currentUser.id };
                
                // Populate form fields
                populateIdentityForm();
                populateHealthForm();
                
                // Show existing QR code if available
                if (profile.code) {
                    showExistingQR(profile.code);
                }
                
                // Calculate and display triage
                calculateAndDisplayTriage();
                
            } catch (error) {
                console.error('Error loading data:', error);
                toast(translations[currentLanguage]?.error || 'Failed to load data', 'error');
            }
        }
        
        function populateIdentityForm() {
            if (!profile) return;
            
            const fields = [
                'i_name', 'i_dob', 'i_country', 'i_nhid', 'i_phone', 
                'i_email', 'i_address', 'i_ec_name', 'i_ec_phone', 'i_ec_relation'
            ];
            
            const mapping = {
                'i_name': 'full_name',
                'i_dob': 'date_of_birth',
                'i_country': 'country',
                'i_nhid': 'health_id',
                'i_phone': 'phone',
                'i_email': 'email',
                'i_address': 'address',
                'i_ec_name': 'emergency_contact_name',
                'i_ec_phone': 'emergency_contact_phone',
                'i_ec_relation': 'emergency_contact_relation'
            };
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                const dataKey = mapping[fieldId];
                if (element && profile[dataKey]) {
                    element.value = profile[dataKey];
                }
            });
        }
        
        function populateHealthForm() {
            if (!health) return;
            
            const fields = [
                'h_bt', 'h_donor', 'h_life', 'h_all', 'h_cond', 'h_meds', 
                'h_impl', 'h_height', 'h_weight', 'h_bur', 'h_rel', 
                'h_physician', 'h_insurance', 'h_notes'
            ];
            
            const mapping = {
                'h_bt': 'blood_type',
                'h_donor': 'organ_donor',
                'h_life': 'life_support_pref',
                'h_all': 'allergies',
                'h_cond': 'conditions',
                'h_meds': 'medications',
                'h_impl': 'implants',
                'h_height': 'height',
                'h_weight': 'weight',
                'h_bur': 'burial_pref',
                'h_rel': 'religion_pref',
                'h_physician': 'primary_physician',
                'h_insurance': 'insurance_info',
                'h_notes': 'additional_notes'
            };
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                const dataKey = mapping[fieldId];
                if (element && health[dataKey] !== undefined) {
                    if (fieldId === 'h_donor') {
                        element.value = health[dataKey] === true ? 'Yes' : 
                                       health[dataKey] === false ? 'No' : '';
                    } else {
                        element.value = health[dataKey] || '';
                    }
                }
            });
        }
        
        // Enhanced auto-save for identity data
        const saveIdentityData = debounce(async () => {
            if (!currentUser || isLoading) return;
            
            try {
                const identityData = {
                    id: currentUser.id,
                    email: currentUser.email,
                    full_name: document.getElementById('i_name')?.value?.trim() || '',
                    date_of_birth: document.getElementById('i_dob')?.value || null,
                    country: document.getElementById('i_country')?.value || '',
                    health_id: document.getElementById('i_nhid')?.value?.trim() || '',
                    phone: document.getElementById('i_phone')?.value?.trim() || '',
                    address: document.getElementById('i_address')?.value?.trim() || '',
                    emergency_contact_name: document.getElementById('i_ec_name')?.value?.trim() || '',
                    emergency_contact_phone: document.getElementById('i_ec_phone')?.value?.trim() || '',
                    emergency_contact_relation: document.getElementById('i_ec_relation')?.value || '',
                    updated_at: new Date().toISOString()
                };
                
                // Preserve existing code if it exists
                if (profile?.code) {
                    identityData.code = profile.code;
                }
                
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert(identityData)
                    .select()
                    .single();
                
                if (error) throw error;
                
                profile = data;
                showSaveIndicator('identity-save');
                toast(translations[currentLanguage]?.saved || 'Identity saved', 'success', 2000);
                
            } catch (error) {
                console.error('Error saving identity:', error);
                toast(translations[currentLanguage]?.error || 'Failed to save identity', 'error');
            }
        }, 800);
        
        // Enhanced auto-save for health data
        const saveHealthData = debounce(async () => {
            if (!currentUser || isLoading) return;
            
            try {
                const healthData = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('h_bt')?.value || null,
                    organ_donor: document.getElementById('h_donor')?.value === 'Yes' ? true : 
                                document.getElementById('h_donor')?.value === 'No' ? false : null,
                    life_support_pref: document.getElementById('h_life')?.value || '',
                    allergies: document.getElementById('h_all')?.value?.trim() || '',
                    conditions: document.getElementById('h_cond')?.value?.trim() || '',
                    medications: document.getElementById('h_meds')?.value?.trim() || '',
                    implants: document.getElementById('h_impl')?.value?.trim() || '',
                    height: document.getElementById('h_height')?.value?.trim() || '',
                    weight: document.getElementById('h_weight')?.value?.trim() || '',
                    burial_pref: document.getElementById('h_bur')?.value || '',
                    religion_pref: document.getElementById('h_rel')?.value?.trim() || '',
                    primary_physician: document.getElementById('h_physician')?.value?.trim() || '',
                    insurance_info: document.getElementById('h_insurance')?.value?.trim() || '',
                    additional_notes: document.getElementById('h_notes')?.value?.trim() || '',
                    updated_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('health_profiles')
                    .upsert(healthData)
                    .select()
                    .single();
                
                if (error) throw error;
                
                health = data;
                calculateAndDisplayTriage();
                toast(translations[currentLanguage]?.saved || 'Health profile saved', 'success', 2000);
                
            } catch (error) {
                console.error('Error saving health data:', error);
                toast(translations[currentLanguage]?.error || 'Failed to save health data', 'error');
            }
        }, 1000);
        
        // ===== TRIAGE SYSTEM =====
        
        function calculateAndDisplayTriage() {
            const lifePref = document.getElementById('h_life')?.value || '';
            const allergies = document.getElementById('h_all')?.value?.toLowerCase() || '';
            const conditions = document.getElementById('h_cond')?.value?.toLowerCase() || '';
            const medications = document.getElementById('h_meds')?.value || '';
            const implants = document.getElementById('h_impl')?.value?.toLowerCase() || '';
            
            let priority = 'Green';
            let className = 'triage-green';
            let description = 'Stable';
            
            // Black priority (DNR/End of life)
            if (lifePref === 'DNR' || lifePref === 'Comfort') {
                priority = 'Black';
                className = 'triage-black';
                description = 'Comfort Care';
            } else {
                // Critical allergies that could cause anaphylaxis
                const criticalAllergies = [
                    'anaphylaxis', 'epipen', 'epinephrine', 'penicillin', 'peanut', 
                    'shellfish', 'bee sting', 'wasp', 'latex', 'contrast dye'
                ];
                
                // Critical medical conditions
                const criticalConditions = [
                    'heart attack', 'cardiac', 'stroke', 'seizure', 'epilepsy', 
                    'diabetes', 'insulin', 'cancer', 'chemotherapy', 'dialysis',
                    'transplant', 'immunocompromised', 'blood clot', 'aneurysm'
                ];
                
                // Critical implants/devices
                const criticalImplants = [
                    'pacemaker', 'defibrillator', 'insulin pump', 'ventilator',
                    'tracheostomy', 'feeding tube', 'catheter'
                ];
                
                const hasCriticalAllergy = criticalAllergies.some(allergy => 
                    allergies.includes(allergy)
                );
                
                const hasCriticalCondition = criticalConditions.some(condition => 
                    conditions.includes(condition)
                );
                
                const hasCriticalImplant = criticalImplants.some(implant => 
                    implants.includes(implant)
                );
                
                const medicationCount = medications.split(',').filter(med => med.trim()).length;
                const hasMultipleMedications = medicationCount >= 4;
                
                // Red priority (Critical/Immediate)
                if (hasCriticalAllergy || hasCriticalCondition || hasCriticalImplant) {
                    priority = 'Red';
                    className = 'triage-red';
                    description = 'Critical';
                } 
                // Amber priority (Urgent)
                else if (allergies || conditions || hasMultipleMedications || medicationCount >= 2) {
                    priority = 'Amber';
                    className = 'triage-amber';
                    description = 'Urgent';
                }
                // Green remains default (Stable)
            }
            
            // Update triage display
            const triagePill = document.getElementById('triage-pill');
            if (triagePill) {
                triagePill.className = `triage-pill ${className}`;
                triagePill.innerHTML = `
                    <span class="triage-indicator"></span>
                    Priority: ${priority} (${description})
                `;
            }
        }
        
        // ===== QR CODE SYSTEM =====
        
        async function ensureEmergencyCode() {
            if (profile?.code && profile.code.length >= 16) {
                return profile.code;
            }
            
            // Generate a secure, unique code
            const code = generateSecureCode();
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert({
                        id: currentUser.id,
                        email: currentUser.email,
                        code: code,
                        updated_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                profile = data;
                return code;
                
            } catch (error) {
                console.error('Error generating emergency code:', error);
                throw error;
            }
        }
        
        function generateSecureCode() {
            // Generate a cryptographically secure random code
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }
        
        async function generateQRCode() {
            const generateBtn = document.getElementById('generate-btn');
            
            try {
                setLoadingState(generateBtn, true, generateBtn.textContent);
                
                const code = await ensureEmergencyCode();
                await renderQRCode(code);
                
                toast(translations[currentLanguage]?.qr_generated || 'Emergency QR Code generated successfully!');
                
            } catch (error) {
                console.error('QR generation error:', error);
                toast(translations[currentLanguage]?.error || 'Failed to generate QR code', 'error');
            } finally {
                setLoadingState(generateBtn, false);
            }
        }
        
        async function renderQRCode(code) {
            const canvas = document.getElementById('qr-canvas');
            const linkEl = document.getElementById('emergency-link');
            
            if (!canvas || !linkEl) return;
            
            // Check if QRCode library is available
            if (typeof QRCode === 'undefined' || !QRCode.toCanvas) {
                throw new Error('QR Code library not loaded');
            }
            
            const emergencyUrl = `https://www.myqer.com/c/${code}`;
            const displayUrl = `www.myqer.com/c/${code.slice(0, 8)}...`;
            
            linkEl.textContent = displayUrl;
            
            // Generate QR code with MYQER branding
            await QRCode.toCanvas(canvas, emergencyUrl, {
                margin: 2,
                width: 180,
                color: {
                    dark: '#C62828',    // MYQER red
                    light: '#FFFFFF00'  // Transparent background
                },
                errorCorrectionLevel: 'H'
            });
            
            // Add MYQER logo in center
            addQRLogo(canvas);
            
            // Show QR code elements
            document.getElementById('qr-placeholder').classList.add('hidden');
            document.getElementById('qr-display').classList.remove('hidden');
            document.getElementById('qr-link-section').classList.remove('hidden');
            document.getElementById('qr-actions').classList.remove('hidden');
            document.getElementById('generate-btn').innerHTML = '🔄 Regenerate Emergency Code';
        }
        
        function addQRLogo(canvas) {
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const logoSize = 28;
            
            // Draw white background circle
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(centerX, centerY, logoSize / 2 + 2, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw red border
            ctx.strokeStyle = '#C62828';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, logoSize / 2 + 1, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw MYQER text
            ctx.fillStyle = '#C62828';
            ctx.font = 'bold 8px system-ui, -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('MYQER', centerX, centerY - 1);
            ctx.fillText('ER', centerX, centerY + 7);
        }
        
        function showExistingQR(code) {
            const canvas = document.getElementById('qr-canvas');
            const linkEl = document.getElementById('emergency-link');
            
            if (!canvas || !linkEl) return;
            
            const emergencyUrl = `https://www.myqer.com/c/${code}`;
            const displayUrl = `www.myqer.com/c/${code.slice(0, 8)}...`;
            
            linkEl.textContent = displayUrl;
            
            QRCode.toCanvas(canvas, emergencyUrl, {
                margin: 2,
                width: 180,
                color: {
                    dark: '#C62828',
                    light: '#FFFFFF00'
                },
                errorCorrectionLevel: 'H'
            }, (error) => {
                if (!error) {
                    addQRLogo(canvas);
                    
                    // Show QR code elements
                    document.getElementById('qr-placeholder').classList.add('hidden');
                    document.getElementById('qr-display').classList.remove('hidden');
                    document.getElementById('qr-link-section').classList.remove('hidden');
                    document.getElementById('qr-actions').classList.remove('hidden');
                    document.getElementById('generate-btn').innerHTML = '🔄 Regenerate Emergency Code';
                }
            });
        }
        
        async function copyLink() {
            const code = profile?.code;
            if (!code) {
                toast('No emergency code available', 'error');
                return;
            }
            
            const url = `https://www.myqer.com/c/${code}`;
            
            try {
                await navigator.clipboard.writeText(url);
                toast(translations[currentLanguage]?.qr_copied || 'Emergency link copied to clipboard!');
            } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                toast(translations[currentLanguage]?.qr_copied || 'Emergency link copied to clipboard!');
            }
        }
        
        function downloadQR() {
            const canvas = document.getElementById('qr-canvas');
            const code = profile?.code;
            
            if (!canvas || !code) {
                toast('No QR code available for download', 'error');
                return;
            }
            
            try {
                // Create download link
                const link = document.createElement('a');
                link.download = `MYQER-Emergency-QR-${code.slice(0, 8)}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                toast('QR code downloaded successfully!');
            } catch (error) {
                console.error('Download error:', error);
                toast('Failed to download QR code', 'error');
            }
        }
        
        function printQR() {
            const canvas = document.getElementById('qr-canvas');
            const code = profile?.code;
            
            if (!canvas || !code) {
                toast('No QR code available for printing', 'error');
                return;
            }
            
            try {
                const fullName = document.getElementById('i_name')?.value || 'Name Not Set';
                const dob = document.getElementById('i_dob')?.value || 'DOB Not Set';
                const bloodType = document.getElementById('h_bt')?.value || 'Unknown';
                const allergies = document.getElementById('h_all')?.value || 'None listed';
                const conditions = document.getElementById('h_cond')?.value || 'None listed';
                const emergencyContact = document.getElementById('i_ec_name')?.<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9788aaa55778d8e0',t:'MTc1Njc3MDU5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
