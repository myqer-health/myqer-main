<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MYQER – Emergency Medical Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase v2 (optional – page still works without it) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- QR library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          brand:'#000000', emergency:'#dc2626', critical:'#dc2626', ice:'#ea580c',
          identity:'#16a34a', vault:'#7c3aed', qr:'#f59e0b'
        }
      }
    }
  }
</script>

<style>
  /* --- Premium look & feel --- */
  .glass-card{background:rgba(255,255,255,.75);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border:1px solid rgba(148,163,184,.3);box-shadow:0 20px 25px -5px rgba(0,0,0,.08),0 10px 10px -5px rgba(0,0,0,.04),inset 0 1px 0 rgba(255,255,255,.15)}
  .myqer-logo{font-family:system-ui,-apple-system,sans-serif;font-weight:800;font-size:1.5rem;letter-spacing:-.025em}
  .myqer-logo .myq{color:#000}.myqer-logo .er{color:#dc2626}
  .myqer-tagline{font-size:.75rem;color:#64748b;font-weight:400;margin-top:-.25rem}
  .ribbon{position:relative;padding-top:2rem;overflow:visible}
  .accolade{position:absolute;top:-.5rem;left:1rem;right:1rem;height:1rem;display:flex;align-items:center;justify-content:center;
    font-size:.625rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:#fff;z-index:20;border-radius:.25rem;
    box-shadow:0 4px 12px rgba(0,0,0,.15),inset 0 2px 0 rgba(255,255,255,.4),inset 0 -2px 0 rgba(0,0,0,.2)}
  .accolade--critical{background:linear-gradient(135deg,#dc2626 0%,#b91c1c 50%,#dc2626 100%)}
  .accolade--ice{background:linear-gradient(135deg,#ea580c 0%,#c2410c 50%,#ea580c 100%)}
  .accolade--identity{background:linear-gradient(135deg,#16a34a 0%,#15803d 50%,#16a34a 100%)}
  .accolade--vault{background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 50%,#7c3aed 100%)}
  .accolade--qr{background:linear-gradient(135deg,#f59e0b 0%,#d97706 50%,#f59e0b 100%)}
  .btn-primary{background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);color:#fff;border-radius:.5rem;padding:.625rem 1.25rem;font-weight:600;
    transition:.15s;box-shadow:0 2px 4px rgba(220,38,38,.2);border:none;cursor:pointer}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(220,38,38,.3);background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%)}
  .btn-outline{border:1.5px solid #dc2626;color:#dc2626;background:rgba(255,255,255,.9);border-radius:.5rem;padding:.5rem 1rem;font-weight:500;transition:.15s;cursor:pointer}
  .btn-outline:hover{background:rgba(220,38,38,.05);transform:translateY(-1px)}
  .btn-secondary{border:1px solid rgb(203,213,225);color:rgb(71,85,105);background:rgba(255,255,255,.9);border-radius:.5rem;padding:.5rem 1rem;font-weight:500;transition:.15s;cursor:pointer}
  .btn-secondary:hover{background:#f8fafc;border-color:#94a3b8;transform:translateY(-1px)}
  .btn-danger{background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);color:#fff;border-radius:.5rem;padding:.625rem 1.25rem;font-weight:600;transition:.15s;border:none;cursor:pointer}
  .input-field{border:1.5px solid #cbd5e1;border-radius:.5rem;padding:.625rem .875rem;transition:.15s;background:rgba(255,255,255,.9);width:100%}
  .input-field:focus{outline:none;border-color:#dc2626;box-shadow:0 0 0 3px rgba(220,38,38,.15);background:#fff}
  .qr-container{background:rgba(255,255,255,.95);border-radius:1rem;padding:1.25rem;box-shadow:0 0 0 2px #dc2626,0 0 20px rgba(220,38,38,.3),0 8px 16px rgba(220,38,38,.15);
    position:relative;display:grid;place-items:center;aspect-ratio:1/1;width:248px;height:248px}
  .offline-badge{position:absolute;top:-.5rem;right:-.5rem;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;font-size:.625rem;font-weight:700;
    padding:.25rem .5rem;border-radius:9999px;letter-spacing:.05em;box-shadow:0 2px 4px rgba(0,0,0,.2);z-index:2}
  .qr-placeholder{width:200px;height:200px;border:2px dashed #cbd5e1;border-radius:.5rem;display:flex;align-items:center;justify-content:center;color:#64748b;font-size:.875rem;text-align:center;background:rgba(248,250,252,.8)}
  .status-pill{border-radius:9999px;border:2px solid;padding:.375rem .75rem;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;box-shadow:0 2px 4px rgba(0,0,0,.1)}
  .pill-green{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-color:#22c55e;color:#16a34a}
  .pill-yellow{background:linear-gradient(135deg,#fefce8,#fde68a);border-color:#f59e0b;color:#d97706}
  .pill-red{background:linear-gradient(135deg,#fef2f2,#fee2e2);border-color:#ef4444;color:#dc2626}
  .pill-black{background:linear-gradient(135deg,#f9fafb,#f3f4f6);border-color:#111827;color:#111827}
  .toast{position:fixed;top:1.5rem;right:1.5rem;padding:1rem 1.25rem;border-radius:.75rem;color:#fff;font-weight:500;z-index:1000;transform:translateX(100%);transition:.3s;max-width:350px;box-shadow:0 10px 15px -3px rgba(0,0,0,.2)}
  .toast.show{transform:translateX(0)} .toast-success{background:linear-gradient(135deg,rgba(5,150,105,.95),rgba(4,120,87,.95))}
  .toast-warning{background:linear-gradient(135deg,rgba(217,119,6,.95),rgba(180,83,9,.95))} .toast-error{background:linear-gradient(135deg,rgba(220,38,38,.95),rgba(185,28,28,.95))}
  .loading-screen{position:fixed;inset:0;background:linear-gradient(135deg,#f8fafc,#f1f5f9);display:flex;align-items:center;justify-content:center;z-index:9999}
  .loading-spinner-large{border:4px solid #f3f4f6;border-top:4px solid #dc2626;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;margin:0 auto 1rem}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .hidden{display:none!important}
  @media(max-width:768px){.qr-container{width:200px;height:200px;padding:1rem}.glass-card{margin:.5rem}.ribbon{padding-top:1.5rem}}
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <!-- Loading -->
  <div id="loadingScreen" class="loading-screen">
    <div class="text-center">
      <div class="myqer-logo mb-2"><span class="myq">MYQ</span><span class="er">ER</span><span class="text-xs align-super text-slate-400">™</span></div>
      <div class="loading-spinner-large"></div>
      <p class="text-slate-600">Loading your emergency dashboard…</p>
    </div>
  </div>

  <!-- App -->
  <div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="glass-card border-b border-slate-200/50 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <div class="myqer-logo"><span class="myq">MYQ</span><span class="er">ER</span><span class="text-xs align-super text-slate-400">™</span></div>
            <div>
              <h1 class="text-xl font-extrabold text-slate-800">🏥 Emergency Dashboard</h1>
              <p class="myqer-tagline">pronounced “My Care”</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <select id="langSelect" class="input-field text-sm" style="width:auto">
              <option value="en">🇺🇸 English</option><option value="es">🇪🇸 Español</option>
              <option value="fr">🇫🇷 Français</option><option value="de">🇩🇪 Deutsch</option>
              <option value="it">🇮🇹 Italiano</option><option value="pt">🇵🇹 Português</option>
              <option value="ro">🇷🇴 Română</option><option value="ar">🇸🇦 العربية</option>
              <option value="hi">🇮🇳 हिन्दी</option><option value="zh">🇨🇳 中文</option>
            </select>
            <span id="userEmail" class="text-sm text-slate-600">Loading…</span>
            <button id="logoutBtn" class="btn-secondary"><span id="logoutSpinner" class="loading-spinner hidden inline-block mr-2"></span>Logout</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="pt-8 pb-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
          <!-- Main (2 cols) -->
          <div class="lg:col-span-3">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">

              <!-- Identity -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--identity">Identity</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <h2 class="text-xl font-extrabold mb-2 text-slate-800">👤 Personal Information</h2>
                  <p class="text-sm text-slate-500 mb-6">These details help responders confirm who you are.</p>
                  <form id="profileForm" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div><label class="block text-sm font-medium text-slate-700 mb-1">Full name</label>
                        <input id="fullName" name="fullName" class="input-field" placeholder="John Doe"></div>
                      <div><label class="block text-sm font-medium text-slate-700 mb-1">Date of Birth</label>
                        <input id="dateOfBirth" name="dateOfBirth" type="date" class="input-field"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div><label class="block text-sm font-medium text-slate-700 mb-1">Country</label>
                        <select id="country" name="country" class="input-field">
                          <option value="">Select country</option>
                          <option value="United States">🇺🇸 United States</option>
                          <option value="Canada">🇨🇦 Canada</option>
                          <option value="United Kingdom">🇬🇧 United Kingdom</option>
                          <option value="Australia">🇦🇺 Australia</option>
                          <option value="Germany">🇩🇪 Germany</option>
                          <option value="France">🇫🇷 France</option>
                          <option value="Spain">🇪🇸 Spain</option>
                          <option value="Italy">🇮🇹 Italy</option>
                          <option value="Portugal">🇵🇹 Portugal</option>
                          <option value="Netherlands">🇳🇱 Netherlands</option>
                          <option value="Other">🌍 Other</option>
                        </select></div>
                      <div><label class="block text-sm font-medium text-slate-700 mb-1">National ID (optional)</label>
                        <input id="nationalId" name="nationalId" class="input-field" placeholder="123-45-6789"></div>
                    </div>
                    <div class="flex justify-end pt-4 border-t border-slate-200/60">
                      <button type="submit" class="btn-primary text-sm"><span id="profileSpinner" class="loading-spinner hidden inline-block mr-2"></span>Save Profile</button>
                    </div>
                  </form>
                </div>
              </section>

              <!-- Medical -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--critical">Critical</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <h2 class="text-xl font-extrabold mb-2 text-slate-800">🩺 Medical Details</h2>
                  <p class="text-sm text-slate-500 mb-6">Keep this current. It appears on your emergency card.</p>
                  <form id="healthForm" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div><label class="block text-sm font-medium text-slate-700 mb-1">Blood type</label>
                        <select id="bloodType" name="bloodType" class="input-field">
                          <option value="">—</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                          <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                        </select></div>
                      <div><label class="block text-sm font-medium text-slate-700 mb-1">Organ donor</label>
                        <select id="organDonor" name="organDonor" class="input-field">
                          <option value="">—</option><option value="yes">Yes</option><option value="no">No</option>
                        </select></div>
                    </div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Critical allergies</label>
                      <textarea id="allergies" name="allergies" rows="2" class="input-field" placeholder="Penicillin, Nuts"></textarea></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Conditions</label>
                      <textarea id="conditions" name="conditions" rows="2" class="input-field" placeholder="Diabetes, Asthma"></textarea></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Current medications</label>
                      <textarea id="medications" name="medications" rows="2" class="input-field" placeholder="Metformin"></textarea></div>
                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Life support preference</label>
                      <select id="lifeSupportPref" name="lifeSupportPref" class="input-field">
                        <option value="">—</option>
                        <option value="Full support">All resuscitation efforts (Full)</option>
                        <option value="Comfort only">Comfort-focused care only</option>
                        <option value="DNR">Do not resuscitate (DNR)</option>
                      </select>
                      <p class="text-xs text-slate-400 mt-1">Informational only. Clinicians must verify with official documents.</p>
                    </div>
                    <div class="flex justify-end pt-4 border-t border-slate-200/60">
                      <button type="submit" class="btn-primary"><span id="healthSpinner" class="loading-spinner hidden inline-block mr-2"></span>Save Health</button>
                    </div>
                  </form>
                </div>
              </section>

              <!-- ICE -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--ice">ICE</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-extrabold text-slate-800">📞 Emergency Contacts</h2>
                    <button id="addContact" class="btn-outline text-sm">Add contact</button>
                  </div>
                  <p class="text-sm text-slate-500 mb-6">Add up to 3 trusted contacts.</p>
                  <div id="contactsList" class="space-y-4"><div class="text-slate-400 text-sm italic">No contacts yet.</div></div>
                </div>
              </section>

              <!-- Vault -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--vault">Vault</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <h2 class="text-xl font-extrabold mb-2 text-slate-800">📁 Document Vault</h2>
                  <p class="text-sm text-slate-500 mb-6">Secure, encrypted storage for critical documents.</p>
                  <div class="grid grid-cols-1 gap-3 opacity-60" title="Coming soon">
                    <div class="border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3">
                      <span style="width:.875rem;height:.875rem;border-radius:50%;display:inline-block;background:#7c3aed"></span>
                      <div><div class="font-semibold text-slate-600 text-sm">DNR Orders</div><div class="text-xs text-slate-400">Coming soon</div></div>
                    </div>
                    <div class="border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3">
                      <span style="width:.875rem;height:.875rem;border-radius:50%;display:inline-block;background:#7c3aed"></span>
                      <div><div class="font-semibold text-slate-600 text-sm">Insurance Documents</div><div class="text-xs text-slate-400">Coming soon</div></div>
                    </div>
                  </div>
                </div>
              </section>

            </div>
          </div>

          <!-- Sidebar -->
          <aside class="lg:col-span-1 space-y-6">
            <!-- Triage -->
            <section class="glass-card rounded-xl p-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-extrabold text-slate-800">🚨 Triage Status</h3>
                <span id="triageStatus" class="status-pill pill-green">GREEN</span>
              </div>
              <p class="text-sm text-slate-500 mb-4">Auto-computed from your data. You can override.</p>
              <select id="triageOverride" class="input-field mb-4">
                <option value="">Auto (recommended)</option>
                <option value="green">GREEN – Standard</option>
                <option value="yellow">AMBER – Urgent</option>
                <option value="red">RED – Critical</option>
                <option value="black">BLACK – Comfort care</option>
              </select>
              <div class="flex gap-2">
                <button id="speakBtn" class="btn-secondary flex-1 text-sm">🔊 Speak</button>
                <button id="stopSpeakBtn" class="btn-secondary text-sm">⏹ Stop</button>
              </div>
            </section>

            <!-- QR Card -->
            <section class="glass-card rounded-xl p-6 ribbon">
              <span class="accolade accolade--qr">QR Card</span>
              <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                <h3 class="text-lg font-extrabold mb-3 text-slate-800">📱 Emergency Card</h3>
                <p class="text-sm text-slate-500 mb-4">Scan for emergency access</p>

                <!-- Mode toggle (Hybrid default) -->
                <div class="mb-3">
                  <label class="block text-sm font-medium text-slate-700 mb-1">QR Mode</label>
                  <div class="grid grid-cols-3 gap-2">
                    <button id="modeHybrid" class="btn-secondary text-xs font-semibold">Hybrid</button>
                    <button id="modeOffline" class="btn-secondary text-xs">Offline-only</button>
                    <button id="modeURL" class="btn-secondary text-xs">URL-only</button>
                  </div>
                  <p class="text-xs text-slate-400 mt-2" id="modeHelp">Hybrid includes offline essentials + short link</p>
                </div>

                <div class="text-center mb-6">
                  <div id="qrContainer" class="qr-container inline-block relative">
                    <div class="offline-badge" id="qrBadge">Hybrid QR</div>
                    <div id="qrPlaceholder" class="qr-placeholder">
                      <div><div class="text-slate-400 mb-2">📋</div><div>Complete profile<br>to generate QR</div></div>
                    </div>
                    <canvas id="qrCanvas" width="200" height="200" class="hidden" style="border-radius:8px;background:#fff;border:2px solid #dc2626"></canvas>
                  </div>
                  <div class="mt-3">
                    <span class="text-sm text-slate-500">Code: </span>
                    <code id="qrCode" class="text-sm font-mono font-bold text-slate-800">—</code>
                  </div>
                  <div class="mt-2"><p class="text-xs text-green-600 font-medium" id="qrFoot">✓ Contains medical essentials + online link</p></div>
                </div>

                <!-- Generate button (only when profile has minimum fields and no code yet) -->
                <div id="generateSection" class="hidden mb-4">
                  <button id="generateCode" class="btn-primary w-full text-sm"><span id="generateSpinner" class="loading-spinner hidden inline-block mr-2"></span>🎯 Generate Emergency Code</button>
                </div>

                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Embedded data preview</label>
                    <div class="flex gap-2">
                      <input id="emergencyData" class="input-field flex-1 text-xs" readonly placeholder="Generate code to see data">
                      <button id="copyData" class="btn-secondary text-sm">Copy</button>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-3 gap-2 mt-4">
                  <button id="downloadPNG" class="btn-outline text-xs">PNG</button>
                  <button id="downloadSVG" class="btn-outline text-xs">SVG</button>
                  <button id="printCard" class="btn-outline text-xs">Print</button>
                </div>
              </div>
            </section>

            <!-- Danger Zone -->
            <section class="glass-card rounded-xl p-6 border-red-200">
              <h3 class="text-lg font-extrabold mb-3 text-red-600">⚠️ Danger Zone</h3>
              <p class="text-sm text-slate-500 mb-4">Permanently delete your account and all data.</p>
              <button id="deleteAccountBtn" class="btn-danger w-full text-sm">Delete Account</button>
            </section>
          </aside>
        </div>
      </div>
    </main>

    <footer class="glass-card border-t border-slate-200/50 mt-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid grid-cols-1 md:grid-cols-3 gap-8">
        <div><h4 class="font-bold text-slate-800 mb-3">Privacy & Security</h4>
          <p class="text-sm text-slate-600">Your medical data is encrypted and stored securely. Only you control access.</p></div>
        <div><h4 class="font-bold text-slate-800 mb-3">Medical Disclaimer</h4>
          <p class="text-sm text-slate-600">This is informational only. Emergency responders must verify all medical information.</p></div>
        <div><h4 class="font-bold text-slate-800 mb-3">Support</h4>
          <p class="text-sm text-slate-600">Need help? Contact our support team 24/7 for assistance.</p></div>
      </div>
    </footer>
  </div>

  <!-- Delete Modal -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[1000] flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-[90%] max-w-md shadow-2xl">
      <h3 class="text-xl font-bold text-red-600 mb-4">⚠️ Delete Account</h3>
      <p class="text-slate-600 mb-6">This action cannot be undone. All your emergency data, contacts, and documents will be permanently deleted.</p>
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2">Type "DELETE MY ACCOUNT" to confirm:</label>
        <input id="deleteConfirm" class="input-field" placeholder="DELETE MY ACCOUNT">
      </div>
      <div class="flex gap-3 justify-end">
        <button id="cancelDelete" class="btn-secondary">Cancel</button>
        <button id="confirmDelete" class="btn-danger" disabled><span id="deleteSpinner" class="loading-spinner hidden inline-block mr-2"></span>Delete Forever</button>
      </div>
    </div>
  </div>

<script>
/* ==============================
   Boot / Config / i18n
   ============================== */
let sb=null, isDemoMode=true;
const SUPABASE_URL='https://tgddpmxpbgrzrbzpomou.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';

try{
  if(typeof supabase!=='undefined'){ sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON); isDemoMode=false; }
}catch(e){ isDemoMode=true; }

let currentUser=isDemoMode?{id:'demo-user',email:'demo@myqer.com'}:null;
let currentLang=localStorage.getItem('myqer_lang')||'en';
const QR_MODES={HYBRID:'hybrid',OFFLINE:'offline',URL:'url'};
let qrMode=localStorage.getItem('myqer_qr_mode')||QR_MODES.HYBRID;

let userData={
  profile:{ fullName:'', dateOfBirth:'', country:'', nationalId:'', code:null },
  health:{ bloodType:'', organDonor:'', allergies:'', conditions:'', medications:'', lifeSupportPref:'', triageOverride:'' },
  contacts:[]
};

const translations={/* (same 10-language bundle as before; trimmed for brevity of comment) */};
function t(k){return (translations[currentLang]&&translations[currentLang][k])||(translations.en&&translations.en[k])||k;}

function showToast(msg,type='success'){
  const el=document.createElement('div'); el.className=`toast toast-${type}`; el.textContent=msg; document.body.appendChild(el);
  setTimeout(()=>el.classList.add('show'),80); setTimeout(()=>{el.classList.remove('show'); setTimeout(()=>el.remove(),300)},3000);
}

document.addEventListener('DOMContentLoaded',async()=>{
  setupEvents();
  await checkSession();
  setTimeout(()=>{document.getElementById('loadingScreen').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');},800);
});

/* ==============================
   Session & Data
   ============================== */
async function checkSession(){
  if(isDemoMode){
    currentUser={id:'demo-user',email:'demo@myqer.com'};
    document.getElementById('userEmail').textContent=currentUser.email;
    loadDemo(); renderAll(); showToast('Welcome to MYQER Demo!','success'); return;
  }
  try{
    const {data:{session},error}=await sb.auth.getSession();
    if(error||!session){ redirectToLogin(); return; }
    currentUser=session.user;
    document.getElementById('userEmail').textContent=currentUser.email;
    await loadFromDB(); renderAll(); showToast('Welcome back!','success');
  }catch(e){ redirectToLogin(); }
}
function redirectToLogin(){ showToast('Please login to access your dashboard','warning'); setTimeout(()=>location.replace('/'),1200); }

function loadDemo(){
  const saved=localStorage.getItem('myqer_demo_data');
  if(saved){ try{ userData=JSON.parse(saved);}catch{} }
}
function saveDemo(){ localStorage.setItem('myqer_demo_data',JSON.stringify(userData)); }

async function loadFromDB(){
  try{
    const {data:profile}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
    if(profile){
      userData.profile={ fullName:profile.full_name||'', dateOfBirth:profile.date_of_birth||'', country:profile.country||'', nationalId:profile.national_id||'', code:profile.code||null };
    }
    const {data:health}=await sb.from('health_profiles').select('*').eq('user_id',currentUser.id).single();
    if(health){
      userData.health={ bloodType:health.blood_type||'', organDonor:health.organ_donor?'yes':'', allergies:health.allergies||'', conditions:health.conditions||'', medications:health.meds||'', lifeSupportPref:health.life_support_pref||'', triageOverride:health.triage_override||'' };
    }
    const {data:contacts}=await sb.from('ice_contacts').select('*').eq('user_id',currentUser.id).order('created_at');
    userData.contacts=(contacts||[]).map(c=>({id:c.id,name:c.name||'',relation:c.relation||'',phone:c.phone||''}));
  }catch(e){ showToast('Failed to load data','warning'); }
}
async function upsertProfile(){
  if(isDemoMode){ saveDemo(); renderQR(); showToast('Profile saved (demo)','success'); return; }
  const {error}=await sb.from('profiles').upsert({ id:currentUser.id,email:currentUser.email, full_name:userData.profile.fullName, date_of_birth:userData.profile.dateOfBirth, country:userData.profile.country, national_id:userData.profile.nationalId, code:userData.profile.code });
  if(error) throw error; renderQR(); showToast('Profile saved','success');
}
async function upsertHealth(){
  if(isDemoMode){ saveDemo(); renderTriage(); renderQR(); showToast('Health saved (demo)','success'); return; }
  const {error}=await sb.from('health_profiles').upsert({ user_id:currentUser.id, blood_type:userData.health.bloodType, organ_donor:userData.health.organDonor==='yes', allergies:userData.health.allergies, conditions:userData.health.conditions, meds:userData.health.medications, life_support_pref:userData.health.lifeSupportPref, triage_override:userData.health.triageOverride });
  if(error) throw error; renderTriage(); renderQR(); showToast('Health saved','success');
}
async function saveContacts(){
  if(isDemoMode){ saveDemo(); renderQR(); showToast('Contacts saved (demo)','success'); return; }
  await sb.from('ice_contacts').delete().eq('user_id',currentUser.id);
  const rows=userData.contacts.filter(c=>c.name||c.phone).map(c=>({user_id:currentUser.id,name:c.name,relation:c.relation,phone:c.phone}));
  if(rows.length){ await sb.from('ice_contacts').insert(rows); }
  renderQR(); showToast('Contacts saved','success');
}

/* ==============================
   Helpers: triage & QR payloads
   ============================== */
function computeTriage(){
  const o=(userData.health.triageOverride||'').trim(); if(o) return o;
  const d=(userData.health.lifeSupportPref||'').toLowerCase(); if(d.includes('dnr')||d.includes('comfort')) return 'black';
  const severe=(userData.health.allergies||'').toLowerCase().includes('anaphyl')||(userData.health.conditions||'').toLowerCase().includes('severe')||(userData.health.conditions||'').toLowerCase().includes('critical');
  if(severe) return 'red';
  const has=(userData.health.conditions||userData.health.allergies||'').trim(); if(has) return 'yellow';
  return 'green';
}
function isProfileComplete(){ return !!(userData.profile.fullName && userData.profile.dateOfBirth && userData.profile.country); }
function shortURLFromCode(code){ return `https://myqer.com/c/${code}`; }

function hybridPayload(){
  if(!userData.profile.code) return '';
  const name=userData.profile.fullName||'';
  const dob=userData.profile.dateOfBirth?new Date(userData.profile.dateOfBirth).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}):'';
  const blood=userData.health.bloodType||'';
  const allergies=(userData.health.allergies||'');
  const conditions=(userData.health.conditions||'');
  const meds=(userData.health.medications||'');
  const organ=userData.health.organDonor==='yes'?'Yes':(userData.health.organDonor==='no'?'No':'');
  const firstICE=userData.contacts[0]?`${userData.contacts[0].name} (${userData.contacts[0].phone})`:'';

  const shortCon=conditions.length>80?conditions.slice(0,77)+'…':conditions;
  let shortMeds=meds; const arr=meds.split(',').map(s=>s.trim()).filter(Boolean); if(arr.length>2) shortMeds=arr.slice(0,2).join(', ')+' + more';

  const parts=[];
  if(name) parts.push(`Name: ${name}`);
  if(dob) parts.push(`DOB: ${dob}`);
  if(blood) parts.push(`Blood: ${blood}`);
  if(allergies) parts.push(`Allergies: ${allergies}`);
  if(shortCon) parts.push(`Conditions: ${shortCon}`);
  if(shortMeds) parts.push(`Meds: ${shortMeds}`);
  if(organ) parts.push(`Organ Donor: ${organ}`);
  if(firstICE) parts.push(`ICE: ${firstICE}`);
  const essentials=parts.join(' | ');
  return `${essentials} | Link: ${shortURLFromCode(userData.profile.code)}`;
}
function offlineTextPayload(){
  // Compact, no URL. Make it small but useful.
  const tri=computeTriage().toUpperCase();
  const name=userData.profile.fullName||'';
  const blood=userData.health.bloodType||'';
  const allergies=(userData.health.allergies||'').replace(/\s+/g,' ').trim();
  const meds=(userData.health.medications||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,2).join(', ');
  const ice=userData.contacts[0]?`${userData.contacts[0].name} ${userData.contacts[0].phone}`:'';
  let s=`${name ? 'Name:'+name+'|' : ''}${blood ? 'Blood:'+blood+'|' : ''}${allergies ? 'Allergies:'+allergies+'|' : ''}${meds ? 'Meds:'+meds+'|' : ''}${ice ? 'ICE:'+ice+'|' : ''}Triage:${tri}`;
  return s.replace(/\|$/,'');
}
function urlOnlyPayload(){
  return userData.profile.code ? shortURLFromCode(userData.profile.code) : '';
}

/* ==============================
   Renderers
   ============================== */
function renderProfile(){
  fullName.value=userData.profile.fullName||'';
  dateOfBirth.value=userData.profile.dateOfBirth||'';
  country.value=userData.profile.country||'';
  nationalId.value=userData.profile.nationalId||'';
  // Show "Generate" button only if profile complete and no code
  document.getElementById('generateSection').classList.toggle('hidden', !(isProfileComplete() && !userData.profile.code));
}
function renderHealth(){
  bloodType.value=userData.health.bloodType||'';
  organDonor.value=userData.health.organDonor||'';
  allergies.value=userData.health.allergies||'';
  conditions.value=userData.health.conditions||'';
  medications.value=userData.health.medications||'';
  lifeSupportPref.value=userData.health.lifeSupportPref||'';
}
function renderContacts(){
  const c=document.getElementById('contactsList');
  if(!userData.contacts.length){ c.innerHTML='<div class="text-slate-400 text-sm italic">No contacts yet.</div>'; return; }
  c.innerHTML=userData.contacts.map((ct,i)=>`
    <div class="glass-card rounded-lg p-4 border border-slate-200/40">
      <div class="grid grid-cols-1 gap-3">
        <input class="input-field" placeholder="Name" value="${ct.name||''}" data-index="${i}" data-field="name">
        <input class="input-field" placeholder="Relationship" value="${ct.relation||''}" data-index="${i}" data-field="relation">
        <div class="flex gap-2">
          <input class="input-field flex-1" placeholder="Phone" value="${ct.phone||''}" data-index="${i}" data-field="phone">
          <button class="btn-secondary px-3 py-2 text-sm hover:bg-red-50 hover:text-red-600" onclick="removeContact(${i})">🗑</button>
        </div>
      </div>
    </div>`).join('');
}
function renderTriage(){
  const level=computeTriage();
  const pill=document.getElementById('triageStatus');
  pill.className='status-pill';
  pill.classList.add(`pill-${level}`);
  pill.textContent=(level==='yellow'?'AMBER':level.toUpperCase());
  triageOverride.value=userData.health.triageOverride||'';
}
function renderQR(){
  const canvas=qrCanvas, ph=qrPlaceholder, codeEl=qrCode, dataEl=emergencyData, badge=qrBadge, foot=qrFoot;
  if(!userData.profile.code){ canvas.classList.add('hidden'); ph.classList.remove('hidden'); codeEl.textContent='—'; dataEl.value=''; return; }
  ph.classList.add('hidden'); canvas.classList.remove('hidden'); codeEl.textContent=userData.profile.code;

  let payload=''; let help='';
  if(qrMode===QR_MODES.HYBRID){ payload=hybridPayload(); badge.textContent='Hybrid QR'; help='✓ Contains medical essentials + online link'; }
  else if(qrMode===QR_MODES.OFFLINE){ payload=offlineTextPayload(); badge.textContent='Offline QR'; help='✓ Contains essentials only (no internet needed)'; }
  else { payload=urlOnlyPayload(); badge.textContent='Link QR'; help='✓ Short URL only (smallest QR)'; }
  foot.textContent=help; dataEl.value=payload;

  const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,200,200);
  try{
    QRCode.toCanvas(canvas, payload, { width:200, margin:3, errorCorrectionLevel:'M', color:{dark:'#1e293b', light:'#ffffff'} },
      err=>{ if(err){ console.error(err); showToast('QR generation failed','error'); } });
  }catch(e){ console.error(e); showToast('QR error','error'); }
}
function renderAll(){ renderProfile(); renderHealth(); renderContacts(); renderTriage(); renderQR(); }

/* ==============================
   Events
   ============================== */
function setupEvents(){
  // logout
  logoutBtn.addEventListener('click', async ()=>{
    if(!confirm('Logout now?')) return;
    logoutSpinner.classList.remove('hidden');
    try{
      if(!isDemoMode && sb){ const {error}=await sb.auth.signOut(); if(error) throw error; }
      if(isDemoMode){ localStorage.removeItem('myqer_demo_data'); }
      showToast('Logged out','success'); setTimeout(()=>location.replace('/'),800);
    }catch(e){ showToast('Logout failed','error'); } finally{ logoutSpinner.classList.add('hidden'); }
  });

  // language
  langSelect.value=currentLang;
  langSelect.addEventListener('change',e=>{ currentLang=e.target.value; localStorage.setItem('myqer_lang',currentLang); renderAll(); showToast('Language changed','success'); });

  // forms
  profileForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(profileForm);
    userData.profile.fullName=fd.get('fullName')||'';
    userData.profile.dateOfBirth=fd.get('dateOfBirth')||'';
    userData.profile.country=fd.get('country')||'';
    userData.profile.nationalId=fd.get('nationalId')||'';
    profileSpinner.classList.remove('hidden');
    try{ await upsertProfile(); }catch{ showToast('Failed to save profile','error'); } finally{ profileSpinner.classList.add('hidden'); }
  });

  healthForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(healthForm);
    userData.health.bloodType=fd.get('bloodType')||'';
    userData.health.organDonor=fd.get('organDonor')||'';
    userData.health.allergies=fd.get('allergies')||'';
    userData.health.conditions=fd.get('conditions')||'';
    userData.health.medications=fd.get('medications')||'';
    userData.health.lifeSupportPref=fd.get('lifeSupportPref')||'';
    healthSpinner.classList.remove('hidden');
    try{ await upsertHealth(); }catch{ showToast('Failed to save health','error'); } finally{ healthSpinner.classList.add('hidden'); }
  });

  // contacts
  addContact.addEventListener('click', ()=>{
    if(userData.contacts.length>=3){ showToast('Maximum 3 contacts allowed','warning'); return; }
    userData.contacts.push({name:'',relation:'',phone:''}); renderContacts();
  });
  contactsList.addEventListener('input', e=>{
    const i=e.target.dataset.index, f=e.target.dataset.field; if(i===undefined||!f) return;
    userData.contacts[+i][f]=e.target.value; clearTimeout(contactsList._t); contactsList._t=setTimeout(saveContacts,700);
  });
  window.removeContact=async (i)=>{ if(confirm('Delete this contact?')){ userData.contacts.splice(i,1); renderContacts(); await saveContacts(); showToast('Contact removed','success'); } };

  // triage
  triageOverride.addEventListener('change', async e=>{ userData.health.triageOverride=e.target.value; renderTriage(); await upsertHealth(); });

  // voice
  speakBtn.addEventListener('click', ()=>{
    if(!('speechSynthesis' in window)){ showToast('Speech not supported','warning'); return; }
    speechSynthesis.cancel();
    let text='';
    if(qrMode===QR_MODES.OFFLINE || qrMode===QR_MODES.HYBRID){ text=(qrMode===QR_MODES.OFFLINE?offlineTextPayload():hybridPayload()).replace(/\|/g,'. ').replace(/Link: .+$/,'Full details available online.'); }
    else{
      const tri=computeTriage().toUpperCase();
      text=`Emergency summary for ${userData.profile.fullName||'Unknown'}. Triage ${tri}.`;
    }
    const u=new SpeechSynthesisUtterance(text); u.rate=.8; u.pitch=1.1; u.lang='en-US'; speechSynthesis.speak(u); showToast('Speaking emergency summary','success');
  });
  stopSpeakBtn.addEventListener('click', ()=>{ if('speechSynthesis' in window){ speechSynthesis.cancel(); showToast('Speech stopped','success'); } });

  // code generate (7 base36 chars -> small QR)
  generateCode.addEventListener('click', async ()=>{
    if(!isProfileComplete()){ showToast('Complete your profile first','warning'); return; }
    if(userData.profile.code){ showToast('Code already exists','warning'); return; }
    generateSpinner.classList.remove('hidden');
    try{
      const rand=Math.random().toString(36).slice(2,9).toUpperCase();
      userData.profile.code='MYQER-'+rand;
      await upsertProfile(); renderProfile(); renderQR();
      showToast('Emergency code generated','success');
    }catch(e){ showToast('Failed to generate code','error'); }
    finally{ generateSpinner.classList.add('hidden'); }
  });

  // QR actions
  copyData.addEventListener('click', async ()=>{
    const txt=qrMode===QR_MODES.HYBRID?hybridPayload():qrMode===QR_MODES.OFFLINE?offlineTextPayload():urlOnlyPayload();
    if(!txt){ showToast('Nothing to copy','warning'); return; }
    try{ await navigator.clipboard.writeText(txt); showToast('Copied','success'); }catch{ showToast('Copy failed','error'); }
  });
  downloadPNG.addEventListener('click', ()=>{
    if(!userData.profile.code){ showToast('Generate a code first','warning'); return; }
    const link=document.createElement('a'); link.download=`myqer-${userData.profile.code}.png`; link.href=qrCanvas.toDataURL('image/png'); link.click(); showToast('PNG downloaded','success');
  });
  downloadSVG.addEventListener('click', ()=>{
    if(!userData.profile.code){ showToast('Generate a code first','warning'); return; }
    const png=qrCanvas.toDataURL('image/png'); const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="white"/><image href="${png}" x="0" y="0" width="512" height="512"/></svg>`;
    const blob=new Blob([svg],{type:'image/svg+xml'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`myqer-${userData.profile.code}.svg`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1200); showToast('SVG downloaded','success');
  });
  printCard.addEventListener('click', ()=>{
    if(!userData.profile.code){ showToast('Generate a code first','warning'); return; }
    const w=window.open('','_blank','width=420,height=620'); const img=qrCanvas.toDataURL(); const code=userData.profile.code; const name=userData.profile.fullName||'Emergency Card';
    const tri=computeTriage().toUpperCase(); const triColor={GREEN:'#16a34a',YELLOW:'#f59e0b',AMBER:'#f59e0b',RED:'#ef4444',BLACK:'#111827'}[tri]||'#16a34a';
    w.document.write(`<html><head><title>MYQER™ Emergency Card - ${name}</title>
      <style>
        @media print{body{margin:0}.card{box-shadow:none!important;border:2px solid #dc2626!important;page-break-inside:avoid}.qr{width:240px!important;height:240px!important}}
        body{font-family:system-ui,-apple-system,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:linear-gradient(135deg,#f8fafc,#f1f5f9)}
        .card{background:#fff;backdrop-filter:blur(12px);padding:32px;border-radius:20px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);border:2px solid #dc2626;max-width:340px;text-align:center}
        .logo{font-weight:800;font-size:2rem;margin-bottom:4px}.myq{color:#000}.er{color:#dc2626}.tm{font-size:.75rem;color:#64748b;vertical-align:super;margin-left:2px}
        .qr{width:240px;height:240px;border:2px solid #dc2626;border-radius:12px;margin:12px auto}
        .code{font-family:monospace;font-weight:700;color:#1e293b;background:#f1f5f9;border-radius:8px;padding:8px 12px;margin-top:8px;display:inline-block}
        .tri{font-weight:700;color:${triColor};background:rgba(${triColor==='#16a34a'?'22,163,74':triColor==='#f59e0b'?'245,158,11':triColor==='#ef4444'?'239,68,68':'17,24,39'},.1);padding:6px 12px;border-radius:20px;display:inline-block;margin:8px 0}
      </style></head><body>
      <div class="card">
        <div class="logo"><span class="myq">MYQ</span><span class="er">ER</span><span class="tm">™</span></div>
        <div>🚨 EMERGENCY MEDICAL CARD</div>
        <div class="tri">TRIAGE: ${tri}</div>
        <img class="qr" src="${img}" alt="QR">
        <div class="code">${code}</div>
      </div>
      </body></html>`);
    w.document.close(); w.focus(); setTimeout(()=>w.print(),400);
  });

  // delete
  deleteAccountBtn.addEventListener('click',()=>deleteModal.classList.remove('hidden'));
  cancelDelete.addEventListener('click',()=>{ deleteModal.classList.add('hidden'); deleteConfirm.value=''; });
  deleteConfirm.addEventListener('input',e=>confirmDelete.disabled=(e.target.value!=='DELETE MY ACCOUNT'));
  confirmDelete.addEventListener('click', async ()=>{
    if(!confirm('Are you absolutely sure?')) return;
    deleteSpinner.classList.remove('hidden');
    try{
      if(isDemoMode){ localStorage.removeItem('myqer_demo_data'); showToast('Demo account cleared','success'); }
      else{
        await Promise.all([ sb.from('ice_contacts').delete().eq('user_id',currentUser.id),
                            sb.from('health_profiles').delete().eq('user_id',currentUser.id),
                            sb.from('profiles').delete().eq('id',currentUser.id) ]);
        const {error}=await sb.auth.signOut(); if(error) throw error;
      }
      setTimeout(()=>location.replace('/'),900);
    }catch(e){ showToast('Delete failed','error'); }
    finally{ deleteSpinner.classList.add('hidden'); }
  });

  // QR mode buttons
  function setMode(m){
    qrMode=m; localStorage.setItem('myqer_qr_mode',m);
    modeHybrid.classList.toggle('btn-secondary',m!==QR_MODES.HYBRID);
    modeHybrid.classList.toggle('btn-primary',m===QR_MODES.HYBRID);
    modeOffline.classList.toggle('btn-secondary',m!==QR_MODES.OFFLINE);
    modeOffline.classList.toggle('btn-primary',m===QR_MODES.OFFLINE);
    modeURL.classList.toggle('btn-secondary',m!==QR_MODES.URL);
    modeURL.classList.toggle('btn-primary',m===QR_MODES.URL);
    const help=m===QR_MODES.HYBRID?'Hybrid includes offline essentials + short link':m===QR_MODES.OFFLINE?'Offline shows essentials only (no internet needed)':'URL-only makes the smallest QR (needs internet)';
    document.getElementById('modeHelp').textContent=help;
    renderQR();
  }
  modeHybrid.addEventListener('click',()=>setMode(QR_MODES.HYBRID));
  modeOffline.addEventListener('click',()=>setMode(QR_MODES.OFFLINE));
  modeURL.addEventListener('click',()=>setMode(QR_MODES.URL));
  // initialize mode appearance
  (function(){ const m=qrMode; qrMode=null; setMode(m||QR_MODES.HYBRID) })();
}

/* expose removeContact */
window.removeContact=idx=>{};
</script>

<!-- Cloudflare challenge noise that was in your previous pages; safe to keep or remove -->
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'dash',t:'now'};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
