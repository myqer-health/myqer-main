<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MYQER Emergency Dashboard</title>

<!-- Fonts / Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- Supabase SDK (v2) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- QRCode -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  :root{
    --ink:#0F172A;--slate-100:#F1F5F9;--slate-200:#E2E8F0;--slate-500:#64748B;
    --red:#DC2626;--red-600:#B91C1C;--amber:#D97706;--green:#059669;--rose:#E11D48;
    --glass:rgba(255,255,255,.92);--border:rgba(15,23,42,.08);--shadow:0 20px 40px rgba(2,8,23,.1);
    --r:16px;--space:20px;--w:1100px;
  }
  *{box-sizing:border-box} body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,#F8FAFC,#E2E8F0);
    color:var(--ink);margin:0}
  header{position:sticky;top:0;background:var(--glass);backdrop-filter:blur(14px);border-bottom:1px solid var(--border)}
  .wrap{max-width:var(--w);margin:auto;padding:14px 18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--red),var(--red-600));
    color:#fff;font-weight:800;display:grid;place-items:center}
  .bar{display:flex;justify-content:space-between;align-items:center}
  .logout{border:2px solid var(--slate-200);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .logout:hover{background:var(--red);border-color:var(--red);color:#fff}

  main{padding:24px 0}
  .card{width:100%;background:var(--glass);border:1px solid var(--border);border-radius:24px;box-shadow:var(--shadow);
        padding:28px;margin:0 auto 26px;max-width:var(--w);position:relative;overflow:hidden}
  .card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:linear-gradient(180deg,var(--green),#047857)}
  .critical::before{background:linear-gradient(180deg,var(--red),var(--red-600))}
  .ice::before{background:linear-gradient(180deg,var(--amber),#B45309)}
  .qr::before{background:linear-gradient(180deg,var(--rose),#BE185D)}
  .delete::before{background:linear-gradient(180deg,var(--red),#991B1B)}
  .card h2{margin:0 0 6px;font-size:22px}
  .muted{color:var(--slate-500);font-size:14px;margin:0 0 18px}

  .grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:18px}
  .full{grid-column:1/-1}
  label{font-size:12px;text-transform:uppercase;font-weight:600;color:#334155}
  input,select,textarea{width:100%;padding:12px 14px;border:2px solid var(--slate-200);border-radius:12px;font-size:15px}
  textarea{min-height:110px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--red)}
  .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}
  .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;display:flex;gap:8px;align-items:center}
  .primary{background:linear-gradient(135deg,var(--green),#047857);color:#fff}
  .warn{background:linear-gradient(135deg,var(--red),var(--red-600));color:#fff}
  .secondary{background:#fff;border:2px solid var(--slate-200)}
  .chip{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:700;font-size:12px}
  .chip.green{background:var(--green);color:#fff}.chip.amber{background:var(--amber);color:#fff}
  .chip.red{background:var(--red);color:#fff}.chip.black{background:#111827;color:#fff}

  .qrbox{background:#fff;border-radius:16px;padding:22px;display:grid;gap:10px;place-items:center;border:1px solid var(--slate-200)}
  .qr-url{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--slate-100);padding:10px;border-radius:8px;width:100%;
          display:flex;justify-content:space-between;gap:10px;align-items:center}
  .qr-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  .toast{position:fixed;top:18px;right:18px;background:#fff;border-left:5px solid var(--green);box-shadow:var(--shadow);
         padding:12px 14px;border-radius:12px;display:none;z-index:9999}
  .toast.show{display:flex;gap:8px;align-items:center}
  .offline{position:fixed;left:0;right:0;top:0;background:var(--amber);color:#fff;text-align:center;padding:8px;display:none;z-index:9998}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="offline" id="offlineBanner">You're offline. Changes will sync when you reconnect.</div>

<header>
  <div class="wrap bar">
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <div style="font-weight:800">MYQER Emergency Dashboard</div>
        <div id="userEmail" class="muted">Loading…</div>
      </div>
    </div>
    <button id="btnSignOut" class="logout"><i class="fa fa-right-from-bracket"></i> Logout</button>
  </div>
</header>

<main>
  <!-- Identity -->
  <section class="card">
    <h2>Identity — Personal Information</h2>
    <p class="muted">Complete your personal information for emergency response</p>
    <form id="identityForm" class="grid">
      <div>
        <label>First Name</label>
        <input id="firstName" required placeholder="First name">
      </div>
      <div>
        <label>Last Name</label>
        <input id="lastName" required placeholder="Last name">
      </div>
      <div>
        <label>Date of Birth</label>
        <input id="dob" type="date">
      </div>
      <div>
        <label>Phone Number</label>
        <input id="phone" type="tel" placeholder="e.g. +44 7777 777777">
      </div>
      <div>
        <label>Country</label>
        <select id="country">
          <option value="">Select country</option>
          <option value="GB">United Kingdom</option>
          <option value="US">United States</option>
          <option value="FR">France</option>
          <option value="ES">Spain</option>
          <option value="DE">Germany</option>
          <!-- …add as needed -->
        </select>
      </div>
      <div>
        <label>Emergency Contact</label>
        <input id="emergencyContact" placeholder="Contact name / number">
      </div>
      <div class="full">
        <label>Medical/National ID (optional)</label>
        <input id="medicalId" placeholder="ID">
      </div>
      <div class="actions full">
        <button type="button" id="resetIdentity" class="btn secondary"><i class="fa fa-rotate-left"></i> Reset</button>
        <button type="submit" class="btn primary"><i class="fa fa-floppy-disk"></i> Save Information</button>
      </div>
    </form>
  </section>

  <!-- Health -->
  <section class="card critical">
    <h2>CRITICAL — Medical & Health Details</h2>
    <p class="muted">Essential medical information for emergency responders</p>
    <div class="muted" style="margin-bottom:10px">Triage: <span id="triageChip" class="chip green">GREEN</span></div>
    <form id="healthForm" class="grid">
      <div>
        <label>Blood Type</label>
        <select id="bloodType">
          <option value="">Select</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
        </select>
      </div>
      <div>
        <label>Organ Donor</label>
        <select id="organDonor">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
      <div class="full">
        <label>Critical Allergies</label>
        <textarea id="allergies" placeholder="e.g., Penicillin, Nuts, Shellfish, Latex"></textarea>
      </div>
      <div class="full">
        <label>Medical Conditions</label>
        <textarea id="conditions" placeholder="e.g., Diabetes Type 2, Hypertension, Epilepsy"></textarea>
      </div>
      <div class="full">
        <label>Current Medications</label>
        <textarea id="medications" placeholder="Name, dose, frequency"></textarea>
      </div>
      <div class="full">
        <label>Implants/Devices</label>
        <textarea id="implants" placeholder="e.g., Pacemaker, Stent, Insulin pump"></textarea>
      </div>
      <div class="actions full">
        <button type="submit" class="btn warn"><i class="fa fa-floppy-disk"></i> Save Health Data</button>
      </div>
    </form>
  </section>

  <!-- ICE -->
  <section class="card ice">
    <h2>ICE — Emergency Contacts</h2>
    <p class="muted">Up to three contacts</p>
    <div id="iceList" class="grid"></div>
    <div class="actions">
      <button id="addIce" class="btn secondary"><i class="fa fa-plus"></i> Add Contact</button>
      <button id="saveIce" class="btn primary"><i class="fa fa-floppy-disk"></i> Save Contacts</button>
    </div>
  </section>

  <!-- QR -->
  <section class="card qr">
    <h2>QR — Emergency Access Code</h2>
    <p class="muted">Share this QR for instant access</p>
    <div class="qrbox">
      <canvas id="qrCanvas" width="260" height="260"></canvas>
      <div id="qrCodeText" class="muted" style="font-weight:800;letter-spacing:.15em">------</div>
      <div class="qr-url">
        <span id="qrUrl">Loading…</span>
        <span>
          <button id="copyUrl" class="btn secondary" style="padding:8px 10px"><i class="fa fa-copy"></i></button>
          <button id="openUrl" class="btn secondary" style="padding:8px 10px"><i class="fa fa-up-right-from-square"></i></button>
        </span>
      </div>
    </div>
    <div class="qr-actions">
      <button id="regenQr" class="btn" style="background:linear-gradient(135deg,var(--rose),#BE185D);color:#fff"><i class="fa fa-rotate"></i> Regenerate QR</button>
      <button id="dlPng" class="btn secondary"><i class="fa fa-download"></i> Download PNG</button>
      <button id="dlSvg" class="btn secondary"><i class="fa fa-download"></i> Download SVG</button>
      <button id="printQr" class="btn secondary"><i class="fa fa-print"></i> Print</button>
    </div>
  </section>

  <!-- Delete -->
  <section class="card delete">
    <h2>Delete Account</h2>
    <p class="muted">This action removes all your data permanently.</p>
    <div class="grid">
      <div class="full">
        <label>Type: DELETE MY ACCOUNT</label>
        <input id="confirmDelete" placeholder="DELETE MY ACCOUNT">
      </div>
      <div class="actions full">
        <button id="deleteAccount" class="btn warn" disabled><i class="fa fa-trash"></i> Delete My Account</button>
      </div>
    </div>
  </section>
</main>

<div class="toast" id="toast"><i class="fa fa-circle-check"></i><span id="toastMsg">Saved</span></div>

<script>
/* ----------------- CONFIG ----------------- */
const SUPABASE_URL = "https://dmntmhkncldgynufajei.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true, autoRefreshToken:true} });

/* ----------------- STATE ----------------- */
let user=null, userCode=null;
let ice = []; // {name,relationship,phone,order}

/* ----------------- UTILS ----------------- */
const $ = (id)=>document.getElementById(id);
function toast(msg, ok=true){ const t=$("toast"); $("toastMsg").textContent=msg; t.style.borderLeftColor = ok? "#059669":"#DC2626"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2000); }
function onlineChanged(){ $("offlineBanner").style.display = navigator.onLine ? "none" : "block"; }
window.addEventListener('online', onlineChanged); window.addEventListener('offline', onlineChanged);

/* ----------------- AUTH ----------------- */
async function guard(){
  const { data, error } = await supabase.auth.getSession();
  if (error || !data?.session){ location.replace("index.html"); return; }
  user = data.session.user; $("userEmail").textContent = user.email || "Signed in";
}
supabase.auth.onAuthStateChange((_e, s)=>{ if(!s){ try{localStorage.clear();sessionStorage.clear();}catch{} location.replace("index.html"); }});

$("btnSignOut").addEventListener("click", async ()=>{
  await supabase.auth.signOut().catch(()=>{});
  try{localStorage.clear();sessionStorage.clear();}catch{}
  location.replace("index.html");
});

/* ----------------- RPC HELPERS ----------------- */
/* You must create these SQL functions exactly as in the SQL section below:
   - get_or_set_code() -> text
   - get_profile() -> setof profiles
   - save_profile(jsonb) -> void
   - get_health() -> setof health
   - save_health(jsonb) -> void
   - get_ice_contacts() -> setof ice_contacts
   - save_ice_contacts(jsonb) -> void
   - delete_account() -> void
*/

async function ensureCode(){
  try{
    if(navigator.onLine){
      const { data, error } = await supabase.rpc("get_or_set_code");
      if(error) throw error;
      userCode = data;
      localStorage.setItem("myqer_code", userCode);
    }else{
      userCode = localStorage.getItem("myqer_code") || tempCode();
      localStorage.setItem("myqer_code", userCode);
    }
  }catch(e){
    userCode = localStorage.getItem("myqer_code") || tempCode();
  }
  drawQR();
}
function tempCode(){ return Array.from({length:6},()=> "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[Math.floor(Math.random()*32)]).join(""); }

/* ----------------- PROFILE ----------------- */
function profileFromForm(){
  return {
    first_name: $("firstName").value.trim(),
    last_name: $("lastName").value.trim(),
    dob: $("dob").value || null,
    phone: $("phone").value.trim() || null,
    country: $("country").value || null,
    emergency_contact: $("emergencyContact").value.trim() || null,
    medical_id: $("medicalId").value.trim() || null
  };
}
function fillProfile(p){
  if(!p) return;
  $("firstName").value = p.first_name || "";
  $("lastName").value = p.last_name || "";
  $("dob").value = p.dob || "";
  $("phone").value = p.phone || "";
  $("country").value = p.country || "";
  $("emergencyContact").value = p.emergency_contact || "";
  $("medicalId").value = p.medical_id || "";
}
async function loadProfile(){
  let p=null;
  if(navigator.onLine){
    try{ const {data} = await supabase.rpc("get_profile"); if(data?.length) p=data[0]; }catch{}
    if(p) localStorage.setItem("myqer_profile", JSON.stringify(p));
  }
  if(!p){ const s=localStorage.getItem("myqer_profile"); if(s) p=JSON.parse(s); }
  fillProfile(p);
}
$("identityForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const p = profileFromForm();
  try{
    if(navigator.onLine){ await supabase.rpc("save_profile",{profile_data:p}); localStorage.setItem("myqer_profile", JSON.stringify(p)); toast("Profile saved"); }
    else{ localStorage.setItem("myqer_profile", JSON.stringify(p)); toast("Saved locally (offline)", true); }
  }catch{ toast("Failed to save profile", false); }
});
$("resetIdentity").addEventListener("click", loadProfile);

/* ----------------- HEALTH ----------------- */
function triageAuto(){
  const txt = [$("allergies").value,$("conditions").value,$("medications").value,$("implants").value].join(" ").toLowerCase();
  const hard = ["anaphylaxis","shock","heart attack","myocardial infarction","stroke","status epilepticus","respiratory failure","airway compromise","dialysis","transplant","pacemaker","defibrillator","anticoagulant","hemophilia","oxygen dependent","malignant","metastatic","chemo","insulin pump"];
  if(hard.some(k=>txt.includes(k))) return "red";
  if(txt.trim()) return "amber";
  return "green";
}
function setTriage(){
  const chip=$("triageChip"); const lvl=triageAuto();
  chip.className = "chip " + (lvl==="green"?"green":lvl==="amber"?"amber":lvl==="red"?"red":"black");
  chip.textContent = lvl.toUpperCase();
}
function healthFromForm(){
  return {
    blood_type: $("bloodType").value || null,
    organ_donor: $("organDonor").value === "yes",
    allergies: $("allergies").value.trim() || null,
    conditions: $("conditions").value.trim() || null,
    medications: $("medications").value.trim() || null,
    implants: $("implants").value.trim() || null
  };
}
function fillHealth(h){
  if(!h) return;
  $("bloodType").value = h.blood_type || "";
  $("organDonor").value = h.organ_donor ? "yes":"no";
  $("allergies").value = h.allergies || "";
  $("conditions").value = h.conditions || "";
  $("medications").value = h.medications || "";
  $("implants").value = h.implants || "";
  setTriage();
}
async function loadHealth(){
  let h=null;
  if(navigator.onLine){
    try{ const {data}=await supabase.rpc("get_health"); if(data?.length) h=data[0]; }catch{}
    if(h) localStorage.setItem("myqer_health", JSON.stringify(h));
  }
  if(!h){ const s=localStorage.getItem("myqer_health"); if(s) h=JSON.parse(s); }
  fillHealth(h);
}
["bloodType","organDonor","allergies","conditions","medications","implants"].forEach(id=>{
  $(id).addEventListener("input", setTriage);
});
$("healthForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const h = healthFromForm();
  try{
    if(navigator.onLine){ await supabase.rpc("save_health",{health_data:h}); localStorage.setItem("myqer_health", JSON.stringify(h)); toast("Health saved"); }
    else{ localStorage.setItem("myqer_health", JSON.stringify(h)); toast("Saved locally (offline)"); }
    setTriage();
  }catch{ toast("Failed to save health", false); }
});

/* ----------------- ICE ----------------- */
function renderICE(){
  const box=$("iceList"); box.innerHTML="";
  ice.forEach((c,i)=>{
    const wrap=document.createElement("div");
    wrap.innerHTML=`
      <label>Contact ${i+1}</label>
      <input id="n${i}" placeholder="Full name" value="${c.name||""}" />
      <input id="r${i}" placeholder="Relationship" value="${c.relationship||""}" />
      <input id="p${i}" placeholder="Phone" value="${c.phone||""}" />
      <div class="actions"><button class="btn secondary" id="rm${i}"><i class="fa fa-xmark"></i> Remove</button></div>
    `;
    wrap.className="full";
    box.appendChild(wrap);
    $("rm"+i).onclick=()=>{ ice.splice(i,1); renderICE(); };
    $("n"+i).oninput=(e)=>ice[i].name=e.target.value;
    $("r"+i).oninput=(e)=>ice[i].relationship=e.target.value;
    $("p"+i).oninput=(e)=>ice[i].phone=e.target.value;
  });
}
$("addIce").addEventListener("click", ()=>{
  if(ice.length>=3){ toast("Max 3 contacts", false); return; }
  ice.push({name:"",relationship:"",phone:"",order:ice.length+1}); renderICE();
});
$("saveIce").addEventListener("click", async ()=>{
  const filtered = ice.filter(c=> (c.name||c.relationship||c.phone) );
  try{
    if(navigator.onLine){ await supabase.rpc("save_ice_contacts",{contacts_data:filtered}); localStorage.setItem("myqer_ice", JSON.stringify(filtered)); toast("ICE saved"); }
    else{ localStorage.setItem("myqer_ice", JSON.stringify(filtered)); toast("Saved locally (offline)"); }
  }catch{ toast("Failed to save ICE", false); }
});
async function loadICE(){
  let data=null;
  if(navigator.onLine){
    try{ const {data:d}=await supabase.rpc("get_ice_contacts"); data=d; }catch{}
    if(data) localStorage.setItem("myqer_ice", JSON.stringify(data));
  }
  if(!data){ const s=localStorage.getItem("myqer_ice"); if(s) data=JSON.parse(s); }
  ice = Array.isArray(data)? data : [];
  renderICE();
}

/* ----------------- QR ----------------- */
function drawQR(){
  if(!userCode) return;
  const url = `https://www.myqer.com/c/${userCode}`;
  $("qrCodeText").textContent = userCode;
  $("qrUrl").textContent = url;
  QRCode.toCanvas($("qrCanvas"), url, { width:260, margin:2, color:{dark:"#0F172A",light:"#FFFFFF"} }, ()=>{});
}
$("regenQr").addEventListener("click", drawQR);
$("copyUrl").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText($("qrUrl").textContent); toast("URL copied"); }catch{ toast("Copy failed", false); }
});
$("openUrl").addEventListener("click", ()=> window.open($("qrUrl").textContent,"_blank"));
$("dlPng").addEventListener("click", async ()=>{
  const url=$("qrUrl").textContent;
  const canvas = await QRCode.toCanvas(url,{width:400,margin:2,color:{dark:"#0F172A",light:"#FFFFFF"}});
  const a=document.createElement("a"); a.download=`myqer-${userCode}.png`; a.href=canvas.toDataURL(); a.click();
});
$("dlSvg").addEventListener("click", async ()=>{
  const url=$("qrUrl").textContent;
  const svg=await QRCode.toString(url,{type:"svg",width:400,margin:2,color:{dark:"#0F172A",light:"#FFFFFF"}});
  const blob=new Blob([svg],{type:"image/svg+xml"}); const a=document.createElement("a");
  a.download=`myqer-${userCode}.svg`; a.href=URL.createObjectURL(blob); a.click();
});
$("printQr").addEventListener("click", ()=>{
  const url=$("qrUrl").textContent;
  const w=window.open("","_blank");
  w.document.write(`<html><head><title>QR ${userCode}</title></head><body style="font-family:Inter;padding:24px;text-align:center">
    <h2>MYQER Emergency QR</h2><canvas id="c" width="300" height="300"></canvas>
    <div style="font-family:monospace;margin:10px 0;font-weight:800">${userCode}</div>
    <div style="font-family:monospace">${url}</div>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"><\/script>
    <script>QRCode.toCanvas(document.getElementById('c'),'${url}',{width:300,margin:2},()=>{window.print();window.close();});<\/script>
  </body></html>`);
  w.document.close();
});

/* ----------------- DELETE ----------------- */
$("confirmDelete").addEventListener("input",(e)=>{ $("deleteAccount").disabled = e.target.value!=="DELETE MY ACCOUNT"; });
$("deleteAccount").addEventListener("click", async ()=>{
  try{ if(navigator.onLine){ await supabase.rpc("delete_account"); } }catch{}
  try{ await supabase.auth.signOut(); }catch{}
  try{ localStorage.clear(); sessionStorage.clear(); }catch{}
  toast("Account deleted"); setTimeout(()=>location.replace("index.html"),700);
});

/* ----------------- BOOT ----------------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  onlineChanged();
  await guard();
  await ensureCode();
  await Promise.all([loadProfile(), loadHealth(), loadICE()]);
});
</script>
  <script>
/* ---- MYQER Debug Bootstrap (temporary) ---- */
(function () {
  // 1) Global error trap so nothing fails silently
  window.addEventListener('error', (e) => {
    console.error('💥 JS error:', e.message, e.error);
    alert('JS error: ' + e.message);
  });

  // 2) Force init once DOM is ready
  document.addEventListener('DOMContentLoaded', async () => {
    if (typeof initializeApp !== 'function') {
      alert('initializeApp() not found. Script likely stopped earlier.');
      return;
    }
    try {
      await initializeApp();
      console.log('✅ Initialized');
    } catch (err) {
      console.error('Init failed:', err);
      alert('Initialization failed: ' + (err.message || err));
      return;
    }

    // 3) Sanity: check auth session
    try {
      const { data, error } = await supabase.auth.getSession();
      if (error || !data?.session) {
        console.warn('⚠️ No session. Redirects may be preventing auth.');
        alert('Not authenticated. Please log in again.');
        return;
      }
      console.log('👤 User:', data.session.user.id);
    } catch (e) {
      console.error('Session check error:', e);
    }

    // 4) Probe profile read/write + show any RPC errors
    try {
      // READ
      const gp = await supabase.rpc('get_profile');
      if (gp.error) {
        console.error('get_profile error:', gp.error);
        alert('get_profile error: ' + gp.error.message);
      } else {
        console.log('get_profile data:', gp.data);
      }

      // If the form is filled, try a tiny write echo to verify save works.
      const f = document.getElementById('firstName');
      const l = document.getElementById('lastName');
      if (f && l && f.value && l.value) {
        const payload = {
          first_name: f.value.trim(),
          last_name: l.value.trim(),
          dob: document.getElementById('dob')?.value || null,
          phone: document.getElementById('phone')?.value || null,
          country: document.getElementById('country')?.value || null,
          emergency_contact: document.getElementById('emergencyContact')?.value || null,
          medical_id: document.getElementById('medicalId')?.value || null
        };
        const sp = await supabase.rpc('save_profile', { profile_data: payload });
        if (sp.error) {
          console.error('save_profile error:', sp.error, payload);
          alert('save_profile error: ' + sp.error.message);
        } else {
          console.log('✅ save_profile OK');
          // Read back to confirm persistence
          const gp2 = await supabase.rpc('get_profile');
          console.log('🔁 get_profile after save:', gp2.data);
          if (!gp2.error && gp2.data?.length) {
            alert('Profile saved & reloaded. If fields still look empty, UI binding is the issue, not the DB.');
          }
        }
      }
    } catch (err) {
      console.error('RPC test failed:', err);
      alert('RPC test failed: ' + (err.message || err));
    }
  });

  // 5) Monkey-patch RPC to surface future errors (optional; remove later)
  const _rpc = supabase.rpc.bind(supabase);
  supabase.rpc = async function(name, args) {
    const res = await _rpc(name, args);
    if (res?.error) console.error(`❌ RPC ${name} failed:`, res.error, { args });
    return res;
  };
})();
</script>
</body>
</html>
