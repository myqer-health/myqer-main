<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER‚Ñ¢ Dashboard - Privacy-first Emergency Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Real QR lib -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #F5F7FB 0%, #E2E8F0 100%);
            min-height: 100vh;
        }
        
        [dir="rtl"] {
            text-align: right;
        }
        
        [dir="rtl"] .card-ribbon {
            left: auto;
            right: 0;
            border-radius: 0 16px 16px 0;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 18px 40px rgba(2, 8, 23, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 50px rgba(2, 8, 23, 0.1);
        }
        
        .card-ribbon {
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: 16px 0 0 16px;
        }
        
        .ribbon-identity { background: #10B981; }
        .ribbon-health { background: #C62828; }
        .ribbon-ice { background: #F59E0B; }
        .ribbon-qr { background: #3B82F6; }
        .ribbon-triage { background: #EAB308; }
        .ribbon-danger { background: #EF4444; }
        .ribbon-vault { background: #8B5CF6; }
        .ribbon-family { background: linear-gradient(135deg, #FF6B9D, #C084FC); }
        .ribbon-coming { background: #6B7280; }
        .ribbon-silver { background: linear-gradient(135deg, #94A3B8, #64748B); }
        
        .brand-red { color: #C62828; }
        .bg-brand-red { background-color: #C62828; }
        .ink-black { color: #0F172A; }
        
        .triage-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .triage-green { background: #DCFCE7; color: #166534; }
        .triage-amber { background: #FEF3C7; color: #92400E; }
        .triage-red { background: #FEE2E2; color: #991B1B; }
        .triage-black { background: #F3F4F6; color: #374151; }
        
        .btn-primary {
            background: #C62828;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #B71C1C;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: #0F172A;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #E5E7EB;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }
        
        .disclaimer {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 8px;
            padding: 16px;
            margin: 24px 0;
        }
        
        .disclaimer-title {
            font-weight: 600;
            color: #92400E;
            margin-bottom: 8px;
        }
        
        .disclaimer-text {
            font-size: 14px;
            color: #78350F;
            line-height: 1.5;
        }
        
        input, textarea, select {
            transition: all 0.2s ease;
            min-height: 48px;
            font-size: 16px;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
            padding: 12px 16px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #C62828;
            box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
        }
        
        .pill {
            background: #F3F4F6;
            color: #374151;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 2px;
        }
        
        .pill-remove {
            cursor: pointer;
            color: #6B7280;
            font-weight: bold;
        }
        
        .pill-remove:hover {
            color: #EF4444;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateX(-50%) translateY(-20px);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { background: #10B981; color: white; }
        .toast.warning { background: #F59E0B; color: white; }
        .toast.error { background: #EF4444; color: white; }
        .toast.info { background: #3B82F6; color: white; }
        
        .qr-container {
            width: 128px;
            height: 128px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .save-indicator {
            font-size: 12px;
            color: #6B7280;
            transition: all 0.3s ease;
        }
        
        .save-indicator.saving {
            color: #F59E0B;
        }
        
        .save-indicator.saved {
            color: #10B981;
        }
        
        .save-indicator.error {
            color: #EF4444;
        }
        
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #EF4444;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        .code-display {
            background: #F8FAFC;
            border: 2px dashed #CBD5E1;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            color: #374151;
            letter-spacing: 2px;
        }
        
        .code-display.has-code {
            background: #ECFDF5;
            border-color: #10B981;
            color: #065F46;
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>
    
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        üì° Offline - Changes queued for sync
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="text-2xl font-bold text-slate-900">
                        MYQ<span class="brand-red">ER</span>‚Ñ¢
                    </div>
                    <div class="text-xs text-gray-500 hidden sm:block" data-translate="tagline">
                        Privacy-first. Works offline.
                    </div>
                </div>
                
                <div class="hidden md:block">
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600" data-translate="pronunciation">MYQER (pronounced 'my care')</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <select id="languageSelect" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="pt">Portugu√™s</option>
                        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                        <option value="zh">‰∏≠Êñá</option>
                        <option value="ro">Rom√¢nƒÉ</option>
                        <option value="hu">Magyar</option>
                    </select>
                    <button id="logoutBtn" class="btn-secondary text-sm" data-translate="logout">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Medical Disclaimer -->
    <div class="max-w-6xl mx-auto px-4 pt-6">
        <div class="disclaimer">
            <div class="disclaimer-title" data-translate="disclaimer_title">Medical Disclaimer</div>
            <div class="disclaimer-text" data-translate="disclaimer_text">
                This information is for emergency reference only and does not constitute medical advice. Healthcare professionals must independently verify all medical information and make their own clinical assessments. MYQER‚Ñ¢ is not responsible for medical decisions made based on this data.
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- Full Width Cards Section -->
        <div class="space-y-6 mb-8">
            <!-- Identity Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-identity"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2" data-translate="identity_title">Identity</h2>
                <p class="text-sm text-gray-600 mb-6" data-translate="identity_desc">These details help responders confirm who you are.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="full_name">Full Name *</label>
                        <input type="text" id="fullName" class="w-full" data-translate-placeholder="enter_full_name" placeholder="Enter your full name">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="date_of_birth">Date of Birth</label>
                        <input type="text" id="dateOfBirth" class="w-full" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" maxlength="10">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="country">Country</label>
                        <select id="country" class="w-full">
                            <option value="" data-translate="select_country">Select country</option>
                            <option value="US">United States</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="IT">Italy</option>
                            <option value="NL">Netherlands</option>
                            <option value="SE">Sweden</option>
                            <option value="NO">Norway</option>
                            <option value="DK">Denmark</option>
                            <option value="FI">Finland</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="health_id">Health ID (Optional)</label>
                        <input type="text" id="healthId" class="w-full" data-translate-placeholder="nhs_number" placeholder="NHS number, etc.">
                        <p class="text-xs text-gray-500 mt-1" data-translate="never_shown_publicly">Never shown publicly</p>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mt-6">
                    <div id="profileSaveStatus" class="save-indicator text-xs">Auto-saves as you type</div>
                    <button id="saveProfileBtn" class="btn-primary" data-translate="save_profile">Save Profile</button>
                </div>
            </div>

            <!-- Health Profile Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-health"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2" data-translate="health_profile">Health Profile</h2>
                <p class="text-sm text-gray-600 mb-6" data-translate="health_desc">Keep this current. It appears on your emergency card.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="blood_type">Blood Type</label>
                        <select id="bloodType" class="w-full">
                            <option value="‚Äî" data-translate="unknown">Unknown</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="organ_donor">Organ Donor</label>
                        <select id="organDonor" class="w-full">
                            <option value="‚Äî" data-translate="not_specified">Not specified</option>
                            <option value="Yes" data-translate="yes">Yes</option>
                            <option value="No" data-translate="no">No</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="critical_allergies">Critical Allergies</label>
                        <input type="text" id="allergiesInput" class="w-full" data-translate-placeholder="allergy_example" placeholder="Type allergy and press Enter (e.g., Penicillin, Nuts)">
                        <div id="allergiesPills" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="medical_conditions">Medical Conditions</label>
                        <input type="text" id="conditionsInput" class="w-full" data-translate-placeholder="condition_example" placeholder="Type condition and press Enter (e.g., Diabetes, Hypertension)">
                        <div id="conditionsPills" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="current_medications">Current Medications</label>
                        <input type="text" id="medicationsInput" class="w-full" data-translate-placeholder="medication_example" placeholder="Type medication and press Enter (e.g., Insulin, Aspirin)">
                        <div id="medicationsPills" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="life_support">Life Support Preference</label>
                        <select id="lifeSupportPref" class="w-full">
                            <option value="Full" data-translate="full_support">Full Life Support</option>
                            <option value="Comfort" data-translate="comfort_care">Comfort Care Only</option>
                            <option value="DNR" data-translate="dnr">Do Not Resuscitate</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="religious_pref">Religious Preference</label>
                        <select id="religionPref" class="w-full">
                            <option value="None" data-translate="none">None</option>
                            <option value="Catholic" data-translate="catholic">Catholic</option>
                            <option value="Protestant" data-translate="protestant">Protestant</option>
                            <option value="Muslim" data-translate="muslim">Muslim</option>
                            <option value="Jewish" data-translate="jewish">Jewish</option>
                            <option value="Hindu" data-translate="hindu">Hindu</option>
                            <option value="Buddhist" data-translate="buddhist">Buddhist</option>
                            <option value="Other" data-translate="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mt-6">
                    <div id="healthSaveStatus" class="save-indicator text-xs">Auto-saves as you type</div>
                    <button id="saveHealthBtn" class="btn-primary" data-translate="save_health">Save Health Profile</button>
                </div>
            </div>

            <!-- ICE Contacts Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-ice"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2" data-translate="ice_contacts">Emergency Contacts (ICE)</h2>
                <p class="text-sm text-gray-600 mb-6" data-translate="ice_desc">Add up to 3 trusted contacts.</p>
                
                <div id="iceContacts" class="space-y-4">
                    <!-- ICE contacts will be populated here -->
                </div>
                <button id="addIceContact" class="btn-secondary mt-4" data-translate="add_contact">Add Contact (0/3)</button>
            </div>
        </div>

        <!-- Three Column Grid Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Automated Triage Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-triage"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2" data-translate="auto_triage">Automated Triage</h2>
                <p class="text-sm text-gray-600 mb-4" data-translate="triage_desc">Auto-computed from your health profile.</p>
                
                <div class="text-center mb-4">
                    <div id="triageStatus" class="triage-status triage-green">
                        GREEN - Standard
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="manual_override">Manual Override</label>
                    <select id="triageOverride" class="w-full">
                        <option value="" data-translate="auto_recommended">Auto (Recommended)</option>
                        <option value="Green" data-translate="green_standard">Green - Standard</option>
                        <option value="Amber" data-translate="amber_urgent">Amber - Urgent</option>
                        <option value="Red" data-translate="red_immediate">Red - Immediate</option>
                        <option value="Black" data-translate="black_comfort">Black - Comfort</option>
                    </select>
                </div>
                
                <p class="text-xs text-gray-500 mb-4" data-translate="triage_control">You control what responders see first.</p>
                
                <div class="space-y-2">
                    <button id="speakSummaryBtn" class="btn-secondary w-full text-sm" data-translate="speak_summary">üîä Speak Summary</button>
                    <button id="stopSpeakingBtn" class="btn-secondary w-full text-sm" style="display: none;" data-translate="stop_speaking">‚èπÔ∏è Stop Speaking</button>
                </div>
            </div>

            <!-- Emergency Card & QR -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-qr"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2" data-translate="emergency_card_qr">Emergency Card & QR</h2>
                <p class="text-sm text-gray-600 mb-4" data-translate="qr_desc">Scan to view your emergency information.</p>
                
                <div class="text-center mb-4">
                    <!-- MYQER Branding -->
                    <div class="mb-3">
                        <div class="text-lg font-bold text-slate-900">
                            MYQ<span class="brand-red">ER</span>‚Ñ¢
                        </div>
                        <div class="text-xs text-gray-500" data-translate="emergency_qr_card">Emergency QR Card</div>
                    </div>
                    
                    <div id="qrContainer" class="qr-container">
                        <canvas id="qrCanvas" width="128" height="128"></canvas>
                    </div>
                    <div class="mt-2">
                        <input type="text" id="cardLink" class="w-full text-xs text-center border border-gray-300 rounded px-2 py-1" readonly data-translate-placeholder="card_link_placeholder" placeholder="Card link will appear here">
                        <button id="copyLinkBtn" class="text-xs text-blue-600 hover:text-blue-800 mt-1" data-translate="copy_link">Copy Link</button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <button id="viewCardBtn" class="btn-primary w-full" data-translate="view_emergency_card">View Emergency Card</button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="exportPngBtn" class="btn-secondary text-sm" data-translate="export_png">Export PNG</button>
                        <button id="exportSvgBtn" class="btn-secondary text-sm" data-translate="export_svg">Export SVG</button>
                    </div>
                    <button id="printCardBtn" class="btn-secondary w-full" data-translate="print_card">Print Card</button>
                    <button id="shareQrBtn" class="btn-secondary w-full" data-translate="share_qr">Share QR Code</button>
                </div>
            </div>

            <!-- Emergency Code Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-silver"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2" data-translate="emergency_code">üîê Emergency Code</h2>
                <p class="text-sm text-gray-600 mb-4" data-translate="code_desc">Your unique identifier for emergency access.</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2" data-translate="your_code">Your Emergency Code</label>
                    <div id="codeDisplay" class="code-display">
                        <span id="cardCodeDisplay">Click Generate to create</span>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <button id="generateCodeBtn" class="btn-primary w-full" data-translate="generate_new_code">üé≤ Generate New Code</button>
                    <button id="copyCodeBtn" class="btn-secondary w-full text-sm" data-translate="copy_code">üìã Copy Code</button>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-xs text-gray-500" data-translate="code_info">
                        üí° This code links to your emergency information. Keep it safe and share with trusted contacts.
                    </p>
                </div>
            </div>
        </div>

        <!-- Bottom Three Column Grid Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Document Vault Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-vault"></div>
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold ink-black" data-translate="vault_title">Document Vault</h2>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-semibold" data-translate="coming_soon">Coming Soon</span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-6" data-translate="vault_desc">Secure, client-side encrypted storage for critical documents.</p>
                
                <div class="grid grid-cols-1 gap-4">
                    <div class="document-tile">
                        <div class="text-2xl mb-2">üìã</div>
                        <h3 class="font-semibold text-gray-700" data-translate="dnr_orders">DNR Orders</h3>
                        <p class="text-xs text-gray-500 mt-1" data-translate="dnr_desc">Do Not Resuscitate documents</p>
                    </div>
                    <div class="document-tile">
                        <div class="text-2xl mb-2">üìú</div>
                        <h3 class="font-semibold text-gray-700" data-translate="living_will">Living Will</h3>
                        <p class="text-xs text-gray-500 mt-1" data-translate="living_will_desc">End-of-life care preferences</p>
                    </div>
                </div>
            </div>

            <!-- Family Care Hub Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-family"></div>
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold ink-black" data-translate="family_title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Care Hub</h2>
                        <span class="bg-pink-100 text-pink-800 px-2 py-1 rounded text-xs font-semibold" data-translate="coming_soon">Coming Soon</span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-6" data-translate="family_desc">üíù Manage emergency information for your loved ones with care and security.</p>
                
                <div class="family-card">
                    <div class="text-4xl mb-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <h3 class="font-bold text-gray-700 mb-2">Add Family Member</h3>
                    <p class="text-sm text-gray-500 mb-4">Create emergency profiles for your loved ones</p>
                    <button id="addFamilyMember" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-6 py-2 rounded-full font-semibold hover:from-pink-600 hover:to-purple-600 transition-all transform hover:scale-105" data-translate="add_family_member">‚ú® Add New Member</button>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="glass-card p-6 border-red-200">
                <div class="card-ribbon ribbon-danger"></div>
                <h2 class="text-xl font-bold text-red-600 mb-2" data-translate="danger_zone">Danger Zone</h2>
                <p class="text-sm text-gray-600 mb-4" data-translate="danger_desc">
                    This permanently deletes your account and all data.
                </p>
                <button id="deleteAccountBtn" class="w-full bg-transparent border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white px-4 py-2 rounded-lg font-semibold transition-all" data-translate="delete_account">
                    Delete My Account
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 mt-16">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="text-sm text-gray-600 mb-4 md:mb-0" data-translate="footer_text">
                    ¬© 2025 MYQER ‚Äî Emergency Response QR ¬∑ GDPR/HIPAA-minded.
                </div>
                <div class="flex gap-6 text-sm">
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors" data-translate="privacy">Privacy</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors" data-translate="terms">Terms</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors" data-translate="about">About</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors" data-translate="support">Support</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors" data-translate="contact">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ========== CONFIGURATION ==========
        const ORIGIN = "https://www.myqer.com";
        
        // ========== GLOBAL STATE ==========
        let token = localStorage.getItem("myqer_public_token") || null;
        let iceContactCount = 0;
        let pillData = {
            allergies: [],
            conditions: [],
            medications: []
        };
        let currentLanguage = localStorage.getItem('myqer_lang') || navigator.language.split('-')[0] || 'en';
        let isOffline = false;
        let currentSpeech = null;
        let db = null;

        // ========== TRANSLATIONS ==========
        const translations = {
            en: {
                tagline: "Privacy-first. Works offline.",
                pronunciation: "MYQER (pronounced 'my care')",
                logout: "Logout",
                disclaimer_title: "Medical Disclaimer",
                disclaimer_text: "This information is for emergency reference only and does not constitute medical advice. Healthcare professionals must independently verify all medical information and make their own clinical assessments. MYQER‚Ñ¢ is not responsible for medical decisions made based on this data.",
                identity_title: "Identity",
                identity_desc: "These details help responders confirm who you are.",
                full_name: "Full Name *",
                enter_full_name: "Enter your full name",
                date_of_birth: "Date of Birth",
                country: "Country",
                select_country: "Select country",
                health_id: "Health ID (Optional)",
                nhs_number: "NHS number, etc.",
                never_shown_publicly: "Never shown publicly",
                save_profile: "Save Profile",
                health_profile: "Health Profile",
                health_desc: "Keep this current. It appears on your emergency card.",
                blood_type: "Blood Type",
                unknown: "Unknown",
                organ_donor: "Organ Donor",
                not_specified: "Not specified",
                yes: "Yes",
                no: "No",
                critical_allergies: "Critical Allergies",
                allergy_example: "Type allergy and press Enter (e.g., Penicillin, Nuts)",
                medical_conditions: "Medical Conditions",
                condition_example: "Type condition and press Enter (e.g., Diabetes, Hypertension)",
                current_medications: "Current Medications",
                medication_example: "Type medication and press Enter (e.g., Insulin, Aspirin)",
                life_support: "Life Support Preference",
                full_support: "Full Life Support",
                comfort_care: "Comfort Care Only",
                dnr: "Do Not Resuscitate",
                religious_pref: "Religious Preference",
                none: "None",
                catholic: "Catholic",
                protestant: "Protestant",
                muslim: "Muslim",
                jewish: "Jewish",
                hindu: "Hindu",
                buddhist: "Buddhist",
                other: "Other",
                save_health: "Save Health Profile",
                ice_contacts: "Emergency Contacts (ICE)",
                ice_desc: "Add up to 3 trusted contacts.",
                add_contact: "Add Contact",
                auto_triage: "Automated Triage",
                triage_desc: "Auto-computed from your health profile.",
                manual_override: "Manual Override",
                auto_recommended: "Auto (Recommended)",
                green_standard: "Green - Standard",
                amber_urgent: "Amber - Urgent",
                red_immediate: "Red - Immediate",
                black_comfort: "Black - Comfort",
                triage_control: "You control what responders see first.",
                speak_summary: "Speak Summary",
                stop_speaking: "Stop Speaking",
                emergency_code: "Emergency Code",
                code_desc: "Your unique identifier for emergency access.",
                your_code: "Your Emergency Code",
                generate_new_code: "Generate New Code",
                copy_code: "Copy Code",
                code_info: "This code links to your emergency information. Keep it safe and share with trusted contacts.",
                emergency_card_qr: "Emergency Card & QR",
                emergency_qr_card: "Emergency QR Card",
                qr_desc: "Scan to view your emergency information.",
                card_link_placeholder: "Card link will appear here",
                copy_link: "Copy Link",
                view_emergency_card: "View Emergency Card",
                export_png: "Export PNG",
                export_svg: "Export SVG",
                print_card: "Print Card",
                share_qr: "Share QR Code",
                danger_zone: "Danger Zone",
                danger_desc: "This permanently deletes your account and all data.",
                delete_account: "Delete My Account",
                vault_title: "Document Vault",
                vault_desc: "Secure, client-side encrypted storage for critical documents.",
                coming_soon: "Coming Soon",
                dnr_orders: "DNR Orders",
                dnr_desc: "Do Not Resuscitate documents",
                living_will: "Living Will",
                living_will_desc: "End-of-life care preferences",
                family_title: "Family Care Hub",
                family_desc: "Manage emergency information for your loved ones with care and security.",
                add_family_member: "Add New Member",
                footer_text: "¬© 2025 MYQER ‚Äî Emergency Response QR ¬∑ GDPR/HIPAA-minded.",
                privacy: "Privacy",
                terms: "Terms",
                about: "About",
                support: "Support",
                contact: "Contact"
            }
        };

        // ========== INDEXEDDB SETUP ==========
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('MyqerDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('profile')) {
                        const profileStore = db.createObjectStore('profile', { keyPath: 'id' });
                        profileStore.createIndex('updated', 'updated', { unique: false });
                    }
                };
            });
        }

        async function saveToIndexedDB(data) {
            if (!db) return;
            
            const transaction = db.transaction(['profile'], 'readwrite');
            const store = transaction.objectStore('profile');
            
            const profileData = {
                id: 'current',
                ...data,
                updated: new Date().toISOString()
            };
            
            return store.put(profileData);
        }

        async function loadFromIndexedDB() {
            if (!db) return null;
            
            const transaction = db.transaction(['profile'], 'readonly');
            const store = transaction.objectStore('profile');
            
            return new Promise((resolve, reject) => {
                const request = store.get('current');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ========== HYBRID PAYLOAD BUILDER ==========
        function buildHybridPayload(u) {
            const name = (u.profile.fullName||"").trim();
            const dob = u.profile.dateOfBirth || "";
            const blood = u.health.bloodType || "";
            const allergies = (u.health.allergies||"").trim();
            const conditions = (u.health.conditions||"").trim();
            const meds = (u.health.medications||"").trim();
            const donor = u.health.organDonor ? `Donor: ${u.health.organDonor}` : "";
            const ice = u.contacts?.[0] ? `ICE: ${u.contacts[0].name} ${u.contacts[0].phone}` : "";
            const url = token ? `${ORIGIN}/c/${token}` : "";

            const lines = [
                `MYQER`,
                name && `Name: ${name}`,
                dob && `DOB: ${fmtDob(dob)}`,
                blood && `Blood: ${blood}`,
                allergies && `Allergies: ${trimLine(allergies, 64)}`,
                conditions && `Conditions: ${trimLine(conditions, 64)}`,
                meds && `Meds: ${trimLine(meds, 64)}`,
                donor,
                ice,
                url && `Link: ${url}`
            ].filter(Boolean);

            return lines.join("\n");
        }

        function fmtDob(d) { 
            try { 
                const dte = new Date(d); 
                return dte.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}); 
            } catch { 
                return d; 
            } 
        }

        function trimLine(s, max) { 
            return s.length > max ? s.slice(0, max-1) + "‚Ä¶" : s; 
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            setupEventListeners();
            setupPillInputs();
            setupDateInput();
            await loadUserData();
            if (!token) generateEmergencyCode();
            updateTriageStatus();
            checkOnlineStatus();
            changeLanguage(currentLanguage);
        });

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Language selector
            document.getElementById('languageSelect').addEventListener('change', (e) => {
                changeLanguage(e.target.value);
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.clear();
                    showToast('Logged out successfully', 'success');
                    window.location.href = '/';
                }
            });
            
            // Generate code button
            document.getElementById('generateCodeBtn').addEventListener('click', generateEmergencyCode);
            
            // Copy code button
            document.getElementById('copyCodeBtn').addEventListener('click', copyEmergencyCode);
            
            // Save buttons
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            document.getElementById('saveHealthBtn').addEventListener('click', saveHealthProfile);
            
            // Add ICE contact
            document.getElementById('addIceContact').addEventListener('click', addIceContact);
            
            // Triage override
            document.getElementById('triageOverride').addEventListener('change', updateTriageStatus);
            
            // Speak summary
            document.getElementById('speakSummaryBtn').addEventListener('click', speakSummary);
            document.getElementById('stopSpeakingBtn').addEventListener('click', stopSpeaking);
            
            // QR and card buttons
            document.getElementById('copyLinkBtn').addEventListener('click', copyCardLink);
            document.getElementById('viewCardBtn').addEventListener('click', viewEmergencyCard);
            document.getElementById('exportPngBtn').addEventListener('click', () => exportQR('png'));
            document.getElementById('exportSvgBtn').addEventListener('click', () => exportQR('svg'));
            document.getElementById('printCardBtn').addEventListener('click', printEmergencyCard);
            document.getElementById('shareQrBtn').addEventListener('click', shareQrCode);
            
            // Family button
            document.getElementById('addFamilyMember').addEventListener('click', () => {
                showToast('Family management coming soon!', 'warning');
            });
            
            // Delete account
            document.getElementById('deleteAccountBtn').addEventListener('click', deleteAccount);
            
            // Auto-save on input with debouncing
            const autoSaveFields = ['fullName', 'dateOfBirth', 'country', 'healthId', 'bloodType', 'organDonor', 'lifeSupportPref', 'religionPref'];
            autoSaveFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', debounce(() => {
                        autoSave();
                    }, 600));
                }
            });
        }

        // ========== AUTO-SAVE FUNCTIONALITY ==========
        async function autoSave() {
            const profileStatus = document.getElementById('profileSaveStatus');
            const healthStatus = document.getElementById('healthSaveStatus');
            
            profileStatus.textContent = 'Saving...';
            profileStatus.className = 'save-indicator saving text-xs';
            healthStatus.textContent = 'Saving...';
            healthStatus.className = 'save-indicator saving text-xs';
            
            try {
                const userData = getUserData();
                await saveToIndexedDB(userData);
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                profileStatus.textContent = `Saved ${timeStr}`;
                profileStatus.className = 'save-indicator saved text-xs';
                healthStatus.textContent = `Saved ${timeStr}`;
                healthStatus.className = 'save-indicator saved text-xs';
                
                generateQRCode();
                
                setTimeout(() => {
                    profileStatus.textContent = 'Auto-saves as you type';
                    profileStatus.className = 'save-indicator text-xs';
                    healthStatus.textContent = 'Auto-saves as you type';
                    healthStatus.className = 'save-indicator text-xs';
                }, 3000);
                
            } catch (error) {
                console.error('Auto-save failed:', error);
                profileStatus.textContent = 'Save failed';
                profileStatus.className = 'save-indicator error text-xs';
                healthStatus.textContent = 'Save failed';
                healthStatus.className = 'save-indicator error text-xs';
                showToast('Could not save', 'error');
            }
        }

        // ========== LANGUAGE MANAGEMENT ==========
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('myqer_lang', lang);
            document.getElementById('languageSelect').value = lang;
            
            if (lang === 'ar' || lang === 'he') {
                document.documentElement.dir = 'rtl';
            } else {
                document.documentElement.dir = 'ltr';
            }
            
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.dataset.translate;
                const translation = getTranslation(key);
                if (translation) {
                    element.textContent = translation;
                }
            });
            
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.dataset.translatePlaceholder;
                const translation = getTranslation(key);
                if (translation) {
                    element.placeholder = translation;
                }
            });
        }

        function getTranslation(key) {
            return translations[currentLanguage]?.[key] || translations['en'][key] || key;
        }

        // ========== PILL INPUT SETUP ==========
        function setupPillInputs() {
            const pillInputs = ['allergies', 'conditions', 'medications'];
            
            pillInputs.forEach(type => {
                const input = document.getElementById(`${type}Input`);
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && input.value.trim()) {
                            e.preventDefault();
                            addPill(type, input.value.trim());
                            input.value = '';
                        }
                    });
                }
            });
        }

        // ========== PILL MANAGEMENT ==========
        function addPill(type, value) {
            if (!value || pillData[type].includes(value)) {
                if (pillData[type].includes(value)) {
                    showToast(`"${value}" is already added`, 'warning');
                }
                return;
            }
            
            pillData[type].push(value);
            renderPills(type);
            updateTriageStatus();
            autoSave();
        }

        function removePill(type, index) {
            const removed = pillData[type][index];
            pillData[type].splice(index, 1);
            renderPills(type);
            updateTriageStatus();
            autoSave();
            showToast(`Removed ${removed}`, 'success');
        }

        function renderPills(type) {
            const container = document.getElementById(`${type}Pills`);
            if (!container) return;
            
            container.innerHTML = pillData[type].map((pill, index) => `
                <div class="pill">
                    ${pill}
                    <span class="pill-remove" onclick="removePill('${type}', ${index})">√ó</span>
                </div>
            `).join('');
        }

        // ========== ICE CONTACT MANAGEMENT ==========
        function addIceContact() {
            if (iceContactCount >= 3) {
                showToast('Maximum 3 contacts allowed', 'warning');
                return;
            }
            
            const container = document.getElementById('iceContacts');
            const contactId = `ice_${Date.now()}`;
            
            const contactDiv = document.createElement('div');
            contactDiv.className = 'border border-gray-200 rounded-lg p-4';
            contactDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" placeholder="Full name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Relationship</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" placeholder="Spouse, Parent, etc.">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Phone</label>
                        <input type="tel" class="w-full px-2 py-1 border border-gray-300 rounded" placeholder="+1234567890" required>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <button class="text-red-600 text-sm hover:text-red-800" onclick="removeIceContact('${contactId}')">
                        Remove Contact
                    </button>
                    <div class="text-xs text-gray-500">Auto-saves on blur</div>
                </div>
            `;
            
            contactDiv.dataset.contactId = contactId;
            container.appendChild(contactDiv);
            iceContactCount++;
            
            contactDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('blur', debounce(autoSave, 600));
            });
            
            updateAddButtonState();
            autoSave();
            showToast('Contact added', 'success');
        }

        function removeIceContact(contactId) {
            const contactDiv = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactDiv) {
                contactDiv.remove();
                iceContactCount--;
                updateAddButtonState();
                autoSave();
                showToast('Contact removed', 'success');
            }
        }

        function updateAddButtonState() {
            const addBtn = document.getElementById('addIceContact');
            addBtn.disabled = iceContactCount >= 3;
            addBtn.textContent = iceContactCount >= 3 ? 'Maximum reached (3/3)' : `Add Contact (${iceContactCount}/3)`;
        }

        // ========== EMERGENCY CODE & QR ==========
        function generateEmergencyCode() {
            if (!token) {
                const code = 'MYQER-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                token = code;
                localStorage.setItem("myqer_public_token", token);
                showToast('Emergency code generated', 'success');
            }
            
            document.getElementById('cardCodeDisplay').textContent = token;
            document.getElementById('codeDisplay').classList.add('has-code');
            
            updateCardLink(token);
            generateQRCode();
        }

        function copyEmergencyCode() {
            const code = document.getElementById('cardCodeDisplay').textContent;
            if (code && code !== 'Click Generate to create') {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('Emergency code copied to clipboard', 'success');
                }).catch(() => {
                    showToast('Failed to copy code', 'error');
                });
            } else {
                showToast('No code to copy. Generate one first.', 'warning');
            }
        }

        function updateCardLink(code) {
            const link = `${ORIGIN}/c/${code}`;
            document.getElementById('cardLink').value = link;
        }

        function generateQRCode() {
            if (!token) return;
            
            const canvas = document.getElementById('qrCanvas');
            const userData = getUserData();
            const hybridPayload = buildHybridPayload(userData);
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 128, 128);
            
            QRCode.toCanvas(canvas, hybridPayload, {
                width: 128,
                height: 128,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                },
                errorCorrectionLevel: 'M'
            }, function (error) {
                if (error) {
                    console.error('QR Code generation failed:', error);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, 128, 128);
                    ctx.fillStyle = '#000000';
                    ctx.font = '12px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText('QR ERROR', 64, 60);
                    ctx.font = '8px Inter';
                    ctx.fillText(token, 64, 75);
                } else {
                    console.log('QR Code generated successfully');
                }
            });
        }

        // ========== TRIAGE STATUS ==========
        function updateTriageStatus() {
            const override = document.getElementById('triageOverride').value;
            const statusElement = document.getElementById('triageStatus');
            
            if (override) {
                const statusMap = {
                    'Green': { class: 'triage-green', text: 'GREEN - Standard' },
                    'Amber': { class: 'triage-amber', text: 'AMBER - Urgent' },
                    'Red': { class: 'triage-red', text: 'RED - Immediate' },
                    'Black': { class: 'triage-black', text: 'BLACK - Comfort' }
                };
                
                const status = statusMap[override];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            } else {
                let calculatedStatus = 'Green';
                
                const lifeSupportPref = document.getElementById('lifeSupportPref').value;
                
                const criticalAllergies = ['midazolam', 'codeine', 'penicillin', 'morphine', 'fentanyl', 'aspirin'];
                const hasCriticalAllergy = pillData.allergies.some(allergy => 
                    criticalAllergies.some(critical => 
                        allergy.toLowerCase().includes(critical.toLowerCase())
                    )
                );
                
                if (lifeSupportPref === 'DNR') {
                    calculatedStatus = 'Black';
                } else if (hasCriticalAllergy || pillData.conditions.length > 3) {
                    calculatedStatus = 'Red';
                } else if (pillData.allergies.length > 0 || pillData.conditions.length > 0 || pillData.medications.length > 2) {
                    calculatedStatus = 'Amber';
                }
                
                const statusMap = {
                    'Green': { class: 'triage-green', text: 'GREEN - Standard (Auto)' },
                    'Amber': { class: 'triage-amber', text: 'AMBER - Urgent (Auto)' },
                    'Red': { class: 'triage-red', text: 'RED - Immediate (Auto)' },
                    'Black': { class: 'triage-black', text: 'BLACK - Comfort (Auto)' }
                };
                
                const status = statusMap[calculatedStatus];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            }
        }

        // ========== SPEECH FUNCTIONALITY ==========
        function speakSummary() {
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            const userData = getUserData();
            const fullName = userData.profile.fullName || 'Unknown';
            const bloodType = userData.health.bloodType || 'Unknown';
            const allergies = pillData.allergies.length > 0 ? pillData.allergies.join(', ') : 'None';
            const conditions = pillData.conditions.length > 0 ? pillData.conditions.join(', ') : 'None';
            
            const summary = `Emergency summary for ${fullName}. Blood type: ${bloodType}. Allergies: ${allergies}. Medical conditions: ${conditions}.`;
            
            if ('speechSynthesis' in window) {
                currentSpeech = new SpeechSynthesisUtterance(summary);
                
                currentSpeech.lang = currentLanguage === 'en' ? 'en-US' : 
                                   currentLanguage === 'es' ? 'es-ES' :
                                   currentLanguage === 'fr' ? 'fr-FR' :
                                   currentLanguage === 'de' ? 'de-DE' :
                                   currentLanguage === 'it' ? 'it-IT' :
                                   'en-US';
                
                currentSpeech.onstart = () => {
                    document.getElementById('speakSummaryBtn').style.display = 'none';
                    document.getElementById('stopSpeakingBtn').style.display = 'block';
                };
                
                currentSpeech.onend = () => {
                    document.getElementById('speakSummaryBtn').style.display = 'block';
                    document.getElementById('stopSpeakingBtn').style.display = 'none';
                    currentSpeech = null;
                };
                
                speechSynthesis.speak(currentSpeech);
                showToast('Speaking summary...', 'info');
            } else {
                showToast('Speech synthesis not supported', 'error');
            }
        }

        function stopSpeaking() {
            if (currentSpeech) {
                speechSynthesis.cancel();
                document.getElementById('speakSummaryBtn').style.display = 'block';
                document.getElementById('stopSpeakingBtn').style.display = 'none';
                currentSpeech = null;
                showToast('Speech stopped', 'info');
            }
        }

        // ========== DATA MANAGEMENT ==========
        function getUserData() {
            const contacts = [];
            document.querySelectorAll('#iceContacts > div').forEach(contactDiv => {
                const inputs = contactDiv.querySelectorAll('input');
                if (inputs.length >= 3) {
                    contacts.push({
                        name: inputs[0].value,
                        relationship: inputs[1].value,
                        phone: inputs[2].value
                    });
                }
            });
            
            return {
                profile: {
                    fullName: document.getElementById('fullName').value,
                    dateOfBirth: document.getElementById('dateOfBirth').value,
                    country: document.getElementById('country').value,
                    healthId: document.getElementById('healthId').value,
                    code: token
                },
                health: {
                    bloodType: document.getElementById('bloodType').value,
                    organDonor: document.getElementById('organDonor').value,
                    lifeSupportPref: document.getElementById('lifeSupportPref').value,
                    religionPref: document.getElementById('religionPref').value,
                    allergies: pillData.allergies.join(', '),
                    conditions: pillData.conditions.join(', '),
                    medications: pillData.medications.join(', ')
                },
                contacts: contacts
            };
        }

        // ========== DATE INPUT FORMATTING ==========
        function setupDateInput() {
            const dateInput = document.getElementById('dateOfBirth');
            
            dateInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                e.target.value = value;
            });
            
            dateInput.addEventListener('blur', function(e) {
                const value = e.target.value;
                const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                
                if (value && !dateRegex.test(value)) {
                    showToast('Please enter date as DD/MM/YYYY', 'warning');
                    e.target.focus();
                }
            });
        }

        async function loadUserData() {
            try {
                const savedData = await loadFromIndexedDB();
                
                if (savedData) {
                    if (savedData.profile) {
                        document.getElementById('fullName').value = savedData.profile.fullName || '';
                        document.getElementById('dateOfBirth').value = savedData.profile.dateOfBirth || '';
                        document.getElementById('country').value = savedData.profile.country || '';
                        document.getElementById('healthId').value = savedData.profile.healthId || '';
                        
                        if (savedData.profile.code) {
                            token = savedData.profile.code;
                            localStorage.setItem("myqer_public_token", token);
                            document.getElementById('cardCodeDisplay').textContent = savedData.profile.code;
                            document.getElementById('codeDisplay').classList.add('has-code');
                            updateCardLink(savedData.profile.code);
                        }
                    }
                
                    if (savedData.health) {
                        document.getElementById('bloodType').value = savedData.health.bloodType || '‚Äî';
                        document.getElementById('organDonor').value = savedData.health.organDonor || '‚Äî';
                        document.getElementById('lifeSupportPref').value = savedData.health.lifeSupportPref || 'Full';
                        document.getElementById('religionPref').value = savedData.health.religionPref || 'None';
                        
                        if (savedData.health.allergies) {
                            pillData.allergies = savedData.health.allergies.split(', ').filter(Boolean);
                            renderPills('allergies');
                        }
                        if (savedData.health.conditions) {
                            pillData.conditions = savedData.health.conditions.split(', ').filter(Boolean);
                            renderPills('conditions');
                        }
                        if (savedData.health.medications) {
                            pillData.medications = savedData.health.medications.split(', ').filter(Boolean);
                            renderPills('medications');
                        }
                    }
                    
                    if (savedData.contacts && savedData.contacts.length > 0) {
                        savedData.contacts.forEach((contact, index) => {
                            const container = document.getElementById('iceContacts');
                            const contactId = `ice_${Date.now()}_${index}`;
                            
                            const contactDiv = document.createElement('div');
                            contactDiv.className = 'border border-gray-200 rounded-lg p-4';
                            contactDiv.innerHTML = `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
                                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" value="${contact.name || ''}" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Relationship</label>
                                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" value="${contact.relationship || ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Phone</label>
                                        <input type="tel" class="w-full px-2 py-1 border border-gray-300 rounded" value="${contact.phone || ''}" required>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-3">
                                    <button class="text-red-600 text-sm hover:text-red-800" onclick="removeIceContact('${contactId}')">
                                        Remove Contact
                                    </button>
                                    <div class="text-xs text-gray-500">Auto-saves on blur</div>
                                </div>
                            `;
                            
                            contactDiv.dataset.contactId = contactId;
                            container.appendChild(contactDiv);
                            iceContactCount++;
                            
                            contactDiv.querySelectorAll('input').forEach(input => {
                                input.addEventListener('blur', debounce(autoSave, 600));
                            });
                        });
                        
                        updateAddButtonState();
                    }
                }
                
                generateQRCode();
                updateTriageStatus();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading data', 'error');
            }
        }

        // ========== SAVE FUNCTIONS ==========
        async function saveProfile() {
            try {
                const userData = getUserData();
                await saveToIndexedDB(userData);
                showToast('Profile saved successfully', 'success');
                generateQRCode();
            } catch (error) {
                console.error('Save profile error:', error);
                showToast('Failed to save profile', 'error');
            }
        }

        async function saveHealthProfile() {
            try {
                const userData = getUserData();
                await saveToIndexedDB(userData);
                showToast('Health profile saved successfully', 'success');
                updateTriageStatus();
                generateQRCode();
            } catch (error) {
                console.error('Save health error:', error);
                showToast('Failed to save health profile', 'error');
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function copyCardLink() {
            const link = document.getElementById('cardLink').value;
            if (link) {
                navigator.clipboard.writeText(link).then(() => {
                    showToast('Link copied to clipboard', 'success');
                }).catch(() => {
                    showToast('Failed to copy link', 'error');
                });
            }
        }

        function viewEmergencyCard() {
            const link = document.getElementById('cardLink').value;
            if (link) {
                window.open(link, '_blank');
            } else {
                showToast('Generate a code first', 'warning');
            }
        }

        function exportQR(format) {
            const canvas = document.getElementById('qrCanvas');
            if (format === 'png') {
                try {
                    const link = document.createElement('a');
                    link.download = `myqer-qr-${token}.png`;
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('QR code exported as PNG', 'success');
                } catch (error) {
                    console.error('PNG export failed:', error);
                    showToast('PNG export failed', 'error');
                }
            } else if (format === 'svg') {
                try {
                    const userData = getUserData();
                    const hybridPayload = buildHybridPayload(userData);
                    
                    QRCode.toString(hybridPayload, {
                        type: 'svg',
                        width: 256,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function (error, svg) {
                        if (error) {
                            showToast('SVG export failed', 'error');
                            return;
                        }
                        
                        const blob = new Blob([svg], { type: 'image/svg+xml' });
                        const link = document.createElement('a');
                        link.download = `myqer-qr-${token}.svg`;
                        link.href = URL.createObjectURL(blob);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                        showToast('QR code exported as SVG', 'success');
                    });
                } catch (error) {
                    console.error('SVG export failed:', error);
                    showToast('SVG export failed', 'error');
                }
            }
        }

        function printEmergencyCard() {
            try {
                const userData = getUserData();
                const printWindow = window.open('', '_blank');
                
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>MYQER Emergency Card - ${userData.profile.fullName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .card { border: 2px solid #C62828; border-radius: 12px; padding: 20px; max-width: 400px; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .brand { font-size: 24px; font-weight: bold; color: #C62828; }
                            .qr-section { text-align: center; margin: 20px 0; }
                            .info { margin: 10px 0; }
                            .label { font-weight: bold; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        <div class="card">
                            <div class="header">
                                <div class="brand">MYQER‚Ñ¢</div>
                                <div>Emergency Information Card</div>
                            </div>
                            <div class="qr-section">
                                <canvas id="printQR" width="128" height="128"></canvas>
                                <div style="margin-top: 10px; font-size: 12px;">${token}</div>
                            </div>
                            <div class="info"><span class="label">Name:</span> ${userData.profile.fullName}</div>
                            <div class="info"><span class="label">Blood Type:</span> ${userData.health.bloodType}</div>
                            <div class="info"><span class="label">Allergies:</span> ${userData.health.allergies || 'None'}</div>
                            <div class="info"><span class="label">Conditions:</span> ${userData.health.conditions || 'None'}</div>
                            <div class="info"><span class="label">Medications:</span> ${userData.health.medications || 'None'}</div>
                        </div>
                        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
                        <script>
                            const payload = \`${buildHybridPayload(userData)}\`;
                            const canvas = document.getElementById('printQR');
                            QRCode.toCanvas(canvas, payload, {
                                width: 128,
                                height: 128,
                                margin: 2
                            }, function() {
                                window.print();
                            });
                        </script>
                    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9777c35a47be777f',t:'MTc1NjU5MzM0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
                    </html>
                `;
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                showToast('Opening print dialog...', 'info');
                
            } catch (error) {
                console.error('Print failed:', error);
                showToast('Print failed', 'error');
            }
        }

        function shareQrCode() {
            if (navigator.share) {
                const canvas = document.getElementById('qrCanvas');
                canvas.toBlob(blob => {
                    const file = new File([blob], 'myqer-qr.png', { type: 'image/png' });
                    navigator.share({
                        title: 'My Emergency QR Code',
                        text: 'My MYQER emergency information',
                        files: [file]
                    });
                });
            } else {
                copyCardLink();
            }
        }

        async function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    try {
                        showToast('Account deletion requires secure verification. Please contact support to complete this action.', 'warning');
                    } catch (error) {
                        console.error('Delete account error:', error);
                        showToast('Account deletion requires secure verification. Please contact support.', 'warning');
                    }
                }
            }
        }

        function checkOnlineStatus() {
            const updateOnlineStatus = () => {
                const indicator = document.getElementById('offlineIndicator');
                if (navigator.onLine) {
                    indicator.classList.remove('show');
                    if (isOffline) {
                        processOutbox();
                    }
                    isOffline = false;
                } else {
                    indicator.classList.add('show');
                    isOffline = true;
                }
            };
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function processOutbox() {
            console.log('Processing offline changes...');
        }
    </script>
</body>
</html>
