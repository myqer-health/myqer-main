<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-red: #dc2626;
            --primary-red-hover: #ef4444;
            --success-green: #059669;
            --warning-amber: #ea580c;
            --ink-dark: #0f172a;
            --slate-text: #475569;
            --slate-light: #94a3b8;
            --background-white: #ffffff;
            --background-gray: #f8fafc;
            --border-light: #e2e8f0;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--background-gray) 0%, #f1f5f9 100%);
            color: var(--ink-dark);
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 18px;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .logo-text {
            font-size: 24px;
            font-weight: 800;
            color: var(--ink-dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--slate-text);
            font-size: 14px;
        }

        .language-selector {
            position: relative;
        }

        .language-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            color: var(--slate-text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .language-option:hover {
            background-color: #f8fafc;
        }

        .language-option.active {
            background-color: var(--primary-red);
            color: white;
        }

        .logout-btn {
            background: none;
            border: 1px solid var(--border-light);
            color: var(--slate-text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .offline-banner {
            background: linear-gradient(135deg, var(--warning-amber), #f97316);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(234, 88, 12, 0.3);
        }

        .offline-banner.show {
            display: flex;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: 24px 0 0 24px;
        }

        .card.identity::before {
            background: linear-gradient(135deg, var(--success-green), #10b981);
        }

        .card.critical::before {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
        }

        .card.ice::before {
            background: linear-gradient(135deg, var(--warning-amber), #f97316);
        }

        .card.emergency {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.05), rgba(239, 68, 68, 0.05));
        }

        .card.emergency::before {
            background: linear-gradient(135deg, #ec4899, #f472b6);
        }

        .card.delete {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.02), rgba(239, 68, 68, 0.02));
            border: 2px solid rgba(220, 38, 38, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--ink-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .triage-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .triage-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .triage-green {
            background: var(--success-green);
            color: white;
        }

        .triage-amber {
            background: var(--warning-amber);
            color: white;
        }

        .triage-red {
            background: var(--primary-red);
            color: white;
        }

        .triage-black {
            background: #1f2937;
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: 400;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 16px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-red);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            color: white;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-red);
            border: 2px solid var(--primary-red);
        }

        .btn-secondary:hover {
            background: var(--primary-red);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green), #10b981);
            color: white;
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-amber), #f97316);
            color: white;
            box-shadow: 0 4px 16px rgba(234, 88, 12, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(234, 88, 12, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
        }

        .ice-contact {
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .ice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .ice-title {
            font-weight: 600;
            color: var(--ink-dark);
        }

        .ice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            text-align: center;
        }

        .qr-box {
            width: 240px;
            height: 240px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-code {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 24px;
            font-weight: 800;
            color: var(--ink-dark);
            letter-spacing: 2px;
        }

        .qr-label {
            font-size: 12px;
            color: var(--primary-red);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .url-group {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .url-input {
            flex: 1;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            background: #f8fafc;
            border: 2px solid var(--border-light);
            padding: 12px 16px;
            border-radius: 8px;
        }

        .qr-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .delete-section {
            text-align: center;
            padding: 40px;
        }

        .delete-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 16px;
        }

        .delete-warning {
            color: #6b7280;
            margin-bottom: 32px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .confirm-input {
            max-width: 300px;
            margin: 0 auto 24px;
            text-align: center;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success-green), #10b981);
        }

        .toast.error {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 16px;
        }

        .modal-text {
            color: #6b7280;
            margin-bottom: 32px;
        }

        .modal-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .footer {
            margin-top: 80px;
            padding: 40px 0;
            border-top: 1px solid var(--border-light);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
        }

        .footer-links {
            display: flex;
            gap: 32px;
        }

        .footer-link {
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--primary-red);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .saving-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-text);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .saving-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .no-contacts {
            text-align: center;
            padding: 40px;
            color: var(--slate-text);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .ice-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 24px;
            }

            .qr-actions {
                flex-direction: column;
            }

            .url-group {
                flex-direction: column;
            }

            .triage-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="container">
            <div id="offlineBanner" class="offline-banner">
                <span>⚠️</span>
                <span data-i18n="offline_mode">You're offline. Changes will sync when connection is restored.</span>
            </div>

            <header class="header">
                <div class="logo">
                    <div class="logo-icon">M</div>
                    <div class="logo-text">MYQER</div>
                </div>
                <div class="user-info">
                    <div class="language-selector">
                        <button class="language-btn" onclick="toggleLanguageDropdown()">
                            <span id="currentLanguage">🇺🇸 EN</span>
                            <span>▼</span>
                        </button>
                        <div id="languageDropdown" class="language-dropdown">
                            <div class="language-option active" onclick="changeLanguage('en')">🇺🇸 English</div>
                            <div class="language-option" onclick="changeLanguage('es')">🇪🇸 Español</div>
                            <div class="language-option" onclick="changeLanguage('fr')">🇫🇷 Français</div>
                            <div class="language-option" onclick="changeLanguage('de')">🇩🇪 Deutsch</div>
                            <div class="language-option" onclick="changeLanguage('it')">🇮🇹 Italiano</div>
                            <div class="language-option" onclick="changeLanguage('pt')">🇵🇹 Português</div>
                            <div class="language-option" onclick="changeLanguage('ro')">🇷🇴 Română</div>
                            <div class="language-option" onclick="changeLanguage('ar')">🇸🇦 العربية</div>
                            <div class="language-option" onclick="changeLanguage('hi')">🇮🇳 हिन्दी</div>
                            <div class="language-option" onclick="changeLanguage('zh')">🇨🇳 中文</div>
                        </div>
                    </div>
                    <span id="userEmail">user@example.com</span>
                    <button class="logout-btn" onclick="logout()" data-i18n="logout">Logout</button>
                </div>
            </header>

            <div class="card identity">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="identity_title">Identity — Personal Information</h2>
                    <button class="btn btn-success" onclick="saveProfile()" data-i18n="save">Save</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-i18n="full_name">Full Name</label>
                        <input type="text" id="fullName" class="form-input" placeholder="Enter your full legal name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="date_of_birth">Date of Birth</label>
                        <input type="date" id="dob" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="country">Country</label>
                        <select id="country" class="form-select">
                            <option value="">Select Country</option>
                            <option value="United States">United States</option>
                            <option value="Canada">Canada</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Spain">Spain</option>
                            <option value="Italy">Italy</option>
                            <option value="Australia">Australia</option>
                            <option value="Japan">Japan</option>
                            <option value="China">China</option>
                            <option value="India">India</option>
                            <option value="Brazil">Brazil</option>
                            <option value="Mexico">Mexico</option>
                            <option value="Argentina">Argentina</option>
                            <option value="South Africa">South Africa</option>
                            <option value="Nigeria">Nigeria</option>
                            <option value="Egypt">Egypt</option>
                            <option value="Russia">Russia</option>
                            <option value="Turkey">Turkey</option>
                            <option value="Saudi Arabia">Saudi Arabia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="health_id">National/Health ID (Optional)</label>
                        <input type="text" id="healthId" class="form-input" placeholder="e.g., SSN, NHS Number">
                    </div>
                </div>
            </div>

            <div class="card critical">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="critical_title">CRITICAL — Medical & Health Details</h2>
                    <div class="triage-container">
                        <select id="triageOverride" class="form-select" style="width: auto; min-width: 120px;" onchange="updateTriage()">
                            <option value="auto" data-i18n="auto">Auto</option>
                            <option value="green" data-i18n="green">Green</option>
                            <option value="amber" data-i18n="amber">Amber</option>
                            <option value="red" data-i18n="red">Red</option>
                            <option value="black" data-i18n="black">Black</option>
                        </select>
                        <div id="triagePill" class="triage-pill triage-green">
                            <span>●</span> <span data-i18n="green">Green</span>
                        </div>
                        <button class="btn btn-warning" onclick="saveHealth()" data-i18n="save">Save</button>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-i18n="blood_type">Blood Type</label>
                        <select id="bloodType" class="form-select">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+ (A Positive)</option>
                            <option value="A-">A- (A Negative)</option>
                            <option value="B+">B+ (B Positive)</option>
                            <option value="B-">B- (B Negative)</option>
                            <option value="AB+">AB+ (AB Positive)</option>
                            <option value="AB-">AB- (AB Negative)</option>
                            <option value="O+">O+ (O Positive)</option>
                            <option value="O-">O- (O Negative)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="allergies">Critical Allergies</label>
                        <input type="text" id="allergies" class="form-input" placeholder="e.g., Penicillin, Nuts, Shellfish">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="conditions">Medical Conditions</label>
                        <textarea id="conditions" class="form-textarea" placeholder="List any chronic conditions, diseases, or ongoing medical issues"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="medications">Current Medications</label>
                        <textarea id="medications" class="form-textarea" placeholder="List all current medications with dosages"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="implants">Implants/Medical Devices</label>
                        <input type="text" id="implants" class="form-input" placeholder="e.g., Pacemaker, Hip replacement, Insulin pump">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="organDonor" class="checkbox">
                            <label for="organDonor" class="form-label" data-i18n="organ_donor">I am an organ donor</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card ice">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="ice_title">Emergency Contacts (ICE)</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="addContact()" data-i18n="add_contact">Add Contact</button>
                        <button class="btn btn-warning" onclick="saveICE()" data-i18n="save_all">Save All</button>
                    </div>
                </div>
                <div id="iceContacts">
                    <div class="no-contacts" data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>
                </div>
            </div>

            <div class="card emergency">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="qr_title">Emergency Card & QR Code</h2>
                </div>
                <div class="qr-container">
                    <div class="qr-box">
                        <canvas id="qrCanvas" width="200" height="200"></canvas>
                    </div>
                    <div class="qr-code" id="qrCode">XXXX-XXXX</div>
                    <div class="qr-label">MYQER™</div>
                    
                    <div class="url-group">
                        <input type="text" id="cardUrl" class="url-input" readonly value="https://www.myqer.com/c/XXXX-XXXX">
                        <button class="btn btn-secondary" onclick="copyUrl()" data-i18n="copy">Copy</button>
                        <button class="btn btn-secondary" onclick="openUrl()" data-i18n="open">Open</button>
                    </div>
                    
                    <div class="qr-actions">
                        <button class="btn btn-secondary" onclick="downloadQR('png')" data-i18n="download_png">Download PNG</button>
                        <button class="btn btn-secondary" onclick="downloadQR('svg')" data-i18n="download_svg">Download SVG</button>
                        <button class="btn btn-secondary" onclick="printQR()" data-i18n="print">Print</button>
                    </div>
                </div>
            </div>

            <div class="card delete">
                <div class="delete-section">
                    <h2 class="delete-title" data-i18n="delete_title">⚠️ Delete Account</h2>
                    <p class="delete-warning" data-i18n="delete_warning">
                        This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers.
                    </p>
                    <div class="form-group">
                        <label class="form-label" data-i18n="delete_confirm_label">Type "DELETE MY ACCOUNT" to confirm:</label>
                        <input type="text" id="deleteConfirm" class="form-input confirm-input" placeholder="DELETE MY ACCOUNT">
                    </div>
                    <button class="btn btn-danger" onclick="deleteAccount()" data-i18n="delete_account">Delete My Account</button>
                </div>
            </div>

            <footer class="footer">
                <div class="footer-content">
                    <div style="color: #6b7280; font-size: 14px;" data-i18n="copyright">
                        © 2024 MYQER. All rights reserved.
                    </div>
                    <div class="footer-links">
                        <a href="#" class="footer-link" data-i18n="privacy_policy">Privacy Policy</a>
                        <a href="#" class="footer-link" data-i18n="terms_of_service">Terms of Service</a>
                        <a href="#" class="footer-link" data-i18n="support">Support</a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <div id="savingIndicator" class="saving-indicator">
        <span data-i18n="saving">Saving...</span>
    </div>

    <div id="idleModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" data-i18n="session_expiring">Session Expiring</h3>
            <p class="modal-text">
                <span data-i18n="session_expire_text">Your session will expire in</span> 
                <span id="countdown">60</span> 
                <span data-i18n="seconds">seconds due to inactivity.</span>
            </p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="resetIdleTimer()" data-i18n="stay_logged_in">Stay Logged In</button>
                <button class="btn btn-secondary" onclick="logout()" data-i18n="logout">Logout</button>
            </div>
        </div>
    </div>

    <script>
        let supabase;
        let currentUser = { id: 'demo-user-' + Date.now(), email: 'user@example.com' };
        let iceContacts = [];
        let idleTimer = null;
        let warningTimer = null;
        let countdownTimer = null;
        let countdownSeconds = 60;
        let debounceTimers = {};
        let isOnline = navigator.onLine;
        let currentLanguage = 'en';
        let userCode = null;
        let isGeneratingQR = false;

        const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';

        const translations = {
            en: {
                offline_mode: "You're offline. Changes will sync when connection is restored.",
                logout: "Logout",
                identity_title: "Identity — Personal Information",
                save: "Save",
                full_name: "Full Name",
                date_of_birth: "Date of Birth",
                country: "Country",
                health_id: "National/Health ID (Optional)",
                critical_title: "CRITICAL — Medical & Health Details",
                auto: "Auto",
                green: "Green",
                amber: "Amber",
                red: "Red",
                black: "Black",
                blood_type: "Blood Type",
                allergies: "Critical Allergies",
                conditions: "Medical Conditions",
                medications: "Current Medications",
                implants: "Implants/Medical Devices",
                organ_donor: "I am an organ donor",
                ice_title: "Emergency Contacts (ICE)",
                add_contact: "Add Contact",
                save_all: "Save All",
                qr_title: "Emergency Card & QR Code",
                copy: "Copy",
                open: "Open",
                download_png: "Download PNG",
                download_svg: "Download SVG",
                print: "Print",
                delete_title: "⚠️ Delete Account",
                delete_warning: "This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers.",
                delete_confirm_label: "Type \"DELETE MY ACCOUNT\" to confirm:",
                delete_account: "Delete My Account",
                copyright: "© 2024 MYQER. All rights reserved.",
                privacy_policy: "Privacy Policy",
                terms_of_service: "Terms of Service",
                support: "Support",
                saving: "Saving...",
                session_expiring: "Session Expiring",
                session_expire_text: "Your session will expire in",
                seconds: "seconds due to inactivity.",
                stay_logged_in: "Stay Logged In",
                contact_name: "Name",
                contact_relationship: "Relationship",
                contact_phone: "Phone",
                remove: "Remove",
                no_contacts: "No emergency contacts added yet. Click \"Add Contact\" to get started."
            },
            es: {
                offline_mode: "Estás desconectado. Los cambios se sincronizarán cuando se restaure la conexión.",
                logout: "Cerrar Sesión",
                identity_title: "Identidad — Información Personal",
                save: "Guardar",
                full_name: "Nombre Completo",
                date_of_birth: "Fecha de Nacimiento",
                country: "País",
                health_id: "ID Nacional/Salud (Opcional)",
                critical_title: "CRÍTICO — Detalles Médicos y de Salud",
                auto: "Auto",
                green: "Verde",
                amber: "Ámbar",
                red: "Rojo",
                black: "Negro",
                blood_type: "Tipo de Sangre",
                allergies: "Alergias Críticas",
                conditions: "Condiciones Médicas",
                medications: "Medicamentos Actuales",
                implants: "Implantes/Dispositivos Médicos",
                organ_donor: "Soy donante de órganos",
                ice_title: "Contactos de Emergencia (ICE)",
                add_contact: "Agregar Contacto",
                save_all: "Guardar Todo",
                qr_title: "Tarjeta de Emergencia y Código QR",
                copy: "Copiar",
                open: "Abrir",
                download_png: "Descargar PNG",
                download_svg: "Descargar SVG",
                print: "Imprimir",
                delete_title: "⚠️ Eliminar Cuenta",
                delete_warning: "Esta acción no se puede deshacer. Todos tus datos médicos de emergencia, códigos QR e información de perfil serán eliminados permanentemente de nuestros servidores.",
                delete_confirm_label: "Escribe \"DELETE MY ACCOUNT\" para confirmar:",
                delete_account: "Eliminar Mi Cuenta",
                copyright: "© 2024 MYQER. Todos los derechos reservados.",
                privacy_policy: "Política de Privacidad",
                terms_of_service: "Términos de Servicio",
                support: "Soporte",
                saving: "Guardando...",
                session_expiring: "Sesión Expirando",
                session_expire_text: "Tu sesión expirará en",
                seconds: "segundos debido a inactividad.",
                stay_logged_in: "Mantener Sesión",
                contact_name: "Nombre",
                contact_relationship: "Relación",
                contact_phone: "Teléfono",
                remove: "Eliminar",
                no_contacts: "No se han agregado contactos de emergencia aún. Haz clic en \"Agregar Contacto\" para comenzar."
            },
            fr: {
                offline_mode: "Vous êtes hors ligne. Les modifications se synchroniseront lorsque la connexion sera rétablie.",
                logout: "Déconnexion",
                identity_title: "Identité — Informations Personnelles",
                save: "Enregistrer",
                full_name: "Nom Complet",
                date_of_birth: "Date de Naissance",
                country: "Pays",
                health_id: "ID National/Santé (Optionnel)",
                critical_title: "CRITIQUE — Détails Médicaux et de Santé",
                auto: "Auto",
                green: "Vert",
                amber: "Ambre",
                red: "Rouge",
                black: "Noir",
                blood_type: "Groupe Sanguin",
                allergies: "Allergies Critiques",
                conditions: "Conditions Médicales",
                medications: "Médicaments Actuels",
                implants: "Implants/Dispositifs Médicaux",
                organ_donor: "Je suis donneur d'organes",
                ice_title: "Contacts d'Urgence (ICE)",
                add_contact: "Ajouter Contact",
                save_all: "Tout Enregistrer",
                qr_title: "Carte d'Urgence et Code QR",
                copy: "Copier",
                open: "Ouvrir",
                download_png: "Télécharger PNG",
                download_svg: "Télécharger SVG",
                print: "Imprimer",
                delete_title: "⚠️ Supprimer le Compte",
                delete_warning: "Cette action ne peut pas être annulée. Toutes vos données médicales d'urgence, codes QR et informations de profil seront définitivement supprimées de nos serveurs.",
                delete_confirm_label: "Tapez \"DELETE MY ACCOUNT\" pour confirmer:",
                delete_account: "Supprimer Mon Compte",
                copyright: "© 2024 MYQER. Tous droits réservés.",
                privacy_policy: "Politique de Confidentialité",
                terms_of_service: "Conditions de Service",
                support: "Support",
                saving: "Enregistrement...",
                session_expiring: "Session Expirant",
                session_expire_text: "Votre session expirera dans",
                seconds: "secondes en raison d'inactivité.",
                stay_logged_in: "Rester Connecté",
                contact_name: "Nom",
                contact_relationship: "Relation",
                contact_phone: "Téléphone",
                remove: "Supprimer",
                no_contacts: "Aucun contact d'urgence ajouté pour le moment. Cliquez sur \"Ajouter Contact\" pour commencer."
            },
            de: {
                offline_mode: "Sie sind offline. Änderungen werden synchronisiert, wenn die Verbindung wiederhergestellt ist.",
                logout: "Abmelden",
                identity_title: "Identität — Persönliche Informationen",
                save: "Speichern",
                full_name: "Vollständiger Name",
                date_of_birth: "Geburtsdatum",
                country: "Land",
                health_id: "National-/Gesundheits-ID (Optional)",
                critical_title: "KRITISCH — Medizinische und Gesundheitsdetails",
                auto: "Auto",
                green: "Grün",
                amber: "Gelb",
                red: "Rot",
                black: "Schwarz",
                blood_type: "Blutgruppe",
                allergies: "Kritische Allergien",
                conditions: "Medizinische Bedingungen",
                medications: "Aktuelle Medikamente",
                implants: "Implantate/Medizinische Geräte",
                organ_donor: "Ich bin Organspender",
                ice_title: "Notfallkontakte (ICE)",
                add_contact: "Kontakt hinzufügen",
                save_all: "Alle speichern",
                qr_title: "Notfallkarte und QR-Code",
                copy: "Kopieren",
                open: "Öffnen",
                download_png: "PNG herunterladen",
                download_svg: "SVG herunterladen",
                print: "Drucken",
                delete_title: "⚠️ Konto löschen",
                delete_warning: "Diese Aktion kann nicht rückgängig gemacht werden. Alle Ihre medizinischen Notfalldaten, QR-Codes und Profilinformationen werden dauerhaft von unseren Servern gelöscht.",
                delete_confirm_label: "Geben Sie \"DELETE MY ACCOUNT\" zur Bestätigung ein:",
                delete_account: "Mein Konto löschen",
                copyright: "© 2024 MYQER. Alle Rechte vorbehalten.",
                privacy_policy: "Datenschutzrichtlinie",
                terms_of_service: "Nutzungsbedingungen",
                support: "Support",
                saving: "Speichern...",
                session_expiring: "Sitzung läuft ab",
                session_expire_text: "Ihre Sitzung läuft ab in",
                seconds: "Sekunden aufgrund von Inaktivität.",
                stay_logged_in: "Angemeldet bleiben",
                contact_name: "Name",
                contact_relationship: "Beziehung",
                contact_phone: "Telefon",
                remove: "Entfernen",
                no_contacts: "Noch keine Notfallkontakte hinzugefügt. Klicken Sie auf \"Kontakt hinzufügen\", um zu beginnen."
            },
            it: {
                offline_mode: "Sei offline. Le modifiche si sincronizzeranno quando la connessione sarà ripristinata.",
                logout: "Disconnetti",
                identity_title: "Identità — Informazioni Personali",
                save: "Salva",
                full_name: "Nome Completo",
                date_of_birth: "Data di Nascita",
                country: "Paese",
                health_id: "ID Nazionale/Sanitario (Opzionale)",
                critical_title: "CRITICO — Dettagli Medici e Sanitari",
                auto: "Auto",
                green: "Verde",
                amber: "Ambra",
                red: "Rosso",
                black: "Nero",
                blood_type: "Gruppo Sanguigno",
                allergies: "Allergie Critiche",
                conditions: "Condizioni Mediche",
                medications: "Farmaci Attuali",
                implants: "Impianti/Dispositivi Medici",
                organ_donor: "Sono un donatore di organi",
                ice_title: "Contatti di Emergenza (ICE)",
                add_contact: "Aggiungi Contatto",
                save_all: "Salva Tutto",
                qr_title: "Carta di Emergenza e Codice QR",
                copy: "Copia",
                open: "Apri",
                download_png: "Scarica PNG",
                download_svg: "Scarica SVG",
                print: "Stampa",
                delete_title: "⚠️ Elimina Account",
                delete_warning: "Questa azione non può essere annullata. Tutti i tuoi dati medici di emergenza, codici QR e informazioni del profilo saranno eliminati permanentemente dai nostri server.",
                delete_confirm_label: "Digita \"DELETE MY ACCOUNT\" per confermare:",
                delete_account: "Elimina Il Mio Account",
                copyright: "© 2024 MYQER. Tutti i diritti riservati.",
                privacy_policy: "Politica sulla Privacy",
                terms_of_service: "Termini di Servizio",
                support: "Supporto",
                saving: "Salvando...",
                session_expiring: "Sessione in Scadenza",
                session_expire_text: "La tua sessione scadrà tra",
                seconds: "secondi a causa dell'inattività.",
                stay_logged_in: "Rimani Connesso",
                contact_name: "Nome",
                contact_relationship: "Relazione",
                contact_phone: "Telefono",
                remove: "Rimuovi",
                no_contacts: "Nessun contatto di emergenza aggiunto ancora. Clicca \"Aggiungi Contatto\" per iniziare."
            },
            pt: {
                offline_mode: "Você está offline. As alterações serão sincronizadas quando a conexão for restaurada.",
                logout: "Sair",
                identity_title: "Identidade — Informações Pessoais",
                save: "Salvar",
                full_name: "Nome Completo",
                date_of_birth: "Data de Nascimento",
                country: "País",
                health_id: "ID Nacional/Saúde (Opcional)",
                critical_title: "CRÍTICO — Detalhes Médicos e de Saúde",
                auto: "Auto",
                green: "Verde",
                amber: "Âmbar",
                red: "Vermelho",
                black: "Preto",
                blood_type: "Tipo Sanguíneo",
                allergies: "Alergias Críticas",
                conditions: "Condições Médicas",
                medications: "Medicamentos Atuais",
                implants: "Implantes/Dispositivos Médicos",
                organ_donor: "Sou doador de órgãos",
                ice_title: "Contatos de Emergência (ICE)",
                add_contact: "Adicionar Contato",
                save_all: "Salvar Tudo",
                qr_title: "Cartão de Emergência e Código QR",
                copy: "Copiar",
                open: "Abrir",
                download_png: "Baixar PNG",
                download_svg: "Baixar SVG",
                print: "Imprimir",
                delete_title: "⚠️ Excluir Conta",
                delete_warning: "Esta ação não pode ser desfeita. Todos os seus dados médicos de emergência, códigos QR e informações de perfil serão permanentemente excluídos de nossos servidores.",
                delete_confirm_label: "Digite \"DELETE MY ACCOUNT\" para confirmar:",
                delete_account: "Excluir Minha Conta",
                copyright: "© 2024 MYQER. Todos os direitos reservados.",
                privacy_policy: "Política de Privacidade",
                terms_of_service: "Termos de Serviço",
                support: "Suporte",
                saving: "Salvando...",
                session_expiring: "Sessão Expirando",
                session_expire_text: "Sua sessão expirará em",
                seconds: "segundos devido à inatividade.",
                stay_logged_in: "Permanecer Conectado",
                contact_name: "Nome",
                contact_relationship: "Relacionamento",
                contact_phone: "Telefone",
                remove: "Remover",
                no_contacts: "Nenhum contato de emergência adicionado ainda. Clique em \"Adicionar Contato\" para começar."
            },
            ro: {
                offline_mode: "Ești offline. Modificările se vor sincroniza când conexiunea va fi restabilită.",
                logout: "Deconectare",
                identity_title: "Identitate — Informații Personale",
                save: "Salvează",
                full_name: "Nume Complet",
                date_of_birth: "Data Nașterii",
                country: "Țară",
                health_id: "ID Național/Sănătate (Opțional)",
                critical_title: "CRITIC — Detalii Medicale și de Sănătate",
                auto: "Auto",
                green: "Verde",
                amber: "Chihlimbar",
                red: "Roșu",
                black: "Negru",
                blood_type: "Grupa Sanguină",
                allergies: "Alergii Critice",
                conditions: "Condiții Medicale",
                medications: "Medicamentele Actuale",
                implants: "Implanturi/Dispozitive Medicale",
                organ_donor: "Sunt donator de organe",
                ice_title: "Contacte de Urgență (ICE)",
                add_contact: "Adaugă Contact",
                save_all: "Salvează Tot",
                qr_title: "Card de Urgență și Cod QR",
                copy: "Copiază",
                open: "Deschide",
                download_png: "Descarcă PNG",
                download_svg: "Descarcă SVG",
                print: "Tipărește",
                delete_title: "⚠️ Șterge Contul",
                delete_warning: "Această acțiune nu poate fi anulată. Toate datele dvs. medicale de urgență, codurile QR și informațiile de profil vor fi șterse permanent de pe serverele noastre.",
                delete_confirm_label: "Tastați \"DELETE MY ACCOUNT\" pentru a confirma:",
                delete_account: "Șterge Contul Meu",
                copyright: "© 2024 MYQER. Toate drepturile rezervate.",
                privacy_policy: "Politica de Confidențialitate",
                terms_of_service: "Termenii de Serviciu",
                support: "Suport",
                saving: "Se salvează...",
                session_expiring: "Sesiunea Expiră",
                session_expire_text: "Sesiunea dvs. va expira în",
                seconds: "secunde din cauza inactivității.",
                stay_logged_in: "Rămâi Conectat",
                contact_name: "Nume",
                contact_relationship: "Relația",
                contact_phone: "Telefon",
                remove: "Elimină",
                no_contacts: "Nu au fost adăugate încă contacte de urgență. Faceți clic pe \"Adaugă Contact\" pentru a începe."
            },
            ar: {
                offline_mode: "أنت غير متصل. ستتم مزامنة التغييرات عند استعادة الاتصال.",
                logout: "تسجيل الخروج",
                identity_title: "الهوية — المعلومات الشخصية",
                save: "حفظ",
                full_name: "الاسم الكامل",
                date_of_birth: "تاريخ الميلاد",
                country: "البلد",
                health_id: "الهوية الوطنية/الصحية (اختياري)",
                critical_title: "حرج — التفاصيل الطبية والصحية",
                auto: "تلقائي",
                green: "أخضر",
                amber: "كهرماني",
                red: "أحمر",
                black: "أسود",
                blood_type: "فصيلة الدم",
                allergies: "الحساسيات الحرجة",
                conditions: "الحالات الطبية",
                medications: "الأدوية الحالية",
                implants: "الزراعات/الأجهزة الطبية",
                organ_donor: "أنا متبرع بالأعضاء",
                ice_title: "جهات الاتصال الطارئة (ICE)",
                add_contact: "إضافة جهة اتصال",
                save_all: "حفظ الكل",
                qr_title: "بطاقة الطوارئ ورمز QR",
                copy: "نسخ",
                open: "فتح",
                download_png: "تحميل PNG",
                download_svg: "تحميل SVG",
                print: "طباعة",
                delete_title: "⚠️ حذف الحساب",
                delete_warning: "لا يمكن التراجع عن هذا الإجراء. ستتم إزالة جميع بيانات الطوارئ الطبية ورموز QR ومعلومات الملف الشخصي نهائياً من خوادمنا.",
                delete_confirm_label: "اكتب \"DELETE MY ACCOUNT\" للتأكيد:",
                delete_account: "حذف حسابي",
                copyright: "© 2024 MYQER. جميع الحقوق محفوظة.",
                privacy_policy: "سياسة الخصوصية",
                terms_of_service: "شروط الخدمة",
                support: "الدعم",
                saving: "جاري الحفظ...",
                session_expiring: "انتهاء صلاحية الجلسة",
                session_expire_text: "ستنتهي صلاحية جلستك خلال",
                seconds: "ثانية بسبب عدم النشاط.",
                stay_logged_in: "البقاء متصلاً",
                contact_name: "الاسم",
                contact_relationship: "العلاقة",
                contact_phone: "الهاتف",
                remove: "إزالة",
                no_contacts: "لم تتم إضافة جهات اتصال طارئة بعد. انقر على \"إضافة جهة اتصال\" للبدء."
            },
            hi: {
                offline_mode: "आप ऑफ़लाइन हैं। कनेक्शन बहाल होने पर परिवर्तन सिंक हो जाएंगे।",
                logout: "लॉगआउट",
                identity_title: "पहचान — व्यक्तिगत जानकारी",
                save: "सेव करें",
                full_name: "पूरा नाम",
                date_of_birth: "जन्म तिथि",
                country: "देश",
                health_id: "राष्ट्रीय/स्वास्थ्य आईडी (वैकल्पिक)",
                critical_title: "गंभीर — चिकित्सा और स्वास्थ्य विवरण",
                auto: "ऑटो",
                green: "हरा",
                amber: "एम्बर",
                red: "लाल",
                black: "काला",
                blood_type: "रक्त समूह",
                allergies: "गंभीर एलर्जी",
                conditions: "चिकित्सा स्थितियां",
                medications: "वर्तमान दवाएं",
                implants: "इम्प्लांट/चिकित्सा उपकरण",
                organ_donor: "मैं अंग दाता हूं",
                ice_title: "आपातकालीन संपर्क (ICE)",
                add_contact: "संपर्क जोड़ें",
                save_all: "सभी सेव करें",
                qr_title: "आपातकालीन कार्ड और QR कोड",
                copy: "कॉपी करें",
                open: "खोलें",
                download_png: "PNG डाउनलोड करें",
                download_svg: "SVG डाउनलोड करें",
                print: "प्रिंट करें",
                delete_title: "⚠️ खाता हटाएं",
                delete_warning: "यह क्रिया पूर्ववत नहीं की जा सकती। आपका सभी आपातकालीन चिकित्सा डेटा, QR कोड और प्रोफ़ाइल जानकारी हमारे सर्वर से स्थायी रूप से हटा दी जाएगी।",
                delete_confirm_label: "पुष्टि के लिए \"DELETE MY ACCOUNT\" टाइप करें:",
                delete_account: "मेरा खाता हटाएं",
                copyright: "© 2024 MYQER। सभी अधिकार सुरक्षित।",
                privacy_policy: "गोपनीयता नीति",
                terms_of_service: "सेवा की शर्तें",
                support: "सहायता",
                saving: "सेव हो रहा है...",
                session_expiring: "सत्र समाप्त हो रहा है",
                session_expire_text: "निष्क्रियता के कारण आपका सत्र समाप्त हो जाएगा",
                seconds: "सेकंड में।",
                stay_logged_in: "लॉग इन रहें",
                contact_name: "नाम",
                contact_relationship: "रिश्ता",
                contact_phone: "फोन",
                remove: "हटाएं",
                no_contacts: "अभी तक कोई आपातकालीन संपर्क नहीं जोड़े गए। शुरू करने के लिए \"संपर्क जोड़ें\" पर क्लिक करें।"
            },
            zh: {
                offline_mode: "您处于离线状态。连接恢复后更改将同步。",
                logout: "登出",
                identity_title: "身份 — 个人信息",
                save: "保存",
                full_name: "全名",
                date_of_birth: "出生日期",
                country: "国家",
                health_id: "国民/健康ID（可选）",
                critical_title: "紧急 — 医疗和健康详情",
                auto: "自动",
                green: "绿色",
                amber: "琥珀色",
                red: "红色",
                black: "黑色",
                blood_type: "血型",
                allergies: "严重过敏",
                conditions: "医疗状况",
                medications: "当前药物",
                implants: "植入物/医疗设备",
                organ_donor: "我是器官捐献者",
                ice_title: "紧急联系人（ICE）",
                add_contact: "添加联系人",
                save_all: "全部保存",
                qr_title: "紧急卡片和二维码",
                copy: "复制",
                open: "打开",
                download_png: "下载PNG",
                download_svg: "下载SVG",
                print: "打印",
                delete_title: "⚠️ 删除账户",
                delete_warning: "此操作无法撤销。您的所有紧急医疗数据、二维码和个人资料信息将从我们的服务器中永久删除。",
                delete_confirm_label: "输入\"DELETE MY ACCOUNT\"确认：",
                delete_account: "删除我的账户",
                copyright: "© 2024 MYQER。保留所有权利。",
                privacy_policy: "隐私政策",
                terms_of_service: "服务条款",
                support: "支持",
                saving: "保存中...",
                session_expiring: "会话即将过期",
                session_expire_text: "由于不活动，您的会话将在",
                seconds: "秒后过期。",
                stay_logged_in: "保持登录",
                contact_name: "姓名",
                contact_relationship: "关系",
                contact_phone: "电话",
                remove: "移除",
                no_contacts: "尚未添加紧急联系人。点击\"添加联系人\"开始。"
            }
        };

        const LIFE_THREATENING_CONDITIONS = [
            'heart attack', 'cardiac arrest', 'stroke', 'anaphylaxis', 'severe asthma', 'diabetes type 1',
            'epilepsy', 'seizure', 'hemophilia', 'severe allergy', 'pacemaker', 'defibrillator',
            'insulin dependent', 'blood clotting disorder', 'severe bleeding disorder', 'aneurysm',
            'heart failure', 'arrhythmia', 'atrial fibrillation', 'ventricular tachycardia',
            'myocardial infarction', 'angina', 'coronary artery disease', 'pulmonary embolism',
            'deep vein thrombosis', 'aortic stenosis', 'mitral valve prolapse', 'cardiomyopathy',
            'heart disease', 'cardiac', 'coronary', 'myocardial', 'ventricular', 'atrial'
        ];

        const LIFE_THREATENING_ALLERGIES = [
            'penicillin', 'shellfish', 'nuts', 'peanuts', 'bee sting', 'wasp sting', 'latex',
            'contrast dye', 'iodine', 'aspirin', 'nsaid', 'sulfa', 'eggs', 'milk', 'soy',
            'anaphylactic', 'severe allergy', 'epipen', 'epinephrine'
        ];

        const CRITICAL_IMPLANTS = [
            'pacemaker', 'defibrillator', 'insulin pump', 'cochlear implant', 'neurostimulator',
            'heart valve', 'stent', 'artificial heart', 'ventricular assist device', 'icd'
        ];

        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                setupOnlineDetection();
                
                const savedLanguage = localStorage.getItem('myqer_language') || 'en';
                changeLanguage(savedLanguage);
                
                await loadProfile();
                await loadHealth();
                await loadICE();
                
                setupAutosave();
                setupIdleTimer();
                await generateQR();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to load dashboard', 'error');
            }
        }

        function setupOnlineDetection() {
            function updateOnlineStatus() {
                isOnline = navigator.onLine;
                const banner = document.getElementById('offlineBanner');
                
                if (isOnline) {
                    banner.classList.remove('show');
                    syncPendingChanges();
                } else {
                    banner.classList.add('show');
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        async function syncPendingChanges() {
            try {
                const profileData = localStorage.getItem('myqer_profile_pending');
                if (profileData) {
                    const data = JSON.parse(profileData);
                    await supabase.from('profiles').upsert(data);
                    localStorage.removeItem('myqer_profile_pending');
                }
                
                const healthData = localStorage.getItem('myqer_health_pending');
                if (healthData) {
                    const data = JSON.parse(healthData);
                    await supabase.from('health_data').upsert(data);
                    localStorage.removeItem('myqer_health_pending');
                }
                
                const iceData = localStorage.getItem('myqer_ice_pending');
                if (iceData) {
                    const data = JSON.parse(iceData);
                    await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
                    if (data.length > 0) {
                        await supabase.from('ice_contacts').insert(data);
                    }
                    localStorage.removeItem('myqer_ice_pending');
                }
                
                showToast('Changes synced successfully', 'success');
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('show');
            
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.language-selector')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('myqer_language', lang);
            
            const flags = {
                en: '🇺🇸 EN',
                es: '🇪🇸 ES',
                fr: '🇫🇷 FR',
                de: '🇩🇪 DE',
                it: '🇮🇹 IT',
                pt: '🇵🇹 PT',
                ro: '🇷🇴 RO',
                ar: '🇸🇦 AR',
                hi: '🇮🇳 HI',
                zh: '🇨🇳 ZH'
            };
            
            document.getElementById('currentLanguage').textContent = flags[lang];
            
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[onclick="changeLanguage('${lang}')"]`).classList.add('active');
            
            document.getElementById('languageDropdown').classList.remove('show');
            
            applyTranslations();
        }

        function applyTranslations() {
            const t = translations[currentLanguage];
            
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
        }

        function setupAutosave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const section = getInputSection(input.id);
                    if (section) {
                        debounceAutosave(section);
                    }
                });
            });
        }

        function getInputSection(inputId) {
            const profileInputs = ['fullName', 'dob', 'country', 'healthId'];
            const healthInputs = ['bloodType', 'allergies', 'conditions', 'medications', 'implants', 'organDonor', 'triageOverride'];
            
            if (profileInputs.includes(inputId)) return 'profile';
            if (healthInputs.includes(inputId)) return 'health';
            return null;
        }

        function debounceAutosave(section) {
            if (debounceTimers[section]) {
                clearTimeout(debounceTimers[section]);
            }
            
            debounceTimers[section] = setTimeout(() => {
                if (section === 'profile') saveProfile(true);
                else if (section === 'health') saveHealth(true);
            }, 1000);
        }

        function showSavingIndicator() {
            const indicator = document.getElementById('savingIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        async function loadProfile() {
            try {
                const cached = localStorage.getItem('myqer_profile');
                if (cached) {
                    const data = JSON.parse(cached);
                    fillProfileForm(data);
                }
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    
                    if (data) {
                        fillProfileForm(data);
                        localStorage.setItem('myqer_profile', JSON.stringify(data));
                        userCode = data.code;
                    }
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        function fillProfileForm(data) {
            if (data.full_name) document.getElementById('fullName').value = data.full_name;
            if (data.dob) document.getElementById('dob').value = data.dob;
            if (data.country) document.getElementById('country').value = data.country;
            if (data.health_id) document.getElementById('healthId').value = data.health_id;
            userCode = data.code;
        }

        async function loadHealth() {
            try {
                const cached = localStorage.getItem('myqer_health');
                if (cached) {
                    const data = JSON.parse(cached);
                    fillHealthForm(data);
                }
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('health_data')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    
                    if (data) {
                        fillHealthForm(data);
                        localStorage.setItem('myqer_health', JSON.stringify(data));
                    }
                }
                
                updateTriage();
            } catch (error) {
                console.error('Load health error:', error);
            }
        }

        function fillHealthForm(data) {
            if (data.blood_type) document.getElementById('bloodType').value = data.blood_type;
            if (data.allergies) document.getElementById('allergies').value = data.allergies;
            if (data.conditions) document.getElementById('conditions').value = data.conditions;
            if (data.medications) document.getElementById('medications').value = data.medications;
            if (data.implants) document.getElementById('implants').value = data.implants;
            if (data.donor !== undefined) document.getElementById('organDonor').checked = data.donor;
            if (data.triage_override) document.getElementById('triageOverride').value = data.triage_override;
        }

        async function loadICE() {
            try {
                const cached = localStorage.getItem('myqer_ice');
                if (cached) {
                    iceContacts = JSON.parse(cached);
                    renderICE();
                }
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('ice_contacts')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('contact_order');
                    
                    if (error) throw error;
                    
                    iceContacts = data || [];
                    localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                    renderICE();
                }
            } catch (error) {
                console.error('Load ICE error:', error);
            }
        }

        async function generateCode() {
            if (userCode) return userCode;
            
            const cached = localStorage.getItem('myqer_profile');
            if (cached) {
                const data = JSON.parse(cached);
                if (data.code) {
                    userCode = data.code;
                    return data.code;
                }
            }
            
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                if (i === 4) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            userCode = code;
            return code;
        }

        async function saveProfile(isAutosave = false) {
            try {
                const code = await generateCode();
                const profileData = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value || null,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value || null,
                    health_id: document.getElementById('healthId').value || null,
                    code: code
                };
                
                localStorage.setItem('myqer_profile', JSON.stringify(profileData));
                
                if (isAutosave) {
                    showSavingIndicator();
                }
                
                if (isOnline) {
                    const { error } = await supabase
                        .from('profiles')
                        .upsert(profileData);
                    
                    if (error) throw error;
                    
                    localStorage.removeItem('myqer_profile_pending');
                } else {
                    localStorage.setItem('myqer_profile_pending', JSON.stringify(profileData));
                }
                
                if (!isAutosave) {
                    showToast('Profile saved successfully', 'success');
                }
                
                await generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save profile error:', error);
                if (!isAutosave) {
                    showToast('Failed to save profile', 'error');
                }
                
                if (!isOnline) {
                    const code = await generateCode();
                    const profileData = {
                        id: currentUser.id,
                        full_name: document.getElementById('fullName').value || null,
                        dob: document.getElementById('dob').value || null,
                        country: document.getElementById('country').value || null,
                        health_id: document.getElementById('healthId').value || null,
                        code: code
                    };
                    localStorage.setItem('myqer_profile_pending', JSON.stringify(profileData));
                }
            }
        }

        async function saveHealth(isAutosave = false) {
            try {
                const healthData = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value || null,
                    allergies: document.getElementById('allergies').value || null,
                    conditions: document.getElementById('conditions').value || null,
                    medications: document.getElementById('medications').value || null,
                    implants: document.getElementById('implants').value || null,
                    donor: document.getElementById('organDonor').checked,
                    triage_override: document.getElementById('triageOverride').value
                };
                
                localStorage.setItem('myqer_health', JSON.stringify(healthData));
                
                if (isAutosave) {
                    showSavingIndicator();
                }
                
                if (isOnline) {
                    const { error } = await supabase
                        .from('health_data')
                        .upsert(healthData);
                    
                    if (error) throw error;
                    
                    localStorage.removeItem('myqer_health_pending');
                } else {
                    localStorage.setItem('myqer_health_pending', JSON.stringify(healthData));
                }
                
                if (!isAutosave) {
                    showToast('Health data saved successfully', 'success');
                }
                
                updateTriage();
                await generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save health error:', error);
                if (!isAutosave) {
                    showToast('Failed to save health data', 'error');
                }
                
                if (!isOnline) {
                    const healthData = {
                        user_id: currentUser.id,
                        blood_type: document.getElementById('bloodType').value || null,
                        allergies: document.getElementById('allergies').value || null,
                        conditions: document.getElementById('conditions').value || null,
                        medications: document.getElementById('medications').value || null,
                        implants: document.getElementById('implants').value || null,
                        donor: document.getElementById('organDonor').checked,
                        triage_override: document.getElementById('triageOverride').value
                    };
                    localStorage.setItem('myqer_health_pending', JSON.stringify(healthData));
                }
            }
        }

        function updateTriage() {
            const override = document.getElementById('triageOverride').value;
            const pill = document.getElementById('triagePill');
            const pillText = pill.querySelector('span:last-child');
            
            if (override !== 'auto') {
                pill.className = `triage-pill triage-${override}`;
                pillText.textContent = translations[currentLanguage][override];
                return;
            }
            
            const allergies = document.getElementById('allergies').value.toLowerCase();
            const conditions = document.getElementById('conditions').value.toLowerCase();
            const implants = document.getElementById('implants').value.toLowerCase();
            
            let isLifeThreatening = false;
            
            LIFE_THREATENING_ALLERGIES.forEach(allergy => {
                if (allergies.includes(allergy)) {
                    isLifeThreatening = true;
                }
            });
            
            LIFE_THREATENING_CONDITIONS.forEach(condition => {
                if (conditions.includes(condition)) {
                    isLifeThreatening = true;
                }
            });
            
            CRITICAL_IMPLANTS.forEach(implant => {
                if (implants.includes(implant)) {
                    isLifeThreatening = true;
                }
            });
            
            if (isLifeThreatening) {
                pill.className = 'triage-pill triage-red';
                pillText.textContent = translations[currentLanguage]['red'];
            } else if (allergies || conditions || implants) {
                pill.className = 'triage-pill triage-amber';
                pillText.textContent = translations[currentLanguage]['amber'];
            } else {
                pill.className = 'triage-pill triage-green';
                pillText.textContent = translations[currentLanguage]['green'];
            }
        }

        function addContact() {
            if (iceContacts.length >= 3) {
                showToast('Maximum 3 emergency contacts allowed', 'error');
                return;
            }
            
            const newContact = {
                id: Date.now().toString(),
                name: '',
                relationship: '',
                phone: '',
                contact_order: iceContacts.length
            };
            
            iceContacts.push(newContact);
            renderICE();
        }

        function removeContact(id) {
            iceContacts = iceContacts.filter(contact => contact.id !== id);
            iceContacts.forEach((contact, index) => {
                contact.contact_order = index;
            });
            renderICE();
        }

        function renderICE() {
            const container = document.getElementById('iceContacts');
            
            if (iceContacts.length === 0) {
                container.innerHTML = '<div class="no-contacts" data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>';
                applyTranslations();
                return;
            }
            
            container.innerHTML = iceContacts.map(contact => `
                <div class="ice-contact">
                    <div class="ice-header">
                        <h4 class="ice-title">Emergency Contact ${contact.contact_order + 1}</h4>
                        <button class="btn btn-danger" onclick="removeContact('${contact.id}')" data-i18n="remove">Remove</button>
                    </div>
                    <div class="ice-grid">
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_name">Name</label>
                            <input type="text" class="form-input" value="${contact.name}" 
                                   onchange="updateContact('${contact.id}', 'name', this.value)"
                                   placeholder="Full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_relationship">Relationship</label>
                            <input type="text" class="form-input" value="${contact.relationship}" 
                                   onchange="updateContact('${contact.id}', 'relationship', this.value)"
                                   placeholder="e.g., Spouse, Parent">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_phone">Phone</label>
                            <input type="tel" class="form-input" value="${contact.phone}" 
                                   onchange="updateContact('${contact.id}', 'phone', this.value)"
                                   placeholder="+1 (555) 123-4567">
                        </div>
                    </div>
                </div>
            `).join('');
            
            applyTranslations();
        }

        function updateContact(id, field, value) {
            const contact = iceContacts.find(c => c.id === id);
            if (contact) {
                contact[field] = value;
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                generateQR();
            }
        }

        async function saveICE() {
            try {
                const iceData = iceContacts.map(contact => ({
                    user_id: currentUser.id,
                    name: contact.name || null,
                    relationship: contact.relationship || null,
                    phone: contact.phone || null,
                    contact_order: contact.contact_order
                }));
                
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                
                if (isOnline) {
                    await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
                    
                    if (iceData.length > 0) {
                        const { error } = await supabase.from('ice_contacts').insert(iceData);
                        if (error) throw error;
                    }
                    
                    localStorage.removeItem('myqer_ice_pending');
                } else {
                    localStorage.setItem('myqer_ice_pending', JSON.stringify(iceData));
                }
                
                showToast('Emergency contacts saved successfully', 'success');
                await generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save ICE error:', error);
                showToast('Failed to save emergency contacts', 'error');
                
                if (!isOnline) {
                    const iceData = iceContacts.map(contact => ({
                        user_id: currentUser.id,
                        name: contact.name || null,
                        relationship: contact.relationship || null,
                        phone: contact.phone || null,
                        contact_order: contact.contact_order
                    }));
                    localStorage.setItem('myqer_ice_pending', JSON.stringify(iceData));
                }
            }
        }

        async function generateQR() {
            if (isGeneratingQR) return;
            isGeneratingQR = true;
            
            try {
                const code = await generateCode();
                document.getElementById('qrCode').textContent = code;
                
                const url = `https://www.myqer.com/c/${code}`;
                document.getElementById('cardUrl').value = url;
                
                const offlineData = createOfflinePayload();
                
                const canvas = document.getElementById('qrCanvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                await QRCode.toCanvas(canvas, offlineData, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#0f172a',
                        light: '#ffffff'
                    }
                });
                
            } catch (error) {
                console.error('QR generation error:', error);
            } finally {
                isGeneratingQR = false;
            }
        }

        function createOfflinePayload() {
            const profile = JSON.parse(localStorage.getItem('myqer_profile') || '{}');
            const health = JSON.parse(localStorage.getItem('myqer_health') || '{}');
            const ice = JSON.parse(localStorage.getItem('myqer_ice') || '[]');
            
            let payload = `MYQER EMERGENCY CARD\n`;
            payload += `Code: ${userCode || 'XXXX-XXXX'}\n`;
            payload += `URL: https://www.myqer.com/c/${userCode || 'XXXX-XXXX'}\n\n`;
            
            if (profile.full_name) payload += `Name: ${profile.full_name}\n`;
            if (profile.dob) payload += `DOB: ${profile.dob}\n`;
            if (health.blood_type) payload += `Blood: ${health.blood_type}\n`;
            if (health.allergies) payload += `Allergies: ${health.allergies}\n`;
            if (health.conditions) payload += `Conditions: ${health.conditions}\n`;
            if (health.medications) payload += `Medications: ${health.medications}\n`;
            if (health.implants) payload += `Implants: ${health.implants}\n`;
            if (health.donor) payload += `Organ Donor: Yes\n`;
            
            ice.slice(0, 3).forEach((contact, i) => {
                if (contact.name && contact.phone) {
                    payload += `ICE${i + 1}: ${contact.name} (${contact.relationship || 'Contact'}) ${contact.phone}\n`;
                }
            });
            
            if (payload.length > 900) {
                payload = payload.substring(0, 897) + '...';
            }
            
            return payload;
        }

        function copyUrl() {
            const urlInput = document.getElementById('cardUrl');
            urlInput.select();
            document.execCommand('copy');
            showToast('URL copied to clipboard', 'success');
        }

        function openUrl() {
            const url = document.getElementById('cardUrl').value;
            window.open(url, '_blank');
        }

        async function downloadQR(format) {
            try {
                const canvas = document.getElementById('qrCanvas');
                
                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = `myqer-${userCode || 'emergency'}-card.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else if (format === 'svg') {
                    const offlineData = createOfflinePayload();
                    const svg = await QRCode.toString(offlineData, { type: 'svg' });
                    const blob = new Blob([svg], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `myqer-${userCode || 'emergency'}-card.svg`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }
                
                showToast(`QR code downloaded as ${format.toUpperCase()}`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download QR code', 'error');
            }
        }

        function printQR() {
            const canvas = document.getElementById('qrCanvas');
            const code = document.getElementById('qrCode').textContent;
            const url = document.getElementById('cardUrl').value;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>MYQER Emergency Card - ${code}</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 40px; }
                        .card { border: 2px solid #dc2626; border-radius: 16px; padding: 40px; max-width: 400px; margin: 0 auto; }
                        .logo { font-size: 24px; font-weight: bold; color: #dc2626; margin-bottom: 20px; }
                        .code { font-family: monospace; font-size: 20px; font-weight: bold; margin: 20px 0; }
                        .url { font-size: 12px; color: #666; word-break: break-all; margin-top: 20px; }
                        .qr { margin: 20px 0; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <div class="logo">MYQER™ EMERGENCY CARD</div>
                        <div class="qr">
                            <img src="${canvas.toDataURL()}" alt="QR Code" style="width: 200px; height: 200px;">
                        </div>
                        <div class="code">${code}</div>
                        <div class="url">${url}</div>
                        <p style="font-size: 12px; color: #666; margin-top: 30px;">
                            Scan QR code or visit URL for emergency medical information
                        </p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function saveSnapshot() {
            try {
                if (!isOnline) return;
                
                const profile = JSON.parse(localStorage.getItem('myqer_profile') || '{}');
                const health = JSON.parse(localStorage.getItem('myqer_health') || '{}');
                const ice = JSON.parse(localStorage.getItem('myqer_ice') || '[]');
                
                const snapshot = {
                    user_id: currentUser.id,
                    profile_data: profile,
                    health_data: health,
                    ice_contacts: ice,
                    created_at: new Date().toISOString()
                };
                
                await supabase.from('profile_snapshots').insert(snapshot);
            } catch (error) {
                console.error('Snapshot save error:', error);
            }
        }

        function setupIdleTimer() {
            const IDLE_TIME = 30 * 60 * 1000;
            const WARNING_TIME = 60 * 1000;
            
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                clearTimeout(warningTimer);
                clearInterval(countdownTimer);
                document.getElementById('idleModal').classList.remove('show');
                
                idleTimer = setTimeout(() => {
                    showIdleWarning();
                }, IDLE_TIME - WARNING_TIME);
            }
            
            function showIdleWarning() {
                document.getElementById('idleModal').classList.add('show');
                countdownSeconds = 60;
                document.getElementById('countdown').textContent = countdownSeconds;
                
                countdownTimer = setInterval(() => {
                    countdownSeconds--;
                    document.getElementById('countdown').textContent = countdownSeconds;
                    
                    if (countdownSeconds <= 0) {
                        logout();
                    }
                }, 1000);
                
                warningTimer = setTimeout(() => {
                    logout();
                }, WARNING_TIME);
            }
            
            window.resetIdleTimer = resetIdleTimer;
            
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetIdleTimer, true);
            });
            
            resetIdleTimer();
        }

        async function deleteAccount() {
            const confirmText = document.getElementById('deleteConfirm').value;
            
            if (confirmText !== 'DELETE MY ACCOUNT') {
                showToast('Please type "DELETE MY ACCOUNT" exactly to confirm', 'error');
                return;
            }
            
            try {
                if (isOnline) {
                    await supabase.from('profiles').delete().eq('id', currentUser.id);
                    await supabase.from('health_data').delete().eq('user_id', currentUser.id);
                    await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
                    await supabase.from('profile_snapshots').delete().eq('user_id', currentUser.id);
                }
                
                localStorage.clear();
                showToast('Account deleted successfully', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Delete account error:', error);
                showToast('Failed to delete account', 'error');
            }
        }

        async function logout() {
            try {
                if (isOnline && supabase) {
                    await supabase.auth.signOut();
                }
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'index.html';
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b0325b25fb940d',t:'MTc1NzE4NTA5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
