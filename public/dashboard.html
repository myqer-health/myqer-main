<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER™ Dashboard - Your Emergency Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- One (1) Supabase SDK only -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <!-- QR generator -->
  <script src="https://unpkg.com/qrcode@1.5.4/build/qrcode.min.js"></script>
  <style>
    /* --- your original design system (trimmed only where redundant) --- */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --red:#DC2626;--green:#059669;--orange:#EA580C;--ink:#0F172A;--slate:#475569;--light-slate:#94A3B8;
      --bg:linear-gradient(135deg,#F8FAFC 0%,#F1F5F9 100%);--white:#FFF;--glass:rgba(255,255,255,.95);
      --border:rgba(148,163,184,.15);--shadow:0 8px 32px rgba(15,23,42,.08);--shadow-lg:0 20px 64px rgba(15,23,42,.12);
      --shadow-xl:0 32px 80px rgba(15,23,42,.15);--gradient-red:linear-gradient(135deg,#DC2626 0%,#B91C1C 100%);
      --gradient-green:linear-gradient(135deg,#059669 0%,#047857 100%);--gradient-orange:linear-gradient(135deg,#EA580C 0%,#C2410C 100%)
    }
    body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--ink);line-height:1.6;min-height:100vh}
    #loadingState{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}
    .spinner{width:48px;height:48px;border:4px solid var(--border);border-top:4px solid var(--red);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:1.125rem;color:var(--slate);font-weight:500}
    #errorBox{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:2px solid #EF4444;border-radius:16px;padding:2rem;max-width:420px;width:90%;text-align:center;box-shadow:var(--shadow-lg);z-index:9998;display:none}
    #errorBox h3{color:#EF4444;margin-bottom:1rem;font-size:1.25rem;font-weight:600}
    #toastArea{position:fixed;top:1rem;right:1rem;z-index:9997;pointer-events:none}
    .toast{background:#fff;border-radius:12px;padding:1rem 1.5rem;margin-bottom:.5rem;box-shadow:var(--shadow);border-left:4px solid var(--green);font-size:.875rem;font-weight:500;opacity:0;transform:translateX(100%);transition:.3s;pointer-events:auto;max-width:320px}
    .toast.show{opacity:1;transform:translateX(0)} .toast.error{border-left-color:#EF4444;color:#991B1B}
    .toast.success{border-left-color:var(--green);color:#166534} .toast.info{border-left-color:#0ea5e9;color:#0c4a6e}
    header{background:#fff;border-bottom:1px solid var(--border);padding:1rem 2rem;position:sticky;top:0;z-index:1000}
    .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo h1{font-size:1.5rem;font-weight:800;letter-spacing:-.02em}.logo-myq{color:var(--ink)}.logo-er{color:var(--red)}.logo-tm{color:var(--ink);font-size:.8em;vertical-align:super}
    .header-controls{display:flex;align-items:center;gap:1rem}
    #netStatus{padding:.5rem 1rem;border-radius:20px;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    #netStatus.online{background:#DCFCE7;color:var(--green)} #netStatus.offline{background:#FEF3C7;color:#D97706}
    #btnSignOut{background:var(--red);color:#fff;border:none;border-radius:8px;padding:.75rem 1.5rem;font-weight:600;cursor:pointer;transition:.2s}
    #btnSignOut:hover{background:#B71C1C;transform:translateY(-1px)}
    #offlineBanner{background:#FEF3C7;color:#92400E;padding:.75rem 2rem;text-align:center;font-size:.875rem;font-weight:500;border-bottom:1px solid #F59E0B;display:none}
    main{max-width:1200px;margin:0 auto;padding:2rem;display:grid;gap:2rem}
    .card{background:var(--glass);backdrop-filter:blur(24px);border:1px solid var(--border);border-radius:24px;padding:3rem 3rem 3rem 4rem;box-shadow:var(--shadow-lg);position:relative;overflow:hidden;transition:.3s;margin-left:1rem}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-xl)}
    .card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:6px;background:var(--gradient-green);border-radius:0 4px 4px 0}
    .card.ice::before{background:var(--gradient-orange)} .card.critical::before,.card.emergency::before{background:var(--gradient-red)}
    .ribbon{position:absolute;top:2rem;left:-.5rem;background:var(--gradient-green);color:#fff;padding:.75rem 1.5rem .75rem 2rem;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;border-radius:0 12px 12px 0;box-shadow:0 4px 16px rgba(5,150,105,.3);z-index:10}
    .ribbon.ice{background:var(--gradient-orange)} .ribbon.critical,.ribbon.emergency{background:var(--gradient-red)}
    .card-title{font-size:1.5rem;font-weight:700;color:var(--ink);margin-bottom:.5rem}
    .card-subtitle{color:var(--slate);font-size:.9rem}
    .form-grid{display:grid;gap:1.5rem}.two-col{grid-template-columns:1fr 1fr}
    .form-group{display:flex;flex-direction:column;gap:.5rem}
    .form-group input,.form-group select,.form-group textarea{padding:.75rem 1rem;border:2px solid var(--border);border-radius:12px;font-size:1rem;background:#fff;transition:.2s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--red);box-shadow:0 0 0 3px rgba(211,47,47,.1)}
    .checkbox-group{display:flex;align-items:center;gap:.75rem}
    .save-button{background:var(--red);color:#fff;border:none;border-radius:12px;padding:.875rem 2rem;font-weight:600;cursor:pointer;transition:.2s;margin-top:1rem}
    .save-button:disabled{background:var(--light-slate);cursor:not-allowed}
    .status-msg{font-size:.875rem;margin-top:.5rem;padding:.5rem;border-radius:8px;display:none}
    .status-msg.success{background:#DCFCE7;color:var(--green)} .status-msg.error{background:#FEE2E2;color:#DC2626}
    .triage-section{display:flex;align-items:center;gap:1rem;margin-top:1rem;padding:1rem;background:rgba(248,250,252,.5);border-radius:12px;border:1px solid var(--border)}
    #triagePill{padding:.5rem 1rem;border-radius:20px;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    #triagePill.green{background:#DCFCE7;color:var(--green)} #triagePill.amber{background:#FEF3C7;color:#D97706}
    #triagePill.red{background:#FEE2E2;color:#DC2626} #triagePill.black{background:#F1F5F9;color:var(--slate)}
    .qr-section{display:grid;grid-template-columns:auto 1fr;gap:3rem;margin-top:2rem;align-items:start}
    #qrSlot{position:relative;width:240px;height:240px;background:#fff;border:3px solid rgba(220,38,38,.1);border-radius:20px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(220,38,38,.1)}
    #qrCanvas{display:none;border-radius:12px}
    .qr-placeholder{width:200px;height:200px;background:rgba(220,38,38,.05);border:2px dashed rgba(220,38,38,.2);border-radius:12px;display:flex;align-items:center;justify-content:center;color:var(--slate);font-size:.875rem;text-align:center;font-weight:500}
    #codeUnderQR{font-family:monospace;font-size:.9rem;color:var(--slate);text-align:center;margin-top:1rem;font-weight:600;letter-spacing:.1em}
    #qrStatus{background:rgba(220,38,38,.1);color:var(--red);padding:.75rem 1rem;border-radius:8px;font-size:.875rem;font-weight:500;margin-top:1rem}
    .qr-controls{display:flex;flex-direction:column;gap:2rem}
    .qr-url-section{background:rgba(220,38,38,.03);border:1px solid rgba(220,38,38,.1);border-radius:16px;padding:1.5rem}
    .btn-secondary{background:#fff;color:var(--red);border:2px solid var(--red);border-radius:12px;padding:.875rem 2rem;font-weight:600;cursor:pointer;transition:.2s}
    .btn-secondary:hover{background:var(--red);color:#fff}
    .ice-row{background:rgba(234,88,12,.03);border:1px solid rgba(234,88,12,.1);border-radius:16px;padding:2rem;margin-bottom:1.5rem;transition:.3s;position:relative}
    .ice-contact-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
    .contact-number{background:var(--gradient-orange);color:#fff;width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;box-shadow:0 4px 12px rgba(234,88,12,.3)}
    .ice-actions{display:flex;gap:.75rem;align-items:center}
    .iceSaveBtn{background:var(--gradient-orange);color:#fff;border:none;border-radius:8px;padding:.5rem 1rem;font-size:.75rem;font-weight:700;cursor:pointer;letter-spacing:.05em;text-transform:uppercase}
    .iceDeleteBtn{background:none;border:none;color:#DC2626;cursor:pointer;font-size:1.25rem;padding:.5rem;border-radius:8px;transition:.2s;display:flex;align-items:center;justify-content:center;width:36px;height:36px}
    #addIce{background:rgba(234,88,12,.1);color:var(--orange);border:2px dashed rgba(234,88,12,.3);border-radius:16px;padding:1.5rem 2rem;font-weight:700;cursor:pointer;transition:.3s;margin-top:1rem;width:100%;font-size:.875rem;text-transform:uppercase;letter-spacing:.05em}
    .delete-account{background:linear-gradient(135deg,rgba(220,38,38,.03) 0%,rgba(220,38,38,.08) 100%);border:1px solid rgba(220,38,38,.15);margin-top:3rem}
    .delete-button{background:#DC2626;color:#fff;border:none;border-radius:12px;padding:.875rem 2rem;font-weight:700;cursor:pointer;transition:.2s;margin-top:1rem;width:100%}
    .footer{background:#fff;border-top:1px solid var(--border);padding:2rem;margin-top:4rem}
    .footer-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
    .footer-links{display:flex;gap:2rem}.footer-links a{color:var(--slate);text-decoration:none;font-size:.9rem;font-weight:500}
    @media(max-width:768px){main{padding:1rem;gap:1.5rem}.card{padding:1.5rem 1.5rem 1.5rem 2rem;margin-left:.5rem}.two-col{grid-template-columns:1fr}.qr-section{grid-template-columns:1fr;gap:2rem;text-align:center}#qrSlot{width:200px;height:200px;margin:0 auto}}
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loadingState">
    <div class="spinner"></div>
    <div class="loading-text">Loading your dashboard…</div>
  </div>

  <!-- Error -->
  <div id="errorBox">
    <h3>Something went wrong</h3>
    <div id="errorMsg"></div>
    <div class="error-actions">
      <button class="btn-secondary" onclick="location.reload()">Try Again</button>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastArea" aria-live="polite"></div>

  <!-- Header -->
  <header>
    <div class="header-content">
      <div class="logo">
        <h1><span class="logo-myq">MYQ</span><span class="logo-er">ER</span><span class="logo-tm">™</span></h1>
        <span class="logo-hint" style="font-size:.75rem;color:#94A3B8;font-style:italic">pronounced "my care"</span>
      </div>
      <div class="header-controls">
        <div id="netStatus" class="online">Online</div>
        <button id="btnSignOut">Logout</button>
      </div>
    </div>
  </header>

  <!-- Offline -->
  <div id="offlineBanner">You're offline — QR still works with cached data.</div>

  <!-- Login inline (only shows if not logged in) -->
  <div id="loginPanel" class="card" style="max-width:720px;margin:2rem auto;display:none">
    <div class="card-header">
      <h2 class="card-title">Log in</h2>
      <p class="card-subtitle">Enter your email to receive a magic link.</p>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" placeholder="you@example.com" />
      </div>
      <button id="loginBtn" class="save-button">Send magic link</button>
    </div>
  </div>

  <!-- Main -->
  <main id="mainApp" style="display:none">
    <!-- Identity -->
    <section class="card identity">
      <div class="ribbon">Identity</div>
      <div class="card-header">
        <h2 class="card-title">Identity — Personal Information</h2>
        <p class="card-subtitle">These details help responders confirm who you are.</p>
      </div>
      <form class="form-grid two-col">
        <div class="form-group">
          <label for="profileFullName">Full Name</label>
          <input type="text" id="profileFullName" placeholder="Enter your full legal name" required>
        </div>
        <div class="form-group">
          <label for="profileDob">Date of Birth</label>
          <input type="date" id="profileDob" required>
          <span class="form-hint">Format: YYYY-MM-DD</span>
        </div>
        <div class="form-group">
          <label for="profileCountry">Country</label>
          <select id="profileCountry" required>
            <option value="">Select your country</option>
            <option value="GB">United Kingdom</option>
            <option value="US">United States</option>
            <option value="CA">Canada</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="ES">Spain</option>
            <option value="IT">Italy</option>
            <option value="PT">Portugal</option>
            <option value="RO">Romania</option>
            <option value="IN">India</option>
            <option value="CN">China</option>
            <option value="AU">Australia</option>
            <option value="BR">Brazil</option>
            <option value="MX">Mexico</option>
            <option value="JP">Japan</option>
            <option value="KR">South Korea</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="profileHealthId">National/Health ID (Optional)</label>
          <input type="text" id="profileHealthId" placeholder="e.g., NHS number, SSN, etc.">
          <span class="form-hint">Only visible to medical professionals</span>
        </div>
      </form>
      <button class="save-button" id="saveProfile">Save Profile</button>
      <div class="status-msg" id="profileMsg"></div>
    </section>

    <!-- Critical Health -->
    <section class="card critical">
      <div class="ribbon critical">Critical</div>
      <div class="card-header">
        <h2 class="card-title">CRITICAL — Medical & Health Details</h2>
        <p class="card-subtitle">Keep this current. It appears on your emergency card.</p>
      </div>
      <form class="form-grid">
        <div class="form-group">
          <label for="hfBloodType">Blood Type</label>
          <select id="hfBloodType">
            <option value="">Select blood type</option>
            <option value="O+">O+</option><option value="O-">O-</option>
            <option value="A+">A+</option><option value="A-">A-</option>
            <option value="B+">B+</option><option value="B-">B-</option>
            <option value="AB+">AB+</option><option value="AB-">AB-</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>
        <div class="form-group">
          <label for="hfAllergies">Critical Allergies</label>
          <textarea id="hfAllergies" placeholder="List life-threatening allergies (meds, foods, etc.)"></textarea>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="hfDonor">
          <label for="hfDonor">I am an organ donor</label>
        </div>
        <div class="form-group">
          <label for="hfConditions">Medical Conditions</label>
          <textarea id="hfConditions" placeholder="Diabetes, heart disease, epilepsy, etc."></textarea>
        </div>
        <div class="form-group">
          <label for="hfMeds">Current Medications</label>
          <textarea id="hfMeds" placeholder="List all current medications and dosages"></textarea>
        </div>
        <div class="form-group">
          <label for="hfImplants">Implants/Medical Devices</label>
          <textarea id="hfImplants" placeholder="Pacemaker, insulin pump, metal implants, etc."></textarea>
        </div>
      </form>

      <!-- Triage -->
      <div class="triage-section">
        <span class="triage-label">Triage:</span>
        <div id="triagePill" class="green">GREEN</div>
        <select id="triageOverride">
          <option value="auto">Use auto</option>
          <option value="green">Green</option>
          <option value="amber">Amber</option>
          <option value="red">Red</option>
          <option value="black">Black</option>
        </select>
      </div>

      <button class="save-button" id="saveHealth">Save Health</button>
      <div class="status-msg" id="healthMsg"></div>
    </section>

    <!-- ICE Contacts -->
    <section class="card ice">
      <div class="ribbon ice">ICE</div>
      <div class="card-header">
        <h2 class="card-title">Emergency Contacts (ICE)</h2>
        <p class="card-subtitle">Add up to 3 trusted contacts.</p>
      </div>
      <div id="iceContactsList"></div>
      <button id="addIce">+ Add Emergency Contact</button>
      <button class="save-button" id="saveIce">Save ICE Contacts</button>
      <div class="status-msg" id="iceMsg"></div>
    </section>

    <!-- QR -->
    <section class="card emergency emergency-card">
      <div class="ribbon emergency">Emergency</div>
      <div class="card-header">
        <h2 class="card-title" id="qrTitle">Emergency Card & QR</h2>
        <p class="card-subtitle" id="qrExplainer">QR points to a short URL that always shows your latest info.</p>
      </div>
      <div class="qr-section">
        <div>
          <div id="qrSlot">
            <canvas id="qrCanvas" width="200" height="200" aria-label="QR Code"></canvas>
            <div class="qr-placeholder" id="qrPlaceholder"><span>QR will appear here<br>after saving your profile</span></div>
          </div>
          <p id="codeUnderQR"></p>
          <p id="qrStatus" role="alert" hidden></p>
        </div>

        <div class="qr-controls">
          <div class="qr-url-section">
            <h4>Card URL</h4>
            <input type="text" id="cardUrl" readonly placeholder="https://yourdomain.com/p/XXXX">
            <div class="url-actions" style="display:flex;gap:.75rem">
              <button class="btn-secondary" id="copyLink">Copy Link</button>
              <button class="btn-secondary" id="openLink">Open Link</button>
            </div>
          </div>
          <div class="qr-downloads">
            <h4>Downloads</h4>
            <div class="download-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem">
              <button class="btn-secondary" id="dlPNG">PNG</button>
              <button class="btn-secondary" id="dlSVG">SVG</button>
              <button class="btn-secondary" id="printQR">Print</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Delete -->
    <section class="card delete-account">
      <div class="ribbon critical">Danger</div>
      <div class="card-header">
        <h2 class="card-title">Delete Account</h2>
        <p class="card-subtitle">This action cannot be undone.</p>
      </div>
      <div class="delete-form" style="background:rgba(220,38,38,.05);border:1px solid rgba(220,38,38,.1);border-radius:16px;padding:2rem;margin-top:1.5rem">
        <div class="form-group">
          <label for="deletePhrase">Type "DELETE MY ACCOUNT" to confirm:</label>
          <input type="text" id="deletePhrase" placeholder="DELETE MY ACCOUNT" autocomplete="off" />
          <span class="form-hint">This phrase must match exactly</span>
        </div>
        <button class="delete-button" id="deleteBtn" disabled>Delete My Account</button>
        <div class="status-msg" id="deleteMsg"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="/privacy.html">Privacy Policy</a>
        <a href="/terms.html">Terms of Service</a>
      </div>
      <div style="color:#94A3B8;font-size:.8rem">© 2024 MYQER™. All rights reserved.</div>
    </div>
  </footer>

  <script>
    // ---- CONFIG: using YOUR Supabase values (as requested; do not change) ----
    const MYQER = {
      SUPABASE_URL: 'https://dmntmhkncldgynufajei.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY',
      SITE_URL: window.location.origin // builds QR to current origin by default
    };

    // ---- Globals ----
    const { createClient } = window.supabase;
    const sb = createClient(MYQER.SUPABASE_URL, MYQER.SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true } });

    let iceContacts = [];
    let userRow = null; // { id, slug, ... } from patients
    let isOnline = navigator.onLine;

    // ---- Utils ----
    const $ = (id) => document.getElementById(id);
    const toast = (msg, type='success', dur=3500) => {
      const area = $('toastArea');
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = msg;
      area.appendChild(el);
      setTimeout(()=>el.classList.add('show'), 50);
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(), 300); }, dur);
    };

    // ---- Auth: finalize magic link if present ----
    async function handleMagicLink() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const type = url.searchParams.get('type');
      if (code && ['magiclink','recovery','signup'].includes(type)) {
        const { error } = await sb.auth.exchangeCodeForSession({ code });
        if (error) console.error('exchangeCodeForSession', error);
        url.searchParams.delete('code'); url.searchParams.delete('type');
        history.replaceState({}, '', url);
      }
    }

    // ---- Session guard & bootstrap ----
    async function ensureSessionOrShowLogin() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        $('loginPanel').style.display = 'block';
        $('mainApp').style.display = 'none';
      } else {
        $('loginPanel').style.display = 'none';
        $('mainApp').style.display = 'block';
        await loadFromSupabase(); // try load DB data
        loadFromLocal();          // then overlay from local if any
        drawQR();                 // draw QR if we can
      }
      hideLoader();
    }

    function hideLoader() {
      const loading = $('loadingState');
      loading.style.opacity = '0';
      loading.style.transition = 'opacity .4s';
      setTimeout(()=>loading.style.display='none', 400);
    }

    // ---- Login / Logout ----
    $('loginBtn').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      if (!email) return toast('Enter your email', 'error');
      const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href.split('#')[0] } });
      if (error) return toast(error.message, 'error');
      toast('Magic link sent. Check your email.', 'info', 5000);
    });

    $('btnSignOut').addEventListener('click', async ()=>{
      if (!confirm('Log out?')) return;
      await sb.auth.signOut();
      localStorage.clear(); sessionStorage.clear();
      location.reload();
    });

    // ---- Network banner ----
    function updateNetworkStatus(){
      const net = $('netStatus'), banner = $('offlineBanner');
      if (navigator.onLine) { net.textContent='Online'; net.className='online'; banner.style.display='none'; if (!isOnline) toast('Back online - syncing','success'); isOnline=true; }
      else { net.textContent='Offline'; net.className='offline'; banner.style.display='block'; if (isOnline) toast('Working offline - local save only','info'); isOnline=false; }
    }
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);

    // ---- DB helpers (patients table) ----
    function slug8() {
      return btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(6))))
        .replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
    }

    async function loadFromSupabase() {
      try {
        const { data, error } = await sb.from('patients').select('*').limit(1);
        if (error) throw error;
        if (data && data.length) {
          userRow = data[0];
          // Fill fields
          $('#profileFullName').value = userRow.name ?? '';
          $('#profileDob').value = userRow.dob ?? '';
          $('#profileCountry').value = userRow.country ?? '';
          $('#profileHealthId').value = userRow.health_id ?? '';
          $('#hfBloodType').value = userRow.blood_type ?? '';
          $('#hfAllergies').value = (userRow.allergies || []).join(', ');
          $('#hfConditions').value = (userRow.conditions || []).join(', ');
          $('#hfMeds').value = (userRow.current_medications || []).join(', ');
          $('#hfImplants').value = (userRow.devices_implants || []).join(', ');
          $('#hfDonor').checked = !!userRow.organ_donor;
          iceContacts = Array.isArray(userRow.ice_contacts) ? userRow.ice_contacts : (userRow.ice_contact ? [{name:'ICE', relationship:'', phone:userRow.ice_contact}] : []);
          renderIceContacts();
          toast('Loaded from server','success',2000);
        } else {
          userRow = null;
        }
      } catch (e) {
        console.warn('Server load failed; using local', e);
        toast('Database unavailable or not set up yet. Using local storage.', 'info', 5000);
      }
    }

    function loadFromLocal() {
      const prof = JSON.parse(localStorage.getItem('myqer_profile')||'null');
      const health = JSON.parse(localStorage.getItem('myqer_health')||'null');
      const ice = JSON.parse(localStorage.getItem('myqer_ice')||'null');
      if (prof) {
        $('#profileFullName').value = prof.fullName||'';
        $('#profileDob').value = prof.dob||'';
        $('#profileCountry').value = prof.country||'';
        $('#profileHealthId').value = prof.healthId||'';
      }
      if (health) {
        $('#hfBloodType').value = health.bloodType||'';
        $('#hfAllergies').value = health.allergies||'';
        $('#hfConditions').value = health.conditions||'';
        $('#hfMeds').value = health.medications||'';
        $('#hfImplants').value = health.implants||'';
        $('#hfDonor').checked = !!health.organDonor;
        $('#triageOverride').value = health.triageOverride||'auto';
      }
      if (ice) { iceContacts = ice; renderIceContacts(); }
      updateTriage();
    }

    async function upsertPatientRow() {
      // Build payload
      const payload = {
        name: $('#profileFullName').value || null,
        dob: $('#profileDob').value || null,
        country: $('#profileCountry').value || null,
        health_id: $('#profileHealthId').value || null,
        blood_type: $('#hfBloodType').value || null,
        allergies: ($('#hfAllergies').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        conditions: ($('#hfConditions').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        current_medications: ($('#hfMeds').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        devices_implants: ($('#hfImplants').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        organ_donor: $('#hfDonor').checked,
        ice_contact: iceContacts[0]?.phone || null,
        ice_contacts: iceContacts // if column exists; if not, Supabase will ignore extra key
      };

      // Insert first row if needed
      if (!userRow) {
        const slug = slug8();
        const { data, error } = await sb.from('patients').insert({ ...payload, slug }).select('id, slug').single();
        if (error) throw error;
        userRow = data;
      } else {
        const { error } = await sb.from('patients').update(payload).eq('id', userRow.id);
        if (error) throw error;
      }

      // local cache
      localStorage.setItem('myqer_profile', JSON.stringify({
        fullName: payload.name, dob: payload.dob, country: payload.country, healthId: payload.health_id
      }));
      localStorage.setItem('myqer_health', JSON.stringify({
        bloodType: payload.blood_type, allergies: $('#hfAllergies').value, conditions: $('#hfConditions').value,
        medications: $('#hfMeds').value, implants: $('#hfImplants').value, organDonor: payload.organ_donor,
        triageOverride: $('#triageOverride').value
      }));
      localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
    }

    // ---- Save buttons ----
    $('saveProfile').addEventListener('click', async ()=>{
      try { await upsertPatientRow(); $('profileMsg').textContent='✓ Profile saved'; $('profileMsg').className='status-msg success'; $('profileMsg').style.display='block'; toast('Profile saved'); drawQR(); }
      catch(e){ console.error(e); $('profileMsg').textContent=e.message; $('profileMsg').className='status-msg error'; $('profileMsg').style.display='block'; toast('Profile save failed: '+e.message,'error'); }
    });

    $('saveHealth').addEventListener('click', async ()=>{
      try { updateTriage(); await upsertPatientRow(); $('healthMsg').textContent='✓ Health info saved'; $('healthMsg').className='status-msg success'; $('healthMsg').style.display='block'; toast('Health info saved'); drawQR(); }
      catch(e){ console.error(e); $('healthMsg').textContent=e.message; $('healthMsg').className='status-msg error'; $('healthMsg').style.display='block'; toast('Health save failed: '+e.message,'error'); }
    });

    $('saveIce').addEventListener('click', async ()=>{
      try { await upsertPatientRow(); $('iceMsg').textContent='✓ ICE contacts saved'; $('iceMsg').className='status-msg success'; $('iceMsg').style.display='block'; toast('ICE contacts saved'); drawQR(); }
      catch(e){ console.error(e); $('iceMsg').textContent=e.message; $('iceMsg').className='status-msg error'; $('iceMsg').style.display='block'; toast('ICE save failed: '+e.message,'error'); }
    });

    // ---- ICE contacts UI ----
    function renderIceContacts(){
      const c = $('iceContactsList'); c.innerHTML='';
      iceContacts.forEach((contact, i)=>{
        const div=document.createElement('div'); div.className='ice-row'; div.innerHTML = `
          <div class="ice-contact-header">
            <div class="contact-number">${i+1}</div>
            <div class="ice-actions">
              <button class="iceSaveBtn" data-idx="${i}">Save</button>
              <button class="iceDeleteBtn" data-del="${i}" aria-label="Delete">🗑️</button>
            </div>
          </div>
          <div class="ice-form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
            <div class="form-group"><label>Name</label><input type="text" class="iceName" value="${contact.name||''}" /></div>
            <div class="form-group"><label>Relationship</label><input type="text" class="iceRelation" value="${contact.relationship||''}" /></div>
            <div class="form-group"><label>Phone</label><input type="tel" class="icePhone" value="${contact.phone||''}" /></div>
          </div>`;
        c.appendChild(div);
      });
      const addBtn=$('addIce');
      if (iceContacts.length>=3){addBtn.disabled=true; addBtn.textContent='Maximum 3 contacts reached';}
      else{addBtn.disabled=false; addBtn.textContent='+ Add Emergency Contact';}
      // wire events
      c.querySelectorAll('[data-idx]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const idx=+e.currentTarget.dataset.idx;
          const row=e.currentTarget.closest('.ice-row');
          iceContacts[idx] = {
            name: row.querySelector('.iceName').value,
            relationship: row.querySelector('.iceRelation').value,
            phone: row.querySelector('.icePhone').value
          };
          localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
          toast(`Contact ${idx+1} saved`);
          drawQR();
        });
      });
      c.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{ const idx=+e.currentTarget.dataset.del; iceContacts.splice(idx,1); renderIceContacts(); });
      });
    }
    $('addIce').addEventListener('click', ()=>{
      if (iceContacts.length>=3) return toast('Maximum 3 contacts', 'error');
      iceContacts.push({name:'',relationship:'',phone:''}); renderIceContacts();
    });

    // ---- Triage ----
    function updateTriage(){
      const override = $('triageOverride').value;
      if (override!=='auto') return setPill(override);
      let score=0;
      const allergies = $('hfAllergies').value.toLowerCase();
      const conditions = $('hfConditions').value.toLowerCase();
      const meds = $('hfMeds').value.toLowerCase();
      if (allergies.includes('anaphylaxis') || allergies.includes('severe')) score+=3;
      if (conditions.includes('heart') || conditions.includes('cardiac')) score+=2;
      if (conditions.includes('diabetes') && meds.includes('insulin')) score+=2;
      if (conditions.includes('epilepsy') || conditions.includes('seizure')) score+=2;
      if (meds.includes('warfarin') || meds.includes('blood thinner')) score+=1;
      let level='green'; if (score>=5) level='red'; else if (score>=3) level='amber';
      setPill(level);
    }
    function setPill(level){ const pill=$('triagePill'); pill.className=level; pill.textContent=level.toUpperCase(); }
    $('triageOverride').addEventListener('change', updateTriage);

    // ---- QR code ----
    function currentSlug() { return userRow?.slug || (localStorage.getItem('myqer_shortcode')||''); }
    function ensureLocalShortcode(){
      let sc = localStorage.getItem('myqer_shortcode'); if (sc) return sc;
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let code=''; for(let i=0;i<8;i++){code+=chars[Math.floor(Math.random()*chars.length)];}
      sc = code.slice(0,4)+'-'+code.slice(4); localStorage.setItem('myqer_shortcode', sc); return sc;
    }

    async function drawQR(){
      const qrCanvas = $('qrCanvas'), ph = $('qrPlaceholder'), code = $('codeUnderQR'), cardUrl = $('cardUrl'), status=$('qrStatus');
      // If we have any meaningful info, enable QR
      const hasProfile = $('#profileFullName').value || $('#profileDob').value || $('#profileCountry').value;
      const hasHealth = $('#hfBloodType').value || $('#hfAllergies').value || $('#hfConditions').value || $('#hfMeds').value || $('#hfImplants').value;
      const hasIce = iceContacts.length>0 && iceContacts.some(c=>c.phone);
      if (!(hasProfile || hasHealth || hasIce)) { ph.style.display='flex'; qrCanvas.style.display='none'; code.textContent=''; cardUrl.value=''; status.hidden=true; return; }

      // Prefer DB slug; else fallback to local short code
      const slug = currentSlug() || ensureLocalShortcode().replace('-','');
      const url = `${MYQER.SITE_URL.replace(/\/$/,'')}/p/${slug}`;
      cardUrl.value = url; code.textContent = slug;

      // Draw real QR
      ph.style.display='none'; qrCanvas.style.display='block';
      try {
        await QRCode.toCanvas(qrCanvas, url, { errorCorrectionLevel:'M', margin:1, scale:6 });
        status.textContent = 'QR Code generated successfully'; status.style.background='rgba(5,150,105,.1)'; status.style.color='var(--green)'; status.hidden=false;
      } catch(e){ status.textContent='Failed to render QR'; status.style.background='rgba(220,38,38,.1)'; status.style.color='var(--red)'; status.hidden=false; }
    }

    $('copyLink').addEventListener('click', async ()=>{ const val=$('cardUrl').value; if (!val) return toast('No link to copy','error'); await navigator.clipboard.writeText(val); toast('Link copied'); });
    $('openLink').addEventListener('click', ()=>{ const val=$('cardUrl').value; if (!val) return toast('No link','error'); window.open(val,'_blank'); });
    $('dlPNG').addEventListener('click', ()=>{
      const canvas=$('qrCanvas'); if (canvas.style.display==='none') return toast('Generate QR first','error');
      const a=document.createElement('a'); a.download='myqer-qr.png'; a.href=canvas.toDataURL(); a.click(); toast('PNG downloaded');
    });
    $('dlSVG').addEventListener('click', async ()=>{
      const val=$('cardUrl').value; if (!val) return toast('Generate QR first','error');
      const svg = await QRCode.toString(val, { type:'svg', errorCorrectionLevel:'M', margin:1 });
      const blob = new Blob([svg], {type:'image/svg+xml'}); const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='myqer-qr.svg'; a.click(); URL.revokeObjectURL(url); toast('SVG downloaded');
    });
    $('printQR').addEventListener('click', ()=>{
      const val=$('cardUrl').value; if (!val) return toast('Generate QR first','error');
      const w=window.open('','_blank'); w.document.write(`<html><head><title>MYQER Emergency QR</title></head><body style="font-family:Inter;text-align:center;padding:2rem">
        <h1>MYQER™ Emergency Card</h1><p>${val}</p><div id="qrc"></div><script src="https://unpkg.com/qrcode@1.5.4/build/qrcode.min.js"><\/script>
        <script>QRCode.toCanvas(document.createElement('canvas'),'${val}',{errorCorrectionLevel:'M',margin:1,scale:8}).then(c=>{document.getElementById('qrc').appendChild(c);window.print();});<\/script>
      </body></html>`); w.document.close();
    });

    // ---- Delete account (client-only demo) ----
    const delPhrase=$('deletePhrase'), delBtn=$('deleteBtn');
    delPhrase.addEventListener('input',()=>{ delBtn.disabled = delPhrase.value!=='DELETE MY ACCOUNT'; });
    delBtn.addEventListener('click', async ()=>{
      if (delPhrase.value!=='DELETE MY ACCOUNT') return;
      if (!confirm('Delete ALL your data? This cannot be undone.')) return;
      try{
        // Attempt to wipe patient row
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
          await sb.from('patients').delete().neq('id', '00000000-0000-0000-0000-000000000000'); // delete all your rows
        }
      } catch(e){ /* ignore */ }
      localStorage.clear(); sessionStorage.clear();
      toast('Account deleted. Redirecting…','success');
      setTimeout(()=>location.href='/', 1200);
    });

    // ---- Events & bootstrap ----
    document.addEventListener('DOMContentLoaded', async ()=>{
      updateNetworkStatus();
      await handleMagicLink();
      await ensureSessionOrShowLogin();
      // Auto-save (light)
      ['profileFullName','profileDob','profileCountry','profileHealthId','hfBloodType','hfAllergies','hfConditions','hfMeds','hfImplants']
        .forEach(id=>{ const el=$(id); if (!el) return; let t; el.addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(()=>drawQR(), 400); }); });
    });
  </script>
</body>
</html>
