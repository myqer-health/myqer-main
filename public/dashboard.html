<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER - Emergency QR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#dc2626">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MYQER">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self' https:; font-src 'self' https:; media-src 'self' data:; worker-src 'self';"
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #F7F9FC 0%, #EEF2F7 100%);
            color: #0F172A;
            letter-spacing: -0.01em;
        }
        
        .glassmorphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 30px -12px rgba(0, 0, 0, 0.15);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glassmorphism:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 16px 40px -12px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        
        .ribbon {
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            height: 6px;
            border-radius: 20px 20px 0 0;
            background: linear-gradient(135deg, var(--ribbon-start), var(--ribbon-mid), var(--ribbon-end));
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .ribbon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4), transparent);
            border-radius: 20px 20px 0 0;
        }
        
        .ribbon::after {
            content: attr(data-label);
            position: absolute;
            top: -20px;
            right: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--ribbon-text);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .identity-ribbon { 
            --ribbon-start: #16a34a; 
            --ribbon-mid: #15803d; 
            --ribbon-end: #16a34a; 
            --ribbon-text: #15803d;
        }
        .critical-ribbon { 
            --ribbon-start: #dc2626; 
            --ribbon-mid: #b91c1c; 
            --ribbon-end: #dc2626; 
            --ribbon-text: #b91c1c;
        }
        .ice-ribbon { 
            --ribbon-start: #f59e0b; 
            --ribbon-mid: #d97706; 
            --ribbon-end: #f59e0b; 
            --ribbon-text: #d97706;
        }
        .vault-ribbon { 
            --ribbon-start: #7c3aed; 
            --ribbon-mid: #6d28d9; 
            --ribbon-end: #7c3aed; 
            --ribbon-text: #6d28d9;
        }
        .triage-ribbon { 
            --ribbon-start: #64748b; 
            --ribbon-mid: #475569; 
            --ribbon-end: #64748b; 
            --ribbon-text: #475569;
        }
        .qr-ribbon { 
            --ribbon-start: #f59e0b; 
            --ribbon-mid: #d97706; 
            --ribbon-end: #f59e0b; 
            --ribbon-text: #d97706;
        }
        
        .triage-pill {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .triage-green { background: #22c55e; color: white; }
        .triage-amber { background: #f59e0b; color: white; }
        .triage-red { background: #ef4444; color: white; }
        .triage-black { background: #1f2937; color: white; }
        
        .myqer-logo {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .btn-primary {
            background: #dc2626;
            border: none;
            color: white;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 10px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
            font-size: 14px;
            letter-spacing: -0.01em;
        }
        
        .btn-primary:hover {
            background: #b91c1c;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            border: 1.5px solid #cbd5e1;
            color: #334155;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            font-size: 14px;
            letter-spacing: -0.01em;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: #94a3b8;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            border: 1.5px solid #dc2626;
            color: #dc2626;
            font-weight: 600;
            padding: 11px 23px;
            border-radius: 10px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            letter-spacing: -0.01em;
        }
        
        .btn-outline:hover {
            background: #dc2626;
            color: white;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
            transform: translateY(-1px);
        }
        
        .input-luxury {
            border: 1.5px solid #cbd5e1;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 15px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            color: #0f172a;
            letter-spacing: -0.01em;
        }
        
        .input-luxury:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            background: rgba(255, 255, 255, 1);
            outline: none;
        }
        
        .label-luxury {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #475569;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }
        
        .qr-container {
            width: 248px;
            height: 248px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            position: relative;
        }
        
        .offline-banner {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .emergency-view {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .emergency-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .desktop-grid {
                display: block !important;
            }
            
            .desktop-grid > div {
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Main App Container -->
    <div id="app">
        <!-- App Bar -->
        <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-slate-200/50">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Left: Brand -->
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-900 tracking-tight">
                            <span class="text-slate-900">MYQ</span><span class="text-red-600">ER</span><span class="text-xs align-top text-slate-500">™</span>
                        </h1>
                        <div class="hidden md:block text-slate-600 text-sm font-medium">Emergency Dashboard</div>
                    </div>
                    
                    <!-- Center: Status -->
                    <div class="hidden md:flex items-center space-x-2">
                        <div id="statusDot" class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-xs text-slate-500" id="statusText">Online</span>
                    </div>
                    
                    <!-- Right: User Menu -->
                    <div class="flex items-center space-x-4">
                        <select class="text-sm border-0 bg-transparent text-slate-600 focus:ring-0">
                            <option value="en">🇺🇸 EN</option>
                            <option value="es">🇪🇸 ES</option>
                            <option value="fr">🇫🇷 FR</option>
                        </select>
                        
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="flex items-center space-x-2 text-sm text-slate-600 hover:text-slate-900">
                                <span>demo@myqer.com</span>
                                <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                    D
                                </div>
                            </button>
                            
                            <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 py-2">
                                <a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">👤 Profile</a>
                                <a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">⚙️ Settings</a>
                                <div class="px-4 py-2 border-t border-slate-100 mt-2">
                                    <label class="flex items-center text-sm text-slate-700">
                                        <input type="checkbox" class="mr-2 rounded" checked>
                                        Remember me
                                    </label>
                                </div>
                                <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 border-t border-slate-100 mt-2">🚪 Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard View -->
        <div id="dashboard-view" class="container mx-auto px-6 py-8">
            <!-- Tagline -->
            <div class="text-center mb-8">
                <p class="text-slate-500 text-sm italic">pronounced "My Care"</p>
            </div>

            <!-- Desktop Grid Layout -->
            <div class="desktop-grid grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-7xl mx-auto">
                <!-- Left Column -->
                <div class="lg:col-span-8 space-y-6">
                    <!-- Card 1: Identity -->
                    <div class="glassmorphism p-6 relative">
                        <div class="ribbon identity-ribbon" data-label="IDENTITY"></div>
                        <h2 class="text-xl font-800 text-slate-900 mb-6 mt-2 tracking-tight">Identity Profile</h2>
                        <p class="text-xs text-slate-500 mb-6">Last updated: Just now</p>
                        
                        <div class="space-y-5">
                            <div>
                                <label class="label-luxury">Full Name</label>
                                <input type="text" id="fullName" class="w-full input-luxury" placeholder="Enter your full name">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="label-luxury">Date of Birth</label>
                                    <input type="date" id="dob" class="w-full input-luxury">
                                </div>
                                <div>
                                    <label class="label-luxury">Country</label>
                                    <select id="country" class="w-full input-luxury">
                                        <option value="">Select Country</option>
                                        <option value="US">🇺🇸 United States</option>
                                        <option value="CA">🇨🇦 Canada</option>
                                        <option value="UK">🇬🇧 United Kingdom</option>
                                        <option value="AU">🇦🇺 Australia</option>
                                        <option value="DE">🇩🇪 Germany</option>
                                        <option value="FR">🇫🇷 France</option>
                                        <option value="JP">🇯🇵 Japan</option>
                                        <option value="OTHER">🌍 Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="label-luxury">National ID (Optional)</label>
                                <input type="text" id="nationalId" class="w-full input-luxury" placeholder="Driver's License, Passport, etc.">
                            </div>
                            
                            <button onclick="saveIdentity()" class="w-full btn-primary">
                                💾 Save Identity Profile
                            </button>
                            
                            <div id="generateCodeCTA" class="hidden mt-4">
                                <button onclick="generateEmergencyCode()" class="w-full btn-secondary">
                                    🚨 Generate Emergency QR Code
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2: Critical Medical -->
                    <div class="glassmorphism p-6 relative">
                        <div class="ribbon critical-ribbon" data-label="CRITICAL"></div>
                        <h2 class="text-xl font-800 text-slate-900 mb-2 mt-2 tracking-tight">Critical Medical Info</h2>
                        <p class="text-xs text-slate-500 mb-6">Informational only. Clinicians must verify with official documents.</p>
                        
                        <div class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="label-luxury">Blood Type</label>
                                    <select id="bloodType" class="w-full input-luxury">
                                        <option value="">Select Blood Type</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label-luxury">Organ Donor</label>
                                    <select id="organDonor" class="w-full input-luxury">
                                        <option value="">Select</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="label-luxury">Allergies</label>
                                <textarea id="allergies" rows="3" class="w-full input-luxury resize-none" placeholder="List any allergies (e.g., Penicillin, Peanuts, Latex)"></textarea>
                            </div>
                            
                            <div>
                                <label class="label-luxury">Medical Conditions</label>
                                <textarea id="conditions" rows="3" class="w-full input-luxury resize-none" placeholder="List medical conditions (e.g., Diabetes, Hypertension, Asthma)"></textarea>
                            </div>
                            
                            <div>
                                <label class="label-luxury">Current Medications</label>
                                <textarea id="medications" rows="3" class="w-full input-luxury resize-none" placeholder="List current medications and dosages"></textarea>
                            </div>
                            
                            <div>
                                <label class="label-luxury">Life Support Preference</label>
                                <select id="lifeSupportPref" class="w-full input-luxury">
                                    <option value="">Select Preference</option>
                                    <option value="full">Full Life Support</option>
                                    <option value="comfort">Comfort Care Only</option>
                                    <option value="dnr">Do Not Resuscitate (DNR)</option>
                                </select>
                            </div>
                            
                            <button onclick="saveCritical()" class="w-full btn-primary mt-2">
                                💾 Save Critical Info
                            </button>
                        </div>
                    </div>

                    <!-- Card 3: ICE Contacts -->
                    <div class="glassmorphism p-6 relative">
                        <div class="ribbon ice-ribbon" data-label="ICE CONTACTS"></div>
                        <h2 class="text-xl font-800 text-slate-900 mb-6 mt-2 tracking-tight">In Case of Emergency (ICE)</h2>
                        
                        <div id="iceContacts" class="space-y-4">
                            <!-- ICE contacts will be dynamically added here -->
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="addICEContact()" id="addICEBtn" class="bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                                Add ICE Contact
                            </button>
                            <span class="text-sm text-gray-500" id="iceCounter">0/3 contacts</span>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-700">💡 Changes auto-save. Phone numbers will be formatted for emergency calling.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Card 4: Triage (Auto) -->
                    <div class="glassmorphism p-6 relative">
                        <div class="ribbon triage-ribbon" data-label="TRIAGE"></div>
                        <h2 class="text-xl font-800 text-slate-900 mb-6 mt-2 tracking-tight">Triage Assessment</h2>
                        
                        <div class="text-center mb-6">
                            <div id="triageResult" class="triage-pill triage-green inline-block mb-3">
                                GREEN
                            </div>
                            <p class="text-sm text-slate-600" id="triageDescription">
                                Standard emergency protocols apply.
                            </p>
                        </div>
                        
                        <div class="mb-5">
                            <label class="label-luxury">Override (Optional)</label>
                            <select id="triageOverride" onchange="handleTriageOverride()" class="w-full input-luxury">
                                <option value="auto">Auto (Recommended)</option>
                                <option value="green">Green - Standard</option>
                                <option value="amber">Amber - Urgent</option>
                                <option value="red">Red - Emergency</option>
                                <option value="black">Black - Expectant</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-3 mb-5">
                            <button onclick="playTriageInfo()" class="flex-1 btn-secondary text-sm">
                                🔊 Speak
                            </button>
                            <button onclick="stopTriageInfo()" class="flex-1 btn-secondary text-sm">
                                ⏹️ Stop
                            </button>
                        </div>
                        
                        <div class="text-xs text-slate-500 bg-slate-50 p-3 rounded-lg">
                            <strong>Note:</strong> Triage color is an aid from patient-provided info. Use clinical judgment.
                        </div>
                    </div>

                    <!-- Card 5: QR & Tags (Hero) -->
                    <div class="glassmorphism p-6 relative">
                        <div class="ribbon qr-ribbon" data-label="QR & TAGS"></div>
                        <h2 class="text-xl font-800 text-slate-900 mb-6 mt-2 tracking-tight">QR Code & Tags</h2>
                        
                        <!-- QR Mode Selector -->
                        <div class="mb-5">
                            <label class="label-luxury">QR Mode</label>
                            <select id="qrMode" onchange="handleQRModeChange()" class="w-full input-luxury">
                                <option value="hybrid">Hybrid (Offline essentials + link)</option>
                                <option value="offline">Offline-Only (Compact essentials only)</option>
                                <option value="url">URL-Only (Smallest QR)</option>
                            </select>
                        </div>
                        
                        <!-- Offline Caching Toggle -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-blue-800">Offline Emergency Access</h4>
                                    <p class="text-sm text-blue-600">Allow caching for offline viewing</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="offlineCaching" class="sr-only peer" checked onchange="handleOfflineCachingToggle()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        
                        <div id="qrSection" class="text-center">
                            <div id="noCodeState" class="py-8">
                                <div class="text-6xl mb-4">📱</div>
                                <p class="text-slate-600 mb-6">No emergency code generated yet</p>
                                <button onclick="generateEmergencyCode()" class="btn-secondary">
                                    🚨 Generate Emergency Code
                                </button>
                            </div>
                            
                            <div id="hasCodeState" class="hidden">
                                <div class="mb-6">
                                    <span id="qrBadge" class="inline-block px-4 py-2 text-sm font-semibold rounded-full bg-gradient-to-r from-yellow-400 to-yellow-600 text-white shadow-lg">
                                        Hybrid QR
                                    </span>
                                </div>
                                
                                <div class="relative mb-6">
                                    <div class="qr-container">
                                        <canvas id="qrCanvas" width="200" height="200"></canvas>
                                    </div>
                                </div>
                                
                                <div class="mb-5 p-3 bg-slate-50 rounded-lg text-left">
                                    <p class="text-xs text-slate-500 mb-1">Owner Code:</p>
                                    <p class="text-sm font-mono font-bold text-slate-900" id="ownerCode">MYQER-XXXXXXX</p>
                                    <p class="text-xs text-slate-500 mt-1" id="qrDescription">Contains medical essentials + online link</p>
                                </div>
                                
                                <div class="space-y-3 mb-5">
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="previewQR()" class="btn-secondary text-sm">
                                            👁️ Preview
                                        </button>
                                        <button onclick="copyPayload()" class="btn-secondary text-sm">
                                            📋 Copy
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="showDownloadMenu()" class="btn-outline text-sm">
                                            📥 Download
                                        </button>
                                        <button onclick="printCard()" class="btn-outline text-sm">
                                            🖨️ Print
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Download Menu (Hidden by default) -->
                                <div id="downloadMenu" class="hidden mb-5 p-4 bg-slate-50 rounded-lg">
                                    <h4 class="text-sm font-bold text-slate-700 mb-3">Download Options</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <button onclick="downloadQR('png', 1024)" class="btn-secondary py-2">PNG 1024px</button>
                                        <button onclick="downloadQR('png', 512)" class="btn-secondary py-2">PNG 512px</button>
                                        <button onclick="downloadQR('pdf', 'a4-6')" class="btn-secondary py-2">PDF A4 (6/page)</button>
                                        <button onclick="downloadQR('pdf', 'a4-12')" class="btn-secondary py-2">PDF A4 (12/page)</button>
                                        <button onclick="downloadQR('pdf', 'letter-6')" class="btn-secondary py-2">PDF Letter (6/page)</button>
                                        <button onclick="downloadQR('pdf', 'letter-12')" class="btn-secondary py-2">PDF Letter (12/page)</button>
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 justify-center mb-5">
                                    <button onclick="rotateCode()" class="btn-secondary text-sm">
                                        🔄 Rotate
                                    </button>
                                    <button onclick="revokeCode()" class="btn-primary text-sm">
                                        🚫 Revoke
                                    </button>
                                </div>
                                
                                <div class="text-center mb-4">
                                    <div class="text-xs text-slate-500 mb-1">Status: <span id="qrStatus" class="text-green-600 font-semibold">Active</span></div>
                                    <div class="text-xs text-slate-500" id="lastRotated">Last rotated: Never</div>
                                </div>
                                
                                <div class="flex justify-center">
                                    <button onclick="toggleQRVoice()" id="voiceBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                                        🔊 Play Voice
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 6: Vault (Documents) -->
                    <div class="glassmorphism p-6 relative">
                        <div class="ribbon vault-ribbon" data-label="VAULT"></div>
                        <h2 class="text-xl font-800 text-slate-900 mb-6 mt-2 tracking-tight">Vault (Documents)</h2>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Coming Soon Tiles -->
                            <div class="p-4 bg-gray-100 rounded-lg opacity-60 cursor-not-allowed">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="text-2xl mr-3">📄</div>
                                        <div>
                                            <h4 class="font-semibold text-gray-700">DNR Directive</h4>
                                            <p class="text-sm text-gray-500">Do Not Resuscitate orders</p>
                                        </div>
                                    </div>
                                    <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded">Coming Soon</span>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gray-100 rounded-lg opacity-60 cursor-not-allowed">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="text-2xl mr-3">📋</div>
                                        <div>
                                            <h4 class="font-semibold text-gray-700">Living Will</h4>
                                            <p class="text-sm text-gray-500">Advanced healthcare directives</p>
                                        </div>
                                    </div>
                                    <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded">Coming Soon</span>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gray-100 rounded-lg opacity-60 cursor-not-allowed">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="text-2xl mr-3">🏥</div>
                                        <div>
                                            <h4 class="font-semibold text-gray-700">Insurance Cards</h4>
                                            <p class="text-sm text-gray-500">Health insurance information</p>
                                        </div>
                                    </div>
                                    <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded">Coming Soon</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-purple-50 rounded-lg">
                            <p class="text-sm text-purple-700">
                                <strong>🔒 Secure Document Storage</strong><br>
                                Upload and encrypt your important medical documents for emergency access.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Account Card -->
            <div class="max-w-md mx-auto mt-12">
                <div class="glassmorphism rounded-xl p-6 border-red-200">
                    <h3 class="text-lg font-bold text-red-800 mb-4">⚠️ Danger Zone</h3>
                    <p class="text-sm text-gray-600 mb-4">This action cannot be undone. All your data and QR codes will be permanently deleted.</p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type "DELETE MY ACCOUNT" to confirm:</label>
                        <input type="text" id="deleteConfirmation" class="w-full px-4 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="DELETE MY ACCOUNT">
                    </div>
                    
                    <button onclick="deleteAccount()" id="deleteAccountBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                        Delete Account
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <footer class="mt-16 text-center text-sm text-gray-500">
                <div class="max-w-4xl mx-auto space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-800 mb-2">🔒 Privacy & Security</h4>
                            <p class="text-blue-700 text-xs">Your medical data is encrypted and stored securely. Only you control access.</p>
                        </div>
                        
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-bold text-red-800 mb-2">⚕️ Medical Disclaimer</h4>
                            <p class="text-red-700 text-xs">Informational only. Emergency responders must verify all medical information.</p>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-green-800 mb-2">📞 Support</h4>
                            <p class="text-green-700 text-xs">Contact support 24/7 for assistance with your emergency codes.</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <p>© 2024 MYQER™. All rights reserved. | <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a> | <a href="#" class="text-blue-600 hover:underline">Terms of Service</a> | <a href="#" class="text-blue-600 hover:underline">Support</a></p>
                    </div>
                </div>
            </footer>
        </div>

        <!-- Emergency View -->
        <div id="emergency-view" class="emergency-view hidden">
            <div class="container mx-auto px-4 py-8 flex items-center justify-center min-h-screen">
                <div class="emergency-card p-8 max-w-2xl w-full">
                    <!-- Offline Banner -->
                    <div id="offlineBanner" class="offline-banner hidden">
                        📡 Offline copy — status unknown. Connect to verify latest.
                    </div>
                    
                    <div id="emergencyContent">
                        <!-- Emergency content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentProfile = null;
        let currentQRCode = null;
        let supabase = null;
        let isDemo = true; // Start in demo mode
        let iceContactCount = 0;
        let debounceTimer = null;
        let currentUtterance = null;
        let isOffline = false;
        let serviceWorker = null;

        // Initialize Supabase
        try {
            supabase = window.supabase.createClient(
                'https://tgddpmxpbgrzrbzpomou.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM'
            );
            console.log('Supabase initialized successfully');
        } catch (error) {
            console.warn('Supabase initialization failed, using demo mode:', error);
            isDemo = true;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize PWA
            initializePWA();
            
            // Setup offline detection
            setupOfflineDetection();
            
            // Load saved QR mode
            const savedMode = localStorage.getItem('myqer_qr_mode');
            if (savedMode) {
                document.getElementById('qrMode').value = savedMode;
            }
            
            // Load saved offline caching preference
            const offlineCaching = localStorage.getItem('myqer_offline_caching');
            if (offlineCaching !== null) {
                document.getElementById('offlineCaching').checked = offlineCaching === 'true';
            }
            
            loadProfile();
            
            // Add initial ICE contact if none exist
            if (iceContactCount === 0) {
                addICEContact();
            }
            
            // Check if we're viewing an emergency code
            const urlPath = window.location.pathname;
            const qrMatch = urlPath.match(/\/qr\/([a-zA-Z0-9]+)/);
            if (qrMatch) {
                showEmergencyView(qrMatch[1]);
            }
        });
        
        // PWA Initialization
        function initializePWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        serviceWorker = registration;
                        console.log('Service Worker registered successfully');
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showNotification('App updated! Refresh to use the latest version.', 'info');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.warn('Service Worker registration failed:', error);
                    });
            }
        }
        
        // Offline Detection
        function setupOfflineDetection() {
            function updateOnlineStatus() {
                isOffline = !navigator.onLine;
                
                if (isOffline) {
                    document.getElementById('offlineBanner')?.classList.remove('hidden');
                } else {
                    document.getElementById('offlineBanner')?.classList.add('hidden');
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }
        
        // Handle offline caching toggle
        function handleOfflineCachingToggle() {
            const enabled = document.getElementById('offlineCaching').checked;
            localStorage.setItem('myqer_offline_caching', enabled.toString());
            
            if (enabled) {
                showNotification('Offline caching enabled for emergency access.', 'success');
            } else {
                showNotification('Offline caching disabled.', 'info');
                // Clear cached emergency data
                if (serviceWorker) {
                    serviceWorker.active?.postMessage({ action: 'clearEmergencyCache' });
                }
            }
        }

        // Profile management
        function loadProfile() {
            if (isDemo) {
                const demoData = localStorage.getItem('myqer_demo_data');
                if (demoData) {
                    currentProfile = JSON.parse(demoData);
                    populateForm();
                }
            }
            // TODO: Load from Supabase when not in demo mode
        }

        function populateForm() {
            if (!currentProfile) return;
            
            document.getElementById('fullName').value = currentProfile.display_name || '';
            document.getElementById('dob').value = currentProfile.dob || '';
            document.getElementById('country').value = currentProfile.country || '';
            document.getElementById('nationalId').value = currentProfile.national_id || '';
            document.getElementById('bloodType').value = currentProfile.blood_type || '';
            document.getElementById('organDonor').value = currentProfile.organ_donor || '';
            document.getElementById('allergies').value = (currentProfile.allergies || []).join(', ');
            document.getElementById('conditions').value = (currentProfile.conditions || []).join(', ');
            document.getElementById('medications').value = (currentProfile.medications || []).join(', ');
            document.getElementById('lifeSupportPref').value = currentProfile.life_support_pref || '';
            document.getElementById('vaultNotes').value = currentProfile.vault_notes || '';
            document.getElementById('languagePref').value = currentProfile.language_pref || 'en';
            
            // Populate ICE contacts
            const iceContainer = document.getElementById('iceContacts');
            iceContainer.innerHTML = '';
            if (currentProfile.ice_contacts && currentProfile.ice_contacts.length > 0) {
                currentProfile.ice_contacts.forEach((contact, index) => {
                    addICEContact(contact);
                });
            } else {
                addICEContact();
            }
            
            updateGenerateCodeCTA();
            recalculateTriage();
            
            if (currentProfile.qr_code) {
                currentQRCode = currentProfile.qr_code;
                showQRCode();
            }
        }

        function saveIdentity() {
            const profile = getCurrentProfile();
            profile.display_name = document.getElementById('fullName').value;
            profile.dob = document.getElementById('dob').value;
            profile.country = document.getElementById('country').value;
            profile.national_id = document.getElementById('nationalId').value;
            profile.last_updated_at = new Date().toISOString();
            
            saveProfile(profile);
            updateGenerateCodeCTA();
            showNotification('Identity saved successfully!', 'success');
        }

        function saveCritical() {
            const profile = getCurrentProfile();
            profile.blood_type = document.getElementById('bloodType').value;
            profile.organ_donor = document.getElementById('organDonor').value;
            profile.allergies = document.getElementById('allergies').value.split(',').map(s => s.trim()).filter(s => s);
            profile.conditions = document.getElementById('conditions').value.split(',').map(s => s.trim()).filter(s => s);
            profile.medications = document.getElementById('medications').value.split(',').map(s => s.trim()).filter(s => s);
            profile.life_support_pref = document.getElementById('lifeSupportPref').value;
            profile.last_updated_at = new Date().toISOString();
            
            saveProfile(profile);
            recalculateTriage();
            showNotification('Critical medical info saved!', 'success');
        }

        function saveICE() {
            const profile = getCurrentProfile();
            const iceContacts = [];
            
            document.querySelectorAll('.ice-contact').forEach(contactDiv => {
                const name = contactDiv.querySelector('.ice-name').value;
                const relation = contactDiv.querySelector('.ice-relation').value;
                const phone = contactDiv.querySelector('.ice-phone').value;
                
                if (name && phone) {
                    iceContacts.push({ name, relation, phone });
                }
            });
            
            profile.ice_contacts = iceContacts;
            profile.last_updated_at = new Date().toISOString();
            
            saveProfile(profile);
            showNotification('ICE contacts saved!', 'success');
        }

        function saveVault() {
            const profile = getCurrentProfile();
            profile.vault_notes = document.getElementById('vaultNotes').value;
            profile.language_pref = document.getElementById('languagePref').value;
            profile.last_updated_at = new Date().toISOString();
            
            saveProfile(profile);
            showNotification('Vault data saved!', 'success');
        }

        function getCurrentProfile() {
            if (!currentProfile) {
                currentProfile = {
                    id: 'demo-' + Date.now(),
                    emergency_view_enabled: true,
                    created_at: new Date().toISOString()
                };
            }
            return currentProfile;
        }

        function saveProfile(profile) {
            currentProfile = profile;
            
            if (isDemo) {
                localStorage.setItem('myqer_demo_data', JSON.stringify(profile));
            } else {
                // TODO: Save to Supabase
            }
        }

        // ICE Contact management
        function addICEContact(contact = null) {
            if (iceContactCount >= 3) {
                showNotification('Maximum 3 ICE contacts allowed.', 'warning');
                return;
            }
            
            const container = document.getElementById('iceContacts');
            const contactDiv = document.createElement('div');
            contactDiv.className = 'ice-contact p-4 border border-gray-200 rounded-lg';
            
            contactDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" class="ice-name px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500" placeholder="Name" value="${contact?.name || ''}" oninput="debounceAutoSave()">
                    <input type="text" class="ice-relation px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500" placeholder="Relation" value="${contact?.relation || ''}" oninput="debounceAutoSave()">
                    <div class="flex gap-2">
                        <input type="tel" class="ice-phone flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500" placeholder="Phone (E.164)" value="${contact?.phone || ''}" oninput="formatPhoneNumber(this); debounceAutoSave()">
                        <button onclick="removeICEContact(this)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition-colors">×</button>
                    </div>
                </div>
            `;
            
            container.appendChild(contactDiv);
            iceContactCount++;
            updateICECounter();
            updateAddICEButton();
        }

        function removeICEContact(button) {
            button.closest('.ice-contact').remove();
            iceContactCount--;
            updateICECounter();
            updateAddICEButton();
            debounceAutoSave();
        }
        
        function updateICECounter() {
            document.getElementById('iceCounter').textContent = `${iceContactCount}/3 contacts`;
        }
        
        function updateAddICEButton() {
            const addBtn = document.getElementById('addICEBtn');
            if (iceContactCount >= 3) {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            
            // Add country code if not present
            if (value.length > 0 && !value.startsWith('1') && value.length === 10) {
                value = '1' + value; // Assume US/Canada
            }
            
            // Format as E.164
            if (value.length > 0) {
                input.value = '+' + value;
            }
        }
        
        function debounceAutoSave() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                saveICE();
            }, 1000);
        }

        // Triage calculation
        function recalculateTriage() {
            const override = document.getElementById('triageOverride').value;
            
            if (override !== 'auto') {
                setTriageResult(override.toUpperCase(), getTriageDescription(override), `triage-${override}`);
                return;
            }
            
            const profile = getCurrentProfile();
            let color = 'green';
            let description = 'Standard emergency protocols apply.';
            
            // Check for BLACK conditions first
            if (profile.life_support_pref === 'dnr' || profile.life_support_pref === 'comfort') {
                color = 'black';
                description = 'Comfort care or DNR directive in place.';
            }
            // Check for RED conditions
            else if (hasRedConditions(profile)) {
                color = 'red';
                description = 'Critical conditions requiring immediate attention.';
            }
            // Check for AMBER conditions
            else if (hasAmberConditions(profile)) {
                color = 'amber';
                description = 'Medical conditions present - monitor closely.';
            }
            
            setTriageResult(color.toUpperCase(), description, `triage-${color}`);
            
            // Save to profile
            profile.triage_color = color;
            profile.triage_description = description;
        }
        
        function hasRedConditions(profile) {
            const redKeywords = [
                'anaphylaxis', 'anaphylactic', 'epipen', 'severe',
                'seizure disorder', 'insulin pump', 'anticoagulant', 'pacemaker'
            ];
            
            const allText = [
                ...(profile.allergies || []),
                ...(profile.conditions || []),
                ...(profile.medications || [])
            ].join(' ').toLowerCase();
            
            return redKeywords.some(keyword => allText.includes(keyword));
        }
        
        function hasAmberConditions(profile) {
            return (profile.allergies && profile.allergies.length > 0) || 
                   (profile.conditions && profile.conditions.length > 0);
        }
        
        function setTriageResult(color, description, className) {
            const resultElement = document.getElementById('triageResult');
            const descElement = document.getElementById('triageDescription');
            
            resultElement.textContent = color;
            resultElement.className = `triage-pill ${className} inline-block mb-4`;
            descElement.textContent = description;
        }
        
        function getTriageDescription(color) {
            switch(color) {
                case 'black': return 'Expectant - comfort care priority.';
                case 'red': return 'Emergency - immediate treatment required.';
                case 'amber': return 'Urgent - treatment within 10 minutes.';
                case 'green': return 'Standard - treatment within 60 minutes.';
                default: return 'Standard emergency protocols apply.';
            }
        }
        
        function handleTriageOverride() {
            recalculateTriage();
            const profile = getCurrentProfile();
            profile.triage_override = document.getElementById('triageOverride').value;
            saveProfile(profile);
        }

        // QR Code management
        function updateGenerateCodeCTA() {
            const profile = getCurrentProfile();
            const hasBasicInfo = profile.display_name && profile.dob && profile.country;
            const ctaElement = document.getElementById('generateCodeCTA');
            
            if (hasBasicInfo && !currentQRCode) {
                ctaElement.classList.remove('hidden');
            } else {
                ctaElement.classList.add('hidden');
            }
        }

        function generateEmergencyCode() {
            const profile = getCurrentProfile();
            
            if (!profile.display_name || !profile.dob || !profile.country) {
                showNotification('Please complete your identity information first.', 'error');
                return;
            }
            
            // Generate tokens
            const publicToken = generateSecureToken();
            const ownerCode = generateOwnerCode();
            
            currentQRCode = {
                id: 'qr-' + Date.now(),
                profile_id: profile.id,
                public_token: publicToken,
                owner_code: ownerCode,
                status: 'active',
                created_at: new Date().toISOString(),
                last_rotated_at: new Date().toISOString()
            };
            
            profile.qr_code = currentQRCode;
            saveProfile(profile);
            showQRCode();
            showNotification('Emergency QR code generated successfully!', 'success');
        }
        
        function generateOwnerCode() {
            // Base36 uppercase: 0-9, A-Z (36 characters total)
            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = 'MYQER-';
            for (let i = 0; i < 7; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function generateSecureToken() {
            // 22-32 random chars for public token
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const length = 22 + Math.floor(Math.random() * 11); // 22-32 chars
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showQRCode() {
            if (!currentQRCode) return;
            
            document.getElementById('noCodeState').classList.add('hidden');
            document.getElementById('hasCodeState').classList.remove('hidden');
            
            // Update owner code display
            document.getElementById('ownerCode').textContent = currentQRCode.owner_code;
            
            // Update QR mode badge
            updateQRBadge();
            
            // Generate QR code with current mode
            generateQRWithMode();
        }
        
        function updateQRBadge() {
            const mode = getQRMode();
            const badge = document.getElementById('qrBadge');
            const description = document.getElementById('qrDescription');
            
            switch(mode) {
                case 'hybrid':
                    badge.textContent = 'Hybrid QR';
                    badge.className = 'inline-block px-4 py-2 text-sm font-semibold rounded-full bg-gradient-to-r from-yellow-400 to-yellow-600 text-white shadow-lg';
                    description.textContent = 'Contains medical essentials + online link';
                    break;
                case 'offline':
                    badge.textContent = 'Offline QR';
                    badge.className = 'inline-block px-4 py-2 text-sm font-semibold rounded-full bg-gradient-to-r from-green-400 to-green-600 text-white shadow-lg';
                    description.textContent = 'Compact essentials only, no link';
                    break;
                case 'url':
                    badge.textContent = 'Link QR';
                    badge.className = 'inline-block px-4 py-2 text-sm font-semibold rounded-full bg-gradient-to-r from-slate-400 to-slate-600 text-white shadow-lg';
                    description.textContent = 'Smallest code - link only';
                    break;
            }
        }
        
        function showDownloadMenu() {
            const menu = document.getElementById('downloadMenu');
            menu.classList.toggle('hidden');
        }
        
        function toggleQRVoice() {
            const btn = document.getElementById('voiceBtn');
            
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                btn.textContent = '🔊 Play Voice';
            } else {
                playQRVoice();
            }
        }
        
        function generateQRWithMode() {
            const mode = getQRMode();
            const payload = generateQRPayload(mode);
            
            const canvas = document.getElementById('qrCanvas');
            QRCode.toCanvas(canvas, payload, {
                width: 200,
                margin: 3,
                errorCorrectionLevel: 'M',
                color: {
                    dark: '#1e293b',
                    light: '#ffffff'
                }
            }, function (error) {
                if (error) console.error('QR Code generation error:', error);
            });
        }
        
        function generateQRPayload(mode) {
            const profile = getCurrentProfile();
            const url = `https://myqer.com/qr/${currentQRCode.public_token}`;
            
            if (mode === 'url') {
                return url;
            }
            
            // Build hybrid/offline payload with smart truncation
            let payload = '';
            
            if (profile.display_name) {
                payload += `Name: ${profile.display_name}`;
            }
            
            if (profile.dob) {
                const dobFormatted = new Date(profile.dob).toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                payload += ` | DOB: ${dobFormatted}`;
            }
            
            if (profile.blood_type) {
                payload += ` | Blood: ${profile.blood_type}`;
            }
            
            if (profile.allergies && profile.allergies.length > 0) {
                const allergiesText = profile.allergies.join(', ');
                payload += ` | Allergies: ${allergiesText}`;
            }
            
            if (profile.conditions && profile.conditions.length > 0) {
                const conditionsText = profile.conditions.join(', ');
                // Truncate conditions to ≤ 80 chars
                if (conditionsText.length > 80) {
                    payload += ` | Conditions: ${conditionsText.substring(0, 77)}...`;
                } else {
                    payload += ` | Conditions: ${conditionsText}`;
                }
            }
            
            if (profile.medications && profile.medications.length > 0) {
                const meds = profile.medications;
                // Show first 2 medications, then "+ more"
                if (meds.length > 2) {
                    payload += ` | Meds: ${meds.slice(0, 2).join(', ')} + more`;
                } else {
                    payload += ` | Meds: ${meds.join(', ')}`;
                }
            }
            
            if (profile.organ_donor === 'yes') {
                payload += ' | Organ Donor: Yes';
            }
            
            if (profile.ice_contacts && profile.ice_contacts.length > 0) {
                const primaryICE = profile.ice_contacts[0];
                payload += ` | ICE: ${primaryICE.name} (${primaryICE.phone})`;
            }
            
            if (mode === 'hybrid') {
                payload += ` | Link: ${url}`;
            }
            
            return payload;
        }
        
        function getQRMode() {
            const saved = localStorage.getItem('myqer_qr_mode');
            return saved || document.getElementById('qrMode').value || 'hybrid';
        }
        
        function handleQRModeChange() {
            const mode = document.getElementById('qrMode').value;
            localStorage.setItem('myqer_qr_mode', mode);
            
            if (currentQRCode) {
                updateQRBadge();
                generateQRWithMode();
            }
        }

        function previewQR() {
            if (!currentQRCode) return;
            const url = `https://myqer.com/qr/${currentQRCode.public_token}`;
            window.open(url, '_blank');
        }
        
        function copyPayload() {
            const mode = getQRMode();
            const payload = generateQRPayload(mode);
            
            navigator.clipboard.writeText(payload).then(() => {
                showNotification('QR payload copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy payload.', 'error');
            });
        }

        function downloadQR(format, size) {
            const mode = getQRMode();
            const payload = generateQRPayload(mode);
            
            if (format === 'png') {
                downloadPNG(payload, size);
            } else if (format === 'pdf') {
                downloadPDF(payload, size);
            }
        }
        
        function downloadPNG(payload, size) {
            const tempCanvas = document.createElement('canvas');
            
            QRCode.toCanvas(tempCanvas, payload, {
                width: size,
                margin: 4,
                errorCorrectionLevel: 'M',
                color: {
                    dark: '#1e293b',
                    light: '#ffffff'
                }
            }, function (error) {
                if (!error) {
                    const link = document.createElement('a');
                    link.download = `myqer-${currentQRCode.owner_code}-${size}px.png`;
                    link.href = tempCanvas.toDataURL();
                    link.click();
                    showNotification(`PNG ${size}px downloaded!`, 'success');
                    document.getElementById('downloadMenu').classList.add('hidden');
                }
            });
        }
        
        function downloadPDF(payload, layout) {
            // Create a simple PDF with multiple QR codes
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Determine layout
            const isA4 = layout.includes('a4');
            const codesPerPage = layout.includes('12') ? 12 : 6;
            
            // Set canvas size (A4: 595x842, Letter: 612x792 at 72 DPI)
            canvas.width = isA4 ? 595 : 612;
            canvas.height = isA4 ? 842 : 792;
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Generate QR codes in grid
            const cols = codesPerPage === 12 ? 3 : 2;
            const rows = codesPerPage === 12 ? 4 : 3;
            const qrSize = codesPerPage === 12 ? 120 : 180;
            const margin = 40;
            
            let completed = 0;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = margin + col * (qrSize + margin);
                    const y = margin + row * (qrSize + margin * 2);
                    
                    // Create QR code
                    QRCode.toCanvas(document.createElement('canvas'), payload, {
                        width: qrSize,
                        margin: 2,
                        errorCorrectionLevel: 'M',
                        color: {
                            dark: '#1e293b',
                            light: '#ffffff'
                        }
                    }, function (error, qrCanvas) {
                        if (!error) {
                            ctx.drawImage(qrCanvas, x, y);
                            
                            // Add MYQER text and owner code
                            ctx.fillStyle = '#1e293b';
                            ctx.font = 'bold 12px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('MYQER™', x + qrSize/2, y + qrSize + 15);
                            
                            ctx.font = '10px monospace';
                            ctx.fillText(currentQRCode.owner_code, x + qrSize/2, y + qrSize + 30);
                            
                            completed++;
                            if (completed === codesPerPage) {
                                // Download PDF
                                const link = document.createElement('a');
                                link.download = `myqer-${currentQRCode.owner_code}-${layout}.pdf`;
                                link.href = canvas.toDataURL('image/png');
                                
                                // Convert to PDF (simplified - in real app would use jsPDF)
                                const dataUrl = canvas.toDataURL('image/png');
                                link.href = dataUrl;
                                link.click();
                                
                                showNotification(`PDF ${layout} downloaded!`, 'success');
                                document.getElementById('downloadMenu').classList.add('hidden');
                            }
                        }
                    });
                }
            }
        }

        function printCard() {
            const canvas = document.getElementById('qrCanvas');
            const profile = getCurrentProfile();
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>MYQER Emergency Card</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .card { border: 2px solid #1e293b; border-radius: 12px; padding: 20px; max-width: 400px; margin: 0 auto; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .logo { font-size: 24px; font-weight: bold; }
                            .qr-section { text-align: center; margin: 20px 0; }
                            .qr-code { width: 240px; height: 240px; }
                            .triage { display: inline-block; padding: 4px 12px; border-radius: 20px; font-weight: bold; color: white; }
                            .triage-${profile.triage_color || 'green'} { background: ${getTriageColor(profile.triage_color || 'green')}; }
                            .owner-code { font-family: monospace; font-size: 18px; font-weight: bold; }
                            .instructions { font-size: 12px; margin-top: 20px; }
                        </style>
                    </head>
                    <body>
                        <div class="card">
                            <div class="header">
                                <div class="logo">MYQ<span style="color: #dc2626;">ER</span>™</div>
                                <div class="triage triage-${profile.triage_color || 'green'}">${(profile.triage_color || 'green').toUpperCase()}</div>
                            </div>
                            
                            <div class="qr-section">
                                <img src="${canvas.toDataURL()}" class="qr-code" alt="Emergency QR Code">
                                <div class="owner-code">${currentQRCode.owner_code}</div>
                            </div>
                            
                            <div class="instructions">
                                <p><strong>Emergency QR Code</strong></p>
                                <p>Scan to access medical information</p>
                                <p>Keep with ID or medical bracelet</p>
                            </div>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function getTriageColor(color) {
            switch(color) {
                case 'green': return '#22c55e';
                case 'amber': return '#f59e0b';
                case 'red': return '#ef4444';
                case 'black': return '#1f2937';
                default: return '#22c55e';
            }
        }

        function playQRVoice() {
            const profile = getCurrentProfile();
            const mode = getQRMode();
            
            if ('speechSynthesis' in window) {
                // Stop any current speech
                window.speechSynthesis.cancel();
                
                let text = '';
                
                if (mode === 'url') {
                    text = `Emergency QR code for ${profile.display_name || 'patient'}. Scan code or visit link for full medical information.`;
                } else {
                    text = generateVoiceText(profile);
                }
                
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.rate = 0.8;
                currentUtterance.pitch = 1.1;
                currentUtterance.volume = 1;
                
                // Try to use a gentle female voice
                const voices = window.speechSynthesis.getVoices();
                const femaleVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('female') || 
                    voice.name.toLowerCase().includes('samantha') ||
                    voice.name.toLowerCase().includes('karen') ||
                    voice.name.toLowerCase().includes('zira') ||
                    voice.name.toLowerCase().includes('susan')
                );
                if (femaleVoice) {
                    currentUtterance.voice = femaleVoice;
                }
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.textContent = '⏸️ Pause Voice';
                
                currentUtterance.onend = () => {
                    voiceBtn.textContent = '🔊 Play Voice';
                };
                
                window.speechSynthesis.speak(currentUtterance);
                showNotification('Playing emergency information...', 'info');
            } else {
                showNotification('Voice synthesis not supported.', 'error');
            }
        }
        
        function generateVoiceText(profile) {
            let text = `Emergency information for ${profile.display_name || 'patient'}. `;
            
            if (profile.triage_color) {
                text += `Triage priority: ${profile.triage_color}. `;
            }
            
            if (profile.blood_type) {
                text += `Blood type: ${profile.blood_type}. `;
            }
            
            if (profile.allergies && profile.allergies.length > 0) {
                text += `Critical allergies: ${profile.allergies.slice(0, 3).join(', ')}. `;
            }
            
            if (profile.conditions && profile.conditions.length > 0) {
                text += `Medical conditions: ${profile.conditions.slice(0, 3).join(', ')}. `;
            }
            
            if (profile.ice_contacts && profile.ice_contacts.length > 0) {
                const contact = profile.ice_contacts[0];
                text += `Emergency contact: ${contact.name}, ${contact.relation}, ${contact.phone}. `;
            }
            
            return text;
        }

        function rotateCode() {
            if (!currentQRCode) return;
            
            if (confirm('This will generate a new QR code and invalidate the old one. Continue?')) {
                const newToken = generateSecureToken();
                currentQRCode.public_token = newToken;
                currentQRCode.last_rotated_at = new Date().toISOString();
                
                const profile = getCurrentProfile();
                profile.qr_code = currentQRCode;
                saveProfile(profile);
                
                // Update last rotated display
                const rotatedDate = new Date(currentQRCode.last_rotated_at).toLocaleDateString();
                document.getElementById('lastRotated').textContent = `Last rotated: ${rotatedDate}`;
                
                showQRCode();
                showNotification('QR code rotated successfully! Old code valid for 24h.', 'success');
            }
        }

        function revokeCode() {
            if (!currentQRCode) return;
            
            if (confirm('This will permanently revoke your QR code. You can generate a new one later. Continue?')) {
                currentQRCode.status = 'revoked';
                currentQRCode.revoked_at = new Date().toISOString();
                
                const profile = getCurrentProfile();
                profile.qr_code = currentQRCode;
                saveProfile(profile);
                
                // Update status display
                document.getElementById('qrStatus').textContent = 'Revoked';
                document.getElementById('qrStatus').className = 'text-red-600 font-semibold';
                
                // Hide code after delay
                setTimeout(() => {
                    currentQRCode = null;
                    document.getElementById('hasCodeState').classList.add('hidden');
                    document.getElementById('noCodeState').classList.remove('hidden');
                    updateGenerateCodeCTA();
                }, 2000);
                
                showNotification('QR code revoked successfully!', 'success');
            }
        }

        // Emergency view
        function showEmergencyView(token) {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('emergency-view').classList.remove('hidden');
            
            // Load emergency data for token
            loadEmergencyData(token);
        }

        function loadEmergencyData(token) {
            // In demo mode, check if token matches current profile
            if (isDemo && currentProfile && currentProfile.qr_code && currentProfile.qr_code.public_token === token) {
                if (currentProfile.qr_code.status === 'revoked') {
                    showRevokedMessage();
                } else {
                    displayEmergencyInfo(currentProfile);
                }
            } else {
                showNotFoundMessage();
            }
        }

        function displayEmergencyInfo(profile) {
            const content = document.getElementById('emergencyContent');
            const lastUpdated = new Date(profile.last_updated_at || profile.created_at).toLocaleDateString();
            
            content.innerHTML = `
                <div class="text-center mb-8">
                    <h1 class="text-4xl md:text-6xl font-bold text-gray-900 mb-2">${profile.display_name || 'Emergency Contact'}</h1>
                    <p class="text-xl text-gray-600">DOB: ${profile.dob ? new Date(profile.dob).toLocaleDateString() : 'Not provided'}</p>
                    ${profile.triage_level ? `<div class="mt-4"><span class="triage-pill ${getTriage ClassName(profile.triage_level)}">${profile.triage_level}</span></div>` : ''}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    ${profile.allergies && profile.allergies.length > 0 ? `
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-red-800 mb-2">⚠️ ALLERGIES</h3>
                            <p class="text-red-700">${profile.allergies.join(', ')}</p>
                        </div>
                    ` : ''}
                    
                    ${profile.conditions && profile.conditions.length > 0 ? `
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-orange-800 mb-2">🏥 CONDITIONS</h3>
                            <p class="text-orange-700">${profile.conditions.join(', ')}</p>
                        </div>
                    ` : ''}
                    
                    ${profile.medications && profile.medications.length > 0 ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-blue-800 mb-2">💊 MEDICATIONS</h3>
                            <p class="text-blue-700">${profile.medications.join(', ')}</p>
                        </div>
                    ` : ''}
                    
                    ${profile.blood_type ? `
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-purple-800 mb-2">🩸 BLOOD TYPE</h3>
                            <p class="text-purple-700 text-2xl font-bold">${profile.blood_type}</p>
                        </div>
                    ` : ''}
                </div>
                
                ${profile.ice_contacts && profile.ice_contacts.length > 0 ? `
                    <div class="bg-green-50 p-6 rounded-lg mb-6">
                        <h3 class="text-xl font-bold text-green-800 mb-4">📞 EMERGENCY CONTACTS</h3>
                        <div class="space-y-3">
                            ${profile.ice_contacts.map(contact => `
                                <div class="flex justify-between items-center bg-white p-3 rounded">
                                    <div>
                                        <p class="font-semibold">${contact.name}</p>
                                        <p class="text-sm text-gray-600">${contact.relation}</p>
                                    </div>
                                    <a href="tel:${contact.phone}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">
                                        Call ${contact.phone}
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="text-center">
                    <p class="text-sm text-gray-500 mb-4">Last updated: ${lastUpdated}</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="playEmergencyInfo()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                            🔊 Play Audio
                        </button>
                        <button onclick="pauseEmergencyInfo()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold">
                            ⏸️ Pause
                        </button>
                    </div>
                </div>
            `;
        }

        function getTriageClassName(level) {
            switch(level) {
                case 'Critical Priority': return 'triage-critical';
                case 'High Priority': return 'triage-high';
                case 'Medium Priority': return 'triage-medium';
                default: return 'triage-low';
            }
        }

        function showRevokedMessage() {
            const content = document.getElementById('emergencyContent');
            content.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">🚫</div>
                    <h1 class="text-3xl font-bold text-red-600 mb-4">MYQER Code Revoked</h1>
                    <p class="text-lg text-gray-600 mb-6">This MYQER code has been revoked.</p>
                    <div class="bg-red-50 p-6 rounded-lg border-l-4 border-red-400">
                        <h3 class="font-bold text-red-800 mb-3">🚨 Emergency Instructions:</h3>
                        <p class="text-red-700 mb-3">If this is an emergency, call local emergency services and check for medical ID/wristband.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="text-center p-3 bg-white rounded">
                                <div class="text-2xl mb-2">🚑</div>
                                <p class="text-sm font-semibold">Call 911</p>
                                <p class="text-xs text-gray-600">Emergency Services</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded">
                                <div class="text-2xl mb-2">🆔</div>
                                <p class="text-sm font-semibold">Check ID</p>
                                <p class="text-xs text-gray-600">Wallet/Purse</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded">
                                <div class="text-2xl mb-2">⌚</div>
                                <p class="text-sm font-semibold">Medical Alert</p>
                                <p class="text-xs text-gray-600">Bracelet/Necklace</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showNotFoundMessage() {
            const content = document.getElementById('emergencyContent');
            content.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">❓</div>
                    <h1 class="text-3xl font-bold text-gray-600 mb-4">Code Not Found</h1>
                    <p class="text-lg text-gray-600 mb-6">This emergency QR code could not be found or may have expired.</p>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-800 mb-2">For Emergency Responders:</h3>
                        <p class="text-blue-700">Please follow standard emergency protocols. Contact emergency services if needed.</p>
                    </div>
                </div>
            `;
        }

        // Audio functionality
        let speechSynthesis = null;
        let currentUtterance = null;

        function playEmergencyInfo() {
            if (!currentProfile) return;
            
            if ('speechSynthesis' in window) {
                speechSynthesis = window.speechSynthesis;
                
                let text = `Emergency information for ${currentProfile.display_name || 'patient'}. `;
                
                if (currentProfile.dob) {
                    text += `Date of birth: ${new Date(currentProfile.dob).toLocaleDateString()}. `;
                }
                
                if (currentProfile.blood_type) {
                    text += `Blood type: ${currentProfile.blood_type}. `;
                }
                
                if (currentProfile.allergies && currentProfile.allergies.length > 0) {
                    text += `Allergies: ${currentProfile.allergies.join(', ')}. `;
                }
                
                if (currentProfile.conditions && currentProfile.conditions.length > 0) {
                    text += `Medical conditions: ${currentProfile.conditions.join(', ')}. `;
                }
                
                if (currentProfile.medications && currentProfile.medications.length > 0) {
                    text += `Current medications: ${currentProfile.medications.join(', ')}. `;
                }
                
                if (currentProfile.ice_contacts && currentProfile.ice_contacts.length > 0) {
                    text += `Emergency contacts: `;
                    currentProfile.ice_contacts.forEach(contact => {
                        text += `${contact.name}, ${contact.relation}, phone ${contact.phone}. `;
                    });
                }
                
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.rate = 0.8;
                currentUtterance.pitch = 1;
                currentUtterance.volume = 1;
                
                speechSynthesis.speak(currentUtterance);
                showNotification('Playing emergency information...', 'info');
            } else {
                showNotification('Speech synthesis not supported in this browser.', 'error');
            }
        }

        function pauseEmergencyInfo() {
            if (speechSynthesis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                showNotification('Audio paused.', 'info');
            }
        }

        // Account management
        function deleteAccount() {
            const confirmation = document.getElementById('deleteConfirmation').value;
            
            if (confirmation !== 'DELETE MY ACCOUNT') {
                showNotification('Please type "DELETE MY ACCOUNT" to confirm.', 'error');
                return;
            }
            
            if (isDemo) {
                // Demo mode - clear localStorage
                currentProfile = null;
                currentQRCode = null;
                localStorage.removeItem('myqer_demo_data');
                localStorage.removeItem('myqer_qr_mode');
                
                // Reset form
                document.querySelectorAll('input, select, textarea').forEach(input => {
                    input.value = '';
                });
                
                // Reset UI
                document.getElementById('hasCodeState').classList.add('hidden');
                document.getElementById('noCodeState').classList.remove('hidden');
                document.getElementById('iceContacts').innerHTML = '';
                iceContactCount = 0;
                addICEContact();
                updateICECounter();
                updateAddICEButton();
                
                showNotification('Demo account deleted successfully.', 'success');
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } else {
                // Supabase mode - delete from database
                // TODO: Implement Supabase deletion
                showNotification('Account deletion not implemented for live mode yet.', 'warning');
            }
        }
        
        // Enable delete button when confirmation text is correct
        document.addEventListener('DOMContentLoaded', function() {
            const deleteInput = document.getElementById('deleteConfirmation');
            const deleteBtn = document.getElementById('deleteAccountBtn');
            
            if (deleteInput && deleteBtn) {
                deleteInput.addEventListener('input', function() {
                    if (this.value === 'DELETE MY ACCOUNT') {
                        deleteBtn.disabled = false;
                        deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        deleteBtn.disabled = true;
                        deleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
            }
        });

        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-black' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Service Worker for PWA (basic implementation)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976af2f7a5cb7737',t:'MTc1NjQ1ODk4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
