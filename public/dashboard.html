<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER™ Dashboard - Privacy-first Emergency Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #F5F7FB 0%, #E2E8F0 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 18px 40px rgba(2, 8, 23, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 50px rgba(2, 8, 23, 0.1);
        }
        
        .card-ribbon {
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: 16px 0 0 16px;
        }
        
        .ribbon-identity { background: #10B981; }
        .ribbon-health { background: #dc2626; }
        .ribbon-ice { background: #F59E0B; }
        .ribbon-qr { background: #3B82F6; }
        .ribbon-triage { background: #EAB308; }
        .ribbon-danger { background: #EF4444; }
        .ribbon-vault { background: #8B5CF6; }
        .ribbon-family { background: linear-gradient(135deg, #FF6B9D, #C084FC); }
        .ribbon-silver { background: linear-gradient(135deg, #94A3B8, #64748B); }
        
        .brand-red { color: #dc2626; }
        .bg-brand-red { background-color: #dc2626; }
        
        .triage-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .triage-green { background: #DCFCE7; color: #166534; }
        .triage-amber { background: #FEF3C7; color: #92400E; }
        .triage-red { background: #FEE2E2; color: #991B1B; }
        .triage-black { background: #F3F4F6; color: #374151; }
        
        .btn-primary {
            background: #dc2626;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: #0F172A;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #E5E7EB;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }
        
        .disclaimer {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 8px;
            padding: 16px;
            margin: 24px 0;
        }
        
        input, textarea, select {
            transition: all 0.2s ease;
            min-height: 48px;
            font-size: 16px;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
            padding: 12px 16px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .pill {
            background: #F3F4F6;
            color: #374151;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 2px;
        }
        
        .pill-remove {
            cursor: pointer;
            color: #6B7280;
            font-weight: bold;
        }
        
        .pill-remove:hover {
            color: #EF4444;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { background: #10B981; color: white; }
        .toast.warning { background: #F59E0B; color: white; }
        .toast.error { background: #EF4444; color: white; }
        .toast.info { background: #3B82F6; color: white; }
        
        .qr-container {
            width: 128px;
            height: 128px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            display: grid;
            place-items: center;
            aspect-ratio: 1/1;
            position: relative;
        }
        
        .qr-placeholder {
            text-align: center;
            color: #6B7280;
            font-size: 12px;
            padding: 20px;
        }
        
        .code-display {
            background: #F8FAFC;
            border: 2px dashed #CBD5E1;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            color: #374151;
            letter-spacing: 2px;
        }
        
        .code-display.has-code {
            background: #ECFDF5;
            border-color: #10B981;
            color: #065F46;
        }
        
        .offline-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10B981;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="text-2xl font-bold text-slate-900">
                        MYQ<span class="brand-red">ER</span>™
                    </div>
                    <div class="text-xs text-gray-500 hidden sm:block">
                        Privacy-first. Works offline.
                    </div>
                </div>
                
                <div class="hidden md:block">
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">MYQER (pronounced 'my care')</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="logoutBtn" class="btn-secondary text-sm">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Medical Disclaimer -->
    <div class="max-w-6xl mx-auto px-4 pt-6">
        <div class="disclaimer">
            <div class="font-semibold text-amber-800 mb-2">Medical Disclaimer</div>
            <div class="text-sm text-amber-700">
                This information is for emergency reference only and does not constitute medical advice. Healthcare professionals must independently verify all medical information and make their own clinical assessments. MYQER™ is not responsible for medical decisions made based on this data.
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- Identity Card -->
        <div class="glass-card p-6 mb-6">
            <div class="card-ribbon ribbon-identity"></div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Identity</h2>
            <p class="text-sm text-gray-600 mb-6">These details help responders confirm who you are.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                    <input type="text" id="fullName" class="w-full" placeholder="Enter your full name">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth</label>
                    <input type="date" id="dateOfBirth" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Country</label>
                    <select id="country" class="w-full">
                        <option value="">Select country</option>
                        <option value="US">United States</option>
                        <option value="GB">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="ES">Spain</option>
                        <option value="IT">Italy</option>
                        <option value="NL">Netherlands</option>
                        <option value="SE">Sweden</option>
                        <option value="NO">Norway</option>
                        <option value="DK">Denmark</option>
                        <option value="FI">Finland</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Emergency Code</label>
                    <div id="codeDisplay" class="code-display">
                        <span id="cardCodeDisplay">Complete profile to generate</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between mt-6">
                <div class="text-xs text-gray-500">Auto-saves as you type</div>
                <button id="generateCodeBtn" class="btn-primary">🎲 Generate Emergency Code</button>
            </div>
        </div>

        <!-- Health Profile Card -->
        <div class="glass-card p-6 mb-6">
            <div class="card-ribbon ribbon-health"></div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Health Profile</h2>
            <p class="text-sm text-gray-600 mb-6">Keep this current. It appears on your emergency card.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Blood Type</label>
                    <select id="bloodType" class="w-full">
                        <option value="">Unknown</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Organ Donor</label>
                    <select id="organDonor" class="w-full">
                        <option value="">Not specified</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Critical Allergies</label>
                    <input type="text" id="allergiesInput" class="w-full" placeholder="Type allergy and press Enter (e.g., Penicillin, Nuts)">
                    <div id="allergiesPills" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Medical Conditions</label>
                    <input type="text" id="conditionsInput" class="w-full" placeholder="Type condition and press Enter (e.g., Diabetes, Hypertension)">
                    <div id="conditionsPills" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Current Medications</label>
                    <input type="text" id="medicationsInput" class="w-full" placeholder="Type medication and press Enter (e.g., Insulin, Aspirin)">
                    <div id="medicationsPills" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Life Support Preference</label>
                    <select id="lifeSupportPref" class="w-full">
                        <option value="Full">Full Life Support</option>
                        <option value="Comfort">Comfort Care Only</option>
                        <option value="DNR">Do Not Resuscitate</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ICE Contacts Card -->
        <div class="glass-card p-6 mb-6">
            <div class="card-ribbon ribbon-ice"></div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Emergency Contacts (ICE)</h2>
            <p class="text-sm text-gray-600 mb-6">Add up to 3 trusted contacts.</p>
            
            <div id="iceContacts" class="space-y-4">
                <!-- ICE contacts will be populated here -->
            </div>
            <button id="addIceContact" class="btn-secondary mt-4">Add Contact (0/3)</button>
        </div>

        <!-- Three Column Grid Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Automated Triage Card -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-triage"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2">Automated Triage</h2>
                <p class="text-sm text-gray-600 mb-4">Auto-computed from your health profile.</p>
                
                <div class="text-center mb-4">
                    <div id="triageStatus" class="triage-status triage-green">
                        GREEN - Standard
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Manual Override</label>
                    <select id="triageOverride" class="w-full">
                        <option value="">Auto (Recommended)</option>
                        <option value="Green">Green - Standard</option>
                        <option value="Amber">Amber - Urgent</option>
                        <option value="Red">Red - Immediate</option>
                        <option value="Black">Black - Comfort</option>
                    </select>
                </div>
                
                <p class="text-xs text-gray-500 mb-4">You control what responders see first.</p>
                
                <div class="space-y-2">
                    <button id="speakSummaryBtn" class="btn-secondary w-full text-sm">🔊 Speak Summary</button>
                    <button id="stopSpeakingBtn" class="btn-secondary w-full text-sm" style="display: none;">⏹️ Stop Speaking</button>
                </div>
            </div>

            <!-- Emergency Card & QR -->
            <div class="glass-card p-6">
                <div class="card-ribbon ribbon-qr"></div>
                <h2 class="text-xl font-bold text-slate-900 mb-2">Emergency Card & QR</h2>
                <p class="text-sm text-gray-600 mb-4">Scan to view your emergency information.</p>
                
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <div class="text-lg font-bold text-slate-900">
                            MYQ<span class="brand-red">ER</span>™
                        </div>
                        <div class="text-xs text-gray-500">Emergency QR Card</div>
                    </div>
                    
                    <div id="qrContainer" class="qr-container">
                        <div class="offline-badge">WORKS OFFLINE</div>
                        <canvas id="qrCanvas" width="128" height="128" style="display: none;"></canvas>
                        <div id="qrPlaceholder" class="qr-placeholder">
                            Complete profile to generate QR
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <input type="text" id="cardLink" class="w-full text-xs text-center border border-gray-300 rounded px-2 py-1" readonly placeholder="Card link will appear here">
                        <button id="copyLinkBtn" class="text-xs text-blue-600 hover:text-blue-800 mt-1">Copy Link</button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <button id="viewCardBtn" class="btn-primary w-full">View Emergency Card</button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="exportPngBtn" class="btn-secondary text-sm">Export PNG</button>
                        <button id="printCardBtn" class="btn-secondary text-sm">Print Card</button>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="glass-card p-6 border-red-200">
                <div class="card-ribbon ribbon-danger"></div>
                <h2 class="text-xl font-bold text-red-600 mb-2">Danger Zone</h2>
                <p class="text-sm text-gray-600 mb-4">
                    This permanently deletes your account and all data.
                </p>
                <button id="deleteAccountBtn" class="w-full bg-transparent border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white px-4 py-2 rounded-lg font-semibold transition-all">
                    Delete My Account
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 mt-16">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="text-sm text-gray-600 mb-4 md:mb-0">
                    © 2025 MYQER — Emergency Response QR · GDPR/HIPAA-minded.
                </div>
                <div class="flex gap-6 text-sm">
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors">Privacy</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors">Terms</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors">About</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors">Support</a>
                    <a href="#" class="text-gray-600 hover:text-gray-900 transition-colors">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ========== CONFIGURATION ==========
        const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
        const ORIGIN = window.location.origin;
        
        // Create global Supabase client
        window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========== GLOBAL STATE ==========
        let currentUser = null;
        let currentProfile = null;
        let iceContactCount = 0;
        let pillData = {
            allergies: [],
            conditions: [],
            medications: []
        };
        let currentSpeech = null;

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSession();
            setupEventListeners();
            setupPillInputs();
            await loadUserData();
            updateTriageStatus();
        });

        // ========== SESSION MANAGEMENT ==========
        async function checkSession() {
            try {
                const { data: { session }, error } = await window.sb.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    location.replace('/');
                    return;
                }
                
                if (!session) {
                    location.replace('/');
                    return;
                }
                
                currentUser = session.user;
                console.log('User authenticated:', currentUser.email);
                
            } catch (error) {
                console.error('Session check failed:', error);
                location.replace('/');
            }
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to logout?')) {
                    await window.sb.auth.signOut();
                    location.replace('/');
                }
            });
            
            // Generate code button
            document.getElementById('generateCodeBtn').addEventListener('click', generateEmergencyCode);
            
            // Add ICE contact
            document.getElementById('addIceContact').addEventListener('click', addIceContact);
            
            // Triage override
            document.getElementById('triageOverride').addEventListener('change', updateTriageStatus);
            
            // Speak summary
            document.getElementById('speakSummaryBtn').addEventListener('click', speakSummary);
            document.getElementById('stopSpeakingBtn').addEventListener('click', stopSpeaking);
            
            // QR and card buttons
            document.getElementById('copyLinkBtn').addEventListener('click', copyCardLink);
            document.getElementById('viewCardBtn').addEventListener('click', viewEmergencyCard);
            document.getElementById('exportPngBtn').addEventListener('click', () => exportQR('png'));
            document.getElementById('printCardBtn').addEventListener('click', printEmergencyCard);
            
            // Delete account
            document.getElementById('deleteAccountBtn').addEventListener('click', deleteAccount);
            
            // Auto-save on input with debouncing
            const autoSaveFields = ['fullName', 'dateOfBirth', 'country', 'bloodType', 'organDonor', 'lifeSupportPref'];
            autoSaveFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', debounce(saveProfile, 1000));
                    element.addEventListener('change', debounce(saveProfile, 1000));
                }
            });
        }

        // ========== PILL INPUT SETUP ==========
        function setupPillInputs() {
            const pillInputs = ['allergies', 'conditions', 'medications'];
            
            pillInputs.forEach(type => {
                const input = document.getElementById(`${type}Input`);
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && input.value.trim()) {
                            e.preventDefault();
                            addPill(type, input.value.trim());
                            input.value = '';
                        }
                    });
                }
            });
        }

        // ========== PILL MANAGEMENT ==========
        function addPill(type, value) {
            if (!value || pillData[type].includes(value)) {
                if (pillData[type].includes(value)) {
                    showToast(`"${value}" is already added`, 'warning');
                }
                return;
            }
            
            pillData[type].push(value);
            renderPills(type);
            updateTriageStatus();
            debounce(saveHealthProfile, 1000)();
        }

        function removePill(type, index) {
            const removed = pillData[type][index];
            pillData[type].splice(index, 1);
            renderPills(type);
            updateTriageStatus();
            debounce(saveHealthProfile, 1000)();
            showToast(`Removed ${removed}`, 'success');
        }

        function renderPills(type) {
            const container = document.getElementById(`${type}Pills`);
            if (!container) return;
            
            container.innerHTML = pillData[type].map((pill, index) => `
                <div class="pill">
                    ${pill}
                    <span class="pill-remove" onclick="removePill('${type}', ${index})">×</span>
                </div>
            `).join('');
        }

        // ========== ICE CONTACT MANAGEMENT ==========
        function addIceContact() {
            if (iceContactCount >= 3) {
                showToast('Maximum 3 contacts allowed', 'warning');
                return;
            }
            
            const container = document.getElementById('iceContacts');
            const contactId = `ice_${Date.now()}`;
            
            const contactDiv = document.createElement('div');
            contactDiv.className = 'border border-gray-200 rounded-lg p-4';
            contactDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded contact-name" placeholder="Full name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Relationship</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded contact-relation" placeholder="Spouse, Parent, etc.">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Phone</label>
                        <input type="tel" class="w-full px-2 py-1 border border-gray-300 rounded contact-phone" placeholder="+1234567890" required>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <button class="text-red-600 text-sm hover:text-red-800" onclick="removeIceContact('${contactId}')">
                        Remove Contact
                    </button>
                    <div class="text-xs text-gray-500">Auto-saves on blur</div>
                </div>
            `;
            
            contactDiv.dataset.contactId = contactId;
            container.appendChild(contactDiv);
            iceContactCount++;
            
            // Add event listeners for auto-save
            contactDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('blur', debounce(saveIceContacts, 1000));
            });
            
            updateAddButtonState();
            showToast('Contact added', 'success');
        }

        function removeIceContact(contactId) {
            const contactDiv = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactDiv) {
                contactDiv.remove();
                iceContactCount--;
                updateAddButtonState();
                debounce(saveIceContacts, 1000)();
                showToast('Contact removed', 'success');
            }
        }

        function updateAddButtonState() {
            const addBtn = document.getElementById('addIceContact');
            addBtn.disabled = iceContactCount >= 3;
            addBtn.textContent = iceContactCount >= 3 ? 'Maximum reached (3/3)' : `Add Contact (${iceContactCount}/3)`;
        }

        // ========== EMERGENCY CODE & QR ==========
        async function generateEmergencyCode() {
            try {
                const fullName = document.getElementById('fullName').value.trim();
                const dateOfBirth = document.getElementById('dateOfBirth').value;
                const country = document.getElementById('country').value;
                
                if (!fullName || !dateOfBirth || !country) {
                    showToast('Please complete your profile first (Name, Date of Birth, Country)', 'warning');
                    return;
                }
                
                const code = 'MYQER-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                
                // Save to database
                const { error } = await window.sb
                    .from('profiles')
                    .upsert({
                        id: currentUser.id,
                        email: currentUser.email,
                        full_name: fullName,
                        country: country,
                        date_of_birth: dateOfBirth,
                        code: code
                    });
                
                if (error) {
                    console.error('Error saving code:', error);
                    showToast('Failed to generate code', 'error');
                    return;
                }
                
                currentProfile = { ...currentProfile, code };
                
                document.getElementById('cardCodeDisplay').textContent = code;
                document.getElementById('codeDisplay').classList.add('has-code');
                
                updateCardLink(code);
                generateQRCode();
                
                showToast('Emergency code generated successfully!', 'success');
                
            } catch (error) {
                console.error('Generate code error:', error);
                showToast('Failed to generate code', 'error');
            }
        }

        function updateCardLink(code) {
            const link = `${ORIGIN}/card.html?code=${code}`;
            document.getElementById('cardLink').value = link;
        }

        function generateQRCode() {
            if (!currentProfile?.code) return;
            
            const canvas = document.getElementById('qrCanvas');
            const placeholder = document.getElementById('qrPlaceholder');
            const cardUrl = `${ORIGIN}/card.html?code=${currentProfile.code}`;
            
            QRCode.toCanvas(canvas, cardUrl, {
                width: 128,
                height: 128,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                },
                errorCorrectionLevel: 'M'
            }, function (error) {
                if (error) {
                    console.error('QR Code generation failed:', error);
                    placeholder.style.display = 'block';
                    canvas.style.display = 'none';
                } else {
                    placeholder.style.display = 'none';
                    canvas.style.display = 'block';
                    console.log('QR Code generated successfully');
                }
            });
        }

        // ========== TRIAGE STATUS ==========
        function updateTriageStatus() {
            const override = document.getElementById('triageOverride').value;
            const statusElement = document.getElementById('triageStatus');
            
            if (override) {
                const statusMap = {
                    'Green': { class: 'triage-green', text: 'GREEN - Standard' },
                    'Amber': { class: 'triage-amber', text: 'AMBER - Urgent' },
                    'Red': { class: 'triage-red', text: 'RED - Immediate' },
                    'Black': { class: 'triage-black', text: 'BLACK - Comfort' }
                };
                
                const status = statusMap[override];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            } else {
                let calculatedStatus = 'Green';
                
                const lifeSupportPref = document.getElementById('lifeSupportPref').value;
                
                const criticalAllergies = ['midazolam', 'codeine', 'penicillin', 'morphine', 'fentanyl', 'aspirin'];
                const hasCriticalAllergy = pillData.allergies.some(allergy => 
                    criticalAllergies.some(critical => 
                        allergy.toLowerCase().includes(critical.toLowerCase())
                    )
                );
                
                if (lifeSupportPref === 'DNR') {
                    calculatedStatus = 'Black';
                } else if (hasCriticalAllergy || pillData.conditions.length > 3) {
                    calculatedStatus = 'Red';
                } else if (pillData.allergies.length > 0 || pillData.conditions.length > 0 || pillData.medications.length > 2) {
                    calculatedStatus = 'Amber';
                }
                
                const statusMap = {
                    'Green': { class: 'triage-green', text: 'GREEN - Standard (Auto)' },
                    'Amber': { class: 'triage-amber', text: 'AMBER - Urgent (Auto)' },
                    'Red': { class: 'triage-red', text: 'RED - Immediate (Auto)' },
                    'Black': { class: 'triage-black', text: 'BLACK - Comfort (Auto)' }
                };
                
                const status = statusMap[calculatedStatus];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            }
        }

        // ========== SPEECH FUNCTIONALITY ==========
        function speakSummary() {
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            const fullName = document.getElementById('fullName').value || 'Unknown';
            const bloodType = document.getElementById('bloodType').value || 'Unknown';
            const allergies = pillData.allergies.length > 0 ? pillData.allergies.join(', ') : 'None';
            const conditions = pillData.conditions.length > 0 ? pillData.conditions.join(', ') : 'None';
            
            const summary = `Emergency summary for ${fullName}. Blood type: ${bloodType}. Allergies: ${allergies}. Medical conditions: ${conditions}.`;
            
            if ('speechSynthesis' in window) {
                currentSpeech = new SpeechSynthesisUtterance(summary);
                currentSpeech.lang = 'en-US';
                
                currentSpeech.onstart = () => {
                    document.getElementById('speakSummaryBtn').style.display = 'none';
                    document.getElementById('stopSpeakingBtn').style.display = 'block';
                };
                
                currentSpeech.onend = () => {
                    document.getElementById('speakSummaryBtn').style.display = 'block';
                    document.getElementById('stopSpeakingBtn').style.display = 'none';
                    currentSpeech = null;
                };
                
                speechSynthesis.speak(currentSpeech);
                showToast('Speaking summary...', 'info');
            } else {
                showToast('Speech synthesis not supported', 'error');
            }
        }

        function stopSpeaking() {
            if (currentSpeech) {
                speechSynthesis.cancel();
                document.getElementById('speakSummaryBtn').style.display = 'block';
                document.getElementById('stopSpeakingBtn').style.display = 'none';
                currentSpeech = null;
                showToast('Speech stopped', 'info');
            }
        }

        // ========== DATA MANAGEMENT ==========
        async function loadUserData() {
            try {
                // Load profile
                const { data: profile, error: profileError } = await window.sb
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileError && profileError.code !== 'PGRST116') {
                    console.error('Profile load error:', profileError);
                } else if (profile) {
                    currentProfile = profile;
                    document.getElementById('fullName').value = profile.full_name || '';
                    document.getElementById('dateOfBirth').value = profile.date_of_birth || '';
                    document.getElementById('country').value = profile.country || '';
                    
                    if (profile.code) {
                        document.getElementById('cardCodeDisplay').textContent = profile.code;
                        document.getElementById('codeDisplay').classList.add('has-code');
                        updateCardLink(profile.code);
                        generateQRCode();
                    }
                }
                
                // Load health profile
                const { data: health, error: healthError } = await window.sb
                    .from('health_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (healthError && healthError.code !== 'PGRST116') {
                    console.error('Health load error:', healthError);
                } else if (health) {
                    document.getElementById('bloodType').value = health.blood_type || '';
                    document.getElementById('organDonor').value = health.organ_donor !== null ? health.organ_donor.toString() : '';
                    document.getElementById('lifeSupportPref').value = health.life_support_pref || 'Full';
                    
                    if (health.allergies) {
                        pillData.allergies = health.allergies.split(',').map(s => s.trim()).filter(Boolean);
                        renderPills('allergies');
                    }
                    if (health.conditions) {
                        pillData.conditions = health.conditions.split(',').map(s => s.trim()).filter(Boolean);
                        renderPills('conditions');
                    }
                    if (health.meds) {
                        pillData.medications = health.meds.split(',').map(s => s.trim()).filter(Boolean);
                        renderPills('medications');
                    }
                }
                
                // Load ICE contacts
                const { data: contacts, error: contactsError } = await window.sb
                    .from('ice_contacts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at');
                
                if (contactsError) {
                    console.error('Contacts load error:', contactsError);
                } else if (contacts && contacts.length > 0) {
                    contacts.forEach((contact, index) => {
                        const container = document.getElementById('iceContacts');
                        const contactId = `ice_${contact.id}`;
                        
                        const contactDiv = document.createElement('div');
                        contactDiv.className = 'border border-gray-200 rounded-lg p-4';
                        contactDiv.innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
                                    <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded contact-name" value="${contact.name || ''}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Relationship</label>
                                    <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded contact-relation" value="${contact.relation || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Phone</label>
                                    <input type="tel" class="w-full px-2 py-1 border border-gray-300 rounded contact-phone" value="${contact.phone || ''}" required>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-3">
                                <button class="text-red-600 text-sm hover:text-red-800" onclick="removeIceContact('${contactId}')">
                                    Remove Contact
                                </button>
                                <div class="text-xs text-gray-500">Auto-saves on blur</div>
                            </div>
                        `;
                        
                        contactDiv.dataset.contactId = contactId;
                        contactDiv.dataset.dbId = contact.id;
                        container.appendChild(contactDiv);
                        iceContactCount++;
                        
                        contactDiv.querySelectorAll('input').forEach(input => {
                            input.addEventListener('blur', debounce(saveIceContacts, 1000));
                        });
                    });
                    
                    updateAddButtonState();
                }
                
                updateTriageStatus();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading data', 'error');
            }
        }

        // ========== SAVE FUNCTIONS ==========
        async function saveProfile() {
            try {
                const fullName = document.getElementById('fullName').value.trim();
                const dateOfBirth = document.getElementById('dateOfBirth').value;
                const country = document.getElementById('country').value;
                
                const { error } = await window.sb
                    .from('profiles')
                    .upsert({
                        id: currentUser.id,
                        email: currentUser.email,
                        full_name: fullName,
                        country: country,
                        date_of_birth: dateOfBirth || null,
                        code: currentProfile?.code || null
                    });
                
                if (error) {
                    console.error('Save profile error:', error);
                    showToast('Failed to save profile', 'error');
                    return;
                }
                
                showToast('Profile saved', 'success');
                
            } catch (error) {
                console.error('Save profile error:', error);
                showToast('Failed to save profile', 'error');
            }
        }

        async function saveHealthProfile() {
            try {
                const bloodType = document.getElementById('bloodType').value;
                const organDonor = document.getElementById('organDonor').value;
                const lifeSupportPref = document.getElementById('lifeSupportPref').value;
                
                const { error } = await window.sb
                    .from('health_profiles')
                    .upsert({
                        user_id: currentUser.id,
                        blood_type: bloodType || null,
                        organ_donor: organDonor ? organDonor === 'true' : null,
                        allergies: pillData.allergies.join(', ') || null,
                        conditions: pillData.conditions.join(', ') || null,
                        meds: pillData.medications.join(', ') || null,
                        life_support_pref: lifeSupportPref
                    });
                
                if (error) {
                    console.error('Save health error:', error);
                    showToast('Failed to save health profile', 'error');
                    return;
                }
                
                updateTriageStatus();
                showToast('Health profile saved', 'success');
                
            } catch (error) {
                console.error('Save health error:', error);
                showToast('Failed to save health profile', 'error');
            }
        }

        async function saveIceContacts() {
            try {
                // First, delete all existing contacts
                await window.sb
                    .from('ice_contacts')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                // Then insert current contacts
                const contacts = [];
                document.querySelectorAll('#iceContacts > div').forEach(contactDiv => {
                    const nameInput = contactDiv.querySelector('.contact-name');
                    const relationInput = contactDiv.querySelector('.contact-relation');
                    const phoneInput = contactDiv.querySelector('.contact-phone');
                    
                    if (nameInput && nameInput.value.trim()) {
                        contacts.push({
                            user_id: currentUser.id,
                            name: nameInput.value.trim(),
                            relation: relationInput.value.trim() || null,
                            phone: phoneInput.value.trim() || null
                        });
                    }
                });
                
                if (contacts.length > 0) {
                    const { error } = await window.sb
                        .from('ice_contacts')
                        .insert(contacts);
                    
                    if (error) {
                        console.error('Save contacts error:', error);
                        showToast('Failed to save contacts', 'error');
                        return;
                    }
                }
                
                showToast('Contacts saved', 'success');
                
            } catch (error) {
                console.error('Save contacts error:', error);
                showToast('Failed to save contacts', 'error');
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function copyCardLink() {
            const link = document.getElementById('cardLink').value;
            if (link) {
                navigator.clipboard.writeText(link).then(() => {
                    showToast('Link copied to clipboard', 'success');
                }).catch(() => {
                    showToast('Failed to copy link', 'error');
                });
            } else {
                showToast('Generate a code first', 'warning');
            }
        }

        function viewEmergencyCard() {
            const link = document.getElementById('cardLink').value;
            if (link) {
                window.open(link, '_blank');
            } else {
                showToast('Generate a code first', 'warning');
            }
        }

        function exportQR(format) {
            const canvas = document.getElementById('qrCanvas');
            if (canvas.style.display === 'none') {
                showToast('Generate QR code first', 'warning');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.download = `myqer-qr-${currentProfile?.code || 'emergency'}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('QR code exported', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showToast('Export failed', 'error');
            }
        }

        function printEmergencyCard() {
            if (!currentProfile?.code) {
                showToast('Generate emergency code first', 'warning');
                return;
            }
            
            try {
                const fullName = document.getElementById('fullName').value || 'Unknown';
                const bloodType = document.getElementById('bloodType').value || 'Unknown';
                const allergies = pillData.allergies.join(', ') || 'None';
                const conditions = pillData.conditions.join(', ') || 'None';
                const medications = pillData.medications.join(', ') || 'None';
                
                const printWindow = window.open('', '_blank');
                
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>MYQER™ Emergency Card - ${fullName}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                background: white;
                            }
                            .card { 
                                border: 3px solid #dc2626; 
                                border-radius: 12px; 
                                padding: 20px; 
                                max-width: 400px; 
                                margin: 0 auto;
                                background: white;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 20px; 
                                border-bottom: 2px solid #dc2626;
                                padding-bottom: 15px;
                            }
                            .brand { 
                                font-size: 28px; 
                                font-weight: bold; 
                                color: #000;
                                margin-bottom: 5px;
                            }
                            .brand .red { color: #dc2626; }
                            .subtitle {
                                font-size: 14px;
                                color: #666;
                                margin-bottom: 10px;
                            }
                            .qr-section { 
                                text-align: center; 
                                margin: 20px 0; 
                                padding: 15px;
                                background: #f8f9fa;
                                border-radius: 8px;
                            }
                            .info { 
                                margin: 12px 0; 
                                padding: 8px 0;
                                border-bottom: 1px solid #eee;
                            }
                            .label { 
                                font-weight: bold; 
                                color: #dc2626;
                                display: inline-block;
                                width: 120px;
                            }
                            .value {
                                color: #333;
                            }
                            .code {
                                font-family: 'Courier New', monospace;
                                font-size: 16px;
                                font-weight: bold;
                                color: #dc2626;
                                letter-spacing: 1px;
                            }
                            @media print { 
                                body { margin: 0; }
                                .card { max-width: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="card">
                            <div class="header">
                                <div class="brand">MYQ<span class="red">ER</span>™</div>
                                <div class="subtitle">Emergency Information Card</div>
                                <div class="code">${currentProfile.code}</div>
                            </div>
                            <div class="qr-section">
                                <canvas id="printQR" width="200" height="200"></canvas>
                                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                    Scan for emergency information
                                </div>
                            </div>
                            <div class="info">
                                <span class="label">Name:</span>
                                <span class="value">${fullName}</span>
                            </div>
                            <div class="info">
                                <span class="label">Blood Type:</span>
                                <span class="value">${bloodType}</span>
                            </div>
                            <div class="info">
                                <span class="label">Allergies:</span>
                                <span class="value">${allergies}</span>
                            </div>
                            <div class="info">
                                <span class="label">Conditions:</span>
                                <span class="value">${conditions}</span>
                            </div>
                            <div class="info">
                                <span class="label">Medications:</span>
                                <span class="value">${medications}</span>
                            </div>
                        </div>
                        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
                        <script>
                            const cardUrl = '${ORIGIN}/card.html?code=${currentProfile.code}';
                            const canvas = document.getElementById('printQR');
                            QRCode.toCanvas(canvas, cardUrl, {
                                width: 200,
                                height: 200,
                                margin: 3,
                                color: {
                                    dark: '#000000',
                                    light: '#FFFFFF'
                                }
                            }, function(error) {
                                if (!error) {
                                    setTimeout(() => window.print(), 500);
                                }
                            });
                        </script>
                    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9777d46070ee78f2',t:'MTc1NjU5NDA0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
                    </html>
                `;
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                showToast('Opening print dialog...', 'info');
                
            } catch (error) {
                console.error('Print failed:', error);
                showToast('Print failed', 'error');
            }
        }

        async function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    showToast('Account deletion requires secure verification. Please contact support to complete this action.', 'warning');
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Make functions globally available for onclick handlers
        window.removePill = removePill;
        window.removeIceContact = removeIceContact;
    </script>
</body>
</html>
