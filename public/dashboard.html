<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MYQER - Emergency Medical Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#000000',
            emergency: '#dc2626',
            critical: '#dc2626',
            ice: '#ea580c',
            identity: '#16a34a',
            vault: '#7c3aed',
            qr: '#f59e0b'
          }
        }
      }
    }
  </script>
  <style>
    /* Premium glassmorphism cards */
    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 
        0 20px 25px -5px rgba(0, 0, 0, 0.08),
        0 10px 10px -5px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    /* MYQER Branding */
    .myqer-logo {
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: -0.025em;
    }
    
    .myqer-logo .myq { color: #000000; }
    .myqer-logo .er { color: #dc2626; }
    
    .myqer-tagline {
      font-size: 0.75rem;
      color: #64748b;
      font-weight: 400;
      margin-top: -0.25rem;
    }
    
    /* Premium accolade ribbon system */
    .ribbon {
      position: relative;
      padding-top: 2rem;
      overflow: visible;
    }
    
    .accolade {
      position: absolute;
      top: -0.5rem;
      left: 1rem;
      right: 1rem;
      height: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: white;
      z-index: 20;
      transition: all 0.3s ease;
      border-radius: 0.25rem;
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.15),
        inset 0 2px 0 rgba(255,255,255,0.4),
        inset 0 -2px 0 rgba(0,0,0,0.2);
    }
    
    /* Realistic ribbon folds with shine */
    .accolade::before {
      content: '';
      position: absolute;
      top: 100%;
      left: 0;
      width: 1rem;
      height: 0.75rem;
      background: inherit;
      filter: brightness(0.7);
      clip-path: polygon(0 0, 100% 0, 70% 100%, 0 70%);
      box-shadow: inset 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .accolade::after {
      content: '';
      position: absolute;
      top: 100%;
      right: 0;
      width: 1rem;
      height: 0.75rem;
      background: inherit;
      filter: brightness(0.7);
      clip-path: polygon(30% 0, 100% 0, 100% 70%, 0 100%);
      box-shadow: inset -2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .accolade:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        0 8px 20px rgba(0,0,0,0.2),
        inset 0 3px 0 rgba(255,255,255,0.5),
        inset 0 -3px 0 rgba(0,0,0,0.3);
    }
    
    .accolade--critical { 
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #dc2626 100%);
    }
    .accolade--ice { 
      background: linear-gradient(135deg, #ea580c 0%, #c2410c 50%, #ea580c 100%);
    }
    .accolade--identity { 
      background: linear-gradient(135deg, #16a34a 0%, #15803d 50%, #16a34a 100%);
    }
    .accolade--vault { 
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 50%, #7c3aed 100%);
    }
    .accolade--qr { 
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #f59e0b 100%);
    }
    
    /* Premium button system */
    .btn-primary {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      transition: all 0.15s ease;
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
      border: none;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .btn-outline {
      border: 1.5px solid #dc2626;
      color: #dc2626;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.15s ease;
      cursor: pointer;
    }
    
    .btn-outline:hover {
      background: rgba(220, 38, 38, 0.05);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      border: 1px solid rgb(203, 213, 225);
      color: rgb(71, 85, 105);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.15s ease;
      cursor: pointer;
    }
    
    .btn-secondary:hover {
      background: rgb(248, 250, 252);
      border-color: rgb(148, 163, 184);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      transition: all 0.15s ease;
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
      border: none;
      cursor: pointer;
    }
    
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .input-field {
      border: 1.5px solid rgb(203, 213, 225);
      border-radius: 0.5rem;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      background: rgba(255, 255, 255, 0.9);
      width: 100%;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
      background: white;
    }
    
    /* Premium QR container */
    .qr-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1rem;
      padding: 1.25rem;
      box-shadow: 
        0 0 0 2px #dc2626,
        0 0 20px rgba(220, 38, 38, 0.3),
        0 8px 16px rgba(220, 38, 38, 0.15);
      position: relative;
      z-index: 1;
      display: grid;
      place-items: center;
      aspect-ratio: 1/1;
      width: 248px;
      height: 248px;
    }
    
    .offline-badge {
      position: absolute;
      top: -0.5rem;
      right: -0.5rem;
      background: linear-gradient(135deg, #16a34a, #15803d);
      color: white;
      font-size: 0.625rem;
      font-weight: 700;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: pulse 2s infinite;
      z-index: 2;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .legend-dot {
      width: 0.875rem;
      height: 0.875rem;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.625rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .status-pill {
      border-radius: 9999px;
      border: 2px solid;
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.15s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .pill-green {
      background: linear-gradient(135deg, rgb(240, 253, 244), rgb(220, 252, 231));
      border-color: rgb(34, 197, 94);
      color: rgb(22, 163, 74);
    }
    
    .pill-yellow {
      background: linear-gradient(135deg, rgb(254, 252, 232), rgb(254, 240, 138));
      border-color: rgb(245, 158, 11);
      color: rgb(217, 119, 6);
    }
    
    .pill-red {
      background: linear-gradient(135deg, rgb(254, 242, 242), rgb(254, 226, 226));
      border-color: rgb(239, 68, 68);
      color: rgb(220, 38, 38);
    }
    
    .pill-black {
      background: linear-gradient(135deg, rgb(249, 250, 251), rgb(243, 244, 246));
      border-color: rgb(17, 24, 39);
      color: rgb(17, 24, 39);
    }
    
    .toast {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: 350px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    }
    
    .toast.show { transform: translateX(0); }
    .toast-success { background: linear-gradient(135deg, rgba(5, 150, 105, 0.95), rgba(4, 120, 87, 0.95)); }
    .toast-warning { background: linear-gradient(135deg, rgba(217, 119, 6, 0.95), rgba(180, 83, 9, 0.95)); }
    .toast-error { background: linear-gradient(135deg, rgba(220, 38, 38, 0.95), rgba(185, 28, 28, 0.95)); }
    
    /* Modal system */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    
    .modal.show .modal-content {
      transform: scale(1);
    }
    
    .hidden { display: none !important; }
    
    /* RTL support for Arabic */
    [dir="rtl"] {
      direction: rtl;
    }
    
    [dir="rtl"] .flex {
      flex-direction: row-reverse;
    }
    
    [dir="rtl"] .text-left {
      text-align: right;
    }
    
    [dir="rtl"] .text-right {
      text-align: left;
    }
    
    .qr-placeholder {
      width: 200px;
      height: 200px;
      border: 2px dashed #cbd5e1;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 0.875rem;
      text-align: center;
      background: rgba(248, 250, 252, 0.8);
    }

    /* Loading spinner */
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #dc2626;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Loading screen */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
      padding: 2rem;
    }

    .loading-logo {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 1rem;
    }

    .loading-spinner-large {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #dc2626;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-content">
      <div class="loading-logo myqer-logo">
        <span class="myq">MYQ</span><span class="er">ER</span><span class="text-xs align-super text-slate-400">â„¢</span>
      </div>
      <div class="loading-spinner-large"></div>
      <p class="text-slate-600">Loading your emergency dashboard...</p>
    </div>
  </div>

  <!-- Main App (hidden initially) -->
  <div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="glass-card border-b border-slate-200/50 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <div class="myqer-logo">
              <span class="myq">MYQ</span><span class="er">ER</span><span class="text-xs align-super text-slate-400">â„¢</span>
            </div>
            <div>
              <h1 class="text-xl font-extrabold text-slate-800">ğŸ¥ Emergency Dashboard</h1>
              <p class="myqer-tagline">pronounced "My Care"</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <select id="langSelect" class="input-field text-sm" style="width: auto;">
              <option value="en">ğŸ‡ºğŸ‡¸ English</option>
              <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
              <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
              <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
              <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
              <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
              <option value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</option>
              <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
              <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
              <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
            </select>
            <span id="userEmail" class="text-sm text-slate-600">Loading...</span>
            <button id="logoutBtn" class="btn-secondary">
              <span id="logoutSpinner" class="loading-spinner hidden inline-block mr-2"></span>
              Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Dashboard Content -->
    <main class="pt-8 pb-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
          
          <!-- Main Content: Two-Row Layout -->
          <div class="lg:col-span-3">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
              
              <!-- 1. Identity â€“ Personal Information -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--identity">Identity</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <h2 class="text-xl font-extrabold mb-2 text-slate-800">ğŸ‘¤ Personal Information</h2>
                  <p class="text-sm text-slate-500 mb-6">These details help responders confirm who you are.</p>

                  <form id="profileForm" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Full name</label>
                        <input id="fullName" name="fullName" class="input-field" placeholder="John Doe">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Date of Birth</label>
                        <input id="dateOfBirth" name="dateOfBirth" type="date" class="input-field">
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Country</label>
                        <select id="country" name="country" class="input-field">
                          <option value="">Select country</option>
                          <option value="United States">ğŸ‡ºğŸ‡¸ United States</option>
                          <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                          <option value="United Kingdom">ğŸ‡¬ğŸ‡§ United Kingdom</option>
                          <option value="Australia">ğŸ‡¦ğŸ‡º Australia</option>
                          <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
                          <option value="France">ğŸ‡«ğŸ‡· France</option>
                          <option value="Spain">ğŸ‡ªğŸ‡¸ Spain</option>
                          <option value="Italy">ğŸ‡®ğŸ‡¹ Italy</option>
                          <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                          <option value="Sweden">ğŸ‡¸ğŸ‡ª Sweden</option>
                          <option value="Norway">ğŸ‡³ğŸ‡´ Norway</option>
                          <option value="Denmark">ğŸ‡©ğŸ‡° Denmark</option>
                          <option value="Switzerland">ğŸ‡¨ğŸ‡­ Switzerland</option>
                          <option value="Austria">ğŸ‡¦ğŸ‡¹ Austria</option>
                          <option value="Belgium">ğŸ‡§ğŸ‡ª Belgium</option>
                          <option value="Japan">ğŸ‡¯ğŸ‡µ Japan</option>
                          <option value="South Korea">ğŸ‡°ğŸ‡· South Korea</option>
                          <option value="Singapore">ğŸ‡¸ğŸ‡¬ Singapore</option>
                          <option value="New Zealand">ğŸ‡³ğŸ‡¿ New Zealand</option>
                          <option value="Ireland">ğŸ‡®ğŸ‡ª Ireland</option>
                          <option value="Finland">ğŸ‡«ğŸ‡® Finland</option>
                          <option value="Portugal">ğŸ‡µğŸ‡¹ Portugal</option>
                          <option value="Czech Republic">ğŸ‡¨ğŸ‡¿ Czech Republic</option>
                          <option value="Poland">ğŸ‡µğŸ‡± Poland</option>
                          <option value="Other">ğŸŒ Other</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">National ID (optional)</label>
                        <input id="nationalId" name="nationalId" class="input-field" placeholder="123-45-6789">
                      </div>
                    </div>

                    <div class="flex justify-end pt-4 border-t border-slate-200/60">
                      <button type="submit" class="btn-primary text-sm">
                        <span id="profileSpinner" class="loading-spinner hidden inline-block mr-2"></span>
                        Save Profile
                      </button>
                    </div>
                  </form>
                </div>
              </section>

              <!-- 2. Critical â€“ Medical Details -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--critical">Critical</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <h2 class="text-xl font-extrabold mb-2 text-slate-800">ğŸ©º Medical Details</h2>
                  <p class="text-sm text-slate-500 mb-6">Keep this current. It appears on your emergency card.</p>

                  <form id="healthForm" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Blood type</label>
                        <select id="bloodType" name="bloodType" class="input-field">
                          <option value="">â€”</option>
                          <option>A+</option><option>A-</option>
                          <option>B+</option><option>B-</option>
                          <option>AB+</option><option>AB-</option>
                          <option>O+</option><option>O-</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Organ donor</label>
                        <select id="organDonor" name="organDonor" class="input-field">
                          <option value="">â€”</option>
                          <option value="yes">Yes</option>
                          <option value="no">No</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-1">Critical allergies</label>
                      <textarea id="allergies" name="allergies" rows="2" class="input-field" placeholder="Penicillin, Nuts"></textarea>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-1">Conditions</label>
                      <textarea id="conditions" name="conditions" rows="2" class="input-field" placeholder="Diabetes, Asthma"></textarea>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-1">Current medications</label>
                      <textarea id="medications" name="medications" rows="2" class="input-field" placeholder="Metformin"></textarea>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-1">Life support preference</label>
                      <select id="lifeSupportPref" name="lifeSupportPref" class="input-field">
                        <option value="">â€”</option>
                        <option value="Full support">All resuscitation efforts (Full)</option>
                        <option value="Comfort only">Comfort-focused care only</option>
                        <option value="DNR">Do not resuscitate (DNR)</option>
                      </select>
                      <p class="text-xs text-slate-400 mt-1">Informational only. Clinicians must verify with official documents.</p>
                    </div>

                    <div class="flex justify-end pt-4 border-t border-slate-200/60">
                      <button type="submit" class="btn-primary">
                        <span id="healthSpinner" class="loading-spinner hidden inline-block mr-2"></span>
                        Save Health
                      </button>
                    </div>
                  </form>
                </div>
              </section>

              <!-- 3. Emergency Contacts (ICE) -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--ice" data-i18n="ice">ICE</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-extrabold text-slate-800">ğŸ“ <span data-i18n="emergency_contacts">Emergency Contacts</span></h2>
                    <button id="addContact" class="btn-outline text-sm" data-i18n="add_contact">Add contact</button>
                  </div>
                  <p class="text-sm text-slate-500 mb-6" data-i18n="contacts_desc">Add up to 3 trusted contacts.</p>
                  <div id="contactsList" class="space-y-4">
                    <div class="text-slate-400 text-sm italic" data-i18n="no_contacts">No contacts yet.</div>
                  </div>
                </div>
              </section>

              <!-- 4. Document Vault -->
              <section class="glass-card rounded-xl p-6 ribbon">
                <span class="accolade accolade--vault">Vault</span>
                <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                  <h2 class="text-xl font-extrabold mb-2 text-slate-800">ğŸ“ Document Vault</h2>
                  <p class="text-sm text-slate-500 mb-6">Secure, encrypted storage for critical documents.</p>
                  <div class="grid grid-cols-1 gap-3">
                    <div class="border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3 opacity-60" title="Coming soon">
                      <span class="legend-dot" style="background:#7c3aed"></span>
                      <div>
                        <div class="font-semibold text-slate-600 text-sm">DNR Orders</div>
                        <div class="text-xs text-slate-400">Coming soon</div>
                      </div>
                    </div>
                    <div class="border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3 opacity-60" title="Coming soon">
                      <span class="legend-dot" style="background:#7c3aed"></span>
                      <div>
                        <div class="font-semibold text-slate-600 text-sm">Living Will</div>
                        <div class="text-xs text-slate-400">Coming soon</div>
                      </div>
                    </div>
                    <div class="border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3 opacity-60" title="Coming soon">
                      <span class="legend-dot" style="background:#7c3aed"></span>
                      <div>
                        <div class="font-semibold text-slate-600 text-sm">Insurance Documents</div>
                        <div class="text-xs text-slate-400">Coming soon</div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </div>

          <!-- Right Sidebar -->
          <aside class="lg:col-span-1 space-y-6">

            <!-- Triage Status -->
            <section class="glass-card rounded-xl p-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-extrabold text-slate-800">ğŸš¨ <span data-i18n="triage_status">Triage Status</span></h3>
                <span id="triageStatus" class="status-pill pill-green">GREEN</span>
              </div>
              <p class="text-sm text-slate-500 mb-4">Auto-computed from your data. You can override.</p>
              
              <select id="triageOverride" class="input-field mb-4">
                <option value="" data-i18n="auto_recommended">Auto (recommended)</option>
                <option value="green">GREEN - <span data-i18n="standard">Standard</span></option>
                <option value="yellow">AMBER - <span data-i18n="urgent">Urgent</span></option>
                <option value="red">RED - <span data-i18n="critical">Critical</span></option>
                <option value="black">BLACK - <span data-i18n="comfort_care">Comfort care</span></option>
              </select>
              
              <div class="flex gap-2">
                <button id="speakBtn" class="btn-secondary flex-1 text-sm">ğŸ”Š <span data-i18n="speak">Speak</span></button>
                <button id="stopSpeakBtn" class="btn-secondary text-sm">â¹ <span data-i18n="stop">Stop</span></button>
              </div>
            </section>

            <!-- Emergency Card & QR -->
            <section class="glass-card rounded-xl p-6 ribbon">
              <span class="accolade accolade--qr">QR Card</span>
              <div class="glass-card rounded-xl p-6 border border-slate-200/60">
                <h3 class="text-lg font-extrabold mb-3 text-slate-800">ğŸ“± Emergency Card</h3>
                <p class="text-sm text-slate-500 mb-4">Scan for emergency access</p>
                
                <div class="text-center mb-6">
                  <div id="qrContainer" class="qr-container inline-block relative">
                    <div class="offline-badge">Hybrid QR</div>
                    <div id="qrPlaceholder" class="qr-placeholder">
                      <div>
                        <div class="text-slate-400 mb-2">ğŸ“‹</div>
                        <div>Complete profile<br>to generate hybrid QR</div>
                      </div>
                    </div>
                    <canvas id="qrCanvas" width="200" height="200" class="hidden"></canvas>
                  </div>
                  <div class="mt-3">
                    <span class="text-sm text-slate-500">Code: </span>
                    <code id="qrCode" class="text-sm font-mono font-bold text-slate-800">â€”</code>
                  </div>
                  <div class="mt-2">
                    <p class="text-xs text-green-600 font-medium">âœ“ Contains medical essentials + online link</p>
                  </div>
                </div>
                
                <!-- Generate Code Button (appears when profile is complete) -->
                <div id="generateSection" class="hidden mb-4">
                  <button id="generateCode" class="btn-primary w-full text-sm">
                    <span id="generateSpinner" class="loading-spinner hidden inline-block mr-2"></span>
                    ğŸ¯ Generate Emergency Code
                  </button>
                </div>
                
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Emergency data (embedded)</label>
                    <div class="flex gap-2">
                      <input id="emergencyData" class="input-field flex-1 text-xs" readonly placeholder="Generate code to see data">
                      <button id="copyData" class="btn-secondary text-sm">Copy</button>
                    </div>
                  </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mt-4">
                  <button id="downloadPNG" class="btn-outline text-xs">PNG</button>
                  <button id="downloadSVG" class="btn-outline text-xs">SVG</button>
                  <button id="printCard" class="btn-outline text-xs">Print</button>
                </div>
              </div>
            </section>

            <!-- Triage Legend -->
            <section class="glass-card rounded-xl p-6">
              <h3 class="text-lg font-extrabold mb-4 text-slate-800">ğŸ¯ Triage Colors</h3>
              <div class="space-y-3">
                <div class="flex items-center">
                  <span class="legend-dot" style="background:#16a34a"></span>
                  <div>
                    <div class="font-semibold text-slate-700 text-sm">GREEN</div>
                    <div class="text-xs text-slate-400">Standard care</div>
                  </div>
                </div>
                <div class="flex items-center">
                  <span class="legend-dot" style="background:#f59e0b"></span>
                  <div>
                    <div class="font-semibold text-slate-700 text-sm">AMBER</div>
                    <div class="text-xs text-slate-400">Urgent attention</div>
                  </div>
                </div>
                <div class="flex items-center">
                  <span class="legend-dot" style="background:#ef4444"></span>
                  <div>
                    <div class="font-semibold text-slate-700 text-sm">RED</div>
                    <div class="text-xs text-slate-400">Critical/immediate</div>
                  </div>
                </div>
                <div class="flex items-center">
                  <span class="legend-dot" style="background:#111827"></span>
                  <div>
                    <div class="font-semibold text-slate-700 text-sm">BLACK</div>
                    <div class="text-xs text-slate-400">Comfort care</div>
                  </div>
                </div>
              </div>
            </section>

            <!-- Delete Account -->
            <section class="glass-card rounded-xl p-6 border-red-200">
              <h3 class="text-lg font-extrabold mb-3 text-red-600">âš ï¸ Danger Zone</h3>
              <p class="text-sm text-slate-500 mb-4">Permanently delete your account and all data.</p>
              <button id="deleteAccountBtn" class="btn-danger w-full text-sm">Delete Account</button>
            </section>

          </aside>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="glass-card border-t border-slate-200/50 mt-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div>
            <h4 class="font-bold text-slate-800 mb-3">Privacy & Security</h4>
            <p class="text-sm text-slate-600">Your medical data is encrypted and stored securely. Only you control access.</p>
          </div>
          <div>
            <h4 class="font-bold text-slate-800 mb-3">Medical Disclaimer</h4>
            <p class="text-sm text-slate-600">This is informational only. Emergency responders must verify all medical information.</p>
          </div>
          <div>
            <h4 class="font-bold text-slate-800 mb-3">Support</h4>
            <p class="text-sm text-slate-600">Need help? Contact our support team 24/7 for assistance.</p>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Delete Account Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3 class="text-xl font-bold text-red-600 mb-4">âš ï¸ Delete Account</h3>
      <p class="text-slate-600 mb-6">This action cannot be undone. All your emergency data, contacts, and documents will be permanently deleted.</p>
      
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2">Type "DELETE MY ACCOUNT" to confirm:</label>
        <input id="deleteConfirm" class="input-field" placeholder="DELETE MY ACCOUNT">
      </div>
      
      <div class="flex gap-3 justify-end">
        <button id="cancelDelete" class="btn-secondary">Cancel</button>
        <button id="confirmDelete" class="btn-danger" disabled>
          <span id="deleteSpinner" class="loading-spinner hidden inline-block mr-2"></span>
          Delete Forever
        </button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Supabase - Using demo mode for now
    let sb = null;
    let isDemoMode = true;

    // Try to initialize Supabase, fall back to demo mode if it fails
    try {
      const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
      
      if (typeof supabase !== 'undefined') {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        isDemoMode = false;
      }
    } catch (error) {
      console.log('Supabase not available, using demo mode');
      isDemoMode = true;
    }

    // Global state
    let currentUser = isDemoMode ? { id: 'demo-user', email: 'demo@myqer.com' } : null;
    let currentLang = localStorage.getItem('myqer_lang') || 'en';
    let userData = {
      profile: { fullName: '', dateOfBirth: '', country: '', nationalId: '', code: null },
      health: { bloodType: '', organDonor: '', allergies: '', conditions: '', medications: '', lifeSupportPref: '', triageOverride: '' },
      contacts: [],
      triageOverride: ''
    };

    // Internationalization
    const translations = {
      en: {
        emergency_contacts: 'Emergency Contacts',
        add_contact: 'Add contact',
        contacts_desc: 'Add up to 3 trusted contacts.',
        no_contacts: 'No contacts yet.',
        ice: 'ICE',
        name: 'Name',
        relationship: 'Relationship',
        phone: 'Phone',
        delete_contact: 'Delete this contact?',
        contact_removed: 'Contact removed',
        max_contacts: 'Maximum 3 contacts allowed',
        triage_status: 'Triage Status',
        auto_recommended: 'Auto (recommended)',
        standard: 'Standard',
        urgent: 'Urgent', 
        critical: 'Critical',
        comfort_care: 'Comfort care',
        speak: 'Speak',
        stop: 'Stop',
        speaking_summary: 'Speaking emergency summary',
        speech_stopped: 'Speech stopped',
        speech_not_supported: 'Speech synthesis not supported',
        language_changed: 'Language changed to'
      },
      es: {
        emergency_contacts: 'Contactos de Emergencia',
        add_contact: 'Agregar contacto',
        contacts_desc: 'Agregue hasta 3 contactos de confianza.',
        no_contacts: 'AÃºn no hay contactos.',
        ice: 'ICE',
        name: 'Nombre',
        relationship: 'RelaciÃ³n',
        phone: 'TelÃ©fono',
        delete_contact: 'Â¿Eliminar este contacto?',
        contact_removed: 'Contacto eliminado',
        max_contacts: 'MÃ¡ximo 3 contactos permitidos',
        triage_status: 'Estado de Triaje',
        auto_recommended: 'Auto (recomendado)',
        standard: 'EstÃ¡ndar',
        urgent: 'Urgente',
        critical: 'CrÃ­tico',
        comfort_care: 'Cuidados paliativos',
        speak: 'Hablar',
        stop: 'Parar',
        speaking_summary: 'Hablando resumen de emergencia',
        speech_stopped: 'Voz detenida',
        speech_not_supported: 'SÃ­ntesis de voz no compatible',
        language_changed: 'Idioma cambiado a'
      },
      fr: {
        emergency_contacts: 'Contacts d\'Urgence',
        add_contact: 'Ajouter contact',
        contacts_desc: 'Ajoutez jusqu\'Ã  3 contacts de confiance.',
        no_contacts: 'Aucun contact pour le moment.',
        ice: 'ICE',
        name: 'Nom',
        relationship: 'Relation',
        phone: 'TÃ©lÃ©phone',
        delete_contact: 'Supprimer ce contact?',
        contact_removed: 'Contact supprimÃ©',
        max_contacts: 'Maximum 3 contacts autorisÃ©s',
        triage_status: 'Statut de Triage',
        auto_recommended: 'Auto (recommandÃ©)',
        standard: 'Standard',
        urgent: 'Urgent',
        critical: 'Critique',
        comfort_care: 'Soins palliatifs',
        speak: 'Parler',
        stop: 'ArrÃªter',
        speaking_summary: 'Lecture du rÃ©sumÃ© d\'urgence',
        speech_stopped: 'Parole arrÃªtÃ©e',
        speech_not_supported: 'SynthÃ¨se vocale non prise en charge',
        language_changed: 'Langue changÃ©e en'
      },
      de: {
        emergency_contacts: 'Notfallkontakte',
        add_contact: 'Kontakt hinzufÃ¼gen',
        contacts_desc: 'FÃ¼gen Sie bis zu 3 vertrauenswÃ¼rdige Kontakte hinzu.',
        no_contacts: 'Noch keine Kontakte.',
        ice: 'ICE',
        name: 'Name',
        relationship: 'Beziehung',
        phone: 'Telefon',
        delete_contact: 'Diesen Kontakt lÃ¶schen?',
        contact_removed: 'Kontakt entfernt',
        max_contacts: 'Maximal 3 Kontakte erlaubt',
        triage_status: 'Triage-Status',
        auto_recommended: 'Auto (empfohlen)',
        standard: 'Standard',
        urgent: 'Dringend',
        critical: 'Kritisch',
        comfort_care: 'Palliativpflege',
        speak: 'Sprechen',
        stop: 'Stopp',
        speaking_summary: 'Notfallzusammenfassung sprechen',
        speech_stopped: 'Sprache gestoppt',
        speech_not_supported: 'Sprachsynthese nicht unterstÃ¼tzt',
        language_changed: 'Sprache geÃ¤ndert zu'
      },
      it: {
        emergency_contacts: 'Contatti di Emergenza',
        add_contact: 'Aggiungi contatto',
        contacts_desc: 'Aggiungi fino a 3 contatti fidati.',
        no_contacts: 'Nessun contatto ancora.',
        ice: 'ICE',
        name: 'Nome',
        relationship: 'Relazione',
        phone: 'Telefono',
        delete_contact: 'Eliminare questo contatto?',
        contact_removed: 'Contatto rimosso',
        max_contacts: 'Massimo 3 contatti consentiti',
        triage_status: 'Stato Triage',
        auto_recommended: 'Auto (raccomandato)',
        standard: 'Standard',
        urgent: 'Urgente',
        critical: 'Critico',
        comfort_care: 'Cure palliative',
        speak: 'Parla',
        stop: 'Ferma',
        speaking_summary: 'Lettura riassunto emergenza',
        speech_stopped: 'Voce fermata',
        speech_not_supported: 'Sintesi vocale non supportata',
        language_changed: 'Lingua cambiata in'
      },
      pt: {
        emergency_contacts: 'Contactos de EmergÃªncia',
        add_contact: 'Adicionar contacto',
        contacts_desc: 'Adicione atÃ© 3 contactos de confianÃ§a.',
        no_contacts: 'Ainda sem contactos.',
        ice: 'ICE',
        name: 'Nome',
        relationship: 'RelaÃ§Ã£o',
        phone: 'Telefone',
        delete_contact: 'Eliminar este contacto?',
        contact_removed: 'Contacto removido',
        max_contacts: 'MÃ¡ximo 3 contactos permitidos',
        triage_status: 'Estado de Triagem',
        auto_recommended: 'Auto (recomendado)',
        standard: 'PadrÃ£o',
        urgent: 'Urgente',
        critical: 'CrÃ­tico',
        comfort_care: 'Cuidados paliativos',
        speak: 'Falar',
        stop: 'Parar',
        speaking_summary: 'Falando resumo de emergÃªncia',
        speech_stopped: 'Voz parada',
        speech_not_supported: 'SÃ­ntese de voz nÃ£o suportada',
        language_changed: 'Idioma alterado para'
      },
      ro: {
        emergency_contacts: 'Contacte de UrgenÈ›Äƒ',
        add_contact: 'AdaugÄƒ contact',
        contacts_desc: 'AdaugÄƒ pÃ¢nÄƒ la 3 contacte de Ã®ncredere.',
        no_contacts: 'ÃncÄƒ nu existÄƒ contacte.',
        ice: 'ICE',
        name: 'Nume',
        relationship: 'RelaÈ›ie',
        phone: 'Telefon',
        delete_contact: 'È˜tergi acest contact?',
        contact_removed: 'Contact eliminat',
        max_contacts: 'Maxim 3 contacte permise',
        triage_status: 'Starea Triajului',
        auto_recommended: 'Auto (recomandat)',
        standard: 'Standard',
        urgent: 'Urgent',
        critical: 'Critic',
        comfort_care: 'Ãngrijire paliativÄƒ',
        speak: 'VorbeÈ™te',
        stop: 'OpreÈ™te',
        speaking_summary: 'Citind rezumatul de urgenÈ›Äƒ',
        speech_stopped: 'Voce opritÄƒ',
        speech_not_supported: 'Sinteza vocalÄƒ nu este suportatÄƒ',
        language_changed: 'Limba schimbatÄƒ Ã®n'
      },
      ar: {
        emergency_contacts: 'Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø·Ø§Ø±Ø¦Ø©',
        add_contact: 'Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„',
        contacts_desc: 'Ø£Ø¶Ù Ø­ØªÙ‰ 3 Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ù…ÙˆØ«ÙˆÙ‚Ø©.',
        no_contacts: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯.',
        ice: 'ICE',
        name: 'Ø§Ù„Ø§Ø³Ù…',
        relationship: 'Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©',
        phone: 'Ø§Ù„Ù‡Ø§ØªÙ',
        delete_contact: 'Ø­Ø°Ù Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù‡Ø°Ù‡ØŸ',
        contact_removed: 'ØªÙ… Ø­Ø°Ù Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
        max_contacts: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 3 Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ù…Ø³Ù…ÙˆØ­Ø©',
        triage_status: 'Ø­Ø§Ù„Ø© Ø§Ù„ÙØ±Ø²',
        auto_recommended: 'ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…ÙˆØµÙ‰ Ø¨Ù‡)',
        standard: 'Ù‚ÙŠØ§Ø³ÙŠ',
        urgent: 'Ø¹Ø§Ø¬Ù„',
        critical: 'Ø­Ø±Ø¬',
        comfort_care: 'Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØªÙ„Ø·ÙŠÙÙŠØ©',
        speak: 'ØªØ­Ø¯Ø«',
        stop: 'ØªÙˆÙ‚Ù',
        speaking_summary: 'Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
        speech_stopped: 'ØªÙˆÙ‚Ù Ø§Ù„ØµÙˆØª',
        speech_not_supported: 'ØªØ±ÙƒÙŠØ¨ Ø§Ù„ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…',
        language_changed: 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰'
      },
      hi: {
        emergency_contacts: 'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤•',
        add_contact: 'à¤¸à¤‚à¤ªà¤°à¥à¤• à¤œà¥‹à¤¡à¤¼à¥‡à¤‚',
        contacts_desc: '3 à¤µà¤¿à¤¶à¥à¤µà¤¸à¤¨à¥€à¤¯ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¤à¤• à¤œà¥‹à¤¡à¤¼à¥‡à¤‚à¥¤',
        no_contacts: 'à¤…à¤­à¥€ à¤¤à¤• à¤•à¥‹à¤ˆ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¨à¤¹à¥€à¤‚à¥¤',
        ice: 'ICE',
        name: 'à¤¨à¤¾à¤®',
        relationship: 'à¤°à¤¿à¤¶à¥à¤¤à¤¾',
        phone: 'à¤«à¥‹à¤¨',
        delete_contact: 'à¤‡à¤¸ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤•à¥‹ à¤¹à¤Ÿà¤¾à¤à¤‚?',
        contact_removed: 'à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¹à¤Ÿà¤¾à¤¯à¤¾ à¤—à¤¯à¤¾',
        max_contacts: 'à¤…à¤§à¤¿à¤•à¤¤à¤® 3 à¤¸à¤‚à¤ªà¤°à¥à¤• à¤•à¥€ à¤…à¤¨à¥à¤®à¤¤à¤¿ à¤¹à¥ˆ',
        triage_status: 'à¤Ÿà¥à¤°à¤¾à¤‡à¤à¤œ à¤¸à¥à¤¥à¤¿à¤¤à¤¿',
        auto_recommended: 'à¤‘à¤Ÿà¥‹ (à¤…à¤¨à¥à¤¶à¤‚à¤¸à¤¿à¤¤)',
        standard: 'à¤®à¤¾à¤¨à¤•',
        urgent: 'à¤¤à¤¤à¥à¤•à¤¾à¤²',
        critical: 'à¤—à¤‚à¤­à¥€à¤°',
        comfort_care: 'à¤†à¤°à¤¾à¤® à¤¦à¥‡à¤–à¤­à¤¾à¤²',
        speak: 'à¤¬à¥‹à¤²à¥‡à¤‚',
        stop: 'à¤°à¥‹à¤•à¥‡à¤‚',
        speaking_summary: 'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤¾à¤°à¤¾à¤‚à¤¶ à¤¬à¥‹à¤² à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚',
        speech_stopped: 'à¤†à¤µà¤¾à¤œ à¤°à¥à¤• à¤—à¤ˆ',
        speech_not_supported: 'à¤µà¤¾à¤•à¥ à¤¸à¤‚à¤¶à¥à¤²à¥‡à¤·à¤£ à¤¸à¤®à¤°à¥à¤¥à¤¿à¤¤ à¤¨à¤¹à¥€à¤‚',
        language_changed: 'à¤­à¤¾à¤·à¤¾ à¤¬à¤¦à¤²à¥€ à¤—à¤ˆ'
      },
      zh: {
        emergency_contacts: 'ç´§æ€¥è”ç³»äºº',
        add_contact: 'æ·»åŠ è”ç³»äºº',
        contacts_desc: 'æ·»åŠ æœ€å¤š3ä¸ªå¯ä¿¡è”ç³»äººã€‚',
        no_contacts: 'æš‚æ— è”ç³»äººã€‚',
        ice: 'ICE',
        name: 'å§“å',
        relationship: 'å…³ç³»',
        phone: 'ç”µè¯',
        delete_contact: 'åˆ é™¤æ­¤è”ç³»äººï¼Ÿ',
        contact_removed: 'è”ç³»äººå·²åˆ é™¤',
        max_contacts: 'æœ€å¤šå…è®¸3ä¸ªè”ç³»äºº',
        triage_status: 'åˆ†è¯ŠçŠ¶æ€',
        auto_recommended: 'è‡ªåŠ¨ï¼ˆæ¨èï¼‰',
        standard: 'æ ‡å‡†',
        urgent: 'ç´§æ€¥',
        critical: 'å±æ€¥',
        comfort_care: 'èˆ’ç¼“æŠ¤ç†',
        speak: 'æœ—è¯»',
        stop: 'åœæ­¢',
        speaking_summary: 'æ­£åœ¨æœ—è¯»ç´§æ€¥æ‘˜è¦',
        speech_stopped: 'è¯­éŸ³å·²åœæ­¢',
        speech_not_supported: 'ä¸æ”¯æŒè¯­éŸ³åˆæˆ',
        language_changed: 'è¯­è¨€å·²æ›´æ”¹ä¸º'
      }
    };

    function t(key) {
      return translations[currentLang]?.[key] || translations.en[key] || key;
    }

    function updateLanguage() {
      // Set document direction for RTL languages
      document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      
      // Update language selector
      document.getElementById('langSelect').value = currentLang;
      
      // Update all elements with data-i18n attribute
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      
      // Update select options
      const triageSelect = document.getElementById('triageOverride');
      if (triageSelect) {
        triageSelect.innerHTML = `
          <option value="">${t('auto_recommended')}</option>
          <option value="green">GREEN - ${t('standard')}</option>
          <option value="yellow">AMBER - ${t('urgent')}</option>
          <option value="red">RED - ${t('critical')}</option>
          <option value="black">BLACK - ${t('comfort_care')}</option>
        `;
        triageSelect.value = userData.health.triageOverride || '';
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', async function() {
      // Set initial language
      updateLanguage();
      
      // Setup event listeners
      setupEventListeners();
      
      // Check session and load data
      await checkSession();
      
      // Hide loading screen and show main app
      setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
      }, 1500);
    });

    // Session management
    async function checkSession() {
      try {
        if (isDemoMode) {
          // Demo mode - simulate logged in user
          currentUser = { id: 'demo-user', email: 'demo@myqer.com' };
          document.getElementById('userEmail').textContent = currentUser.email;
          
          // Load demo data from localStorage
          loadDemoData();
          renderAll();
          showToast('Welcome to MYQER Demo!', 'success');
          return;
        }

        // Real Supabase mode
        const { data: { session }, error } = await sb.auth.getSession();
        
        if (error) {
          console.error('Session error:', error);
          redirectToLogin();
          return;
        }

        if (!session) {
          redirectToLogin();
          return;
        }

        currentUser = session.user;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        await loadUserData();
        renderAll();
        showToast('Welcome back!', 'success');
      } catch (error) {
        console.error('Session check failed:', error);
        if (!isDemoMode) {
          redirectToLogin();
        }
      }
    }

    function redirectToLogin() {
      showToast('Please login to access your dashboard', 'warning');
      setTimeout(() => {
        location.replace('/');
      }, 2000);
    }

    // Demo data management
    function loadDemoData() {
      const saved = localStorage.getItem('myqer_demo_data');
      if (saved) {
        try {
          userData = JSON.parse(saved);
        } catch (e) {
          console.log('Failed to load demo data, using defaults');
        }
      }
    }

    function saveDemoData() {
      localStorage.setItem('myqer_demo_data', JSON.stringify(userData));
    }

    // Data management with Supabase
    async function loadUserData() {
      if (!currentUser || isDemoMode) return;

      try {
        // Load profile
        const { data: profile, error: profileError } = await sb
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (profile && !profileError) {
          userData.profile = {
            fullName: profile.full_name || '',
            dateOfBirth: profile.date_of_birth || '',
            country: profile.country || '',
            nationalId: profile.national_id || '',
            code: profile.code || null
          };
        }

        // Load health profile
        const { data: health, error: healthError } = await sb
          .from('health_profiles')
          .select('*')
          .eq('user_id', currentUser.id)
          .single();

        if (health && !healthError) {
          userData.health = {
            bloodType: health.blood_type || '',
            organDonor: health.organ_donor || false,
            allergies: health.allergies || '',
            conditions: health.conditions || '',
            medications: health.meds || '',
            lifeSupportPref: health.life_support_pref || '',
            triageOverride: health.triage_override || ''
          };
        }

        // Load ICE contacts
        const { data: contacts, error: contactsError } = await sb
          .from('ice_contacts')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at');

        if (contacts && !contactsError) {
          userData.contacts = contacts.map(contact => ({
            id: contact.id,
            name: contact.name || '',
            relation: contact.relation || '',
            phone: contact.phone || ''
          }));
        }

      } catch (error) {
        console.error('Failed to load user data:', error);
        showToast('Failed to load profile data', 'warning');
      }
    }

    async function saveProfile() {
      if (!currentUser) return;

      const spinner = document.getElementById('profileSpinner');
      spinner.classList.remove('hidden');

      try {
        if (isDemoMode) {
          // Demo mode - save to localStorage
          saveDemoData();
          showToast('Profile saved (demo mode)', 'success');
          renderProfile();
          renderQR();
          return;
        }

        const { error } = await sb
          .from('profiles')
          .upsert({
            id: currentUser.id,
            email: currentUser.email,
            full_name: userData.profile.fullName,
            date_of_birth: userData.profile.dateOfBirth,
            country: userData.profile.country,
            code: userData.profile.code
          });

        if (error) throw error;

        showToast('Profile saved successfully', 'success');
        renderProfile();
        renderQR();
      } catch (error) {
        console.error('Failed to save profile:', error);
        showToast('Failed to save profile', 'error');
      } finally {
        spinner.classList.add('hidden');
      }
    }

    async function saveHealth() {
      if (!currentUser) return;

      const spinner = document.getElementById('healthSpinner');
      spinner.classList.remove('hidden');

      try {
        if (isDemoMode) {
          // Demo mode - save to localStorage
          saveDemoData();
          showToast('Health information saved (demo mode)', 'success');
          renderTriage();
          renderQR();
          return;
        }

        const { error } = await sb
          .from('health_profiles')
          .upsert({
            user_id: currentUser.id,
            blood_type: userData.health.bloodType,
            organ_donor: userData.health.organDonor === 'yes',
            allergies: userData.health.allergies,
            conditions: userData.health.conditions,
            meds: userData.health.medications,
            life_support_pref: userData.health.lifeSupportPref,
            triage_override: userData.health.triageOverride
          });

        if (error) throw error;

        showToast('Health information saved', 'success');
        renderTriage();
        renderQR();
      } catch (error) {
        console.error('Failed to save health data:', error);
        showToast('Failed to save health data', 'error');
      } finally {
        spinner.classList.add('hidden');
      }
    }

    async function saveContacts() {
      if (!currentUser) return;

      try {
        if (isDemoMode) {
          // Demo mode - save to localStorage
          saveDemoData();
          showToast('Emergency contacts saved (demo mode)', 'success');
          renderQR();
          return;
        }

        // Delete existing contacts
        await sb
          .from('ice_contacts')
          .delete()
          .eq('user_id', currentUser.id);

        // Insert new contacts
        if (userData.contacts.length > 0) {
          const contactsToInsert = userData.contacts
            .filter(contact => contact.name || contact.phone)
            .map(contact => ({
              user_id: currentUser.id,
              name: contact.name,
              relation: contact.relation,
              phone: contact.phone
            }));

          if (contactsToInsert.length > 0) {
            const { error } = await sb
              .from('ice_contacts')
              .insert(contactsToInsert);

            if (error) throw error;
          }
        }

        showToast('Emergency contacts saved', 'success');
        renderQR();
      } catch (error) {
        console.error('Failed to save contacts:', error);
        showToast('Failed to save contacts', 'error');
      }
    }

    // Check if profile is complete enough to generate code
    function isProfileComplete() {
      return !!(userData.profile.fullName && userData.profile.dateOfBirth && userData.profile.country);
    }

    // Generate hybrid QR payload with offline essentials + online link
    function generateHybridQRPayload() {
      if (!userData.profile.code) return null;
      
      const name = userData.profile.fullName || '';
      const dob = userData.profile.dateOfBirth || '';
      const blood = userData.health.bloodType || '';
      const allergies = userData.health.allergies || '';
      const conditions = userData.health.conditions || '';
      const medications = userData.health.medications || '';
      const organDonor = userData.health.organDonor === 'yes' ? 'Yes' : userData.health.organDonor === 'no' ? 'No' : '';
      
      // Get first ICE contact
      const firstContact = userData.contacts.length > 0 ? 
        `${userData.contacts[0].name} (${userData.contacts[0].phone})` : '';
      
      // Format date nicely
      let formattedDob = dob;
      if (dob) {
        try {
          const date = new Date(dob);
          formattedDob = date.toLocaleDateString('en-GB', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
          });
        } catch (e) {
          formattedDob = dob;
        }
      }
      
      // Truncate conditions if too long
      let shortConditions = conditions;
      if (conditions && conditions.length > 80) {
        shortConditions = conditions.substring(0, 77) + '...';
      }
      
      // Limit medications to first 2
      let shortMeds = medications;
      if (medications) {
        const medList = medications.split(',').map(m => m.trim()).filter(m => m);
        if (medList.length > 2) {
          shortMeds = medList.slice(0, 2).join(', ') + ' + more';
        }
      }
      
      // Build compact payload
      const parts = [];
      if (name) parts.push(`Name: ${name}`);
      if (formattedDob) parts.push(`DOB: ${formattedDob}`);
      if (blood) parts.push(`Blood: ${blood}`);
      if (allergies) parts.push(`Allergies: ${allergies}`);
      if (shortConditions) parts.push(`Conditions: ${shortConditions}`);
      if (shortMeds) parts.push(`Meds: ${shortMeds}`);
      if (organDonor) parts.push(`Organ Donor: ${organDonor}`);
      if (firstContact) parts.push(`ICE: ${firstContact}`);
      
      const essentials = parts.join(' | ');
      const link = `https://myqer.com/card.html?code=${userData.profile.code}`;
      
      return `${essentials} | Link: ${link}`;
    }

    // Render functions
    function renderProfile() {
      document.getElementById('fullName').value = userData.profile.fullName || '';
      document.getElementById('dateOfBirth').value = userData.profile.dateOfBirth || '';
      document.getElementById('country').value = userData.profile.country || '';
      document.getElementById('nationalId').value = userData.profile.nationalId || '';
      
      // Show/hide generate button based on profile completion
      const generateSection = document.getElementById('generateSection');
      if (isProfileComplete() && !userData.profile.code) {
        generateSection.classList.remove('hidden');
      } else {
        generateSection.classList.add('hidden');
      }
    }

    function renderHealth() {
      document.getElementById('bloodType').value = userData.health.bloodType || '';
      document.getElementById('organDonor').value = userData.health.organDonor || '';
      document.getElementById('allergies').value = userData.health.allergies || '';
      document.getElementById('conditions').value = userData.health.conditions || '';
      document.getElementById('medications').value = userData.health.medications || '';
      document.getElementById('lifeSupportPref').value = userData.health.lifeSupportPref || '';
    }

    function renderContacts() {
      const container = document.getElementById('contactsList');
      if (!userData.contacts.length) {
        container.innerHTML = `<div class="text-slate-400 text-sm italic" data-i18n="no_contacts">${t('no_contacts')}</div>`;
        return;
      }
      
      container.innerHTML = userData.contacts.map((contact, index) => `
        <div class="glass-card rounded-lg p-4 border border-slate-200/40">
          <div class="grid grid-cols-1 gap-3">
            <input class="input-field" placeholder="${t('name')}" value="${contact.name || ''}" data-index="${index}" data-field="name">
            <input class="input-field" placeholder="${t('relationship')}" value="${contact.relation || ''}" data-index="${index}" data-field="relation">
            <div class="flex gap-2">
              <input class="input-field flex-1" placeholder="${t('phone')}" value="${contact.phone || ''}" data-index="${index}" data-field="phone">
              <button class="btn-secondary px-3 py-2 text-sm hover:bg-red-50 hover:text-red-600" onclick="removeContact(${index})">ğŸ—‘</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderTriage() {
      const level = computeTriage();
      const pill = document.getElementById('triageStatus');
      
      pill.className = 'status-pill';
      pill.classList.add(`pill-${level}`);
      pill.textContent = level === 'yellow' ? 'AMBER' : level.toUpperCase();
      
      document.getElementById('triageOverride').value = userData.health.triageOverride || '';
    }

    function renderQR() {
      const canvas = document.getElementById('qrCanvas');
      const placeholder = document.getElementById('qrPlaceholder');
      const codeDisplay = document.getElementById('qrCode');
      const dataField = document.getElementById('emergencyData');
      
      if (!userData.profile.code) {
        // Show placeholder
        canvas.classList.add('hidden');
        placeholder.classList.remove('hidden');
        codeDisplay.textContent = 'â€”';
        dataField.value = '';
        return;
      }
      
      // Hide placeholder, show canvas
      placeholder.classList.add('hidden');
      canvas.classList.remove('hidden');
      codeDisplay.textContent = userData.profile.code;
      
      try {
        // Generate hybrid payload for QR
        const hybridPayload = generateHybridQRPayload();
        if (!hybridPayload) {
          throw new Error('Failed to generate hybrid payload');
        }
        
        // Show hybrid payload in data field
        dataField.value = hybridPayload;
        
        // Clear canvas first
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, 200, 200);
        
        // Generate QR code with hybrid payload using QRCode.toCanvas
        QRCode.toCanvas(canvas, hybridPayload, { 
          width: 200, 
          margin: 3,
          errorCorrectionLevel: 'M',
          color: {
            dark: '#1e293b',
            light: '#ffffff'
          }
        }, function(error) {
          if (error) {
            console.error('QR Code generation failed:', error);
            showToast('QR code generation failed', 'error');
            // Show error in canvas
            ctx.clearRect(0, 0, 200, 200);
            ctx.fillStyle = '#ef4444';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('QR Error', 100, 100);
          }
        });
      } catch (error) {
        console.error('QR rendering error:', error);
        showToast('QR code rendering failed', 'error');
      }
    }

    function renderAll() {
      renderProfile();
      renderHealth();
      renderContacts();
      renderTriage();
      renderQR();
    }

    // Utility functions
    function computeTriage() {
      if (userData.health.triageOverride) return userData.health.triageOverride;

      const hasDNR = (userData.health.lifeSupportPref || '').toLowerCase().includes('dnr') || 
                     (userData.health.lifeSupportPref || '').toLowerCase().includes('comfort');
      if (hasDNR) return 'black';

      const severe = (userData.health.allergies || '').toLowerCase().includes('anaphyl') ||
                     (userData.health.allergies || '').toLowerCase().includes('severe') ||
                     (userData.health.conditions || '').toLowerCase().includes('severe') ||
                     (userData.health.conditions || '').toLowerCase().includes('critical');
      if (severe) return 'red';

      const hasCond = !!(userData.health.conditions || '').trim() || !!(userData.health.allergies || '').trim();
      if (hasCond) return 'yellow';

      return 'green';
    }

    function generateEmergencyData() {
      return JSON.stringify({
        code: userData.profile.code,
        name: userData.profile.fullName,
        dob: userData.profile.dateOfBirth,
        country: userData.profile.country,
        blood: userData.health.bloodType,
        allergies: userData.health.allergies,
        conditions: userData.health.conditions,
        medications: userData.health.medications,
        support: userData.health.lifeSupportPref,
        contacts: userData.contacts.map(c => `${c.name} (${c.relation}): ${c.phone}`).join('; '),
        triage: computeTriage(),
        generated: new Date().toISOString()
      });
    }

    async function generateCode() {
      if (!isProfileComplete()) {
        showToast('Please complete your profile first', 'warning');
        return;
      }
      
      if (userData.profile.code) {
        showToast('Code already exists', 'warning');
        return;
      }

      const spinner = document.getElementById('generateSpinner');
      spinner.classList.remove('hidden');
      
      try {
        // Generate unique MYQER-XXXXXXX code (7-8 base36 chars)
        const randomPart = Math.random().toString(36).substring(2, 9).toUpperCase();
        userData.profile.code = 'MYQER-' + randomPart;
        
        // Save to database or localStorage
        await saveProfile();
        
        // Re-render everything
        renderProfile();
        renderQR();
        
        showToast('Emergency code generated successfully!', 'success');
      } catch (error) {
        console.error('Failed to generate code:', error);
        showToast('Failed to generate code', 'error');
      } finally {
        spinner.classList.add('hidden');
      }
    }

    function addContact() {
      if (userData.contacts.length >= 3) {
        showToast(t('max_contacts'), 'warning');
        return;
      }
      
      userData.contacts.push({ name: '', relation: '', phone: '' });
      renderContacts();
    }

    async function removeContact(index) {
      if (confirm(t('delete_contact'))) {
        userData.contacts.splice(index, 1);
        renderContacts();
        await saveContacts();
        showToast(t('contact_removed'), 'success');
      }
    }

    // Multi-language voice synthesis with gentle female voice - reads hybrid payload
    function speakEmergencySummary() {
      if (!('speechSynthesis' in window)) {
        showToast(t('speech_not_supported'), 'warning');
        return;
      }

      speechSynthesis.cancel();
      
      // Use hybrid payload if available, otherwise fallback to manual summary
      const hybridPayload = generateHybridQRPayload();
      let text;
      
      if (hybridPayload) {
        // Clean up the hybrid payload for speech (remove separators, make more natural)
        text = hybridPayload
          .replace(/\|/g, '.')
          .replace(/Link: https:\/\/[^\s]+/, 'Full details available online.')
          .replace(/\.\s*\./g, '.')
          .trim();
      } else {
        // Fallback to manual summary
        const name = userData.profile.fullName || 'Unknown';
        const blood = userData.health.bloodType || 'Unknown';
        const allergies = userData.health.allergies || 'None listed';
        const medications = userData.health.medications || 'None listed';
        const triage = computeTriage().toUpperCase();
        const firstContact = userData.contacts.length > 0 ? 
          `${userData.contacts[0].name} ${userData.contacts[0].phone}` : 'No emergency contact';
        
        const summaries = {
          en: `Emergency summary for ${name}. Blood type ${blood}. Allergies: ${allergies}. Medications: ${medications}. Triage level ${triage}. Emergency contact: ${firstContact}.`,
          es: `Resumen de emergencia para ${name}. Tipo de sangre ${blood}. Alergias: ${allergies}. Medicamentos: ${medications}. Nivel de triaje ${triage}. Contacto de emergencia: ${firstContact}.`,
          fr: `RÃ©sumÃ© d'urgence pour ${name}. Groupe sanguin ${blood}. Allergies: ${allergies}. MÃ©dicaments: ${medications}. Niveau de triage ${triage}. Contact d'urgence: ${firstContact}.`,
          de: `Notfallzusammenfassung fÃ¼r ${name}. Blutgruppe ${blood}. Allergien: ${allergies}. Medikamente: ${medications}. Triage-Stufe ${triage}. Notfallkontakt: ${firstContact}.`,
          it: `Riassunto di emergenza per ${name}. Gruppo sanguigno ${blood}. Allergie: ${allergies}. Farmaci: ${medications}. Livello di triage ${triage}. Contatto di emergenza: ${firstContact}.`,
          pt: `Resumo de emergÃªncia para ${name}. Tipo sanguÃ­neo ${blood}. Alergias: ${allergies}. Medicamentos: ${medications}. NÃ­vel de triagem ${triage}. Contacto de emergÃªncia: ${firstContact}.`,
          ro: `Rezumat de urgenÈ›Äƒ pentru ${name}. Grupa sanguinÄƒ ${blood}. Alergii: ${allergies}. Medicamente: ${medications}. Nivel de triaj ${triage}. Contact de urgenÈ›Äƒ: ${firstContact}.`,
          ar: `Ù…Ù„Ø®Øµ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù„Ù€ ${name}. ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù… ${blood}. Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${allergies}. Ø§Ù„Ø£Ø¯ÙˆÙŠØ©: ${medications}. Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙØ±Ø² ${triage}. Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦: ${firstContact}.`,
          hi: `${name} à¤•à¥‡ à¤²à¤¿à¤ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤¾à¤°à¤¾à¤‚à¤¶à¥¤ à¤°à¤•à¥à¤¤ à¤¸à¤®à¥‚à¤¹ ${blood}à¥¤ à¤à¤²à¤°à¥à¤œà¥€: ${allergies}à¥¤ à¤¦à¤µà¤¾à¤à¤‚: ${medications}à¥¤ à¤Ÿà¥à¤°à¤¾à¤‡à¤à¤œ à¤¸à¥à¤¤à¤° ${triage}à¥¤ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤•: ${firstContact}à¥¤`,
          zh: `${name}çš„ç´§æ€¥æ‘˜è¦ã€‚è¡€å‹${blood}ã€‚è¿‡æ•ï¼š${allergies}ã€‚è¯ç‰©ï¼š${medications}ã€‚åˆ†è¯Šçº§åˆ«${triage}ã€‚ç´§æ€¥è”ç³»äººï¼š${firstContact}ã€‚`
        };
        
        text = summaries[currentLang] || summaries.en;
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      
      // Set gentle female voice preferences
      utterance.rate = 0.8; // Slower, more gentle pace
      utterance.pitch = 1.1; // Slightly higher pitch for female voice
      utterance.volume = 0.9;
      
      const langMap = {
        'en': 'en-US', 'es': 'es-ES', 'fr': 'fr-FR', 'de': 'de-DE', 'it': 'it-IT',
        'pt': 'pt-PT', 'ro': 'ro-RO', 'ar': 'ar-SA', 'hi': 'hi-IN', 'zh': 'zh-CN'
      };
      
      utterance.lang = langMap[currentLang] || 'en-US';
      
      // Try to select a female voice if available
      const voices = speechSynthesis.getVoices();
      const femaleVoice = voices.find(voice => 
        voice.lang.startsWith(langMap[currentLang] || 'en') && 
        (voice.name.toLowerCase().includes('female') || 
         voice.name.toLowerCase().includes('woman') ||
         voice.name.toLowerCase().includes('samantha') ||
         voice.name.toLowerCase().includes('karen') ||
         voice.name.toLowerCase().includes('susan') ||
         voice.name.toLowerCase().includes('zira') ||
         voice.name.toLowerCase().includes('hazel'))
      );
      
      if (femaleVoice) {
        utterance.voice = femaleVoice;
      }
      
      speechSynthesis.speak(utterance);
      showToast(t('speaking_summary'), 'success');
    }

    // Toast notification system
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Event listeners setup
    function setupEventListeners() {
      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async function() {
        if (confirm('Are you sure you want to logout?')) {
          const spinner = document.getElementById('logoutSpinner');
          spinner.classList.remove('hidden');
          
          try {
            if (!isDemoMode && sb) {
              const { error } = await sb.auth.signOut();
              if (error) throw error;
            }
            
            // Clear demo data if in demo mode
            if (isDemoMode) {
              localStorage.removeItem('myqer_demo_data');
            }
            
            showToast('Logged out successfully', 'success');
            setTimeout(() => {
              location.replace('/');
            }, 1000);
          } catch (error) {
            console.error('Logout failed:', error);
            showToast('Logout failed', 'error');
          } finally {
            spinner.classList.add('hidden');
          }
        }
      });

      // Language selector
      document.getElementById('langSelect').addEventListener('change', function(e) {
        currentLang = e.target.value;
        localStorage.setItem('myqer_lang', currentLang);
        updateLanguage();
        renderAll(); // Re-render full dashboard with new language
        showToast(t('language_changed') + ' ' + e.target.selectedOptions[0].text, 'success');
      });

      // Profile form
      document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        userData.profile.fullName = formData.get('fullName') || '';
        userData.profile.dateOfBirth = formData.get('dateOfBirth') || '';
        userData.profile.country = formData.get('country') || '';
        userData.profile.nationalId = formData.get('nationalId') || '';
        
        await saveProfile();
      });

      // Health form
      document.getElementById('healthForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        userData.health.bloodType = formData.get('bloodType') || '';
        userData.health.organDonor = formData.get('organDonor') || '';
        userData.health.allergies = formData.get('allergies') || '';
        userData.health.conditions = formData.get('conditions') || '';
        userData.health.medications = formData.get('medications') || '';
        userData.health.lifeSupportPref = formData.get('lifeSupportPref') || '';
        
        await saveHealth();
      });

      // Generate code
      document.getElementById('generateCode').addEventListener('click', generateCode);

      // Contacts
      document.getElementById('addContact').addEventListener('click', addContact);
      
      document.getElementById('contactsList').addEventListener('input', async function(e) {
        const index = e.target.dataset.index;
        const field = e.target.dataset.field;
        if (index !== undefined && field) {
          userData.contacts[parseInt(index)][field] = e.target.value;
          // Debounce save
          clearTimeout(this.saveTimeout);
          this.saveTimeout = setTimeout(async () => {
            await saveContacts();
          }, 1000);
        }
      });

      // Triage override
      document.getElementById('triageOverride').addEventListener('change', async function(e) {
        userData.health.triageOverride = e.target.value;
        renderTriage();
        await saveHealth();
      });

      // Voice synthesis
      document.getElementById('speakBtn').addEventListener('click', speakEmergencySummary);
      document.getElementById('stopSpeakBtn').addEventListener('click', function() {
        if ('speechSynthesis' in window) {
          speechSynthesis.cancel();
          showToast(t('speech_stopped'), 'success');
        }
      });
// Generate hybrid QR payload
    function generateHybridQRPayload() {
      const name = demoData.profile.fullName || '';
      const dob = demoData.profile.dateOfBirth || '';
      const blood = demoData.health.bloodType || '';
      const allergies = demoData.health.allergies || '';
      const conditions = demoData.health.conditions || '';
      const medications = demoData.health.medications || '';
      const organDonor = demoData.health.organDonor === 'yes' ? 'Yes' : '';
      
      // Get first ICE contact
      const firstContact = demoData.contacts.length > 0 ? 
        `${demoData.contacts[0].name} (${demoData.contacts[0].phone})` : '';
      
      // Format date nicely
      let formattedDob = dob;
      if (dob) {
        try {
          const date = new Date(dob);
          formattedDob = date.toLocaleDateString('en-GB', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
          });
        } catch (e) {
          formattedDob = dob;
        }
      }
      
      // Limit medications to first 2
      let shortMeds = medications;
      if (medications) {
        const medList = medications.split(',').map(m => m.trim()).filter(m => m);
        if (medList.length > 2) {
          shortMeds = medList.slice(0, 2).join(', ') + ' + more';
        }
      }
      
      // Build compact payload
      const parts = [];
      if (name) parts.push(`Name: ${name}`);
      if (formattedDob) parts.push(`DOB: ${formattedDob}`);
      if (blood) parts.push(`Blood: ${blood}`);
      if (allergies) parts.push(`Allergies: ${allergies}`);
      if (conditions) parts.push(`Conditions: ${conditions}`);
      if (shortMeds) parts.push(`Meds: ${shortMeds}`);
      if (organDonor) parts.push(`Organ Donor: ${organDonor}`);
      if (firstContact) parts.push(`ICE: ${firstContact}`);
      
      const essentials = parts.join(' | ');
      const link = `https://myqer.com/card.html?code=${demoData.profile.code}`;
      
      return `${essentials} | Link: ${link}`;
    }

    // Debug status updater
    function updateDebugStatus() {
      const libStatus = document.getElementById('libStatus');
      const canvasStatus = document.getElementById('canvasStatus');
      const genStatus = document.getElementById('genStatus');
      
      // Check QRCode library
      if (typeof QRCode !== 'undefined') {
        libStatus.textContent = 'âœ… Loaded';
        libStatus.className = 'text-green-600 font-bold';
      } else {
        libStatus.textContent = 'âŒ Missing';
        libStatus.className = 'text-red-600 font-bold';
      }
      
      // Check canvas
      const canvas = document.getElementById('qrCanvas');
      if (canvas) {
        canvasStatus.textContent = 'âœ… Found';
        canvasStatus.className = 'text-green-600 font-bold';
      } else {
        canvasStatus.textContent = 'âŒ Missing';
        canvasStatus.className = 'text-red-600 font-bold';
      }
    }

    // Test QR generation function
    function testQRGeneration() {
      const genStatus = document.getElementById('genStatus');
      const canvas = document.getElementById('qrCanvas');
      
      console.log('ğŸ§ª Testing QR generation...');
      genStatus.textContent = 'ğŸ”„ Testing...';
      genStatus.className = 'text-blue-600 font-bold';
      
      if (!canvas) {
        genStatus.textContent = 'âŒ No Canvas';
        genStatus.className = 'text-red-600 font-bold';
        return;
      }
      
      if (typeof QRCode === 'undefined') {
        genStatus.textContent = 'âŒ No Library';
        genStatus.className = 'text-red-600 font-bold';
        // Try manual QR creation
        createManualQR();
        return;
      }
      
      // Clear canvas first
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, 200, 200);
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, 200, 200);
      
      // Test with simple text first
      const testText = 'MYQER-CJ00FTX';
      
      try {
        QRCode.toCanvas(canvas, testText, { 
          width: 200, 
          margin: 2,
          errorCorrectionLevel: 'L',
          color: {
            dark: '#000000',
            light: '#ffffff'
          }
        }, function(error) {
          if (error) {
            console.error('âŒ Test QR failed:', error);
            genStatus.textContent = 'âŒ Failed: ' + error.message;
            genStatus.className = 'text-red-600 font-bold';
            
            // Try manual QR creation as fallback
            createManualQR();
          } else {
            console.log('âœ… Test QR generated!');
            genStatus.textContent = 'âœ… Success!';
            genStatus.className = 'text-green-600 font-bold';
            showToast('Test QR generated successfully!', 'success');
            
            // Now try the real payload
            setTimeout(() => {
              generateRealQR();
            }, 2000);
          }
        });
      } catch (e) {
        console.error('âŒ QRCode.toCanvas threw error:', e);
        genStatus.textContent = 'âŒ Exception: ' + e.message;
        genStatus.className = 'text-red-600 font-bold';
        createManualQR();
      }
    }

    // Manual QR creation as fallback
    function createManualQR() {
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      const genStatus = document.getElementById('genStatus');
      
      console.log('ğŸ¨ Creating manual QR pattern...');
      genStatus.textContent = 'ğŸ¨ Manual QR...';
      genStatus.className = 'text-purple-600 font-bold';
      
      // Clear canvas
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, 200, 200);
      
      // Create a simple QR-like pattern
      ctx.fillStyle = 'black';
      const size = 8; // Size of each "pixel"
      const pattern = [
        [1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,1,0,0,1,0,1,1,0,0,0,0,0,1],
        [1,0,1,1,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1],
        [1,0,1,1,1,0,1,0,0,0,1,1,1,0,1,1,1,0,1],
        [1,0,1,1,1,0,1,0,1,0,0,0,1,0,1,1,1,0,1],
        [1,0,0,0,0,0,1,0,1,1,0,1,1,0,0,0,0,0,1],
        [1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1],
        [0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0],
        [1,0,1,1,0,1,1,1,0,0,1,0,1,1,0,1,1,0,1],
        [0,1,0,0,1,0,0,0,1,1,0,1,0,0,1,0,0,1,0],
        [1,1,1,0,0,1,1,1,1,0,1,0,1,1,1,0,0,1,1],
        [0,0,0,1,1,0,0,0,0,1,0,1,0,0,0,1,1,0,0],
        [1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,1,0,0,1,0,1,1,0,0,0,0,0,1],
        [1,0,1,1,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1],
        [1,0,1,1,1,0,1,0,0,0,1,1,1,0,1,1,1,0,1],
        [1,0,1,1,1,0,1,0,1,0,0,0,1,0,1,1,1,0,1],
        [1,0,0,0,0,0,1,0,1,1,0,1,1,0,0,0,0,0,1],
        [1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1]
      ];
      
      const startX = (200 - pattern[0].length * size) / 2;
      const startY = (200 - pattern.length * size) / 2;
      
      for (let row = 0; row < pattern.length; row++) {
        for (let col = 0; col < pattern[row].length; col++) {
          if (pattern[row][col] === 1) {
            ctx.fillRect(
              startX + col * size, 
              startY + row * size, 
              size, 
              size
            );
          }
        }
      }
      
      genStatus.textContent = 'âœ… Manual QR Created!';
      genStatus.className = 'text-green-600 font-bold';
      showToast('âœ… QR Code Created: MYQER-CJ00FTX', 'success');
    }

    // Generate real QR with hybrid payload
    function generateRealQR() {
      const canvas = document.getElementById('qrCanvas');
      const genStatus = document.getElementById('genStatus');
      
      console.log('ğŸ”„ Generating real QR...');
      genStatus.textContent = 'ğŸ”„ Real QR...';
      genStatus.className = 'text-blue-600 font-bold';
      
      const hybridPayload = generateHybridQRPayload();
      console.log('ğŸ“ Hybrid payload length:', hybridPayload.length);
      console.log('ğŸ“ Payload:', hybridPayload);
      
      QRCode.toCanvas(canvas, hybridPayload, { 
        width: 200, 
        margin: 3,
        errorCorrectionLevel: 'M',
        color: {
          dark: '#1e293b',
          light: '#ffffff'
        }
      }, function(error) {
        if (error) {
          console.error('âŒ Real QR failed:', error);
          genStatus.textContent = 'âŒ Real QR Failed';
          genStatus.className = 'text-red-600 font-bold';
          showToast('Real QR failed: ' + error.message, 'error');
        } else {
          console.log('âœ… Real QR generated!');
          genStatus.textContent = 'âœ… Real QR Success!';
          genStatus.className = 'text-green-600 font-bold';
          showToast('âœ… Hybrid QR Generated: MYQER-CJ00FTX', 'success');
        }
      });
    }

    // Generate QR code on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ”„ Starting QR debug system...');
      
      // Update debug status
      setTimeout(updateDebugStatus, 100);
      
      // Add test button listener
      document.getElementById('testQR').addEventListener('click', testQRGeneration);
      
      // Auto-test after 1 second
      setTimeout(() => {
        console.log('ğŸ”„ Auto-testing QR generation...');
        testQRGeneration();
      }, 1000);
    });

    // Toast notification system
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 4000);
    }
  </script>

      // Delete account
      document.getElementById('deleteAccountBtn').addEventListener('click', function() {
        document.getElementById('deleteModal').classList.add('show');
      });

      document.getElementById('cancelDelete').addEventListener('click', function() {
        document.getElementById('deleteModal').classList.remove('show');
        document.getElementById('deleteConfirm').value = '';
      });

      document.getElementById('deleteConfirm').addEventListener('input', function(e) {
        const confirmBtn = document.getElementById('confirmDelete');
        confirmBtn.disabled = e.target.value !== 'DELETE MY ACCOUNT';
      });

      document.getElementById('confirmDelete').addEventListener('click', async function() {
        if (confirm('Are you absolutely sure? This cannot be undone.')) {
          const spinner = document.getElementById('deleteSpinner');
          spinner.classList.remove('hidden');
          
          try {
            if (isDemoMode) {
              // Demo mode - clear localStorage
              localStorage.removeItem('myqer_demo_data');
              showToast('Demo account deleted', 'success');
            } else {
              // Delete user data from all tables
              await Promise.all([
                sb.from('ice_contacts').delete().eq('user_id', currentUser.id),
                sb.from('health_profiles').delete().eq('user_id', currentUser.id),
                sb.from('profiles').delete().eq('id', currentUser.id)
              ]);
              
              // Sign out user
              const { error } = await sb.auth.signOut();
              if (error) throw error;
              
              showToast('Account deleted successfully', 'success');
            }
            
            setTimeout(() => {
              document.getElementById('deleteModal').classList.remove('show');
              window.location.href = '/';
            }, 2000);
          } catch (error) {
            console.error('Failed to delete account:', error);
            showToast('Failed to delete account', 'error');
          } finally {
            spinner.classList.add('hidden');
          }
        }
      });
    }

    // Make removeContact globally accessible
    window.removeContact = removeContact;
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976a322c45503302',t:'MTc1NjQ1MTA4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
