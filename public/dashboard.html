<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER™ - Emergency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.5;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.86);
            backdrop-filter: blur(18px);
            border-radius: 24px;
            box-shadow: 0 18px 40px rgba(16, 24, 40, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.25);
            position: relative;
            padding: 28px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 24px 48px rgba(16, 24, 40, 0.12);
        }
        
        @media (max-width: 768px) {
            .card {
                border-radius: 16px;
                padding: 20px;
            }
        }
        
        .ribbon {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 24px 24px 0 0;
        }
        
        @media (max-width: 768px) {
            .ribbon {
                border-radius: 16px 16px 0 0;
            }
        }
        
        .ribbon-identity { background: #16a34a; }
        .ribbon-critical { background: #dc2626; }
        .ribbon-ice { background: #ea580c; }
        .ribbon-triage { background: #0ea5e9; }
        .ribbon-vault { background: #7c3aed; }
        .ribbon-qr { background: #f59e0b; }
        .ribbon-danger { background: #dc2626; }
        
        .input-field {
            padding: 12px;
            border-radius: 8px;
            border: 1.5px solid #cbd5e1;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .input-field:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
        }
        
        .field-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 640px) {
            .field-pair {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        .label {
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            margin-bottom: 6px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .helper-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        
        .btn-primary {
            background: #dc2626;
            color: white;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-primary:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: #475569;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            border: 1.5px solid #cbd5e1;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-secondary:hover {
            border-color: #94a3b8;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
            font-weight: 700;
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .triage-pill {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .triage-green { background: #22c55e; color: white; }
        .triage-yellow { background: #f59e0b; color: white; }
        .triage-red { background: #ef4444; color: white; }
        .triage-black { background: #1f2937; color: white; }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background: #22c55e; }
        .status-offline { background: #ef4444; }
        .status-hybrid { background: #f59e0b; }
        
        .saved-indicator {
            color: #22c55e;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .saved-indicator.show {
            opacity: 1;
        }
        
        .auto-saved {
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .auto-saved.show {
            opacity: 1;
        }
        
        .qr-container {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            border: 2px solid #f1f5f9;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal.show .modal-content {
            transform: scale(1);
        }
        
        .warning-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .warning-box p {
            color: #991b1b;
            font-weight: 600;
            margin: 0;
        }
        
        .revoked-banner {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .revoked-banner p {
            color: #991b1b;
            font-weight: 600;
            margin: 0;
        }
        
        .grid-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 28px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (max-width: 1024px) {
            .grid-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }
        
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }
        
        @media (max-width: 1024px) {
            .left-column, .right-column {
                gap: 20px;
            }
        }
        
        .footer-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 768px) {
            .footer-info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        .info-box {
            padding: 20px;
            border-radius: 12px;
            border: 1px solid;
        }
        
        .info-box-privacy {
            background: #eff6ff;
            border-color: #bfdbfe;
        }
        
        .info-box-medical {
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        .info-box-support {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .info-box h4 {
            font-weight: 700;
            font-size: 14px;
            margin: 0 0 8px 0;
        }
        
        .info-box p {
            font-size: 12px;
            margin: 0;
            line-height: 1.4;
        }
        
        .info-box-privacy h4 { color: #1e40af; }
        .info-box-privacy p { color: #1e3a8a; }
        .info-box-medical h4 { color: #991b1b; }
        .info-box-medical p { color: #7f1d1d; }
        .info-box-support h4 { color: #166534; }
        .info-box-support p { color: #14532d; }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: #22c55e;
            color: white;
        }
        
        .toast.warning {
            background: #f59e0b;
            color: white;
        }
        
        .toast.error {
            background: #ef4444;
            color: white;
        }
        
        .remember-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
        }
        
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .toggle-switch.active {
            background: #22c55e;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        /* RTL Support */
        [dir="rtl"] {
            text-align: right;
        }
        
        [dir="rtl"] .status-dot {
            margin-right: 0;
            margin-left: 8px;
        }
        
        /* Typography Scale */
        h1 { font-size: 28px; font-weight: 800; }
        h2 { font-size: 20px; font-weight: 700; }
        h3 { font-size: 18px; font-weight: 700; }
        h4 { font-size: 16px; font-weight: 700; }
        
        @media (max-width: 768px) {
            h1 { font-size: 24px; }
            h2 { font-size: 18px; }
            h3 { font-size: 16px; }
        }
        
        /* Print styles for emergency card */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-card, .print-card * {
                visibility: visible;
            }
            
            .print-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: 40px;
                box-sizing: border-box;
            }
        }
        
        .print-card {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border: 3px solid #dc2626;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            font-family: 'Inter', sans-serif;
        }
        
        .print-card h1 {
            color: #dc2626;
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 8px 0;
        }
        
        .print-card .subtitle {
            color: #475569;
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 24px 0;
        }
        
        .print-card .patient-name {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 16px 0;
        }
        
        .print-card .triage-display {
            margin: 0 0 24px 0;
        }
        
        .print-card .qr-display {
            margin: 0 0 16px 0;
        }
        
        .print-card .code-display {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            margin: 0 0 16px 0;
        }
        
        .print-card .footer-text {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-slate-200">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Left: Brand -->
                <div class="flex items-center space-x-4">
                    <h1 class="text-slate-900">
                        MYQ<span class="text-red-600">ER</span><span class="text-xs align-top text-slate-500">™</span>
                    </h1>
                    <div class="hidden md:block text-slate-600 font-medium" data-i18n="header.dashboard">Emergency Dashboard</div>
                </div>
                
                <!-- Center: Status -->
                <div class="flex items-center">
                    <div class="status-dot status-online" id="statusDot"></div>
                    <span class="text-sm text-slate-600" id="statusText" data-i18n="status.online">Online</span>
                </div>
                
                <!-- Right: Controls -->
                <div class="flex items-center space-x-4">
                    <select id="languageSelect" class="input-field text-sm py-2 px-3 w-auto" onchange="handleLanguageChange()">
                        <option value="en">🇺🇸 English</option>
                        <option value="es">🇪🇸 Español</option>
                        <option value="fr">🇫🇷 Français</option>
                        <option value="de">🇩🇪 Deutsch</option>
                        <option value="it">🇮🇹 Italiano</option>
                        <option value="pt">🇵🇹 Português</option>
                        <option value="ro">🇷🇴 Română</option>
                        <option value="ar">🇸🇦 العربية</option>
                        <option value="hi">🇮🇳 हिन्दी</option>
                        <option value="zh">🇨🇳 中文</option>
                    </select>
                    
                    <div class="hidden md:flex flex-col items-end">
                        <div class="text-sm text-slate-600" id="userEmail">Loading...</div>
                        <div class="remember-toggle">
                            <span data-i18n="auth.rememberMe">Remember me</span>
                            <div class="toggle-switch active" id="rememberToggle" onclick="toggleRememberMe()"></div>
                        </div>
                    </div>
                    
                    <button data-hook="btn-logout" onclick="logout()" class="btn-primary">
                        <span data-i18n="auth.logout">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="grid-layout">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Identity Card -->
                <div class="card">
                    <div class="ribbon ribbon-identity"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 data-i18n="identity.title">Identity Profile</h2>
                            <div class="text-sm text-slate-500 mt-1" id="identityLastUpdated" data-i18n="identity.lastUpdated">Last updated: Never</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="saved-indicator" id="identitySaved">✓ <span data-i18n="common.saved">Saved</span></div>
                            <div class="auto-saved" id="identityAutoSaved">✓ <span data-i18n="common.autoSaved">Saved just now</span></div>
                        </div>
                    </div>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="label" data-i18n="identity.fullName">Full Name</label>
                            <input type="text" id="fullName" class="input-field" data-i18n-placeholder="identity.fullNamePlaceholder" placeholder="Enter your full name" oninput="handleAutoSave('identity')">
                        </div>
                        
                        <div class="field-pair">
                            <div>
                                <label class="label" data-i18n="identity.dob">Date of Birth</label>
                                <input type="date" id="dob" class="input-field" oninput="handleAutoSave('identity')">
                            </div>
                            <div>
                                <label class="label" data-i18n="identity.country">Country</label>
                                <select id="country" class="input-field" onchange="handleAutoSave('identity')">
                                    <option value="" data-i18n="identity.selectCountry">Select Country</option>
                                    <option value="US">🇺🇸 United States</option>
                                    <option value="CA">🇨🇦 Canada</option>
                                    <option value="GB">🇬🇧 United Kingdom</option>
                                    <option value="AU">🇦🇺 Australia</option>
                                    <option value="NZ">🇳🇿 New Zealand</option>
                                    <option value="IE">🇮🇪 Ireland</option>
                                    <option value="FR">🇫🇷 France</option>
                                    <option value="DE">🇩🇪 Germany</option>
                                    <option value="IT">🇮🇹 Italy</option>
                                    <option value="ES">🇪🇸 Spain</option>
                                    <option value="PT">🇵🇹 Portugal</option>
                                    <option value="RO">🇷🇴 Romania</option>
                                    <option value="NL">🇳🇱 Netherlands</option>
                                    <option value="BE">🇧🇪 Belgium</option>
                                    <option value="NO">🇳🇴 Norway</option>
                                    <option value="SE">🇸🇪 Sweden</option>
                                    <option value="DK">🇩🇰 Denmark</option>
                                    <option value="FI">🇫🇮 Finland</option>
                                    <option value="CH">🇨🇭 Switzerland</option>
                                    <option value="AT">🇦🇹 Austria</option>
                                    <option value="PL">🇵🇱 Poland</option>
                                    <option value="CZ">🇨🇿 Czech Republic</option>
                                    <option value="JP">🇯🇵 Japan</option>
                                    <option value="KR">🇰🇷 South Korea</option>
                                    <option value="SG">🇸🇬 Singapore</option>
                                    <option value="MY">🇲🇾 Malaysia</option>
                                    <option value="PH">🇵🇭 Philippines</option>
                                    <option value="TH">🇹🇭 Thailand</option>
                                    <option value="AE">🇦🇪 UAE</option>
                                    <option value="SA">🇸🇦 Saudi Arabia</option>
                                    <option value="IN">🇮🇳 India</option>
                                    <option value="PK">🇵🇰 Pakistan</option>
                                    <option value="CN">🇨🇳 China</option>
                                    <option value="HK">🇭🇰 Hong Kong</option>
                                    <option value="TW">🇹🇼 Taiwan</option>
                                    <option value="BR">🇧🇷 Brazil</option>
                                    <option value="MX">🇲🇽 Mexico</option>
                                    <option value="AR">🇦🇷 Argentina</option>
                                    <option value="CO">🇨🇴 Colombia</option>
                                    <option value="CL">🇨🇱 Chile</option>
                                    <option value="ZA">🇿🇦 South Africa</option>
                                    <option value="NG">🇳🇬 Nigeria</option>
                                    <option value="KE">🇰🇪 Kenya</option>
                                    <option value="GH">🇬🇭 Ghana</option>
                                    <option value="EG">🇪🇬 Egypt</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="identity.healthId">Health ID</label>
                            <input type="text" id="healthId" class="input-field" data-i18n-placeholder="identity.healthIdPlaceholder" placeholder="NHS, EHIC, national health number" oninput="handleAutoSave('identity')">
                            <div class="helper-text" data-i18n="identity.helper">Examples: NHS (UK), CHI (Scotland), HCN (CA), Versicherungsnummer (DE). Do not enter passport/tax IDs.</div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button data-hook="btn-save-profile" onclick="saveIdentity()" class="btn-primary">
                            <span data-i18n="identity.save">Save Identity</span>
                        </button>
                    </div>
                    
                    <div class="mt-4 text-sm text-slate-500" data-i18n="identity.cardHelper">
                        Used by emergency responders to confirm your identity and contact your healthcare providers.
                    </div>
                </div>

                <!-- Critical Card -->
                <div class="card">
                    <div class="ribbon ribbon-critical"></div>
                    <div class="flex justify-between items-start mb-2">
                        <h2 data-i18n="critical.title">Critical Medical Info</h2>
                        <div class="flex flex-col items-end gap-1">
                            <div class="saved-indicator" id="criticalSaved">✓ <span data-i18n="common.saved">Saved</span></div>
                            <div class="auto-saved" id="criticalAutoSaved">✓ <span data-i18n="common.autoSaved">Saved just now</span></div>
                        </div>
                    </div>
                    <div class="text-sm text-slate-500 mb-6" data-i18n="critical.subtitle">Informational only. Clinicians must verify.</div>
                    
                    <div class="space-y-5">
                        <div class="field-pair">
                            <div>
                                <label class="label" data-i18n="critical.bloodType">Blood Type</label>
                                <select id="bloodType" class="input-field" onchange="handleAutoSave('critical')">
                                    <option value="" data-i18n="critical.selectBloodType">Select Blood Type</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            <div>
                                <label class="label" data-i18n="critical.organDonor">Organ Donor</label>
                                <select id="organDonor" class="input-field" onchange="handleAutoSave('critical')">
                                    <option value="" data-i18n="common.select">Select</option>
                                    <option value="yes" data-i18n="common.yes">Yes</option>
                                    <option value="no" data-i18n="common.no">No</option>
                                    <option value="unknown" data-i18n="common.unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.allergies">Allergies</label>
                            <textarea id="allergies" rows="3" class="input-field resize-none" data-i18n-placeholder="critical.allergiesPlaceholder" placeholder="List any allergies (e.g., Penicillin, Peanuts, Latex)" oninput="handleAutoSave('critical')"></textarea>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.conditions">Conditions</label>
                            <textarea id="conditions" rows="3" class="input-field resize-none" data-i18n-placeholder="critical.conditionsPlaceholder" placeholder="List medical conditions (e.g., Diabetes, Hypertension, Asthma)" oninput="handleAutoSave('critical')"></textarea>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.medications">Medications</label>
                            <textarea id="medications" rows="3" class="input-field resize-none" data-i18n-placeholder="critical.medicationsPlaceholder" placeholder="List current medications and dosages" oninput="handleAutoSave('critical')"></textarea>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.resuscitation">Resuscitation Preferences</label>
                            <select id="resuscitationPref" class="input-field" onchange="handleAutoSave('critical')">
                                <option value="" data-i18n="critical.selectResuscitation">Select Preference</option>
                                <option value="full" data-i18n="critical.fullLifeSupport">Full life support (all resuscitation)</option>
                                <option value="comfort" data-i18n="critical.comfortCare">Comfort care only (no escalation)</option>
                                <option value="dnr" data-i18n="critical.dnr">Do Not Resuscitate (DNR)</option>
                            </select>
                            <div class="helper-text" data-i18n="critical.resuscitationHelper">This is guidance, not a legal order.</div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button data-hook="btn-save-health" onclick="saveCritical()" class="btn-primary">
                            <span data-i18n="critical.save">Save Critical Info</span>
                        </button>
                    </div>
                    
                    <div class="mt-4 text-sm text-slate-500" data-i18n="critical.cardHelper">
                        Life-saving information for emergency medical personnel. Keep this updated and accurate.
                    </div>
                </div>

                <!-- ICE Card -->
                <div class="card">
                    <div class="ribbon ribbon-ice"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 data-i18n="ice.title">In Case of Emergency (ICE)</h2>
                            <div class="text-sm text-slate-500 mt-1" data-i18n="ice.subtitle">Phone numbers are formatted for emergency calling.</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="saved-indicator" id="iceSaved">✓ <span data-i18n="common.saved">Saved</span></div>
                            <div class="auto-saved" id="iceAutoSaved">✓ <span data-i18n="common.autoSaved">Saved just now</span></div>
                        </div>
                    </div>
                    
                    <div id="iceContacts" class="space-y-4">
                        <!-- ICE contacts will be dynamically added here -->
                    </div>
                    
                    <div class="flex justify-between items-center mt-6">
                        <button data-hook="btn-add-ice" onclick="addICEContact()" id="addICEBtn" class="btn-secondary">
                            <span data-i18n="ice.addContact">Add ICE Contact</span>
                        </button>
                        <span class="text-sm text-slate-500" id="iceCounter">0/3 <span data-i18n="ice.contacts">contacts</span></span>
                    </div>
                    
                    <div class="mt-4 text-sm text-slate-500" data-i18n="ice.cardHelper">
                        Emergency contacts who can be reached immediately. First responders will call these numbers.
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Triage Card -->
                <div class="card">
                    <div class="ribbon ribbon-triage"></div>
                    <h2 class="mb-6" data-i18n="triage.title">Triage Assessment</h2>
                    
                    <div class="text-center mb-6">
                        <div class="triage-pill triage-green mb-3" id="triagePill">
                            <span data-i18n="triage.green">GREEN</span>
                        </div>
                        <p class="text-sm text-slate-600" id="triageDescription" data-i18n="triage.greenDesc">
                            Standard emergency protocols apply.
                        </p>
                    </div>
                    
                    <div class="mb-5">
                        <label class="label" data-i18n="triage.override">Override (Optional)</label>
                        <select class="input-field" id="triageOverride" data-hook="triage-override" onchange="handleTriageOverride()">
                            <option value="auto" data-i18n="triage.auto">Auto (Recommended)</option>
                            <option value="green" data-i18n="triage.greenOption">Green - Standard</option>
                            <option value="yellow" data-i18n="triage.yellowOption">Yellow - Urgent</option>
                            <option value="red" data-i18n="triage.redOption">Red - Emergency</option>
                            <option value="black" data-i18n="triage.blackOption">Black - Expectant</option>
                        </select>
                        <div class="helper-text" data-i18n="triage.helper">Triage color is an aid from patient-provided info. Use clinical judgment.</div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button class="flex-1 btn-secondary" data-hook="btn-speak" onclick="speakTriage()">
                            🔊 <span data-i18n="triage.speak">Speak</span>
                        </button>
                        <button class="flex-1 btn-secondary" data-hook="btn-stop" onclick="stopSpeaking()">
                            ⏹️ <span data-i18n="triage.stop">Stop</span>
                        </button>
                    </div>
                    
                    <div class="mt-4 text-sm text-slate-500" data-i18n="triage.cardHelper">
                        Automated assessment based on your medical information. Emergency personnel make final decisions.
                    </div>
                </div>

                <!-- QR & Tags Card -->
                <div class="card">
                    <div class="ribbon ribbon-qr"></div>
                    <h2 class="mb-6" data-i18n="qr.title">QR Code & Tags</h2>
                    
                    <div id="qrSection">
                        <div id="noCodeState" class="text-center py-8">
                            <div class="text-6xl mb-4">📱</div>
                            <p class="text-slate-600 mb-6" data-i18n="qr.noCode">No emergency code generated yet</p>
                            <button data-hook="qr-generate" onclick="generateEmergencyCode()" class="btn-primary">
                                🚨 <span data-i18n="qr.generate">Generate Emergency Code</span>
                            </button>
                        </div>
                        
                        <div id="hasCodeState" class="hidden">
                            <div id="revokedBanner" class="revoked-banner hidden">
                                <p>🚫 Revoked — generate a new code.</p>
                            </div>
                            
                            <div class="qr-container">
                                <canvas id="qrCanvas" data-hook="qr-code" width="200" height="200"></canvas>
                            </div>
                            
                            <div class="helper-text text-center mb-4" data-i18n="qr.helper">QR contains essential medical info + online link.</div>
                            
                            <div class="mb-4">
                                <label class="label" data-i18n="qr.payload">QR Payload</label>
                                <textarea id="qrPayloadDisplay" data-hook="qr-note" class="input-field resize-none bg-gray-50" rows="6" readonly></textarea>
                            </div>
                            
                            <div class="mb-4">
                                <div class="remember-toggle">
                                    <span data-i18n="qr.offlineMode">Offline mode</span>
                                    <div class="toggle-switch active" id="offlineToggle" data-hook="qr-offline-toggle" onclick="toggleOfflineMode()"></div>
                                </div>
                                <div class="helper-text mt-1" data-i18n="qr.offlineHelper">When enabled, QR works without internet connection.</div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <button data-hook="qr-copy" onclick="copyPayload()" class="btn-secondary text-sm py-2" id="copyBtn">
                                    📋 <span data-i18n="qr.copy">Copy</span>
                                </button>
                                <button data-hook="qr-dl-png" onclick="downloadQR('png', 1024)" class="btn-secondary text-sm py-2" id="downloadBtn">
                                    📥 1024px
                                </button>
                                <button onclick="downloadQR('png', 512)" class="btn-secondary text-sm py-2" id="download512Btn">
                                    📥 512px
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <button data-hook="qr-rotate" onclick="rotateCode()" class="btn-secondary text-sm py-2" id="rotateBtn">
                                    🔄 <span data-i18n="qr.rotate">Rotate</span>
                                </button>
                                <button data-hook="qr-revoke" onclick="revokeCode()" class="btn-primary text-sm py-2" id="revokeBtn">
                                    🚫 <span data-i18n="qr.revoke">Revoke</span>
                                </button>
                                <button data-hook="qr-print" onclick="printCard()" class="btn-secondary text-sm py-2" id="printBtn">
                                    🖨️ <span data-i18n="qr.print">Print</span>
                                </button>
                            </div>
                            
                            <div class="text-center text-sm text-slate-500">
                                <div><span data-i18n="qr.status">Status:</span> <span id="qrStatus" class="font-semibold text-green-600" data-i18n="qr.active">Active</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-sm text-slate-500" data-i18n="qr.cardHelper">
                        Scannable code containing your emergency medical information for first responders.
                    </div>
                </div>

                <!-- Vault Card -->
                <div class="card">
                    <div class="ribbon ribbon-vault"></div>
                    <h2 class="mb-6" data-i18n="vault.title">Vault</h2>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">📄</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.dnr">DNR Directive</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.dnrDesc">Do Not Resuscitate orders</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">📋</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.livingWill">Living Will</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.livingWillDesc">Advanced healthcare directives</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">🏥</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.insurance">Insurance Cards</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.insuranceDesc">Health insurance information</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">🔒</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.secureStorage">Secure Document Storage</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.secureStorageDesc">Encrypted document vault</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-sm text-slate-500" data-i18n="vault.cardHelper">
                        Secure storage for legal documents and advanced directives. Features coming soon.
                    </div>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="card mt-8 max-w-4xl mx-auto">
            <div class="ribbon ribbon-danger"></div>
            <h2 class="text-red-600 mb-6">⚠️ <span data-i18n="danger.title">Danger Zone</span></h2>
            
            <div class="warning-box">
                <p data-i18n="danger.warning">This action cannot be undone. All your medical data, QR codes, and contacts will be permanently deleted.</p>
            </div>
            
            <div class="mb-6">
                <label class="label" data-i18n="danger.confirmLabel">Type DELETE MY ACCOUNT to confirm</label>
                <input type="text" id="deleteConfirmInput" data-hook="del-input" class="input-field" data-i18n-placeholder="danger.confirmPlaceholder" placeholder="DELETE MY ACCOUNT" oninput="checkDeleteConfirmation()">
            </div>
            
            <div class="flex gap-4">
                <button onclick="cancelDelete()" class="btn-secondary">
                    <span data-i18n="common.cancel">Cancel</span>
                </button>
                <button onclick="deleteAccountForever()" data-hook="btn-del" id="deleteConfirmBtn" class="btn-danger" disabled>
                    <span data-i18n="danger.deleteForever">Delete Account Forever</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-16 bg-white/50 backdrop-blur-sm border-t border-slate-200">
        <div class="container mx-auto px-6 py-8">
            <div class="footer-info-grid">
                <div class="info-box info-box-privacy">
                    <h4>🔒 <span data-i18n="footer.privacy">Privacy & Security</span></h4>
                    <p data-i18n="footer.privacyDesc">Your medical data is encrypted and stored securely. Only you control access.</p>
                </div>
                
                <div class="info-box info-box-medical">
                    <h4>⚕️ <span data-i18n="footer.medical">Medical Disclaimer</span></h4>
                    <p data-i18n="footer.medicalDesc">Informational only. Emergency responders must verify all medical information.</p>
                </div>
                
                <div class="info-box info-box-support">
                    <h4>📞 <span data-i18n="footer.support">Support</span></h4>
                    <p data-i18n="footer.supportDesc">Contact support 24/7 for assistance with your emergency codes.</p>
                </div>
            </div>
            
            <div class="text-center text-xs text-slate-500 border-t border-slate-200 pt-4">
                <p>© 2024 MYQER™ • <a href="#" class="text-blue-600 hover:underline" data-i18n="footer.privacy">Privacy Policy</a> • <a href="#" class="text-blue-600 hover:underline" data-i18n="footer.terms">Terms of Service</a> • <a href="#" class="text-blue-600 hover:underline" data-i18n="footer.supportLink">Support</a></p>
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
            auth: {
                persistSession: true,
                storage: localStorage
            }
        });

        // Global variables
        let currentUser = null;
        let currentLanguage = 'en';
        let iceContactCount = 0;
        let currentQRCode = null;
        let currentEmergencyCode = null;
        let speechSynthesis = window.speechSynthesis;
        let autoSaveTimeouts = {};
        let rememberMe = true;
        let offlineMode = true;

        // Internationalization
        const translations = {
            en: {
                "header.dashboard": "Emergency Dashboard",
                "status.online": "Online",
                "status.offline": "No signal",
                "status.hybrid": "Hybrid-ready",
                "auth.logout": "Logout",
                "auth.rememberMe": "Remember me",
                "common.saved": "Saved",
                "common.autoSaved": "Saved just now",
                "common.select": "Select",
                "common.yes": "Yes",
                "common.no": "No",
                "common.unknown": "Unknown",
                "common.cancel": "Cancel",
                "identity.title": "Identity Profile",
                "identity.lastUpdated": "Last updated: Never",
                "identity.fullName": "Full Name",
                "identity.fullNamePlaceholder": "Enter your full name",
                "identity.dob": "Date of Birth",
                "identity.country": "Country",
                "identity.selectCountry": "Select Country",
                "identity.healthId": "Health ID",
                "identity.healthIdPlaceholder": "NHS, EHIC, national health number",
                "identity.helper": "Examples: NHS (UK), CHI (Scotland), HCN (CA), Versicherungsnummer (DE). Do not enter passport/tax IDs.",
                "identity.save": "Save Identity",
                "identity.cardHelper": "Used by emergency responders to confirm your identity and contact your healthcare providers.",
                "critical.title": "Critical Medical Info",
                "critical.subtitle": "Informational only. Clinicians must verify.",
                "critical.bloodType": "Blood Type",
                "critical.selectBloodType": "Select Blood Type",
                "critical.organDonor": "Organ Donor",
                "critical.allergies": "Allergies",
                "critical.allergiesPlaceholder": "List any allergies (e.g., Penicillin, Peanuts, Latex)",
                "critical.conditions": "Conditions",
                "critical.conditionsPlaceholder": "List medical conditions (e.g., Diabetes, Hypertension, Asthma)",
                "critical.medications": "Medications",
                "critical.medicationsPlaceholder": "List current medications and dosages",
                "critical.resuscitation": "Resuscitation Preferences",
                "critical.selectResuscitation": "Select Preference",
                "critical.fullLifeSupport": "Full life support (all resuscitation)",
                "critical.comfortCare": "Comfort care only (no escalation)",
                "critical.dnr": "Do Not Resuscitate (DNR)",
                "critical.resuscitationHelper": "This is guidance, not a legal order.",
                "critical.save": "Save Critical Info",
                "critical.cardHelper": "Life-saving information for emergency medical personnel. Keep this updated and accurate.",
                "ice.title": "In Case of Emergency (ICE)",
                "ice.subtitle": "Phone numbers are formatted for emergency calling.",
                "ice.addContact": "Add ICE Contact",
                "ice.contacts": "contacts",
                "ice.name": "Name",
                "ice.relation": "Relation",
                "ice.phone": "Phone",
                "ice.cardHelper": "Emergency contacts who can be reached immediately. First responders will call these numbers.",
                "triage.title": "Triage Assessment",
                "triage.green": "GREEN",
                "triage.yellow": "YELLOW",
                "triage.red": "RED",
                "triage.black": "BLACK",
                "triage.greenDesc": "Standard emergency protocols apply.",
                "triage.yellowDesc": "Medical conditions present - monitor closely.",
                "triage.redDesc": "Critical conditions requiring immediate attention.",
                "triage.blackDesc": "Expectant - comfort care priority.",
                "triage.override": "Override (Optional)",
                "triage.auto": "Auto (Recommended)",
                "triage.greenOption": "Green - Standard",
                "triage.yellowOption": "Yellow - Urgent",
                "triage.redOption": "Red - Emergency",
                "triage.blackOption": "Black - Expectant",
                "triage.helper": "Triage color is an aid from patient-provided info. Use clinical judgment.",
                "triage.speak": "Speak",
                "triage.stop": "Stop",
                "triage.cardHelper": "Automated assessment based on your medical information. Emergency personnel make final decisions.",
                "qr.title": "QR Code & Tags",
                "qr.noCode": "No emergency code generated yet",
                "qr.generate": "Generate Emergency Code",
                "qr.helper": "QR contains essential medical info + online link.",
                "qr.payload": "QR Payload",
                "qr.copy": "Copy",
                "qr.rotate": "Rotate",
                "qr.revoke": "Revoke",
                "qr.print": "Print",
                "qr.status": "Status:",
                "qr.active": "Active",
                "qr.revoked": "Revoked",
                "qr.offlineMode": "Offline mode",
                "qr.offlineHelper": "When enabled, QR works without internet connection.",
                "qr.cardHelper": "Scannable code containing your emergency medical information for first responders.",
                "vault.title": "Vault",
                "vault.dnr": "DNR Directive",
                "vault.dnrDesc": "Do Not Resuscitate orders",
                "vault.livingWill": "Living Will",
                "vault.livingWillDesc": "Advanced healthcare directives",
                "vault.insurance": "Insurance Cards",
                "vault.insuranceDesc": "Health insurance information",
                "vault.secureStorage": "Secure Document Storage",
                "vault.secureStorageDesc": "Encrypted document vault",
                "vault.comingSoon": "Coming Soon",
                "vault.cardHelper": "Secure storage for legal documents and advanced directives. Features coming soon.",
                "danger.title": "Danger Zone",
                "danger.warning": "This action cannot be undone. All your medical data, QR codes, and contacts will be permanently deleted.",
                "danger.confirmLabel": "Type DELETE MY ACCOUNT to confirm",
                "danger.confirmPlaceholder": "DELETE MY ACCOUNT",
                "danger.deleteForever": "Delete Account Forever",
                "footer.privacy": "Privacy & Security",
                "footer.privacyDesc": "Your medical data is encrypted and stored securely. Only you control access.",
                "footer.medical": "Medical Disclaimer",
                "footer.medicalDesc": "Informational only. Emergency responders must verify all medical information.",
                "footer.support": "Support",
                "footer.supportDesc": "Contact support 24/7 for assistance with your emergency codes.",
                "footer.terms": "Terms of Service",
                "footer.supportLink": "Support"
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            await checkSession();
            loadRememberMePreference();
            await loadUserData();
            updateTriageAssessment();
            updateICECounter();
            applyTranslations();
            
            // Handle page unload for remember me
            window.addEventListener('beforeunload', handleBeforeUnload);
        });

        // Session Management
        async function checkSession() {
            try {
                const { data: { session }, error } = await sb.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    location.replace('/');
                    return;
                }
                
                if (!session) {
                    location.replace('/');
                    return;
                }
                
                currentUser = session.user;
                document.getElementById('userEmail').textContent = currentUser.email;
                
                // Update status indicator
                document.getElementById('statusDot').className = 'status-dot status-online';
                document.getElementById('statusText').textContent = translations[currentLanguage]['status.online'] || 'Online';
                
            } catch (error) {
                console.error('Session check failed:', error);
                location.replace('/');
            }
        }

        function loadRememberMePreference() {
            const saved = localStorage.getItem('myqer_remember_me');
            rememberMe = saved !== 'false'; // Default to true
            
            const toggle = document.getElementById('rememberToggle');
            if (rememberMe) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function toggleRememberMe() {
            rememberMe = !rememberMe;
            const toggle = document.getElementById('rememberToggle');
            
            if (rememberMe) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            localStorage.setItem('myqer_remember_me', rememberMe.toString());
        }

        function toggleOfflineMode() {
            offlineMode = !offlineMode;
            const toggle = document.getElementById('offlineToggle');
            
            if (offlineMode) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        async function handleBeforeUnload() {
            if (!rememberMe) {
                await sb.auth.signOut({ scope: 'local' });
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await sb.auth.signOut();
                    location.replace('/');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Logout failed', 'error');
                }
            }
        }

        // Language handling
        async function handleLanguageChange() {
            const select = document.getElementById('languageSelect');
            currentLanguage = select.value;
            
            // Handle RTL for Arabic
            if (currentLanguage === 'ar') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            // Save language preference to database
            try {
                await sb.from('profiles').upsert({
                    id: currentUser.id,
                    language_pref: currentLanguage
                });
            } catch (error) {
                console.error('Failed to save language preference:', error);
            }
            
            applyTranslations();
        }

        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            // Handle placeholders
            const placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
        }

        // Data loading
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load profile data
                const { data: profile } = await sb
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profile) {
                    document.getElementById('fullName').value = profile.full_name || '';
                    document.getElementById('dob').value = profile.dob || '';
                    document.getElementById('country').value = profile.country || '';
                    document.getElementById('healthId').value = profile.health_id || '';
                    
                    if (profile.language_pref) {
                        currentLanguage = profile.language_pref;
                        document.getElementById('languageSelect').value = currentLanguage;
                        if (currentLanguage === 'ar') {
                            document.documentElement.setAttribute('dir', 'rtl');
                        }
                    }
                    
                    if (profile.updated_at) {
                        updateLastUpdated('identityLastUpdated', profile.updated_at);
                    }
                    
                    // Load emergency code if exists
                    if (profile.code) {
                        currentEmergencyCode = profile.code;
                        showQRCodeState();
                        await generateQRCode();
                    }
                }
                
                // Load health profile data
                const { data: healthProfile } = await sb
                    .from('health_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (healthProfile) {
                    document.getElementById('bloodType').value = healthProfile.blood_type || '';
                    document.getElementById('organDonor').value = healthProfile.organ_donor || '';
                    document.getElementById('allergies').value = healthProfile.allergies || '';
                    document.getElementById('conditions').value = healthProfile.conditions || '';
                    document.getElementById('medications').value = healthProfile.meds || '';
                    document.getElementById('resuscitationPref').value = healthProfile.life_support_pref || '';
                    document.getElementById('triageOverride').value = healthProfile.triage_override || 'auto';
                }
                
                // Load ICE contacts
                const { data: iceContacts } = await sb
                    .from('ice_contacts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at');
                
                if (iceContacts) {
                    iceContacts.forEach(contact => {
                        addICEContactWithData(contact);
                    });
                }
                
            } catch (error) {
                console.error('Failed to load user data:', error);
                showToast('Failed to load data', 'error');
            }
        }

        // Auto-save functionality
        function handleAutoSave(section) {
            // Clear existing timeout
            if (autoSaveTimeouts[section]) {
                clearTimeout(autoSaveTimeouts[section]);
            }
            
            // Set new timeout
            autoSaveTimeouts[section] = setTimeout(() => {
                if (section === 'identity') {
                    saveIdentityAuto();
                } else if (section === 'critical') {
                    saveCriticalAuto();
                }
                updateTriageAssessment();
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
            }, 800);
        }

        async function saveIdentityAuto() {
            try {
                const data = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value,
                    health_id: document.getElementById('healthId').value,
                    language_pref: currentLanguage,
                    updated_at: new Date().toISOString(),
                    code: currentEmergencyCode
                };
                
                await sb.from('profiles').upsert(data);
                showAutoSavedIndicator('identityAutoSaved');
                
            } catch (error) {
                console.error('Auto-save identity failed:', error);
            }
        }

        async function saveCriticalAuto() {
            try {
                const data = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value,
                    organ_donor: document.getElementById('organDonor').value,
                    allergies: document.getElementById('allergies').value,
                    conditions: document.getElementById('conditions').value,
                    meds: document.getElementById('medications').value,
                    life_support_pref: document.getElementById('resuscitationPref').value,
                    triage_override: document.getElementById('triageOverride').value
                };
                
                await sb.from('health_profiles').upsert(data);
                showAutoSavedIndicator('criticalAutoSaved');
                
            } catch (error) {
                console.error('Auto-save critical failed:', error);
            }
        }

        // Manual save functions
        async function saveIdentity() {
            try {
                const data = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value,
                    health_id: document.getElementById('healthId').value,
                    language_pref: currentLanguage,
                    updated_at: new Date().toISOString(),
                    code: currentEmergencyCode
                };
                
                await sb.from('profiles').upsert(data);
                showSavedIndicator('identitySaved');
                updateLastUpdated('identityLastUpdated', data.updated_at);
                showToast('Identity saved successfully');
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
                
            } catch (error) {
                console.error('Save identity failed:', error);
                showToast('Failed to save identity', 'error');
            }
        }

        async function saveCritical() {
            try {
                const data = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value,
                    organ_donor: document.getElementById('organDonor').value,
                    allergies: document.getElementById('allergies').value,
                    conditions: document.getElementById('conditions').value,
                    meds: document.getElementById('medications').value,
                    life_support_pref: document.getElementById('resuscitationPref').value,
                    triage_override: document.getElementById('triageOverride').value
                };
                
                await sb.from('health_profiles').upsert(data);
                showSavedIndicator('criticalSaved');
                showToast('Critical info saved successfully');
                updateTriageAssessment();
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
                
            } catch (error) {
                console.error('Save critical failed:', error);
                showToast('Failed to save critical info', 'error');
            }
        }

        // ICE Contacts
        async function addICEContact() {
            if (iceContactCount >= 3) return;
            
            try {
                const { data, error } = await sb
                    .from('ice_contacts')
                    .insert({
                        user_id: currentUser.id,
                        name: '',
                        relation: '',
                        phone: ''
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                addICEContactWithData(data);
                showAutoSavedIndicator('iceAutoSaved');
                
            } catch (error) {
                console.error('Failed to add ICE contact:', error);
                showToast('Failed to add contact', 'error');
            }
        }

        function addICEContactWithData(contact) {
            iceContactCount++;
            const container = document.getElementById('iceContacts');
            const contactDiv = document.createElement('div');
            contactDiv.className = 'space-y-3 p-4 border border-slate-200 rounded-lg';
            contactDiv.id = `iceContact${contact.id}`;
            
            contactDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold">Contact ${iceContactCount}</h4>
                    <button onclick="removeICEContact(${contact.id})" class="text-red-600 hover:text-red-700 text-sm">Remove</button>
                </div>
                <div class="field-pair">
                    <div>
                        <label class="label" data-i18n="ice.name">Name</label>
                        <input type="text" class="input-field" value="${contact.name || ''}" oninput="updateICEContact(${contact.id}, 'name', this.value)">
                    </div>
                    <div>
                        <label class="label" data-i18n="ice.relation">Relation</label>
                        <input type="text" class="input-field" value="${contact.relation || ''}" oninput="updateICEContact(${contact.id}, 'relation', this.value)">
                    </div>
                </div>
                <div>
                    <label class="label" data-i18n="ice.phone">Phone</label>
                    <input type="tel" class="input-field" value="${contact.phone || ''}" oninput="updateICEContact(${contact.id}, 'phone', this.value)">
                </div>
            `;
            
            container.appendChild(contactDiv);
            updateICECounter();
            applyTranslations();
        }

        async function updateICEContact(contactId, field, value) {
            try {
                // Normalize phone to E.164 format if it's a phone field
                if (field === 'phone') {
                    value = normalizePhoneNumber(value);
                }
                
                await sb
                    .from('ice_contacts')
                    .update({ [field]: value })
                    .eq('id', contactId);
                
                showAutoSavedIndicator('iceAutoSaved');
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
                
            } catch (error) {
                console.error('Failed to update ICE contact:', error);
            }
        }

        async function removeICEContact(contactId) {
            try {
                await sb
                    .from('ice_contacts')
                    .delete()
                    .eq('id', contactId);
                
                const contact = document.getElementById(`iceContact${contactId}`);
                if (contact) {
                    contact.remove();
                    iceContactCount--;
                    updateICECounter();
                    showAutoSavedIndicator('iceAutoSaved');
                    
                    // Update QR code if it exists
                    if (currentEmergencyCode) {
                        generateQRCode();
                    }
                }
                
            } catch (error) {
                console.error('Failed to remove ICE contact:', error);
                showToast('Failed to remove contact', 'error');
            }
        }

        function normalizePhoneNumber(phone) {
            // Basic E.164 normalization - remove spaces, keep leading +
            let normalized = phone.replace(/\s+/g, '');
            if (normalized && !normalized.startsWith('+')) {
                // Add + if it looks like an international number
                if (normalized.length > 10) {
                    normalized = '+' + normalized;
                }
            }
            return normalized;
        }

        function updateICECounter() {
            const counter = document.getElementById('iceCounter');
            const addBtn = document.getElementById('addICEBtn');
            
            counter.innerHTML = `${iceContactCount}/3 <span data-i18n="ice.contacts">contacts</span>`;
            
            if (iceContactCount >= 3) {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            applyTranslations();
        }

        // Triage Assessment
        function updateTriageAssessment() {
            const allergies = document.getElementById('allergies').value.toLowerCase();
            const conditions = document.getElementById('conditions').value.toLowerCase();
            const override = document.getElementById('triageOverride').value;
            
            let triageLevel = 'green';
            
            if (override !== 'auto') {
                triageLevel = override;
            } else {
                // Triage logic
                const criticalAllergies = ['anaphylaxis', 'anaphylactic', 'epipen', 'severe'];
                const criticalConditions = ['seizure disorder', 'insulin pump', 'anticoagulant', 'pacemaker'];
                
                const hasCriticalAllergy = criticalAllergies.some(term => allergies.includes(term));
                const hasCriticalCondition = criticalConditions.some(term => conditions.includes(term));
                
                if (hasCriticalAllergy || hasCriticalCondition) {
                    triageLevel = 'red';
                } else if (allergies.trim() || conditions.trim()) {
                    triageLevel = 'yellow';
                }
            }
            
            updateTriageDisplay(triageLevel);
        }

        function updateTriageDisplay(level) {
            const pill = document.getElementById('triagePill');
            const description = document.getElementById('triageDescription');
            
            pill.className = `triage-pill triage-${level} mb-3`;
            
            const levelText = {
                green: translations[currentLanguage]['triage.green'] || 'GREEN',
                yellow: translations[currentLanguage]['triage.yellow'] || 'YELLOW',
                red: translations[currentLanguage]['triage.red'] || 'RED',
                black: translations[currentLanguage]['triage.black'] || 'BLACK'
            };
            
            const descText = {
                green: translations[currentLanguage]['triage.greenDesc'] || 'Standard emergency protocols apply.',
                yellow: translations[currentLanguage]['triage.yellowDesc'] || 'Medical conditions present - monitor closely.',
                red: translations[currentLanguage]['triage.redDesc'] || 'Critical conditions requiring immediate attention.',
                black: translations[currentLanguage]['triage.blackDesc'] || 'Expectant - comfort care priority.'
            };
            
            pill.querySelector('span').textContent = levelText[level];
            description.textContent = descText[level];
        }

        function handleTriageOverride() {
            updateTriageAssessment();
            handleAutoSave('critical');
        }

        // Speech functionality
        async function speakTriage() {
            if (!speechSynthesis) return;
            
            try {
                // Build speech content from current data
                const name = document.getElementById('fullName').value || 'Unknown patient';
                const dob = document.getElementById('dob').value || 'Unknown date of birth';
                const allergies = document.getElementById('allergies').value || 'No known allergies';
                const conditions = document.getElementById('conditions').value || 'No known conditions';
                const medications = document.getElementById('medications').value || 'No current medications';
                
                // Get first ICE contact
                const firstIceContact = document.querySelector('#iceContacts .input-field');
                const iceContact = firstIceContact ? firstIceContact.value || 'No emergency contact' : 'No emergency contact';
                
                const speechText = `Patient: ${name}. Date of birth: ${dob}. Critical allergies: ${allergies}. Medical conditions: ${conditions}. Current medications: ${medications}. Emergency contact: ${iceContact}.`;
                
                const utterance = new SpeechSynthesisUtterance(speechText);
                
                // Set language based on current preference
                const langMap = {
                    'en': 'en-US',
                    'es': 'es-ES',
                    'fr': 'fr-FR',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-PT',
                    'ro': 'ro-RO',
                    'ar': 'ar-SA',
                    'hi': 'hi-IN',
                    'zh': 'zh-CN'
                };
                
                utterance.lang = langMap[currentLanguage] || 'en-US';
                speechSynthesis.speak(utterance);
                
            } catch (error) {
                console.error('Speech synthesis failed:', error);
                showToast('Speech synthesis failed', 'error');
            }
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // QR Code System
        async function generateEmergencyCode() {
            // Check if minimal fields are present
            const name = document.getElementById('fullName').value.trim();
            const dob = document.getElementById('dob').value;
            const country = document.getElementById('country').value;
            
            if (!name || !dob || !country) {
                showToast('Please fill in Name, Date of Birth, and Country first', 'warning');
                return;
            }
            
            try {
                // Generate new emergency code
                currentEmergencyCode = 'MYQER-' + Math.random().toString(36).slice(2, 9).toUpperCase();
                
                // Save to database
                await sb.from('profiles').upsert({
                    id: currentUser.id,
                    code: currentEmergencyCode
                });
                
                showQRCodeState();
                await generateQRCode();
                showToast('Emergency code generated successfully');
                
            } catch (error) {
                console.error('Failed to generate emergency code:', error);
                showToast('Failed to generate emergency code', 'error');
            }
        }

        function showQRCodeState() {
            document.getElementById('noCodeState').classList.add('hidden');
            document.getElementById('hasCodeState').classList.remove('hidden');
            document.getElementById('revokedBanner').classList.add('hidden');
            
            // Enable buttons
            const buttons = ['copyBtn', 'downloadBtn', 'download512Btn', 'printBtn', 'rotateBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
            
            // Update status
            document.getElementById('qrStatus').textContent = translations[currentLanguage]['qr.active'] || 'Active';
            document.getElementById('qrStatus').className = 'font-semibold text-green-600';
        }

        function showRevokedState() {
            document.getElementById('revokedBanner').classList.remove('hidden');
            
            // Disable buttons
            const buttons = ['copyBtn', 'downloadBtn', 'download512Btn', 'printBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
            
            // Update status
            document.getElementById('qrStatus').textContent = translations[currentLanguage]['qr.revoked'] || 'Revoked';
            document.getElementById('qrStatus').className = 'font-semibold text-red-600';
        }

        async function generateQRCode() {
            if (!currentEmergencyCode) return;
            
            try {
                // Build compact payload
                const payload = await buildQRPayload();
                
                // Generate QR code
                const canvas = document.getElementById('qrCanvas');
                await QRCode.toCanvas(canvas, payload, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                // Update payload display
                document.getElementById('qrPayloadDisplay').value = payload;
                currentQRCode = payload;
                
            } catch (error) {
                console.error('Failed to generate QR code:', error);
                showToast('Failed to generate QR code', 'error');
            }
        }

        async function buildQRPayload() {
            // Get current data
            const name = document.getElementById('fullName').value || 'Unknown';
            const dob = document.getElementById('dob').value;
            const bloodType = document.getElementById('bloodType').value || 'Unknown';
            const organDonor = document.getElementById('organDonor').value || 'Unknown';
            const allergies = document.getElementById('allergies').value || 'None reported';
            const conditions = document.getElementById('conditions').value || 'None reported';
            const medications = document.getElementById('medications').value || 'None reported';
            
            // Get triage level
            const triageLevel = getCurrentTriageLevel();
            
            // Format DOB
            let formattedDOB = 'Unknown';
            if (dob) {
                const date = new Date(dob);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                formattedDOB = `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
            }
            
            // Get first ICE contact
            let iceContact = 'None';
            try {
                const { data: iceContacts } = await sb
                    .from('ice_contacts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at')
                    .limit(1);
                
                if (iceContacts && iceContacts.length > 0) {
                    const contact = iceContacts[0];
                    iceContact = `${contact.name || 'Unknown'}, ${contact.phone || 'No phone'}`;
                }
            } catch (error) {
                console.error('Failed to load ICE contact for QR:', error);
            }
            
            // Truncate long lists
            const truncateList = (text, maxLength = 60) => {
                if (text.length <= maxLength) return text;
                const truncated = text.substring(0, maxLength);
                const lastComma = truncated.lastIndexOf(',');
                if (lastComma > 0) {
                    return truncated.substring(0, lastComma) + ', +more';
                }
                return truncated + '...';
            };
            
            const truncatedAllergies = truncateList(allergies);
            const truncatedConditions = truncateList(conditions);
            const truncatedMedications = truncateList(medications);
            
            // Build payload (≤800 chars)
            const payload = `EMERGENCY: ${name}
DOB: ${formattedDOB}  TRIAGE: ${triageLevel.toUpperCase()}
BLOOD: ${bloodType}  DONOR: ${organDonor}
ALLERGIES: ${truncatedAllergies}
CONDITIONS: ${truncatedConditions}
MEDS: ${truncatedMedications}
ICE: ${iceContact}
MYQER: myqer.com/qr/${currentEmergencyCode.replace('MYQER-', '')}`;
            
            return payload;
        }

        function getCurrentTriageLevel() {
            const pill = document.getElementById('triagePill');
            if (pill.classList.contains('triage-red')) return 'red';
            if (pill.classList.contains('triage-yellow')) return 'yellow';
            if (pill.classList.contains('triage-black')) return 'black';
            return 'green';
        }

        async function copyPayload() {
            if (!currentQRCode) return;
            
            try {
                await navigator.clipboard.writeText(currentQRCode);
                showToast('QR payload copied to clipboard');
            } catch (error) {
                console.error('Failed to copy payload:', error);
                showToast('Failed to copy payload', 'error');
            }
        }

        async function downloadQR(format, size) {
            if (!currentQRCode) return;
            
            try {
                // Create a temporary canvas for high-res export
                const tempCanvas = document.createElement('canvas');
                await QRCode.toCanvas(tempCanvas, currentQRCode, {
                    width: size,
                    margin: 4, // Quiet zone = 4 modules
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                // Download the image
                const link = document.createElement('a');
                link.download = `${currentEmergencyCode}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                
                showToast(`QR code downloaded (${size}px)`);
                
            } catch (error) {
                console.error('Failed to download QR code:', error);
                showToast('Failed to download QR code', 'error');
            }
        }

        async function rotateCode() {
            if (!currentEmergencyCode) return;
            
            try {
                // Generate new code
                const newCode = 'MYQER-' + Math.random().toString(36).slice(2, 9).toUpperCase();
                currentEmergencyCode = newCode;
                
                // Save to database
                await sb.from('profiles').upsert({
                    id: currentUser.id,
                    code: currentEmergencyCode
                });
                
                // Regenerate QR code
                await generateQRCode();
                showToast('Emergency code rotated successfully');
                
            } catch (error) {
                console.error('Failed to rotate code:', error);
                showToast('Failed to rotate code', 'error');
            }
        }

        async function revokeCode() {
            if (!confirm('Are you sure you want to revoke this emergency code? It will stop working immediately.')) {
                return;
            }
            
            try {
                // Set code to null in database
                await sb.from('profiles').upsert({
                    id: currentUser.id,
                    code: null
                });
                
                currentEmergencyCode = null;
                showRevokedState();
                showToast('Emergency code revoked');
                
            } catch (error) {
                console.error('Failed to revoke code:', error);
                showToast('Failed to revoke code', 'error');
            }
        }

        function printCard() {
            if (!currentEmergencyCode || !currentQRCode) return;
            
            try {
                // Create print window
                const printWindow = window.open('', '_blank', 'width=600,height=800');
                
                // Get current data
                const name = document.getElementById('fullName').value || 'Unknown Patient';
                const triageLevel = getCurrentTriageLevel();
                
                // Generate QR code for print
                const tempCanvas = document.createElement('canvas');
                QRCode.toCanvas(tempCanvas, currentQRCode, {
                    width: 240,
                    margin: 4,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }).then(() => {
                    const qrDataURL = tempCanvas.toDataURL('image/png');
                    
                    // Build print HTML
                    const printHTML = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>MYQER Emergency Card</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 40px;
                                    font-family: 'Arial', sans-serif;
                                    background: white;
                                }
                                .print-card {
                                    max-width: 400px;
                                    margin: 0 auto;
                                    background: white;
                                    border: 3px solid #dc2626;
                                    border-radius: 16px;
                                    padding: 32px;
                                    text-align: center;
                                }
                                .print-card h1 {
                                    color: #dc2626;
                                    font-size: 32px;
                                    font-weight: 800;
                                    margin: 0 0 8px 0;
                                }
                                .print-card .subtitle {
                                    color: #475569;
                                    font-size: 16px;
                                    font-weight: 600;
                                    margin: 0 0 24px 0;
                                }
                                .print-card .patient-name {
                                    font-size: 20px;
                                    font-weight: 700;
                                    color: #1f2937;
                                    margin: 0 0 16px 0;
                                }
                                .print-card .triage-display {
                                    margin: 0 0 24px 0;
                                }
                                .triage-pill {
                                    display: inline-block;
                                    padding: 8px 20px;
                                    border-radius: 20px;
                                    font-weight: 700;
                                    font-size: 16px;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    color: white;
                                }
                                .triage-green { background: #22c55e; }
                                .triage-yellow { background: #f59e0b; }
                                .triage-red { background: #ef4444; }
                                .triage-black { background: #1f2937; }
                                .print-card .qr-display {
                                    margin: 0 0 16px 0;
                                }
                                .print-card .code-display {
                                    font-family: 'Courier New', monospace;
                                    font-size: 14px;
                                    font-weight: 600;
                                    color: #475569;
                                    margin: 0 0 16px 0;
                                }
                                .print-card .footer-text {
                                    font-size: 12px;
                                    color: #64748b;
                                    margin: 0;
                                }
                                @media print {
                                    body { padding: 0; }
                                    .print-card { border: 3px solid #dc2626; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="print-card">
                                <h1>MYQER™</h1>
                                <div class="subtitle">EMERGENCY MEDICAL CARD</div>
                                <div class="patient-name">${name}</div>
                                <div class="triage-display">
                                    <div class="triage-pill triage-${triageLevel}">${triageLevel.toUpperCase()}</div>
                                </div>
                                <div class="qr-display">
                                    <img src="${qrDataURL}" alt="Emergency QR Code" style="width: 240px; height: 240px;">
                                </div>
                                <div class="code-display">${currentEmergencyCode}</div>
                                ${offlineMode ? '<div class="footer-text">✓ Works offline — Scan for medical info</div>' : ''}
                            </div>
                        </body>
                        </html>
                    `;
                    
                    printWindow.document.write(printHTML);
                    printWindow.document.close();
                    
                    // Print after a short delay to ensure images load
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                });
                
            } catch (error) {
                console.error('Failed to print card:', error);
                showToast('Failed to print card', 'error');
            }
        }

        // Delete Account
        function checkDeleteConfirmation() {
            const input = document.getElementById('deleteConfirmInput');
            const btn = document.getElementById('deleteConfirmBtn');
            
            if (input.value === 'DELETE MY ACCOUNT') {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function cancelDelete() {
            document.getElementById('deleteConfirmInput').value = '';
            checkDeleteConfirmation();
        }

        async function deleteAccountForever() {
            if (!confirm('Are you absolutely sure? This cannot be undone.')) {
                return;
            }
            
            try {
                // Delete in order: ice_contacts -> health_profiles -> profiles
                await sb.from('ice_contacts').delete().eq('user_id', currentUser.id);
                await sb.from('health_profiles').delete().eq('user_id', currentUser.id);
                await sb.from('profiles').delete().eq('id', currentUser.id);
                
                // Sign out and redirect
                await sb.auth.signOut();
                showToast('Account deleted successfully');
                
                setTimeout(() => {
                    location.replace('/');
                }, 1000);
                
            } catch (error) {
                console.error('Account deletion failed:', error);
                showToast('Failed to delete account', 'error');
            }
        }

        // Utility functions
        function showSavedIndicator(elementId) {
            const indicator = document.getElementById(elementId);
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function showAutoSavedIndicator(elementId) {
            const indicator = document.getElementById(elementId);
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        }

        function updateLastUpdated(elementId, timestamp) {
            const element = document.getElementById(elementId);
            const date = new Date(timestamp);
            element.textContent = `Last updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976b70452121ef4e',t:'MTc1NjQ2NDExMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
