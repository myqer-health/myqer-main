<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MYQER‚Ñ¢ Dashboard</title>

  <!-- CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{--myqer-red:#dc2626}
    html,body{font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff}
    .glass{background:rgba(255,255,255,.9);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .btn-primary{background:var(--myqer-red);color:#fff;font-weight:700;border-radius:.75rem;padding:.75rem 1rem}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .tag{display:inline-flex;align-items:center;gap:.25rem;background:#e5e7eb;color:#111;padding:.25rem .5rem;border-radius:999px;font-size:.825rem}
    .tag button{color:#6b7280}
    .toast{position:fixed;top:20px;right:20px;z-index:1000;background:#111;color:#fff;padding:.75rem 1rem;border-radius:.5rem;opacity:0;transform:translateY(-8px);transition:.25s}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body class="min-h-screen">

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Header -->
  <header class="w-full border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="text-2xl font-extrabold">MYQ<span class="text-red-600">ER</span>‚Ñ¢</div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 text-sm text-gray-700">
          <span id="netDot" class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse"></span>
          <span id="netLabel">Online</span>
        </div>
        <button id="logoutBtn" class="text-sm font-semibold hover:text-red-600">Logout</button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">

    <!-- Profile Completion -->
    <section class="glass rounded-2xl p-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold">Profile Completion</h2>
        <p class="text-gray-600">Complete your emergency profile.</p>
      </div>
      <div class="flex items-center gap-6">
        <div class="relative w-20 h-20">
          <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 36 36">
            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e5e7eb" stroke-width="3"/>
            <path id="progressArc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#dc2626" stroke-width="3" stroke-dasharray="0,100"/>
          </svg>
          <div class="absolute inset-0 grid place-items-center">
            <span id="progressPct" class="text-xl font-bold">0%</span>
          </div>
        </div>
        <ul class="text-sm space-y-1">
          <li><span id="chkIdentity" class="font-bold text-amber-600">‚óã</span> Identity</li>
          <li><span id="chkHealth" class="font-bold text-amber-600">‚óã</span> Health</li>
          <li><span id="chkContacts" class="font-bold text-amber-600">‚óã</span> ICE</li>
          <li><span id="chkQR" class="font-bold text-amber-600">‚óã</span> QR</li>
        </ul>
      </div>
    </section>

    <!-- Identity + Health -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Identity -->
      <div class="glass rounded-2xl p-6 border-l-4 border-green-500">
        <div class="flex items-start justify-between mb-6">
          <div>
            <h3 class="text-xl font-bold">Identity Information</h3>
            <p class="text-gray-600 text-sm">Helps first responders confirm who you are.</p>
          </div>
          <div id="iconIdentity" class="w-8 h-8 rounded-full grid place-items-center bg-amber-500 text-white">‚óã</div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium mb-1">Full Legal Name *</label>
            <input id="full_name" type="text" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Jane Doe" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Date of Birth *</label>
            <input id="date_of_birth" type="text" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="DD/MM/YYYY" required>
            <p class="text-xs text-gray-500 mt-1">Format: DD/MM/YYYY</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Country of Residence *</label>
            <select id="country" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" required>
              <option value="">Select your country</option>
              <option value="GB">üá¨üáß United Kingdom</option>
              <option value="US">üá∫üá∏ United States</option>
              <option value="CA">üá®üá¶ Canada</option>
              <option value="DE">üá©üá™ Germany</option>
              <option value="FR">üá´üá∑ France</option>
              <option value="ES">üá™üá∏ Spain</option>
              <option value="IT">üáÆüáπ Italy</option>
              <option value="IN">üáÆüá≥ India</option>
              <option value="CN">üá®üá≥ China</option>
              <option value="AU">üá¶üá∫ Australia</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">National Health ID</label>
            <input id="national_health_id" type="text" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="NHS Number, SSN, etc."/>
            <p class="text-xs text-gray-500 mt-1">Stored privately. Not shown on your public card.</p>
          </div>
        </div>
      </div>

      <!-- Health -->
      <div class="glass rounded-2xl p-6 border-l-4 border-red-500">
        <div class="flex items-start justify-between mb-6">
          <div>
            <h3 class="text-xl font-bold">Health Profile</h3>
            <p class="text-gray-600 text-sm">Appears on your emergency card. Keep accurate.</p>
          </div>
          <div id="iconHealth" class="w-8 h-8 rounded-full grid place-items-center bg-amber-500 text-white">‚óã</div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium mb-1">Blood Type</label>
            <select id="blood_type" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
              <option value="">Select blood type</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
              <option>Unknown</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Organ Donor Status</label>
            <select id="organ_donor" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
              <option value="">Select status</option>
              <option value="yes">Yes (Registered)</option>
              <option value="no">No (Not a donor)</option>
              <option value="unspecified">Not specified</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Life Support Preference</label>
            <select id="life_support_pref" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
              <option value="">Select preference</option>
              <option value="Full">Full Life Support</option>
              <option value="Limited">Limited</option>
              <option value="Comfort">Comfort Care Only</option>
              <option value="DNR">DNR</option>
            </select>
          </div>

          <!-- Allergies / Conditions / Meds -->
          <div>
            <label class="block text-sm font-semibold">Critical Allergies ‚ö†Ô∏è</label>
            <div id="allergiesPills" class="flex flex-wrap gap-2 my-2"></div>
            <input id="allergiesInput" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Type allergy and press Enter"/>
            <p class="text-xs text-gray-500 mt-1">Drug/food/environmental (e.g., Penicillin, Peanut).</p>
          </div>

          <div>
            <label class="block text-sm font-semibold">Medical Conditions</label>
            <div id="conditionsPills" class="flex flex-wrap gap-2 my-2"></div>
            <input id="conditionsInput" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Type condition and press Enter"/>
          </div>

          <div>
            <label class="block text-sm font-semibold">Medications</label>
            <div id="medicationsPills" class="flex flex-wrap gap-2 my-2"></div>
            <input id="medicationsInput" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Type medication and press Enter"/>
          </div>
        </div>
      </div>
    </section>

    <!-- Triage -->
    <section class="glass rounded-2xl p-6 border-l-4 border-amber-500">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <h3 class="text-xl font-bold">Triage</h3>
          <p class="text-gray-600 text-sm">Auto-computed from your data. You can override.</p>
          <p class="text-xs text-gray-500 mt-1">Disclaimer: MYQER does not diagnose or provide medical advice. This triage label is user-provided and assistive only for responders.</p>
        </div>
        <div id="triageBadge" class="inline-flex items-center px-6 py-3 rounded-full text-white text-lg font-bold bg-green-600">
          üü¢ <span class="ml-2">Green ‚Äî Stable</span>
        </div>
      </div>
      <div class="mt-4 max-w-sm">
        <label class="block text-sm font-medium mb-1">Override</label>
        <select id="triage_override" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
          <option value="auto">Auto (recommended)</option>
          <option value="Green">Green ‚Äî Stable</option>
          <option value="Amber">Amber ‚Äî Urgent</option>
          <option value="Red">Red ‚Äî Immediate</option>
          <option value="Black">Black ‚Äî Comfort Care</option>
        </select>
      </div>
    </section>

    <!-- ICE + QR -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- ICE -->
      <div class="glass rounded-2xl p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold">ICE Contacts</h3>
            <p class="text-gray-600 text-sm"><span id="contactsCounter">0</span> of 5 added</p>
          </div>
          <button id="addContact" class="btn-primary">Add Contact</button>
        </div>
        <div id="contactsList" class="space-y-3"></div>
        <div id="noContacts" class="text-sm text-gray-500">Add people you trust. Name and phone are required.</div>
      </div>

      <!-- QR -->
      <div class="glass rounded-2xl p-6 border-l-4 border-gray-800">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">Your QR Code</h3>
          <button id="generateQR" class="btn-primary">Generate</button>
        </div>
        <p class="text-gray-600 text-sm mb-4">Single, permanent code for your public emergency card.</p>
        <div id="qrBox" class="border rounded-xl h-52 grid place-items-center mb-3 overflow-hidden bg-white"></div>

        <div class="flex items-center gap-2 mb-3">
          <input id="shareLink" class="flex-1 border rounded-lg px-3 py-2 text-sm" readonly placeholder="Share link"/>
          <button id="copyLink" class="px-3 py-2 border rounded-lg text-sm">Copy</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="exportPNG" class="px-3 py-2 border rounded-lg text-sm" disabled>Export PNG</button>
          <button id="printQR" class="px-3 py-2 border rounded-lg text-sm" disabled>Print</button>
        </div>
      </div>
    </section>

    <!-- Danger Zone -->
    <section class="glass rounded-2xl p-8 border border-red-200 text-center">
      <h3 class="text-xl font-bold mb-2 text-red-700">Danger Zone</h3>
      <p class="text-gray-700 mb-4">This will delete your profile, health data, contacts, and disable your QR.</p>
      <div class="max-w-sm mx-auto">
        <input id="confirmDelete" class="w-full border rounded-lg px-4 py-3 mb-3" placeholder='Type "DELETE" to confirm'/>
        <button id="deleteAccount" class="btn-primary w-full" disabled>Delete Account</button>
      </div>
    </section>

  </main>

  <script>
    // ---------- Supabase ----------
    const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ---------- State ----------
    let currentUser = null;
    let profile = null;
    let health = null;
    let contacts = [];

    const $ = (sel) => document.querySelector(sel);

    // ---------- Boot / guard ----------
    document.addEventListener('DOMContentLoaded', async () => {
      // simple online indicator
      const setNet = () => {
        $('#netDot').className = 'w-2.5 h-2.5 rounded-full ' + (navigator.onLine ? 'bg-green-500 animate-pulse':'bg-gray-400');
        $('#netLabel').textContent = navigator.onLine ? 'Online' : 'Offline';
      };
      window.addEventListener('online', setNet); window.addEventListener('offline', setNet); setNet();

      // route guard
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user || null;
      if (!currentUser) {
        location.replace('/index.html'); return;
      }

      // wire events
      wireEvents();

      // load all
      await loadAll();

      // QR on load
      await ensureQrRendered();
    });

    supabase.auth.onAuthStateChange((ev, session) => {
      if (ev === 'SIGNED_OUT') location.replace('/index.html');
    });

    // ---------- Events ----------
    function wireEvents(){
      // logout
      $('#logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
      });

      // identity autosave (debounced)
      ['#full_name','#date_of_birth','#national_health_id'].forEach(id=>{
        $(id).addEventListener('input', ()=>debouncedSave(identitySave, 650));
        $(id).addEventListener('blur', ()=>debouncedSave(identitySave, 50));
      });
      $('#country').addEventListener('change', ()=>identitySave());

      // health dropdown autosave
      ['#blood_type','#organ_donor','#life_support_pref'].forEach(id=>{
        $(id).addEventListener('change', ()=>saveHealthFields());
      });

      // pills: Enter adds, blur also adds & saves
      $('#allergiesInput').addEventListener('keydown', e=>pillKey(e,'allergies'));
      $('#conditionsInput').addEventListener('keydown', e=>pillKey(e,'conditions'));
      $('#medicationsInput').addEventListener('keydown', e=>pillKey(e,'medications'));
      $('#allergiesInput').addEventListener('blur', e=>addBlurToPills(e,'allergies'));
      $('#conditionsInput').addEventListener('blur', e=>addBlurToPills(e,'conditions'));
      $('#medicationsInput').addEventListener('blur', e=>addBlurToPills(e,'medications'));

      // triage override
      $('#triage_override').addEventListener('change', async ()=>{
        const v = $('#triage_override').value;
        health = health || {};
        health.triage_override = (v==='auto'?null:v);
        await upsertHealth({ triage_override: health.triage_override });
        updateTriage();
      });

      // ICE CRUD
      $('#addContact').addEventListener('click', createBlankContact);
      $('#contactsList').addEventListener('input', iceAutosaveHandler);
      $('#contactsList').addEventListener('change', iceAutosaveHandler);
      $('#contactsList').addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-del]');
        if (!btn) return;
        const id = btn.getAttribute('data-del');
        await supabase.from('ice_contacts').delete().eq('id', id);
        contacts = contacts.filter(c=>c.id!==id);
        renderContacts();
        showToast('Contact deleted','');
        updateProgress();
      });

      // QR actions
      $('#generateQR').addEventListener('click', onGenerateQR);
      $('#copyLink').addEventListener('click', copyShareLink);
      $('#exportPNG').addEventListener('click', exportQrPng);
      $('#printQR').addEventListener('click', ()=>{ const u=$('#shareLink').value; if(u) window.open(u,'_blank'); });

      // Danger zone
      $('#confirmDelete').addEventListener('input', ()=>{
        $('#deleteAccount').disabled = ($('#confirmDelete').value.trim().toUpperCase()!=='DELETE');
      });
      $('#deleteAccount').addEventListener('click', doDeleteAccount);
    }

    // ---------- Loaders ----------
    async function loadAll(){
      const [pRes, hRes, cRes] = await Promise.all([
        supabase.from('profiles').select('*').single(),
        supabase.from('health_profiles').select('*').single(),
        supabase.from('ice_contacts').select('*').order('created_at',{ascending:true})
      ]);
      if (!pRes.error) profile = pRes.data || null;
      if (!hRes.error) health  = hRes.data  || null;
      if (!cRes.error) contacts = cRes.data || [];

      hydrateIdentity();
      hydrateHealth();
      renderContacts();
      updateTriage();
      updateProgress();
    }

    // ---------- Identity ----------
    function hydrateIdentity(){
      $('#full_name').value = profile?.full_name || '';
      $('#date_of_birth').value = profile?.date_of_birth || '';
      $('#country').value = profile?.country || '';
      $('#national_health_id').value = profile?.national_health_id || '';
    }

    let identTimer=null;
    function debouncedSave(fn,ms){ clearTimeout(identTimer); identTimer=setTimeout(fn,ms); }

    async function identitySave(){
      const patch = {
        full_name: $('#full_name').value.trim(),
        date_of_birth: $('#date_of_birth').value.trim(),
        country: $('#country').value,
        national_health_id: $('#national_health_id').value.trim()
      };
      const { data, error } = await supabase.from('profiles').upsert(patch, { onConflict:'id' }).select().single();
      if (!error) {
        profile = data;
        showToast('Identity saved');
        updateProgress();
      }
    }

    // ---------- Health ----------
    function hydrateHealth(){
      const hp = health || {};
      $('#blood_type').value = hp.blood_type || '';
      $('#organ_donor').value = (hp.organ_donor===true?'yes':hp.organ_donor===false?'no':(hp.organ_donor===null? '': (hp.organ_donor||'')));
      $('#life_support_pref').value = hp.life_support_pref || '';

      hydratePills('allergiesPills', hp.allergies);
      hydratePills('conditionsPills', hp.conditions);
      hydratePills('medicationsPills', hp.medications);
    }

    function hydratePills(containerId, csv){
      const box = document.getElementById(containerId);
      box.innerHTML='';
      (csv?csv.split(','):[]).map(s=>s.trim()).filter(Boolean)
        .forEach(val=> box.appendChild(makePill(val, containerId)));
    }

    function makePill(text, containerId){
      const span = document.createElement('span');
      span.className='tag';
      span.innerHTML = `<span>${escapeHtml(text)}</span><button aria-label="Remove">√ó</button>`;
      span.querySelector('button').addEventListener('click', async ()=>{
        span.remove(); await saveHealthPills(containerId);
      });
      return span;
    }

    function pillKey(e, kind){
      if (e.key!=='Enter') return;
      e.preventDefault();
      addValueToPills(e.target.value, kind);
      e.target.value='';
    }

    function addBlurToPills(e, kind){
      const v = (e.target.value||'').trim();
      if (!v) return;
      addValueToPills(v, kind);
      e.target.value='';
    }

    function addValueToPills(raw, kind){
      const map = { allergies:'allergiesPills', conditions:'conditionsPills', medications:'medicationsPills' };
      const cont = document.getElementById(map[kind]);
      raw.split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean)
        .forEach(tok => cont.appendChild(makePill(tok, cont.id)));
      saveHealthPills(cont.id);
    }

    async function saveHealthPills(containerId){
      const vals = Array.from(document.getElementById(containerId).querySelectorAll('.tag span:first-child'))
        .map(n=>n.textContent.trim()).filter(Boolean);
      const csv = Array.from(new Set(vals.map(v=>v.toLowerCase()))).map(v=>v).join(', ');
      const patch = {};
      if (containerId==='allergiesPills') patch.allergies = csv;
      if (containerId==='conditionsPills') patch.conditions = csv;
      if (containerId==='medicationsPills') patch.medications = csv;
      await upsertHealth(patch);
      showToast('Health saved');
      updateTriage();
      updateProgress();
    }

    async function saveHealthFields(){
      const organVal = $('#organ_donor').value;
      const patch = {
        blood_type: $('#blood_type').value || null,
        organ_donor: (organVal==='yes'?true:organVal==='no'?false:null),
        life_support_pref: $('#life_support_pref').value || null
      };
      await upsertHealth(patch);
      showToast('Health saved');
      updateTriage();
      updateProgress();
    }

    async function upsertHealth(patch){
      health = {...(health||{}), ...patch};
      await supabase.from('health_profiles').upsert({
        blood_type: health.blood_type ?? null,
        organ_donor: health.organ_donor ?? null,
        life_support_pref: health.life_support_pref ?? null,
        allergies: health.allergies ?? null,
        conditions: health.conditions ?? null,
        medications: health.medications ?? null,
        triage_override: health.triage_override ?? null
      }, { onConflict:'user_id' });
    }

    // ---------- Triage ----------
    function updateTriage(){
      const color = computeTriage();
      const badge = $('#triageBadge');
      const map = {
        Green:{bg:'bg-green-600',label:'Green ‚Äî Stable',icon:'üü¢'},
        Amber:{bg:'bg-amber-500',label:'Amber ‚Äî Urgent',icon:'üü°'},
        Red:{bg:'bg-red-600',label:'Red ‚Äî Immediate',icon:'üî¥'},
        Black:{bg:'bg-gray-900',label:'Black ‚Äî Comfort Care',icon:'‚ö´'}
      };
      const m = map[color]||map.Green;
      badge.className = `inline-flex items-center px-6 py-3 rounded-full text-white text-lg font-bold ${m.bg}`;
      badge.innerHTML = `${m.icon} <span class="ml-2">${m.label}</span>`;
      $('#triage_override').value = health?.triage_override ? health.triage_override : 'auto';
    }

    function computeTriage(){
      const hp = health||{};
      // Override
      if (hp.triage_override && hp.triage_override!=='auto') return hp.triage_override;

      // Black: DNR
      if ((hp.life_support_pref||'').toUpperCase()==='DNR') return 'Black';

      const allergies = (hp.allergies||'').toLowerCase();
      const conditions = (hp.conditions||'').toLowerCase();
      const medications = (hp.medications||'').toLowerCase();

      // Red triggers (common criticals)
      const redAllergy = ['anaphylaxis','epipen','penicillin','amoxicillin','codeine','morphine','peanut','shellfish','bee sting'];
      if (redAllergy.some(w=>allergies.includes(w))) return 'Red';
      const redCond = ['heart attack','myocard','mi ','stroke','seizure','status epilepticus','cancer','copd severe','oxygen dependent','dialysis'];
      if (redCond.some(w=>conditions.includes(w))) return 'Red';

      // Amber: any info at all, or ‚â•3 meds
      const anyInfo = [allergies,conditions,medications].some(s=>s.trim());
      const medsCount = medications ? medications.split(',').map(s=>s.trim()).filter(Boolean).length : 0;
      if (anyInfo || medsCount>=3) return 'Amber';

      // Default
      return 'Green';
    }

    // ---------- ICE ----------
    function renderContacts(){
      const list = $('#contactsList');
      list.innerHTML='';
      if (!contacts.length){ $('#noContacts').classList.remove('hidden'); } else { $('#noContacts').classList.add('hidden'); }
      contacts.forEach(c=>{
        const row = document.createElement('div');
        row.className='border rounded-xl p-4';
        row.innerHTML = `
          <div class="grid grid-cols-12 gap-3 items-center">
            <input class="col-span-3 border rounded-lg px-3 py-2" data-field="name" data-id="${c.id}" placeholder="Name*" value="${escapeHtml(c.name||'')}">
            <input class="col-span-2 border rounded-lg px-3 py-2" data-field="relationship" data-id="${c.id}" placeholder="Relationship" value="${escapeHtml(c.relationship||'')}">
            <input class="col-span-3 border rounded-lg px-3 py-2" data-field="phone" data-id="${c.id}" placeholder="Phone*" value="${escapeHtml(c.phone||'')}">
            <input class="col-span-3 border rounded-lg px-3 py-2" data-field="email" data-id="${c.id}" placeholder="Email" value="${escapeHtml(c.email||'')}">
            <button class="col-span-1 text-red-600 border rounded-lg px-3 py-2" data-del="${c.id}">Delete</button>
            <textarea class="col-span-12 mt-2 border rounded-lg px-3 py-2" data-field="notes" data-id="${c.id}" rows="2" placeholder="Notes">${escapeHtml(c.notes||'')}</textarea>
          </div>`;
        list.appendChild(row);
      });
      $('#contactsCounter').textContent = `${contacts.length} of 5 added`;
    }

    async function createBlankContact(){
      if (contacts.length>=5){ showToast('Max 5 contacts',''); return; }
      const { data, error } = await supabase.from('ice_contacts').insert({ name:'', phone:'' }).select().single();
      if (error) return;
      contacts.push(data);
      renderContacts();
    }

    let iceDebounce=null;
    function iceAutosaveHandler(e){
      const el = e.target;
      const id = el.getAttribute('data-id');
      const field = el.getAttribute('data-field');
      if (!id || !field) return;
      const row = contacts.find(c=>c.id===id);
      if (!row) return;
      row[field] = el.value;
      clearTimeout(iceDebounce);
      iceDebounce = setTimeout(async ()=>{
        if (!row.name?.trim() || !row.phone?.trim()){
          showToast('Name and phone are required',''); return;
        }
        await supabase.from('ice_contacts').update({
          name: row.name, relationship: row.relationship||'', phone: row.phone,
          email: row.email||'', notes: row.notes||''
        }).eq('id', id);
        showToast('Contact saved','');
        updateProgress();
      }, 500);
    }

    // ---------- QR ----------
    async function ensureQrRendered(){
      if (profile?.code){
        renderQR(profile.code);
        enableQrButtons(true);
        $('#generateQR').disabled = false;
        $('#shareLink').value = `${location.origin}/c/${profile.code}`;
      }
    }

    async function onGenerateQR(){
      if (profile?.code){
        showToast('Code already assigned',''); return;
      }
      const code = await makeUniqueCode();
      const { data, error } = await supabase.from('profiles').update({ code }).eq('id', currentUser.id).select().single();
      if (error) return;
      profile = data;
      renderQR(code);
      $('#shareLink').value = `${location.origin}/c/${code}`;
      enableQrButtons(true);
      showToast('QR generated','');
      updateProgress();
    }

    async function makeUniqueCode(){
      for (let i=0;i<6;i++){
        const code = Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6);
        const { data } = await supabase.from('profiles').select('id').eq('code', code).maybeSingle();
        if (!data) return code;
      }
      return crypto.randomUUID().slice(0,6).toUpperCase();
    }

    function renderQR(code){
      const box = $('#qrBox'); box.innerHTML='';
      const canvas = document.createElement('canvas'); canvas.id='qrCanvas';
      box.appendChild(canvas);
      QRCode.toCanvas(canvas, `${location.origin}/c/${code}`, { width: box.clientWidth-8, margin:1, color:{dark:'#111', light:'#fff'} });
    }

    function enableQrButtons(on){
      $('#exportPNG').disabled = !on;
      $('#printQR').disabled = !on;
    }

    function copyShareLink(){
      const v = $('#shareLink').value;
      if (!v) return;
      if (navigator.clipboard?.writeText){ navigator.clipboard.writeText(v).then(()=>showToast('Link copied','')); }
      else { const t=document.createElement('input'); t.value=v; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); showToast('Link copied',''); }
    }

    function exportQrPng(){
      const canvas = $('#qrCanvas'); if (!canvas) return;
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png'); a.download = (profile?.code || 'myqer') + '.png'; a.click();
    }

    // ---------- Danger Zone ----------
    async function doDeleteAccount(){
      if ($('#confirmDelete').value.trim().toUpperCase()!=='DELETE') return;
      try {
        await supabase.from('ice_contacts').delete().neq('id','');
        await supabase.from('health_profiles').delete().neq('user_id','');
        await supabase.from('profiles').delete().neq('id','');
        await supabase.auth.signOut();
        showToast('Account deleted'); setTimeout(()=>location.replace('/index.html'), 800);
      } catch(e){ console.error(e); showToast('Network error'); }
    }

    // ---------- Helpers ----------
    function updateProgress(){
      const iOK = !!(profile?.full_name && profile?.date_of_birth && profile?.country);
      const hOK = !!( (health?.blood_type) || (health?.life_support_pref) ||
                      (health?.allergies?.trim()) || (health?.conditions?.trim()) || (health?.medications?.trim()) );
      const cOK = contacts.length>0;
      const qOK = !!profile?.code;

      $('#iconIdentity').className = 'w-8 h-8 rounded-full grid place-items-center ' + (iOK?'bg-green-600 text-white':'bg-amber-500 text-white');
      $('#iconHealth').className = 'w-8 h-8 rounded-full grid place-items-center ' + (hOK?'bg-green-600 text-white':'bg-amber-500 text-white');

      $('#chkIdentity').className = iOK?'font-bold text-green-600':'font-bold text-amber-600';
      $('#chkHealth').className = hOK?'font-bold text-green-600':'font-bold text-amber-600';
      $('#chkContacts').className = cOK?'font-bold text-green-600':'font-bold text-amber-600';
      $('#chkQR').className = qOK?'font-bold text-green-600':'font-bold text-amber-600';

      const complete = [iOK,hOK,cOK,qOK].filter(Boolean).length;
      const pct = Math.round(complete/4*100);
      $('#progressPct').textContent = pct+'%';
      $('#progressArc').setAttribute('stroke-dasharray', `${pct},100`);
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    let toastTimer=null;
    function showToast(msg){
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),1800);
    }<script>
/* ===========================
   MYQER Dashboard ‚Äî Data & QR
   Drop-in replacement block
   =========================== */

/* --- shared state --- */
let currentUser = null;
let userProfile = null;         // from profiles
let userHealthProfile = null;   // from health_profiles
let userContacts = [];          // from ice_contacts
let currentLanguage = localStorage.getItem('myqer_language') || 'en';
const saveTimeouts = { identity: null, health: null };

/* ---------- helpers ---------- */
const $  = (id) => document.getElementById(id);
const t  = (k)  => (window.i18nDict?.[currentLanguage]?.[k]) ?? k;

function showToast(msg, type='info') {
  let el = document.querySelector('.toast');
  if (!el) {
    el = document.createElement('div');
    el.className = 'toast';
    document.body.appendChild(el);
  }
  el.className = `toast show ${type}`;
  el.textContent = msg;
  setTimeout(() => el.classList.remove('show'), 2100);
}

function langBadge(lang) {
  const map = { en:'üá∫üá∏ EN', es:'üá™üá∏ ES', fr:'üá´üá∑ FR', de:'üá©üá™ DE', it:'üáÆüáπ IT', hi:'üáÆüá≥ HI', ar:'üá∏üá¶ AR', zh:'üá®üá≥ ZH', hu:'üá≠üá∫ HU', ro:'üá∑üá¥ RO' };
  return map[lang] || 'üá∫üá∏ EN';
}
function updateLangBadge() {
  const b = $('dashboardCurrentLang');
  if (b) b.textContent = langBadge(currentLanguage);
}

/* =========================================================
   AUTH BOOTSTRAP
   ========================================================= */
async function boot() {
  const { data: { session } } = await supabase.auth.getSession();
  currentUser = session?.user || null;

  // belt & suspenders: if not logged in, bounce back to login/landing
  if (!currentUser) {
    window.location.replace('/index.html');
    return;
  }

  await loadAllData();
  wireEvents();                 // once
  updateLangBadge();
}
document.addEventListener('DOMContentLoaded', boot);

/* =========================================================
   LOAD ALL
   ========================================================= */
async function loadAllData() {
  await Promise.all([
    loadProfile(),
    loadHealthProfile(),
    loadContacts()
  ]);
  hydrateIdentityForm();
  hydrateHealthForm();
  renderContactsList();
  updateCountersAndProgress();
  await initQrCard();           // draws code if you have one
}

/* ---------- profiles (identity + code) ---------- */
async function loadProfile() {
  // Always scope to current user id
  const { data, error } = await supabase
    .from('profiles')
    .select('id,email,full_name,date_of_birth,country,national_health_id,code,lang,updated_at')
    .eq('id', currentUser.id)
    .single();

  if (error) { console.warn('loadProfile', error); return; }
  userProfile = data || {};
  // prefer stored lang if valid
  if (userProfile.lang && window.i18nDict?.[userProfile.lang]) {
    currentLanguage = userProfile.lang;
    localStorage.setItem('myqer_language', currentLanguage);
    document.documentElement.dir = (currentLanguage === 'ar') ? 'rtl' : 'ltr';
  }
}

/* ---------- health_profiles (create if missing) ---------- */
async function loadHealthProfile() {
  let { data, error } = await supabase
    .from('health_profiles')
    .select('user_id,blood_type,organ_donor,life_support_pref,triage_override,allergies,conditions,medications,updated_at')
    .eq('user_id', currentUser.id)
    .single();

  if (error && error.code === 'PGRST116') {
    // Not found: create a blank row for this user
    const ins = await supabase.from('health_profiles').insert({ user_id: currentUser.id }).select().single();
    data = ins.data;
  } else if (error) {
    console.warn('loadHealthProfile', error);
  }

  userHealthProfile = data || { user_id: currentUser.id };
}

/* ---------- ice_contacts ---------- */
async function loadContacts() {
  const { data, error } = await supabase
    .from('ice_contacts')
    .select('id,name,relationship,phone,email,notes,created_at,updated_at')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: true });

  if (error) { console.warn('loadContacts', error); return; }
  userContacts = Array.isArray(data) ? data : [];
}

/* =========================================================
   HYDRATE FORMS
   ========================================================= */
function hydrateIdentityForm() {
  if (!userProfile) return;
  $('fullName')      && ($('fullName').value      = userProfile.full_name ?? '');
  $('dateOfBirth')   && ($('dateOfBirth').value   = userProfile.date_of_birth ?? '');
  $('country')       && ($('country').value       = userProfile.country ?? '');
  $('healthId')      && ($('healthId').value      = userProfile.national_health_id ?? '');
}

function hydrateHealthForm() {
  const hp = userHealthProfile || {};
  $('bloodType')   && ($('bloodType').value   = hp.blood_type ?? '');
  $('organDonor')  && ($('organDonor').value  = (hp.organ_donor === true ? 'yes' : hp.organ_donor === false ? 'no' : ''));
  $('lifeSupport') && ($('lifeSupport').value = hp.life_support_pref ?? '');

  hydratePills('allergiesPills',  hp.allergies);
  hydratePills('conditionsPills', hp.conditions);
  hydratePills('medicationsPills', hp.medications);

  updateTriageBadge();
}

function hydratePills(containerId, csv) {
  const cont = $(containerId);
  if (!cont) return;
  cont.innerHTML = '';
  (csv ? String(csv).split(',') : [])
    .map(s => s.trim())
    .filter(Boolean)
    .forEach(val => cont.appendChild(makePill(val, containerId)));
}

function makePill(text, containerId) {
  const pill = document.createElement('span');
  pill.className = 'inline-flex items-center px-3 py-1 rounded-full bg-gray-200 text-gray-800 text-sm';
  pill.textContent = text;
  const close = document.createElement('button');
  close.className = 'ml-2 text-gray-600 hover:text-red-600';
  close.textContent = '√ó';
  close.addEventListener('click', async () => {
    pill.remove();
    await saveHealthPills(containerId);
  });
  pill.appendChild(close);
  return pill;
}

/* =========================================================
   AUTOSAVE (debounced)
   ========================================================= */
function debouncedSave(kind) {
  clearTimeout(saveTimeouts[kind]);
  saveTimeouts[kind] = setTimeout(() => {
    if (kind === 'identity') saveIdentity();
    if (kind === 'health')   saveHealth();
  }, 650);
}

/* ---------- save identity -> profiles (upsert by id) ---------- */
async function saveIdentity() {
  const payload = {
    id: currentUser.id,
    full_name:          $('fullName')?.value?.trim() || null,
    date_of_birth:      $('dateOfBirth')?.value?.trim() || null,
    country:            $('country')?.value || null,
    national_health_id: $('healthId')?.value?.trim() || null,
    lang:               currentLanguage,
    updated_at:         new Date().toISOString()
  };

  const { data, error } = await supabase
    .from('profiles')
    .upsert(payload, { onConflict: 'id' })
    .select()
    .single();

  if (error) { console.warn('saveIdentity', error); showToast(t('toast.network_error'),'error'); return; }
  userProfile = data;
  updateCountersAndProgress();
  showToast(t('toast.profile_saved'),'success');
}

/* ---------- save health -> health_profiles (upsert by user_id) ---------- */
async function saveHealth() {
  const blood_type = $('bloodType')?.value || null;
  const organSel   = $('organDonor')?.value || '';
  const organ_donor = organSel === 'yes' ? true : (organSel === 'no' ? false : null);
  const life_support_pref = $('lifeSupport')?.value || null;

  await upsertHealth({
    user_id: currentUser.id,
    blood_type, organ_donor, life_support_pref
  });

  updateTriageBadge();
  updateCountersAndProgress();
  showToast(t('toast.health_saved'),'success');
}

async function saveHealthPills(containerId) {
  const cont = $(containerId);
  const values = Array.from(cont?.querySelectorAll('span') || [])
    .map(s => (s.firstChild?.nodeValue || '').trim())
    .filter(Boolean);
  const csv = values.join(', ');

  const patch = { user_id: currentUser.id };
  if (containerId === 'allergiesPills')  patch.allergies  = csv || null;
  if (containerId === 'conditionsPills') patch.conditions = csv || null;
  if (containerId === 'medicationsPills') patch.medications = csv || null;

  await upsertHealth(patch);
  updateTriageBadge();
  showToast(t('toast.health_saved'),'success');
}

async function upsertHealth(patch) {
  // merge into local
  userHealthProfile = { ...(userHealthProfile || {}), ...patch };

  const payload = {
    user_id:          currentUser.id,
    blood_type:       userHealthProfile.blood_type ?? null,
    organ_donor:      (userHealthProfile.organ_donor ?? null),
    life_support_pref:userHealthProfile.life_support_pref ?? null,
    triage_override:  userHealthProfile.triage_override ?? null,
    allergies:        userHealthProfile.allergies ?? null,
    conditions:       userHealthProfile.conditions ?? null,
    medications:      userHealthProfile.medications ?? null,
    updated_at:       new Date().toISOString()
  };

  const { error } = await supabase
    .from('health_profiles')
    .upsert(payload, { onConflict: 'user_id' });

  if (error) console.warn('upsertHealth', error);
}

/* =========================================================
   CONTACTS CRUD (scoped)
   ========================================================= */
function renderContactsList() {
  const list = $('contactsList');
  if (!list) return;

  // purge existing
  list.querySelectorAll('.contact-card').forEach(n => n.remove());

  // empty state
  if (!userContacts?.length) {
    $('emptyState')?.classList.remove('hidden');
  } else {
    $('emptyState')?.classList.add('hidden');
    userContacts.forEach(c => list.appendChild(contactCard(c)));
  }
  $('contactsCounter') && ($('contactsCounter').textContent = `${userContacts.length} of 5 added`);
}

function contactCard(contact) {
  const wrap = document.createElement('div');
  wrap.className = 'contact-card border rounded-lg p-4';
  wrap.innerHTML = `
    <div class="flex justify-between">
      <div>
        <div class="font-semibold">${escapeHtml(contact.name || '')}</div>
        <div class="text-sm text-gray-600">${escapeHtml(contact.relationship || '')}</div>
        <div class="text-sm text-gray-700 mt-1">${escapeHtml(contact.phone || '')}</div>
        ${contact.email ? `<div class="text-sm text-gray-700">${escapeHtml(contact.email)}</div>` : ''}
        ${contact.notes ? `<div class="text-sm text-gray-500 mt-1">${escapeHtml(contact.notes)}</div>` : ''}
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-1 rounded border hover:bg-gray-50" data-action="edit">Edit</button>
        <button class="px-3 py-1 rounded border text-red-600 hover:bg-red-50" data-action="delete">Delete</button>
      </div>
    </div>
  `;
  wrap.querySelector('[data-action="edit"]').addEventListener('click', () => openContactModal(contact));
  wrap.querySelector('[data-action="delete"]').addEventListener('click', () => deleteContact(contact.id));
  return wrap;
}

function openContactModal(contact=null) {
  window.editingContactId = contact?.id || null;
  $('contactModalTitle').textContent = contact ? t('dashboard.edit_contact') : t('dashboard.add_contact');
  $('contactName').value         = contact?.name || '';
  $('contactRelationship').value = contact?.relationship || '';
  $('contactPhone').value        = contact?.phone || '';
  $('contactEmail').value        = contact?.email || '';
  $('contactNotes').value        = contact?.notes || '';
  $('contactModal').classList.remove('hidden');
}
function closeContactModal() {
  $('contactModal').classList.add('hidden');
  window.editingContactId = null;
}

async function saveContactFromModal(e) {
  e.preventDefault();
  const name  = $('contactName').value.trim();
  const phone = $('contactPhone').value.trim();
  if (!name || !phone) { showToast(t('toast.name_phone_required'),'warning'); return; }

  const payload = {
    user_id: currentUser.id,
    name,
    relationship: $('contactRelationship').value || '',
    phone,
    email: $('contactEmail').value || '',
    notes: $('contactNotes').value || ''
  };

  if (window.editingContactId) {
    await supabase.from('ice_contacts').update(payload).eq('id', window.editingContactId).eq('user_id', currentUser.id);
    const i = userContacts.findIndex(c => c.id === window.editingContactId);
    if (i > -1) Object.assign(userContacts[i], payload);
  } else {
    if (userContacts.length >= 5) { showToast(t('toast.max_contacts'),'warning'); return; }
    const { data, error } = await supabase.from('ice_contacts').insert(payload).select().single();
    if (!error && data) userContacts.push(data);
  }
  closeContactModal();
  renderContactsList();
  updateCountersAndProgress();
  showToast(t('toast.contact_saved'),'success');
}

async function deleteContact(id) {
  await supabase.from('ice_contacts').delete().eq('id', id).eq('user_id', currentUser.id);
  userContacts = userContacts.filter(c => c.id !== id);
  renderContactsList();
  updateCountersAndProgress();
  showToast(t('toast.contact_deleted'),'success');
}

/* =========================================================
   QR ‚Äî single, persistent
   ========================================================= */
async function initQrCard() {
  if (userProfile?.code) {
    // already assigned -> render immediately
    renderQr(userProfile.code);
    const url = makePublicCardUrl(userProfile.code, currentLanguage);
    $('shareableLink') && ($('shareableLink').value = url);
    $('exportPNGBtn')?.removeAttribute('disabled');
    $('printCardBtn')?.removeAttribute('disabled');
  } else {
    // not yet assigned -> leave blank until user clicks Generate
    $('exportPNGBtn')?.setAttribute('disabled','true');
    $('printCardBtn')?.setAttribute('disabled','true');
  }
}

async function onGenerateQR() {
  if (userProfile?.code) {
    showToast(t('toast.code_already_assigned'),'warning');
    return;
  }
  // generate unique 6-char uppercase
  const code = await generateUniqueCode();
  const { data, error } = await supabase
    .from('profiles')
    .update({ code })
    .eq('id', currentUser.id)
    .select()
    .single();

  if (error) { console.warn('generateQR', error); showToast(t('toast.network_error'),'error'); return; }

  userProfile = data;
  renderQr(code);
  const url = makePublicCardUrl(code, currentLanguage);
  $('shareableLink') && ($('shareableLink').value = url);
  $('exportPNGBtn')?.removeAttribute('disabled');
  $('printCardBtn')?.removeAttribute('disabled');
  updateCountersAndProgress();
  showToast(t('toast.qr_generated'),'success');
}

async function generateUniqueCode() {
  for (let i = 0; i < 6; i++) {
    const c = Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6);
    const { data } = await supabase.from('profiles').select('id').eq('code', c).maybeSingle();
    if (!data) return c;
  }
  return crypto.randomUUID().slice(0,6).toUpperCase();
}

function renderQr(code) {
  const box = $('qrPreview');
  if (!box) return;
  box.innerHTML = '';
  const canvas = document.createElement('canvas');
  canvas.id = 'qrCanvas';
  box.appendChild(canvas);

  const url = makePublicCardUrl(code, currentLanguage);
  QRCode.toCanvas(canvas, url, {
    width: Math.max(160, (box.clientWidth || 260) - 8),
    margin: 1,
    color: { dark: '#111111', light: '#FFFFFF' }
  });
}

function makePublicCardUrl(code, lang) {
  const base = `${location.origin}/c/${encodeURIComponent(code)}`;
  return `${base}?lang=${encodeURIComponent(lang || 'en')}`;
}

function copyShareLink() {
  const el = $('shareableLink');
  if (!el || !el.value) return;
  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(el.value).then(() => showToast(t('toast.link_copied'),'success'));
  } else {
    el.select(); document.execCommand('copy'); showToast(t('toast.link_copied'),'success');
  }
}
function exportQrPng() {
  const cv = $('qrCanvas'); if (!cv) return;
  const a = document.createElement('a');
  a.download = (userProfile?.code || 'myqer') + '.png';
  a.href = cv.toDataURL('image/png');
  a.click();
}
function printEmergencyCard() {
  if (!userProfile?.code) return;
  window.open(makePublicCardUrl(userProfile.code, currentLanguage), '_blank');
}

/* =========================================================
   TRIAGE (auto + override)
   ========================================================= */
function computeAutoTriage() {
  const hp = userHealthProfile || {};
  const ls = (hp.life_support_pref || '').toLowerCase();
  if (ls === 'dnr') return 'black';

  // Allergies critical keywords ‚Üí red
  const allergies = (hp.allergies || '').toLowerCase();
  const redAllergy = ['anaphylaxis','epipen','penicillin','peanut','shellfish','midazolam','codeine']
    .some(w => allergies.includes(w));
  if (redAllergy) return 'red';

  // Conditions heuristic
  const conds = (hp.conditions || '').toLowerCase();
  const redCond = ['stroke','heart failure','myocardial','cancer','dialysis','seizure','copd','alport']
    .some(w => conds.includes(w));
  const condCount = (hp.conditions || '').split(',').map(s=>s.trim()).filter(Boolean).length;

  // Meds count heuristic
  const medsCount = (hp.medications || '').split(',').map(s=>s.trim()).filter(Boolean).length;

  if (redCond || medsCount >= 3) return 'red';
  if (allergies.trim() || conds.trim() || (hp.medications||'').trim()) return 'amber';
  return 'green';
}

function setTriageBadge(colorKey) {
  const badge = $('triageBadge'); if (!badge) return;
  const map = {
    green: { bg:'bg-green-500', label: t('dashboard.triage_green') || 'Green ‚Äî Stable' },
    amber: { bg:'bg-amber-500', label: t('dashboard.triage_amber') || 'Amber ‚Äî Urgent' },
    red:   { bg:'bg-red-600',   label: t('dashboard.triage_red') || 'Red ‚Äî Immediate' },
    black: { bg:'bg-gray-900',  label: t('dashboard.triage_black') || 'Black ‚Äî Comfort Care' }
  };
  const m = map[colorKey] || map.green;
  badge.className = `inline-flex items-center px-8 py-4 rounded-full text-2xl font-bold text-white ${m.bg}`;
  badge.innerHTML = `${colorKey==='green'?'üü¢':colorKey==='amber'?'üü°':colorKey==='red'?'üî¥':'‚ö´'} <span>${m.label}</span>`;
}

function updateTriageBadge() {
  const hp = userHealthProfile || {};
  const override = (hp.triage_override || '').toLowerCase();
  const color = (override && override !== 'auto') ? override : computeAutoTriage();
  setTriageBadge(color);
  $('triageOverride') && ($('triageOverride').value = override || 'auto');
}

async function onTriageOverrideChange() {
  const val = $('triageOverride')?.value || 'auto';
  userHealthProfile = userHealthProfile || { user_id: currentUser.id };
  userHealthProfile.triage_override = (val === 'auto' ? null : val);
  await upsertHealth({ triage_override: userHealthProfile.triage_override, user_id: currentUser.id });
  updateTriageBadge();
  showToast(t('toast.triage_updated'),'success');

  // Disclaimer stays visible near the triage card (your markup)
  // ‚ÄúMYQER does not diagnose or provide medical advice. This triage label is user-provided and assistive only for responders.‚Äù
}

/* =========================================================
   EVENTS
   ========================================================= */
function wireEvents() {
  // language switcher
  document.querySelectorAll('.dropdown-menu [data-lang]').forEach(a => {
    a.addEventListener('click', async (e) => {
      e.preventDefault();
      const lang = a.getAttribute('data-lang');
      if (!window.i18nDict?.[lang]) return;
      currentLanguage = lang;
      localStorage.setItem('myqer_language', lang);
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      updateLangBadge();
      // persist preference
      await supabase.from('profiles').update({ lang }).eq('id', currentUser.id);
      // update texts
      if (typeof window.updateI18nElements === 'function') window.updateI18nElements();
    });
  });

  // identity autosave
  $('fullName')     && $('fullName').addEventListener('input', () => debouncedSave('identity'));
  $('dateOfBirth')  && $('dateOfBirth').addEventListener('input', () => debouncedSave('identity'));
  $('country')      && $('country').addEventListener('change', () => debouncedSave('identity'));
  $('healthId')     && $('healthId').addEventListener('input', () => debouncedSave('identity'));

  // health autosave
  $('bloodType')    && $('bloodType').addEventListener('change', () => debouncedSave('health'));
  $('organDonor')   && $('organDonor').addEventListener('change', () => debouncedSave('health'));
  $('lifeSupport')  && $('lifeSupport').addEventListener('change', () => debouncedSave('health'));

  // pills
  $('allergiesInput')  && $('allergiesInput').addEventListener('keydown', e => pillKeyHandler(e,'allergies'));
  $('conditionsInput') && $('conditionsInput').addEventListener('keydown', e => pillKeyHandler(e,'conditions'));
  $('medicationsInput')&& $('medicationsInput').addEventListener('keydown', e => pillKeyHandler(e,'medications'));

  // triage override
  $('triageOverride') && $('triageOverride').addEventListener('change', onTriageOverrideChange);

  // QR
  $('generateQRBtn') && $('generateQRBtn').addEventListener('click', onGenerateQR);
  $('exportPNGBtn')  && $('exportPNGBtn').addEventListener('click', exportQrPng);
  $('printCardBtn')  && $('printCardBtn').addEventListener('click', printEmergencyCard);
  $('copyLinkBtn')   && $('copyLinkBtn').addEventListener('click', copyShareLink);

  // contacts
  $('addContactBtn')     && $('addContactBtn').addEventListener('click', () => openContactModal());
  $('closeContactModal') && $('closeContactModal').addEventListener('click', closeContactModal);
  $('contactForm')       && $('contactForm').addEventListener('submit', saveContactFromModal);
}

/* ---------- pills key handler ---------- */
function pillKeyHandler(e, kind) {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  const input = e.target;
  const val = (input.value || '').trim();
  if (!val) return;
  const map = { allergies:'allergiesPills', conditions:'conditionsPills', medications:'medicationsPills' };
  const cont = $(map[kind]); if (!cont) return;
  cont.appendChild(makePill(val, map[kind]));
  input.value = '';
  saveHealthPills(map[kind]);
}

/* ---------- misc ---------- */
function updateCountersAndProgress() {
  const iOK =
    !!($('fullName')?.value?.trim()) &&
    !!($('dateOfBirth')?.value?.trim()) &&
    !!($('country')?.value);

  const hp = userHealthProfile || {};
  const hOK = !!(hp.blood_type || hp.organ_donor !== undefined || hp.life_support_pref ||
                 (hp.allergies && hp.allergies.trim()) ||
                 (hp.conditions && hp.conditions.trim()) ||
                 (hp.medications && hp.medications.trim()));

  const cOK = (userContacts || []).length > 0;
  const qOK = !!userProfile?.code;

  // badges
  $('identityCheckmark') && ($('identityCheckmark').className = 'w-8 h-8 rounded-full flex items-center justify-center ' + (iOK ? 'bg-green-500' : 'bg-amber-500'));
  $('healthCheckmark')   && ($('healthCheckmark').className   = 'w-8 h-8 rounded-full flex items-center justify-center ' + (hOK ? 'bg-green-500' : 'bg-amber-500'));
  $('identityStatus')    && ($('identityStatus').className    = iOK ? 'text-green-600' : 'text-amber-500');
  $('healthStatus')      && ($('healthStatus').className      = hOK ? 'text-green-600' : 'text-amber-500');
  $('contactsStatus')    && ($('contactsStatus').className    = cOK ? 'text-green-600' : 'text-amber-500');
  $('qrStatus')          && ($('qrStatus').className          = qOK ? 'text-green-600' : 'text-amber-500');

  const total = 4;
  const pct = Math.round(([iOK,hOK,cOK,qOK].filter(Boolean).length/total)*100);
  $('progressPercent') && ($('progressPercent').textContent = pct + '%');
  $('progressCircle')  && ($('progressCircle').setAttribute('stroke-dasharray', `${pct}, 100`));
}

function escapeHtml(s='') {
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
    <script>
/* =====================  CONFIG & GLOBALS  ===================== */
const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

let currentUser = null;
let userProfile = null;
let userHealth = null;
let userContacts = [];
const saveTimers = { identity: null, health: null };

/* =====================  UTILITIES  ===================== */
const $  = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
function toast(msg, type='info') {
  let t = document.querySelector('.toast');
  if (!t) {
    t = document.createElement('div');
    t.className = 'toast';
    document.body.appendChild(t);
  }
  t.className = `toast show ${type}`;
  t.textContent = msg;
  setTimeout(()=>t.classList.remove('show'), 2400);
}
function escapeHtml(s=''){
  return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

/* =====================  AUTH GATE & BOOT  ===================== */
document.addEventListener('DOMContentLoaded', async () => {
  // If not signed in ‚Üí bounce to index
  const { data: { session } } = await supabase.auth.getSession();
  currentUser = session?.user || null;
  if (!currentUser) {
    location.replace('/index.html');
    return;
  }

  // Logout
  $('#logoutBtn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    location.replace('/index.html');
  });

  bindIdentityAutosave();
  bindHealthAutosave();
  bindPillInputs();
  bindTriage();
  bindContacts();
  bindQr();

  await loadAll();         // fetch all data
  hydrateAll();            // paint UI
  computeAndRenderTriage();// badge + % 
});

/* =====================  LOAD & HYDRATE  ===================== */
async function loadAll(){
  await Promise.all([loadProfile(), loadHealth(), loadContacts()]);
}

async function loadProfile(){
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', currentUser.id)
    .single();
  if (error) { console.error(error); toast('Profile load failed', 'error'); return; }
  userProfile = data;
}

async function loadHealth(){
  const { data, error } = await supabase
    .from('health_profiles')
    .select('*')
    .eq('user_id', currentUser.id)
    .maybeSingle();
  if (error) { console.error(error); toast('Health load failed', 'error'); return; }
  userHealth = data || { user_id: currentUser.id };
}

async function loadContacts(){
  const { data, error } = await supabase
    .from('ice_contacts')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: true });
  if (error) { console.error(error); toast('Contacts load failed', 'error'); return; }
  userContacts = data || [];
}

function hydrateAll(){
  // Identity
  $('#fullName').value        = userProfile?.full_name ?? '';
  $('#dateOfBirth').value     = userProfile?.date_of_birth ?? '';
  $('#country').value         = userProfile?.country ?? '';
  $('#healthId').value        = userProfile?.national_health_id ?? '';

  // Health (selects)
  $('#bloodType').value       = userHealth?.blood_type ?? '';
  $('#organDonor').value      = userHealth?.organ_donor === true ? 'yes' : (userHealth?.organ_donor === false ? 'no' : '');
  $('#lifeSupport').value     = userHealth?.life_support_pref ?? '';

  // Health pills (text inputs accept CSV; keep your UI as-is)
  $('#allergiesInput').value  = userHealth?.allergies ?? '';
  $('#conditionsInput').value = userHealth?.conditions ?? '';
  $('#medicationsInput').value= userHealth?.medications ?? '';

  // Contacts render
  renderContacts();

  // QR card
  renderQrIfAny();
  updateProgress();
}

/* =====================  AUTOSAVE: IDENTITY  ===================== */
function bindIdentityAutosave(){
  ['#fullName','#dateOfBirth','#country','#healthId'].forEach(sel=>{
    $(sel)?.addEventListener('input', ()=>debounce('identity', saveIdentity, 700));
    $(sel)?.addEventListener('change', ()=>debounce('identity', saveIdentity, 700));
  });
}
async function saveIdentity(){
  const patch = {
    id: currentUser.id, // upsert key
    full_name:         $('#fullName').value.trim(),
    date_of_birth:     $('#dateOfBirth').value.trim(),
    country:           $('#country').value,
    national_health_id:$('#healthId').value.trim(),
    updated_at: new Date().toISOString()
  };
  const { data, error } = await supabase.from('profiles').upsert(patch).select().single();
  if (error){ console.error(error); toast('Couldn‚Äôt save profile','error'); return; }
  userProfile = data;
  toast('Profile saved','success');
  updateProgress();
}

/* =====================  AUTOSAVE: HEALTH  ===================== */
function bindHealthAutosave(){
  ['#bloodType','#organDonor','#lifeSupport'].forEach(sel=>{
    $(sel)?.addEventListener('change', ()=>debounce('health', saveHealth, 700));
  });
}
function bindPillInputs(){
  // You‚Äôre using plain inputs (not chips). Save on Enter/blur.
  $('#allergiesInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveHealth(); } });
  $('#conditionsInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveHealth(); } });
  $('#medicationsInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveHealth(); } });

  ['#allergiesInput','#conditionsInput','#medicationsInput'].forEach(sel=>{
    $(sel)?.addEventListener('blur', ()=>debounce('health', saveHealth, 700));
  });
}
async function saveHealth(){
  const organSel = $('#organDonor').value;
  const payload = {
    user_id: currentUser.id,
    blood_type: $('#bloodType').value || null,
    organ_donor: organSel === 'yes' ? true : organSel === 'no' ? false : null,
    life_support_pref: $('#lifeSupport').value || null,
    allergies:  $('#allergiesInput').value.trim() || null,
    conditions: $('#conditionsInput').value.trim() || null,
    medications:$('#medicationsInput').value.trim() || null,
    triage_override: userHealth?.triage_override ?? null,
    updated_at: new Date().toISOString()
  };
  const { data, error } = await supabase.from('health_profiles').upsert(payload, { onConflict: 'user_id' }).select().single();
  if (error){ console.error(error); toast('Couldn‚Äôt save health','error'); return; }
  userHealth = data;
  toast('Health saved','success');
  computeAndRenderTriage();
  updateProgress();
}

/* =====================  TRIAGE  ===================== */
function bindTriage(){
  $('#triageOverride')?.addEventListener('change', async ()=>{
    const v = $('#triageOverride').value;
    userHealth = userHealth || { user_id: currentUser.id };
    userHealth.triage_override = (v === 'auto' ? null : v);
    const { error } = await supabase
      .from('health_profiles')
      .update({ triage_override: userHealth.triage_override, updated_at: new Date().toISOString() })
      .eq('user_id', currentUser.id);
    if (error){ console.error(error); toast('Couldn‚Äôt update triage','error'); return; }
    computeAndRenderTriage();
    toast('Triage updated','success');
  });
}

// simple rules, conservative bias
function computeAutoTriage(){
  const hp = userHealth || {};
  const dnr = (hp.life_support_pref || '').toLowerCase() === 'dnr';
  if (dnr) return 'black';

  const critAllergyWords = ['anaphylaxis','epipen','penicillin','peanut','shellfish','sulfa','morphine'];
  const all = (hp.allergies || '').toLowerCase();
  if (critAllergyWords.some(w => all.includes(w))) return 'red';

  const conds = (hp.conditions || '').toLowerCase();
  const redConds = ['heart failure','myocardial','stroke','seizure','cancer','dialysis'];
  if (redConds.some(w => conds.includes(w))) return 'red';

  const medCount = (hp.medications || '').split(',').map(s=>s.trim()).filter(Boolean).length;
  const hasAny  = all.trim() || conds.trim() || (hp.medications||'').trim();
  if (medCount >= 3 || hasAny) return 'amber';

  return 'green';
}
function computeAndRenderTriage(){
  const override = (userHealth?.triage_override || '').toLowerCase();
  const color = override && override !== 'auto' ? override : computeAutoTriage();

  const badge = $('#triageBadge');
  if (badge){
    const map = {
      green: { bg:'bg-green-500', label:'Green ‚Äî Stable', dot:'üü¢' },
      amber: { bg:'bg-amber-500', label:'Amber ‚Äî Urgent', dot:'üü°' },
      red:   { bg:'bg-red-600',   label:'Red ‚Äî Immediate', dot:'üî¥' },
      black: { bg:'bg-gray-900',  label:'Black ‚Äî Comfort', dot:'‚ö´' },
    };
    const m = map[color] || map.green;
    badge.className = `inline-flex items-center px-8 py-4 rounded-full text-2xl font-bold text-white ${m.bg}`;
    badge.innerHTML = `${m.dot} <span>${m.label}</span>`;
  }
}

/* =====================  PROGRESS  ===================== */
function updateProgress(){
  const iOK = !!$('#fullName').value.trim() && !!$('#dateOfBirth').value.trim() && !!$('#country').value;
  const hp = userHealth || {};
  const hOK = !!(hp.blood_type || hp.organ_donor !== undefined || hp.life_support_pref ||
                 (hp.allergies||'').trim() || (hp.conditions||'').trim() || (hp.medications||'').trim());
  const cOK = userContacts.length > 0;
  const qOK = !!userProfile?.code;

  $('#identityStatus')?.classList.toggle('text-green-600', iOK);
  $('#identityStatus')?.classList.toggle('text-amber-500', !iOK);
  $('#healthStatus')?.classList.toggle('text-green-600', hOK);
  $('#healthStatus')?.classList.toggle('text-amber-500', !hOK);
  $('#contactsStatus')?.classList.toggle('text-green-600', cOK);
  $('#contactsStatus')?.classList.toggle('text-amber-500', !cOK);
  $('#qrStatus')?.classList.toggle('text-green-600', qOK);
  $('#qrStatus')?.classList.toggle('text-amber-500', !qOK);

  const pct = Math.round(([iOK,hOK,cOK,qOK].filter(Boolean).length/4)*100);
  $('#progressPercent') && ($('#progressPercent').textContent = pct + '%');
  $('#progressCircle')?.setAttribute('stroke-dasharray', `${pct}, 100`);
}

/* =====================  CONTACTS (ICE)  ===================== */
function bindContacts(){
  $('#addContactBtn')?.addEventListener('click', addEmptyContactRow);
  $('#contactsList')?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if (action === 'delete') await deleteContact(id);
  });
}
function renderContacts(){
  const list = $('#contactsList');
  if (!list) return;
  list.innerHTML = '';
  if (!userContacts.length) {
    $('#emptyState')?.classList.remove('hidden');
  } else {
    $('#emptyState')?.classList.add('hidden');
  }
  userContacts.forEach(c => list.appendChild(contactCard(c)));
  $('#contactsCounter') && ($('#contactsCounter').textContent = `${userContacts.length} of 5 added`);
}
function contactCard(c){
  const el = document.createElement('div');
  el.className = 'contact-card border rounded-lg p-4';
  el.innerHTML = `
    <div class="flex justify-between">
      <div class="grid gap-1">
        <input class="border rounded px-2 py-1" value="${escapeHtml(c.name||'')}"       data-field="name"       data-id="${c.id}">
        <input class="border rounded px-2 py-1" value="${escapeHtml(c.relationship||'')}"data-field="relationship"data-id="${c.id}">
        <input class="border rounded px-2 py-1" value="${escapeHtml(c.phone||'')}"      data-field="phone"      data-id="${c.id}">
        <input class="border rounded px-2 py-1" value="${escapeHtml(c.email||'')}"      data-field="email"      data-id="${c.id}">
        <input class="border rounded px-2 py-1" value="${escapeHtml(c.notes||'')}"      data-field="notes"      data-id="${c.id}">
      </div>
      <div class="flex items-start gap-2">
        <button class="px-3 py-1 rounded border text-red-600 hover:bg-red-50" data-action="delete" data-id="${c.id}">Delete</button>
      </div>
    </div>`;
  // auto-save on blur
  el.querySelectorAll('[data-field]').forEach(inp=>{
    inp.addEventListener('blur', ()=>updateContactField(inp.getAttribute('data-id'), inp.getAttribute('data-field'), inp.value));
  });
  return el;
}
async function updateContactField(id, field, value){
  const patch = {}; patch[field] = value;
  const { error } = await supabase.from('ice_contacts').update(patch).eq('id', id).eq('user_id', currentUser.id);
  if (error){ console.error(error); toast('Contact save failed','error'); return; }
  const idx = userContacts.findIndex(c => c.id === id);
  if (idx>-1) userContacts[idx][field] = value;
  toast('Contact saved','success');
}
async function addEmptyContactRow(){
  if (userContacts.length >= 5){ toast('Max 5 contacts','warning'); return; }
  const payload = { user_id: currentUser.id, name:'', relationship:'', phone:'', email:'', notes:'' };
  const { data, error } = await supabase.from('ice_contacts').insert(payload).select().single();
  if (error){ console.error(error); toast('Couldn‚Äôt add contact','error'); return; }
  userContacts.push(data);
  renderContacts();
  updateProgress();
}
async function deleteContact(id){
  const { error } = await supabase.from('ice_contacts').delete().eq('id', id).eq('user_id', currentUser.id);
  if (error){ console.error(error); toast('Delete failed','error'); return; }
  userContacts = userContacts.filter(c => c.id !== id);
  renderContacts();
  updateProgress();
  toast('Contact deleted','success');
}

/* =====================  QR: single, persistent  ===================== */
function bindQr(){
  $('#generateQRBtn')?.addEventListener('click', generateQrOnce);
  $('#copyLinkBtn')?.addEventListener('click', copyQrLink);
  $('#exportPNGBtn')?.addEventListener('click', exportQrPng);
  $('#printCardBtn')?.addEventListener('click', printQrCard);
}
function publicCardUrl(code){
  return `${location.origin}/c/${encodeURIComponent(code)}?lang=${encodeURIComponent('en')}`;
}
async function generateQrOnce(){
  if (userProfile?.code){ toast('Code already assigned','warning'); return; }
  // create unique 6-char uppercase code
  let code = '';
  for (let i=0;i<6;i++) code += 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)];
  // rare collision loop
  for (let tries=0; tries<5; tries++){
    const { data: exists } = await supabase.from('profiles').select('id').eq('code', code).maybeSingle();
    if (!exists) break;
    code = crypto.randomUUID().slice(0,6).toUpperCase();
  }
  const { data, error } = await supabase.from('profiles').update({ code }).eq('id', currentUser.id).select().single();
  if (error){ console.error(error); toast('Couldn‚Äôt set code','error'); return; }
  userProfile = data;
  renderQrIfAny();
  updateProgress();
  toast('QR generated','success');
}
function renderQrIfAny(){
  const box = $('#qrPreview');
  if (!box) return;
  box.innerHTML = '';
  if (!userProfile?.code){
    $('#shareableLink').value = '';
    $('#exportPNGBtn')?.setAttribute('disabled','true');
    $('#printCardBtn')?.setAttribute('disabled','true');
    return;
  }
  const canvas = document.createElement('canvas');
  canvas.id = 'qrCanvas';
  box.appendChild(canvas);
  const url = publicCardUrl(userProfile.code);
  $('#shareableLink').value = url;
  QRCode.toCanvas(canvas, url, { width: Math.min(300, box.clientWidth-8), margin: 1, color:{ dark:'#111', light:'#fff' }});
  $('#exportPNGBtn')?.removeAttribute('disabled');
  $('#printCardBtn')?.removeAttribute('disabled');
}
function copyQrLink(){
  const v = $('#shareableLink').value;
  if (!v) return;
  navigator.clipboard?.writeText(v).then(()=>toast('Link copied','success')).catch(()=>toast('Copy failed','error'));
}
function exportQrPng(){
  const canvas = $('#qrCanvas'); if (!canvas) return;
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = 'myqer-qr.png';
  a.click();
}
function printQrCard(){
  if (!userProfile?.code) return;
  window.open(publicCardUrl(userProfile.code), '_blank');
}

/* =====================  DELETE ACCOUNT  ===================== */
$('#deleteAccountBtn')?.addEventListener('click', async ()=>{
  try{
    await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
    await supabase.from('health_profiles').delete().eq('user_id', currentUser.id);
    await supabase.from('profiles').delete().eq('id', currentUser.id);
    await supabase.auth.signOut();
    toast('Account deleted','success');
    setTimeout(()=>location.replace('/index.html'), 600);
  }catch(e){
    console.error(e); toast('Delete failed','error');
  }
});

/* =====================  HELPERS  ===================== */
function debounce(key, fn, ms){
  clearTimeout(saveTimers[key]); saveTimers[key] = setTimeout(fn, ms);
}
</script>
</body>
</html>
