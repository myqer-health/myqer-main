<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER‚Ñ¢ Dashboard - Privacy-first Emergency Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-red: #C62828;
            --ink-black: #0F172A;
            --soft-gray: #F5F7FB;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #F5F7FB 0%, #E2E8F0 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 18px 40px rgba(2, 8, 23, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 50px rgba(2, 8, 23, 0.1);
        }
        
        .card-ribbon {
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: 16px 0 0 16px;
        }
        
        .ribbon-identity { background: #10B981; }
        .ribbon-health { background: #C62828; }
        .ribbon-ice { background: #F59E0B; }
        .ribbon-qr { background: #0F172A; }
        .ribbon-reference { background: #6B7280; }
        .ribbon-coming { background: #8B5CF6; }
        .ribbon-danger { background: #EF4444; }
        
        .brand-red { color: var(--brand-red); }
        .bg-brand-red { background-color: var(--brand-red); }
        .ink-black { color: var(--ink-black); }
        .bg-ink-black { background-color: var(--ink-black); }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { background: #10B981; color: white; }
        .toast.warning { background: #F59E0B; color: white; }
        .toast.error { background: #EF4444; color: white; }
        
        .grid-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        
        @media (min-width: 768px) {
            .grid-dashboard {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        @media (min-width: 1024px) {
            .grid-dashboard {
                grid-template-columns: repeat(8, 1fr);
            }
            
            .main-content {
                grid-column: span 5;
            }
            
            .sidebar-content {
                grid-column: span 3;
            }
        }
        
        .triage-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .triage-green { background: #DCFCE7; color: #166534; }
        .triage-amber { background: #FEF3C7; color: #92400E; }
        .triage-red { background: #FEE2E2; color: #991B1B; }
        .triage-black { background: #F3F4F6; color: #374151; }
        
        .qr-code {
            width: 120px;
            height: 120px;
            background: #000;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-align: center;
            border-radius: 8px;
        }
        
        input, textarea, select {
            transition: all 0.2s ease;
            min-height: 48px;
            font-size: 16px;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
            padding: 12px 16px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--brand-red);
            box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
        }
        
        .input-group {
            position: relative;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .required::after {
            content: "*";
            color: #EF4444;
        }
        
        .save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .saving-dot {
            width: 6px;
            height: 6px;
            background: #F59E0B;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .saved-check {
            color: #10B981;
            animation: fadeOut 1.8s forwards;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .pill-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .pill {
            background: #F3F4F6;
            color: #374151;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .pill-remove {
            cursor: pointer;
            color: #6B7280;
            font-weight: bold;
        }
        
        .pill-remove:hover {
            color: #EF4444;
        }
        
        .offline-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #F59E0B;
            font-size: 12px;
        }
        
        .help-tooltip {
            position: relative;
            cursor: help;
            color: #6B7280;
        }
        
        .help-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1F2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        .btn-primary {
            background: var(--brand-red);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #B71C1C;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: var(--ink-black);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #E5E7EB;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }
        
        .btn-danger {
            background: transparent;
            color: #EF4444;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 2px solid #EF4444;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #EF4444;
            color: white;
        }
        
        .coming-soon-card {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .coming-soon-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .document-tile {
            background: #F8FAFC;
            border: 2px dashed #CBD5E1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: not-allowed;
        }
        
        .document-tile:hover {
            border-color: #94A3B8;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal.show .modal-content {
            transform: scale(1);
        }
        
        .footer-links {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 640px) {
            .footer-links {
                flex-direction: column;
                gap: 12px;
            }
        }
        
        /* RTL Support */
        [dir="rtl"] .card-ribbon {
            left: auto;
            right: 0;
            border-radius: 0 16px 16px 0;
        }
        
        [dir="rtl"] .help-tooltip:hover::after {
            left: auto;
            right: 50%;
            transform: translateX(50%);
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- Delete Account Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-red-600 mb-4" data-i18n="danger.title">‚ö†Ô∏è Delete Account</h3>
            <p class="text-gray-600 mb-6" data-i18n="danger.warning">
                This will permanently delete your MYQER account and all associated data. This action cannot be undone.
            </p>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="danger.type_delete">
                    Type "DELETE" to confirm:
                </label>
                <input type="text" id="deleteConfirmInput" class="w-full" placeholder="DELETE">
            </div>
            <div class="mb-6">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="deleteUnderstand">
                    <span class="text-sm" data-i18n="danger.understand">I understand this action cannot be undone</span>
                </label>
            </div>
            <div class="flex gap-3">
                <button id="cancelDeleteBtn" class="btn-secondary flex-1" data-i18n="common.cancel">Cancel</button>
                <button id="confirmDeleteBtn" class="btn-danger flex-1" disabled data-i18n="danger.confirm">Delete Account</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    <div class="text-2xl font-bold ink-black">
                        MYQ<span class="brand-red">ER</span>‚Ñ¢
                    </div>
                    <div class="text-xs text-gray-500 hidden sm:block" data-i18n="app.tagline">
                        Privacy-first. Works offline.
                    </div>
                </div>
                
                <!-- Center Link -->
                <div class="hidden md:block">
                    <a href="about.html" class="text-sm text-gray-600 hover:text-gray-900 transition-colors" data-i18n="app.pronounce">
                        MYQER (pronounced 'my care')
                    </a>
                </div>
                
                <!-- Right Controls -->
                <div class="flex items-center space-x-4">
                    <div id="offlineIndicator" class="offline-indicator" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23 12l-2.44-2.78.34-3.68-3.61-.82-1.89-3.18L12 3 8.6 1.54 6.71 4.72l-3.61.81.34 3.68L1 12l2.44 2.78-.34 3.68 3.61.82 1.89 3.18L12 21l3.4 1.46 1.89-3.18 3.61-.81-.34-3.68L23 12zM13 17h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                        <span data-i18n="status.offline">Offline</span>
                        <span id="queueCount" class="bg-amber-500 text-white text-xs px-2 py-1 rounded-full" style="display: none;">0</span>
                    </div>
                    <select id="languageSelect" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="it">üáÆüáπ Italiano</option>
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="hi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="ro">üá∑üá¥ Rom√¢nƒÉ</option>
                        <option value="hu">üá≠üá∫ Magyar</option>
                    </select>
                    <button id="logoutBtn" class="btn-secondary text-sm" data-i18n="nav.logout">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="grid-dashboard">
            <!-- Main Content -->
            <div class="main-content space-y-6">
                <!-- Identity Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-identity"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="identity.title">üë§ Identity</h2>
                        <div class="help-tooltip" data-tooltip="These details help responders confirm who you are">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="identity.subtitle">These details help responders confirm who you are.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label class="input-label required" data-i18n="identity.name">Full Name
                                <span id="fullNameIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="fullName" class="w-full" data-i18n-placeholder="identity.name_placeholder" placeholder="Enter your full name" aria-required="true">
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="identity.dob">Date of Birth
                                <span id="dobIndicator" class="save-indicator"></span>
                            </label>
                            <input type="date" id="dob" class="w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="identity.country">Country
                                <span id="countryIndicator" class="save-indicator"></span>
                            </label>
                            <select id="country" class="w-full">
                                <option value="" data-i18n="identity.select_country">Select country</option>
                                <option value="US">üá∫üá∏ United States</option>
                                <option value="UK">üá¨üáß United Kingdom</option>
                                <option value="CA">üá®üá¶ Canada</option>
                                <option value="AU">üá¶üá∫ Australia</option>
                                <option value="DE">üá©üá™ Germany</option>
                                <option value="FR">üá´üá∑ France</option>
                                <option value="ES">üá™üá∏ Spain</option>
                                <option value="IT">üáÆüáπ Italy</option>
                                <option value="NL">üá≥üá± Netherlands</option>
                                <option value="SE">üá∏üá™ Sweden</option>
                                <option value="NO">üá≥üá¥ Norway</option>
                                <option value="DK">üá©üá∞ Denmark</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="identity.health_id">Health ID (NHS, etc.)
                                <span id="healthIdIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="healthId" class="w-full" data-i18n-placeholder="identity.health_id_placeholder" placeholder="Optional - never shown publicly">
                            <p class="text-xs text-gray-500 mt-1" data-i18n="identity.health_id_note">Health ID is optional and never shown on your public card.</p>
                        </div>
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="identity.code">Your Card Code
                                <span id="cardCodeIndicator" class="save-indicator"></span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="cardCode" class="flex-1" readonly data-i18n-placeholder="identity.code_placeholder" placeholder="Will be generated automatically">
                                <button id="generateCodeBtn" class="btn-secondary" data-i18n="identity.generate">Generate Code</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-xs text-gray-500" data-i18n="common.autosave">
                            ‚úì Auto-saves as you type
                        </div>
                        <button id="saveProfileBtn" class="btn-primary" data-i18n="identity.save">Save Profile</button>
                    </div>
                </div>

                <!-- Health Profile Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-health"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="health.title">üè• Health Profile</h2>
                        <div class="help-tooltip" data-tooltip="Keep this current. It appears on your emergency card">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="health.subtitle">Keep this current. It appears on your emergency card.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.blood">Blood Type
                                <span id="bloodTypeIndicator" class="save-indicator"></span>
                            </label>
                            <select id="bloodType" class="w-full">
                                <option value="‚Äî" data-i18n="health.unknown">‚Äî Unknown</option>
                                <option value="A+">ü©∏ A+</option>
                                <option value="A-">ü©∏ A-</option>
                                <option value="B+">ü©∏ B+</option>
                                <option value="B-">ü©∏ B-</option>
                                <option value="AB+">ü©∏ AB+</option>
                                <option value="AB-">ü©∏ AB-</option>
                                <option value="O+">ü©∏ O+</option>
                                <option value="O-">ü©∏ O-</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.donor">Organ Donor
                                <span id="organDonorIndicator" class="save-indicator"></span>
                            </label>
                            <select id="organDonor" class="w-full">
                                <option value="‚Äî" data-i18n="health.not_specified">‚Äî Not specified</option>
                                <option value="Yes" data-i18n="common.yes">‚úÖ Yes</option>
                                <option value="No" data-i18n="common.no">‚ùå No</option>
                            </select>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.allergies">Critical Allergies
                                <span id="allergiesIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="allergiesInput" class="w-full" data-i18n-placeholder="health.allergies_placeholder" placeholder="Type allergy and press Enter (e.g., Penicillin, Nuts)">
                            <div id="allergiesPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.conditions">Medical Conditions
                                <span id="conditionsIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="conditionsInput" class="w-full" data-i18n-placeholder="health.conditions_placeholder" placeholder="Type condition and press Enter (e.g., Diabetes, Hypertension)">
                            <div id="conditionsPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.meds">Current Medications
                                <span id="medicationsIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="medicationsInput" class="w-full" data-i18n-placeholder="health.meds_placeholder" placeholder="Type medication and press Enter (e.g., Insulin, Aspirin)">
                            <div id="medicationsPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.implants">Implants & Devices
                                <span id="implantsIndicator" class="save-indicator"></span>
                            </label>
                            <input type="text" id="implantsInput" class="w-full" data-i18n-placeholder="health.implants_placeholder" placeholder="Include model/MRI info (e.g., Pacemaker MRI-unsafe, Hip replacement)">
                            <div id="implantsPills" class="pill-container"></div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.life_support">Life Support Preference
                                <span id="lifeSupportIndicator" class="save-indicator"></span>
                            </label>
                            <select id="lifeSupportPref" class="w-full">
                                <option value="Full" data-i18n="health.full_support">üè• Full Life Support</option>
                                <option value="Comfort" data-i18n="health.comfort_care">ü§≤ Comfort Care Only</option>
                                <option value="DNR" data-i18n="health.dnr">üö´ Do Not Resuscitate</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label" data-i18n="health.burial">Burial Preference
                                <span id="burialIndicator" class="save-indicator"></span>
                            </label>
                            <select id="burialPref" class="w-full">
                                <option value="Burial" data-i18n="health.burial_option">‚ö∞Ô∏è Burial</option>
                                <option value="Cremation" data-i18n="health.cremation">üî• Cremation</option>
                                <option value="Other" data-i18n="health.other">üìã Other</option>
                            </select>
                        </div>
                        
                        <div class="input-group md:col-span-2">
                            <label class="input-label" data-i18n="health.religion">Religious/Cultural Preference
                                <span id="religionIndicator" class="save-indicator"></span>
                            </label>
                            <select id="religionPref" class="w-full">
                                <option value="None" data-i18n="health.none">‚Äî None</option>
                                <option value="Catholic">‚úùÔ∏è Catholic</option>
                                <option value="Protestant">‚úùÔ∏è Protestant</option>
                                <option value="Orthodox">‚ò¶Ô∏è Orthodox</option>
                                <option value="Muslim">‚ò™Ô∏è Muslim</option>
                                <option value="Jewish">‚ú°Ô∏è Jewish</option>
                                <option value="Hindu">üïâÔ∏è Hindu</option>
                                <option value="Buddhist">‚ò∏Ô∏è Buddhist</option>
                                <option value="Sikh">‚ò¨ Sikh</option>
                                <option value="Other" data-i18n="health.other">üìã Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-xs text-gray-500" data-i18n="common.autosave">
                            ‚úì Auto-saves as you type
                        </div>
                        <button id="saveHealthBtn" class="btn-primary" data-i18n="health.save">Save Health Profile</button>
                    </div>
                </div>

                <!-- ICE Contacts Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-ice"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="ice.title">üö® Emergency Contacts (ICE)</h2>
                        <div class="help-tooltip" data-tooltip="In Case of Emergency - who should we call?">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="ice.subtitle">Add up to 3 trusted contacts.</p>
                    
                    <div id="iceContacts" class="space-y-4">
                        <!-- ICE contacts will be populated here -->
                    </div>
                    <button id="addIceContact" class="btn-secondary mt-4" data-i18n="ice.add">
                        + Add Contact (Max 3)
                    </button>
                </div>

                <!-- Document Vault Card -->
                <div class="glass-card p-6 coming-soon-card">
                    <div class="card-ribbon ribbon-coming"></div>
                    <div class="coming-soon-overlay">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üîí</div>
                            <p class="font-semibold text-purple-600" data-i18n="docs.coming">Coming Soon</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="docs.title">üìÅ Document Vault</h2>
                        <div class="help-tooltip" data-tooltip="Launching after clinical review and security audit">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="docs.subtitle">Secure, client-side encrypted storage for critical documents.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="document-tile">
                            <div class="text-2xl mb-2">üìã</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.dnr">DNR Orders</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.dnr_desc">Do Not Resuscitate documents</p>
                        </div>
                        <div class="document-tile">
                            <div class="text-2xl mb-2">üìú</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.living_will">Living Will</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.living_will_desc">End-of-life care preferences</p>
                        </div>
                        <div class="document-tile">
                            <div class="text-2xl mb-2">‚öñÔ∏è</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.power_attorney">Medical Power of Attorney</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.power_attorney_desc">Healthcare decision authority</p>
                        </div>
                        <div class="document-tile">
                            <div class="text-2xl mb-2">üè•</div>
                            <h3 class="font-semibold text-gray-700" data-i18n="docs.insurance">Insurance Documents</h3>
                            <p class="text-xs text-gray-500 mt-1" data-i18n="docs.insurance_desc">Health insurance cards & info</p>
                        </div>
                    </div>
                </div>

                <!-- Family Dashboard Card -->
                <div class="glass-card p-6 coming-soon-card">
                    <div class="card-ribbon ribbon-coming"></div>
                    <div class="coming-soon-overlay">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üë•</div>
                            <p class="font-semibold text-purple-600" data-i18n="family.coming">Coming Soon</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="family.title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Dashboard</h2>
                        <div class="help-tooltip" data-tooltip="Coming soon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-6" data-i18n="family.subtitle">Manage dependents and household emergency info in one place.</p>
                    
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <button class="btn-secondary" disabled data-i18n="family.invite">
                            Invite Family Members
                        </button>
                        <p class="text-sm text-gray-500 mt-2" data-i18n="family.invite_desc">Create and manage emergency profiles for your loved ones</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content space-y-6">
                <!-- Automated Triage Card -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-health"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="triage.title">ü§ñ Automated Triage</h2>
                        <div class="help-tooltip" data-tooltip="AI-powered emergency priority assessment">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-2" data-i18n="triage.auto">Auto-computed from your health profile.</p>
                    
                    <div class="text-center mb-4">
                        <div id="triageStatus" class="triage-status triage-green">
                            üü¢ GREEN - Standard
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="input-label" data-i18n="triage.override">Manual Override</label>
                        <select id="triageOverride" class="w-full">
                            <option value="" data-i18n="triage.auto_recommended">Auto (Recommended)</option>
                            <option value="Green" data-i18n="triage.green">üü¢ Green - Standard</option>
                            <option value="Amber" data-i18n="triage.amber">üü° Amber - Urgent</option>
                            <option value="Red" data-i18n="triage.red">üî¥ Red - Immediate</option>
                            <option value="Black" data-i18n="triage.black">‚ö´ Black - Comfort</option>
                        </select>
                    </div>
                    <p class="text-xs text-gray-500 mb-4" data-i18n="triage.control">You control what responders see first.</p>
                    <div class="space-y-2">
                        <button id="speakTriageBtn" class="btn-secondary w-full text-sm" data-i18n="triage.speak">
                            üîä Speak Summary
                        </button>
                        <button id="stopSpeechBtn" class="btn-secondary w-full text-sm" style="display: none;" data-i18n="triage.stop">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>

                <!-- Emergency Card & QR -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-qr"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="qr.title">üì± Emergency Card & QR</h2>
                        <div class="help-tooltip" data-tooltip="Your emergency information accessible via QR code">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4" data-i18n="qr.subtitle">Scan to view your emergency information.</p>
                    
                    <div class="text-center mb-4">
                        <div class="relative">
                            <canvas id="qrCanvas" width="120" height="120" class="mx-auto border-2 border-gray-200 rounded-lg"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="bg-white rounded-full p-2 shadow-sm">
                                    <div class="text-xs font-bold ink-black">MYQ<span class="brand-red">ER</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <input type="text" id="cardLink" class="w-full text-xs text-center border border-gray-300 rounded px-2 py-1" readonly>
                            <button id="copyLinkBtn" class="text-xs text-blue-600 hover:text-blue-800 mt-1" data-i18n="qr.copy">Copy Link</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <button id="viewCardBtn" class="btn-primary w-full" data-i18n="qr.view">
                            üì± View Emergency Card
                        </button>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="exportPngBtn" class="btn-secondary text-sm" data-i18n="qr.png">PNG</button>
                            <button id="exportSvgBtn" class="btn-secondary text-sm" data-i18n="qr.svg">SVG</button>
                        </div>
                        <button id="printCardBtn" class="btn-secondary w-full" data-i18n="qr.print">
                            üñ®Ô∏è Print Card
                        </button>
                        <button id="shareQrBtn" class="btn-secondary w-full" data-i18n="qr.share">
                            üì§ Share QR Code
                        </button>
                        <button id="speakCardBtn" class="btn-secondary w-full text-sm" data-i18n="qr.speak">
                            üîä Speak Summary
                        </button>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-xs text-gray-500" id="qrStatus" data-i18n="qr.status">
                            ‚úì QR library loaded
                        </p>
                    </div>
                </div>

                <!-- Triage Reference -->
                <div class="glass-card p-6">
                    <div class="card-ribbon ribbon-reference"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold ink-black" data-i18n="triage.legend.title">üìã Triage Reference</h2>
                        <div class="help-tooltip" data-tooltip="Emergency priority color coding system">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4" data-i18n="triage.legend.subtitle">Emergency priority color coding system.</p>
                    
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-green text-xs">üü¢ GREEN</div>
                            <span class="text-sm" data-i18n="triage.legend.green">Mild allergies, no major conditions</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-amber text-xs">üü° AMBER</div>
                            <span class="text-sm" data-i18n="triage.legend.amber">Stable chronic conditions</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-red text-xs">üî¥ RED</div>
                            <span class="text-sm" data-i18n="triage.legend.red">Severe allergies / life-threatening conditions</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="triage-status triage-black text-xs">‚ö´ BLACK</div>
                            <span class="text-sm" data-i18n="triage.legend.black">DNR / Comfort care set</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-xs text-gray-500 mb-2" data-i18n="qr.persistent">
                            ‚ÑπÔ∏è Your QR code stays the same ‚Äî it always opens your latest information.
                        </p>
                        <p class="text-xs text-gray-500" data-i18n="qr.privacy">
                            üîí Works offline; your data stays private until you choose to share.
                        </p>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="glass-card p-6 border-red-200">
                    <div class="card-ribbon ribbon-danger"></div>
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold text-red-600" data-i18n="danger.title">‚ö†Ô∏è Danger Zone</h2>
                        <div class="help-tooltip" data-tooltip="Permanently delete your account and all data">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4" data-i18n="danger.subtitle">
                        This permanently deletes your account and all data.
                    </p>
                    <button id="deleteAccountBtn" class="btn-danger w-full" data-i18n="danger.delete">
                        Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 mt-16">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="text-sm text-gray-600 mb-4 md:mb-0" data-i18n="footer.copyright">
                    ¬© 2025 MYQER ‚Äî Emergency Response QR ¬∑ GDPR/HIPAA-minded.
                </div>
                <div class="footer-links text-sm">
                    <a href="/privacy.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.privacy">Privacy</a>
                    <a href="/terms.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.terms">Terms</a>
                    <a href="/about.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.about">About</a>
                    <a href="/support.html" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.support">Support</a>
                    <a href="mailto:support@myqer.com" class="text-gray-600 hover:text-gray-900 transition-colors" data-i18n="footer.contact">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Internationalization (i18n) System
        const T = {
            en: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (pronounced 'my care')",
                    tagline: "Privacy-first. Works offline."
                },
                nav: {
                    logout: "Logout"
                },
                identity: {
                    title: "üë§ Identity",
                    subtitle: "These details help responders confirm who you are.",
                    name: "Full Name",
                    name_placeholder: "Enter your full name",
                    dob: "Date of Birth",
                    country: "Country",
                    select_country: "Select country",
                    health_id: "Health ID (NHS, etc.)",
                    health_id_placeholder: "Optional - never shown publicly",
                    health_id_note: "Health ID is optional and never shown on your public card.",
                    code: "Your Card Code",
                    code_placeholder: "Will be generated automatically",
                    generate: "Generate Code",
                    save: "Save Profile"
                },
                health: {
                    title: "üè• Health Profile",
                    subtitle: "Keep this current. It appears on your emergency card.",
                    blood: "Blood Type",
                    unknown: "‚Äî Unknown",
                    donor: "Organ Donor",
                    not_specified: "‚Äî Not specified",
                    allergies: "Critical Allergies",
                    allergies_placeholder: "Type allergy and press Enter (e.g., Penicillin, Nuts)",
                    conditions: "Medical Conditions",
                    conditions_placeholder: "Type condition and press Enter (e.g., Diabetes, Hypertension)",
                    meds: "Current Medications",
                    meds_placeholder: "Type medication and press Enter (e.g., Insulin, Aspirin)",
                    implants: "Implants & Devices",
                    implants_placeholder: "Include model/MRI info (e.g., Pacemaker MRI-unsafe, Hip replacement)",
                    life_support: "Life Support Preference",
                    full_support: "üè• Full Life Support",
                    comfort_care: "ü§≤ Comfort Care Only",
                    dnr: "üö´ Do Not Resuscitate",
                    burial: "Burial Preference",
                    burial_option: "‚ö∞Ô∏è Burial",
                    cremation: "üî• Cremation",
                    other: "üìã Other",
                    religion: "Religious/Cultural Preference",
                    none: "‚Äî None",
                    save: "Save Health Profile"
                },
                ice: {
                    title: "üö® Emergency Contacts (ICE)",
                    subtitle: "Add up to 3 trusted contacts.",
                    add: "+ Add Contact (Max 3)",
                    name: "Name",
                    rel: "Relationship",
                    phone: "Phone",
                    delete: "Remove Contact",
                    limit: "Maximum 3 emergency contacts allowed"
                },
                triage: {
                    title: "ü§ñ Automated Triage",
                    auto: "Auto-computed from your health profile.",
                    override: "Manual Override",
                    auto_recommended: "Auto (Recommended)",
                    green: "üü¢ Green - Standard",
                    amber: "üü° Amber - Urgent",
                    red: "üî¥ Red - Immediate",
                    black: "‚ö´ Black - Comfort",
                    control: "You control what responders see first.",
                    speak: "üîä Speak Summary",
                    stop: "‚èπÔ∏è Stop",
                    legend: {
                        title: "üìã Triage Reference",
                        subtitle: "Emergency priority color coding system.",
                        green: "Mild allergies, no major conditions",
                        amber: "Stable chronic conditions",
                        red: "Severe allergies / life-threatening conditions",
                        black: "DNR / Comfort care set"
                    }
                },
                qr: {
                    title: "üì± Emergency Card & QR",
                    subtitle: "Scan to view your emergency information.",
                    copy: "Copy Link",
                    copied: "Card link copied!",
                    view: "üì± View Emergency Card",
                    png: "PNG",
                    svg: "SVG",
                    print: "üñ®Ô∏è Print Card",
                    share: "üì§ Share QR Code",
                    speak: "üîä Speak Summary",
                    status: "‚úì QR library loaded",
                    persistent: "‚ÑπÔ∏è Your QR code stays the same ‚Äî it always opens your latest information.",
                    privacy: "üîí Works offline; your data stays private until you choose to share."
                },
                docs: {
                    title: "üìÅ Document Vault",
                    subtitle: "Secure, client-side encrypted storage for critical documents.",
                    coming: "Coming Soon",
                    dnr: "DNR Orders",
                    dnr_desc: "Do Not Resuscitate documents",
                    living_will: "Living Will",
                    living_will_desc: "End-of-life care preferences",
                    power_attorney: "Medical Power of Attorney",
                    power_attorney_desc: "Healthcare decision authority",
                    insurance: "Insurance Documents",
                    insurance_desc: "Health insurance cards & info"
                },
                family: {
                    title: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Dashboard",
                    subtitle: "Manage dependents and household emergency info in one place.",
                    coming: "Coming Soon",
                    invite: "Invite Family Members",
                    invite_desc: "Create and manage emergency profiles for your loved ones"
                },
                danger: {
                    title: "‚ö†Ô∏è Danger Zone",
                    subtitle: "This permanently deletes your account and all data.",
                    delete: "Delete My Account",
                    warning: "This will permanently delete your MYQER account and all associated data. This action cannot be undone.",
                    type_delete: "Type \"DELETE\" to confirm:",
                    understand: "I understand this action cannot be undone",
                    confirm: "Delete Account"
                },
                common: {
                    autosave: "‚úì Auto-saves as you type",
                    yes: "‚úÖ Yes",
                    no: "‚ùå No",
                    cancel: "Cancel",
                    save: "Save",
                    delete: "Delete"
                },
                status: {
                    offline: "Offline"
                },
                toasts: {
                    saving: "Saving...",
                    saved: "Saved",
                    offline: "No network - queued for sync",
                    network_restored: "Back online - syncing data",
                    sync_complete: "All changes synced successfully"
                },
                errors: {
                    network: "Network error",
                    save: "Couldn't save",
                    not_found: "Not found",
                    duplicate_contact: "You already added this person"
                },
                footer: {
                    copyright: "¬© 2025 MYQER ‚Äî Emergency Response QR ¬∑ GDPR/HIPAA-minded.",
                    privacy: "Privacy",
                    terms: "Terms",
                    about: "About",
                    support: "Support",
                    contact: "Contact"
                }
            },
            es: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (se pronuncia 'mi cuidado')",
                    tagline: "Privacidad primero. Funciona sin conexi√≥n."
                },
                nav: {
                    logout: "Cerrar sesi√≥n"
                },
                identity: {
                    title: "üë§ Identidad",
                    subtitle: "Estos detalles ayudan a los socorristas a confirmar qui√©n eres.",
                    name: "Nombre completo",
                    name_placeholder: "Ingresa tu nombre completo",
                    dob: "Fecha de nacimiento",
                    country: "Pa√≠s",
                    select_country: "Seleccionar pa√≠s",
                    health_id: "ID de salud (NHS, etc.)",
                    health_id_placeholder: "Opcional - nunca se muestra p√∫blicamente",
                    health_id_note: "El ID de salud es opcional y nunca se muestra en tu tarjeta p√∫blica.",
                    code: "Tu c√≥digo de tarjeta",
                    code_placeholder: "Se generar√° autom√°ticamente",
                    generate: "Generar c√≥digo",
                    save: "Guardar perfil"
                },
                // Add more Spanish translations...
                common: {
                    autosave: "‚úì Se guarda autom√°ticamente mientras escribes",
                    yes: "‚úÖ S√≠",
                    no: "‚ùå No",
                    cancel: "Cancelar",
                    save: "Guardar",
                    delete: "Eliminar"
                }
            },
            fr: {
                app: {
                    brand: "MYQER‚Ñ¢",
                    pronounce: "MYQER (se prononce 'mes soins')",
                    tagline: "Confidentialit√© d'abord. Fonctionne hors ligne."
                },
                nav: {
                    logout: "Se d√©connecter"
                },
                identity: {
                    title: "üë§ Identit√©",
                    subtitle: "Ces d√©tails aident les secouristes √† confirmer qui vous √™tes.",
                    name: "Nom complet",
                    name_placeholder: "Entrez votre nom complet",
                    dob: "Date de naissance",
                    country: "Pays",
                    select_country: "S√©lectionner le pays",
                    health_id: "ID sant√© (NHS, etc.)",
                    health_id_placeholder: "Optionnel - jamais affich√© publiquement",
                    health_id_note: "L'ID sant√© est optionnel et n'est jamais affich√© sur votre carte publique.",
                    code: "Votre code de carte",
                    code_placeholder: "Sera g√©n√©r√© automatiquement",
                    generate: "G√©n√©rer le code",
                    save: "Sauvegarder le profil"
                },
                // Add more French translations...
                common: {
                    autosave: "‚úì Sauvegarde automatique pendant que vous tapez",
                    yes: "‚úÖ Oui",
                    no: "‚ùå Non",
                    cancel: "Annuler",
                    save: "Sauvegarder",
                    delete: "Supprimer"
                }
            }
            // Add more languages: de, it, pt, hi, zh, ro, hu...
        };
        
        // i18n Functions
        function getCurrentLanguage() {
            return localStorage.getItem('myqer_lang') || navigator.language.split('-')[0] || 'en';
        }
        
        function t(key) {
            const lang = getCurrentLanguage();
            const keys = key.split('.');
            let value = T[lang] || T.en;
            
            for (const k of keys) {
                value = value?.[k];
                if (!value) break;
            }
            
            // Fallback to English if translation not found
            if (!value && lang !== 'en') {
                value = T.en;
                for (const k of keys) {
                    value = value?.[k];
                    if (!value) break;
                }
            }
            
            return value || key;
        }
        
        function updateLanguage() {
            const lang = getCurrentLanguage();
            
            // Update document direction for RTL languages
            if (['ar', 'he'].includes(lang)) {
                document.dir = 'rtl';
            } else {
                document.dir = 'ltr';
            }
            
            // Update all elements with data-i18n attributes
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
            
            // Update language selector
            document.getElementById('languageSelect').value = lang;
        }
        
        // Supabase Configuration (Replace with your actual values)
        const SUPABASE_URL = "https://YOURPROJECTID.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOi..."; // Your public anon key
        
        // Initialize Supabase client
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state
        let currentUser = null;
        let iceContactCount = 0;
        let saveTimeouts = {};
        let offlineQueue = [];
        let pillData = {
            allergies: [],
            conditions: [],
            medications: [],
            implants: []
        };
        let currentSpeech = null;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            updateLanguage();
            await checkAuth();
            setupEventListeners();
            setupPillInputs();
            loadUserData();
            registerServiceWorker();
            updateOfflineStatus();
            checkSpeechSupport();
        });
        
        // Check speech synthesis support
        function checkSpeechSupport() {
            if (!('speechSynthesis' in window)) {
                document.getElementById('speakTriageBtn').style.display = 'none';
                document.getElementById('speakCardBtn').style.display = 'none';
                document.getElementById('stopSpeechBtn').style.display = 'none';
            }
        }
        
        // Authentication check
        async function checkAuth() {
            const { data: { session } } = await sb.auth.getSession();
            if (!session) {
                window.location.href = '/'; // Redirect to login
                return;
            }
            currentUser = session.user;
            generateEmergencyCode();
        }
        
        // Event listeners
        function setupEventListeners() {
            // Language selector
            document.getElementById('languageSelect').addEventListener('change', (e) => {
                localStorage.setItem('myqer_lang', e.target.value);
                updateLanguage();
                showToast(t('toasts.language_updated'), 'success');
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await sb.auth.signOut();
                window.location.href = '/';
            });
            
            // Auto-save inputs
            setupAutoSave();
            
            // ICE contacts
            document.getElementById('addIceContact').addEventListener('click', addIceContact);
            
            // Delete account modal
            document.getElementById('deleteAccountBtn').addEventListener('click', showDeleteModal);
            document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteAccount);
            document.getElementById('deleteConfirmInput').addEventListener('input', validateDeleteInput);
            document.getElementById('deleteUnderstand').addEventListener('change', validateDeleteInput);
            
            // Triage override
            document.getElementById('triageOverride').addEventListener('change', updateTriageStatus);
            
            // Generate code button
            document.getElementById('generateCodeBtn').addEventListener('click', generateEmergencyCode);
            
            // Save buttons
            document.getElementById('saveProfileBtn').addEventListener('click', () => saveUserData(true));
            document.getElementById('saveHealthBtn').addEventListener('click', () => saveUserData(true));
            
            // Speech buttons
            document.getElementById('speakTriageBtn').addEventListener('click', speakTriage);
            document.getElementById('speakCardBtn').addEventListener('click', speakEmergencyCard);
            document.getElementById('stopSpeechBtn').addEventListener('click', stopSpeech);
            
            // QR and card buttons
            document.getElementById('viewCardBtn').addEventListener('click', viewEmergencyCard);
            document.getElementById('printCardBtn').addEventListener('click', printEmergencyCard);
            document.getElementById('shareQrBtn').addEventListener('click', shareQrCode);
            document.getElementById('copyLinkBtn').addEventListener('click', copyCardLink);
            document.getElementById('exportPngBtn').addEventListener('click', () => exportQR('png'));
            document.getElementById('exportSvgBtn').addEventListener('click', () => exportQR('svg'));
        }
        
        // Delete account modal functions
        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('show');
        }
        
        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('deleteUnderstand').checked = false;
            validateDeleteInput();
        }
        
        function validateDeleteInput() {
            const input = document.getElementById('deleteConfirmInput').value;
            const checkbox = document.getElementById('deleteUnderstand').checked;
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            confirmBtn.disabled = !(input === 'DELETE' && checkbox);
        }
        
        // Enhanced delete account handling
        async function handleDeleteAccount() {
            try {
                showToast(t('toasts.deleting_account'), 'warning');
                
                // Call secured Edge Function for account deletion
                const { data, error } = await sb.functions.invoke('delete-account', {
                    body: { userId: currentUser.id }
                });
                
                if (error) {
                    throw error;
                }
                
                // Success - sign out and redirect
                showToast(t('toasts.account_deleted'), 'success');
                
                setTimeout(async () => {
                    await sb.auth.signOut();
                    window.location.href = '/?deleted=true';
                }, 2000);
                
            } catch (error) {
                console.error('Delete account error:', error);
                
                // Show guidance for manual deletion
                showToast(t('errors.delete_failed'), 'error');
                setTimeout(() => {
                    alert(t('errors.contact_support') + ' support@myqer.com');
                }, 1000);
            }
            
            hideDeleteModal();
        }
        
        // Pill input setup
        function setupPillInputs() {
            const pillInputs = ['allergies', 'conditions', 'medications', 'implants'];
            
            pillInputs.forEach(type => {
                const input = document.getElementById(`${type}Input`);
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && input.value.trim()) {
                            e.preventDefault();
                            addPill(type, input.value.trim());
                            input.value = '';
                            debouncedSave(type);
                        }
                        if (e.key === 'Backspace' && !input.value && pillData[type].length > 0) {
                            removePill(type, pillData[type].length - 1);
                            debouncedSave(type);
                        }
                    });
                }
            });
        }
        
        // Pill management with validation
        function addPill(type, value) {
            // Trim and validate
            value = value.trim();
            if (!value || pillData[type].includes(value)) return;
            
            // Validation warnings (non-blocking)
            if (type === 'medications' && (value.toLowerCase().includes('many') || value.toLowerCase().includes('various'))) {
                showToast(t('warnings.be_specific'), 'warning');
            }
            
            pillData[type].push(value);
            renderPills(type);
            
            // Show tooltip reminder for allergies
            if (type === 'allergies') {
                showValidationTooltip(t('tooltips.informational_only'));
            }
        }
        
        function removePill(type, index) {
            pillData[type].splice(index, 1);
            renderPills(type);
        }
        
        function renderPills(type) {
            const container = document.getElementById(`${type}Pills`);
            if (!container) return;
            
            container.innerHTML = pillData[type].map((pill, index) => `
                <div class="pill">
                    ${pill}
                    <span class="pill-remove" onclick="removePillByIndex('${type}', ${index})">√ó</span>
                </div>
            `).join('');
        }
        
        function removePillByIndex(type, index) {
            removePill(type, index);
            debouncedSave(type);
        }
        
        // Auto-save functionality
        function setupAutoSave() {
            const autoSaveFields = [
                'fullName', 'dob', 'country', 'healthId', 'cardCode',
                'bloodType', 'organDonor', 'lifeSupportPref', 'burialPref', 'religionPref'
            ];
            
            autoSaveFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', () => debouncedSave(fieldId));
                    element.addEventListener('change', () => debouncedSave(fieldId));
                    element.addEventListener('blur', () => saveUserData(false, fieldId));
                }
            });
        }
        
        // Debounced save
        function debouncedSave(fieldId) {
            showSavingIndicator(fieldId);
            clearTimeout(saveTimeouts[fieldId]);
            saveTimeouts[fieldId] = setTimeout(() => {
                saveUserData(false, fieldId);
            }, 600);
        }
        
        // Save indicators
        function showSavingIndicator(fieldId) {
            const indicator = document.getElementById(`${fieldId}Indicator`);
            if (indicator) {
                indicator.innerHTML = `<div class="saving-dot"></div><span>${t('toasts.saving')}</span>`;
            }
        }
        
        function showSavedIndicator(fieldId) {
            const indicator = document.getElementById(`${fieldId}Indicator`);
            if (indicator) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                indicator.innerHTML = `<span class="saved-check">‚úì ${t('toasts.saved')} ${timestamp}</span>`;
            }
        }
        
        // Save user data
        async function saveUserData(immediate = false, specificField = null) {
            if (!currentUser) return;
            
            try {
                // Prepare profile data
                const profileData = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value,
                    health_id: maskHealthId(document.getElementById('healthId').value),
                    code: document.getElementById('cardCode').value,
                    updated_at: new Date().toISOString()
                };
                
                // Prepare health profile data
                const healthData = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value,
                    organ_donor: document.getElementById('organDonor').value === 'Yes',
                    allergies: pillData.allergies.join(', '),
                    conditions: pillData.conditions.join(', '),
                    meds: pillData.medications.join(', '),
                    implants: pillData.implants.join(', '),
                    life_support_pref: document.getElementById('lifeSupportPref').value,
                    burial_pref: document.getElementById('burialPref').value,
                    religion_pref: document.getElementById('religionPref').value,
                    triage_override: document.getElementById('triageOverride').value || null,
                    updated_at: new Date().toISOString()
                };
                
                // Save to Supabase with idempotent upserts
                await Promise.all([
                    sb.from('profiles').upsert(profileData, { onConflict: 'id' }),
                    sb.from('health_profiles').upsert(healthData, { onConflict: 'user_id' })
                ]);
                
                if (immediate) {
                    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    showToast(`${t('toasts.saved')} ${timestamp}`, 'success');
                } else if (specificField) {
                    showSavedIndicator(specificField);
                } else {
                    showToast(t('toasts.saved'), 'success');
                }
                
                updateTriageStatus();
                
            } catch (error) {
                console.error('Save error:', error);
                if (!navigator.onLine) {
                    // Queue for offline
                    offlineQueue.push({ profileData, healthData });
                    updateOfflineQueue();
                    showToast(t('toasts.offline'), 'warning');
                } else {
                    showToast(t('errors.save'), 'error');
                }
            }
        }
        
        // Health ID masking
        function maskHealthId(healthId) {
            if (!healthId || healthId.length <= 3) return healthId;
            return '*'.repeat(healthId.length - 3) + healthId.slice(-3);
        }
        
        // Load user data
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const [profileResult, healthResult, iceResult] = await Promise.all([
                    sb.from('profiles').select('*').eq('id', currentUser.id).single(),
                    sb.from('health_profiles').select('*').eq('user_id', currentUser.id).single(),
                    sb.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at')
                ]);
                
                // Populate profile data
                if (profileResult.data) {
                    const profile = profileResult.data;
                    document.getElementById('fullName').value = profile.full_name || '';
                    document.getElementById('dob').value = profile.dob || '';
                    document.getElementById('country').value = profile.country || '';
                    document.getElementById('healthId').value = profile.health_id || '';
                    document.getElementById('cardCode').value = profile.code || '';
                }
                
                // Populate health data
                if (healthResult.data) {
                    const health = healthResult.data;
                    document.getElementById('bloodType').value = health.blood_type || '‚Äî';
                    document.getElementById('organDonor').value = health.organ_donor ? 'Yes' : (health.organ_donor === false ? 'No' : '‚Äî');
                    
                    // Load pill data
                    pillData.allergies = health.allergies ? health.allergies.split(', ').filter(Boolean) : [];
                    pillData.conditions = health.conditions ? health.conditions.split(', ').filter(Boolean) : [];
                    pillData.medications = health.meds ? health.meds.split(', ').filter(Boolean) : [];
                    pillData.implants = health.implants ? health.implants.split(', ').filter(Boolean) : [];
                    
                    // Render pills
                    renderPills('allergies');
                    renderPills('conditions');
                    renderPills('medications');
                    renderPills('implants');
                    
                    document.getElementById('lifeSupportPref').value = health.life_support_pref || 'Full';
                    document.getElementById('burialPref').value = health.burial_pref || 'Burial';
                    document.getElementById('religionPref').value = health.religion_pref || 'None';
                    document.getElementById('triageOverride').value = health.triage_override || '';
                }
                
                // Populate ICE contacts
                if (iceResult.data) {
                    iceResult.data.forEach(contact => {
                        addIceContact(contact);
                    });
                }
                
                // Generate code if missing
                if (!document.getElementById('cardCode').value) {
                    generateEmergencyCode();
                } else {
                    // Update existing code display
                    const code = document.getElementById('cardCode').value;
                    updateCardLink(code);
                    generateQRCode(code);
                }
                
                updateTriageStatus();
                
            } catch (error) {
                console.error('Load error:', error);
                showToast(t('errors.load_data'), 'error');
            }
        }
        
        // ICE Contact management
        function addIceContact(existingContact = null) {
            if (iceContactCount >= 3) {
                showToast(t('ice.limit'), 'warning');
                return;
            }
            
            const container = document.getElementById('iceContacts');
            const contactId = existingContact?.id || `ice_${Date.now()}`;
            
            const contactDiv = document.createElement('div');
            contactDiv.className = 'border border-gray-200 rounded-lg p-4';
            contactDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">${t('ice.name')}</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" 
                               value="${existingContact?.name || ''}" data-field="name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">${t('ice.rel')}</label>
                        <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" 
                               value="${existingContact?.relation || ''}" data-field="relation" placeholder="Spouse, Parent, etc.">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">${t('ice.phone')}</label>
                        <input type="tel" class="w-full px-2 py-1 border border-gray-300 rounded" 
                               value="${existingContact?.phone || ''}" data-field="phone" placeholder="+1234567890" required>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <button class="text-red-600 text-sm hover:text-red-800" onclick="removeIceContact('${contactId}')">
                        ${t('ice.delete')}
                    </button>
                    <div class="text-xs text-gray-500">${t('common.autosave_blur')}</div>
                </div>
            `;
            
            contactDiv.dataset.contactId = contactId;
            container.appendChild(contactDiv);
            iceContactCount++;
            
            // Add auto-save listeners with blur trigger
            contactDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('blur', () => saveIceContact(contactId));
                input.addEventListener('input', () => debouncedSaveIce(contactId));
            });
            
            updateAddButtonState();
        }
        
        function removeIceContact(contactId) {
            if (!confirm(t('ice.confirm_remove'))) return;
            
            const contactDiv = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactDiv) {
                contactDiv.remove();
                iceContactCount--;
                updateAddButtonState();
                
                // Delete from database if it exists
                if (contactId.startsWith('ice_') === false) {
                    sb.from('ice_contacts').delete().eq('id', contactId);
                    showToast(t('toasts.contact_removed'), 'success');
                }
            }
        }
        
        // Debounced ICE save
        function debouncedSaveIce(contactId) {
            clearTimeout(saveTimeouts[`ice_${contactId}`]);
            saveTimeouts[`ice_${contactId}`] = setTimeout(() => {
                saveIceContact(contactId);
            }, 600);
        }
        
        function updateAddButtonState() {
            const addBtn = document.getElementById('addIceContact');
            addBtn.disabled = iceContactCount >= 3;
            addBtn.textContent = iceContactCount >= 3 ? t('ice.max_reached') : `${t('ice.add')} (${iceContactCount}/3)`;
        }
        
        async function saveIceContact(contactId) {
            const contactDiv = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (!contactDiv) return;
            
            const name = contactDiv.querySelector('[data-field="name"]').value.trim();
            const relation = contactDiv.querySelector('[data-field="relation"]').value.trim();
            const phone = contactDiv.querySelector('[data-field="phone"]').value.trim();
            
            if (!name || !phone) return;
            
            try {
                // Normalize phone to E.164 format (basic)
                const normalizedPhone = phone.replace(/[^\d+]/g, '');
                
                const contactData = {
                    user_id: currentUser.id,
                    name,
                    relation,
                    phone: normalizedPhone
                };
                
                if (contactId.startsWith('ice_')) {
                    // New contact
                    const { data, error } = await sb.from('ice_contacts').insert(contactData).select().single();
                    if (error) throw error;
                    contactDiv.dataset.contactId = data.id;
                } else {
                    // Update existing
                    const { error } = await sb.from('ice_contacts').update(contactData).eq('id', contactId);
                    if (error) throw error;
                }
                
                showToast(t('toasts.contact_saved'), 'success');
            } catch (error) {
                console.error('ICE save error:', error);
                
                // Handle duplicate constraint error
                if (error.message.includes('duplicate key value')) {
                    showToast(t('errors.duplicate_contact'), 'warning');
                } else {
                    showToast(t('errors.save_contact'), 'error');
                }
            }
        }
        
        // Enhanced triage status calculation
        function updateTriageStatus() {
            const override = document.getElementById('triageOverride').value;
            const statusElement = document.getElementById('triageStatus');
            
            if (override) {
                const statusMap = {
                    'Green': { class: 'triage-green', text: t('triage.green') },
                    'Amber': { class: 'triage-amber', text: t('triage.amber') },
                    'Red': { class: 'triage-red', text: t('triage.red') },
                    'Black': { class: 'triage-black', text: t('triage.black') }
                };
                
                const status = statusMap[override];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            } else {
                // Auto-calculate based on enhanced logic
                let calculatedStatus = 'Green';
                
                // Check life support preference first
                const lifeSupportPref = document.getElementById('lifeSupportPref').value;
                if (lifeSupportPref === 'DNR') {
                    calculatedStatus = 'Black';
                    // Show non-blocking DNR alert
                    showValidationTooltip(t('warnings.dnr_detected'));
                } else {
                    // Check for severe allergies
                    const allergies = pillData.allergies.join(' ').toLowerCase();
                    const severeAllergyKeywords = ['anaphylaxis', 'epipen', 'epinephrine', 'severe'];
                    
                    // Check conditions
                    const conditions = pillData.conditions.join(' ').toLowerCase();
                    const criticalConditions = ['cardiac', 'heart attack', 'stroke', 'epilepsy', 'seizure'];
                    
                    // Check medications
                    const medications = pillData.medications.join(' ').toLowerCase();
                    const criticalMeds = ['anticoagulant', 'warfarin', 'heparin', 'insulin'];
                    
                    // Determine status
                    if (severeAllergyKeywords.some(keyword => allergies.includes(keyword)) ||
                        criticalConditions.some(condition => conditions.includes(condition)) ||
                        criticalMeds.some(med => medications.includes(med))) {
                        calculatedStatus = 'Red';
                    } else if (pillData.conditions.length > 2 || pillData.medications.length > 3 ||
                               conditions.includes('diabetes') || conditions.includes('hypertension') ||
                               conditions.includes('chronic')) {
                        calculatedStatus = 'Amber';
                    }
                }
                
                const statusMap = {
                    'Green': { class: 'triage-green', text: `${t('triage.green')} (Auto)` },
                    'Amber': { class: 'triage-amber', text: `${t('triage.amber')} (Auto)` },
                    'Red': { class: 'triage-red', text: `${t('triage.red')} (Auto)` },
                    'Black': { class: 'triage-black', text: `${t('triage.black')} (Auto)` }
                };
                
                const status = statusMap[calculatedStatus];
                statusElement.className = `triage-status ${status.class}`;
                statusElement.textContent = status.text;
            }
        }
        
        // Speech synthesis functionality
        function getVoice() {
            const voices = speechSynthesis.getVoices();
            const lang = getCurrentLanguage();
            
            // Try to find a female voice for the current language
            let voice = voices.find(v => v.lang.startsWith(lang) && v.name.toLowerCase().includes('female'));
            if (!voice) {
                voice = voices.find(v => v.lang.startsWith(lang));
            }
            if (!voice) {
                voice = voices.find(v => v.default);
            }
            
            return voice;
        }
        
        function speakText(text) {
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            const voice = getVoice();
            
            if (voice) {
                utterance.voice = voice;
            }
            
            utterance.rate = 0.95;
            utterance.pitch = 1.05;
            
            currentSpeech = utterance;
            speechSynthesis.speak(utterance);
            
            // Show/hide stop button
            document.getElementById('stopSpeechBtn').style.display = 'block';
            document.getElementById('speakTriageBtn').style.display = 'none';
            document.getElementById('speakCardBtn').style.display = 'none';
            
            utterance.onend = () => {
                currentSpeech = null;
                document.getElementById('stopSpeechBtn').style.display = 'none';
                document.getElementById('speakTriageBtn').style.display = 'block';
                document.getElementById('speakCardBtn').style.display = 'block';
            };
        }
        
        function stopSpeech() {
            if (currentSpeech) {
                speechSynthesis.cancel();
                currentSpeech = null;
                document.getElementById('stopSpeechBtn').style.display = 'none';
                document.getElementById('speakTriageBtn').style.display = 'block';
                document.getElementById('speakCardBtn').style.display = 'block';
            }
        }
        
        function speakTriage() {
            const name = document.getElementById('fullName').value || t('speech.patient');
            const triageStatus = document.getElementById('triageStatus').textContent;
            
            const text = `${t('speech.triage_status')} ${name}: ${triageStatus}`;
            speakText(text);
        }
        
        function speakEmergencyCard() {
            const name = document.getElementById('fullName').value || t('speech.patient');
            const dob = document.getElementById('dob').value;
            const country = document.getElementById('country').value;
            const bloodType = document.getElementById('bloodType').value;
            const organDonor = document.getElementById('organDonor').value;
            const topAllergies = pillData.allergies.slice(0, 2).join(', ');
            const criticalMeds = pillData.medications.slice(0, 2).join(', ');
            const implants = pillData.implants.length > 0 ? pillData.implants[0] : '';
            const triageColor = document.getElementById('triageStatus').textContent.split(' ')[1];
            
            let age = '';
            if (dob) {
                const birthDate = new Date(dob);
                const today = new Date();
                age = Math.floor((today - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
            }
            
            let summary = `${t('speech.emergency_summary')} ${name}`;
            if (age) summary += `, ${t('speech.age')} ${age}`;
            if (country) summary += `, ${t('speech.from')} ${country}`;
            if (bloodType && bloodType !== '‚Äî') summary += `. ${t('speech.blood_type')}: ${bloodType}`;
            if (organDonor && organDonor !== '‚Äî') summary += `. ${t('speech.organ_donor')}: ${organDonor}`;
            if (topAllergies) summary += `. ${t('speech.critical_allergies')}: ${topAllergies}`;
            if (criticalMeds) summary += `. ${t('speech.critical_medications')}: ${criticalMeds}`;
            if (implants) summary += `. ${t('speech.important')}: ${implants}`;
            summary += `. ${t('speech.triage_priority')}: ${triageColor}`;
            
            speakText(summary);
        }
        
        // Emergency code generation
        function generateEmergencyCode() {
            const code = Array.from(crypto.getRandomValues(new Uint8Array(16)))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('')
                .substring(0, 12)
                .toUpperCase();
            
            document.getElementById('cardCode').value = code;
            updateCardLink(code);
            generateQRCode(code);
            
            // Auto-save the new code
            debouncedSave('cardCode');
            
            showToast(t('toasts.code_generated'), 'success');
        }
        
        // Update card link
        function updateCardLink(code) {
            const link = `https://www.myqer.com/c/${code}`;
            document.getElementById('cardLink').value = link;
        }
        
        // Generate QR Code (simple pattern for demo)
        function generateQRCode(code) {
            const canvas = document.getElementById('qrCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 120, 120);
            
            // Draw simple QR pattern (finder patterns)
            ctx.fillStyle = '#000000';
            
            // Top-left finder pattern
            ctx.fillRect(8, 8, 28, 28);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(12, 12, 20, 20);
            ctx.fillStyle = '#000000';
            ctx.fillRect(16, 16, 12, 12);
            
            // Top-right finder pattern
            ctx.fillStyle = '#000000';
            ctx.fillRect(84, 8, 28, 28);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(88, 12, 20, 20);
            ctx.fillStyle = '#000000';
            ctx.fillRect(92, 16, 12, 12);
            
            // Bottom-left finder pattern
            ctx.fillStyle = '#000000';
            ctx.fillRect(8, 84, 28, 28);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(12, 88, 20, 20);
            ctx.fillStyle = '#000000';
            ctx.fillRect(16, 92, 12, 12);
            
            // Add data modules (simplified pattern)
            ctx.fillStyle = '#000000';
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    if (Math.random() > 0.5) {
                        ctx.fillRect(40 + i * 4, 40 + j * 4, 3, 3);
                    }
                }
            }
        }
        
        // Copy card link
        function copyCardLink() {
            const link = document.getElementById('cardLink').value;
            navigator.clipboard.writeText(link).then(() => {
                showToast(t('qr.copied'), 'success');
            });
        }
        
        // Export QR code
        function exportQR(format) {
            const canvas = document.getElementById('qrCanvas');
            
            if (format === 'png') {
                // Create high-res version
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = 1024;
                exportCanvas.height = 1024;
                const ctx = exportCanvas.getContext('2d');
                
                // Scale up the current canvas
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(canvas, 0, 0, 1024, 1024);
                
                // Download
                const link = document.createElement('a');
                link.download = `myqer-qr-${document.getElementById('cardCode').value}.png`;
                link.href = exportCanvas.toDataURL();
                link.click();
                
                showToast(t('toasts.qr_exported_png'), 'success');
            } else if (format === 'svg') {
                // Create SVG version
                const code = document.getElementById('cardCode').value;
                const svg = `
                    <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="200" height="200" fill="white"/>
                        <text x="100" y="100" text-anchor="middle" font-family="Arial" font-size="12">
                            QR Code: ${code}
                        </text>
                    </svg>
                `;
                
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const link = document.createElement('a');
                link.download = `myqer-qr-${code}.svg`;
                link.href = URL.createObjectURL(blob);
                link.click();
                
                showToast(t('toasts.qr_exported_svg'), 'success');
            }
        }
        
        // QR and card functionality
        function viewEmergencyCard() {
            const code = document.getElementById('cardCode').value;
            if (!code) {
                showToast(t('warnings.generate_code_first'), 'warning');
                return;
            }
            
            // In a real app, this would open the emergency card view
            const url = `https://myqer.com/card/${code}`;
            window.open(url, '_blank');
        }
        
        function printEmergencyCard() {
            const code = document.getElementById('cardCode').value;
            if (!code) {
                showToast(t('warnings.generate_code_first'), 'warning');
                return;
            }
            
            // In a real app, this would generate a printable card
            showToast(t('warnings.print_coming_soon'), 'warning');
        }
        
        function shareQrCode() {
            const code = document.getElementById('cardCode').value;
            if (!code) {
                showToast(t('warnings.generate_code_first'), 'warning');
                return;
            }
            
            const url = `https://myqer.com/card/${code}`;
            
            if (navigator.share) {
                navigator.share({
                    title: t('share.title'),
                    text: t('share.text'),
                    url: url
                });
            } else {
                // Fallback to clipboard
                navigator.clipboard.writeText(url).then(() => {
                    showToast(t('toasts.link_copied'), 'success');
                });
            }
        }
        
        // Offline status management
        function updateOfflineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            const queueCount = document.getElementById('queueCount');
            
            if (!navigator.onLine) {
                indicator.style.display = 'flex';
                if (offlineQueue.length > 0) {
                    queueCount.textContent = offlineQueue.length;
                    queueCount.style.display = 'block';
                } else {
                    queueCount.style.display = 'none';
                }
            } else {
                indicator.style.display = 'none';
            }
        }
        
        function updateOfflineQueue() {
            const queueCount = document.getElementById('queueCount');
            if (offlineQueue.length > 0) {
                queueCount.textContent = offlineQueue.length;
                queueCount.style.display = 'block';
            } else {
                queueCount.style.display = 'none';
            }
        }
        
        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Validation tooltip
        function showValidationTooltip(message) {
            const tooltip = document.createElement('div');
            tooltip.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm z-50 opacity-0 transition-opacity';
            tooltip.textContent = message;
            document.body.appendChild(tooltip);
            
            setTimeout(() => tooltip.classList.add('opacity-100'), 100);
            setTimeout(() => {
                tooltip.classList.remove('opacity-100');
                setTimeout(() => tooltip.remove(), 300);
            }, 4000);
        }
        
        // Service Worker registration
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            }
        }
        
        // Offline handling
        window.addEventListener('online', () => {
            updateOfflineStatus();
            showToast(t('toasts.network_restored'), 'success');
            processOfflineQueue();
        });
        
        window.addEventListener('offline', () => {
            updateOfflineStatus();
            showToast(t('toasts.offline'), 'warning');
        });
        
        async function processOfflineQueue() {
            while (offlineQueue.length > 0) {
                const data = offlineQueue.shift();
                try {
                    await Promise.all([
                        sb.from('profiles').upsert(data.profileData, { onConflict: 'id' }),
                        sb.from('health_profiles').upsert(data.healthData, { onConflict: 'user_id' })
                    ]);
                    updateOfflineQueue();
                } catch (error) {
                    console.error('Offline sync error:', error);
                    offlineQueue.unshift(data); // Put back in queue
                    break;
                }
            }
            
            if (offlineQueue.length === 0) {
                showToast(t('toasts.sync_complete'), 'success');
            }
        }
        
        // Make functions globally available
        window.removeIceContact = removeIceContact;
        window.removePillByIndex = removePillByIndex;
        
        // Production logging suppression
        if (window.location.hostname !== 'localhost') {
            console.log = () => {};
            console.warn = () => {};
            console.info = () => {};
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9776833735413695',t:'MTc1NjU4MDIzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
