<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-red: #dc2626;
            --primary-red-hover: #ef4444;
            --success-green: #059669;
            --warning-amber: #ea580c;
            --ink-dark: #0f172a;
            --slate-text: #475569;
            --slate-light: #94a3b8;
            --background-white: #ffffff;
            --background-gray: #f8fafc;
            --border-light: #e2e8f0;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--background-gray) 0%, #f1f5f9 100%);
            color: var(--ink-dark);
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 18px;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .logo-text {
            font-size: 24px;
            font-weight: 800;
            color: var(--ink-dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--slate-text);
            font-size: 14px;
        }

        .language-selector {
            position: relative;
        }

        .language-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            color: var(--slate-text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .language-option:hover {
            background-color: #f8fafc;
        }

        .language-option.active {
            background-color: var(--primary-red);
            color: white;
        }

        .logout-btn {
            background: none;
            border: 1px solid var(--border-light);
            color: var(--slate-text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .offline-banner {
            background: linear-gradient(135deg, var(--warning-amber), #f97316);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(234, 88, 12, 0.3);
        }

        .offline-banner.show {
            display: flex;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: 24px 0 0 24px;
        }

        .card.identity::before {
            background: linear-gradient(135deg, var(--success-green), #10b981);
        }

        .card.critical::before {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
        }

        .card.ice::before {
            background: linear-gradient(135deg, var(--warning-amber), #f97316);
        }

        .card.emergency {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.05), rgba(239, 68, 68, 0.05));
        }

        .card.emergency::before {
            background: linear-gradient(135deg, #ec4899, #f472b6);
        }

        .card.delete {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.02), rgba(239, 68, 68, 0.02));
            border: 2px solid rgba(220, 38, 38, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--ink-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .triage-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .triage-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .triage-green {
            background: var(--success-green);
            color: white;
        }

        .triage-amber {
            background: var(--warning-amber);
            color: white;
        }

        .triage-red {
            background: var(--primary-red);
            color: white;
        }

        .triage-black {
            background: #1f2937;
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: 400;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 16px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-red);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            color: white;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-red);
            border: 2px solid var(--primary-red);
        }

        .btn-secondary:hover {
            background: var(--primary-red);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green), #10b981);
            color: white;
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-amber), #f97316);
            color: white;
            box-shadow: 0 4px 16px rgba(234, 88, 12, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(234, 88, 12, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
        }

        .ice-contact {
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .ice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .ice-title {
            font-weight: 600;
            color: var(--ink-dark);
        }

        .ice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            text-align: center;
        }

        .qr-box {
            width: 240px;
            height: 240px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-code {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 24px;
            font-weight: 800;
            color: var(--ink-dark);
            letter-spacing: 2px;
        }

        .qr-label {
            font-size: 12px;
            color: var(--primary-red);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .url-group {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .url-input {
            flex: 1;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            background: #f8fafc;
            border: 2px solid var(--border-light);
            padding: 12px 16px;
            border-radius: 8px;
        }

        .qr-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .delete-section {
            text-align: center;
            padding: 40px;
        }

        .delete-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 16px;
        }

        .delete-warning {
            color: #6b7280;
            margin-bottom: 32px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .confirm-input {
            max-width: 300px;
            margin: 0 auto 24px;
            text-align: center;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success-green), #10b981);
        }

        .toast.error {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 16px;
        }

        .modal-text {
            color: #6b7280;
            margin-bottom: 32px;
        }

        .modal-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .footer {
            margin-top: 80px;
            padding: 40px 0;
            border-top: 1px solid var(--border-light);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
        }

        .footer-links {
            display: flex;
            gap: 32px;
        }

        .footer-link {
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--primary-red);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .saving-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-text);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .saving-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .no-contacts {
            text-align: center;
            padding: 40px;
            color: var(--slate-text);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .ice-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 24px;
            }

            .qr-actions {
                flex-direction: column;
            }

            .url-group {
                flex-direction: column;
            }

            .triage-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="container">
            <div id="offlineBanner" class="offline-banner">
                <span>‚ö†Ô∏è</span>
                <span data-i18n="offline_mode">You're offline. Changes will sync when connection is restored.</span>
            </div>

            <header class="header">
                <div class="logo">
                    <div class="logo-icon">M</div>
                    <div class="logo-text">MYQER</div>
                </div>
                <div class="user-info">
                    <div class="language-selector">
                        <button class="language-btn" onclick="toggleLanguageDropdown()">
                            <span id="currentLanguage">üá∫üá∏ EN</span>
                            <span>‚ñº</span>
                        </button>
                        <div id="languageDropdown" class="language-dropdown">
                            <div class="language-option active" onclick="changeLanguage('en')">üá∫üá∏ English</div>
                            <div class="language-option" onclick="changeLanguage('es')">üá™üá∏ Espa√±ol</div>
                            <div class="language-option" onclick="changeLanguage('fr')">üá´üá∑ Fran√ßais</div>
                            <div class="language-option" onclick="changeLanguage('de')">üá©üá™ Deutsch</div>
                            <div class="language-option" onclick="changeLanguage('it')">üáÆüáπ Italiano</div>
                            <div class="language-option" onclick="changeLanguage('pt')">üáµüáπ Portugu√™s</div>
                            <div class="language-option" onclick="changeLanguage('ro')">üá∑üá¥ Rom√¢nƒÉ</div>
                            <div class="language-option" onclick="changeLanguage('ar')">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                            <div class="language-option" onclick="changeLanguage('hi')">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                            <div class="language-option" onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</div>
                        </div>
                    </div>
                    <span id="userEmail">user@example.com</span>
                    <button class="logout-btn" onclick="logout()" data-i18n="logout">Logout</button>
                </div>
            </header>

            <div class="card identity">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="identity_title">Identity ‚Äî Personal Information</h2>
                    <button class="btn btn-success" onclick="saveProfile()" data-i18n="save">Save</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-i18n="full_name">Full Name</label>
                        <input type="text" id="fullName" class="form-input" placeholder="Enter your full legal name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="date_of_birth">Date of Birth</label>
                        <input type="date" id="dob" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="country">Country</label>
                        <select id="country" class="form-select">
                            <option value="">Select Country</option>
                            <option value="United States">United States</option>
                            <option value="Canada">Canada</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Spain">Spain</option>
                            <option value="Italy">Italy</option>
                            <option value="Australia">Australia</option>
                            <option value="Japan">Japan</option>
                            <option value="China">China</option>
                            <option value="India">India</option>
                            <option value="Brazil">Brazil</option>
                            <option value="Mexico">Mexico</option>
                            <option value="Argentina">Argentina</option>
                            <option value="South Africa">South Africa</option>
                            <option value="Nigeria">Nigeria</option>
                            <option value="Egypt">Egypt</option>
                            <option value="Russia">Russia</option>
                            <option value="Turkey">Turkey</option>
                            <option value="Saudi Arabia">Saudi Arabia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="health_id">National/Health ID (Optional)</label>
                        <input type="text" id="healthId" class="form-input" placeholder="e.g., SSN, NHS Number">
                    </div>
                </div>
            </div>

            <div class="card critical">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="critical_title">CRITICAL ‚Äî Medical & Health Details</h2>
                    <div class="triage-container">
                        <select id="triageOverride" class="form-select" style="width: auto; min-width: 120px;" onchange="updateTriage()">
                            <option value="auto" data-i18n="auto">Auto</option>
                            <option value="green" data-i18n="green">Green</option>
                            <option value="amber" data-i18n="amber">Amber</option>
                            <option value="red" data-i18n="red">Red</option>
                            <option value="black" data-i18n="black">Black</option>
                        </select>
                        <div id="triagePill" class="triage-pill triage-green">
                            <span>‚óè</span> <span data-i18n="green">Green</span>
                        </div>
                        <button class="btn btn-warning" onclick="saveHealth()" data-i18n="save">Save</button>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-i18n="blood_type">Blood Type</label>
                        <select id="bloodType" class="form-select">
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+ (A Positive)</option>
                            <option value="A-">A- (A Negative)</option>
                            <option value="B+">B+ (B Positive)</option>
                            <option value="B-">B- (B Negative)</option>
                            <option value="AB+">AB+ (AB Positive)</option>
                            <option value="AB-">AB- (AB Negative)</option>
                            <option value="O+">O+ (O Positive)</option>
                            <option value="O-">O- (O Negative)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="allergies">Critical Allergies</label>
                        <input type="text" id="allergies" class="form-input" placeholder="e.g., Penicillin, Nuts, Shellfish">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="conditions">Medical Conditions</label>
                        <textarea id="conditions" class="form-textarea" placeholder="List any chronic conditions, diseases, or ongoing medical issues"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="medications">Current Medications</label>
                        <textarea id="medications" class="form-textarea" placeholder="List all current medications with dosages"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="implants">Implants/Medical Devices</label>
                        <input type="text" id="implants" class="form-input" placeholder="e.g., Pacemaker, Hip replacement, Insulin pump">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="organDonor" class="checkbox">
                            <label for="organDonor" class="form-label" data-i18n="organ_donor">I am an organ donor</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card ice">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="ice_title">Emergency Contacts (ICE)</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="addContact()" data-i18n="add_contact">Add Contact</button>
                        <button class="btn btn-warning" onclick="saveICE()" data-i18n="save_all">Save All</button>
                    </div>
                </div>
                <div id="iceContacts">
                    <div class="no-contacts" data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>
                </div>
            </div>

            <div class="card emergency">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="qr_title">Emergency Card & QR Code</h2>
                </div>
                <div class="qr-container">
                    <div class="qr-box">
                        <canvas id="qrCanvas" width="200" height="200"></canvas>
                    </div>
                    <div class="qr-code" id="qrCode">XXXX-XXXX</div>
                    <div class="qr-label">MYQER‚Ñ¢</div>
                    
                    <div class="url-group">
                        <input type="text" id="cardUrl" class="url-input" readonly value="https://www.myqer.com/c/XXXX-XXXX">
                        <button class="btn btn-secondary" onclick="copyUrl()" data-i18n="copy">Copy</button>
                        <button class="btn btn-secondary" onclick="openUrl()" data-i18n="open">Open</button>
                    </div>
                    
                    <div class="qr-actions">
                        <button class="btn btn-secondary" onclick="downloadQR('png')" data-i18n="download_png">Download PNG</button>
                        <button class="btn btn-secondary" onclick="downloadQR('svg')" data-i18n="download_svg">Download SVG</button>
                        <button class="btn btn-secondary" onclick="printQR()" data-i18n="print">Print</button>
                    </div>
                </div>
            </div>

            <div class="card delete">
                <div class="delete-section">
                    <h2 class="delete-title" data-i18n="delete_title">‚ö†Ô∏è Delete Account</h2>
                    <p class="delete-warning" data-i18n="delete_warning">
                        This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers.
                    </p>
                    <div class="form-group">
                        <label class="form-label" data-i18n="delete_confirm_label">Type "DELETE MY ACCOUNT" to confirm:</label>
                        <input type="text" id="deleteConfirm" class="form-input confirm-input" placeholder="DELETE MY ACCOUNT">
                    </div>
                    <button class="btn btn-danger" onclick="deleteAccount()" data-i18n="delete_account">Delete My Account</button>
                </div>
            </div>

            <footer class="footer">
                <div class="footer-content">
                    <div style="color: #6b7280; font-size: 14px;" data-i18n="copyright">
                        ¬© 2024 MYQER. All rights reserved.
                    </div>
                    <div class="footer-links">
                        <a href="#" class="footer-link" data-i18n="privacy_policy">Privacy Policy</a>
                        <a href="#" class="footer-link" data-i18n="terms_of_service">Terms of Service</a>
                        <a href="#" class="footer-link" data-i18n="support">Support</a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <div id="savingIndicator" class="saving-indicator">
        <span data-i18n="saving">Saving...</span>
    </div>

    <div id="idleModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" data-i18n="session_expiring">Session Expiring</h3>
            <p class="modal-text">
                <span data-i18n="session_expire_text">Your session will expire in</span> 
                <span id="countdown">60</span> 
                <span data-i18n="seconds">seconds due to inactivity.</span>
            </p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="resetIdleTimer()" data-i18n="stay_logged_in">Stay Logged In</button>
                <button class="btn btn-secondary" onclick="logout()" data-i18n="logout">Logout</button>
            </div>
        </div>
    </div>

    <script>
        let supabase;
        let currentUser = { id: 'demo-user-' + Date.now(), email: 'user@example.com' };
        let iceContacts = [];
        let idleTimer = null;
        let warningTimer = null;
        let countdownTimer = null;
        let countdownSeconds = 60;
        let debounceTimers = {};
        let isOnline = navigator.onLine;
        let currentLanguage = 'en';
        let userCode = null;
        let isGeneratingQR = false;

        const SUPABASE_URL = 'https://dmntmhkncldgynufajei.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY';

        const translations = {
            en: {
                offline_mode: "You're offline. Changes will sync when connection is restored.",
                logout: "Logout",
                identity_title: "Identity ‚Äî Personal Information",
                save: "Save",
                full_name: "Full Name",
                date_of_birth: "Date of Birth",
                country: "Country",
                health_id: "National/Health ID (Optional)",
                critical_title: "CRITICAL ‚Äî Medical & Health Details",
                auto: "Auto",
                green: "Green",
                amber: "Amber",
                red: "Red",
                black: "Black",
                blood_type: "Blood Type",
                allergies: "Critical Allergies",
                conditions: "Medical Conditions",
                medications: "Current Medications",
                implants: "Implants/Medical Devices",
                organ_donor: "I am an organ donor",
                ice_title: "Emergency Contacts (ICE)",
                add_contact: "Add Contact",
                save_all: "Save All",
                qr_title: "Emergency Card & QR Code",
                copy: "Copy",
                open: "Open",
                download_png: "Download PNG",
                download_svg: "Download SVG",
                print: "Print",
                delete_title: "‚ö†Ô∏è Delete Account",
                delete_warning: "This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers.",
                delete_confirm_label: "Type \"DELETE MY ACCOUNT\" to confirm:",
                delete_account: "Delete My Account",
                copyright: "¬© 2024 MYQER. All rights reserved.",
                privacy_policy: "Privacy Policy",
                terms_of_service: "Terms of Service",
                support: "Support",
                saving: "Saving...",
                session_expiring: "Session Expiring",
                session_expire_text: "Your session will expire in",
                seconds: "seconds due to inactivity.",
                stay_logged_in: "Stay Logged In",
                contact_name: "Name",
                contact_relationship: "Relationship",
                contact_phone: "Phone",
                remove: "Remove",
                no_contacts: "No emergency contacts added yet. Click \"Add Contact\" to get started."
            },
            es: {
                offline_mode: "Est√°s desconectado. Los cambios se sincronizar√°n cuando se restaure la conexi√≥n.",
                logout: "Cerrar Sesi√≥n",
                identity_title: "Identidad ‚Äî Informaci√≥n Personal",
                save: "Guardar",
                full_name: "Nombre Completo",
                date_of_birth: "Fecha de Nacimiento",
                country: "Pa√≠s",
                health_id: "ID Nacional/Salud (Opcional)",
                critical_title: "CR√çTICO ‚Äî Detalles M√©dicos y de Salud",
                auto: "Auto",
                green: "Verde",
                amber: "√Åmbar",
                red: "Rojo",
                black: "Negro",
                blood_type: "Tipo de Sangre",
                allergies: "Alergias Cr√≠ticas",
                conditions: "Condiciones M√©dicas",
                medications: "Medicamentos Actuales",
                implants: "Implantes/Dispositivos M√©dicos",
                organ_donor: "Soy donante de √≥rganos",
                ice_title: "Contactos de Emergencia (ICE)",
                add_contact: "Agregar Contacto",
                save_all: "Guardar Todo",
                qr_title: "Tarjeta de Emergencia y C√≥digo QR",
                copy: "Copiar",
                open: "Abrir",
                download_png: "Descargar PNG",
                download_svg: "Descargar SVG",
                print: "Imprimir",
                delete_title: "‚ö†Ô∏è Eliminar Cuenta",
                delete_warning: "Esta acci√≥n no se puede deshacer. Todos tus datos m√©dicos de emergencia, c√≥digos QR e informaci√≥n de perfil ser√°n eliminados permanentemente de nuestros servidores.",
                delete_confirm_label: "Escribe \"DELETE MY ACCOUNT\" para confirmar:",
                delete_account: "Eliminar Mi Cuenta",
                copyright: "¬© 2024 MYQER. Todos los derechos reservados.",
                privacy_policy: "Pol√≠tica de Privacidad",
                terms_of_service: "T√©rminos de Servicio",
                support: "Soporte",
                saving: "Guardando...",
                session_expiring: "Sesi√≥n Expirando",
                session_expire_text: "Tu sesi√≥n expirar√° en",
                seconds: "segundos debido a inactividad.",
                stay_logged_in: "Mantener Sesi√≥n",
                contact_name: "Nombre",
                contact_relationship: "Relaci√≥n",
                contact_phone: "Tel√©fono",
                remove: "Eliminar",
                no_contacts: "No se han agregado contactos de emergencia a√∫n. Haz clic en \"Agregar Contacto\" para comenzar."
            },
            fr: {
                offline_mode: "Vous √™tes hors ligne. Les modifications se synchroniseront lorsque la connexion sera r√©tablie.",
                logout: "D√©connexion",
                identity_title: "Identit√© ‚Äî Informations Personnelles",
                save: "Enregistrer",
                full_name: "Nom Complet",
                date_of_birth: "Date de Naissance",
                country: "Pays",
                health_id: "ID National/Sant√© (Optionnel)",
                critical_title: "CRITIQUE ‚Äî D√©tails M√©dicaux et de Sant√©",
                auto: "Auto",
                green: "Vert",
                amber: "Ambre",
                red: "Rouge",
                black: "Noir",
                blood_type: "Groupe Sanguin",
                allergies: "Allergies Critiques",
                conditions: "Conditions M√©dicales",
                medications: "M√©dicaments Actuels",
                implants: "Implants/Dispositifs M√©dicaux",
                organ_donor: "Je suis donneur d'organes",
                ice_title: "Contacts d'Urgence (ICE)",
                add_contact: "Ajouter Contact",
                save_all: "Tout Enregistrer",
                qr_title: "Carte d'Urgence et Code QR",
                copy: "Copier",
                open: "Ouvrir",
                download_png: "T√©l√©charger PNG",
                download_svg: "T√©l√©charger SVG",
                print: "Imprimer",
                delete_title: "‚ö†Ô∏è Supprimer le Compte",
                delete_warning: "Cette action ne peut pas √™tre annul√©e. Toutes vos donn√©es m√©dicales d'urgence, codes QR et informations de profil seront d√©finitivement supprim√©es de nos serveurs.",
                delete_confirm_label: "Tapez \"DELETE MY ACCOUNT\" pour confirmer:",
                delete_account: "Supprimer Mon Compte",
                copyright: "¬© 2024 MYQER. Tous droits r√©serv√©s.",
                privacy_policy: "Politique de Confidentialit√©",
                terms_of_service: "Conditions de Service",
                support: "Support",
                saving: "Enregistrement...",
                session_expiring: "Session Expirant",
                session_expire_text: "Votre session expirera dans",
                seconds: "secondes en raison d'inactivit√©.",
                stay_logged_in: "Rester Connect√©",
                contact_name: "Nom",
                contact_relationship: "Relation",
                contact_phone: "T√©l√©phone",
                remove: "Supprimer",
                no_contacts: "Aucun contact d'urgence ajout√© pour le moment. Cliquez sur \"Ajouter Contact\" pour commencer."
            },
            de: {
                offline_mode: "Sie sind offline. √Ñnderungen werden synchronisiert, wenn die Verbindung wiederhergestellt ist.",
                logout: "Abmelden",
                identity_title: "Identit√§t ‚Äî Pers√∂nliche Informationen",
                save: "Speichern",
                full_name: "Vollst√§ndiger Name",
                date_of_birth: "Geburtsdatum",
                country: "Land",
                health_id: "National-/Gesundheits-ID (Optional)",
                critical_title: "KRITISCH ‚Äî Medizinische und Gesundheitsdetails",
                auto: "Auto",
                green: "Gr√ºn",
                amber: "Gelb",
                red: "Rot",
                black: "Schwarz",
                blood_type: "Blutgruppe",
                allergies: "Kritische Allergien",
                conditions: "Medizinische Bedingungen",
                medications: "Aktuelle Medikamente",
                implants: "Implantate/Medizinische Ger√§te",
                organ_donor: "Ich bin Organspender",
                ice_title: "Notfallkontakte (ICE)",
                add_contact: "Kontakt hinzuf√ºgen",
                save_all: "Alle speichern",
                qr_title: "Notfallkarte und QR-Code",
                copy: "Kopieren",
                open: "√ñffnen",
                download_png: "PNG herunterladen",
                download_svg: "SVG herunterladen",
                print: "Drucken",
                delete_title: "‚ö†Ô∏è Konto l√∂schen",
                delete_warning: "Diese Aktion kann nicht r√ºckg√§ngig gemacht werden. Alle Ihre medizinischen Notfalldaten, QR-Codes und Profilinformationen werden dauerhaft von unseren Servern gel√∂scht.",
                delete_confirm_label: "Geben Sie \"DELETE MY ACCOUNT\" zur Best√§tigung ein:",
                delete_account: "Mein Konto l√∂schen",
                copyright: "¬© 2024 MYQER. Alle Rechte vorbehalten.",
                privacy_policy: "Datenschutzrichtlinie",
                terms_of_service: "Nutzungsbedingungen",
                support: "Support",
                saving: "Speichern...",
                session_expiring: "Sitzung l√§uft ab",
                session_expire_text: "Ihre Sitzung l√§uft ab in",
                seconds: "Sekunden aufgrund von Inaktivit√§t.",
                stay_logged_in: "Angemeldet bleiben",
                contact_name: "Name",
                contact_relationship: "Beziehung",
                contact_phone: "Telefon",
                remove: "Entfernen",
                no_contacts: "Noch keine Notfallkontakte hinzugef√ºgt. Klicken Sie auf \"Kontakt hinzuf√ºgen\", um zu beginnen."
            },
            it: {
                offline_mode: "Sei offline. Le modifiche si sincronizzeranno quando la connessione sar√† ripristinata.",
                logout: "Disconnetti",
                identity_title: "Identit√† ‚Äî Informazioni Personali",
                save: "Salva",
                full_name: "Nome Completo",
                date_of_birth: "Data di Nascita",
                country: "Paese",
                health_id: "ID Nazionale/Sanitario (Opzionale)",
                critical_title: "CRITICO ‚Äî Dettagli Medici e Sanitari",
                auto: "Auto",
                green: "Verde",
                amber: "Ambra",
                red: "Rosso",
                black: "Nero",
                blood_type: "Gruppo Sanguigno",
                allergies: "Allergie Critiche",
                conditions: "Condizioni Mediche",
                medications: "Farmaci Attuali",
                implants: "Impianti/Dispositivi Medici",
                organ_donor: "Sono un donatore di organi",
                ice_title: "Contatti di Emergenza (ICE)",
                add_contact: "Aggiungi Contatto",
                save_all: "Salva Tutto",
                qr_title: "Carta di Emergenza e Codice QR",
                copy: "Copia",
                open: "Apri",
                download_png: "Scarica PNG",
                download_svg: "Scarica SVG",
                print: "Stampa",
                delete_title: "‚ö†Ô∏è Elimina Account",
                delete_warning: "Questa azione non pu√≤ essere annullata. Tutti i tuoi dati medici di emergenza, codici QR e informazioni del profilo saranno eliminati permanentemente dai nostri server.",
                delete_confirm_label: "Digita \"DELETE MY ACCOUNT\" per confermare:",
                delete_account: "Elimina Il Mio Account",
                copyright: "¬© 2024 MYQER. Tutti i diritti riservati.",
                privacy_policy: "Politica sulla Privacy",
                terms_of_service: "Termini di Servizio",
                support: "Supporto",
                saving: "Salvando...",
                session_expiring: "Sessione in Scadenza",
                session_expire_text: "La tua sessione scadr√† tra",
                seconds: "secondi a causa dell'inattivit√†.",
                stay_logged_in: "Rimani Connesso",
                contact_name: "Nome",
                contact_relationship: "Relazione",
                contact_phone: "Telefono",
                remove: "Rimuovi",
                no_contacts: "Nessun contatto di emergenza aggiunto ancora. Clicca \"Aggiungi Contatto\" per iniziare."
            },
            pt: {
                offline_mode: "Voc√™ est√° offline. As altera√ß√µes ser√£o sincronizadas quando a conex√£o for restaurada.",
                logout: "Sair",
                identity_title: "Identidade ‚Äî Informa√ß√µes Pessoais",
                save: "Salvar",
                full_name: "Nome Completo",
                date_of_birth: "Data de Nascimento",
                country: "Pa√≠s",
                health_id: "ID Nacional/Sa√∫de (Opcional)",
                critical_title: "CR√çTICO ‚Äî Detalhes M√©dicos e de Sa√∫de",
                auto: "Auto",
                green: "Verde",
                amber: "√Çmbar",
                red: "Vermelho",
                black: "Preto",
                blood_type: "Tipo Sangu√≠neo",
                allergies: "Alergias Cr√≠ticas",
                conditions: "Condi√ß√µes M√©dicas",
                medications: "Medicamentos Atuais",
                implants: "Implantes/Dispositivos M√©dicos",
                organ_donor: "Sou doador de √≥rg√£os",
                ice_title: "Contatos de Emerg√™ncia (ICE)",
                add_contact: "Adicionar Contato",
                save_all: "Salvar Tudo",
                qr_title: "Cart√£o de Emerg√™ncia e C√≥digo QR",
                copy: "Copiar",
                open: "Abrir",
                download_png: "Baixar PNG",
                download_svg: "Baixar SVG",
                print: "Imprimir",
                delete_title: "‚ö†Ô∏è Excluir Conta",
                delete_warning: "Esta a√ß√£o n√£o pode ser desfeita. Todos os seus dados m√©dicos de emerg√™ncia, c√≥digos QR e informa√ß√µes de perfil ser√£o permanentemente exclu√≠dos de nossos servidores.",
                delete_confirm_label: "Digite \"DELETE MY ACCOUNT\" para confirmar:",
                delete_account: "Excluir Minha Conta",
                copyright: "¬© 2024 MYQER. Todos os direitos reservados.",
                privacy_policy: "Pol√≠tica de Privacidade",
                terms_of_service: "Termos de Servi√ßo",
                support: "Suporte",
                saving: "Salvando...",
                session_expiring: "Sess√£o Expirando",
                session_expire_text: "Sua sess√£o expirar√° em",
                seconds: "segundos devido √† inatividade.",
                stay_logged_in: "Permanecer Conectado",
                contact_name: "Nome",
                contact_relationship: "Relacionamento",
                contact_phone: "Telefone",
                remove: "Remover",
                no_contacts: "Nenhum contato de emerg√™ncia adicionado ainda. Clique em \"Adicionar Contato\" para come√ßar."
            },
            ro: {
                offline_mode: "E»ôti offline. ModificƒÉrile se vor sincroniza c√¢nd conexiunea va fi restabilitƒÉ.",
                logout: "Deconectare",
                identity_title: "Identitate ‚Äî Informa»õii Personale",
                save: "SalveazƒÉ",
                full_name: "Nume Complet",
                date_of_birth: "Data Na»ôterii",
                country: "»öarƒÉ",
                health_id: "ID Na»õional/SƒÉnƒÉtate (Op»õional)",
                critical_title: "CRITIC ‚Äî Detalii Medicale »ôi de SƒÉnƒÉtate",
                auto: "Auto",
                green: "Verde",
                amber: "Chihlimbar",
                red: "Ro»ôu",
                black: "Negru",
                blood_type: "Grupa SanguinƒÉ",
                allergies: "Alergii Critice",
                conditions: "Condi»õii Medicale",
                medications: "Medicamentele Actuale",
                implants: "Implanturi/Dispozitive Medicale",
                organ_donor: "Sunt donator de organe",
                ice_title: "Contacte de Urgen»õƒÉ (ICE)",
                add_contact: "AdaugƒÉ Contact",
                save_all: "SalveazƒÉ Tot",
                qr_title: "Card de Urgen»õƒÉ »ôi Cod QR",
                copy: "CopiazƒÉ",
                open: "Deschide",
                download_png: "DescarcƒÉ PNG",
                download_svg: "DescarcƒÉ SVG",
                print: "TipƒÉre»ôte",
                delete_title: "‚ö†Ô∏è »òterge Contul",
                delete_warning: "AceastƒÉ ac»õiune nu poate fi anulatƒÉ. Toate datele dvs. medicale de urgen»õƒÉ, codurile QR »ôi informa»õiile de profil vor fi »ôterse permanent de pe serverele noastre.",
                delete_confirm_label: "Tasta»õi \"DELETE MY ACCOUNT\" pentru a confirma:",
                delete_account: "»òterge Contul Meu",
                copyright: "¬© 2024 MYQER. Toate drepturile rezervate.",
                privacy_policy: "Politica de Confiden»õialitate",
                terms_of_service: "Termenii de Serviciu",
                support: "Suport",
                saving: "Se salveazƒÉ...",
                session_expiring: "Sesiunea ExpirƒÉ",
                session_expire_text: "Sesiunea dvs. va expira √Æn",
                seconds: "secunde din cauza inactivitƒÉ»õii.",
                stay_logged_in: "RƒÉm√¢i Conectat",
                contact_name: "Nume",
                contact_relationship: "Rela»õia",
                contact_phone: "Telefon",
                remove: "EliminƒÉ",
                no_contacts: "Nu au fost adƒÉugate √ÆncƒÉ contacte de urgen»õƒÉ. Face»õi clic pe \"AdaugƒÉ Contact\" pentru a √Æncepe."
            },
            ar: {
                offline_mode: "ÿ£ŸÜÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ. ÿ≥ÿ™ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿπŸÜÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ.",
                logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                identity_title: "ÿßŸÑŸáŸàŸäÿ© ‚Äî ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©",
                save: "ÿ≠ŸÅÿ∏",
                full_name: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",
                date_of_birth: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                country: "ÿßŸÑÿ®ŸÑÿØ",
                health_id: "ÿßŸÑŸáŸàŸäÿ© ÿßŸÑŸàÿ∑ŸÜŸäÿ©/ÿßŸÑÿµÿ≠Ÿäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
                critical_title: "ÿ≠ÿ±ÿ¨ ‚Äî ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ÿ®Ÿäÿ© ŸàÿßŸÑÿµÿ≠Ÿäÿ©",
                auto: "ÿ™ŸÑŸÇÿßÿ¶Ÿä",
                green: "ÿ£ÿÆÿ∂ÿ±",
                amber: "ŸÉŸáÿ±ŸÖÿßŸÜŸä",
                red: "ÿ£ÿ≠ŸÖÿ±",
                black: "ÿ£ÿ≥ŸàÿØ",
                blood_type: "ŸÅÿµŸäŸÑÿ© ÿßŸÑÿØŸÖ",
                allergies: "ÿßŸÑÿ≠ÿ≥ÿßÿ≥Ÿäÿßÿ™ ÿßŸÑÿ≠ÿ±ÿ¨ÿ©",
                conditions: "ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ∑ÿ®Ÿäÿ©",
                medications: "ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©",
                implants: "ÿßŸÑÿ≤ÿ±ÿßÿπÿßÿ™/ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©",
                organ_donor: "ÿ£ŸÜÿß ŸÖÿ™ÿ®ÿ±ÿπ ÿ®ÿßŸÑÿ£ÿπÿ∂ÿßÿ°",
                ice_title: "ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ∑ÿßÿ±ÿ¶ÿ© (ICE)",
                add_contact: "ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ",
                save_all: "ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸÑ",
                qr_title: "ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ Ÿàÿ±ŸÖÿ≤ QR",
                copy: "ŸÜÿ≥ÿÆ",
                open: "ŸÅÿ™ÿ≠",
                download_png: "ÿ™ÿ≠ŸÖŸäŸÑ PNG",
                download_svg: "ÿ™ÿ≠ŸÖŸäŸÑ SVG",
                print: "ÿ∑ÿ®ÿßÿπÿ©",
                delete_title: "‚ö†Ô∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
                delete_warning: "ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°. ÿ≥ÿ™ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿßŸÑÿ∑ÿ®Ÿäÿ© Ÿàÿ±ŸÖŸàÿ≤ QR ŸàŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ŸÜŸáÿßÿ¶ŸäÿßŸã ŸÖŸÜ ÿÆŸàÿßÿØŸÖŸÜÿß.",
                delete_confirm_label: "ÿßŸÉÿ™ÿ® \"DELETE MY ACCOUNT\" ŸÑŸÑÿ™ÿ£ŸÉŸäÿØ:",
                delete_account: "ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®Ÿä",
                copyright: "¬© 2024 MYQER. ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©.",
                privacy_policy: "ÿ≥Ÿäÿßÿ≥ÿ© ÿßŸÑÿÆÿµŸàÿµŸäÿ©",
                terms_of_service: "ÿ¥ÿ±Ÿàÿ∑ ÿßŸÑÿÆÿØŸÖÿ©",
                support: "ÿßŸÑÿØÿπŸÖ",
                saving: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...",
                session_expiring: "ÿßŸÜÿ™Ÿáÿßÿ° ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ©",
                session_expire_text: "ÿ≥ÿ™ŸÜÿ™ŸáŸä ÿµŸÑÿßÿ≠Ÿäÿ© ÿ¨ŸÑÿ≥ÿ™ŸÉ ÿÆŸÑÿßŸÑ",
                seconds: "ÿ´ÿßŸÜŸäÿ© ÿ®ÿ≥ÿ®ÿ® ÿπÿØŸÖ ÿßŸÑŸÜÿ¥ÿßÿ∑.",
                stay_logged_in: "ÿßŸÑÿ®ŸÇÿßÿ° ŸÖÿ™ÿµŸÑÿßŸã",
                contact_name: "ÿßŸÑÿßÿ≥ŸÖ",
                contact_relationship: "ÿßŸÑÿπŸÑÿßŸÇÿ©",
                contact_phone: "ÿßŸÑŸáÿßÿ™ŸÅ",
                remove: "ÿ•ÿ≤ÿßŸÑÿ©",
                no_contacts: "ŸÑŸÖ ÿ™ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿßÿ™ ÿßÿ™ÿµÿßŸÑ ÿ∑ÿßÿ±ÿ¶ÿ© ÿ®ÿπÿØ. ÿßŸÜŸÇÿ± ÿπŸÑŸâ \"ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ\" ŸÑŸÑÿ®ÿØÿ°."
            },
            hi: {
                offline_mode: "‡§Ü‡§™ ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§π‡•à‡§Ç‡•§ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§¨‡§π‡§æ‡§≤ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§∏‡§ø‡§Ç‡§ï ‡§π‡•ã ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§",
                logout: "‡§≤‡•â‡§ó‡§Ü‡§â‡§ü",
                identity_title: "‡§™‡§π‡§ö‡§æ‡§® ‚Äî ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä",
                save: "‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç",
                full_name: "‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ",
                date_of_birth: "‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø",
                country: "‡§¶‡•á‡§∂",
                health_id: "‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Ø/‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§Ü‡§à‡§°‡•Ä (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)",
                critical_title: "‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‚Äî ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§î‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£",
                auto: "‡§ë‡§ü‡•ã",
                green: "‡§π‡§∞‡§æ",
                amber: "‡§è‡§Æ‡•ç‡§¨‡§∞",
                red: "‡§≤‡§æ‡§≤",
                black: "‡§ï‡§æ‡§≤‡§æ",
                blood_type: "‡§∞‡§ï‡•ç‡§§ ‡§∏‡§Æ‡•Ç‡§π",
                allergies: "‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä",
                conditions: "‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡§æ‡§Ç",
                medications: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¶‡§µ‡§æ‡§è‡§Ç",
                implants: "‡§á‡§Æ‡•ç‡§™‡•ç‡§≤‡§æ‡§Ç‡§ü/‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§â‡§™‡§ï‡§∞‡§£",
                organ_donor: "‡§Æ‡•à‡§Ç ‡§Ö‡§Ç‡§ó ‡§¶‡§æ‡§§‡§æ ‡§π‡•Ç‡§Ç",
                ice_title: "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï (ICE)",
                add_contact: "‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
                save_all: "‡§∏‡§≠‡•Ä ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç",
                qr_title: "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§ï‡§æ‡§∞‡•ç‡§° ‡§î‡§∞ QR ‡§ï‡•ã‡§°",
                copy: "‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç",
                open: "‡§ñ‡•ã‡§≤‡•á‡§Ç",
                download_png: "PNG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
                download_svg: "SVG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
                print: "‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç",
                delete_title: "‚ö†Ô∏è ‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Ç",
                delete_warning: "‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡§≠‡•Ä ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§°‡•á‡§ü‡§æ, QR ‡§ï‡•ã‡§° ‡§î‡§∞ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§π‡§Æ‡§æ‡§∞‡•á ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§",
                delete_confirm_label: "‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è \"DELETE MY ACCOUNT\" ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç:",
                delete_account: "‡§Æ‡•á‡§∞‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Ç",
                copyright: "¬© 2024 MYQER‡•§ ‡§∏‡§≠‡•Ä ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§‡•§",
                privacy_policy: "‡§ó‡•ã‡§™‡§®‡•Ä‡§Ø‡§§‡§æ ‡§®‡•Ä‡§§‡§ø",
                terms_of_service: "‡§∏‡•á‡§µ‡§æ ‡§ï‡•Ä ‡§∂‡§∞‡•ç‡§§‡•á‡§Ç",
                support: "‡§∏‡§π‡§æ‡§Ø‡§§‡§æ",
                saving: "‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...",
                session_expiring: "‡§∏‡§§‡•ç‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à",
                session_expire_text: "‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø‡§§‡§æ ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡§§‡•ç‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ",
                seconds: "‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç‡•§",
                stay_logged_in: "‡§≤‡•â‡§ó ‡§á‡§® ‡§∞‡§π‡•á‡§Ç",
                contact_name: "‡§®‡§æ‡§Æ",
                contact_relationship: "‡§∞‡§ø‡§∂‡•ç‡§§‡§æ",
                contact_phone: "‡§´‡•ã‡§®",
                remove: "‡§π‡§ü‡§æ‡§è‡§Ç",
                no_contacts: "‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ú‡•ã‡§°‡§º‡•á ‡§ó‡§è‡•§ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è \"‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç\" ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§"
            },
            zh: {
                offline_mode: "ÊÇ®Â§Ñ‰∫éÁ¶ªÁ∫øÁä∂ÊÄÅ„ÄÇËøûÊé•ÊÅ¢Â§çÂêéÊõ¥ÊîπÂ∞ÜÂêåÊ≠•„ÄÇ",
                logout: "ÁôªÂá∫",
                identity_title: "Ë∫´‰ªΩ ‚Äî ‰∏™‰∫∫‰ø°ÊÅØ",
                save: "‰øùÂ≠ò",
                full_name: "ÂÖ®Âêç",
                date_of_birth: "Âá∫ÁîüÊó•Êúü",
                country: "ÂõΩÂÆ∂",
                health_id: "ÂõΩÊ∞ë/ÂÅ•Â∫∑IDÔºàÂèØÈÄâÔºâ",
                critical_title: "Á¥ßÊÄ• ‚Äî ÂåªÁñóÂíåÂÅ•Â∫∑ËØ¶ÊÉÖ",
                auto: "Ëá™Âä®",
                green: "ÁªøËâ≤",
                amber: "Áê•ÁèÄËâ≤",
                red: "Á∫¢Ëâ≤",
                black: "ÈªëËâ≤",
                blood_type: "Ë°ÄÂûã",
                allergies: "‰∏•ÈáçËøáÊïè",
                conditions: "ÂåªÁñóÁä∂ÂÜµ",
                medications: "ÂΩìÂâçËçØÁâ©",
                implants: "Ê§çÂÖ•Áâ©/ÂåªÁñóËÆæÂ§á",
                organ_donor: "ÊàëÊòØÂô®ÂÆòÊçêÁåÆËÄÖ",
                ice_title: "Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ÔºàICEÔºâ",
                add_contact: "Ê∑ªÂä†ËÅîÁ≥ª‰∫∫",
                save_all: "ÂÖ®ÈÉ®‰øùÂ≠ò",
                qr_title: "Á¥ßÊÄ•Âç°ÁâáÂíå‰∫åÁª¥Á†Å",
                copy: "Â§çÂà∂",
                open: "ÊâìÂºÄ",
                download_png: "‰∏ãËΩΩPNG",
                download_svg: "‰∏ãËΩΩSVG",
                print: "ÊâìÂç∞",
                delete_title: "‚ö†Ô∏è Âà†Èô§Ë¥¶Êà∑",
                delete_warning: "Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇÊÇ®ÁöÑÊâÄÊúâÁ¥ßÊÄ•ÂåªÁñóÊï∞ÊçÆ„ÄÅ‰∫åÁª¥Á†ÅÂíå‰∏™‰∫∫ËµÑÊñô‰ø°ÊÅØÂ∞Ü‰ªéÊàë‰ª¨ÁöÑÊúçÂä°Âô®‰∏≠Ê∞∏‰πÖÂà†Èô§„ÄÇ",
                delete_confirm_label: "ËæìÂÖ•\"DELETE MY ACCOUNT\"Á°ÆËÆ§Ôºö",
                delete_account: "Âà†Èô§ÊàëÁöÑË¥¶Êà∑",
                copyright: "¬© 2024 MYQER„ÄÇ‰øùÁïôÊâÄÊúâÊùÉÂà©„ÄÇ",
                privacy_policy: "ÈöêÁßÅÊîøÁ≠ñ",
                terms_of_service: "ÊúçÂä°Êù°Ê¨æ",
                support: "ÊîØÊåÅ",
                saving: "‰øùÂ≠ò‰∏≠...",
                session_expiring: "‰ºöËØùÂç≥Â∞ÜËøáÊúü",
                session_expire_text: "Áî±‰∫é‰∏çÊ¥ªÂä®ÔºåÊÇ®ÁöÑ‰ºöËØùÂ∞ÜÂú®",
                seconds: "ÁßíÂêéËøáÊúü„ÄÇ",
                stay_logged_in: "‰øùÊåÅÁôªÂΩï",
                contact_name: "ÂßìÂêç",
                contact_relationship: "ÂÖ≥Á≥ª",
                contact_phone: "ÁîµËØù",
                remove: "ÁßªÈô§",
                no_contacts: "Â∞öÊú™Ê∑ªÂä†Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫„ÄÇÁÇπÂáª\"Ê∑ªÂä†ËÅîÁ≥ª‰∫∫\"ÂºÄÂßã„ÄÇ"
            }
        };

        const LIFE_THREATENING_CONDITIONS = [
            'heart attack', 'cardiac arrest', 'stroke', 'anaphylaxis', 'severe asthma', 'diabetes type 1',
            'epilepsy', 'seizure', 'hemophilia', 'severe allergy', 'pacemaker', 'defibrillator',
            'insulin dependent', 'blood clotting disorder', 'severe bleeding disorder', 'aneurysm',
            'heart failure', 'arrhythmia', 'atrial fibrillation', 'ventricular tachycardia',
            'myocardial infarction', 'angina', 'coronary artery disease', 'pulmonary embolism',
            'deep vein thrombosis', 'aortic stenosis', 'mitral valve prolapse', 'cardiomyopathy',
            'heart disease', 'cardiac', 'coronary', 'myocardial', 'ventricular', 'atrial'
        ];

        const LIFE_THREATENING_ALLERGIES = [
            'penicillin', 'shellfish', 'nuts', 'peanuts', 'bee sting', 'wasp sting', 'latex',
            'contrast dye', 'iodine', 'aspirin', 'nsaid', 'sulfa', 'eggs', 'milk', 'soy',
            'anaphylactic', 'severe allergy', 'epipen', 'epinephrine'
        ];

        const CRITICAL_IMPLANTS = [
            'pacemaker', 'defibrillator', 'insulin pump', 'cochlear implant', 'neurostimulator',
            'heart valve', 'stent', 'artificial heart', 'ventricular assist device', 'icd'
        ];

        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                setupOnlineDetection();
                
                const savedLanguage = localStorage.getItem('myqer_language') || 'en';
                changeLanguage(savedLanguage);
                
                await loadProfile();
                await loadHealth();
                await loadICE();
                
                setupAutosave();
                setupIdleTimer();
                await generateQR();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to load dashboard', 'error');
            }
        }

        function setupOnlineDetection() {
            function updateOnlineStatus() {
                isOnline = navigator.onLine;
                const banner = document.getElementById('offlineBanner');
                
                if (isOnline) {
                    banner.classList.remove('show');
                    syncPendingChanges();
                } else {
                    banner.classList.add('show');
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        async function syncPendingChanges() {
            try {
                const profileData = localStorage.getItem('myqer_profile_pending');
                if (profileData) {
                    const data = JSON.parse(profileData);
                    await supabase.from('profiles').upsert(data);
                    localStorage.removeItem('myqer_profile_pending');
                }
                
                const healthData = localStorage.getItem('myqer_health_pending');
                if (healthData) {
                    const data = JSON.parse(healthData);
                    await supabase.from('health_data').upsert(data);
                    localStorage.removeItem('myqer_health_pending');
                }
                
                const iceData = localStorage.getItem('myqer_ice_pending');
                if (iceData) {
                    const data = JSON.parse(iceData);
                    await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
                    if (data.length > 0) {
                        await supabase.from('ice_contacts').insert(data);
                    }
                    localStorage.removeItem('myqer_ice_pending');
                }
                
                showToast('Changes synced successfully', 'success');
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('show');
            
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.language-selector')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('myqer_language', lang);
            
            const flags = {
                en: 'üá∫üá∏ EN',
                es: 'üá™üá∏ ES',
                fr: 'üá´üá∑ FR',
                de: 'üá©üá™ DE',
                it: 'üáÆüáπ IT',
                pt: 'üáµüáπ PT',
                ro: 'üá∑üá¥ RO',
                ar: 'üá∏üá¶ AR',
                hi: 'üáÆüá≥ HI',
                zh: 'üá®üá≥ ZH'
            };
            
            document.getElementById('currentLanguage').textContent = flags[lang];
            
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[onclick="changeLanguage('${lang}')"]`).classList.add('active');
            
            document.getElementById('languageDropdown').classList.remove('show');
            
            applyTranslations();
        }

        function applyTranslations() {
            const t = translations[currentLanguage];
            
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
        }

        function setupAutosave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const section = getInputSection(input.id);
                    if (section) {
                        debounceAutosave(section);
                    }
                });
            });
        }

        function getInputSection(inputId) {
            const profileInputs = ['fullName', 'dob', 'country', 'healthId'];
            const healthInputs = ['bloodType', 'allergies', 'conditions', 'medications', 'implants', 'organDonor', 'triageOverride'];
            
            if (profileInputs.includes(inputId)) return 'profile';
            if (healthInputs.includes(inputId)) return 'health';
            return null;
        }

        function debounceAutosave(section) {
            if (debounceTimers[section]) {
                clearTimeout(debounceTimers[section]);
            }
            
            debounceTimers[section] = setTimeout(() => {
                if (section === 'profile') saveProfile(true);
                else if (section === 'health') saveHealth(true);
            }, 1000);
        }

        function showSavingIndicator() {
            const indicator = document.getElementById('savingIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        async function loadProfile() {
            try {
                const cached = localStorage.getItem('myqer_profile');
                if (cached) {
                    const data = JSON.parse(cached);
                    fillProfileForm(data);
                }
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    
                    if (data) {
                        fillProfileForm(data);
                        localStorage.setItem('myqer_profile', JSON.stringify(data));
                        userCode = data.code;
                    }
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        function fillProfileForm(data) {
            if (data.full_name) document.getElementById('fullName').value = data.full_name;
            if (data.dob) document.getElementById('dob').value = data.dob;
            if (data.country) document.getElementById('country').value = data.country;
            if (data.health_id) document.getElementById('healthId').value = data.health_id;
            userCode = data.code;
        }

        async function loadHealth() {
            try {
                const cached = localStorage.getItem('myqer_health');
                if (cached) {
                    const data = JSON.parse(cached);
                    fillHealthForm(data);
                }
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('health_data')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    
                    if (data) {
                        fillHealthForm(data);
                        localStorage.setItem('myqer_health', JSON.stringify(data));
                    }
                }
                
                updateTriage();
            } catch (error) {
                console.error('Load health error:', error);
            }
        }

        function fillHealthForm(data) {
            if (data.blood_type) document.getElementById('bloodType').value = data.blood_type;
            if (data.allergies) document.getElementById('allergies').value = data.allergies;
            if (data.conditions) document.getElementById('conditions').value = data.conditions;
            if (data.medications) document.getElementById('medications').value = data.medications;
            if (data.implants) document.getElementById('implants').value = data.implants;
            if (data.donor !== undefined) document.getElementById('organDonor').checked = data.donor;
            if (data.triage_override) document.getElementById('triageOverride').value = data.triage_override;
        }

        async function loadICE() {
            try {
                const cached = localStorage.getItem('myqer_ice');
                if (cached) {
                    iceContacts = JSON.parse(cached);
                    renderICE();
                }
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('ice_contacts')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('contact_order');
                    
                    if (error) throw error;
                    
                    iceContacts = data || [];
                    localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                    renderICE();
                }
            } catch (error) {
                console.error('Load ICE error:', error);
            }
        }

        async function generateCode() {
            if (userCode) return userCode;
            
            const cached = localStorage.getItem('myqer_profile');
            if (cached) {
                const data = JSON.parse(cached);
                if (data.code) {
                    userCode = data.code;
                    return data.code;
                }
            }
            
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                if (i === 4) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            userCode = code;
            return code;
        }

        async function saveProfile(isAutosave = false) {
            try {
                const code = await generateCode();
                const profileData = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value || null,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value || null,
                    health_id: document.getElementById('healthId').value || null,
                    code: code
                };
                
                localStorage.setItem('myqer_profile', JSON.stringify(profileData));
                
                if (isAutosave) {
                    showSavingIndicator();
                }
                
                if (isOnline) {
                    const { error } = await supabase
                        .from('profiles')
                        .upsert(profileData);
                    
                    if (error) throw error;
                    
                    localStorage.removeItem('myqer_profile_pending');
                } else {
                    localStorage.setItem('myqer_profile_pending', JSON.stringify(profileData));
                }
                
                if (!isAutosave) {
                    showToast('Profile saved successfully', 'success');
                }
                
                await generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save profile error:', error);
                if (!isAutosave) {
                    showToast('Failed to save profile', 'error');
                }
                
                if (!isOnline) {
                    const code = await generateCode();
                    const profileData = {
                        id: currentUser.id,
                        full_name: document.getElementById('fullName').value || null,
                        dob: document.getElementById('dob').value || null,
                        country: document.getElementById('country').value || null,
                        health_id: document.getElementById('healthId').value || null,
                        code: code
                    };
                    localStorage.setItem('myqer_profile_pending', JSON.stringify(profileData));
                }
            }
        }

        async function saveHealth(isAutosave = false) {
            try {
                const healthData = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value || null,
                    allergies: document.getElementById('allergies').value || null,
                    conditions: document.getElementById('conditions').value || null,
                    medications: document.getElementById('medications').value || null,
                    implants: document.getElementById('implants').value || null,
                    donor: document.getElementById('organDonor').checked,
                    triage_override: document.getElementById('triageOverride').value
                };
                
                localStorage.setItem('myqer_health', JSON.stringify(healthData));
                
                if (isAutosave) {
                    showSavingIndicator();
                }
                
                if (isOnline) {
                    const { error } = await supabase
                        .from('health_data')
                        .upsert(healthData);
                    
                    if (error) throw error;
                    
                    localStorage.removeItem('myqer_health_pending');
                } else {
                    localStorage.setItem('myqer_health_pending', JSON.stringify(healthData));
                }
                
                if (!isAutosave) {
                    showToast('Health data saved successfully', 'success');
                }
                
                updateTriage();
                await generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save health error:', error);
                if (!isAutosave) {
                    showToast('Failed to save health data', 'error');
                }
                
                if (!isOnline) {
                    const healthData = {
                        user_id: currentUser.id,
                        blood_type: document.getElementById('bloodType').value || null,
                        allergies: document.getElementById('allergies').value || null,
                        conditions: document.getElementById('conditions').value || null,
                        medications: document.getElementById('medications').value || null,
                        implants: document.getElementById('implants').value || null,
                        donor: document.getElementById('organDonor').checked,
                        triage_override: document.getElementById('triageOverride').value
                    };
                    localStorage.setItem('myqer_health_pending', JSON.stringify(healthData));
                }
            }
        }

        function updateTriage() {
            const override = document.getElementById('triageOverride').value;
            const pill = document.getElementById('triagePill');
            const pillText = pill.querySelector('span:last-child');
            
            if (override !== 'auto') {
                pill.className = `triage-pill triage-${override}`;
                pillText.textContent = translations[currentLanguage][override];
                return;
            }
            
            const allergies = document.getElementById('allergies').value.toLowerCase();
            const conditions = document.getElementById('conditions').value.toLowerCase();
            const implants = document.getElementById('implants').value.toLowerCase();
            
            let isLifeThreatening = false;
            
            LIFE_THREATENING_ALLERGIES.forEach(allergy => {
                if (allergies.includes(allergy)) {
                    isLifeThreatening = true;
                }
            });
            
            LIFE_THREATENING_CONDITIONS.forEach(condition => {
                if (conditions.includes(condition)) {
                    isLifeThreatening = true;
                }
            });
            
            CRITICAL_IMPLANTS.forEach(implant => {
                if (implants.includes(implant)) {
                    isLifeThreatening = true;
                }
            });
            
            if (isLifeThreatening) {
                pill.className = 'triage-pill triage-red';
                pillText.textContent = translations[currentLanguage]['red'];
            } else if (allergies || conditions || implants) {
                pill.className = 'triage-pill triage-amber';
                pillText.textContent = translations[currentLanguage]['amber'];
            } else {
                pill.className = 'triage-pill triage-green';
                pillText.textContent = translations[currentLanguage]['green'];
            }
        }

        function addContact() {
            if (iceContacts.length >= 3) {
                showToast('Maximum 3 emergency contacts allowed', 'error');
                return;
            }
            
            const newContact = {
                id: Date.now().toString(),
                name: '',
                relationship: '',
                phone: '',
                contact_order: iceContacts.length
            };
            
            iceContacts.push(newContact);
            renderICE();
        }

        function removeContact(id) {
            iceContacts = iceContacts.filter(contact => contact.id !== id);
            iceContacts.forEach((contact, index) => {
                contact.contact_order = index;
            });
            renderICE();
        }

        function renderICE() {
            const container = document.getElementById('iceContacts');
            
            if (iceContacts.length === 0) {
                container.innerHTML = '<div class="no-contacts" data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>';
                applyTranslations();
                return;
            }
            
            container.innerHTML = iceContacts.map(contact => `
                <div class="ice-contact">
                    <div class="ice-header">
                        <h4 class="ice-title">Emergency Contact ${contact.contact_order + 1}</h4>
                        <button class="btn btn-danger" onclick="removeContact('${contact.id}')" data-i18n="remove">Remove</button>
                    </div>
                    <div class="ice-grid">
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_name">Name</label>
                            <input type="text" class="form-input" value="${contact.name}" 
                                   onchange="updateContact('${contact.id}', 'name', this.value)"
                                   placeholder="Full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_relationship">Relationship</label>
                            <input type="text" class="form-input" value="${contact.relationship}" 
                                   onchange="updateContact('${contact.id}', 'relationship', this.value)"
                                   placeholder="e.g., Spouse, Parent">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="contact_phone">Phone</label>
                            <input type="tel" class="form-input" value="${contact.phone}" 
                                   onchange="updateContact('${contact.id}', 'phone', this.value)"
                                   placeholder="+1 (555) 123-4567">
                        </div>
                    </div>
                </div>
            `).join('');
            
            applyTranslations();
        }

        function updateContact(id, field, value) {
            const contact = iceContacts.find(c => c.id === id);
            if (contact) {
                contact[field] = value;
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                generateQR();
            }
        }

        async function saveICE() {
            try {
                const iceData = iceContacts.map(contact => ({
                    user_id: currentUser.id,
                    name: contact.name || null,
                    relationship: contact.relationship || null,
                    phone: contact.phone || null,
                    contact_order: contact.contact_order
                }));
                
                localStorage.setItem('myqer_ice', JSON.stringify(iceContacts));
                
                if (isOnline) {
                    await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
                    
                    if (iceData.length > 0) {
                        const { error } = await supabase.from('ice_contacts').insert(iceData);
                        if (error) throw error;
                    }
                    
                    localStorage.removeItem('myqer_ice_pending');
                } else {
                    localStorage.setItem('myqer_ice_pending', JSON.stringify(iceData));
                }
                
                showToast('Emergency contacts saved successfully', 'success');
                await generateQR();
                saveSnapshot();
                
            } catch (error) {
                console.error('Save ICE error:', error);
                showToast('Failed to save emergency contacts', 'error');
                
                if (!isOnline) {
                    const iceData = iceContacts.map(contact => ({
                        user_id: currentUser.id,
                        name: contact.name || null,
                        relationship: contact.relationship || null,
                        phone: contact.phone || null,
                        contact_order: contact.contact_order
                    }));
                    localStorage.setItem('myqer_ice_pending', JSON.stringify(iceData));
                }
            }
        }

        async function generateQR() {
            if (isGeneratingQR) return;
            isGeneratingQR = true;
            
            try {
                const code = await generateCode();
                document.getElementById('qrCode').textContent = code;
                
                const url = `https://www.myqer.com/c/${code}`;
                document.getElementById('cardUrl').value = url;
                
                const offlineData = createOfflinePayload();
                
                const canvas = document.getElementById('qrCanvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                await QRCode.toCanvas(canvas, offlineData, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#0f172a',
                        light: '#ffffff'
                    }
                });
                
            } catch (error) {
                console.error('QR generation error:', error);
            } finally {
                isGeneratingQR = false;
            }
        }

        function createOfflinePayload() {
            const profile = JSON.parse(localStorage.getItem('myqer_profile') || '{}');
            const health = JSON.parse(localStorage.getItem('myqer_health') || '{}');
            const ice = JSON.parse(localStorage.getItem('myqer_ice') || '[]');
            
            let payload = `MYQER EMERGENCY CARD\n`;
            payload += `Code: ${userCode || 'XXXX-XXXX'}\n`;
            payload += `URL: https://www.myqer.com/c/${userCode || 'XXXX-XXXX'}\n\n`;
            
            if (profile.full_name) payload += `Name: ${profile.full_name}\n`;
            if (profile.dob) payload += `DOB: ${profile.dob}\n`;
            if (health.blood_type) payload += `Blood: ${health.blood_type}\n`;
            if (health.allergies) payload += `Allergies: ${health.allergies}\n`;
            if (health.conditions) payload += `Conditions: ${health.conditions}\n`;
            if (health.medications) payload += `Medications: ${health.medications}\n`;
            if (health.implants) payload += `Implants: ${health.implants}\n`;
            if (health.donor) payload += `Organ Donor: Yes\n`;
            
            ice.slice(0, 3).forEach((contact, i) => {
                if (contact.name && contact.phone) {
                    payload += `ICE${i + 1}: ${contact.name} (${contact.relationship || 'Contact'}) ${contact.phone}\n`;
                }
            });
            
            if (payload.length > 900) {
                payload = payload.substring(0, 897) + '...';
            }
            
            return payload;
        }

        function copyUrl() {
            const urlInput = document.getElementById('cardUrl');
            urlInput.select();
            document.execCommand('copy');
            showToast('URL copied to clipboard', 'success');
        }

        function openUrl() {
            const url = document.getElementById('cardUrl').value;
            window.open(url, '_blank');
        }

        async function downloadQR(format) {
            try {
                const canvas = document.getElementById('qrCanvas');
                
                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = `myqer-${userCode || 'emergency'}-card.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else if (format === 'svg') {
                    const offlineData = createOfflinePayload();
                    const svg = await QRCode.toString(offlineData, { type: 'svg' });
                    const blob = new Blob([svg], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `myqer-${userCode || 'emergency'}-card.svg`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }
                
                showToast(`QR code downloaded as ${format.toUpperCase()}`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download QR code', 'error');
            }
        }

        function printQR() {
            const canvas = document.getElementById('qrCanvas');
            const code = document.getElementById('qrCode').textContent;
            const url = document.getElementById('cardUrl').value;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>MYQER Emergency Card - ${code}</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 40px; }
                        .card { border: 2px solid #dc2626; border-radius: 16px; padding: 40px; max-width: 400px; margin: 0 auto; }
                        .logo { font-size: 24px; font-weight: bold; color: #dc2626; margin-bottom: 20px; }
                        .code { font-family: monospace; font-size: 20px; font-weight: bold; margin: 20px 0; }
                        .url { font-size: 12px; color: #666; word-break: break-all; margin-top: 20px; }
                        .qr { margin: 20px 0; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <div class="logo">MYQER‚Ñ¢ EMERGENCY CARD</div>
                        <div class="qr">
                            <img src="${canvas.toDataURL()}" alt="QR Code" style="width: 200px; height: 200px;">
                        </div>
                        <div class="code">${code}</div>
                        <div class="url">${url}</div>
                        <p style="font-size: 12px; color: #666; margin-top: 30px;">
                            Scan QR code or visit URL for emergency medical information
                        </p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function saveSnapshot() {
            try {
                if (!isOnline) return;
                
                const profile = JSON.parse(localStorage.getItem('myqer_profile') || '{}');
                const health = JSON.parse(localStorage.getItem('myqer_health') || '{}');
                const ice = JSON.parse(localStorage.getItem('myqer_ice') || '[]');
                
                const snapshot = {
                    user_id: currentUser.id,
                    profile_data: profile,
                    health_data: health,
                    ice_contacts: ice,
                    created_at: new Date().toISOString()
                };
                
                await supabase.from('profile_snapshots').insert(snapshot);
            } catch (error) {
                console.error('Snapshot save error:', error);
            }
        }

        function setupIdleTimer() {
            const IDLE_TIME = 30 * 60 * 1000;
            const WARNING_TIME = 60 * 1000;
            
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                clearTimeout(warningTimer);
                clearInterval(countdownTimer);
                document.getElementById('idleModal').classList.remove('show');
                
                idleTimer = setTimeout(() => {
                    showIdleWarning();
                }, IDLE_TIME - WARNING_TIME);
            }
            
            function showIdleWarning() {
                document.getElementById('idleModal').classList.add('show');
                countdownSeconds = 60;
                document.getElementById('countdown').textContent = countdownSeconds;
                
                countdownTimer = setInterval(() => {
                    countdownSeconds--;
                    document.getElementById('countdown').textContent = countdownSeconds;
                    
                    if (countdownSeconds <= 0) {
                        logout();
                    }
                }, 1000);
                
                warningTimer = setTimeout(() => {
                    logout();
                }, WARNING_TIME);
            }
            
            window.resetIdleTimer = resetIdleTimer;
            
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetIdleTimer, true);
            });
            
            resetIdleTimer();
        }

        async function deleteAccount() {
            const confirmText = document.getElementById('deleteConfirm').value;
            
            if (confirmText !== 'DELETE MY ACCOUNT') {
                showToast('Please type "DELETE MY ACCOUNT" exactly to confirm', 'error');
                return;
            }
            
            try {
                if (isOnline) {
                    await supabase.from('profiles').delete().eq('id', currentUser.id);
                    await supabase.from('health_data').delete().eq('user_id', currentUser.id);
                    await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
                    await supabase.from('profile_snapshots').delete().eq('user_id', currentUser.id);
                }
                
                localStorage.clear();
                showToast('Account deleted successfully', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Delete account error:', error);
                showToast('Failed to delete account', 'error');
            }
        }

        async function logout() {
            try {
                if (isOnline && supabase) {
                    await supabase.auth.signOut();
                }
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'index.html';
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b0325b25fb940d',t:'MTc1NzE4NTA5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
