<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER Dashboard v9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
            background-attachment: fixed;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(198, 40, 40, 0.02) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(17, 17, 17, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .premium-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.08),
                0 8px 16px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            aspect-ratio: 1;
            height: 100%;
        }
        
        .premium-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 40px 80px rgba(0, 0, 0, 0.12),
                0 12px 24px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .card-ribbon {
            position: absolute;
            top: 0;
            left: 0;
            padding: 8px 16px;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: white;
            border-radius: 0 0 12px 0;
            z-index: 10;
        }
        
        .ribbon-identity { background: linear-gradient(135deg, #10b981, #059669); }
        .ribbon-qr { background: linear-gradient(135deg, #C62828, #b71c1c); }
        .ribbon-health { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .ribbon-danger { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        
        .card-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 1.5rem;
            opacity: 0.6;
            z-index: 5;
        }
        
        .premium-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(229, 231, 235, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
        }
        
        .premium-input:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #C62828;
            box-shadow: 0 0 0 4px rgba(198, 40, 40, 0.1);
            outline: none;
            transform: translateY(-1px);
        }
        
        .premium-btn {
            background: linear-gradient(135deg, #C62828, #b71c1c);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
        }
        
        .premium-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(198, 40, 40, 0.4);
        }
        
        .premium-btn:active {
            transform: translateY(0);
        }
        
        .danger-btn {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .danger-btn:hover {
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }
        
        .save-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
        
        .qr-placeholder {
            width: 160px;
            height: 160px;
            background: rgba(248, 250, 252, 0.8);
            border: 2px dashed rgba(198, 40, 40, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        
        .qr-display {
            width: 160px;
            height: 160px;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 auto;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .emergency-link {
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid rgba(229, 231, 235, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.8rem;
            color: #374151;
            text-align: center;
        }
        
        .triage-pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .triage-green { background: rgba(16, 185, 129, 0.1); color: #059669; }
        .triage-amber { background: rgba(245, 158, 11, 0.1); color: #d97706; }
        .triage-red { background: rgba(220, 38, 38, 0.1); color: #dc2626; }
        .triage-black { background: rgba(107, 114, 128, 0.1); color: #374151; }
        
        .floating-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            max-width: 1000px;
            margin: 0 auto;
            aspect-ratio: 1;
        }
        
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
                aspect-ratio: auto;
            }
            .premium-card {
                aspect-ratio: auto;
                min-height: 400px;
            }
        }
        
        .card-content {
            padding: 20px;
            padding-top: 48px;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .field-group {
            margin-bottom: 12px;
        }
        
        .field-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 6px;
        }
        
        .card-subtitle {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .warning-icon {
            color: #dc2626;
            font-size: 1.1rem;
            margin-right: 6px;
        }
        
        .auto-save-notice {
            font-size: 0.7rem;
            color: #6b7280;
            text-align: center;
            margin-top: auto;
            font-style: italic;
            padding-top: 12px;
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 231, 235, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #10b981;
            color: #059669;
        }

        .toast.error {
            border-left: 4px solid #dc2626;
            color: #b91c1c;
        }

        /* Compact input styles for square cards */
        .compact-input {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        .compact-btn {
            padding: 10px 16px;
            font-size: 0.85rem;
        }

        .grid-2-cols {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 4px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 2px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Premium Header -->
    <header class="floating-header sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <div class="flex items-center">
                        <h1 class="text-3xl font-black">
                            <span class="text-black">MYQ</span><span class="text-red-600">ER</span>
                        </h1>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 italic font-medium">pronounced "my care"</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <!-- Language Selector -->
                    <select id="language-selector" class="premium-input text-sm">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="it">üáÆüáπ Italiano</option>
                        <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                        <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="hu">üá≠üá∫ Magyar</option>
                        <option value="ro">üá∑üá¥ Rom√¢nƒÉ</option>
                    </select>
                    <button onclick="signOut()" class="bg-gray-900 text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition-colors font-medium text-sm">
                        <span data-translate="sign_out">Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto px-6 py-12">
        <div class="grid-container">
            
            <!-- Card 1: Identity & Personal Info -->
            <div class="premium-card" id="identityCard">
                <div class="card-ribbon ribbon-identity">Identity</div>
                <div class="card-icon">üßë</div>
                <div class="card-content">
                    <h2 class="card-title">Personal Information</h2>
                    <p class="card-subtitle">These details confirm who you are in an emergency.</p>
                    
                    <div class="scrollable-content">
                        <div class="space-y-3">
                            <div class="field-group">
                                <label class="field-label" for="i_name">Full Name</label>
                                <input type="text" id="i_name" class="premium-input compact-input w-full" placeholder="Enter your full name">
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="i_dob">Date of Birth</label>
                                <input type="date" id="i_dob" class="premium-input compact-input w-full">
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="i_country">Country</label>
                                <select id="i_country" class="premium-input compact-input w-full">
                                    <option value="">Select Country</option>
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                    <option value="DE">Germany</option>
                                    <option value="FR">France</option>
                                    <option value="IT">Italy</option>
                                    <option value="ES">Spain</option>
                                    <option value="NL">Netherlands</option>
                                    <option value="SE">Sweden</option>
                                    <option value="NO">Norway</option>
                                    <option value="DK">Denmark</option>
                                    <option value="FI">Finland</option>
                                    <option value="JP">Japan</option>
                                    <option value="KR">South Korea</option>
                                    <option value="SG">Singapore</option>
                                    <option value="NZ">New Zealand</option>
                                </select>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="i_nhid">National Health ID</label>
                                <input type="text" id="i_nhid" class="premium-input compact-input w-full" placeholder="Enter health ID number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="save-indicator" id="identity-save">
                        ‚úì Saved
                    </div>
                </div>
            </div>

            <!-- Card 2: Health Profile -->
            <div class="premium-card" id="healthCard">
                <div class="card-ribbon ribbon-health">Health</div>
                <div class="card-icon">‚ù§Ô∏è</div>
                <div class="card-content">
                    <h2 class="card-title">Health Profile</h2>
                    <p class="card-subtitle">Critical medical information for responders.</p>
                    
                    <div class="scrollable-content">
                        <div class="space-y-3">
                            <div class="grid-2-cols">
                                <div class="field-group">
                                    <label class="field-label" for="h_bt">Blood Type</label>
                                    <select id="h_bt" class="premium-input compact-input w-full">
                                        <option value="">Select</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                    </select>
                                </div>
                                
                                <div class="field-group">
                                    <label class="field-label" for="h_donor">Organ Donor</label>
                                    <select id="h_donor" class="premium-input compact-input w-full">
                                        <option value="">Unspecified</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="h_life">Life Support Preference</label>
                                <select id="h_life" class="premium-input compact-input w-full">
                                    <option value="">Select Preference</option>
                                    <option value="Full">Full Support</option>
                                    <option value="Limited">Limited Support</option>
                                    <option value="Comfort">Comfort Care Only</option>
                                    <option value="DNR">Do Not Resuscitate</option>
                                </select>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="h_all">Allergies</label>
                                <input type="text" id="h_all" class="premium-input compact-input w-full" placeholder="List allergies (comma separated)">
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="h_cond">Medical Conditions</label>
                                <input type="text" id="h_cond" class="premium-input compact-input w-full" placeholder="List conditions (comma separated)">
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="h_meds">Medications</label>
                                <input type="text" id="h_meds" class="premium-input compact-input w-full" placeholder="List medications (comma separated)">
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label" for="h_impl">Implants</label>
                                <input type="text" id="h_impl" class="premium-input compact-input w-full" placeholder="Pacemaker, metal implants, etc.">
                            </div>
                            
                            <div class="grid-2-cols">
                                <div class="field-group">
                                    <label class="field-label" for="h_bur">Burial Preference</label>
                                    <select id="h_bur" class="premium-input compact-input w-full">
                                        <option value="">Unspecified</option>
                                        <option value="Burial">Burial</option>
                                        <option value="Cremation">Cremation</option>
                                        <option value="Donation">Body Donation</option>
                                    </select>
                                </div>
                                
                                <div class="field-group">
                                    <label class="field-label" for="h_rel">Religion</label>
                                    <input type="text" id="h_rel" class="premium-input compact-input w-full" placeholder="Religious preference">
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <div id="triage-pill" class="triage-pill triage-green">
                                <span class="w-2 h-2 rounded-full bg-current mr-2"></span>
                                Priority: Green
                            </div>
                        </div>
                    </div>
                    
                    <div class="auto-save-notice">
                        Updates are saved instantly.
                    </div>
                </div>
            </div>

            <!-- Card 3: Emergency QR Code -->
            <div class="premium-card">
                <div class="card-ribbon ribbon-qr">QR Code</div>
                <div class="card-icon">üî≥</div>
                <div class="card-content text-center">
                    <h2 class="card-title">Emergency QR Code</h2>
                    <p class="card-subtitle">Scan for instant emergency access.</p>
                    
                    <div class="scrollable-content">
                        <div class="mb-4">
                            <div id="qr-placeholder" class="qr-placeholder">
                                <div class="text-center">
                                    <div class="text-3xl mb-2 opacity-40">üì±</div>
                                    <p class="text-xs text-gray-500 font-medium">No QR code generated</p>
                                </div>
                            </div>
                            
                            <div id="qr-display" class="qr-display hidden">
                                <canvas id="qr-canvas" width="160" height="160"></canvas>
                            </div>
                        </div>
                        
                        <div id="qr-link-section" class="hidden mb-3">
                            <div class="emergency-link text-xs" id="emergency-link">
                                www.myqer.com/c/xxxxxx
                            </div>
                        </div>
                        
                        <button onclick="generateQRCode()" id="generate-btn" class="premium-btn compact-btn w-full">
                            Generate Emergency Code
                        </button>
                        
                        <div id="qr-actions" class="hidden mt-3 flex gap-2">
                            <button onclick="copyLink()" class="premium-btn compact-btn flex-1 text-xs">Copy</button>
                            <button onclick="printQR()" class="premium-btn compact-btn flex-1 text-xs">Print</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 4: Delete & Danger Zone -->
            <div class="premium-card">
                <div class="card-ribbon ribbon-danger">Danger Zone</div>
                <div class="card-icon">‚ö†Ô∏è</div>
                <div class="card-content text-center">
                    <h2 class="card-title text-red-600">Delete Account</h2>
                    <p class="card-subtitle">This action cannot be undone.</p>
                    
                    <div class="scrollable-content">
                        <div class="warning-box">
                            <div class="flex items-start">
                                <span class="warning-icon">‚ö†Ô∏è</span>
                                <div class="text-left">
                                    <p class="font-semibold text-red-800 mb-1 text-sm">Permanent Deletion</p>
                                    <p class="text-xs text-red-700 leading-relaxed">
                                        This will permanently delete your profile & emergency card. 
                                        All data will be lost and cannot be recovered.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="deleteAccount()" class="danger-btn compact-btn w-full">
                            Delete Account
                        </button>
                        
                        <p class="text-xs text-gray-500 mt-3">
                            Secured with double confirmation.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global Supabase client and profile cache
        const sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Cache of profile/health
        let profile = null, health = null;
        let currentUser = null;
        let currentLanguage = 'en';

        // Enhanced Translations
        const translations = {
            en: {
                sign_out: "Sign Out"
            },
            es: {
                sign_out: "Cerrar Sesi√≥n"
            },
            fr: {
                sign_out: "Se D√©connecter"
            },
            de: {
                sign_out: "Abmelden"
            },
            it: {
                sign_out: "Disconnetti"
            },
            hi: {
                sign_out: "‡§∏‡§æ‡§á‡§® ‡§Ü‡§â‡§ü"
            },
            ar: {
                sign_out: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨"
            },
            zh: {
                sign_out: "ÈÄÄÂá∫ÁôªÂΩï"
            },
            hu: {
                sign_out: "Kijelentkez√©s"
            },
            ro: {
                sign_out: "Deconectare"
            }
        };

        // Load both records once at startup (and anytime after save)
        async function loadAll() {
            try {
                const { data: p } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
                const { data: h } = await sb.from('health_profiles').select('*').eq('user_id', currentUser.id).single();
                profile = p || { id: currentUser.id };
                health = h || {};
                
                // Populate form fields
                if (profile) {
                    document.getElementById('i_name').value = profile.full_name || '';
                    document.getElementById('i_dob').value = profile.date_of_birth || '';
                    document.getElementById('i_country').value = profile.country || '';
                    document.getElementById('i_nhid').value = profile.health_id || '';
                    
                    if (profile.code) {
                        showExistingQR(profile.code);
                    }
                }
                
                if (health) {
                    document.getElementById('h_bt').value = health.blood_type || '';
                    document.getElementById('h_donor').value = health.organ_donor ? 'Yes' : (health.organ_donor === false ? 'No' : '');
                    document.getElementById('h_life').value = health.life_support_pref || '';
                    document.getElementById('h_all').value = health.allergies || '';
                    document.getElementById('h_cond').value = health.conditions || '';
                    document.getElementById('h_meds').value = health.meds || '';
                    document.getElementById('h_impl').value = health.implants || '';
                    document.getElementById('h_bur').value = health.burial_pref || '';
                    document.getElementById('h_rel').value = health.religion_pref || '';
                }
                
                renderTriagePill();
            } catch (error) {
                console.error('Error loading profile data:', error);
                profile = { id: currentUser.id };
                health = {};
            }
        }

        // Generate or reuse a code, then save & render QR
        async function ensureCode() {
            if (profile?.code && profile.code.length > 10) return profile.code;
            const code = (crypto.randomUUID().replace(/-/g,'') + crypto.randomUUID().replace(/-/g,'')).slice(0,32);
            const { data, error } = await sb.from('profiles').upsert({ 
                id: currentUser.id, 
                email: currentUser.email,
                code,
                updated_at: new Date().toISOString()
            }).select().single();
            if (error) throw error;
            profile = data;
            return code;
        }

        async function renderQR() {
            const canvas = document.getElementById('qr-canvas');
            const linkEl = document.getElementById('emergency-link');
            if (!canvas || !linkEl) return;

            // Guard against library not ready
            if (typeof QRCode === 'undefined' || !QRCode.toCanvas) {
                toast('QR library not loaded', 'error');
                return;
            }

            const code = await ensureCode();
            const cardUrl = `https://www.myqer.com/c/${code}`;
            linkEl.textContent = `www.myqer.com/c/${code.slice(0,8)}...`;

            // Generate branded QR
            await QRCode.toCanvas(canvas, cardUrl, {
                margin: 1,
                width: 160,
                color: {
                    dark: '#C62828',    // MYQER red modules
                    light: '#FFFFFF00', // transparent background
                },
                errorCorrectionLevel: 'H'
            });

            // Draw tiny center badge
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff'; 
            ctx.strokeStyle = '#C62828';
            ctx.lineWidth = 2;
            ctx.beginPath(); 
            ctx.roundRect(68, 68, 24, 24, 6); 
            ctx.fill(); 
            ctx.stroke();
            ctx.fillStyle = '#C62828';
            ctx.font = '700 7px system-ui, -apple-system, Segoe UI';
            ctx.textAlign = 'center'; 
            ctx.textBaseline = 'middle';
            ctx.fillText('ER', 80, 80);

            // Show QR code
            document.getElementById('qr-placeholder').classList.add('hidden');
            document.getElementById('qr-display').classList.remove('hidden');
            document.getElementById('qr-link-section').classList.remove('hidden');
            document.getElementById('qr-actions').classList.remove('hidden');
            document.getElementById('generate-btn').textContent = 'Regenerate Code';
        }

        function showExistingQR(code) {
            const cardUrl = `https://www.myqer.com/c/${code}`;
            const canvas = document.getElementById('qr-canvas');
            const linkEl = document.getElementById('emergency-link');
            
            linkEl.textContent = `www.myqer.com/c/${code.slice(0,8)}...`;
            
            QRCode.toCanvas(canvas, cardUrl, {
                margin: 1,
                width: 160,
                color: {
                    dark: '#C62828',
                    light: '#FFFFFF00',
                },
                errorCorrectionLevel: 'H'
            }, (error) => {
                if (!error) {
                    // Draw center badge
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#fff'; 
                    ctx.strokeStyle = '#C62828';
                    ctx.lineWidth = 2;
                    ctx.beginPath(); 
                    ctx.roundRect(68, 68, 24, 24, 6); 
                    ctx.fill(); 
                    ctx.stroke();
                    ctx.fillStyle = '#C62828';
                    ctx.font = '700 7px system-ui, -apple-system, Segoe UI';
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ER', 80, 80);
                    
                    // Show QR code
                    document.getElementById('qr-placeholder').classList.add('hidden');
                    document.getElementById('qr-display').classList.remove('hidden');
                    document.getElementById('qr-link-section').classList.remove('hidden');
                    document.getElementById('qr-actions').classList.remove('hidden');
                    document.getElementById('generate-btn').textContent = 'Regenerate Code';
                }
            });
        }

        // Shared debounce function
        function debounce(fn, t=500){ 
            let id; 
            return (...a)=>{ 
                clearTimeout(id); 
                id=setTimeout(()=>fn(...a),t); 
            }; 
        }

        // Toast system
        function toast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showSaveIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            }
        }

        // Triage calculation and rendering
        function renderTriagePill() {
            const lifePref = document.getElementById('h_life').value;
            const allergies = document.getElementById('h_all').value;
            const conditions = document.getElementById('h_cond').value;
            const meds = document.getElementById('h_meds').value;
            
            let priority = 'Green';
            let className = 'triage-green';
            
            if (lifePref === 'DNR') {
                priority = 'Black';
                className = 'triage-black';
            } else {
                const criticalAllergies = ['anaphylaxis', 'epipen', 'penicillin', 'peanut', 'shellfish'];
                const criticalConditions = ['heart', 'stroke', 'seizure', 'cancer', 'diabetes'];
                
                const hasCriticalAllergy = criticalAllergies.some(ca => 
                    allergies.toLowerCase().includes(ca)
                );
                const hasCriticalCondition = criticalConditions.some(cc => 
                    conditions.toLowerCase().includes(cc)
                );
                const hasMultipleMeds = meds.split(',').filter(m => m.trim()).length >= 3;
                
                if (hasCriticalAllergy || hasCriticalCondition) {
                    priority = 'Red';
                    className = 'triage-red';
                } else if (allergies || conditions || hasMultipleMeds) {
                    priority = 'Amber';
                    className = 'triage-amber';
                }
            }
            
            const pill = document.getElementById('triage-pill');
            pill.className = `triage-pill ${className}`;
            pill.innerHTML = `<span class="w-2 h-2 rounded-full bg-current mr-2"></span>Priority: ${priority}`;
        }

        // Session Management
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                location.href = '/index.html';
                return;
            }
            currentUser = session.user;
            await loadAll();
        }

        async function signOut() {
            try { 
                await sb.auth.signOut(); 
                location.replace('/'); 
            } catch(_) {
                location.href = '/index.html';
            }
        }

        // QR Code Functions
        async function generateQRCode() {
            try {
                await renderQR();
                toast('Emergency QR Code generated successfully!');
            } catch (error) {
                toast('Failed to generate QR code: ' + error.message, 'error');
                console.error('QR Generation Error:', error);
            }
        }

        function copyLink() {
            const code = profile?.code;
            if (!code) {
                toast('No QR code to copy', 'error');
                return;
            }
            
            const url = `https://www.myqer.com/c/${code}`;
            navigator.clipboard.writeText(url).then(() => {
                toast('Emergency link copied to clipboard!');
            }).catch(() => {
                toast('Failed to copy link', 'error');
            });
        }

        function printQR() {
            const canvas = document.getElementById('qr-canvas');
            const code = profile?.code;
            
            if (!canvas || !code) {
                toast('No QR code to print', 'error');
                return;
            }
            
            const fullName = document.getElementById('i_name').value || 'Name Not Set';
            const dob = document.getElementById('i_dob').value || 'DOB Not Set';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>MYQER‚Ñ¢ Emergency Medical Card</title>
                        <style>
                            @page { margin: 0.5in; }
                            body { 
                                text-align: center; 
                                padding: 20px; 
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
                                background: #f8fafc; 
                                margin: 0;
                            }
                            .card { 
                                background: white; 
                                padding: 30px; 
                                border-radius: 20px; 
                                box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
                                max-width: 400px; 
                                margin: 0 auto;
                                border: 3px solid #C62828;
                            }
                            .header { 
                                margin-bottom: 20px; 
                                border-bottom: 2px solid #C62828; 
                                padding-bottom: 15px;
                            }
                            h1 { 
                                color: #000; 
                                margin: 0; 
                                font-weight: 900; 
                                font-size: 2.5rem; 
                            }
                            .er { color: #C62828; }
                            .subtitle { 
                                color: #6b7280; 
                                font-size: 0.9rem; 
                                font-style: italic; 
                                margin-top: 5px;
                            }
                            .patient-info {
                                background: #f9fafb;
                                padding: 15px;
                                border-radius: 10px;
                                margin: 20px 0;
                                text-align: left;
                            }
                            .patient-info h3 {
                                margin: 0 0 10px 0;
                                color: #374151;
                                font-size: 1.1rem;
                            }
                            .patient-info p {
                                margin: 5px 0;
                                color: #6b7280;
                                font-size: 0.9rem;
                            }
                            img { 
                                max-width: 200px; 
                                border: 3px solid #C62828; 
                                border-radius: 12px; 
                                margin: 15px 0; 
                            }
                            .emergency { 
                                background: #fef2f2; 
                                padding: 15px; 
                                border-radius: 10px; 
                                margin: 15px 0; 
                                border: 2px solid #fecaca; 
                            }
                            .footer {
                                margin-top: 20px;
                                padding-top: 15px;
                                border-top: 1px solid #e5e7eb;
                                font-size: 0.8rem;
                                color: #9ca3af;
                            }
                            .code {
                                font-family: 'Courier New', monospace;
                                background: #f3f4f6;
                                padding: 8px 12px;
                                border-radius: 6px;
                                font-weight: bold;
                                color: #374151;
                                margin: 10px 0;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="card">
                            <div class="header">
                                <h1>MYQ<span class="er">ER</span>‚Ñ¢</h1>
                                <div class="subtitle">Emergency Medical Profile</div>
                            </div>
                            
                            <div class="patient-info">
                                <h3>Patient Information</h3>
                                <p><strong>Name:</strong> ${fullName}</p>
                                <p><strong>DOB:</strong> ${dob}</p>
                                <div class="code">Code: MYQER-${code.slice(0,8)}</div>
                            </div>
                            
                            <img src="${canvas.toDataURL()}" alt="MYQER Emergency QR Code">
                            
                            <div class="emergency">
                                <p><strong>üì± SCAN FOR EMERGENCY ACCESS</strong></p>
                                <p>This QR code provides immediate access to critical medical information for emergency responders.</p>
                            </div>
                            
                            <div class="footer">
                                <p>MYQER‚Ñ¢ Emergency Medical System</p>
                                <p>GDPR & HIPAA Compliant ‚Ä¢ Emergency Access Only</p>
                                <p>Generated: ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            toast('Emergency medical card ready to print!');
        }

        // Delete Account
        async function deleteAccount() {
            const confirmation = prompt('Type "DELETE" to confirm account deletion:');
            if (confirmation !== 'DELETE') {
                toast('Account deletion cancelled', 'error');
                return;
            }

            try {
                // Delete in order: health_profiles, profiles
                await sb.from('health_profiles').delete().eq('user_id', currentUser.id);
                await sb.from('profiles').delete().eq('id', currentUser.id);
                
                await sb.auth.signOut();
                toast('Account deleted successfully');
                setTimeout(() => location.href = '/index.html', 2000);
            } catch (error) {
                toast('Failed to delete account: ' + error.message, 'error');
            }
        }

        // Language Management
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('myqer_language', lang);
            
            // Set RTL for Arabic
            if (lang === 'ar') {
                document.documentElement.setAttribute('dir', 'rtl');
                document.documentElement.setAttribute('lang', 'ar');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
                document.documentElement.setAttribute('lang', lang);
            }
            
            // Update all translatable elements
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved language
            const savedLanguage = localStorage.getItem('myqer_language') || 'en';
            document.getElementById('language-selector').value = savedLanguage;
            changeLanguage(savedLanguage);
            
            checkSession();

            // Language selector
            document.getElementById('language-selector').addEventListener('change', (e) => {
                changeLanguage(e.target.value);
            });

            // Identity auto-save with debounce
            document.getElementById('identityCard')?.addEventListener('focusout', debounce(async ()=>{
                const full_name = document.getElementById('i_name')?.value?.trim() || '';
                const dob = document.getElementById('i_dob')?.value || null;
                const country = document.getElementById('i_country')?.value || '';
                const health_id = document.getElementById('i_nhid')?.value?.trim() || '';
                
                const { data, error } = await sb.from('profiles').upsert({ 
                    id: profile.id, 
                    email: currentUser.email,
                    full_name, 
                    date_of_birth: dob, 
                    country, 
                    health_id,
                    updated_at: new Date().toISOString()
                }).select().single();
                
                if (!error) { 
                    profile = data; 
                    toast('Identity saved');
                    showSaveIndicator('identity-save');
                } else {
                    toast('Failed to save identity', 'error');
                }
            }, 600));

            // Health auto-save with debounce
            document.getElementById('healthCard')?.addEventListener('focusout', debounce(async ()=>{
                const body = {
                    user_id: profile.id,
                    blood_type: document.getElementById('h_bt')?.value || null,
                    organ_donor: (document.getElementById('h_donor')?.value||'') === 'Yes',
                    life_support_pref: document.getElementById('h_life')?.value || '',
                    allergies: document.getElementById('h_all')?.value || '',
                    conditions: document.getElementById('h_cond')?.value || '',
                    meds: document.getElementById('h_meds')?.value || '',
                    implants: document.getElementById('h_impl')?.value || '',
                    burial_pref: document.getElementById('h_bur')?.value || '',
                    religion_pref: document.getElementById('h_rel')?.value || ''
                };
                
                const { data, error } = await sb.from('health_profiles').upsert(body).select().single();
                if (!error) { 
                    health = data; 
                    renderTriagePill(); 
                    toast('Health saved'); 
                } else {
                    toast('Failed to save health profile', 'error');
                }
            }, 700));

            // Real-time triage updates
            ['h_life', 'h_all', 'h_cond', 'h_meds'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', debounce(renderTriagePill, 300));
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97889e0d20ca63c1',t:'MTc1Njc3MDA3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
