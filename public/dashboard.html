<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYQER ‚Äî Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QRCode.js (UMD, works everywhere) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- Supabase UMD v2 (no ESM headaches) -->
  <script src="https://esm.sh/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --brand:#c62828;        /* MYQER red */
      --ink:#0f172a;          /* slate-900 */
      --muted:#64748b;        /* slate-500 */
      --ring:rgba(198,40,40,.14);
      --stroke:rgba(15,23,42,.08);
      --shadow:0 18px 42px rgba(2,8,23,.12), 0 2px 6px rgba(2,8,23,.06);
      --rad:16px;
    }
    body{background:linear-gradient(135deg,#f8fafc 0%,#eef2f7 100%);color:var(--ink)}
    .glass{background:rgba(255,255,255,.7);backdrop-filter:blur(14px);border:1px solid var(--stroke)}
    .card{background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border:1px solid var(--stroke);border-radius:var(--rad);box-shadow:var(--shadow)}
    .ribbon{position:relative;padding-top:14px}
    .ribbon::before{content:attr(data-title);position:absolute;top:0;left:-1px;font-weight:800;font-size:.78rem;letter-spacing:.02em;color:#fff;padding:.28rem .6rem;border-top-left-radius:10px;border-bottom-right-radius:10px}
    .r-green::before{background:#16a34a}
    .r-orange::before{background:#ea580c}
    .r-red::before{background:#ef4444}
    .r-purple::before{background:#7c3aed}
    .pill{border-radius:999px;border:1px solid var(--stroke);background:#fff;padding:.3rem .6rem;font-size:.75rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;font-weight:700}
    .btn-red{background:var(--brand);color:#fff}
    .btn-red:hover{filter:brightness(1.03)}
    .btn-outline{border:1px solid var(--brand);color:var(--brand);background:#fff}
    .kicker{font-size:.8rem;color:var(--muted)}
    .qr-ring{box-shadow:0 0 0 2px var(--brand), 0 8px 20px var(--ring);border-radius:14px}
    .legend-dot{width:.65rem;height:.65rem;border-radius:999px;display:inline-block;margin-right:.4rem}
    .spin{border:3px solid #e5e7eb;border-top-color:var(--brand);border-radius:999px;width:40px;height:40px;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .field{border:1px solid #e2e8f0;border-radius:10px;padding:.6rem .75rem;background:#fff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .muted{color:#64748b}
    .ghost{opacity:.55;pointer-events:none}
  </style>
</head>
<body class="min-h-screen">

  <!-- Top Bar -->
  <header class="glass sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="h-16 flex items-center justify-between gap-4">
        <a href="/" class="flex items-center gap-2 font-extrabold text-xl">
          MYQ<span class="text-[var(--brand)]">ER</span><sup class="text-xs ml-0.5">‚Ñ¢</sup>
          <span class="ml-3 kicker">(pronounced <em>‚Äúmy care‚Äù</em>)</span>
        </a>

        <div class="flex items-center gap-3">
          <!-- Language -->
          <select id="lang" class="border rounded-md px-3 py-1 text-sm">
            <option value="en">üá∫üá∏ EN</option><option value="es">üá™üá∏ ES</option>
            <option value="fr">üá´üá∑ FR</option><option value="de">üá©üá™ DE</option>
            <option value="it">üáÆüáπ IT</option><option value="pt">üáµüáπ PT</option>
            <option value="ro">üá∑üá¥ RO</option><option value="ar">üá∏üá¶ AR</option>
            <option value="hi">üáÆüá≥ HI</option><option value="zh">üá®üá≥ ‰∏≠Êñá</option>
          </select>
          <button id="logoutBtn" class="btn btn-outline px-4 py-2 text-sm">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading / Error -->
  <div id="loading" class="flex items-center justify-center min-height-[40vh] py-16">
    <div class="text-center space-y-3">
      <div class="spin mx-auto"></div>
      <p class="muted">Loading your dashboard‚Ä¶</p>
    </div>
  </div>

  <div id="errorBox" class="hidden max-w-3xl mx-auto mt-8 card p-5">
    <div class="text-red-600 font-bold mb-1">Something went wrong</div>
    <div id="errorMsg" class="text-sm text-slate-600"></div>
  </div>

  <!-- Dashboard -->
  <main id="dash" class="hidden pt-6 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- LEFT / CENTER -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Identity -->
        <section class="card p-6 ribbon r-green" data-title="Identity">
          <h2 class="text-xl font-extrabold mb-1" data-i18n="identityTitle">Identity ‚Äî Personal Information</h2>
          <p class="kicker mb-5" data-i18n="identityHint">These details help responders confirm who you are.</p>

          <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium" data-i18n="fullName">Full name</label>
              <input name="full_name" class="field w-full" autocomplete="name">
            </div>
            <div>
              <label class="text-sm font-medium" data-i18n="dob">Date of Birth</label>
              <input name="date_of_birth" type="date" class="field w-full" autocomplete="bday">
            </div>
            <div>
              <label class="text-sm font-medium" data-i18n="country">Country</label>
              <input name="country" class="field w-full" autocomplete="country-name">
            </div>
            <div>
              <label class="text-sm font-medium" data-i18n="healthId">Health ID (NHS/other)</label>
              <input name="health_id" class="field w-full" autocomplete="off">
            </div>
            <div class="md:col-span-2 flex items-center justify-between">
              <div>
                <span class="kicker" data-i18n="codeLabel">Your card code:</span>
                <code id="codeText" class="ml-2 px-2 py-1 rounded bg-slate-100 text-[.85rem] mono">‚Äî</code>
              </div>
              <div class="flex gap-2">
                <button type="button" id="genCode" class="btn px-3 py-2 border" data-i18n="genCode">Generate code</button>
                <button class="btn btn-red px-4 py-2" data-i18n="saveProfile">Save Profile</button>
              </div>
            </div>
          </form>
        </section>

        <!-- Health -->
        <section class="card p-6 ribbon r-red" data-title="Critical">
          <h2 class="text-xl font-extrabold mb-1" data-i18n="criticalTitle">CRITICAL ‚Äî Medical & Health Details</h2>
          <p class="kicker mb-5" data-i18n="criticalHint">Keep this current. It appears on your emergency card.</p>

          <form id="healthForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium" data-i18n="bloodType">Blood type</label>
              <select name="blood_type" class="field w-full">
                <option value="">‚Äî</option>
                <option>A+</option><option>A-</option>
                <option>B+</option><option>B-</option>
                <option>AB+</option><option>AB-</option>
                <option>O+</option><option>O-</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <input id="donor" type="checkbox" class="w-4 h-4">
              <label for="donor" class="text-sm font-medium" data-i18n="organDonor">Organ donor</label>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-medium" data-i18n="allergies">Critical allergies</label>
              <textarea name="allergies" rows="2" class="field w-full" placeholder="Penicillin, Nuts"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="text-sm font-medium" data-i18n="conditions">Conditions</label>
              <textarea name="conditions" rows="2" class="field w-full" placeholder="Diabetes, Asthma"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="text-sm font-medium" data-i18n="meds">Current medications</label>
              <textarea name="meds" rows="2" class="field w-full" placeholder="Metformin"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="text-sm font-medium" data-i18n="implants">Implants / devices</label>
              <textarea name="implants" rows="2" class="field w-full" placeholder="Pacemaker, Insulin pump"></textarea>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-medium" data-i18n="lifeSupport">Life support preference (informational)</label>
              <select name="life_support_pref" class="field w-full">
                <option value="">‚Äî</option>
                <option value="Full support" data-i18n="fullSupport">All resuscitation efforts (Full)</option>
                <option value="Comfort only" data-i18n="comfortOnly">Comfort-focused care only</option>
                <option value="DNR" data-i18n="dnr">Do not resuscitate (DNR)</option>
              </select>
              <p class="kicker mt-1" data-i18n="lifeSupportNote">These preferences are informational only. Clinicians must confirm with official documents.</p>
            </div>

            <div class="md:col-span-2 flex justify-end">
              <button class="btn btn-red px-4 py-2" data-i18n="saveHealth">Save Health</button>
            </div>
          </form>
        </section>

        <!-- ICE -->
        <section class="card p-6 ribbon r-orange" data-title="ICE">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-extrabold" data-i18n="iceTitle">Emergency Contacts (ICE)</h2>
            <button id="addIce" class="btn btn-outline px-3 py-2 text-sm" data-i18n="addContact">Add contact</button>
          </div>
          <p class="kicker mb-4" data-i18n="iceHint">Add up to 3 trusted contacts.</p>
          <div id="iceList" class="space-y-3"></div>
        </section>

        <!-- Delete -->
        <section class="card p-6 border-2 border-red-300">
          <h2 class="text-xl font-extrabold text-red-700 mb-2" data-i18n="deleteTitle">Delete account</h2>
          <p class="kicker mb-3" data-i18n="deleteWarning">Type <strong>DELETE MY ACCOUNT</strong> to enable. This is permanent.</p>
          <div class="flex flex-col sm:flex-row gap-3">
            <input id="deletePhrase" class="field flex-1" placeholder="DELETE MY ACCOUNT">
            <button id="deleteBtn" class="btn px-4 py-2 bg-red-600 text-white disabled:opacity-50" disabled data-i18n="deleteBtn">Delete my account</button>
          </div>
          <p id="deleteNote" class="kicker mt-2"></p>
        </section>
      </div>

      <!-- RIGHT -->
      <aside class="space-y-8">
        <!-- Triage -->
        <section class="card p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-extrabold" data-i18n="triageTitle">Emergency Triage Status</h3>
            <span id="triagePill" class="pill">‚Äî</span>
          </div>
          <p class="kicker mb-4" data-i18n="triageHint">Auto-computed from your data. You can override.</p>
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="text-sm font-medium" data-i18n="override">Manual override</label>
              <select id="triageOverride" class="field w-full">
                <option value="">Auto</option>
                <option value="green">Green</option>
                <option value="amber">Amber</option>
                <option value="red">Red</option>
                <option value="black">Black</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button id="speak" class="btn btn-outline px-3 py-2 text-sm" data-i18n="speak">üîà Speak summary</button>
              <button id="stopSpeak" class="btn px-3 py-2 border text-sm" data-i18n="stop">Stop</button>
            </div>
          </div>
        </section>

        <!-- QR -->
        <section class="card p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-extrabold" data-i18n="cardTitle">Emergency Card & QR</h3>
            <span class="kicker" id="qrStatus"></span>
          </div>

          <div class="grid grid-cols-1 gap-3">
            <div class="flex items-center justify-center">
              <div class="qr-ring bg-white p-3 rounded-xl">
                <div id="qrHost" class="w-[200px] h-[200px]"></div>
              </div>
            </div>

            <div class="text-center">
              <div class="text-xs text-slate-500 mb-1" data-i18n="scanTip">Scan for emergency access</div>
              <div class="mono text-sm" id="codeUnderQR">‚Äî</div>
            </div>

            <div>
              <label class="text-sm font-medium" data-i18n="cardLink">Card link</label>
              <div class="flex gap-2 mt-1">
                <input id="cardUrl" class="field flex-1" readonly>
                <button id="copyLink" class="btn btn-outline px-3 py-2 text-sm" data-i18n="copy">Copy</button>
              </div>
            </div>

            <div>
              <label class="text-sm font-medium">Offline text (encoded in the offline QR)</label>
              <textarea id="offlineText" class="field w-full mono" rows="4" readonly></textarea>
              <div class="kicker mt-1">Primary QR = short URL. Offline QR = this text payload for no-signal scenarios.</div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="dlPNG" class="btn px-2 py-2 border text-sm" data-i18n="png">Download PNG</button>
              <button id="dlSVG" class="btn px-2 py-2 border text-sm" data-i18n="svg">Download SVG</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <button id="toggleOfflineQR" class="btn px-2 py-2 border text-sm">Show Offline QR</button>
              <button id="printQR" class="btn px-2 py-2 border text-sm" data-i18n="print">Print Card</button>
            </div>

            <div id="offlineQRwrap" class="hidden">
              <hr class="my-2"/>
              <div class="text-sm font-semibold mb-1">Offline QR (text):</div>
              <div class="flex items-center justify-center">
                <div id="offlineQR" class="p-2 border rounded-lg bg-white"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Legend -->
        <section class="card p-6">
          <h3 class="text-lg font-extrabold mb-2" data-i18n="legend">Triage colours</h3>
          <ul class="space-y-1 text-sm">
            <li><span class="legend-dot" style="background:#16a34a"></span><strong>Green</strong> ‚Äî mild allergies, no major conditions.</li>
            <li><span class="legend-dot" style="background:#f59e0b"></span><strong>Amber</strong> ‚Äî stable chronic conditions.</li>
            <li><span class="legend-dot" style="background:#ef4444"></span><strong>Red</strong> ‚Äî severe allergies / life-threatening conditions.</li>
            <li><span class="legend-dot" style="background:#111827"></span><strong>Black</strong> ‚Äî DNR / Comfort care set.</li>
          </ul>
          <div class="mt-4 text-xs text-slate-500 space-y-2">
            <p data-i18n="infoOnly"><strong>Info only:</strong> This card supports care; clinicians must verify with official records.</p>
            <p data-i18n="privacyNote"><strong>Privacy:</strong> Your data stays on your device unless you share it. No ads, no trackers.</p>
            <p data-i18n="qrNote">Your QR code stays the same ‚Äî it always opens your latest information.</p>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-10 pb-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 text-center text-sm text-slate-500">
      ¬© <span id="year"></span> MYQER ‚Äî My QR for Emergency Response ¬∑ GDPR/HIPAA-minded ¬∑
      <a class="underline" href="/privacy.html">Privacy</a> ¬∑
      <a class="underline" href="/terms.html">Terms</a>
    </div>
  </footer>

  <!-- ============ APP LOGIC ============ -->
  <script>
    // ---- Config (NEW PROJECT) ----
    const MYQER = {
      SUPABASE_URL: 'https://dmntmhkncldgynufajei.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY',
      SHORT_BASE: 'https://www.myqer.com' // used in QR
    };

    // ---- i18n (UI labels only) ----
    const T = {
      en:{identityTitle:"Identity ‚Äî Personal Information",identityHint:"These details help responders confirm who you are.",
          fullName:"Full name",dob:"Date of Birth",country:"Country",healthId:"Health ID (NHS/other)",
          codeLabel:"Your card code:",genCode:"Generate code",saveProfile:"Save Profile",
          criticalTitle:"CRITICAL ‚Äî Medical & Health Details",criticalHint:"Keep this current. It appears on your emergency card.",
          bloodType:"Blood type",organDonor:"Organ donor",allergies:"Critical allergies",conditions:"Conditions",meds:"Current medications",implants:"Implants / devices",
          lifeSupport:"Life support preference (informational)",fullSupport:"All resuscitation efforts (Full)",comfortOnly:"Comfort-focused care only",dnr:"Do not resuscitate (DNR)",lifeSupportNote:"These preferences are informational only. Clinicians must confirm with official documents.",
          saveHealth:"Save Health",iceTitle:"Emergency Contacts (ICE)",iceHint:"Add up to 3 trusted contacts.",addContact:"Add contact",
          deleteTitle:"Delete account",deleteWarning:"Type DELETE MY ACCOUNT to enable. This is permanent.",deleteBtn:"Delete my account",
          triageTitle:"Emergency Triage Status",triageHint:"Auto-computed from your data. You can override.",override:"Manual override",speak:"Speak summary",stop:"Stop",
          cardTitle:"Emergency Card & QR",scanTip:"Scan for emergency access",cardLink:"Card link",copy:"Copy",png:"PNG",svg:"SVG",print:"Print",legend:"Triage colours",
          infoOnly:"Info only: This card supports care; clinicians must verify with official records.",
          privacyNote:"Privacy: Your data stays on your device unless you share it.",
          qrNote:"Your QR code stays the same ‚Äî it always opens your latest information."
      },
      es:{identityTitle:"Identidad ‚Äî Informaci√≥n Personal",identityHint:"Ayuda a confirmar tu identidad.",
          fullName:"Nombre completo",dob:"Fecha de nacimiento",country:"Pa√≠s",healthId:"ID de salud",
          codeLabel:"Tu c√≥digo:",genCode:"Generar c√≥digo",saveProfile:"Guardar perfil",
          criticalTitle:"CR√çTICO ‚Äî Detalles de Salud",criticalHint:"Mant√©n esto actualizado.",
          bloodType:"Grupo sangu√≠neo",organDonor:"Donante de √≥rganos",allergies:"Alergias cr√≠ticas",conditions:"Condiciones",meds:"Medicamentos",implants:"Implantes",
          lifeSupport:"Preferencia de soporte vital",fullSupport:"Esfuerzos completos",comfortOnly:"Solo confort",dnr:"No reanimar (DNR)",lifeSupportNote:"Informativo; verificar con documentos.",
          saveHealth:"Guardar salud",iceTitle:"Contactos de Emergencia (ICE)",iceHint:"Hasta 3 contactos.",addContact:"A√±adir contacto",
          deleteTitle:"Eliminar cuenta",deleteWarning:"Escribe DELETE MY ACCOUNT.",deleteBtn:"Eliminar mi cuenta",
          triageTitle:"Estado de Triaje",triageHint:"C√°lculo autom√°tico; puedes cambiarlo.",override:"Anulaci√≥n manual",speak:"Leer resumen",stop:"Detener",
          cardTitle:"Tarjeta & QR",scanTip:"Escanee para acceso",cardLink:"Enlace",copy:"Copiar",png:"PNG",svg:"SVG",print:"Imprimir",legend:"Colores de triaje",
          infoOnly:"Solo informativo.",privacyNote:"Privacidad: tus datos permanecen en tu dispositivo.",qrNote:"El QR no cambia."
      },
      fr:{identityTitle:"Identit√© ‚Äî Informations personnelles",identityHint:"Aide √† confirmer votre identit√©.",
          fullName:"Nom complet",dob:"Date de naissance",country:"Pays",healthId:"ID de sant√©",
          codeLabel:"Code de carte :",genCode:"G√©n√©rer le code",saveProfile:"Enregistrer le profil",
          criticalTitle:"CRITIQUE ‚Äî Informations m√©dicales",criticalHint:"√Ä jour = carte fiable.",
          bloodType:"Groupe sanguin",organDonor:"Donneur d'organes",allergies:"Allergies critiques",conditions:"Affections",meds:"M√©dicaments",implants:"Implants",
          lifeSupport:"Pr√©f√©rence de soins (info)",fullSupport:"Soutien complet",comfortOnly:"Confort uniquement",dnr:"DNR",lifeSupportNote:"Informationnel uniquement.",
          saveHealth:"Enregistrer",iceTitle:"Contacts d'urgence (ICE)",iceHint:"Jusqu'√† 3 contacts.",addContact:"Ajouter un contact",
          deleteTitle:"Supprimer le compte",deleteWarning:"Saisir DELETE MY ACCOUNT.",deleteBtn:"Supprimer mon compte",
          triageTitle:"Statut de triage",triageHint:"Calcul automatique; modifiable.",override:"Remplacement manuel",speak:"Lire",stop:"Arr√™ter",
          cardTitle:"Carte & QR",scanTip:"Scanner pour l'acc√®s",cardLink:"Lien",copy:"Copier",png:"PNG",svg:"SVG",print:"Imprimer",legend:"Couleurs",
          infoOnly:"√Ä titre indicatif.",privacyNote:"Donn√©es sur votre appareil.",qrNote:"QR permanent."
      },
      de:{identityTitle:"Identit√§t ‚Äî Pers√∂nliche Daten",identityHint:"Best√§tigung Ihrer Identit√§t.",
          fullName:"Vollst√§ndiger Name",dob:"Geburtsdatum",country:"Land",healthId:"Gesundheits-ID",
          codeLabel:"Ihr Karten-Code:",genCode:"Code erzeugen",saveProfile:"Profil speichern",
          criticalTitle:"KRITISCH ‚Äî Medizinische Angaben",criticalHint:"Aktuell halten.",
          bloodType:"Blutgruppe",organDonor:"Organspender",allergies:"Kritische Allergien",conditions:"Erkrankungen",meds:"Medikamente",implants:"Implantate",
          lifeSupport:"Lebenserhaltungs-Pr√§f.",fullSupport:"Voller Einsatz",comfortOnly:"Nur Komfort",dnr:"DNR",lifeSupportNote:"Nur informativ.",
          saveHealth:"Gesundheit speichern",iceTitle:"Notfallkontakte (ICE)",iceHint:"Bis zu 3.",addContact:"Kontakt hinzuf√ºgen",
          deleteTitle:"Konto l√∂schen",deleteWarning:"DELETE MY ACCOUNT eingeben.",deleteBtn:"Konto l√∂schen",
          triageTitle:"Triage-Status",triageHint:"Automatisch; anpassbar.",override:"Manuell √ºberschreiben",speak:"Vorlesen",stop:"Stopp",
          cardTitle:"Notfallkarte & QR",scanTip:"Scannen",cardLink:"Link",copy:"Kopieren",png:"PNG",svg:"SVG",print:"Drucken",legend:"Farben",
          infoOnly:"Nur unterst√ºtzend.",privacyNote:"Daten bleiben lokal.",qrNote:"QR bleibt gleich."
      },
      it:{identityTitle:"Identit√† ‚Äî Informazioni personali",identityHint:"Conferma la tua identit√†.",
          fullName:"Nome completo",dob:"Data di nascita",country:"Paese",healthId:"ID sanitario",
          codeLabel:"Codice tessera:",genCode:"Genera codice",saveProfile:"Salva profilo",
          criticalTitle:"CRITICO ‚Äî Dati sanitari",criticalHint:"Tienili aggiornati.",
          bloodType:"Gruppo sanguigno",organDonor:"Donatore",allergies:"Allergie critiche",conditions:"Condizioni",meds:"Farmaci",implants:"Impianti",
          lifeSupport:"Preferenza rianimazione",fullSupport:"Supporto completo",comfortOnly:"Solo comfort",dnr:"DNR",lifeSupportNote:"Solo informativo.",
          saveHealth:"Salva",iceTitle:"Contatti ICE",iceHint:"Fino a 3.",addContact:"Aggiungi contatto",
          deleteTitle:"Elimina account",deleteWarning:"Scrivi DELETE MY ACCOUNT.",deleteBtn:"Elimina",
          triageTitle:"Stato triage",triageHint:"Auto; modificabile.",override:"Override manuale",speak:"Sintesi vocale",stop:"Stop",
          cardTitle:"Tessera & QR",scanTip:"Scansiona",cardLink:"Link",copy:"Copia",png:"PNG",svg:"SVG",print:"Stampa",legend:"Colori",
          infoOnly:"Solo supporto.",privacyNote:"Dati sul dispositivo.",qrNote:"QR fisso."
      },
      pt:{identityTitle:"Identidade ‚Äî Informa√ß√µes Pessoais",identityHint:"Confirma quem voc√™ √©.",
          fullName:"Nome completo",dob:"Data de nascimento",country:"Pa√≠s",healthId:"ID de sa√∫de",
          codeLabel:"Seu c√≥digo:",genCode:"Gerar c√≥digo",saveProfile:"Salvar perfil",
          criticalTitle:"CR√çTICO ‚Äî Sa√∫de",criticalHint:"Mantenha atualizado.",
          bloodType:"Tipo sangu√≠neo",organDonor:"Doador",allergies:"Alergias cr√≠ticas",conditions:"Condi√ß√µes",meds:"Medicamentos",implants:"Implantes",
          lifeSupport:"Prefer√™ncia de suporte",fullSupport:"Completo",comfortOnly:"Conforto",dnr:"DNR",lifeSupportNote:"Informativo.",
          saveHealth:"Salvar",iceTitle:"Contatos ICE",iceHint:"At√© 3.",addContact:"Adicionar",
          deleteTitle:"Excluir conta",deleteWarning:"Digite DELETE MY ACCOUNT.",deleteBtn:"Excluir",
          triageTitle:"Triagem",triageHint:"Autom√°tica; pode alterar.",override:"Substitui√ß√£o manual",speak:"Falar",stop:"Parar",
          cardTitle:"Cart√£o & QR",scanTip:"Escaneie",cardLink:"Link",copy:"Copiar",png:"PNG",svg:"SVG",print:"Imprimir",legend:"Cores",
          infoOnly:"Apenas apoio.",privacyNote:"Dados locais.",qrNote:"QR permanente."
      },
      ro:{identityTitle:"Identitate ‚Äî Informa»õii personale",identityHint:"ConfirmƒÉ identitatea.",
          fullName:"Nume complet",dob:"Data na»ôterii",country:"»öarƒÉ",healthId:"ID sƒÉnƒÉtate",
          codeLabel:"Codul tƒÉu:",genCode:"GenereazƒÉ cod",saveProfile:"SalveazƒÉ profil",
          criticalTitle:"CRITIC ‚Äî Detalii medicale",criticalHint:"»öine actualizat.",
          bloodType:"Grupa sanguinƒÉ",organDonor:"Donator de organe",allergies:"Alergii critice",conditions:"Afectiuni",meds:"Medica»õie",implants:"Implanturi",
          lifeSupport:"Preferin»õƒÉ suport vital",fullSupport:"Complet",comfortOnly:"Confort",dnr:"DNR",lifeSupportNote:"Informativ.",
          saveHealth:"SalveazƒÉ",iceTitle:"Contacte ICE",iceHint:"P√¢nƒÉ la 3.",addContact:"AdaugƒÉ contact",
          deleteTitle:"»òterge contul",deleteWarning:"TasteazƒÉ DELETE MY ACCOUNT.",deleteBtn:"»òterge contul",
          triageTitle:"Stare triere",triageHint:"AutomatƒÉ; po»õi schimba.",override:"Manual",speak:"Vorbe»ôte",stop:"Stop",
          cardTitle:"Card & QR",scanTip:"ScaneazƒÉ",cardLink:"Link",copy:"CopiazƒÉ",png:"PNG",svg:"SVG",print:"PrinteazƒÉ",legend:"Culori",
          infoOnly:"Doar informativ.",privacyNote:"Date locale.",qrNote:"QR neschimbat."
      },
      ar:{identityTitle:"ÿßŸÑŸáŸàŸäÿ© ‚Äî ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©",identityHint:"ÿ™Ÿèÿ≥ÿßÿπÿØ ŸÅŸä ÿ™ÿ£ŸÉŸäÿØ ŸáŸàŸäÿ™ŸÉ.",
          fullName:"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ",dob:"ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ",country:"ÿßŸÑÿØŸàŸÑÿ©",healthId:"ŸáŸàŸäÿ© ÿµÿ≠Ÿäÿ©",
          codeLabel:"ÿ±ŸÖÿ≤ ÿ®ÿ∑ÿßŸÇÿ™ŸÉ:",genCode:"ÿ•ŸÜÿ¥ÿßÿ° ÿ±ŸÖÿ≤",saveProfile:"ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ",
          criticalTitle:"ÿ≠ÿ±Ÿêÿ¨ ‚Äî ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿµÿ≠Ÿäÿ©",criticalHint:"ÿ£ÿ®ŸÇŸáÿß ŸÖÿ≠ÿØÿ´ÿ©.",
          bloodType:"ŸÅÿµŸäŸÑÿ© ÿßŸÑÿØŸÖ",organDonor:"ŸÖÿ™ÿ®ÿ±ÿπ ÿ®ÿßŸÑÿ£ÿπÿ∂ÿßÿ°",allergies:"ÿ≠ÿ≥ÿßÿ≥Ÿäÿßÿ™ ÿ≠ÿ±ÿ¨ÿ©",conditions:"ÿ≠ÿßŸÑÿßÿ™",meds:"ÿ£ÿØŸàŸäÿ©",implants:"ÿ≤ÿ±ÿπÿßÿ™",
          lifeSupport:"ÿ™ŸÅÿ∂ŸäŸÑ ÿØÿπŸÖ ÿßŸÑÿ≠Ÿäÿßÿ©",fullSupport:"ŸÉÿßŸÖŸÑ",comfortOnly:"ÿ±ÿßÿ≠ÿ© ŸÅŸÇÿ∑",dnr:"ÿπÿØŸÖ ÿßŸÑÿ•ŸÜÿπÿßÿ¥",lifeSupportNote:"ŸÑŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÅŸÇÿ∑.",
          saveHealth:"ÿ≠ŸÅÿ∏",iceTitle:"ÿ¨Ÿáÿßÿ™ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ (ICE)",iceHint:"ÿ≠ÿ™Ÿâ 3 ÿ¨Ÿáÿßÿ™.",addContact:"ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿ©",
          deleteTitle:"ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®",deleteWarning:"ÿßŸÉÿ™ÿ® DELETE MY ACCOUNT.",deleteBtn:"ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
          triageTitle:"ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ±ÿ≤ ÿßŸÑÿ∑ÿ®Ÿä",triageHint:"ŸÖÿ≠ÿ≥Ÿàÿ® ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.",override:"ÿ™ÿ¨ÿßŸàÿ≤ ŸäÿØŸàŸä",speak:"ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑÿÆÿµ",stop:"ÿ•ŸäŸÇÿßŸÅ",
          cardTitle:"ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© Ÿà ÿ±ŸÖÿ≤ QR",scanTip:"ÿßŸÖÿ≥ÿ≠ ŸÑŸÑŸàÿµŸàŸÑ",cardLink:"ÿ±ÿßÿ®ÿ∑",copy:"ŸÜÿ≥ÿÆ",png:"PNG",svg:"SVG",print:"ÿ∑ÿ®ÿßÿπÿ©",legend:"ÿ£ŸÑŸàÿßŸÜ",
          infoOnly:"ŸÑŸÑÿßÿ≥ÿ™ÿ±ÿ¥ÿßÿØ ŸÅŸÇÿ∑.",privacyNote:"ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ŸÉ.",qrNote:"ÿ±ŸÖÿ≤ ÿ´ÿßÿ®ÿ™."
      },
      hi:{identityTitle:"‡§™‡§π‡§ö‡§æ‡§® ‚Äî ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä",identityHint:"‡§™‡§π‡§ö‡§æ‡§® ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø‡•§",
          fullName:"‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ",dob:"‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø",country:"‡§¶‡•á‡§∂",healthId:"‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§Ü‡§à‡§°‡•Ä",
          codeLabel:"‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡•ã‡§°:",genCode:"‡§ï‡•ã‡§° ‡§¨‡§®‡§æ‡§è‡§Å",saveProfile:"‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç",
          criticalTitle:"‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‚Äî ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡•Ä‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£",criticalHint:"‡§Ö‡§™‡§°‡•á‡§ü ‡§∞‡§ñ‡•á‡§Ç.",
          bloodType:"‡§∞‡§ï‡•ç‡§§ ‡§∏‡§Æ‡•Ç‡§π",organDonor:"‡§Ö‡§Ç‡§ó ‡§¶‡§æ‡§§‡§æ",allergies:"‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä",conditions:"‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡§æ‡§Å",meds:"‡§¶‡§µ‡§æ‡§è‡§Å",implants:"‡§á‡§Æ‡•ç‡§™‡•ç‡§≤‡§æ‡§Ç‡§ü",
          lifeSupport:"‡§ú‡•Ä‡§µ‡§®-‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§µ‡§∞‡•Ä‡§Ø‡§§‡§æ",fullSupport:"‡§™‡•Ç‡§∞‡•ç‡§£",comfortOnly:"‡§Ü‡§∞‡§æ‡§Æ",dnr:"DNR",lifeSupportNote:"‡§ï‡•á‡§µ‡§≤ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§π‡•á‡§§‡•Å.",
          saveHealth:"‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§π‡•á‡§ú‡•á‡§Ç",iceTitle:"‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï (ICE)",iceHint:"‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 3.",addContact:"‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
          deleteTitle:"‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Å",deleteWarning:"DELETE MY ACCOUNT ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§",deleteBtn:"‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Å",
          triageTitle:"‡§ü‡•ç‡§∞‡§æ‡§Ø‡•á‡§ú ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",triageHint:"‡§∏‡•ç‡§µ‡§§‡§É ‡§ó‡§£‡§®‡§æ; ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§",override:"‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§°",speak:"‡§Ü‡§µ‡§æ‡§ú‡§º: ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂",stop:"‡§∞‡•ã‡§ï‡•á‡§Ç",
          cardTitle:"‡§ï‡§æ‡§∞‡•ç‡§° ‡§µ QR",scanTip:"‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç",cardLink:"‡§≤‡§ø‡§Ç‡§ï",copy:"‡§ï‡•â‡§™‡•Ä",png:"PNG",svg:"SVG",print:"‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü",legend:"‡§ü‡•ç‡§∞‡§æ‡§Ø‡•á‡§ú ‡§∞‡§Ç‡§ó",
          infoOnly:"‡§∏‡§ø‡§∞‡•ç‡§´ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§π‡•á‡§§‡•Å‡•§",privacyNote:"‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§™‡§∞‡•§",qrNote:"QR ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§π‡•à‡•§"
      },
      zh:{identityTitle:"Ë∫´‰ªΩ ‚Äî ‰∏™‰∫∫‰ø°ÊÅØ",identityHint:"Â∏ÆÂä©ÊÄ•Êïë‰∫∫ÂëòÁ°ÆËÆ§Ë∫´‰ªΩ„ÄÇ",
          fullName:"ÂßìÂêç",dob:"Âá∫ÁîüÊó•Êúü",country:"ÂõΩÂÆ∂",healthId:"ÂÅ•Â∫∑ID",
          codeLabel:"Âç°Áâá‰ª£Á†ÅÔºö",genCode:"ÁîüÊàê‰ª£Á†Å",saveProfile:"‰øùÂ≠òËµÑÊñô",
          criticalTitle:"ÈáçË¶Å ‚Äî ÂåªÁñó‰ø°ÊÅØ",criticalHint:"ËØ∑‰øùÊåÅÊúÄÊñ∞„ÄÇ",
          bloodType:"Ë°ÄÂûã",organDonor:"Âô®ÂÆòÊçêÁåÆËÄÖ",allergies:"ÈáçË¶ÅËøáÊïè",conditions:"ÁóÖÁóá",meds:"ÂΩìÂâçÁî®ËçØ",implants:"Ê§çÂÖ•/ËÆæÂ§á",
          lifeSupport:"ÁîüÂëΩÊîØÊåÅÂÅèÂ•Ω",fullSupport:"ÂÖ®ÂäõÊä¢Êïë",comfortOnly:"ËàíÁºìÊ≤ªÁñó",dnr:"DNR",lifeSupportNote:"‰ªÖ‰æõÂèÇËÄÉ„ÄÇ",
          saveHealth:"‰øùÂ≠ò",iceTitle:"Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ (ICE)",iceHint:"ÊúÄÂ§ö 3 ‰Ωç„ÄÇ",addContact:"Ê∑ªÂä†ËÅîÁ≥ª‰∫∫",
          deleteTitle:"Âà†Èô§Ë¥¶Êà∑",deleteWarning:"ËæìÂÖ• DELETE MY ACCOUNT„ÄÇ",deleteBtn:"Âà†Èô§Ë¥¶Êà∑",
          triageTitle:"ÂàÜËØäÁä∂ÊÄÅ",triageHint:"Ëá™Âä®ËÆ°ÁÆóÔºõÂèØÊâãÂä®Ë¶ÜÁõñ„ÄÇ",override:"ÊâãÂä®Ë¶ÜÁõñ",speak:"ÊúóËØªÊëòË¶Å",stop:"ÂÅúÊ≠¢",
          cardTitle:"ÊÄ•ÊïëÂç° & ‰∫åÁª¥Á†Å",scanTip:"Êâ´Á†ÅËé∑Âèñ‰ø°ÊÅØ",cardLink:"Âç°ÁâáÈìæÊé•",copy:"Â§çÂà∂",png:"PNG",svg:"SVG",print:"ÊâìÂç∞",legend:"ÂàÜËØäÈ¢úËâ≤",
          infoOnly:"‰ªÖ‰æõÂèÇËÄÉ„ÄÇ",privacyNote:"Êï∞ÊçÆ‰øùÂ≠òÂú®‰Ω†ÁöÑËÆæÂ§á‰∏ä„ÄÇ",qrNote:"‰∫åÁª¥Á†ÅÂõ∫ÂÆö‰∏çÂèò„ÄÇ"
      }
    };

    const langSel = document.getElementById('lang');
    function applyI18n(){
      const L = T[langSel.value] || T.en;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(L[key]) el.textContent = L[key];
      });
      document.documentElement.dir = (langSel.value==='ar') ? 'rtl' : 'ltr';
    }
    langSel.addEventListener('change', ()=>{
      localStorage.setItem('myqer_lang', langSel.value);
      applyI18n();
      updateVoiceLocale();
    });

    // ---- Supabase client ----
    const sb = window.supabase.createClient(MYQER.SUPABASE_URL, MYQER.SUPABASE_ANON_KEY, { auth:{ persistSession:true } });

    // ---- Voice (gentle female if available) ----
    let voiceLang = 'en-US';
    function updateVoiceLocale(){
      const map = {en:'en-US',es:'es-ES',fr:'fr-FR',de:'de-DE',it:'it-IT',pt:'pt-PT',ro:'ro-RO',ar:'ar-SA',hi:'hi-IN',zh:'zh-CN'};
      voiceLang = map[langSel.value] || 'en-US';
    }
    function buildSummary(){
      const n = (profile.full_name||'');
      const bt = (health.blood_type||'‚Äî');
      const a  = (health.allergies||'‚Äî');
      const c  = (health.conditions||'‚Äî');
      const m  = (health.meds||'‚Äî');
      return `${n}. Blood: ${bt}. Allergies: ${a}. Conditions: ${c}. Meds: ${m}.`;
    }
    function speakSummary(){
      try{ speechSynthesis.cancel(); }catch(_){}
      const u = new SpeechSynthesisUtterance(buildSummary());
      u.lang = voiceLang;
      // try to pick a female voice
      const voices = speechSynthesis.getVoices();
      const cand = voices.find(v=>v.lang===voiceLang && /female|woman|siri/i.test(v.name)) ||
                   voices.find(v=>v.lang===voiceLang) || voices[0];
      if (cand) u.voice = cand;
      u.rate = 0.98; u.pitch = 1.05;
      speechSynthesis.speak(u);
    }

    // ---- Elements ----
    const year = document.getElementById('year'); year.textContent = new Date().getFullYear();
    const loading = document.getElementById('loading');
    const dash = document.getElementById('dash');
    const errorBox = document.getElementById('errorBox');
    const errorMsg = document.getElementById('errorMsg');

    const profileForm = document.getElementById('profileForm');
    const healthForm  = document.getElementById('healthForm');
    const iceList     = document.getElementById('iceList');

    const codeText    = document.getElementById('codeText');
    const codeUnderQR = document.getElementById('codeUnderQR');
    const cardUrlEl   = document.getElementById('cardUrl');
    const qrStatus    = document.getElementById('qrStatus');

    const triagePill  = document.getElementById('triagePill');
    const triageOverride = document.getElementById('triageOverride');

    const offlineText = document.getElementById('offlineText');
    const qrHost      = document.getElementById('qrHost');
    const offlineQRwrap = document.getElementById('offlineQRwrap');
    const offlineQR   = document.getElementById('offlineQR');

    // ---- Data state ----
    let session, user, profile={}, health={}, ice=[];

    // ---- Helpers ----
    function toast(msg,type='ok'){
      const el = document.createElement('div');
      el.className = `fixed top-4 right-4 z-[999] px-4 py-2 rounded-md text-white shadow ${type==='ok'?'bg-emerald-600':type==='warn'?'bg-amber-600':'bg-red-600'}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    }
    const debounce = (fn,ms=500)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };

    async function ensureSession(){
      const g = await sb.auth.getSession();
      if(!g.data.session){ location.replace('/'); return false; }
      session = g.data.session; user = session.user; return true;
    }

    // ---- Load / Save ----
    async function loadAll(){
      // profile
      let P = await sb.from('profiles').select('*').eq('id', user.id).maybeSingle();
      if(P.error && P.error.code!=='PGRST116') throw P.error;
      if(!P.data){
        const ins = await sb.from('profiles').insert({ id:user.id, email:user.email }).select().single();
        if(ins.error) throw ins.error;
        profile = ins.data;
      } else profile = P.data;

      // health
      let H = await sb.from('health_profiles').select('*').eq('user_id', user.id).maybeSingle();
      if(H.error && H.error.code!=='PGRST116') throw H.error;
      if(!H.data){
        await sb.from('health_profiles').insert({ user_id:user.id });
        health = {};
      } else health = H.data;

      // ice
      const I = await sb.from('ice_contacts').select('*').eq('user_id', user.id).order('created_at');
      if(I.error) throw I.error;
      ice = I.data || [];
    }

    function renderProfile(){
      const f = profileForm;
      f.full_name.value     = profile.full_name || '';
      f.date_of_birth.value = profile.date_of_birth || '';
      f.country.value       = profile.country || '';
      f.health_id.value     = profile.health_id || '';
      codeText.textContent  = profile.code || '‚Äî';
      const link = profile.code ? `${MYQER.SHORT_BASE}/c/${encodeURIComponent(profile.code)}` : '';
      cardUrlEl.value = link;
      codeUnderQR.textContent = profile.code || '‚Äî';
    }

    function renderHealth(){
      const f = healthForm;
      f.blood_type.value       = health.blood_type || '';
      document.getElementById('donor').checked = !!health.organ_donor;
      f.allergies.value        = health.allergies || '';
      f.conditions.value       = health.conditions || '';
      f.meds.value             = health.meds || '';
      f.implants.value         = health.implants || '';
      f.life_support_pref.value= health.life_support_pref || '';
    }

    function renderIce(){
      if(!ice.length){
        iceList.innerHTML = `<div class="muted text-sm">No contacts yet.</div>`;
        return;
      }
      iceList.innerHTML = ice.map(c=>`
        <div class="border rounded-lg p-3 bg-white">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
            <input class="field" placeholder="Name" value="${c.name||''}" data-id="${c.id}" data-field="name">
            <input class="field" placeholder="Relationship" value="${c.relation||''}" data-id="${c.id}" data-field="relation">
            <div class="flex gap-2">
              <input class="field flex-1" placeholder="Phone" value="${c.phone||''}" data-id="${c.id}" data-field="phone">
              <button class="btn px-3 py-2 border text-sm" data-del="${c.id}">üóë</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function computeTriage(){
      const ov = profile.triage_override;
      if(ov) return ov;

      const pref = (health.life_support_pref||'').toLowerCase();
      if(pref.includes('dnr') || pref.includes('comfort')) return 'black';

      const severe = (health.allergies||'').toLowerCase().includes('anaphyl') ||
                     (health.conditions||'').toLowerCase().includes('severe');
      if(severe) return 'red';

      const hasCond = !!(health.conditions||'').trim();
      if(hasCond) return 'amber';

      return 'green';
    }
    function applyTriage(){
      const level = computeTriage();
      const map = {
        green:{text:'GREEN', color:'#16a34a'},
        amber:{text:'AMBER', color:'#f59e0b'},
        red:{text:'RED', color:'#ef4444'},
        black:{text:'BLACK', color:'#111827'},
      };
      const v = map[level]||map.green;
      triagePill.style.border = '1px solid ' + v.color + '55';
      triagePill.style.color = v.color;
      triagePill.textContent = v.text + (level==='green'?' ‚Äî Standard':'' );
    }

    function buildOfflineText(){
      // Omit-empty (clean) style; easy to switch to explicit if you prefer
      const lines = [];
      const push = (label, val)=>{ if(val && String(val).trim()) lines.push(`${label}: ${String(val).trim()}`); };

      push('Name', profile.full_name);
      push('DOB', profile.date_of_birth);
      push('Country', profile.country);
      push('Health ID', profile.health_id);
      push('Blood', health.blood_type);
      push('Allergies', health.allergies);
      push('Conditions', health.conditions);
      push('Meds', health.meds);
      push('Implants', health.implants);
      const tri = computeTriage().toUpperCase();
      push('Triage', tri);
      // Include short URL last (so most scanners show it right after the text)
      if (profile.code) push('URL', `${MYQER.SHORT_BASE}/c/${profile.code}`);

      return lines.join('\n');
    }

    function drawQR(hostEl, payload){
      // clear previous
      hostEl.innerHTML = '';
      new QRCode(hostEl, {
        text: payload,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    function renderQR(){
      if(!profile.code){
        qrStatus.textContent = 'No code yet';
        document.getElementById('qrHost').innerHTML = '';
        return;
      }
      const url = `${MYQER.SHORT_BASE}/c/${encodeURIComponent(profile.code)}`;
      qrStatus.textContent = '';
      drawQR(qrHost, url);
      cardUrlEl.value = url;
      codeUnderQR.textContent = profile.code;
      offlineText.value = buildOfflineText();
      // if offline QR visible, refresh it too
      if(!offlineQRwrap.classList.contains('hidden')){
        drawQR(offlineQR, offlineText.value);
      }
    }

    // ---- Saves ----
    profileForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(profileForm);
      const data = {
        id:user.id, email:user.email,
        full_name: fd.get('full_name')||null,
        date_of_birth: fd.get('date_of_birth')||null,
        country: fd.get('country')||null,
        health_id: fd.get('health_id')||null,
      };
      const { error } = await sb.from('profiles').upsert(data);
      if(error) return toast(error.message,'err');
      profile = { ...profile, ...data };
      renderProfile(); renderQR(); applyTriage();
      toast('Profile saved','ok');
    });

    document.getElementById('genCode').addEventListener('click', async ()=>{
      if(profile.code){ toast('Code already exists','warn'); return; }
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      const r = n => Array.from({length:n},()=>alphabet[Math.floor(Math.random()*alphabet.length)]).join('');
      const newCode = `${r(3)}-${r(4)}-${r(3)}`;
      const { error } = await sb.from('profiles').update({ code:newCode }).eq('id', user.id);
      if(error) return toast(error.message,'err');
      profile.code = newCode;
      renderProfile(); renderQR();
      toast('Code generated','ok');
    });

    healthForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(healthForm);
      const data = {
        user_id: user.id,
        blood_type: fd.get('blood_type')||null,
        organ_donor: document.getElementById('donor').checked,
        allergies: fd.get('allergies')||null,
        conditions: fd.get('conditions')||null,
        meds: fd.get('meds')||null,
        implants: fd.get('implants')||null,
        life_support_pref: fd.get('life_support_pref')||null
      };
      const { error } = await sb.from('health_profiles').upsert(data);
      if(error) return toast(error.message,'err');
      health = { ...health, ...data };
      applyTriage(); renderQR(); // offline text includes triage
      toast('Health saved','ok');
    });

    // ICE
    document.getElementById('addIce').addEventListener('click', async ()=>{
      if(ice.length>=3){ toast('Maximum 3 contacts','warn'); return; }
      const { data, error } = await sb.from('ice_contacts').insert({user_id:user.id,name:'',relation:'',phone:''}).select().single();
      if(error) return toast(error.message,'err');
      ice.push(data); renderIce();
    });

    // Debounced inline update
    const debouncers = {};
    function debounced(id,fn,ms=400){ clearTimeout(debouncers[id]); debouncers[id]=setTimeout(fn,ms); }
    iceList.addEventListener('input', (e)=>{
      const id = e.target.dataset.id; const field = e.target.dataset.field;
      if(!id||!field) return;
      const val = e.target.value;
      debounced(`${id}:${field}`, async ()=>{
        const { error } = await sb.from('ice_contacts').update({ [field]:val }).eq('id', id);
        if(error) toast('Update failed','err');
      });
      const row = ice.find(x=>String(x.id)===String(id)); if(row) row[field]=val;
    });
    iceList.addEventListener('click', async (e)=>{
      const del = e.target.dataset.del;
      if(!del) return;
      if(!confirm('Delete this contact?')) return;
      const { error } = await sb.from('ice_contacts').delete().eq('id', del);
      if(error) return toast(error.message,'err');
      ice = ice.filter(x=>String(x.id)!==String(del)); renderIce();
    });

    // Voice buttons
    document.getElementById('speak').addEventListener('click', speakSummary);
    document.getElementById('stopSpeak').addEventListener('click', ()=>{ try{ speechSynthesis.cancel(); }catch(_){}});

    // QR actions
    document.getElementById('copyLink').addEventListener('click', async ()=>{
      if(cardUrlEl.value){ await navigator.clipboard.writeText(cardUrlEl.value); toast('Copied','ok'); }
    });
    document.getElementById('dlPNG').addEventListener('click', ()=>{
      // export the main QR image (qrcodejs renders <img> inside #qrHost)
      const img = qrHost.querySelector('img');
      if(!img) return;
      const a = document.createElement('a');
      a.href = img.src; a.download='myqer-qr.png'; a.click();
    });
    document.getElementById('dlSVG').addEventListener('click', ()=>{
      const img = qrHost.querySelector('img'); if(!img) return;
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="#fff"/><image href="${img.src}" x="0" y="0" height="512" width="512"/></svg>`;
      const blob = new Blob([svg], {type:'image/svg+xml'});
      const a = document.createElement('a'); a.download='myqer-qr.svg'; a.href = URL.createObjectURL(blob); a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    });
    document.getElementById('printQR').addEventListener('click', ()=>{
      if(!profile.code) return;
      const img = qrHost.querySelector('img')?.src || '';
      const link = cardUrlEl.value || '';
      const code = profile.code || '';
      const text = (offlineText.value||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
      const w = window.open('','_blank','width=420,height=640');
      w.document.write(`
        <html><head><title>Print Emergency Card</title>
        <style>
          body{font-family:system-ui;margin:0;padding:20px}
          .wrap{max-width:360px;margin:0 auto}
          .pill{display:inline-block;border:1px solid #c6282855;color:#c62828;border-radius:9999px;padding:2px 8px;font:12px/18px system-ui;}
          .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
          pre{white-space:pre-wrap;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:8px;}
        </style>
        </head><body><div class="wrap">
          <h3 style="margin:0 0 6px;font-weight:800">MYQ<span style="color:#c62828">ER</span> <sup style="font-size:10px">‚Ñ¢</sup></h3>
          <div class="pill">Emergency Card</div>
          <div style="margin:12px 0;text-align:center">
            <img src="${img}" style="width:260px;height:260px;border:2px solid #c62828;border-radius:12px"/><br/>
            <div class="mono" style="margin-top:8px">${code}</div>
            <div style="font-size:12px;color:#475569">${link}</div>
          </div>
          <div style="font-size:12px;color:#0f172a"><strong>Offline essentials</strong></div>
          <pre class="mono">${text}</pre>
        </div></body></html>
      `);
      w.document.close(); w.focus(); w.print();
    });

    document.getElementById('toggleOfflineQR').addEventListener('click', ()=>{
      if(offlineQRwrap.classList.contains('hidden')){
        drawQR(offlineQR, offlineText.value || 'No data');
        offlineQRwrap.classList.remove('hidden');
      } else {
        offlineQRwrap.classList.add('hidden');
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      try { await sb.auth.signOut(); } catch(e) { console.error(e); }
      location.replace('/');
    });

    // Delete
    const deleteBtn = document.getElementById('deleteBtn');
    const deletePhrase = document.getElementById('deletePhrase');
    const deleteNote = document.getElementById('deleteNote');
    deletePhrase.addEventListener('input', ()=>{
      deleteBtn.disabled = deletePhrase.value.trim().toUpperCase() !== 'DELETE MY ACCOUNT';
    });
    deleteBtn.addEventListener('click', async ()=>{
      if(!confirm('This will permanently delete your account and data. Continue?')) return;
      deleteBtn.disabled = true;
      deleteNote.textContent = 'Processing‚Ä¶';
      try{
        // Recommend a secured Edge Function that uses the service role to cascade delete + auth.delete
        const resp = await fetch(`${location.origin}/functions/v1/account-delete`, {
          method:'POST', headers:{ Authorization:`Bearer ${session.access_token}` }
        });
        if(!resp.ok) throw new Error('Delete endpoint not available');
        deleteNote.textContent = 'Deleted. Signing out‚Ä¶';
        setTimeout(async ()=>{ await sb.auth.signOut(); location.replace('/'); }, 900);
      }catch(e){
        deleteNote.textContent = 'Automatic deletion not available. Please enable the secured Edge Function.';
        deleteBtn.disabled = false;
      }
    });

    // Init
    (async ()=>{
      try{
        // restore language
        const saved = localStorage.getItem('myqer_lang');
        if(saved && T[saved]) langSel.value = saved;
        applyI18n(); updateVoiceLocale();

        const ok = await ensureSession(); if(!ok) return;

        await loadAll();
        renderProfile(); renderHealth(); renderIce(); renderQR(); applyTriage();

        loading.classList.add('hidden');
        dash.classList.remove('hidden');
      }catch(e){
        console.error(e);
        loading.classList.add('hidden');
        errorMsg.textContent = e.message||'Unknown error';
        errorBox.classList.remove('hidden');
      }
    })();

    // manual triage override store
    triageOverride.addEventListener('change', async ()=>{
      const value = triageOverride.value || null;
      const { error } = await sb.from('profiles').update({ triage_override:value }).eq('id', user.id);
      if(!error){ profile.triage_override = value; applyTriage(); renderQR(); }
    });

    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Service worker (optional)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
