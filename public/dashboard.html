<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MYQER Emergency Dashboard</title>

<!-- Fonts / Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- Supabase SDK (v2) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- QRCode -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  :root{
    --ink:#0F172A;--slate-100:#F1F5F9;--slate-200:#E2E8F0;--slate-500:#64748B;--slate-600:#475569;
    --red:#DC2626;--red-600:#B91C1C;--amber:#D97706;--green:#059669;--rose:#E11D48;
    --glass:rgba(255,255,255,.92);--border:rgba(15,23,42,.08);--shadow:0 20px 40px rgba(2,8,23,.1);
    --r:16px;--space:20px;--w:1100px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,#F8FAFC,#E2E8F0);color:var(--ink);margin:0}
  header{position:sticky;top:0;background:var(--glass);backdrop-filter:blur(14px);border-bottom:1px solid var(--border);z-index:50}
  .wrap{max-width:var(--w);margin:auto;padding:14px 18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--red),var(--red-600));color:#fff;font-weight:800;display:grid;place-items:center}
  .bar{display:flex;justify-content:space-between;align-items:center}
  .logout{border:2px solid var(--slate-200);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .logout:hover{background:var(--red);border-color:var(--red);color:#fff}

  main{padding:24px 0}
  .card{width:100%;background:var(--glass);border:1px solid var(--border);border-radius:24px;box-shadow:var(--shadow);padding:28px;margin:0 auto 26px;max-width:var(--w);position:relative;overflow:hidden}
  .card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:linear-gradient(180deg,var(--green),#047857)}
  .critical::before{background:linear-gradient(180deg,var(--red),var(--red-600))}
  .ice::before{background:linear-gradient(180deg,var(--amber),#B45309)}
  .qr::before{background:linear-gradient(180deg,var(--rose),#BE185D)}
  .delete::before{background:linear-gradient(180deg,var(--red),#991B1B)}
  .card h2{margin:0 0 6px;font-size:22px}
  .muted{color:var(--slate-500);font-size:14px;margin:0 0 18px}

  .grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:18px}
  .full{grid-column:1/-1}
  label{font-size:12px;text-transform:uppercase;font-weight:600;color:#334155}
  input,select,textarea{width:100%;padding:12px 14px;border:2px solid var(--slate-200);border-radius:12px;font-size:15px;background:#fff}
  textarea{min-height:110px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--red)}
  .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}
  .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;display:flex;gap:8px;align-items:center}
  .primary{background:linear-gradient(135deg,var(--green),#047857);color:#fff}
  .warn{background:linear-gradient(135deg,var(--red),var(--red-600));color:#fff}
  .secondary{background:#fff;border:2px solid var(--slate-200)}
  .chip{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:700;font-size:12px}
  .chip.green{background:var(--green);color:#fff}.chip.amber{background:var(--amber);color:#fff}
  .chip.red{background:var(--red);color:#fff}.chip.black{background:#111827;color:#fff}

  .qrbox{background:#fff;border-radius:16px;padding:22px;display:grid;gap:10px;place-items:center;border:1px solid var(--slate-200)}
  .qr-url{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--slate-100);padding:10px;border-radius:8px;width:100%;display:flex;justify-content:space-between;gap:10px;align-items:center}
  .qr-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  .toast{position:fixed;top:18px;right:18px;background:#fff;border-left:5px solid var(--green);box-shadow:var(--shadow);padding:12px 14px;border-radius:12px;display:none;z-index:9999}
  .toast.show{display:flex;gap:8px;align-items:center}
  .offline{position:fixed;left:0;right:0;top:0;background:var(--amber);color:#fff;text-align:center;padding:8px;display:none;z-index:9998}

  footer{margin:28px auto 40px;max-width:var(--w);color:var(--slate-600);font-size:13px;display:flex;gap:12px;justify-content:space-between;padding:0 18px}
  .foot-left{display:flex;gap:10px;align-items:center}
  .foot-badge{background:var(--red);color:#fff;border-radius:8px;padding:4px 8px;font-weight:700}
  .foot-right{display:flex;gap:18px}
  @media (max-width:900px){.grid{grid-template-columns:1fr} footer{flex-direction:column;gap:10px}}
</style>
</head>
<body>
<div class="offline" id="offlineBanner">You're offline. Changes will sync when you reconnect.</div>

<header>
  <div class="wrap bar">
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <div style="font-weight:800">MYQER Emergency Dashboard</div>
        <div id="userEmail" class="muted">Loading…</div>
      </div>
    </div>
    <button id="btnSignOut" class="logout"><i class="fa fa-right-from-bracket"></i> Logout</button>
  </div>
</header>

<main>
  <!-- Identity -->
  <section class="card">
    <h2>Identity — Personal Information</h2>
    <p class="muted">Complete your personal information for emergency response</p>
    <form id="identityForm" class="grid" autocomplete="on">
      <div>
        <label>First Name</label>
        <input id="firstName" required placeholder="First name" autocomplete="given-name">
      </div>
      <div>
        <label>Last Name</label>
        <input id="lastName" required placeholder="Last name" autocomplete="family-name">
      </div>
      <div>
        <label>Date of Birth</label>
        <input id="dob" type="date" autocomplete="bday">
      </div>
      <div>
        <label>Phone Number</label>
        <input id="phone" type="tel" placeholder="e.g. +44 7777 777777" autocomplete="tel">
      </div>
      <div>
        <label>Country</label>
        <select id="country" autocomplete="country">
          <option value="">Select country</option>
          <option value="GB">United Kingdom</option>
          <option value="US">United States</option>
          <option value="FR">France</option>
          <option value="ES">Spain</option>
          <option value="DE">Germany</option>
        </select>
      </div>
      <div>
        <label>Emergency Contact</label>
        <input id="emergencyContact" placeholder="Contact name / number" autocomplete="off">
      </div>
      <div class="full">
        <label>Medical/National ID (optional)</label>
        <input id="medicalId" placeholder="ID" autocomplete="off">
      </div>
      <div class="actions full">
        <button type="button" id="resetIdentity" class="btn secondary"><i class="fa fa-rotate-left"></i> Reset</button>
        <button type="submit" class="btn primary"><i class="fa fa-floppy-disk"></i> Save Information</button>
      </div>
    </form>
  </section>

  <!-- Health -->
  <section class="card critical">
    <h2>CRITICAL — Medical & Health Details</h2>
    <p class="muted">Essential medical information for emergency responders</p>
    <div class="muted" style="margin-bottom:10px">Triage: <span id="triageChip" class="chip green">GREEN</span></div>
    <form id="healthForm" class="grid">
      <div>
        <label>Blood Type</label>
        <select id="bloodType">
          <option value="">Select</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
        </select>
      </div>
      <div>
        <label>Organ Donor</label>
        <select id="organDonor">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
      <div class="full">
        <label>Critical Allergies</label>
        <textarea id="allergies" placeholder="e.g., Penicillin, Nuts, Shellfish, Latex"></textarea>
      </div>
      <div class="full">
        <label>Medical Conditions</label>
        <textarea id="conditions" placeholder="e.g., Diabetes Type 2, Hypertension, Epilepsy"></textarea>
      </div>
      <div class="full">
        <label>Current Medications</label>
        <textarea id="medications" placeholder="Name, dose, frequency"></textarea>
      </div>
      <div class="full">
        <label>Implants/Devices</label>
        <textarea id="implants" placeholder="e.g., Pacemaker, Stent, Insulin pump"></textarea>
      </div>
      <div class="actions full">
        <button type="submit" class="btn warn"><i class="fa fa-floppy-disk"></i> Save Health Data</button>
      </div>
    </form>
  </section>

  <!-- ICE -->
  <section class="card ice">
    <h2>ICE — Emergency Contacts</h2>
    <p class="muted">Up to three contacts</p>
    <div id="iceList" class="grid"></div>
    <div class="actions">
      <button id="addIce" class="btn secondary"><i class="fa fa-plus"></i> Add Contact</button>
      <button id="saveIce" class="btn primary"><i class="fa fa-floppy-disk"></i> Save Contacts</button>
    </div>
  </section>

  <!-- QR -->
  <section class="card qr">
    <h2>QR — Emergency Access Code</h2>
    <p class="muted">Self-contained essentials offline + live link online</p>
    <div class="qrbox">
      <canvas id="qrCanvas" width="260" height="260" aria-label="MYQER QR"></canvas>
      <div id="qrCaption" class="muted" style="font-weight:800;letter-spacing:.15em">------</div>
      <div class="qr-url">
        <span id="qrUrl">Loading…</span>
        <span>
          <button id="copyUrl" class="btn secondary" style="padding:8px 10px" title="Copy URL"><i class="fa fa-copy"></i></button>
          <button id="openUrl" class="btn secondary" style="padding:8px 10px" title="Open URL"><i class="fa fa-up-right-from-square"></i></button>
        </span>
      </div>
      <div class="muted" style="font-size:12px">MYQER™ (my care)</div>
    </div>
    <div class="qr-actions">
      <button id="regenQr" class="btn" style="background:linear-gradient(135deg,var(--rose),#BE185D);color:#fff"><i class="fa fa-rotate"></i> Refresh QR</button>
      <button id="dlPng" class="btn secondary"><i class="fa fa-download"></i> Download PNG</button>
      <button id="dlSvg" class="btn secondary"><i class="fa fa-download"></i> Download SVG</button>
      <button id="printQr" class="btn secondary"><i class="fa fa-print"></i> Print</button>
    </div>
  </section>

  <!-- Delete -->
  <section class="card delete">
    <h2>Delete Account</h2>
    <p class="muted">This action removes all your data permanently.</p>
    <div class="grid">
      <div class="full">
        <label>Type: DELETE MY ACCOUNT</label>
        <input id="confirmDelete" placeholder="DELETE MY ACCOUNT">
      </div>
      <div class="actions full">
        <button id="deleteAccount" class="btn warn" disabled><i class="fa fa-trash"></i> Delete My Account</button>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="foot-left">
    <span class="foot-badge">MYQER</span>
    <span>Emergency profile • Keep this QR visible on phone lock screen, card, or wristband.</span>
  </div>
  <div class="foot-right">
    <span id="footStatus">Status: <strong>Online</strong></span>
    <span id="footSync">Last sync: <strong>—</strong></span>
  </div>
</footer>

<div class="toast" id="toast"><i class="fa fa-circle-check"></i><span id="toastMsg">Saved</span></div>

<script>
/* ----------------- CONFIG ----------------- */
const SUPABASE_URL = "https://dmntmhkncldgynufajei.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true, autoRefreshToken:true} });

/* ----------------- STATE ----------------- */
let user=null, userCode=null;
let ice = []; // {name,relationship,phone,order}
const LS = {
  code: "myqer_code",
  profile: "myqer_profile",
  health: "myqer_health",
  ice: "myqer_ice",
  lastSync: "myqer_last_sync"
};

/* ----------------- UTILS ----------------- */
const $ = (id)=>document.getElementById(id);
function toast(msg, ok=true){ const t=$("toast"); $("toastMsg").textContent=msg; t.style.borderLeftColor = ok? "#059669":"#DC2626"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2200); }
function setFoot(statusText){ $("footStatus").innerHTML = "Status: <strong>"+statusText+"</strong>"; }
function setSync(ts){ const d = ts ? new Date(ts) : new Date(); const s = d.toLocaleString(); localStorage.setItem(LS.lastSync, s); $("footSync").innerHTML = "Last sync: <strong>"+s+"</strong>"; }
function onlineChanged(){
  $("offlineBanner").style.display = navigator.onLine ? "none" : "block";
  setFoot(navigator.onLine ? "Online" : "Offline");
}
window.addEventListener('online', onlineChanged); window.addEventListener('offline', onlineChanged);

/* ----------------- AUTH ----------------- */
async function guard(){
  const { data, error } = await supabase.auth.getSession();
  if (error || !data?.session){ location.replace("index.html"); return; }
  user = data.session.user;
  $("userEmail").textContent = user.email || "Signed in";
}
supabase.auth.onAuthStateChange((_e, s)=>{ if(!s){ try{localStorage.clear();sessionStorage.clear();}catch{} location.replace("index.html"); }});

$("btnSignOut").addEventListener("click", async ()=>{
  await supabase.auth.signOut().catch(()=>{});
  try{localStorage.clear();sessionStorage.clear();}catch{}
  location.replace("index.html");
});

/* ----------------- RPC HELPERS ----------------- */
/* You must have these SQL RPCs in your project:
   - get_or_set_code() -> text
   - get_profile() -> setof profiles
   - save_profile(jsonb) -> void
   - get_health() -> setof health
   - save_health(jsonb) -> void
   - get_ice_contacts() -> setof ice_contacts
   - save_ice_contacts(jsonb) -> void
   - delete_account() -> void
*/

async function ensureCode(){
  try{
    if(navigator.onLine){
      const { data, error } = await supabase.rpc("get_or_set_code");
      if(error) throw error;
      userCode = data;
      localStorage.setItem(LS.code, userCode);
      setSync();
    }else{
      userCode = localStorage.getItem(LS.code) || tempCode();
      localStorage.setItem(LS.code, userCode);
    }
  }catch(e){
    userCode = localStorage.getItem(LS.code) || tempCode();
  }
  refreshQR(); // draw with current cached data
}
function tempCode(){ return Array.from({length:6},()=> "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[Math.floor(Math.random()*32)]).join(""); }

/* ----------------- PROFILE ----------------- */
function profileFromForm(){
  return {
    first_name: $("firstName").value.trim(),
    last_name: $("lastName").value.trim(),
    dob: $("dob").value || null,
    phone: $("phone").value.trim() || null,
    country: $("country").value || null,
    emergency_contact: $("emergencyContact").value.trim() || null,
    medical_id: $("medicalId").value.trim() || null
  };
}
function fullNameOf(p){ const f = (p?.first_name||"").trim(); const l = (p?.last_name||"").trim(); return (f+" "+l).trim(); }
function fillProfile(p){
  if(!p) return;
  $("firstName").value = p.first_name || "";
  $("lastName").value = p.last_name || "";
  $("dob").value = p.dob || "";
  $("phone").value = p.phone || "";
  $("country").value = p.country || "";
  $("emergencyContact").value = p.emergency_contact || "";
  $("medicalId").value = p.medical_id || "";
}
async function loadProfile(){
  let p=null;
  if(navigator.onLine){
    try{ const {data} = await supabase.rpc("get_profile"); if(data?.length) p=data[0]; }catch{}
    if(p){ localStorage.setItem(LS.profile, JSON.stringify(p)); setSync(); }
  }
  if(!p){ const s=localStorage.getItem(LS.profile); if(s) p=JSON.parse(s); }
  fillProfile(p);
}
$("identityForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const p = profileFromForm();
  try{
    if(navigator.onLine){ await supabase.rpc("save_profile",{profile_data:p}); localStorage.setItem(LS.profile, JSON.stringify(p)); toast("Profile saved"); setSync(); }
    else{ localStorage.setItem(LS.profile, JSON.stringify(p)); toast("Saved locally (offline)", true); }
  }catch{ toast("Failed to save profile", false); }
  refreshQR();
});
$("resetIdentity").addEventListener("click", loadProfile);

/* ----------------- HEALTH ----------------- */
function triageAuto(){
  const txt = [$("allergies").value,$("conditions").value,$("medications").value,$("implants").value].join(" ").toLowerCase();
  const hard = ["anaphylaxis","shock","heart attack","myocardial infarction","stroke","status epilepticus","respiratory failure","airway compromise","dialysis","transplant","pacemaker","defibrillator","anticoagulant","hemophilia","oxygen dependent","malignant","metastatic","chemo","insulin pump"];
  if(hard.some(k=>txt.includes(k))) return "red";
  if(txt.trim()) return "amber";
  return "green";
}
function setTriage(){
  const chip=$("triageChip"); const lvl=triageAuto();
  chip.className = "chip " + (lvl==="green"?"green":lvl==="amber"?"amber":lvl==="red"?"red":"black");
  chip.textContent = lvl.toUpperCase();
}
function healthFromForm(){
  return {
    blood_type: $("bloodType").value || null,
    organ_donor: $("organDonor").value === "yes",
    allergies: $("allergies").value.trim() || null,
    conditions: $("conditions").value.trim() || null,
    medications: $("medications").value.trim() || null,
    implants: $("implants").value.trim() || null
  };
}
function fillHealth(h){
  if(!h) return;
  $("bloodType").value = h.blood_type || "";
  $("organDonor").value = h.organ_donor ? "yes":"no";
  $("allergies").value = h.allergies || "";
  $("conditions").value = h.conditions || "";
  $("medications").value = h.medications || "";
  $("implants").value = h.implants || "";
  setTriage();
}
async function loadHealth(){
  let h=null;
  if(navigator.onLine){
    try{ const {data}=await supabase.rpc("get_health"); if(data?.length) h=data[0]; }catch{}
    if(h){ localStorage.setItem(LS.health, JSON.stringify(h)); setSync(); }
  }
  if(!h){ const s=localStorage.getItem(LS.health); if(s) h=JSON.parse(s); }
  fillHealth(h);
}
["bloodType","organDonor","allergies","conditions","medications","implants"].forEach(id=>{
  $(id).addEventListener("input", ()=>{ setTriage(); debounce(refreshQR, 400)(); });
});
$("healthForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const h = healthFromForm();
  try{
    if(navigator.onLine){ await supabase.rpc("save_health",{health_data:h}); localStorage.setItem(LS.health, JSON.stringify(h)); toast("Health saved"); setSync(); }
    else{ localStorage.setItem(LS.health, JSON.stringify(h)); toast("Saved locally (offline)"); }
    setTriage();
  }catch{ toast("Failed to save health", false); }
  refreshQR();
});

/* ----------------- ICE ----------------- */
function renderICE(){
  const box=$("iceList"); box.innerHTML="";
  ice.forEach((c,i)=>{
    const wrap=document.createElement("div");
    wrap.className="full";
    wrap.innerHTML=`
      <label>Contact ${i+1}</label>
      <input id="n${i}" placeholder="Full name" value="${(c.name||"").replace(/"/g,'&quot;')}" />
      <input id="r${i}" placeholder="Relationship" value="${(c.relationship||"").replace(/"/g,'&quot;')}" />
      <input id="p${i}" placeholder="Phone" value="${(c.phone||"").replace(/"/g,'&quot;')}" />
      <div class="actions"><button type="button" class="btn secondary" id="rm${i}"><i class="fa fa-xmark"></i> Remove</button></div>
    `;
    box.appendChild(wrap);
    $("rm"+i).onclick=()=>{ ice.splice(i,1); renderICE(); refreshQR(); };
    $("n"+i).oninput=(e)=>{ ice[i].name=e.target.value; debounce(refreshQR,400)(); };
    $("r"+i).oninput=(e)=>{ ice[i].relationship=e.target.value; };
    $("p"+i).oninput=(e)=>{ ice[i].phone=e.target.value; debounce(refreshQR,400)(); };
  });
}
$("addIce").addEventListener("click", ()=>{
  if(ice.length>=3){ toast("Max 3 contacts", false); return; }
  ice.push({name:"",relationship:"",phone:"",order:ice.length+1}); renderICE();
});
$("saveIce").addEventListener("click", async ()=>{
  const filtered = ice.filter(c=> (c.name||c.relationship||c.phone) );
  try{
    if(navigator.onLine){ await supabase.rpc("save_ice_contacts",{contacts_data:filtered}); localStorage.setItem(LS.ice, JSON.stringify(filtered)); toast("ICE saved"); setSync(); }
    else{ localStorage.setItem(LS.ice, JSON.stringify(filtered)); toast("Saved locally (offline)"); }
  }catch{ toast("Failed to save ICE", false); }
  refreshQR();
});
async function loadICE(){
  let data=null;
  if(navigator.onLine){
    try{ const {data:d}=await supabase.rpc("get_ice_contacts"); data=d; }catch{}
    if(data){ localStorage.setItem(LS.ice, JSON.stringify(data)); setSync(); }
  }
  if(!data){ const s=localStorage.getItem(LS.ice); if(s) data=JSON.parse(s); }
  ice = Array.isArray(data)? data : [];
  renderICE();
}

/* ----------------- QR (offline JSON + URL, branded) ----------------- */
function buildOfflinePayload(){
  const p = JSON.parse(localStorage.getItem(LS.profile) || "{}");
  const h = JSON.parse(localStorage.getItem(LS.health) || "{}");
  const allIce = JSON.parse(localStorage.getItem(LS.ice) || "[]");
  const firstICE = allIce.find(c=> (c?.name||c?.phone)) || {name:null,phone:null};

  const payload = {
    n: fullNameOf(p) || null,                 // name
    d: p?.dob || null,                        // dob
    b: h?.blood_type || null,                 // blood type
    a: (h?.allergies||"")                     // allergies compact
          .split(",").map(s=>s.trim()).filter(Boolean).slice(0,6).join(", "),
    i: { n: firstICE?.name || null, p: firstICE?.phone || null }, // ICE 1
    u: `https://www.myqer.com/c/${userCode}`  // online detail URL
  };
  // Keep <2KB: stringify compact
  return "MYQER|" + JSON.stringify(payload);
}

function drawBrandedOnCanvas(canvas){
  const ctx = canvas.getContext("2d");
  // center red badge
  const size = Math.min(canvas.width, canvas.height);
  const badge = Math.round(size * 0.16); // ~16% of QR size
  const x = (canvas.width - badge)/2;
  const y = (canvas.height - badge)/2;
  ctx.save();
  ctx.fillStyle = "#DC2626";
  roundRect(ctx, x, y, badge, badge, 8);
  ctx.fill();
  // white "M"
  ctx.fillStyle = "#FFFFFF";
  ctx.font = `${Math.round(badge*0.6)}px Inter, Arial, sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("M", x + badge/2, y + badge/2 + 1);
  ctx.restore();
}
function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

async function renderQRToCanvas(canvas, text){
  // strong contrast per ISO/IEC 18004: dark ~#111, light #fff
  await QRCode.toCanvas(canvas, text, { width: canvas.width, margin: 2, color:{dark:"#111111",light:"#FFFFFF"} });
  drawBrandedOnCanvas(canvas);
}

function refreshQR(){
  if(!userCode) return;
  const url = `https://www.myqer.com/c/${userCode}`;
  const payload = buildOfflinePayload(); // JSON + url

  $("qrCaption").textContent = userCode;
  $("qrUrl").textContent = url;

  // draw primary display
  renderQRToCanvas($("qrCanvas"), payload).catch(()=>{});
}

$("regenQr").addEventListener("click", refreshQR);

$("copyUrl").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText($("qrUrl").textContent); toast("URL copied"); }catch{ toast("Copy failed", false); }
});
$("openUrl").addEventListener("click", ()=> window.open($("qrUrl").textContent,"_blank"));

$("dlPng").addEventListener("click", async ()=>{
  const payload = buildOfflinePayload();
  const tmp = document.createElement("canvas"); tmp.width=600; tmp.height=600;
  await renderQRToCanvas(tmp, payload);
  const a=document.createElement("a"); a.download=`myqer-${userCode}.png`; a.href=tmp.toDataURL("image/png"); a.click();
});

$("dlSvg").addEventListener("click", async ()=>{
  // Base SVG QR (no overlay), keeps vectors for print
  const payload = buildOfflinePayload();
  const svg = await QRCode.toString(payload,{type:"svg",width:600,margin:2,color:{dark:"#111111",light:"#FFFFFF"}});
  const branded = svg.replace("</svg>", `
    <rect x="270" y="270" width="60" height="60" rx="8" ry="8" fill="#DC2626"/>
    <text x="300" y="306" text-anchor="middle" font-family="Inter, Arial" font-size="36" fill="#FFFFFF" dominant-baseline="middle">M</text>
  </svg>`);
  const blob=new Blob([branded],{type:"image/svg+xml"}); 
  const a=document.createElement("a"); a.download=`myqer-${userCode}.svg`; a.href=URL.createObjectURL(blob); a.click();
});

$("printQr").addEventListener("click", async ()=>{
  const payload = buildOfflinePayload();
  const w=window.open("","_blank");
  w.document.write(`<html><head><title>QR ${userCode}</title>
    <style>body{font-family:Inter,Arial;padding:24px;text-align:center} .cap{font-family:monospace;margin:10px 0;font-weight:800}</style>
  </head><body>
    <h2>MYQER Emergency QR</h2>
    <canvas id="c" width="360" height="360"></canvas>
    <div class="cap">${userCode}</div>
    <div style="font-family:monospace">${"https://www.myqer.com/c/"+userCode}</div>
    <div style="margin-top:10px;color:#475569;font-size:12px">Contains offline essentials + online link</div>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"><\/script>
    <script>
      (async ()=>{
        const text = ${JSON.stringify(buildOfflinePayload())};
        const canvas = document.getElementById('c');
        await QRCode.toCanvas(canvas, text, {width:360, margin:2, color:{dark:'#111111', light:'#FFFFFF'}});
        // brand
        const ctx = canvas.getContext('2d');
        const b=58; const x=(canvas.width-b)/2, y=(canvas.height-b)/2;
        ctx.fillStyle='#DC2626'; 
        ctx.beginPath(); ctx.moveTo(x+8,y); ctx.lineTo(x+b-8,y); ctx.quadraticCurveTo(x+b,y,x+b,y+8);
        ctx.lineTo(x+b,y+b-8); ctx.quadraticCurveTo(x+b,y+b,x+b-8,y+b);
        ctx.lineTo(x+8,y+b); ctx.quadraticCurveTo(x,y+b,x,y+b-8);
        ctx.lineTo(x,y+8); ctx.quadraticCurveTo(x,y,x+8,y); ctx.fill();
        ctx.fillStyle='#fff'; ctx.font='34px Inter,Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('M', x+b/2, y+b/2+1);
        window.print(); window.close();
      })();
    <\/script>
  </body></html>`);
  w.document.close();
});

/* ----------------- DELETE ----------------- */
$("confirmDelete").addEventListener("input",(e)=>{ $("deleteAccount").disabled = e.target.value!=="DELETE MY ACCOUNT"; });
$("deleteAccount").addEventListener("click", async ()=>{
  try{ if(navigator.onLine){ await supabase.rpc("delete_account"); } }catch{}
  try{ await supabase.auth.signOut(); }catch{}
  try{ localStorage.clear(); sessionStorage.clear(); }catch{}
  toast("Account deleted"); setTimeout(()=>location.replace("index.html"),700);
});

/* ----------------- BOOT ----------------- */
function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

document.addEventListener("DOMContentLoaded", async ()=>{
  onlineChanged();
  // restore last sync footer text if any
  const ls = localStorage.getItem(LS.lastSync); if(ls) $("footSync").innerHTML = "Last sync: <strong>"+ls+"</strong>";
  await guard();
  await ensureCode();
  await Promise.all([loadProfile(), loadHealth(), loadICE()]);
  refreshQR();
});
</script>
</body>
</html>
