<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER™ - Emergency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.5;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(16, 24, 40, 0.08), 0 8px 16px rgba(16, 24, 40, 0.04);
            border: 1px solid rgba(148, 163, 184, 0.2);
            position: relative;
            padding: 32px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            box-shadow: 0 32px 64px rgba(16, 24, 40, 0.12), 0 16px 24px rgba(16, 24, 40, 0.06);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .card {
                border-radius: 20px;
                padding: 24px;
            }
        }
        
        .ribbon {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            border-radius: 24px 24px 0 0;
        }
        
        @media (max-width: 768px) {
            .ribbon {
                border-radius: 20px 20px 0 0;
            }
        }
        
        .ribbon-identity { background: #16a34a; }
        .ribbon-critical { background: #dc2626; }
        .ribbon-ice { background: #ea580c; }
        .ribbon-triage { background: #64748b; }
        .ribbon-vault { background: #7c3aed; }
        .ribbon-qr { background: #f59e0b; }
        .ribbon-danger { background: #dc2626; }
        
        .input-field {
            padding: 14px 16px;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .input-field:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12), 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .field-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        @media (max-width: 640px) {
            .field-pair {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        .label {
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        
        .helper-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
            line-height: 1.4;
        }
        
        .card-helper {
            font-size: 13px;
            color: #64748b;
            margin-top: 20px;
            line-height: 1.5;
            padding-top: 16px;
            border-top: 1px solid #f1f5f9;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            font-weight: 700;
            padding: 14px 28px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background: white;
            color: #475569;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .btn-secondary:hover:not(:disabled) {
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            font-weight: 700;
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.3);
        }
        
        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(220, 38, 38, 0.4);
        }
        
        .btn-danger:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .triage-pill {
            display: inline-block;
            padding: 10px 24px;
            border-radius: 24px;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .triage-green { background: #22c55e; color: white; }
        .triage-yellow { background: #f59e0b; color: white; }
        .triage-red { background: #ef4444; color: white; }
        .triage-black { background: #1f2937; color: white; }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }
        
        .status-online { background: #22c55e; }
        .status-offline { background: #ef4444; }
        .status-hybrid { background: #f59e0b; }
        
        .saved-indicator {
            color: #22c55e;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .saved-indicator.show {
            opacity: 1;
        }
        
        .auto-saved {
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .auto-saved.show {
            opacity: 1;
        }
        
        .qr-container {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            border: 2px solid #f1f5f9;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 32px 80px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border: 1px solid #fca5a5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .warning-box p {
            color: #991b1b;
            font-weight: 600;
            margin: 0;
            line-height: 1.5;
        }
        
        .revoked-banner {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border: 1px solid #fca5a5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .revoked-banner p {
            color: #991b1b;
            font-weight: 600;
            margin: 0;
        }
        
        .grid-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (max-width: 1024px) {
            .grid-layout {
                grid-template-columns: 1fr;
                gap: 24px;
            }
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }
        
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }
        
        @media (max-width: 1024px) {
            .left-column, .right-column {
                gap: 24px;
            }
        }
        
        .danger-zone-card {
            width: 80%;
            margin: 0 auto;
        }
        
        @media (max-width: 1024px) {
            .danger-zone-card {
                width: 100%;
            }
        }
        
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .remember-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #64748b;
        }
        
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .toggle-switch.active {
            background: #22c55e;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        /* RTL Support */
        [dir="rtl"] {
            text-align: right;
        }
        
        [dir="rtl"] .status-dot {
            margin-right: 0;
            margin-left: 10px;
        }
        
        /* Typography Scale */
        h1 { font-size: 28px; font-weight: 800; }
        h2 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        h3 { font-size: 18px; font-weight: 700; }
        h4 { font-size: 16px; font-weight: 700; }
        
        @media (max-width: 768px) {
            h1 { font-size: 24px; }
            h2 { font-size: 18px; }
            h3 { font-size: 16px; }
        }
        
        /* Print styles for emergency card */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-card, .print-card * {
                visibility: visible;
            }
            
            .print-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: 40px;
                box-sizing: border-box;
            }
        }
        
        .print-card {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border: 3px solid #dc2626;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            font-family: 'Inter', sans-serif;
        }
        
        .print-card h1 {
            color: #dc2626;
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 8px 0;
        }
        
        .print-card .subtitle {
            color: #475569;
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 24px 0;
        }
        
        .print-card .patient-name {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 16px 0;
        }
        
        .print-card .triage-display {
            margin: 0 0 24px 0;
        }
        
        .print-card .qr-display {
            margin: 0 0 16px 0;
        }
        
        .print-card .code-display {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            margin: 0 0 16px 0;
        }
        
        .print-card .footer-text {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }
        
        .country-search {
            position: relative;
        }
        
        .country-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        
        .country-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .country-option:hover {
            background: #f8fafc;
        }
        
        .country-option.popular {
            background: #f0f9ff;
            border-bottom: 1px solid #e0f2fe;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-lg border-b border-slate-200">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Left: Brand -->
                <div class="flex items-center space-x-4">
                    <h1 class="text-slate-900">
                        MYQ<span class="text-red-600">ER</span><span class="text-xs align-top text-slate-500">™</span>
                    </h1>
                    <div class="hidden md:block text-slate-600 font-medium" data-i18n="header.dashboard">Emergency Dashboard</div>
                </div>
                
                <!-- Center: Status -->
                <div class="flex items-center">
                    <div class="status-dot status-online" id="statusDot"></div>
                    <span class="text-sm text-slate-600 font-medium" id="statusText" data-i18n="status.online">Online</span>
                </div>
                
                <!-- Right: Controls -->
                <div class="flex items-center space-x-4">
                    <select id="languageSelect" class="input-field text-sm py-2 px-3 w-auto" onchange="handleLanguageChange()">
                        <option value="en">🇺🇸 English</option>
                        <option value="es">🇪🇸 Español</option>
                        <option value="fr">🇫🇷 Français</option>
                        <option value="de">🇩🇪 Deutsch</option>
                        <option value="it">🇮🇹 Italiano</option>
                        <option value="pt">🇵🇹 Português</option>
                        <option value="ro">🇷🇴 Română</option>
                        <option value="ar">🇸🇦 العربية</option>
                        <option value="hi">🇮🇳 हिन्दी</option>
                        <option value="zh">🇨🇳 中文</option>
                    </select>
                    
                    <div class="hidden md:flex flex-col items-end">
                        <div class="text-sm text-slate-600 font-medium" id="userEmail">Loading...</div>
                        <div class="remember-toggle">
                            <span data-i18n="auth.rememberMe">Remember me</span>
                            <div class="toggle-switch active" id="rememberToggle" onclick="toggleRememberMe()"></div>
                        </div>
                    </div>
                    
                    <button data-hook="btn-logout" onclick="logout()" class="btn-primary">
                        🚪 <span data-i18n="auth.logout">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="grid-layout">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Identity Card -->
                <div class="card">
                    <div class="ribbon ribbon-identity"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 data-i18n="identity.title">Identity Profile</h2>
                            <div class="helper-text" data-i18n="identity.helper">Used to identify patient across global systems.</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="saved-indicator" id="identitySaved">✓ <span data-i18n="common.saved">Saved just now</span></div>
                            <div class="auto-saved" id="identityAutoSaved">✓ <span data-i18n="common.autoSaved">Saved just now</span></div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="label" data-i18n="identity.fullName">Full Name</label>
                            <input type="text" id="fullName" class="input-field" data-i18n-placeholder="identity.fullNamePlaceholder" placeholder="Enter your full name" oninput="handleAutoSave('identity')">
                        </div>
                        
                        <div class="field-pair">
                            <div>
                                <label class="label" data-i18n="identity.dob">Date of Birth</label>
                                <input type="date" id="dob" class="input-field" oninput="handleAutoSave('identity')">
                            </div>
                            <div class="country-search">
                                <label class="label" data-i18n="identity.country">Country</label>
                                <input type="text" id="countrySearch" class="input-field" data-i18n-placeholder="identity.countryPlaceholder" placeholder="Search countries..." oninput="filterCountries()" onfocus="showCountryDropdown()" onblur="hideCountryDropdown()">
                                <input type="hidden" id="country" onchange="handleAutoSave('identity')">
                                <div id="countryDropdown" class="country-dropdown"></div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="identity.healthId">Health ID</label>
                            <input type="text" id="healthId" class="input-field" data-i18n-placeholder="identity.healthIdPlaceholder" placeholder="NHS, EHIC, national health number" oninput="handleAutoSave('identity')">
                            <div class="helper-text" data-i18n="identity.healthIdHelper">NHS (UK), CHI (Scotland), HCN (CA), Versicherungsnummer (DE). Do not enter passport/ID.</div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button data-hook="btn-save-profile" onclick="saveIdentity()" class="btn-primary">
                            <span data-i18n="identity.save">Save Identity</span>
                        </button>
                    </div>
                    
                    <div class="card-helper" data-i18n="identity.cardHelper">
                        Used by emergency responders to confirm your identity and contact your healthcare providers.
                    </div>
                </div>

                <!-- Critical Card -->
                <div class="card">
                    <div class="ribbon ribbon-critical"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 data-i18n="critical.title">Critical Medical Info</h2>
                            <div class="helper-text" data-i18n="critical.subtitle">Informational only. Clinicians must verify.</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="saved-indicator" id="criticalSaved">✓ <span data-i18n="common.saved">Saved just now</span></div>
                            <div class="auto-saved" id="criticalAutoSaved">✓ <span data-i18n="common.autoSaved">Saved just now</span></div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="field-pair">
                            <div>
                                <label class="label" data-i18n="critical.bloodType">Blood Type</label>
                                <select id="bloodType" class="input-field" onchange="handleAutoSave('critical')">
                                    <option value="" data-i18n="critical.selectBloodType">Select Blood Type</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            <div>
                                <label class="label" data-i18n="critical.organDonor">Organ Donor</label>
                                <select id="organDonor" class="input-field" onchange="handleAutoSave('critical')">
                                    <option value="" data-i18n="common.select">Select</option>
                                    <option value="Yes" data-i18n="common.yes">Yes</option>
                                    <option value="No" data-i18n="common.no">No</option>
                                    <option value="Unknown" data-i18n="common.unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.allergies">Allergies</label>
                            <textarea id="allergies" rows="3" class="input-field resize-none" data-i18n-placeholder="critical.allergiesPlaceholder" placeholder="List any allergies (e.g., Penicillin, Peanuts, Latex)" oninput="handleAutoSave('critical')"></textarea>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.conditions">Conditions</label>
                            <textarea id="conditions" rows="3" class="input-field resize-none" data-i18n-placeholder="critical.conditionsPlaceholder" placeholder="List medical conditions (e.g., Diabetes, Hypertension, Asthma)" oninput="handleAutoSave('critical')"></textarea>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.medications">Medications</label>
                            <textarea id="medications" rows="3" class="input-field resize-none" data-i18n-placeholder="critical.medicationsPlaceholder" placeholder="List current medications and dosages" oninput="handleAutoSave('critical')"></textarea>
                        </div>
                        
                        <div>
                            <label class="label" data-i18n="critical.resuscitation">Resuscitation Preferences</label>
                            <select id="resuscitationPref" class="input-field" onchange="handleAutoSave('critical')">
                                <option value="" data-i18n="critical.selectResuscitation">Select Preference</option>
                                <option value="full" data-i18n="critical.fullLifeSupport">Full Life Support — All resuscitation efforts (CPR, ventilation, meds)</option>
                                <option value="comfort" data-i18n="critical.comfortCare">Comfort Care Only — Focus on comfort; no life-prolonging measures</option>
                                <option value="dnr" data-i18n="critical.dnr">Do Not Resuscitate (DNR)</option>
                            </select>
                            <div class="helper-text" data-i18n="critical.resuscitationHelper">Guidance only — confirm with official records.</div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button data-hook="btn-save-health" onclick="saveCritical()" class="btn-primary">
                            <span data-i18n="critical.save">Save Critical Info</span>
                        </button>
                    </div>
                    
                    <div class="card-helper" data-i18n="critical.cardHelper">
                        Life-saving information for emergency medical personnel. Keep this updated and accurate.
                    </div>
                </div>

                <!-- ICE Card -->
                <div class="card">
                    <div class="ribbon ribbon-ice"></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 data-i18n="ice.title">In Case of Emergency (ICE)</h2>
                            <div class="helper-text" data-i18n="ice.subtitle">Tap-to-call links help responders connect instantly.</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="saved-indicator" id="iceSaved">✓ <span data-i18n="common.saved">Saved just now</span></div>
                            <div class="auto-saved" id="iceAutoSaved">✓ <span data-i18n="common.autoSaved">Saved just now</span></div>
                        </div>
                    </div>
                    
                    <div id="iceContacts" class="space-y-6">
                        <!-- ICE contacts will be dynamically added here -->
                    </div>
                    
                    <div class="flex justify-between items-center mt-8">
                        <button data-hook="btn-add-ice" onclick="addICEContact()" id="addICEBtn" class="btn-secondary">
                            <span data-i18n="ice.addContact">Add ICE Contact</span>
                        </button>
                        <span class="text-sm text-slate-500 font-medium" id="iceCounter">0/3 <span data-i18n="ice.contacts">contacts</span></span>
                    </div>
                    
                    <div class="card-helper" data-i18n="ice.cardHelper">
                        Emergency contacts who can be reached immediately. First responders will call these numbers.
                    </div>
                </div>

                <!-- Danger Zone Card -->
                <div class="card danger-zone-card">
                    <div class="ribbon ribbon-danger"></div>
                    <h2 class="text-red-600 mb-6">⚠️ <span data-i18n="danger.title">DANGER ZONE</span></h2>
                    
                    <div class="warning-box">
                        <p data-i18n="danger.warning">This action cannot be undone. All your data, QR codes, and ICE contacts will be permanently deleted.</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="label" data-i18n="danger.confirmLabel">Type 'DELETE MY ACCOUNT' to confirm:</label>
                        <input type="text" id="deleteConfirmInput" data-hook="del-input" class="input-field" data-i18n-placeholder="danger.confirmPlaceholder" placeholder="DELETE MY ACCOUNT" oninput="checkDeleteConfirmation()">
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="cancelDelete()" class="btn-secondary">
                            <span data-i18n="common.cancel">Cancel</span>
                        </button>
                        <button onclick="showDeleteModal()" data-hook="btn-del" id="deleteConfirmBtn" class="btn-danger" disabled>
                            <span data-i18n="danger.deleteForever">Delete Account Forever</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Triage Card -->
                <div class="card">
                    <div class="ribbon ribbon-triage"></div>
                    <h2 class="mb-2" data-i18n="triage.title">Triage Assessment</h2>
                    <div class="helper-text mb-6" data-i18n="triage.helper">Automated assessment based on your medical information. Emergency personnel make final decisions.</div>
                    
                    <div class="text-center mb-6">
                        <div class="triage-pill triage-green mb-4" id="triagePill">
                            <span data-i18n="triage.green">GREEN</span>
                        </div>
                        <p class="text-sm text-slate-600" id="triageDescription" data-i18n="triage.greenDesc">
                            Standard emergency protocols apply.
                        </p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="label" data-i18n="triage.override">Override (Optional)</label>
                        <select class="input-field" id="triageOverride" data-hook="triage-override" onchange="handleTriageOverride()">
                            <option value="auto" data-i18n="triage.auto">Auto (Recommended)</option>
                            <option value="green" data-i18n="triage.greenOption">Green - Standard</option>
                            <option value="yellow" data-i18n="triage.yellowOption">Yellow - Urgent</option>
                            <option value="red" data-i18n="triage.redOption">Red - Emergency</option>
                            <option value="black" data-i18n="triage.blackOption">Black - Expectant</option>
                        </select>
                        <div class="helper-text" data-i18n="triage.overrideHelper">Triage color is an aid from patient-provided info. Use clinical judgment.</div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button class="flex-1 btn-secondary" data-hook="btn-speak" onclick="speakTriage()">
                            🔊 <span data-i18n="triage.speak">Speak</span>
                        </button>
                        <button class="flex-1 btn-secondary" data-hook="btn-stop" onclick="stopSpeaking()">
                            ⏹️ <span data-i18n="triage.stop">Stop</span>
                        </button>
                    </div>
                </div>

                <!-- QR & Tags Card -->
                <div class="card">
                    <div class="ribbon ribbon-qr"></div>
                    <h2 class="mb-2" data-i18n="qr.title">QR Code & Tags</h2>
                    <div class="helper-text mb-6" data-i18n="qr.helper">QR contains essential medical info + online link.</div>
                    
                    <div id="qrSection">
                        <div id="noCodeState" class="text-center py-8">
                            <div class="text-6xl mb-4">📱</div>
                            <p class="text-slate-600 mb-6" data-i18n="qr.noCode">No emergency code generated yet</p>
                            <button data-hook="qr-generate" onclick="generateEmergencyCode()" class="btn-primary">
                                🚨 <span data-i18n="qr.generate">Generate Emergency Code</span>
                            </button>
                        </div>
                        
                        <div id="hasCodeState" class="hidden">
                            <div id="revokedBanner" class="revoked-banner hidden">
                                <p>🚫 Revoked — generate a new code.</p>
                            </div>
                            
                            <div class="qr-container">
                                <canvas id="qrCanvas" data-hook="qr-code" width="200" height="200"></canvas>
                            </div>
                            
                            <div class="mb-6">
                                <label class="label" data-i18n="qr.payload">QR Payload</label>
                                <textarea id="qrPayloadDisplay" data-hook="qr-note" class="input-field resize-none bg-gray-50" rows="6" readonly></textarea>
                            </div>
                            
                            <div class="mb-6">
                                <div class="remember-toggle">
                                    <span data-i18n="qr.offlineMode">Offline mode</span>
                                    <div class="toggle-switch active" id="offlineToggle" data-hook="qr-offline-toggle" onclick="toggleOfflineMode()"></div>
                                </div>
                                <div class="helper-text mt-2" data-i18n="qr.offlineHelper">When enabled, QR works without internet connection.</div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <button data-hook="qr-copy" onclick="copyPayload()" class="btn-secondary text-sm py-3" id="copyBtn">
                                    📋 <span data-i18n="qr.copy">Copy</span>
                                </button>
                                <button data-hook="qr-dl-png" onclick="downloadQR('png', 1024)" class="btn-secondary text-sm py-3" id="downloadBtn">
                                    📥 1024px
                                </button>
                                <button onclick="downloadQR('png', 512)" class="btn-secondary text-sm py-3" id="download512Btn">
                                    📥 512px
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-3 mb-6">
                                <button data-hook="qr-rotate" onclick="rotateCode()" class="btn-secondary text-sm py-3" id="rotateBtn">
                                    🔄 <span data-i18n="qr.rotate">Rotate</span>
                                </button>
                                <button data-hook="qr-revoke" onclick="revokeCode()" class="btn-primary text-sm py-3" id="revokeBtn">
                                    🚫 <span data-i18n="qr.revoke">Revoke</span>
                                </button>
                                <button data-hook="qr-print" onclick="printCard()" class="btn-secondary text-sm py-3" id="printBtn">
                                    🖨️ <span data-i18n="qr.print">Print</span>
                                </button>
                            </div>
                            
                            <div class="text-center text-sm text-slate-500">
                                <div><span data-i18n="qr.status">Status:</span> <span id="qrStatus" class="font-semibold text-green-600" data-i18n="qr.active">Active</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vault Card -->
                <div class="card">
                    <div class="ribbon ribbon-vault"></div>
                    <h2 class="mb-2" data-i18n="vault.title">Vault</h2>
                    <div class="helper-text mb-6" data-i18n="vault.helper">Secure storage for legal documents and advanced directives. Features coming soon.</div>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">📄</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.dnr">DNR Directive</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.dnrDesc">Do Not Resuscitate orders</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">📋</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.livingWill">Living Will</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.livingWillDesc">Advanced healthcare directives</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">🏥</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.insurance">Insurance Cards</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.insuranceDesc">Health insurance information</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg opacity-60">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">🔒</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700" data-i18n="vault.secureStorage">Secure Document Storage</h4>
                                        <p class="text-sm text-gray-500" data-i18n="vault.secureStorageDesc">Encrypted document vault</p>
                                    </div>
                                </div>
                                <span class="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded" data-i18n="vault.comingSoon">Coming Soon</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirm Deletion</h3>
            <div class="mb-6">
                <p class="text-gray-700 mb-4">You are about to permanently delete:</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Your identity profile and medical information</li>
                    <li>All emergency contacts (ICE)</li>
                    <li>QR codes and emergency access codes</li>
                    <li>All stored preferences and settings</li>
                </ul>
                <p class="text-red-600 font-semibold mt-4">This action cannot be undone.</p>
            </div>
            <div class="flex gap-4">
                <button onclick="hideDeleteModal()" class="btn-secondary flex-1">Cancel</button>
                <button onclick="deleteAccountForever()" class="btn-danger flex-1">Delete Forever</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
            auth: {
                persistSession: true,
                storage: localStorage
            }
        });

        // Global variables
        let currentUser = null;
        let currentLanguage = 'en';
        let iceContactCount = 0;
        let currentQRCode = null;
        let currentEmergencyCode = null;
        let speechSynthesis = window.speechSynthesis;
        let autoSaveTimeouts = {};
        let rememberMe = true;
        let offlineMode = true;

        // Country data with popular countries first
        const countries = [
            // Popular countries first
            { code: 'US', name: 'United States', flag: '🇺🇸', popular: true },
            { code: 'GB', name: 'United Kingdom', flag: '🇬🇧', popular: true },
            { code: 'CA', name: 'Canada', flag: '🇨🇦', popular: true },
            { code: 'AU', name: 'Australia', flag: '🇦🇺', popular: true },
            { code: 'DE', name: 'Germany', flag: '🇩🇪', popular: true },
            { code: 'FR', name: 'France', flag: '🇫🇷', popular: true },
            { code: 'IT', name: 'Italy', flag: '🇮🇹', popular: true },
            { code: 'ES', name: 'Spain', flag: '🇪🇸', popular: true },
            { code: 'NL', name: 'Netherlands', flag: '🇳🇱', popular: true },
            { code: 'SE', name: 'Sweden', flag: '🇸🇪', popular: true },
            // All other countries
            { code: 'AD', name: 'Andorra', flag: '🇦🇩' },
            { code: 'AE', name: 'United Arab Emirates', flag: '🇦🇪' },
            { code: 'AF', name: 'Afghanistan', flag: '🇦🇫' },
            { code: 'AG', name: 'Antigua and Barbuda', flag: '🇦🇬' },
            { code: 'AI', name: 'Anguilla', flag: '🇦🇮' },
            { code: 'AL', name: 'Albania', flag: '🇦🇱' },
            { code: 'AM', name: 'Armenia', flag: '🇦🇲' },
            { code: 'AO', name: 'Angola', flag: '🇦🇴' },
            { code: 'AQ', name: 'Antarctica', flag: '🇦🇶' },
            { code: 'AR', name: 'Argentina', flag: '🇦🇷' },
            { code: 'AS', name: 'American Samoa', flag: '🇦🇸' },
            { code: 'AT', name: 'Austria', flag: '🇦🇹' },
            { code: 'AW', name: 'Aruba', flag: '🇦🇼' },
            { code: 'AX', name: 'Åland Islands', flag: '🇦🇽' },
            { code: 'AZ', name: 'Azerbaijan', flag: '🇦🇿' },
            { code: 'BA', name: 'Bosnia and Herzegovina', flag: '🇧🇦' },
            { code: 'BB', name: 'Barbados', flag: '🇧🇧' },
            { code: 'BD', name: 'Bangladesh', flag: '🇧🇩' },
            { code: 'BE', name: 'Belgium', flag: '🇧🇪' },
            { code: 'BF', name: 'Burkina Faso', flag: '🇧🇫' },
            { code: 'BG', name: 'Bulgaria', flag: '🇧🇬' },
            { code: 'BH', name: 'Bahrain', flag: '🇧🇭' },
            { code: 'BI', name: 'Burundi', flag: '🇧🇮' },
            { code: 'BJ', name: 'Benin', flag: '🇧🇯' },
            { code: 'BL', name: 'Saint Barthélemy', flag: '🇧🇱' },
            { code: 'BM', name: 'Bermuda', flag: '🇧🇲' },
            { code: 'BN', name: 'Brunei', flag: '🇧🇳' },
            { code: 'BO', name: 'Bolivia', flag: '🇧🇴' },
            { code: 'BQ', name: 'Caribbean Netherlands', flag: '🇧🇶' },
            { code: 'BR', name: 'Brazil', flag: '🇧🇷' },
            { code: 'BS', name: 'Bahamas', flag: '🇧🇸' },
            { code: 'BT', name: 'Bhutan', flag: '🇧🇹' },
            { code: 'BV', name: 'Bouvet Island', flag: '🇧🇻' },
            { code: 'BW', name: 'Botswana', flag: '🇧🇼' },
            { code: 'BY', name: 'Belarus', flag: '🇧🇾' },
            { code: 'BZ', name: 'Belize', flag: '🇧🇿' },
            { code: 'CC', name: 'Cocos Islands', flag: '🇨🇨' },
            { code: 'CD', name: 'Democratic Republic of the Congo', flag: '🇨🇩' },
            { code: 'CF', name: 'Central African Republic', flag: '🇨🇫' },
            { code: 'CG', name: 'Republic of the Congo', flag: '🇨🇬' },
            { code: 'CH', name: 'Switzerland', flag: '🇨🇭' },
            { code: 'CI', name: 'Côte d\'Ivoire', flag: '🇨🇮' },
            { code: 'CK', name: 'Cook Islands', flag: '🇨🇰' },
            { code: 'CL', name: 'Chile', flag: '🇨🇱' },
            { code: 'CM', name: 'Cameroon', flag: '🇨🇲' },
            { code: 'CN', name: 'China', flag: '🇨🇳' },
            { code: 'CO', name: 'Colombia', flag: '🇨🇴' },
            { code: 'CR', name: 'Costa Rica', flag: '🇨🇷' },
            { code: 'CU', name: 'Cuba', flag: '🇨🇺' },
            { code: 'CV', name: 'Cape Verde', flag: '🇨🇻' },
            { code: 'CW', name: 'Curaçao', flag: '🇨🇼' },
            { code: 'CX', name: 'Christmas Island', flag: '🇨🇽' },
            { code: 'CY', name: 'Cyprus', flag: '🇨🇾' },
            { code: 'CZ', name: 'Czech Republic', flag: '🇨🇿' },
            { code: 'DJ', name: 'Djibouti', flag: '🇩🇯' },
            { code: 'DK', name: 'Denmark', flag: '🇩🇰' },
            { code: 'DM', name: 'Dominica', flag: '🇩🇲' },
            { code: 'DO', name: 'Dominican Republic', flag: '🇩🇴' },
            { code: 'DZ', name: 'Algeria', flag: '🇩🇿' },
            { code: 'EC', name: 'Ecuador', flag: '🇪🇨' },
            { code: 'EE', name: 'Estonia', flag: '🇪🇪' },
            { code: 'EG', name: 'Egypt', flag: '🇪🇬' },
            { code: 'EH', name: 'Western Sahara', flag: '🇪🇭' },
            { code: 'ER', name: 'Eritrea', flag: '🇪🇷' },
            { code: 'ET', name: 'Ethiopia', flag: '🇪🇹' },
            { code: 'FI', name: 'Finland', flag: '🇫🇮' },
            { code: 'FJ', name: 'Fiji', flag: '🇫🇯' },
            { code: 'FK', name: 'Falkland Islands', flag: '🇫🇰' },
            { code: 'FM', name: 'Micronesia', flag: '🇫🇲' },
            { code: 'FO', name: 'Faroe Islands', flag: '🇫🇴' },
            { code: 'GA', name: 'Gabon', flag: '🇬🇦' },
            { code: 'GD', name: 'Grenada', flag: '🇬🇩' },
            { code: 'GE', name: 'Georgia', flag: '🇬🇪' },
            { code: 'GF', name: 'French Guiana', flag: '🇬🇫' },
            { code: 'GG', name: 'Guernsey', flag: '🇬🇬' },
            { code: 'GH', name: 'Ghana', flag: '🇬🇭' },
            { code: 'GI', name: 'Gibraltar', flag: '🇬🇮' },
            { code: 'GL', name: 'Greenland', flag: '🇬🇱' },
            { code: 'GM', name: 'Gambia', flag: '🇬🇲' },
            { code: 'GN', name: 'Guinea', flag: '🇬🇳' },
            { code: 'GP', name: 'Guadeloupe', flag: '🇬🇵' },
            { code: 'GQ', name: 'Equatorial Guinea', flag: '🇬🇶' },
            { code: 'GR', name: 'Greece', flag: '🇬🇷' },
            { code: 'GS', name: 'South Georgia', flag: '🇬🇸' },
            { code: 'GT', name: 'Guatemala', flag: '🇬🇹' },
            { code: 'GU', name: 'Guam', flag: '🇬🇺' },
            { code: 'GW', name: 'Guinea-Bissau', flag: '🇬🇼' },
            { code: 'GY', name: 'Guyana', flag: '🇬🇾' },
            { code: 'HK', name: 'Hong Kong', flag: '🇭🇰' },
            { code: 'HM', name: 'Heard Island', flag: '🇭🇲' },
            { code: 'HN', name: 'Honduras', flag: '🇭🇳' },
            { code: 'HR', name: 'Croatia', flag: '🇭🇷' },
            { code: 'HT', name: 'Haiti', flag: '🇭🇹' },
            { code: 'HU', name: 'Hungary', flag: '🇭🇺' },
            { code: 'ID', name: 'Indonesia', flag: '🇮🇩' },
            { code: 'IE', name: 'Ireland', flag: '🇮🇪' },
            { code: 'IL', name: 'Israel', flag: '🇮🇱' },
            { code: 'IM', name: 'Isle of Man', flag: '🇮🇲' },
            { code: 'IN', name: 'India', flag: '🇮🇳' },
            { code: 'IO', name: 'British Indian Ocean Territory', flag: '🇮🇴' },
            { code: 'IQ', name: 'Iraq', flag: '🇮🇶' },
            { code: 'IR', name: 'Iran', flag: '🇮🇷' },
            { code: 'IS', name: 'Iceland', flag: '🇮🇸' },
            { code: 'JE', name: 'Jersey', flag: '🇯🇪' },
            { code: 'JM', name: 'Jamaica', flag: '🇯🇲' },
            { code: 'JO', name: 'Jordan', flag: '🇯🇴' },
            { code: 'JP', name: 'Japan', flag: '🇯🇵' },
            { code: 'KE', name: 'Kenya', flag: '🇰🇪' },
            { code: 'KG', name: 'Kyrgyzstan', flag: '🇰🇬' },
            { code: 'KH', name: 'Cambodia', flag: '🇰🇭' },
            { code: 'KI', name: 'Kiribati', flag: '🇰🇮' },
            { code: 'KM', name: 'Comoros', flag: '🇰🇲' },
            { code: 'KN', name: 'Saint Kitts and Nevis', flag: '🇰🇳' },
            { code: 'KP', name: 'North Korea', flag: '🇰🇵' },
            { code: 'KR', name: 'South Korea', flag: '🇰🇷' },
            { code: 'KW', name: 'Kuwait', flag: '🇰🇼' },
            { code: 'KY', name: 'Cayman Islands', flag: '🇰🇾' },
            { code: 'KZ', name: 'Kazakhstan', flag: '🇰🇿' },
            { code: 'LA', name: 'Laos', flag: '🇱🇦' },
            { code: 'LB', name: 'Lebanon', flag: '🇱🇧' },
            { code: 'LC', name: 'Saint Lucia', flag: '🇱🇨' },
            { code: 'LI', name: 'Liechtenstein', flag: '🇱🇮' },
            { code: 'LK', name: 'Sri Lanka', flag: '🇱🇰' },
            { code: 'LR', name: 'Liberia', flag: '🇱🇷' },
            { code: 'LS', name: 'Lesotho', flag: '🇱🇸' },
            { code: 'LT', name: 'Lithuania', flag: '🇱🇹' },
            { code: 'LU', name: 'Luxembourg', flag: '🇱🇺' },
            { code: 'LV', name: 'Latvia', flag: '🇱🇻' },
            { code: 'LY', name: 'Libya', flag: '🇱🇾' },
            { code: 'MA', name: 'Morocco', flag: '🇲🇦' },
            { code: 'MC', name: 'Monaco', flag: '🇲🇨' },
            { code: 'MD', name: 'Moldova', flag: '🇲🇩' },
            { code: 'ME', name: 'Montenegro', flag: '🇲🇪' },
            { code: 'MF', name: 'Saint Martin', flag: '🇲🇫' },
            { code: 'MG', name: 'Madagascar', flag: '🇲🇬' },
            { code: 'MH', name: 'Marshall Islands', flag: '🇲🇭' },
            { code: 'MK', name: 'North Macedonia', flag: '🇲🇰' },
            { code: 'ML', name: 'Mali', flag: '🇲🇱' },
            { code: 'MM', name: 'Myanmar', flag: '🇲🇲' },
            { code: 'MN', name: 'Mongolia', flag: '🇲🇳' },
            { code: 'MO', name: 'Macao', flag: '🇲🇴' },
            { code: 'MP', name: 'Northern Mariana Islands', flag: '🇲🇵' },
            { code: 'MQ', name: 'Martinique', flag: '🇲🇶' },
            { code: 'MR', name: 'Mauritania', flag: '🇲🇷' },
            { code: 'MS', name: 'Montserrat', flag: '🇲🇸' },
            { code: 'MT', name: 'Malta', flag: '🇲🇹' },
            { code: 'MU', name: 'Mauritius', flag: '🇲🇺' },
            { code: 'MV', name: 'Maldives', flag: '🇲🇻' },
            { code: 'MW', name: 'Malawi', flag: '🇲🇼' },
            { code: 'MX', name: 'Mexico', flag: '🇲🇽' },
            { code: 'MY', name: 'Malaysia', flag: '🇲🇾' },
            { code: 'MZ', name: 'Mozambique', flag: '🇲🇿' },
            { code: 'NA', name: 'Namibia', flag: '🇳🇦' },
            { code: 'NC', name: 'New Caledonia', flag: '🇳🇨' },
            { code: 'NE', name: 'Niger', flag: '🇳🇪' },
            { code: 'NF', name: 'Norfolk Island', flag: '🇳🇫' },
            { code: 'NG', name: 'Nigeria', flag: '🇳🇬' },
            { code: 'NI', name: 'Nicaragua', flag: '🇳🇮' },
            { code: 'NO', name: 'Norway', flag: '🇳🇴' },
            { code: 'NP', name: 'Nepal', flag: '🇳🇵' },
            { code: 'NR', name: 'Nauru', flag: '🇳🇷' },
            { code: 'NU', name: 'Niue', flag: '🇳🇺' },
            { code: 'NZ', name: 'New Zealand', flag: '🇳🇿' },
            { code: 'OM', name: 'Oman', flag: '🇴🇲' },
            { code: 'PA', name: 'Panama', flag: '🇵🇦' },
            { code: 'PE', name: 'Peru', flag: '🇵🇪' },
            { code: 'PF', name: 'French Polynesia', flag: '🇵🇫' },
            { code: 'PG', name: 'Papua New Guinea', flag: '🇵🇬' },
            { code: 'PH', name: 'Philippines', flag: '🇵🇭' },
            { code: 'PK', name: 'Pakistan', flag: '🇵🇰' },
            { code: 'PL', name: 'Poland', flag: '🇵🇱' },
            { code: 'PM', name: 'Saint Pierre and Miquelon', flag: '🇵🇲' },
            { code: 'PN', name: 'Pitcairn', flag: '🇵🇳' },
            { code: 'PR', name: 'Puerto Rico', flag: '🇵🇷' },
            { code: 'PS', name: 'Palestine', flag: '🇵🇸' },
            { code: 'PT', name: 'Portugal', flag: '🇵🇹' },
            { code: 'PW', name: 'Palau', flag: '🇵🇼' },
            { code: 'PY', name: 'Paraguay', flag: '🇵🇾' },
            { code: 'QA', name: 'Qatar', flag: '🇶🇦' },
            { code: 'RE', name: 'Réunion', flag: '🇷🇪' },
            { code: 'RO', name: 'Romania', flag: '🇷🇴' },
            { code: 'RS', name: 'Serbia', flag: '🇷🇸' },
            { code: 'RU', name: 'Russia', flag: '🇷🇺' },
            { code: 'RW', name: 'Rwanda', flag: '🇷🇼' },
            { code: 'SA', name: 'Saudi Arabia', flag: '🇸🇦' },
            { code: 'SB', name: 'Solomon Islands', flag: '🇸🇧' },
            { code: 'SC', name: 'Seychelles', flag: '🇸🇨' },
            { code: 'SD', name: 'Sudan', flag: '🇸🇩' },
            { code: 'SG', name: 'Singapore', flag: '🇸🇬' },
            { code: 'SH', name: 'Saint Helena', flag: '🇸🇭' },
            { code: 'SI', name: 'Slovenia', flag: '🇸🇮' },
            { code: 'SJ', name: 'Svalbard and Jan Mayen', flag: '🇸🇯' },
            { code: 'SK', name: 'Slovakia', flag: '🇸🇰' },
            { code: 'SL', name: 'Sierra Leone', flag: '🇸🇱' },
            { code: 'SM', name: 'San Marino', flag: '🇸🇲' },
            { code: 'SN', name: 'Senegal', flag: '🇸🇳' },
            { code: 'SO', name: 'Somalia', flag: '🇸🇴' },
            { code: 'SR', name: 'Suriname', flag: '🇸🇷' },
            { code: 'SS', name: 'South Sudan', flag: '🇸🇸' },
            { code: 'ST', name: 'São Tomé and Príncipe', flag: '🇸🇹' },
            { code: 'SV', name: 'El Salvador', flag: '🇸🇻' },
            { code: 'SX', name: 'Sint Maarten', flag: '🇸🇽' },
            { code: 'SY', name: 'Syria', flag: '🇸🇾' },
            { code: 'SZ', name: 'Eswatini', flag: '🇸🇿' },
            { code: 'TC', name: 'Turks and Caicos Islands', flag: '🇹🇨' },
            { code: 'TD', name: 'Chad', flag: '🇹🇩' },
            { code: 'TF', name: 'French Southern Territories', flag: '🇹🇫' },
            { code: 'TG', name: 'Togo', flag: '🇹🇬' },
            { code: 'TH', name: 'Thailand', flag: '🇹🇭' },
            { code: 'TJ', name: 'Tajikistan', flag: '🇹🇯' },
            { code: 'TK', name: 'Tokelau', flag: '🇹🇰' },
            { code: 'TL', name: 'Timor-Leste', flag: '🇹🇱' },
            { code: 'TM', name: 'Turkmenistan', flag: '🇹🇲' },
            { code: 'TN', name: 'Tunisia', flag: '🇹🇳' },
            { code: 'TO', name: 'Tonga', flag: '🇹🇴' },
            { code: 'TR', name: 'Turkey', flag: '🇹🇷' },
            { code: 'TT', name: 'Trinidad and Tobago', flag: '🇹🇹' },
            { code: 'TV', name: 'Tuvalu', flag: '🇹🇻' },
            { code: 'TW', name: 'Taiwan', flag: '🇹🇼' },
            { code: 'TZ', name: 'Tanzania', flag: '🇹🇿' },
            { code: 'UA', name: 'Ukraine', flag: '🇺🇦' },
            { code: 'UG', name: 'Uganda', flag: '🇺🇬' },
            { code: 'UM', name: 'United States Minor Outlying Islands', flag: '🇺🇲' },
            { code: 'UY', name: 'Uruguay', flag: '🇺🇾' },
            { code: 'UZ', name: 'Uzbekistan', flag: '🇺🇿' },
            { code: 'VA', name: 'Vatican City', flag: '🇻🇦' },
            { code: 'VC', name: 'Saint Vincent and the Grenadines', flag: '🇻🇨' },
            { code: 'VE', name: 'Venezuela', flag: '🇻🇪' },
            { code: 'VG', name: 'British Virgin Islands', flag: '🇻🇬' },
            { code: 'VI', name: 'U.S. Virgin Islands', flag: '🇻🇮' },
            { code: 'VN', name: 'Vietnam', flag: '🇻🇳' },
            { code: 'VU', name: 'Vanuatu', flag: '🇻🇺' },
            { code: 'WF', name: 'Wallis and Futuna', flag: '🇼🇫' },
            { code: 'WS', name: 'Samoa', flag: '🇼🇸' },
            { code: 'YE', name: 'Yemen', flag: '🇾🇪' },
            { code: 'YT', name: 'Mayotte', flag: '🇾🇹' },
            { code: 'ZA', name: 'South Africa', flag: '🇿🇦' },
            { code: 'ZM', name: 'Zambia', flag: '🇿🇲' },
            { code: 'ZW', name: 'Zimbabwe', flag: '🇿🇼' }
        ];

        // Internationalization
        const translations = {
            en: {
                "header.dashboard": "Emergency Dashboard",
                "status.online": "Online",
                "status.offline": "No signal",
                "status.hybrid": "Hybrid-ready",
                "auth.logout": "Logout",
                "auth.rememberMe": "Remember me",
                "common.saved": "Saved just now",
                "common.autoSaved": "Saved just now",
                "common.select": "Select",
                "common.yes": "Yes",
                "common.no": "No",
                "common.unknown": "Unknown",
                "common.cancel": "Cancel",
                "identity.title": "Identity Profile",
                "identity.helper": "Used to identify patient across global systems.",
                "identity.fullName": "Full Name",
                "identity.fullNamePlaceholder": "Enter your full name",
                "identity.dob": "Date of Birth",
                "identity.country": "Country",
                "identity.countryPlaceholder": "Search countries...",
                "identity.healthId": "Health ID",
                "identity.healthIdPlaceholder": "NHS, EHIC, national health number",
                "identity.healthIdHelper": "NHS (UK), CHI (Scotland), HCN (CA), Versicherungsnummer (DE). Do not enter passport/ID.",
                "identity.save": "Save Identity",
                "identity.cardHelper": "Used by emergency responders to confirm your identity and contact your healthcare providers.",
                "critical.title": "Critical Medical Info",
                "critical.subtitle": "Informational only. Clinicians must verify.",
                "critical.bloodType": "Blood Type",
                "critical.selectBloodType": "Select Blood Type",
                "critical.organDonor": "Organ Donor",
                "critical.allergies": "Allergies",
                "critical.allergiesPlaceholder": "List any allergies (e.g., Penicillin, Peanuts, Latex)",
                "critical.conditions": "Conditions",
                "critical.conditionsPlaceholder": "List medical conditions (e.g., Diabetes, Hypertension, Asthma)",
                "critical.medications": "Medications",
                "critical.medicationsPlaceholder": "List current medications and dosages",
                "critical.resuscitation": "Resuscitation Preferences",
                "critical.selectResuscitation": "Select Preference",
                "critical.fullLifeSupport": "Full Life Support — All resuscitation efforts (CPR, ventilation, meds)",
                "critical.comfortCare": "Comfort Care Only — Focus on comfort; no life-prolonging measures",
                "critical.dnr": "Do Not Resuscitate (DNR)",
                "critical.resuscitationHelper": "Guidance only — confirm with official records.",
                "critical.save": "Save Critical Info",
                "critical.cardHelper": "Life-saving information for emergency medical personnel. Keep this updated and accurate.",
                "ice.title": "In Case of Emergency (ICE)",
                "ice.subtitle": "Tap-to-call links help responders connect instantly.",
                "ice.addContact": "Add ICE Contact",
                "ice.contacts": "contacts",
                "ice.name": "Name",
                "ice.relation": "Relation",
                "ice.phone": "Phone",
                "ice.cardHelper": "Emergency contacts who can be reached immediately. First responders will call these numbers.",
                "triage.title": "Triage Assessment",
                "triage.helper": "Automated assessment based on your medical information. Emergency personnel make final decisions.",
                "triage.green": "GREEN",
                "triage.yellow": "YELLOW",
                "triage.red": "RED",
                "triage.black": "BLACK",
                "triage.greenDesc": "Standard emergency protocols apply.",
                "triage.yellowDesc": "Medical conditions present - monitor closely.",
                "triage.redDesc": "Critical conditions requiring immediate attention.",
                "triage.blackDesc": "Expectant - comfort care priority.",
                "triage.override": "Override (Optional)",
                "triage.auto": "Auto (Recommended)",
                "triage.greenOption": "Green - Standard",
                "triage.yellowOption": "Yellow - Urgent",
                "triage.redOption": "Red - Emergency",
                "triage.blackOption": "Black - Expectant",
                "triage.overrideHelper": "Triage color is an aid from patient-provided info. Use clinical judgment.",
                "triage.speak": "Speak",
                "triage.stop": "Stop",
                "qr.title": "QR Code & Tags",
                "qr.helper": "QR contains essential medical info + online link.",
                "qr.noCode": "No emergency code generated yet",
                "qr.generate": "Generate Emergency Code",
                "qr.payload": "QR Payload",
                "qr.copy": "Copy",
                "qr.rotate": "Rotate",
                "qr.revoke": "Revoke",
                "qr.print": "Print",
                "qr.status": "Status:",
                "qr.active": "Active",
                "qr.revoked": "Revoked",
                "qr.offlineMode": "Offline mode",
                "qr.offlineHelper": "When enabled, QR works without internet connection.",
                "vault.title": "Vault",
                "vault.helper": "Secure storage for legal documents and advanced directives. Features coming soon.",
                "vault.dnr": "DNR Directive",
                "vault.dnrDesc": "Do Not Resuscitate orders",
                "vault.livingWill": "Living Will",
                "vault.livingWillDesc": "Advanced healthcare directives",
                "vault.insurance": "Insurance Cards",
                "vault.insuranceDesc": "Health insurance information",
                "vault.secureStorage": "Secure Document Storage",
                "vault.secureStorageDesc": "Encrypted document vault",
                "vault.comingSoon": "Coming Soon",
                "danger.title": "DANGER ZONE",
                "danger.warning": "This action cannot be undone. All your data, QR codes, and ICE contacts will be permanently deleted.",
                "danger.confirmLabel": "Type 'DELETE MY ACCOUNT' to confirm:",
                "danger.confirmPlaceholder": "DELETE MY ACCOUNT",
                "danger.deleteForever": "Delete Account Forever"
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            await checkSession();
            loadRememberMePreference();
            await loadUserData();
            updateTriageAssessment();
            updateICECounter();
            applyTranslations();
            initializeCountryDropdown();
            
            // Handle page unload for remember me
            window.addEventListener('beforeunload', handleBeforeUnload);
        });

        // Country dropdown functionality
        function initializeCountryDropdown() {
            const dropdown = document.getElementById('countryDropdown');
            renderCountryOptions('');
        }

        function renderCountryOptions(filter = '') {
            const dropdown = document.getElementById('countryDropdown');
            const filteredCountries = countries.filter(country => 
                country.name.toLowerCase().includes(filter.toLowerCase()) ||
                country.code.toLowerCase().includes(filter.toLowerCase())
            );

            dropdown.innerHTML = '';
            
            // Show popular countries first if no filter
            if (!filter) {
                const popularCountries = filteredCountries.filter(c => c.popular);
                const otherCountries = filteredCountries.filter(c => !c.popular);
                
                popularCountries.forEach(country => {
                    const option = document.createElement('div');
                    option.className = 'country-option popular';
                    option.innerHTML = `${country.flag} ${country.name}`;
                    option.onclick = () => selectCountry(country);
                    dropdown.appendChild(option);
                });
                
                if (popularCountries.length > 0 && otherCountries.length > 0) {
                    const separator = document.createElement('div');
                    separator.style.borderTop = '1px solid #e2e8f0';
                    separator.style.margin = '4px 0';
                    dropdown.appendChild(separator);
                }
                
                otherCountries.forEach(country => {
                    const option = document.createElement('div');
                    option.className = 'country-option';
                    option.innerHTML = `${country.flag} ${country.name}`;
                    option.onclick = () => selectCountry(country);
                    dropdown.appendChild(option);
                });
            } else {
                filteredCountries.forEach(country => {
                    const option = document.createElement('div');
                    option.className = 'country-option';
                    option.innerHTML = `${country.flag} ${country.name}`;
                    option.onclick = () => selectCountry(country);
                    dropdown.appendChild(option);
                });
            }
        }

        function selectCountry(country) {
            document.getElementById('countrySearch').value = `${country.flag} ${country.name}`;
            document.getElementById('country').value = country.code;
            hideCountryDropdown();
            handleAutoSave('identity');
        }

        function filterCountries() {
            const input = document.getElementById('countrySearch');
            const filter = input.value;
            renderCountryOptions(filter);
            showCountryDropdown();
        }

        function showCountryDropdown() {
            document.getElementById('countryDropdown').style.display = 'block';
        }

        function hideCountryDropdown() {
            setTimeout(() => {
                document.getElementById('countryDropdown').style.display = 'none';
            }, 200);
        }

        // Session Management
        async function checkSession() {
            try {
                const { data: { session }, error } = await sb.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    location.replace('/');
                    return;
                }
                
                if (!session) {
                    location.replace('/');
                    return;
                }
                
                currentUser = session.user;
                document.getElementById('userEmail').textContent = currentUser.email;
                
                // Update status indicator
                document.getElementById('statusDot').className = 'status-dot status-online';
                document.getElementById('statusText').textContent = translations[currentLanguage]['status.online'] || 'Online';
                
            } catch (error) {
                console.error('Session check failed:', error);
                location.replace('/');
            }
        }

        function loadRememberMePreference() {
            const saved = localStorage.getItem('myqer_remember_me');
            rememberMe = saved !== 'false'; // Default to true
            
            const toggle = document.getElementById('rememberToggle');
            if (rememberMe) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function toggleRememberMe() {
            rememberMe = !rememberMe;
            const toggle = document.getElementById('rememberToggle');
            
            if (rememberMe) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            localStorage.setItem('myqer_remember_me', rememberMe.toString());
        }

        function toggleOfflineMode() {
            offlineMode = !offlineMode;
            const toggle = document.getElementById('offlineToggle');
            
            if (offlineMode) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        async function handleBeforeUnload() {
            if (!rememberMe) {
                await sb.auth.signOut({ scope: 'local' });
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await sb.auth.signOut();
                    location.replace('/');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Logout failed', 'error');
                }
            }
        }

        // Language handling
        async function handleLanguageChange() {
            const select = document.getElementById('languageSelect');
            currentLanguage = select.value;
            
            // Handle RTL for Arabic
            if (currentLanguage === 'ar') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            // Save language preference to database
            try {
                await sb.from('profiles').upsert({
                    id: currentUser.id,
                    language_pref: currentLanguage
                });
            } catch (error) {
                console.error('Failed to save language preference:', error);
            }
            
            applyTranslations();
        }

        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            // Handle placeholders
            const placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
        }

        // Data loading
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load profile data
                const { data: profile } = await sb
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profile) {
                    document.getElementById('fullName').value = profile.full_name || '';
                    document.getElementById('dob').value = profile.dob || '';
                    
                    // Set country with flag
                    if (profile.country) {
                        const country = countries.find(c => c.code === profile.country);
                        if (country) {
                            document.getElementById('countrySearch').value = `${country.flag} ${country.name}`;
                            document.getElementById('country').value = country.code;
                        }
                    }
                    
                    document.getElementById('healthId').value = profile.health_id || '';
                    
                    if (profile.language_pref) {
                        currentLanguage = profile.language_pref;
                        document.getElementById('languageSelect').value = currentLanguage;
                        if (currentLanguage === 'ar') {
                            document.documentElement.setAttribute('dir', 'rtl');
                        }
                    }
                    
                    // Load emergency code if exists
                    if (profile.code) {
                        currentEmergencyCode = profile.code;
                        showQRCodeState();
                        await generateQRCode();
                    }
                }
                
                // Load health profile data
                const { data: healthProfile } = await sb
                    .from('health_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (healthProfile) {
                    document.getElementById('bloodType').value = healthProfile.blood_type || '';
                    document.getElementById('organDonor').value = healthProfile.organ_donor || '';
                    document.getElementById('allergies').value = healthProfile.allergies || '';
                    document.getElementById('conditions').value = healthProfile.conditions || '';
                    document.getElementById('medications').value = healthProfile.meds || '';
                    document.getElementById('resuscitationPref').value = healthProfile.life_support_pref || '';
                    document.getElementById('triageOverride').value = healthProfile.triage_override || 'auto';
                }
                
                // Load ICE contacts
                const { data: iceContacts } = await sb
                    .from('ice_contacts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at');
                
                if (iceContacts) {
                    iceContacts.forEach(contact => {
                        addICEContactWithData(contact);
                    });
                }
                
            } catch (error) {
                console.error('Failed to load user data:', error);
                showToast('Failed to load data', 'error');
            }
        }

        // Auto-save functionality
        function handleAutoSave(section) {
            // Clear existing timeout
            if (autoSaveTimeouts[section]) {
                clearTimeout(autoSaveTimeouts[section]);
            }
            
            // Set new timeout
            autoSaveTimeouts[section] = setTimeout(() => {
                if (section === 'identity') {
                    saveIdentityAuto();
                } else if (section === 'critical') {
                    saveCriticalAuto();
                }
                updateTriageAssessment();
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
            }, 800);
        }

        async function saveIdentityAuto() {
            try {
                const data = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value,
                    health_id: document.getElementById('healthId').value,
                    language_pref: currentLanguage,
                    updated_at: new Date().toISOString(),
                    code: currentEmergencyCode
                };
                
                await sb.from('profiles').upsert(data);
                showAutoSavedIndicator('identityAutoSaved');
                
            } catch (error) {
                console.error('Auto-save identity failed:', error);
            }
        }

        async function saveCriticalAuto() {
            try {
                const data = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value,
                    organ_donor: document.getElementById('organDonor').value,
                    allergies: document.getElementById('allergies').value,
                    conditions: document.getElementById('conditions').value,
                    meds: document.getElementById('medications').value,
                    life_support_pref: document.getElementById('resuscitationPref').value,
                    triage_override: document.getElementById('triageOverride').value
                };
                
                await sb.from('health_profiles').upsert(data);
                showAutoSavedIndicator('criticalAutoSaved');
                
            } catch (error) {
                console.error('Auto-save critical failed:', error);
            }
        }

        // Manual save functions
        async function saveIdentity() {
            try {
                const data = {
                    id: currentUser.id,
                    full_name: document.getElementById('fullName').value,
                    dob: document.getElementById('dob').value || null,
                    country: document.getElementById('country').value,
                    health_id: document.getElementById('healthId').value,
                    language_pref: currentLanguage,
                    updated_at: new Date().toISOString(),
                    code: currentEmergencyCode
                };
                
                await sb.from('profiles').upsert(data);
                showSavedIndicator('identitySaved');
                showToast('Identity saved successfully');
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
                
            } catch (error) {
                console.error('Save identity failed:', error);
                showToast('Failed to save identity', 'error');
            }
        }

        async function saveCritical() {
            try {
                const data = {
                    user_id: currentUser.id,
                    blood_type: document.getElementById('bloodType').value,
                    organ_donor: document.getElementById('organDonor').value,
                    allergies: document.getElementById('allergies').value,
                    conditions: document.getElementById('conditions').value,
                    meds: document.getElementById('medications').value,
                    life_support_pref: document.getElementById('resuscitationPref').value,
                    triage_override: document.getElementById('triageOverride').value
                };
                
                await sb.from('health_profiles').upsert(data);
                showSavedIndicator('criticalSaved');
                showToast('Critical info saved successfully');
                updateTriageAssessment();
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
                
            } catch (error) {
                console.error('Save critical failed:', error);
                showToast('Failed to save critical info', 'error');
            }
        }

        // ICE Contacts
        async function addICEContact() {
            if (iceContactCount >= 3) return;
            
            try {
                const { data, error } = await sb
                    .from('ice_contacts')
                    .insert({
                        user_id: currentUser.id,
                        name: '',
                        relation: '',
                        phone: ''
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                addICEContactWithData(data);
                showAutoSavedIndicator('iceAutoSaved');
                
            } catch (error) {
                console.error('Failed to add ICE contact:', error);
                showToast('Failed to add contact', 'error');
            }
        }

        function addICEContactWithData(contact) {
            iceContactCount++;
            const container = document.getElementById('iceContacts');
            const contactDiv = document.createElement('div');
            contactDiv.className = 'space-y-4 p-6 border border-slate-200 rounded-lg bg-slate-50/50';
            contactDiv.id = `iceContact${contact.id}`;
            
            contactDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold text-slate-700">Contact ${iceContactCount}</h4>
                    <button onclick="removeICEContact(${contact.id})" class="text-red-600 hover:text-red-700 text-sm font-medium">Remove</button>
                </div>
                <div class="field-pair">
                    <div>
                        <label class="label" data-i18n="ice.name">Name</label>
                        <input type="text" class="input-field" value="${contact.name || ''}" oninput="updateICEContact(${contact.id}, 'name', this.value)">
                    </div>
                    <div>
                        <label class="label" data-i18n="ice.relation">Relation</label>
                        <input type="text" class="input-field" value="${contact.relation || ''}" oninput="updateICEContact(${contact.id}, 'relation', this.value)">
                    </div>
                </div>
                <div>
                    <label class="label" data-i18n="ice.phone">Phone</label>
                    <input type="tel" class="input-field" value="${contact.phone || ''}" oninput="updateICEContact(${contact.id}, 'phone', this.value)">
                </div>
            `;
            
            container.appendChild(contactDiv);
            updateICECounter();
            applyTranslations();
        }

        async function updateICEContact(contactId, field, value) {
            try {
                // Normalize phone to E.164 format if it's a phone field
                if (field === 'phone') {
                    value = normalizePhoneNumber(value);
                }
                
                await sb
                    .from('ice_contacts')
                    .update({ [field]: value })
                    .eq('id', contactId);
                
                showAutoSavedIndicator('iceAutoSaved');
                
                // Update QR code if it exists
                if (currentEmergencyCode) {
                    generateQRCode();
                }
                
            } catch (error) {
                console.error('Failed to update ICE contact:', error);
            }
        }

        async function removeICEContact(contactId) {
            try {
                await sb
                    .from('ice_contacts')
                    .delete()
                    .eq('id', contactId);
                
                const contact = document.getElementById(`iceContact${contactId}`);
                if (contact) {
                    contact.remove();
                    iceContactCount--;
                    updateICECounter();
                    showAutoSavedIndicator('iceAutoSaved');
                    
                    // Update QR code if it exists
                    if (currentEmergencyCode) {
                        generateQRCode();
                    }
                }
                
            } catch (error) {
                console.error('Failed to remove ICE contact:', error);
                showToast('Failed to remove contact', 'error');
            }
        }

        function normalizePhoneNumber(phone) {
            // Basic E.164 normalization - remove spaces, keep leading +
            let normalized = phone.replace(/\s+/g, '');
            if (normalized && !normalized.startsWith('+')) {
                // Add + if it looks like an international number
                if (normalized.length > 10) {
                    normalized = '+' + normalized;
                }
            }
            return normalized;
        }

        function updateICECounter() {
            const counter = document.getElementById('iceCounter');
            const addBtn = document.getElementById('addICEBtn');
            
            counter.innerHTML = `${iceContactCount}/3 <span data-i18n="ice.contacts">contacts</span>`;
            
            if (iceContactCount >= 3) {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            applyTranslations();
        }

        // Triage Assessment
        function updateTriageAssessment() {
            const allergies = document.getElementById('allergies').value.toLowerCase();
            const conditions = document.getElementById('conditions').value.toLowerCase();
            const override = document.getElementById('triageOverride').value;
            
            let triageLevel = 'green';
            
            if (override !== 'auto') {
                triageLevel = override;
            } else {
                // Triage logic
                const criticalAllergies = ['anaphylaxis', 'anaphylactic', 'epipen', 'severe'];
                const criticalConditions = ['seizure disorder', 'insulin pump', 'anticoagulant', 'pacemaker'];
                
                const hasCriticalAllergy = criticalAllergies.some(term => allergies.includes(term));
                const hasCriticalCondition = criticalConditions.some(term => conditions.includes(term));
                
                if (hasCriticalAllergy || hasCriticalCondition) {
                    triageLevel = 'red';
                } else if (allergies.trim() || conditions.trim()) {
                    triageLevel = 'yellow';
                }
            }
            
            updateTriageDisplay(triageLevel);
        }

        function updateTriageDisplay(level) {
            const pill = document.getElementById('triagePill');
            const description = document.getElementById('triageDescription');
            
            pill.className = `triage-pill triage-${level} mb-4`;
            
            const levelText = {
                green: translations[currentLanguage]['triage.green'] || 'GREEN',
                yellow: translations[currentLanguage]['triage.yellow'] || 'YELLOW',
                red: translations[currentLanguage]['triage.red'] || 'RED',
                black: translations[currentLanguage]['triage.black'] || 'BLACK'
            };
            
            const descText = {
                green: translations[currentLanguage]['triage.greenDesc'] || 'Standard emergency protocols apply.',
                yellow: translations[currentLanguage]['triage.yellowDesc'] || 'Medical conditions present - monitor closely.',
                red: translations[currentLanguage]['triage.redDesc'] || 'Critical conditions requiring immediate attention.',
                black: translations[currentLanguage]['triage.blackDesc'] || 'Expectant - comfort care priority.'
            };
            
            pill.querySelector('span').textContent = levelText[level];
            description.textContent = descText[level];
        }

        function handleTriageOverride() {
            updateTriageAssessment();
            handleAutoSave('critical');
        }

        // Speech functionality
        async function speakTriage() {
            if (!speechSynthesis) return;
            
            try {
                // Build speech content from current data
                const name = document.getElementById('fullName').value || 'Unknown patient';
                const dob = document.getElementById('dob').value || 'Unknown date of birth';
                const allergies = document.getElementById('allergies').value || 'No known allergies';
                const conditions = document.getElementById('conditions').value || 'No known conditions';
                const medications = document.getElementById('medications').value || 'No current medications';
                
                // Get first ICE contact
                const firstIceContact = document.querySelector('#iceContacts .input-field');
                const iceContact = firstIceContact ? firstIceContact.value || 'No emergency contact' : 'No emergency contact';
                
                const speechText = `Patient: ${name}. Date of birth: ${dob}. Critical allergies: ${allergies}. Medical conditions: ${conditions}. Current medications: ${medications}. Emergency contact: ${iceContact}.`;
                
                const utterance = new SpeechSynthesisUtterance(speechText);
                
                // Set language based on current preference
                const langMap = {
                    'en': 'en-US',
                    'es': 'es-ES',
                    'fr': 'fr-FR',
                    'de': 'de-DE',
                    'it': 'it-IT',
                    'pt': 'pt-PT',
                    'ro': 'ro-RO',
                    'ar': 'ar-SA',
                    'hi': 'hi-IN',
                    'zh': 'zh-CN'
                };
                
                utterance.lang = langMap[currentLanguage] || 'en-US';
                speechSynthesis.speak(utterance);
                
            } catch (error) {
                console.error('Speech synthesis failed:', error);
                showToast('Speech synthesis failed', 'error');
            }
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // QR Code System
        async function generateEmergencyCode() {
            // Check if minimal fields are present
            const name = document.getElementById('fullName').value.trim();
            const dob = document.getElementById('dob').value;
            const country = document.getElementById('country').value;
            
            if (!name || !dob || !country) {
                showToast('Please fill in Name, Date of Birth, and Country first', 'warning');
                return;
            }
            
            try {
                // Generate new emergency code
                currentEmergencyCode = 'MYQER-' + Math.random().toString(36).slice(2, 9).toUpperCase();
                
                // Save to database
                await sb.from('profiles').upsert({
                    id: currentUser.id,
                    code: currentEmergencyCode
                });
                
                showQRCodeState();
                await generateQRCode();
                showToast('Emergency code generated successfully');
                
            } catch (error) {
                console.error('Failed to generate emergency code:', error);
                showToast('Failed to generate emergency code', 'error');
            }
        }

        function showQRCodeState() {
            document.getElementById('noCodeState').classList.add('hidden');
            document.getElementById('hasCodeState').classList.remove('hidden');
            document.getElementById('revokedBanner').classList.add('hidden');
            
            // Enable buttons
            const buttons = ['copyBtn', 'downloadBtn', 'download512Btn', 'printBtn', 'rotateBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
            
            // Update status
            document.getElementById('qrStatus').textContent = translations[currentLanguage]['qr.active'] || 'Active';
            document.getElementById('qrStatus').className = 'font-semibold text-green-600';
        }

        function showRevokedState() {
            document.getElementById('revokedBanner').classList.remove('hidden');
            
            // Disable buttons
            const buttons = ['copyBtn', 'downloadBtn', 'download512Btn', 'printBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
            
            // Update status
            document.getElementById('qrStatus').textContent = translations[currentLanguage]['qr.revoked'] || 'Revoked';
            document.getElementById('qrStatus').className = 'font-semibold text-red-600';
        }

        async function generateQRCode() {
            if (!currentEmergencyCode) return;
            
            try {
                // Build compact payload
                const payload = await buildQRPayload();
                
                // Generate QR code
                const canvas = document.getElementById('qrCanvas');
                await QRCode.toCanvas(canvas, payload, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                // Update payload display
                document.getElementById('qrPayloadDisplay').value = payload;
                currentQRCode = payload;
                
            } catch (error) {
                console.error('Failed to generate QR code:', error);
                showToast('Failed to generate QR code', 'error');
            }
        }

        async function buildQRPayload() {
            // Get current data
            const name = document.getElementById('fullName').value || 'Unknown';
            const dob = document.getElementById('dob').value;
            const bloodType = document.getElementById('bloodType').value || 'Unknown';
            const organDonor = document.getElementById('organDonor').value || 'Unknown';
            const allergies = document.getElementById('allergies').value || 'None reported';
            const conditions = document.getElementById('conditions').value || 'None reported';
            const medications = document.getElementById('medications').value || 'None reported';
            
            // Get triage level
            const triageLevel = getCurrentTriageLevel();
            
            // Format DOB
            let formattedDOB = 'Unknown';
            if (dob) {
                const date = new Date(dob);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                formattedDOB = `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
            }
            
            // Get first ICE contact
            let iceContact = 'None';
            try {
                const { data: iceContacts } = await sb
                    .from('ice_contacts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at')
                    .limit(1);
                
                if (iceContacts && iceContacts.length > 0) {
                    const contact = iceContacts[0];
                    iceContact = `${contact.name || 'Unknown'}, ${contact.phone || 'No phone'}`;
                }
            } catch (error) {
                console.error('Failed to load ICE contact for QR:', error);
            }
            
            // Truncate long lists
            const truncateList = (text, maxLength = 60) => {
                if (text.length <= maxLength) return text;
                const truncated = text.substring(0, maxLength);
                const lastComma = truncated.lastIndexOf(',');
                if (lastComma > 0) {
                    return truncated.substring(0, lastComma) + ', +more';
                }
                return truncated + '...';
            };
            
            const truncatedAllergies = truncateList(allergies);
            const truncatedConditions = truncateList(conditions);
            const truncatedMedications = truncateList(medications);
            
            // Build payload (≤800 chars)
            const payload = `EMERGENCY: ${name}
DOB: ${formattedDOB}  TRIAGE: ${triageLevel.toUpperCase()}
BLOOD: ${bloodType}  DONOR: ${organDonor}
ALLERGIES: ${truncatedAllergies}
CONDITIONS: ${truncatedConditions}
MEDS: ${truncatedMedications}
ICE: ${iceContact}
MYQER: myqer.com/qr/${currentEmergencyCode.replace('MYQER-', '')}`;
            
            return payload;
        }

        function getCurrentTriageLevel() {
            const pill = document.getElementById('triagePill');
            if (pill.classList.contains('triage-red')) return 'red';
            if (pill.classList.contains('triage-yellow')) return 'yellow';
            if (pill.classList.contains('triage-black')) return 'black';
            return 'green';
        }

        async function copyPayload() {
            if (!currentQRCode) return;
            
            try {
                await navigator.clipboard.writeText(currentQRCode);
                showToast('QR payload copied to clipboard');
            } catch (error) {
                console.error('Failed to copy payload:', error);
                showToast('Failed to copy payload', 'error');
            }
        }

        async function downloadQR(format, size) {
            if (!currentQRCode) return;
            
            try {
                // Create a temporary canvas for high-res export
                const tempCanvas = document.createElement('canvas');
                await QRCode.toCanvas(tempCanvas, currentQRCode, {
                    width: size,
                    margin: 4, // Quiet zone = 4 modules
                    color: {<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976ba33931f0591e',t:'MTc1NjQ2NjIwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
