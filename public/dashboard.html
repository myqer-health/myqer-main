<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MYQER™ Dashboard</title>
  <!-- CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{--myqer-red:#dc2626}
    html,body{font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff}
    .glass{background:rgba(255,255,255,.9);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .btn-primary{background:var(--myqer-red);color:#fff;font-weight:700;border-radius:.75rem;padding:.75rem 1rem}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .tag{display:inline-flex;align-items:center;gap:.25rem;background:#e5e7eb;color:#111;padding:.25rem .5rem;border-radius:999px;font-size:.825rem}
    .tag button{color:#6b7280}
    .toast{position:fixed;top:20px;right:20px;z-index:1000;background:#111;color:#fff;padding:.75rem 1rem;border-radius:.5rem;opacity:0;transform:translateY(-8px);transition:.25s}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body class="min-h-screen">

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Header -->
  <header class="w-full border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="text-2xl font-extrabold">MYQ<span class="text-red-600">ER</span>™</div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 text-sm text-gray-700">
          <span id="netDot" class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse"></span>
          <span id="netLabel">Online</span>
        </div>
        <button id="logoutBtn" class="text-sm font-semibold hover:text-red-600">Logout</button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">

    <!-- Profile Completion -->
    <section class="glass rounded-2xl p-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold">Profile Completion</h2>
        <p class="text-gray-600">Complete your emergency profile.</p>
      </div>
      <div class="flex items-center gap-6">
        <div class="relative w-20 h-20">
          <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 36 36">
            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e5e7eb" stroke-width="3"/>
            <path id="progressArc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#dc2626" stroke-width="3" stroke-dasharray="0,100"/>
          </svg>
          <div class="absolute inset-0 grid place-items-center">
            <span id="progressPct" class="text-xl font-bold">0%</span>
          </div>
        </div>
        <ul class="text-sm space-y-1">
          <li><span id="chkIdentity" class="font-bold text-amber-600">○</span> Identity</li>
          <li><span id="chkHealth" class="font-bold text-amber-600">○</span> Health</li>
          <li><span id="chkContacts" class="font-bold text-amber-600">○</span> ICE</li>
          <li><span id="chkQR" class="font-bold text-amber-600">○</span> QR</li>
        </ul>
      </div>
    </section>

    <!-- Identity + Health -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Identity -->
      <div class="glass rounded-2xl p-6 border-l-4 border-green-500">
        <div class="flex items-start justify-between mb-6">
          <div>
            <h3 class="text-xl font-bold">Identity Information</h3>
            <p class="text-gray-600 text-sm">Helps first responders confirm who you are.</p>
          </div>
          <div id="iconIdentity" class="w-8 h-8 rounded-full grid place-items-center bg-amber-500 text-white">○</div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium mb-1">Full Legal Name *</label>
            <input id="full_name" type="text" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Jane Doe" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Date of Birth *</label>
            <input id="date_of_birth" type="text" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="DD/MM/YYYY" required>
            <p class="text-xs text-gray-500 mt-1">Format: DD/MM/YYYY</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Country of Residence *</label>
            <select id="country" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" required>
              <option value="">Select your country</option>
              <option value="GB">🇬🇧 United Kingdom</option>
              <option value="US">🇺🇸 United States</option>
              <option value="CA">🇨🇦 Canada</option>
              <option value="DE">🇩🇪 Germany</option>
              <option value="FR">🇫🇷 France</option>
              <option value="ES">🇪🇸 Spain</option>
              <option value="IT">🇮🇹 Italy</option>
              <option value="IN">🇮🇳 India</option>
              <option value="CN">🇨🇳 China</option>
              <option value="AU">🇦🇺 Australia</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">National Health ID</label>
            <input id="national_health_id" type="text" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="NHS Number, SSN, etc."/>
            <p class="text-xs text-gray-500 mt-1">Stored privately. Not shown on your public card.</p>
          </div>
        </div>
      </div>

      <!-- Health -->
      <div class="glass rounded-2xl p-6 border-l-4 border-red-500">
        <div class="flex items-start justify-between mb-6">
          <div>
            <h3 class="text-xl font-bold">Health Profile</h3>
            <p class="text-gray-600 text-sm">Appears on your emergency card. Keep accurate.</p>
          </div>
          <div id="iconHealth" class="w-8 h-8 rounded-full grid place-items-center bg-amber-500 text-white">○</div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium mb-1">Blood Type</label>
            <select id="blood_type" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
              <option value="">Select blood type</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
              <option>Unknown</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Organ Donor Status</label>
            <select id="organ_donor" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
              <option value="">Select status</option>
              <option value="yes">Yes (Registered)</option>
              <option value="no">No (Not a donor)</option>
              <option value="unspecified">Not specified</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Life Support Preference</label>
            <select id="life_support_pref" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
              <option value="">Select preference</option>
              <option value="Full">Full Life Support</option>
              <option value="Limited">Limited</option>
              <option value="Comfort">Comfort Care Only</option>
              <option value="DNR">DNR</option>
            </select>
          </div>

          <!-- Allergies / Conditions / Meds -->
          <div>
            <label class="block text-sm font-semibold">Critical Allergies ⚠️</label>
            <div id="allergiesPills" class="flex flex-wrap gap-2 my-2"></div>
            <input id="allergiesInput" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Type allergy and press Enter"/>
            <p class="text-xs text-gray-500 mt-1">Drug/food/environmental (e.g., Penicillin, Peanut).</p>
          </div>

          <div>
            <label class="block text-sm font-semibold">Medical Conditions</label>
            <div id="conditionsPills" class="flex flex-wrap gap-2 my-2"></div>
            <input id="conditionsInput" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Type condition and press Enter"/>
          </div>

          <div>
            <label class="block text-sm font-semibold">Medications</label>
            <div id="medicationsPills" class="flex flex-wrap gap-2 my-2"></div>
            <input id="medicationsInput" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="Type medication and press Enter"/>
          </div>
        </div>
      </div>
    </section>

    <!-- Triage -->
    <section class="glass rounded-2xl p-6 border-l-4 border-amber-500">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <h3 class="text-xl font-bold">Triage</h3>
          <p class="text-gray-600 text-sm">Auto-computed from your data. You can override.</p>
          <p class="text-xs text-gray-500 mt-1">Disclaimer: MYQER does not diagnose or provide medical advice. This triage label is user-provided and assistive only for responders.</p>
        </div>
        <div id="triageBadge" class="inline-flex items-center px-6 py-3 rounded-full text-white text-lg font-bold bg-green-600">
          🟢 <span class="ml-2">Green — Stable</span>
        </div>
      </div>
      <div class="mt-4 max-w-sm">
        <label class="block text-sm font-medium mb-1">Override</label>
        <select id="triage_override" class="w-full border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600">
          <option value="auto">Auto (recommended)</option>
          <option value="Green">Green — Stable</option>
          <option value="Amber">Amber — Urgent</option>
          <option value="Red">Red — Immediate</option>
          <option value="Black">Black — Comfort Care</option>
        </select>
      </div>
    </section>

    <!-- ICE + QR -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- ICE -->
      <div class="glass rounded-2xl p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold">ICE Contacts</h3>
            <p class="text-gray-600 text-sm"><span id="contactsCounter">0</span> of 5 added</p>
          </div>
          <button id="addContact" class="btn-primary">Add Contact</button>
        </div>
        <div id="contactsList" class="space-y-3"></div>
        <div id="noContacts" class="text-sm text-gray-500">Add people you trust. Name and phone are required.</div>
      </div>

      <!-- QR -->
      <div class="glass rounded-2xl p-6 border-l-4 border-gray-800">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">Your QR Code</h3>
          <button id="generateQR" class="btn-primary">Generate</button>
        </div>
        <p class="text-gray-600 text-sm mb-4">Single, permanent code for your public emergency card.</p>
        <div id="qrBox" class="border rounded-xl h-52 grid place-items-center mb-3 overflow-hidden bg-white"></div>

        <div class="flex items-center gap-2 mb-3">
          <input id="shareLink" class="flex-1 border rounded-lg px-3 py-2 text-sm" readonly placeholder="Share link"/>
          <button id="copyLink" class="px-3 py-2 border rounded-lg text-sm">Copy</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="exportPNG" class="px-3 py-2 border rounded-lg text-sm" disabled>Export PNG</button>
          <button id="printQR" class="px-3 py-2 border rounded-lg text-sm" disabled>Print</button>
        </div>
      </div>
    </section>

    <!-- Danger Zone -->
    <section class="glass rounded-2xl p-8 border border-red-200 text-center">
      <h3 class="text-xl font-bold mb-2 text-red-700">Danger Zone</h3>
      <p class="text-gray-700 mb-4">This will delete your profile, health data, contacts, and disable your QR.</p>
      <div class="max-w-sm mx-auto">
        <input id="confirmDelete" class="w-full border rounded-lg px-4 py-3 mb-3" placeholder='Type "DELETE" to confirm'/>
        <button id="deleteAccount" class="btn-primary w-full" disabled>Delete Account</button>
      </div>
    </section>

  </main>

  <script>
    // ---------- Supabase ----------
    const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ---------- State ----------
    let currentUser = null;
    let profile = null;     // profiles row
    let health = null;      // health_profiles row
    let contacts = [];      // ice_contacts rows

    const $ = (sel) => document.querySelector(sel);

    // ---------- Boot / guard ----------
    document.addEventListener('DOMContentLoaded', async () => {
      // simple online indicator
      const setNet = () => {
        $('#netDot').className = 'w-2.5 h-2.5 rounded-full ' + (navigator.onLine ? 'bg-green-500 animate-pulse':'bg-gray-400');
        $('#netLabel').textContent = navigator.onLine ? 'Online' : 'Offline';
      };
      window.addEventListener('online', setNet); window.addEventListener('offline', setNet); setNet();

      // route guard
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user || null;
      if (!currentUser) {
        location.replace('/index.html'); return;
      }

      // wire events
      wireEvents();

      // load all
      await loadAll();

      // QR on load
      await ensureQrRendered();
    });

    supabase.auth.onAuthStateChange((ev) => {
      if (ev === 'SIGNED_OUT') location.replace('/index.html');
    });

    // ---------- Events ----------
    function wireEvents(){
      // logout
      $('#logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
      });

      // identity autosave (debounced)
      ['#full_name','#date_of_birth','#national_health_id'].forEach(id=>{
        $(id).addEventListener('input', ()=>debouncedSave(identitySave, 650));
        $(id).addEventListener('blur',  ()=>debouncedSave(identitySave, 50));
      });
      $('#country').addEventListener('change', ()=>identitySave());

      // health dropdown autosave
      ['#blood_type','#organ_donor','#life_support_pref'].forEach(id=>{
        $(id).addEventListener('change', ()=>saveHealthFields());
      });

      // pills: Enter adds, blur also adds & saves
      $('#allergiesInput').addEventListener('keydown', e=>pillKey(e,'allergies'));
      $('#conditionsInput').addEventListener('keydown', e=>pillKey(e,'conditions'));
      $('#medicationsInput').addEventListener('keydown', e=>pillKey(e,'medications'));
      $('#allergiesInput').addEventListener('blur', e=>addBlurToPills(e,'allergies'));
      $('#conditionsInput').addEventListener('blur', e=>addBlurToPills(e,'conditions'));
      $('#medicationsInput').addEventListener('blur', e=>addBlurToPills(e,'medications'));

      // triage override
      $('#triage_override').addEventListener('change', async ()=>{
        const v = $('#triage_override').value;
        health = health || {};
        health.triage_override = (v==='auto'?null:v);
        await upsertHealth({ triage_override: health.triage_override });
        updateTriage();
      });

      // ICE CRUD
      $('#addContact').addEventListener('click', createBlankContact);
      $('#contactsList').addEventListener('input', iceAutosaveHandler);
      $('#contactsList').addEventListener('change', iceAutosaveHandler);
      $('#contactsList').addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-del]');
        if (!btn) return;
        const id = Number(btn.getAttribute('data-del')); // ensure number
        await supabase.from('ice_contacts').delete().eq('id', id).eq('user_id', currentUser.id);
        contacts = contacts.filter(c=>c.id!==id);
        renderContacts();
        showToast('Contact deleted');
        updateProgress();
      });

      // QR actions
      $('#generateQR').addEventListener('click', onGenerateQR);
      $('#copyLink').addEventListener('click', copyShareLink);
      $('#exportPNG').addEventListener('click', exportQrPng);
      $('#printQR').addEventListener('click', ()=>{ const u=$('#shareLink').value; if(u) window.open(u,'_blank'); });

      // Danger zone
      $('#confirmDelete').addEventListener('input', ()=>{
        $('#deleteAccount').disabled = ($('#confirmDelete').value.trim().toUpperCase()!=='DELETE');
      });
      $('#deleteAccount').addEventListener('click', doDeleteAccount);
    }

    // ---------- Loaders ----------
    async function loadAll(){
      const [pRes, hRes, cRes] = await Promise.all([
        supabase.from('profiles').select('*').eq('id', currentUser.id).maybeSingle(),
        supabase.from('health_profiles').select('*').eq('user_id', currentUser.id).maybeSingle(),
        supabase.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at',{ascending:true})
      ]);
      if (!pRes.error) profile = pRes.data || null;
      if (!hRes.error) health  = hRes.data  || null;
      if (!cRes.error) contacts = cRes.data || [];

      hydrateIdentity();
      hydrateHealth();
      renderContacts();
      updateTriage();
      updateProgress();
    }

    // ---------- Identity ----------
    function hydrateIdentity(){
      $('#full_name').value = profile?.full_name || '';
      $('#date_of_birth').value = profile?.date_of_birth || '';
      $('#country').value = profile?.country || '';
      $('#national_health_id').value = profile?.national_health_id || '';
    }

    let identTimer=null;
    function debouncedSave(fn,ms){ clearTimeout(identTimer); identTimer=setTimeout(fn,ms); }

    async function identitySave(){
      const patch = {
        id: currentUser.id, // include PK for upsert
        full_name: $('#full_name').value.trim(),
        date_of_birth: $('#date_of_birth').value.trim(),
        country: $('#country').value,
        national_health_id: $('#national_health_id').value.trim(),
        updated_at: new Date().toISOString()
      };
      const { data, error } = await supabase.from('profiles').upsert(patch, { onConflict:'id' }).select().maybeSingle();
      if (!error) {
        profile = data || patch;
        showToast('Identity saved');
        updateProgress();
      }
    }

    // ---------- Health ----------
    function hydrateHealth(){
      const hp = health || {};
      $('#blood_type').value = hp.blood_type || '';
      $('#organ_donor').value = (hp.organ_donor===true?'yes':hp.organ_donor===false?'no':(hp.organ_donor===null? '': (hp.organ_donor||'')));
      $('#life_support_pref').value = hp.life_support_pref || '';

      hydratePills('allergiesPills', hp.allergies);
      hydratePills('conditionsPills', hp.conditions);
      hydratePills('medicationsPills', hp.medications);
    }

    function hydratePills(containerId, csv){
      const box = document.getElementById(containerId);
      box.innerHTML='';
      (csv?String(csv).split(','):[]).map(s=>s.trim()).filter(Boolean)
        .forEach(val=> box.appendChild(makePill(val, containerId)));
    }

    function makePill(text, containerId){
      const span = document.createElement('span');
      span.className='tag';
      span.innerHTML = `<span>${escapeHtml(text)}</span><button aria-label="Remove">×</button>`;
      span.querySelector('button').addEventListener('click', async ()=>{
        span.remove(); await saveHealthPills(containerId);
      });
      return span;
    }

    function pillKey(e, kind){
      if (e.key!=='Enter') return;
      e.preventDefault();
      addValueToPills(e.target.value, kind);
      e.target.value='';
    }

    function addBlurToPills(e, kind){
      const v = (e.target.value||'').trim();
      if (!v) return;
      addValueToPills(v, kind);
      e.target.value='';
    }

    function addValueToPills(raw, kind){
      const map = { allergies:'allergiesPills', conditions:'conditionsPills', medications:'medicationsPills' };
      const cont = document.getElementById(map[kind]);
      raw.split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean)
        .forEach(tok => cont.appendChild(makePill(tok, cont.id)));
      saveHealthPills(cont.id);
    }

    async function saveHealthPills(containerId){
      const vals = Array.from(document.getElementById(containerId).querySelectorAll('.tag span:first-child'))
        .map(n=>n.textContent.trim()).filter(Boolean);
      const csv = Array.from(new Set(vals.map(v=>v.toLowerCase()))).map(v=>v).join(', ');
      const patch = {};
      if (containerId==='allergiesPills') patch.allergies = csv || null;
      if (containerId==='conditionsPills') patch.conditions = csv || null;
      if (containerId==='medicationsPills') patch.medications = csv || null;
      await upsertHealth(patch);
      showToast('Health saved');
      updateTriage();
      updateProgress();
    }

    async function saveHealthFields(){
      const organVal = $('#organ_donor').value;
      const patch = {
        blood_type: $('#blood_type').value || null,
        organ_donor: (organVal==='yes'?true:organVal==='no'?false:null),
        life_support_pref: $('#life_support_pref').value || null
      };
      await upsertHealth(patch);
      showToast('Health saved');
      updateTriage();
      updateProgress();
    }

    async function upsertHealth(patch){
      health = {...(health||{}), ...patch};
      const payload = {
        user_id: currentUser.id, // required for onConflict
        blood_type: health.blood_type ?? null,
        organ_donor: (health.organ_donor ?? null),
        life_support_pref: health.life_support_pref ?? null,
        allergies: health.allergies ?? null,
        conditions: health.conditions ?? null,
        medications: health.medications ?? null,
        triage_override: health.triage_override ?? null,
        updated_at: new Date().toISOString()
      };
      await supabase.from('health_profiles').upsert(payload, { onConflict:'user_id' });
    }

    // ---------- Triage ----------
    function updateTriage(){
      const color = computeTriage();
      const badge = $('#triageBadge');
      const map = {
        Green:{bg:'bg-green-600',label:'Green — Stable',icon:'🟢'},
        Amber:{bg:'bg-amber-500',label:'Amber — Urgent',icon:'🟡'},
        Red:{bg:'bg-red-600',label:'Red — Immediate',icon:'🔴'},
        Black:{bg:'bg-gray-900',label:'Black — Comfort Care',icon:'⚫'}
      };
      const m = map[color]||map.Green;
      badge.className = `inline-flex items-center px-6 py-3 rounded-full text-white text-lg font-bold ${m.bg}`;
      badge.innerHTML = `${m.icon} <span class="ml-2">${m.label}</span>`;
      $('#triage_override').value = health?.triage_override ? health.triage_override : 'auto';
    }

    function computeTriage(){
      const hp = health||{};
      // Override
      if (hp.triage_override && hp.triage_override!=='auto') return hp.triage_override;

      // Black: DNR
      if ((hp.life_support_pref||'').toUpperCase()==='DNR') return 'Black';

      const allergies = (hp.allergies||'').toLowerCase();
      const conditions = (hp.conditions||'').toLowerCase();
      const medications = (hp.medications||'').toLowerCase();

      // Red triggers (common criticals)
      const redAllergy = ['anaphylaxis','epipen','penicillin','amoxicillin','codeine','morphine','peanut','shellfish','bee sting'];
      if (redAllergy.some(w=>allergies.includes(w))) return 'Red';
      const redCond = ['heart attack','myocard','mi ','stroke','seizure','status epilepticus','cancer','copd severe','oxygen dependent','dialysis'];
      if (redCond.some(w=>conditions.includes(w))) return 'Red';

      // Amber: any info at all, or ≥3 meds
      const anyInfo = [allergies,conditions,medications].some(s=>s.trim());
      const medsCount = medications ? medications.split(',').map(s=>s.trim()).filter(Boolean).length : 0;
      if (anyInfo || medsCount>=3) return 'Amber';

      // Default
      return 'Green';
    }

    // ---------- ICE ----------
    function renderContacts(){
      const list = $('#contactsList');
      list.innerHTML='';
      if (!contacts.length){ $('#noContacts').classList.remove('hidden'); } else { $('#noContacts').classList.add('hidden'); }
      contacts.forEach(c=>{
        const row = document.createElement('div');
        row.className='border rounded-xl p-4';
        row.innerHTML = `
          <div class="grid grid-cols-12 gap-3 items-center">
            <input class="col-span-3 border rounded-lg px-3 py-2" data-field="name" data-id="${c.id}" placeholder="Name*" value="${escapeHtml(c.name||'')}">
            <input class="col-span-2 border rounded-lg px-3 py-2" data-field="relationship" data-id="${c.id}" placeholder="Relationship" value="${escapeHtml(c.relationship||'')}">
            <input class="col-span-3 border rounded-lg px-3 py-2" data-field="phone" data-id="${c.id}" placeholder="Phone*" value="${escapeHtml(c.phone||'')}">
            <input class="col-span-3 border rounded-lg px-3 py-2" data-field="email" data-id="${c.id}" placeholder="Email" value="${escapeHtml(c.email||'')}">
            <button class="col-span-1 text-red-600 border rounded-lg px-3 py-2" data-del="${c.id}">Delete</button>
            <textarea class="col-span-12 mt-2 border rounded-lg px-3 py-2" data-field="notes" data-id="${c.id}" rows="2" placeholder="Notes">${escapeHtml(c.notes||'')}</textarea>
          </div>`;
        list.appendChild(row);
      });
      $('#contactsCounter').textContent = `${contacts.length} of 5 added`;
    }

    async function createBlankContact(){
      if (contacts.length>=5){ showToast('Max 5 contacts'); return; }
      const { data, error } = await supabase.from('ice_contacts').insert({ user_id: currentUser.id, name:'', phone:'' }).select().single();
      if (error) return;
      contacts.push(data);
      renderContacts();
    }

    let iceDebounce=null;
    function iceAutosaveHandler(e){
      const el = e.target;
      const id = Number(el.getAttribute('data-id'));
      const field = el.getAttribute('data-field');
      if (!id || !field) return;
      const row = contacts.find(c=>c.id===id);
      if (!row) return;
      row[field] = el.value;
      clearTimeout(iceDebounce);
      iceDebounce = setTimeout(async ()=>{
        if (!row.name?.trim() || !row.phone?.trim()){
          showToast('Name and phone are required'); return;
        }
        await supabase.from('ice_contacts').update({
          name: row.name, relationship: row.relationship||'', phone: row.phone,
          email: row.email||'', notes: row.notes||''
        }).eq('id', id).eq('user_id', currentUser.id);
        showToast('Contact saved');
        updateProgress();
      }, 500);
    }

    // ---------- QR ----------
    async function ensureQrRendered(){
      if (profile?.code){
        renderQR(profile.code);
        enableQrButtons(true);
        $('#shareLink').value = `${location.origin}/c/${profile.code}`;
      } else {
        enableQrButtons(false);
        $('#shareLink').value = '';
        $('#qrBox').innerHTML = '';
      }
    }

    async function onGenerateQR(){
      if (profile?.code){
        showToast('Code already assigned'); return;
      }
      const code = await makeUniqueCode();
      const { data, error } = await supabase.from('profiles').update({ code }).eq('id', currentUser.id).select().maybeSingle();
      if (error) return;
      profile = data || { ...(profile||{}), code };
      renderQR(code);
      $('#shareLink').value = `${location.origin}/c/${code}`;
      enableQrButtons(true);
      showToast('QR generated');
      updateProgress();
    }

    async function makeUniqueCode(){
      for (let i=0;i<6;i++){
        const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = Array.from({length:6},()=>alphabet[Math.floor(Math.random()*alphabet.length)]).join('');
        const { data } = await supabase.from('profiles').select('id').eq('code', code).maybeSingle();
        if (!data) return code;
      }
      return crypto.randomUUID().slice(0,6).toUpperCase();
    }

    function renderQR(code){
      const box = $('#qrBox'); box.innerHTML='';
      const canvas = document.createElement('canvas'); canvas.id='qrCanvas';
      box.appendChild(canvas);
      QRCode.toCanvas(canvas, `${location.origin}/c/${code}`, { width: Math.max(220, box.clientWidth-8), margin:1, color:{dark:'#111', light:'#fff'} });
    }

    function enableQrButtons(on){
      $('#exportPNG').disabled = !on;
      $('#printQR').disabled = !on;
    }

    function copyShareLink(){
      const v = $('#shareLink').value;
      if (!v) return;
      if (navigator.clipboard?.writeText){ navigator.clipboard.writeText(v).then(()=>showToast('Link copied')); }
      else { const t=document.createElement('input'); t.value=v; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); showToast('Link copied'); }
    }

    function exportQrPng(){
      const canvas = $('#qrCanvas'); if (!canvas) return;
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png'); a.download = (profile?.code || 'myqer') + '.png'; a.click();
    }

    // ---------- Danger Zone ----------
    async function doDeleteAccount(){
      if ($('#confirmDelete').value.trim().toUpperCase()!=='DELETE') return;
      try {
        await supabase.from('ice_contacts').delete().eq('user_id', currentUser.id);
        await supabase.from('health_profiles').delete().eq('user_id', currentUser.id);
        await supabase.from('profiles').delete().eq('id', currentUser.id);
        await supabase.auth.signOut();
        showToast('Account deleted'); setTimeout(()=>location.replace('/index.html'), 800);
      } catch(e){ console.error(e); showToast('Network error'); }
    }

    // ---------- Helpers ----------
    function updateProgress(){
      const iOK = !!(profile && profile.full_name && profile.date_of_birth && profile.country);
      const hp = health || {};
      const hOK = !!( (hp.blood_type) || (hp.life_support_pref) ||
                      (hp.allergies && hp.allergies.trim()) || (hp.conditions && hp.conditions.trim()) || (hp.medications && hp.medications.trim()) );
      const cOK = contacts.length>0;
      const qOK = !!(profile && profile.code);

      $('#iconIdentity').className = 'w-8 h-8 rounded-full grid place-items-center ' + (iOK?'bg-green-600 text-white':'bg-amber-500 text-white');
      $('#iconHealth').className   = 'w-8 h-8 rounded-full grid place-items-center ' + (hOK?'bg-green-600 text-white':'bg-amber-500 text-white');

      $('#chkIdentity').className = iOK?'font-bold text-green-600':'font-bold text-amber-600';
      $('#chkHealth').className   = hOK?'font-bold text-green-600':'font-bold text-amber-600';
      $('#chkContacts').className = cOK?'font-bold text-green-600':'font-bold text-amber-600';
      $('#chkQR').className       = qOK?'font-bold text-green-600':'font-bold text-amber-600';

      const complete = [iOK,hOK,cOK,qOK].filter(Boolean).length;
      const pct = Math.round(complete/4*100);
      $('#progressPct').textContent = pct+'%';
      $('#progressArc').setAttribute('stroke-dasharray', `${pct},100`);
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    let toastTimer=null;
    function showToast(msg){
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),1800);
    }
  </script>
</body>
</html>
