<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER™ Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0f172a;--slate:#64748b;--muted:#94a3b8;--border:#e2e8f0;
      --bg:#f8fafc;--red:#dc2626;--amber:#d97706;--green:#059669;--brand:#c62828;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1080px;margin:24px auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr 380px;gap:20px}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px 16px 8px;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    h1{font-size:1.35rem;margin:0 0 .25rem;font-weight:800}
    .sub{color:var(--slate);margin:0 0 1rem}
    label{display:block;font-size:.9rem;font-weight:600;color:var(--slate);margin:.35rem 0 .15rem}
    input[type="text"],input[type="date"],textarea,select{
      width:100%;padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;font:inherit
    }
    textarea{min-height:72px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-weight:800;font-size:.75rem;margin-left:.4rem}
    .pill.GREEN{background:#dcfce7;color:var(--green)}
    .pill.AMBER{background:#fef3c7;color:var(--amber)}
    .pill.RED{background:#fee2e2;color:var(--red)}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:.55rem .8rem;font:inherit;font-weight:600;cursor:pointer}
    button.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
    .qrCard{background:#fff7f7;border:1px dashed #f2d8d8;border-radius:16px;padding:16px;text-align:center}
    .foot{margin-top:14px;border-top:1px solid var(--border);padding-top:8px;text-align:center;color:var(--slate);font-size:.8rem}
    .status-msg{display:none;margin-top:8px;border-radius:10px;padding:.6rem;font-weight:600}
    .status-msg.success{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .status-msg.error{display:block;background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    .badge{font-size:.75rem;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);color:var(--slate)}
    .mutebar{margin:.25rem 0 1rem;color:var(--muted);font-size:.85rem}
    .ghost{opacity:.6}
    .qrLabel{font-weight:800;margin:.4rem 0 .2rem}
    .qrUnder{font:600 .85rem/1.2 ui-monospace,Menlo,monospace;color:var(--slate);letter-spacing:.04em}
    .loader{display:none;place-items:center;position:fixed;inset:0;background:#fff9;backdrop-filter:saturate(1.2) blur(1.5px)}
    .spinner{width:34px;height:34px;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#c62828;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .small{font-size:.75rem}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>MYQER™ Dashboard <span id="triPill" class="pill GREEN">GREEN</span></h1>
  <p class="sub">pronounced “my care” • Manage your emergency info & QR</p>

  <div class="row">
    <!-- Left: form -->
    <div class="card">
      <h3>Personal</h3>
      <div class="row2">
        <div>
          <label for="pi-name">Full Name</label>
          <input id="pi-name" type="text" placeholder="Your name" />
        </div>
        <div>
          <label for="pi-dob">Date of Birth</label>
          <input id="pi-dob" type="date" />
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="pi-blood">Blood Type</label>
          <select id="pi-blood">
            <option value="">—</option>
            <option>O+</option><option>O-</option>
            <option>A+</option><option>A-</option>
            <option>B+</option><option>B-</option>
            <option>AB+</option><option>AB-</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:.6rem">
          <input id="pi-donor" type="checkbox" />
          <label for="pi-donor" style="margin:0">I am an organ donor</label>
        </div>
      </div>

      <h3 style="margin-top:14px">Health</h3>
      <label for="sec-allergies">Critical Allergies</label>
      <textarea id="sec-allergies" placeholder="e.g. Penicillin"></textarea>
      <label for="sec-conditions">Medical Conditions</label>
      <textarea id="sec-conditions" placeholder="e.g. Asthma"></textarea>
      <label for="sec-meds">Current Medications</label>
      <textarea id="sec-meds" placeholder="e.g. Metformin"></textarea>
      <label for="sec-implants">Implants / Devices</label>
      <textarea id="sec-implants" placeholder="e.g. None"></textarea>

      <h3 style="margin-top:14px">Emergency Contacts (ICE)</h3>
      <textarea id="sec-ice" placeholder="e.g. G (Partner): +44 7700 900000"></textarea>

      <div class="actions">
        <button id="btnSaveProfile" class="primary">Save Profile</button>
        <button id="btnSaveHealth">Save Health</button>
        <button id="btnSaveICE">Save Contacts</button>
      </div>

      <div id="msg" class="status-msg"></div>
    </div>

    <!-- Right: QR panel -->
    <div class="card">
      <div class="mutebar">QRs include a **live** URL and a **self-contained** offline snapshot.</div>

      <div class="qrCard">
        <div class="qrLabel">Live QR (URL)</div>
        <div id="qrLive"></div>
        <div class="qrUnder"><span class="muted">Code:</span> <span id="liveCode">—</span></div>
        <div class="actions" style="justify-content:center;margin-top:6px">
          <button id="copyLink">Copy URL</button>
          <button id="openLink">Open</button>
        </div>
      </div>

      <div class="qrCard" style="margin-top:12px">
        <div class="qrLabel">Offline QR (JSON)</div>
        <div id="offlineQRwrap" style="display:none">
          <div id="offlineQRbox"></div>
        </div>
        <div class="small muted" style="margin-top:6px">Scannable without internet. Contains: name, DOB, blood, allergies, donor, first ICE + live URL.</div>
        <div class="actions" style="justify-content:center;margin-top:6px">
          <button id="btnSaveOfflineQR">Download PNG</button>
        </div>
      </div>

      <div class="foot">Read-only emergency info. Always verify clinically before treatment.</div>
    </div>
  </div>
</div>

<div id="loading" class="loader"><div class="spinner"></div></div>

<script>
/* ----------------- Supabase (your project) ----------------- */
const SUPABASE_URL = "https://dmntmhkncldgynufajei.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ----------------- helpers ----------------- */
const $ = (sel) => document.querySelector(sel);
const show = (id,msg,type='success')=>{
  const el = $('#msg'); el.className = `status-msg ${type}`; el.textContent = msg; el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 2000);
};
const loading = (on)=>{ $('#loading').style.display = on ? 'grid' : 'none'; };

function triageFrom(f){
  // very simple: any allergy or condition => AMBER, else GREEN
  const hasRisk = (f.allergies||'').trim() || (f.conditions||'').trim();
  return hasRisk ? 'AMBER' : 'GREEN';
}
function setTriageBadge(level){
  const pill = $('#triPill'); pill.textContent = level;
  pill.className = 'pill ' + (level || 'GREEN');
}

/* ----------------- read current form values ----------------- */
function fieldsFromForm(){
  return {
    full_name: $('#pi-name')?.value?.trim() || '',
    date_of_birth: $('#pi-dob')?.value || '',
    blood_type: $('#pi-blood')?.value || '',
    organ_donor: !!$('#pi-donor')?.checked,
    allergies: $('#sec-allergies')?.value?.trim() || '',
    conditions: $('#sec-conditions')?.value?.trim() || '',
    meds: $('#sec-meds')?.value?.trim() || '',
    implants: $('#sec-implants')?.value?.trim() || '',
    ice_contacts: $('#sec-ice')?.value?.trim() || ''
  };
}
function bindToForm(card){
  $('#pi-name').value = card.full_name || '';
  $('#pi-dob').value = (card.date_of_birth || '').substring(0,10);
  $('#pi-blood').value = card.blood_type || '';
  $('#pi-donor').checked = !!card.organ_donor;
  $('#sec-allergies').value = card.allergies || '';
  $('#sec-conditions').value = card.conditions || '';
  $('#sec-meds').value = card.meds || '';
  $('#sec-implants').value = card.implants || '';
  $('#sec-ice').value = card.ice_contacts || '';
  setTriageBadge(card.triage || triageFrom(card));
}

/* ----------------- permanent short code ----------------- */
async function getOrCreateShortCode(){
  const cached = localStorage.getItem('myqer_shortcode');
  if (cached) return cached;

  // try profiles.code
  try{
    const { data: sess } = await supabase.auth.getSession();
    const uid = sess?.session?.user?.id || null;
    if (uid){
      const { data: row } = await supabase.from('profiles').select('code').eq('id', uid).maybeSingle();
      if (row?.code){
        localStorage.setItem('myqer_shortcode', row.code);
        return row.code;
      }
    }
  }catch(e){ console.warn('read code failed', e); }

  // make new
  const chars = 'ABCDEFGHJKLNMPRQSTUVWXY23456789';
  let raw = ''; for (let i=0;i<8;i++) raw += chars[Math.floor(Math.random()*chars.length)];
  const code = raw.slice(0,4)+'-'+raw.slice(4);

  localStorage.setItem('myqer_shortcode', code);

  try{
    const { data: sess } = await supabase.auth.getSession();
    const uid = sess?.session?.user?.id || null;
    if (uid){
      await supabase.from('profiles').upsert({ id: uid, code }, { onConflict: 'id' });
    }
  }catch(e){ console.warn('persist code failed', e); }

  return code;
}

/* ----------------- QR: live + offline json ----------------- */
function liveUrlFor(code){ return `https://www.myqer.com/c/${encodeURIComponent(code)}`; }

function firstICE(iceText){
  // try to extract first phone-like token from free text
  const line = (iceText||'').split(/\n/)[0] || '';
  return line.trim();
}
function buildOfflineJSONPayload(){
  const code = localStorage.getItem('myqer_shortcode') || '';
  const f = fieldsFromForm();
  const offline = {
    name: f.full_name || null,
    dob: f.date_of_birth || null,
    blood: f.blood_type || null,
    allergies: f.allergies || null,
    donor: !!f.organ_donor,
    ice: firstICE(f.ice_contacts) || null
  };
  const payload = { code, offline, url: code ? liveUrlFor(code) : null };
  const json = JSON.stringify(payload);
  const bytes = new TextEncoder().encode(json).length;
  if (bytes > 2000) console.warn('Offline QR payload is large:', bytes, 'bytes');
  return json;
}

function renderLiveQR(code){
  const box = $('#qrLive'); box.innerHTML='';
  new QRCode(box, { text: liveUrlFor(code), width: 240, height: 240, correctLevel: QRCode.CorrectLevel.M });
  $('#liveCode').textContent = code;
  $('#cardUrl').value = liveUrlFor(code);
}
function renderOfflineJsonQR(){
  const wrap = $('#offlineQRwrap'); const box = $('#offlineQRbox');
  wrap.style.display='block'; box.innerHTML='';
  const json = buildOfflineJSONPayload();
  new QRCode(box, { text: json, width: 240, height: 240, correctLevel: QRCode.CorrectLevel.M });

  // brand mark
  const mark = document.createElement('div');
  mark.style.marginTop='6px'; mark.style.textAlign='center'; mark.style.fontWeight='700';
  mark.style.fontSize='.85rem'; mark.style.color='#c62828'; mark.textContent='MYQER™';
  box.appendChild(mark);
}

/* ----------------- Save / Load ----------------- */
async function loadAll(){
  loading(true);
  try{
    const { data: sess, error: sErr } = await supabase.auth.getSession();
    if (sErr) throw sErr;
    const uid = sess?.session?.user?.id || null;
    if (!uid){ location.href='/'; return; }

    // single RPC you already have on card.html; for dashboard we stitch from tables
    const { data: p } = await supabase.from('profiles').select('full_name,date_of_birth,code').eq('id', uid).maybeSingle();
    const { data: h } = await supabase.from('health_data').select('blood_type,organ_donor,allergies,conditions,meds,implants,triage').eq('user_id', uid).maybeSingle();
    const { data: iceRows } = await supabase.from('ice_contacts').select('name,relation,phone,contact_order').eq('user_id', uid).order('contact_order',{ascending:true});

    const iceStr = (iceRows||[]).map(c=>{
      const tag = c.relation ? `${c.relation}` : (c.name||'');
      const phone = c.phone||'';
      return `${tag ? tag+': ' : ''}${phone}`.trim();
    }).filter(Boolean).join('\n');

    const card = {
      ...(p||{}),
      ...(h||{}),
      ice_contacts: iceStr || ''
    };
    bindToForm(card);

    // short code
    const code = await getOrCreateShortCode();
    renderLiveQR(code);
    renderOfflineJsonQR();
  }catch(e){
    console.error(e);
    show('Failed to load your data. Please retry.', 'error');
  }finally{
    loading(false);
  }
}

async function saveProfile(){
  try{
    const { data: sess } = await supabase.auth.getSession();
    const uid = sess?.session?.user?.id || null; if (!uid) return;
    const f = fieldsFromForm();
    await supabase.from('profiles').upsert({
      id: uid,
      full_name: f.full_name || null,
      date_of_birth: f.date_of_birth || null
    }, { onConflict:'id' });
    show('Profile saved','success');
    renderOfflineJsonQR();
  }catch(e){ console.error(e); show('Save failed','error'); }
}
async function saveHealth(){
  try{
    const { data: sess } = await supabase.auth.getSession();
    const uid = sess?.session?.user?.id || null; if (!uid) return;
    const f = fieldsFromForm();
    await supabase.from('health_data').upsert({
      user_id: uid,
      blood_type: f.blood_type || null,
      organ_donor: f.organ_donor,
      allergies: f.allergies || null,
      conditions: f.conditions || null,
      meds: f.meds || null,
      implants: f.implants || null,
      triage: triageFrom(f)
    }, { onConflict:'user_id' });
    setTriageBadge(triageFrom(f));
    show('Health information saved','success');
    renderOfflineJsonQR();
  }catch(e){ console.error(e); show('Save failed','error'); }
}
async function saveICE(){
  try{
    const { data: sess } = await supabase.auth.getSession();
    const uid = sess?.session?.user?.id || null; if (!uid) return;
    const text = $('#sec-ice').value || '';
    const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,3);
    // replace rows (simple approach)
    await supabase.from('ice_contacts').delete().eq('user_id', uid);
    for (let i=0;i<lines.length;i++){
      await supabase.from('ice_contacts').insert({ user_id: uid, name: null, relation: null, phone: lines[i], contact_order: i+1 });
    }
    show('Emergency contacts saved','success');
    renderOfflineJsonQR();
  }catch(e){ console.error(e); show('Save failed','error'); }
}

/* ----------------- Buttons & wiring ----------------- */
document.getElementById('btnSaveProfile').addEventListener('click', saveProfile);
document.getElementById('btnSaveHealth').addEventListener('click', saveHealth);
document.getElementById('btnSaveICE').addEventListener('click', saveICE);

document.getElementById('copyLink').addEventListener('click', async ()=>{
  const code = await getOrCreateShortCode();
  try{
    await navigator.clipboard.writeText(liveUrlFor(code));
    show('Link copied','success');
  }catch{ show('Copy failed','error'); }
});
document.getElementById('openLink').addEventListener('click', async ()=>{
  const code = await getOrCreateShortCode();
  window.open(liveUrlFor(code), '_blank');
});
document.getElementById('btnSaveOfflineQR').addEventListener('click', ()=>{
  const box = document.getElementById('offlineQRbox');
  const img = box.querySelector('img') || box.querySelector('canvas');
  if (!img) return show('Generate the offline QR first','error');
  const url = img.tagName === 'IMG' ? img.src : img.toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download='myqer-offline-qr.png'; a.click();
});

/* ----------------- boot ----------------- */
loadAll();
</script>
</body>
</html>
