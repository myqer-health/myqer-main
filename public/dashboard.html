<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER ‚Äî Dashboard</title>
  <link rel="icon" href="/assets/logo-myqer.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#c62828" />

  <style>
    :root{
      --brand:#c62828;
      --ink:#111318;
      --muted:#667085;
      --stroke:rgba(17,24,39,.12);
      --shadow:0 18px 42px rgba(2,8,23,.12), 0 2px 6px rgba(2,8,23,.06);
      --r:18px;
      --red:#ef4444; --amber:#f59e0b; --green:#10b981; --blue:#60a5fa;
    }
    html,body{background:linear-gradient(180deg,#f7fafc 0%,#eef2f7 100%);color:var(--ink)}
    .glass-card{background:rgba(255,255,255,.9);backdrop-filter:blur(14px);border:1px solid var(--stroke);border-radius:18px;box-shadow:var(--shadow)}
    .section-ribbon{position:relative;padding-top:1.25rem;border-left:4px solid}
    .section-ribbon.red{border-color:var(--red)}
    .section-ribbon.amber{border-color:var(--amber)}
    .section-ribbon.blue{border-color:var(--blue)}
    .section-ribbon.green{border-color:var(--green)}
    .ribbon-title{display:flex;align-items:center;gap:.5rem;font-weight:800}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.6rem 1rem;border-radius:.75rem;font-weight:600}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-secondary{border:1px solid var(--stroke);background:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .input{width:100%;border:1px solid #e5e7eb;border-radius:.75rem;padding:.65rem .8rem;background:rgba(255,255,255,.9)}
    .tag{border:1px solid var(--stroke);background:#fff;border-radius:999px;padding:.3rem .6rem;font-size:.75rem}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px}
    .offline{background:#fff3c4;border:1px solid #f3d08e;color:#7c5400}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .phone-shadow{box-shadow:0 30px 60px rgba(2,8,23,.18)}
  </style>

  <!-- Supabase + QRCode -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <!-- Top bar -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-white/60">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2 font-extrabold text-lg select-none">
        <img src="/assets/logo.svg" class="h-6" onerror="this.src='/assets/logo-myqer.png'">
        <span>MYQ<span class="text-[#c62828]">ER</span>‚Ñ¢</span>
      </a>

      <div class="flex items-center gap-3">
        <!-- Language -->
        <select id="langSelect" class="input !py-2 !px-3 w-[140px]">
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
          <option value="de">Deutsch</option>
          <option value="fr">Fran√ßais</option>
          <option value="it">Italiano</option>
          <option value="pt">Portugu√™s</option>
          <option value="ro">Rom√¢nƒÉ</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
          <option value="zh">‰∏≠Êñá</option>
        </select>

        <a href="/" class="tag" data-i18n="nav.back_home">Back to Home</a>
        <button id="logoutBtn" class="btn btn-secondary" data-i18n="nav.logout">Logout</button>
      </div>
    </div>
  </header>

  <!-- Offline note -->
  <div id="offlineNote" class="hidden offline max-w-7xl mx-auto mt-4 rounded-lg px-4 py-2 text-sm">
    <span data-i18n="offline.message">You're offline ‚Äî edits will sync when connection returns</span>
  </div>
    <!-- Middle column -->
    <section class="lg:col-span-1 space-y-6">
      <!-- CRITICAL -->
      <section class="glass-card p-6 section-ribbon red">
        <h2 class="ribbon-title text-red-700 text-lg mb-4">
          <span>üö®</span><span data-i18n="critical.title">CRITICAL - Emergency Priority</span>
        </h2>

        <label class="text-sm font-medium mb-1 block" data-i18n="health.blood_type">Blood Type *</label>
        <select id="blood_type" class="input mb-4">
          <option value="">‚Äî</option>
          <option>O+</option><option>O-</option><option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option><option>AB+</option><option>AB-</option>
        </select>

        <label class="text-sm font-medium mb-1 block" data-i18n="health.allergies">Critical Allergies *</label>
        <input id="allergies" class="input mb-4" placeholder="Penicillin, Midazolam" />

        <label class="text-sm font-medium mb-1 block" data-i18n="health.life_support">Life Support & DNR Preferences *</label>
        <select id="life_support" class="input mb-4">
          <option value="full">Full</option>
          <option value="dnr">Do Not Resuscitate (DNR)</option>
          <option value="comfort">Comfort-focused only</option>
        </select>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium mb-1 block" data-i18n="health.burial_preference">Burial Preference</label>
            <select id="burial_pref" class="input">
              <option value="">‚Äî</option>
              <option value="burial">Burial</option>
              <option value="cremation">Cremation</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium mb-1 block">Religious/Cultural Preference</label>
            <input id="religion" class="input" placeholder="No religious preference" />
          </div>
        </div>
      </section>

      <!-- MEDICAL -->
      <section class="glass-card p-6 section-ribbon blue">
        <h2 class="ribbon-title text-blue-700 text-lg mb-4">
          <span>üìã</span><span data-i18n="medical.title">MEDICAL - Health Details</span>
        </h2>

        <label class="text-sm font-medium mb-1 block">Organ Donor</label>
        <input id="organ_donor" type="checkbox" class="mr-2 align-middle">
        <span class="text-sm align-middle">Yes</span>

        <div class="grid grid-cols-1 mt-4 gap-3">
          <div>
            <label class="text-sm font-medium mb-1 block">Medical Conditions</label>
            <input id="conditions" class="input" placeholder="Asthma, Diabetes" />
          </div>
          <div>
            <label class="text-sm font-medium mb-1 block">Current Medications</label>
            <input id="medications" class="input" placeholder="Metformin 500mg daily" />
          </div>
          <div>
            <label class="text-sm font-medium mb-1 block">Implants/Devices</label>
            <input id="implants" class="input" placeholder="Pacemaker" />
          </div>
        </div>
      </section>

      <!-- DOCUMENT VAULT (coming soon) -->
      <section class="glass-card p-6 section-ribbon amber opacity-80">
        <h2 class="ribbon-title text-amber-700 text-lg mb-2">üóÑÔ∏è DOCUMENT VAULT ‚Äî Legacy & Critical Papers</h2>
        <div class="rounded-lg border border-amber-200 bg-amber-50 text-amber-800 text-sm p-3 mb-3">
          Coming soon ‚Äî securely store DNR orders, living will, medical power of attorney, insurance papers.
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="border-2 border-dashed rounded-lg p-6 text-center text-gray-400">DNR Orders</div>
          <div class="border-2 border-dashed rounded-lg p-6 text-center text-gray-400">Living Will</div>
          <div class="border-2 border-dashed rounded-lg p-6 text-center text-gray-400">Med. Power of Attorney</div>
          <div class="border-2 border-dashed rounded-lg p-6 text-center text-gray-400">Insurance Docs</div>
        </div>
      </section>
    </section>

    <!-- Right column -->
    <section class="lg:col-span-1 space-y-6">
      <!-- Triage Status -->
      <section class="glass-card p-6">
        <h3 class="font-bold text-lg mb-1" data-i18n="triage.title">Emergency Triage Status</h3>
        <div class="text-sm text-gray-600 mb-3" data-i18n="triage.auto_computed">Auto-computed from health profile</div>

        <div class="flex items-center gap-2 mb-3">
          <span class="tag">GREEN ‚Äî Standard</span>
          <span class="tag">AMBER ‚Äî Urgent</span>
          <span class="tag">RED ‚Äî Immediate</span>
          <span class="tag">BLUE ‚Äî Non-urgent</span>
        </div>

        <label class="text-sm font-medium mb-1 block" data-i18n="triage.override">Override:</label>
        <select id="triage_override" class="input">
          <option value="auto" data-i18n="triage.use_auto">Use auto-computed</option>
          <option value="red">RED ‚Äî Immediate</option>
          <option value="amber">AMBER ‚Äî Urgent</option>
          <option value="green">GREEN ‚Äî Standard</option>
          <option value="blue">BLUE ‚Äî Non-urgent</option>
        </select>
      </section>

      <!-- QR & share -->
      <section class="glass-card p-6">
        <h3 class="font-bold text-lg mb-2" data-i18n="qr.title">Emergency Card & QR</h3>
        <div class="text-sm text-gray-600 mb-4" data-i18n="qr.scan_info">Scan to view emergency information</div>

        <div id="qrBox" class="w-full flex items-center justify-center mb-4">
          <canvas id="qrCanvas"></canvas>
        </div>

        <div class="flex gap-2">
          <button id="downloadQR" class="btn btn-secondary" data-i18n="qr.download">Download QR Code</button>
          <button id="printCard" class="btn btn-secondary" data-i18n="qr.print">Print Emergency Card</button>
        </div>

        <div class="mt-4">
          <label class="text-sm font-medium mb-1 block" data-i18n="qr.shareable_link">Shareable Link:</label>
          <div class="flex gap-2">
            <input id="shareLink" class="input" readonly />
            <button id="copyLink" class="btn btn-secondary" data-i18n="qr.copy">Copy</button>
          </div>
        </div>

        <!-- Voice controls -->
        <div class="mt-5 flex items-center gap-3">
          <button id="playVoice" class="btn btn-primary text-sm">
            ‚ñ∂Ô∏è <span data-i18n="voice.play">Play voice</span>
          </button>
          <button id="stopVoice" class="btn btn-secondary text-sm">
            ‚èπ <span data-i18n="voice.stop">Stop</span>
          </button>
          <span class="text-xs text-gray-500" data-i18n="voice.note">(Speaks a short triage summary in your selected language)</span>
        </div>
      </section>

      <!-- Legend -->
      <section class="glass-card p-6">
        <h3 class="font-bold text-lg mb-3" data-i18n="help.triage_colors">Triage Colors</h3>
        <div class="space-y-2 text-sm">
          <div><strong data-i18n="help.red_title">RED - Immediate</strong> ‚Äî <span data-i18n="help.red_desc">Life-threatening conditions</span></div>
          <div><strong data-i18n="help.amber_title">AMBER - Urgent</strong> ‚Äî <span data-i18n="help.amber_desc">Serious but stable</span></div>
          <div><strong data-i18n="help.green_title">GREEN - Standard</strong> ‚Äî <span data-i18n="help.green_desc">Non-urgent care needed</span></div>
          <div><strong data-i18n="help.blue_title">BLUE - Non-urgent</strong> ‚Äî <span data-i18n="help.blue_desc">Minor conditions</span></div>
        </div>

        <div class="mt-4 rounded-lg border border-slate-200 bg-slate-50 text-slate-700 p-3 text-sm">
          <strong data-i18n="help.privacy_title">User-Controlled Priority</strong><br>
          <span data-i18n="help.privacy_desc">You control what's most important for emergency responders to see first. Your data works offline and stays private.</span>
        </div>
      </section>

      <!-- Delete account -->
      <section class="glass-card p-6 border border-red-300 bg-red-50/70">
        <h3 class="font-bold text-lg text-red-700 mb-1" data-i18n="delete.title">Danger zone ‚Äî Delete account</h3>
        <p class="text-sm text-red-700 mb-3" data-i18n="delete.desc">
          This permanently removes your account and all profile/health data. This cannot be undone.
        </p>
        <label class="text-sm text-red-800 mb-2 block" data-i18n="delete.type">Type <strong>DELETE MY ACCOUNT</strong> to confirm:</label>
        <input id="confirmDelete" class="input mb-3" placeholder="DELETE MY ACCOUNT" />
        <button id="deleteAccount" class="btn btn-danger" disabled data-i18n="delete.button">Delete my account</button>
        <div class="text-xs text-red-600 mt-2">Placed far from Logout to avoid misclicks.</div>
      </section>
    </section>
  </main>

  <footer class="py-10 text-center text-sm text-gray-500">
    ¬© 2025 MYQER ‚Äî My QR for Emergency Response ¬∑ No ads ¬∑ No trackers ¬∑ Your data stays on your device unless you share it.
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast hidden">
    <div class="px-4 py-2 bg-white rounded-lg shadow border text-sm">‚úîÔ∏è <span data-i18n="toast.saved">Changes saved</span></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ===== Supabase config (browser-safe) =====
    const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
    // Your anon key (ok in browser):
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Elements =====
    const logoutBtn = document.getElementById('logoutBtn');
    const langSelect = document.getElementById('langSelect');
    const toast = document.getElementById('toast');
    const offlineNote = document.getElementById('offlineNote');

    const fields = {
      blood_type: document.getElementById('blood_type'),
      allergies:  document.getElementById('allergies'),
      life_support: document.getElementById('life_support'),
      burial_pref: document.getElementById('burial_pref'),
      religion: document.getElementById('religion'),
      organ_donor: document.getElementById('organ_donor'),
      conditions: document.getElementById('conditions'),
      medications: document.getElementById('medications'),
      implants: document.getElementById('implants'),
      triage_override: document.getElementById('triage_override'),
    };

    const phone = {
      triage: document.getElementById('phoneTriagePill'),
      blood: document.getElementById('ph_blood'),
      ice: document.getElementById('ph_ice'),
      allergies: document.getElementById('ph_allergies'),
      meds: document.getElementById('ph_meds')
    };

    // ===== i18n (10 languages, minimal keys ‚Äî extend anytime) =====
    const I18N = {
      en:{ "nav.back_home":"Back to Home","nav.logout":"Logout","offline.message":"You're offline ‚Äî edits will sync when connection returns",
           "critical.title":"CRITICAL - Emergency Priority","health.blood_type":"Blood Type *","health.allergies":"Critical Allergies *",
           "health.life_support":"Life Support & DNR Preferences *","health.burial_preference":"Burial Preference",
           "medical.title":"MEDICAL - Health Details","triage.title":"Emergency Triage Status","triage.auto_computed":"Auto-computed from health profile",
           "triage.override":"Override:","triage.use_auto":"Use auto-computed","qr.title":"Emergency Card & QR","qr.scan_info":"Scan to view emergency information",
           "qr.download":"Download QR Code","qr.print":"Print Emergency Card","qr.shareable_link":"Shareable Link:","qr.copy":"Copy",
           "help.triage_colors":"Triage Colors","help.red_title":"RED - Immediate","help.red_desc":"Life-threatening conditions",
           "help.amber_title":"AMBER - Urgent","help.amber_desc":"Serious but stable","help.green_title":"GREEN - Standard","help.green_desc":"Non-urgent care needed",
           "help.blue_title":"BLUE - Non-urgent","help.blue_desc":"Minor conditions","help.privacy_title":"User-Controlled Priority",
           "help.privacy_desc":"You control what's most important for emergency responders to see first. Your data works offline and stays private.",
           "voice.play":"Play voice","voice.stop":"Stop","voice.note":"(Speaks a short triage summary in your selected language)",
           "delete.title":"Danger zone ‚Äî Delete account","delete.desc":"This permanently removes your account and all profile/health data. This cannot be undone.",
           "delete.type":"Type DELETE MY ACCOUNT to confirm:","delete.button":"Delete my account","toast.saved":"Changes saved",
           "phone.h1a":"Your","phone.h1b":"emergency","phone.h1c":"card.","phone.h2a":"One scan, instant","phone.h2b":"triage",
           "phone.sub1":"A QR triage code to guide","phone.sub2":"responders","phone.sub3":"anywhere, anytime.",
           "phone.pronounce1":"pronounced","phone.blood":"Blood","phone.allergies":"Allergies","phone.meds":"Meds",
           "tag.simple":"Simple for people.","tag.precise":"Precise","tag.for_resp":"for responders.","btn.signin":"Sign In","btn.signup":"Sign Up"
      },
      es:{ "nav.back_home":"Volver al inicio","nav.logout":"Cerrar sesi√≥n","offline.message":"Sin conexi√≥n ‚Äî los cambios se sincronizar√°n al volver",
           "critical.title":"CR√çTICO - Prioridad de emergencia","health.blood_type":"Grupo sangu√≠neo *","health.allergies":"Alergias cr√≠ticas *",
           "health.life_support":"Soporte vital y DNR *","health.burial_preference":"Preferencia funeraria","medical.title":"M√âDICO - Detalles de salud",
           "triage.title":"Estado de triaje","triage.auto_computed":"Calculado autom√°ticamente","triage.override":"Anular:",
           "triage.use_auto":"Usar autom√°tico","qr.title":"Tarjeta de emergencia y QR","qr.scan_info":"Escanea para ver la informaci√≥n",
           "qr.download":"Descargar QR","qr.print":"Imprimir tarjeta","qr.shareable_link":"Enlace para compartir:","qr.copy":"Copiar",
           "help.triage_colors":"Colores de triaje","help.red_title":"ROJO - Inmediato","help.red_desc":"Amenaza vital",
           "help.amber_title":"√ÅMBAR - Urgente","help.amber_desc":"Grave pero estable","help.green_title":"VERDE - Est√°ndar","help.green_desc":"No urgente",
           "help.blue_title":"AZUL - No urgente","help.blue_desc":"Leve","help.privacy_title":"Prioridad controlada por el usuario",
           "help.privacy_desc":"T√∫ decides qu√© es m√°s importante para los respondedores.","voice.play":"Reproducir voz","voice.stop":"Detener",
           "voice.note":"(Lee un breve resumen en tu idioma)","delete.title":"Zona de peligro ‚Äî Eliminar cuenta",
           "delete.desc":"Esto elimina permanentemente tu cuenta y datos.","delete.type":"Escribe DELETE MY ACCOUNT para confirmar:",
           "delete.button":"Eliminar mi cuenta","toast.saved":"Cambios guardados",
           "phone.h1a":"Tu","phone.h1b":"emergencia","phone.h1c":"tarjeta.","phone.h2a":"Un escaneo, triaje","phone.h2b":"instant√°neo",
           "phone.sub1":"Un c√≥digo QR para guiar a","phone.sub2":"respondedores","phone.sub3":"en cualquier lugar, en cualquier momento.",
           "phone.pronounce1":"se pronuncia","phone.blood":"Sangre","phone.allergies":"Alergias","phone.meds":"Medicaci√≥n",
           "tag.simple":"Simple para la gente.","tag.precise":"Preciso","tag.for_resp":"para respondedores.","btn.signin":"Entrar","btn.signup":"Crear cuenta"
      },
      de:{}, fr:{}, it:{}, pt:{}, ro:{}, ar:{}, hi:{}, zh:{}
    };

    // simple populate: fall back to English if translation missing
    function applyI18n(lang='en'){
      const dict = {...I18N.en, ...(I18N[lang]||{})};
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if(dict[k]) el.textContent = dict[k];
      });
    }

    // ===== Auth/session =====
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session){ window.location.href = '/?modal=login'; }

    logoutBtn.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      window.location.replace('/');
    });

    // ===== Connectivity banner =====
    function updateOnline(){ offlineNote.classList.toggle('hidden', navigator.onLine); }
    window.addEventListener('online', updateOnline);
    window.addEventListener('offline', updateOnline);
    updateOnline();

    // ===== Load user profile + health + contacts =====
    let profile=null, health=null, contacts=[];
    let userId = session?.user?.id;

    async function loadAll(){
      const p = await supabase.from('profiles').select('id, full_name, country, date_of_birth, code').eq('id', userId).single();
      profile = p.data || {};
      const h = await supabase.from('health_profiles').select('*').eq('user_id', userId).single();
      health = h.data || {};
      const c = await supabase.from('ice_contacts').select('name, relation, phone').eq('user_id', userId).order('id');
      contacts = c.data || [];

      // Put values in fields
      fields.blood_type.value = health?.blood_type || '';
      fields.allergies.value = health?.allergies || '';
      fields.life_support.value = health?.life_support || 'full';
      fields.burial_pref.value = health?.burial_pref || '';
      fields.religion.value = health?.religion || '';
      fields.organ_donor.checked = !!health?.organ_donor;
      fields.conditions.value = health?.conditions || '';
      fields.medications.value = health?.medications || '';
      fields.implants.value = health?.implants || '';
      fields.triage_override.value = health?.triage_override || 'auto';

      // Phone preview
      phone.blood.textContent = health?.blood_type || '‚Äî';
      const firstICE = contacts[0]?.phone || '‚Äî';
      phone.ice.textContent = firstICE.length>4 ? firstICE.slice(0,5)+'‚Ä¶' : firstICE;
      phone.allergies.textContent = health?.allergies || '‚Äî';
      phone.meds.textContent = (health?.medications || '‚Äî').split(',')[0];

      // Triage pill
      setTriagePill(computeTriage(health, fields.triage_override.value));

      // QR
      updateQR();
    }

    function computeTriage(h, override='auto'){
      if(override && override!=='auto') return override;
      // naive heuristic
      if(h?.life_support === 'dnr' || h?.life_support==='comfort') return 'red';
      if((h?.allergies||'').toLowerCase().includes('ana')) return 'red';
      if((h?.conditions||'').match(/asthma|diabet/i)) return 'amber';
      return 'green';
    }
    function setTriagePill(level){
      const map = {red:['RED ‚Äî Immediate','text-red-700','bg-red-100','border-red-300'],
                   amber:['AMBER ‚Äî Urgent','text-amber-700','bg-amber-100','border-amber-300'],
                   green:['GREEN ‚Äî Standard','text-green-700','bg-green-100','border-green-300'],
                   blue:['BLUE ‚Äî Non-urgent','text-blue-700','bg-blue-100','border-blue-300']};
      const [label, text, bg, br] = map[level] || map.green;
      phone.triage.textContent = label;
      phone.triage.className = `text-[12px] font-medium ${text}`;
      phone.triage.parentElement.className = `inline-flex items-center px-2 py-1 rounded-full ${bg} border ${br}`;
    }

    // ===== Debounced auto-save =====
    let t=null;
    Object.values(fields).forEach(el=>{
      el?.addEventListener(el.type==='checkbox'?'change':'input', ()=>{
        clearTimeout(t);
        t = setTimeout(saveAll, 600);
      });
    });

    async function saveAll(){
      if(!userId) return;
      const patch = {
        user_id: userId,
        blood_type: fields.blood_type.value || null,
        allergies: fields.allergies.value || null,
        life_support: fields.life_support.value || null,
        burial_pref: fields.burial_pref.value || null,
        religion: fields.religion.value || null,
        organ_donor: fields.organ_donor.checked,
        conditions: fields.conditions.value || null,
        medications: fields.medications.value || null,
        implants: fields.implants.value || null,
        triage_override: fields.triage_override.value || 'auto'
      };
      const { error } = await supabase.from('health_profiles')
        .upsert(patch, { onConflict:'user_id' });
      if(!error){
        showToast();
        // refresh preview + triage
        setTriagePill(computeTriage(patch, patch.triage_override));
        phone.blood.textContent = patch.blood_type || '‚Äî';
        phone.allergies.textContent = patch.allergies || '‚Äî';
        phone.meds.textContent = (patch.medications||'‚Äî').split(',')[0];
        updateQR();
      }
    }

    function showToast(){
      toast.classList.remove('hidden');
      setTimeout(()=>toast.classList.add('hidden'), 1200);
    }

    // ===== QR =====
    const qrCanvas = document.getElementById('qrCanvas');
    const shareLink = document.getElementById('shareLink');
    const downloadQR = document.getElementById('downloadQR');
    const copyLink = document.getElementById('copyLink');
    const printCard = document.getElementById('printCard');

    function currentLang(){ return langSelect.value || 'en'; }
    function cardUrl(){
      const code = profile?.code || '';
      const lang = currentLang();
      return `${SUPABASE_URL}/functions/v1/card?code=${encodeURIComponent(code)}&lang=${lang}`;
    }
    async function updateQR(){
      const url = cardUrl();
      shareLink.value = url;
      await QRCode.toCanvas(qrCanvas, url, { width: 220, margin: 1 });
    }
    downloadQR.addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.download = 'myqer-qr.png';
      a.href = qrCanvas.toDataURL('image/png');
      a.click();
    });
    copyLink.addEventListener('click', async ()=>{
      await navigator.clipboard.writeText(shareLink.value);
      showToast();
    });
    printCard.addEventListener('click', ()=>{ window.open(shareLink.value, '_blank'); });

    // ===== Voice (Web Speech Synthesis) =====
    const playVoice = document.getElementById('playVoice');
    const stopVoice = document.getElementById('stopVoice');

    function langCodeForTTS(lang){
      // map to supported BCP-47 codes (best-effort)
      const map = {en:'en-US', es:'es-ES', de:'de-DE', fr:'fr-FR', it:'it-IT',
                   pt:'pt-PT', ro:'ro-RO', ar:'ar-SA', hi:'hi-IN', zh:'zh-CN'};
      return map[lang] || 'en-US';
    }
    function voiceSummary(){
      const a = fields.allergies.value || 'None';
      const m = fields.medications.value || 'None';
      const ice = (contacts[0]?.name? contacts[0].name + ' ' : '') + (contacts[0]?.phone||'');
      const lang = currentLang();
      const parts = {
        en:`Emergency summary. Allergies: ${a}. Medications: ${m}. Primary emergency contact: ${ice}.`,
        es:`Resumen de emergencia. Alergias: ${a}. Medicaci√≥n: ${m}. Contacto de emergencia: ${ice}.`,
        de:`Notfallzusammenfassung. Allergien: ${a}. Medikamente: ${m}. Notfallkontakt: ${ice}.`,
        fr:`R√©sum√© d'urgence. Allergies : ${a}. M√©dicaments : ${m}. Contact d'urgence : ${ice}.`,
        it:`Riepilogo di emergenza. Allergie: ${a}. Farmaci: ${m}. Contatto di emergenza: ${ice}.`,
        pt:`Resumo de emerg√™ncia. Alergias: ${a}. Medicamentos: ${m}. Contato de emerg√™ncia: ${ice}.`,
        ro:`Rezumat de urgen»õƒÉ. Alergii: ${a}. Medicamente: ${m}. Contact de urgen»õƒÉ: ${ice}.`,
        ar:`ŸÖŸÑÿÆÿµ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶. ÿßŸÑÿ≠ÿ≥ÿßÿ≥Ÿäÿ©: ${a}. ÿßŸÑÿ£ÿØŸàŸäÿ©: ${m}. ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÅŸä ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶: ${ice}.`,
        hi:`‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂‡•§ ‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä: ${a}‡•§ ‡§¶‡§µ‡§æ‡§á‡§Ø‡§æ‡§Å: ${m}‡•§ ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï: ${ice}‡•§`,
        zh:`Á¥ßÊÄ•ÊëòË¶Å„ÄÇËøáÊïèÔºö${a}„ÄÇËçØÁâ©Ôºö${m}„ÄÇÁ¥ßÊÄ•ËÅîÁ≥ª‰∫∫Ôºö${ice}„ÄÇ`
      };
      return parts[lang] || parts.en;
    }
    playVoice.addEventListener('click', ()=>{
      const utter = new SpeechSynthesisUtterance(voiceSummary());
      utter.lang = langCodeForTTS(currentLang());
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    });
    stopVoice.addEventListener('click', ()=> window.speechSynthesis.cancel());

    // ===== Phone buttons (reuse your existing auth flow) =====
    document.getElementById('phoneSignIn')?.addEventListener('click', ()=>{ window.location.href='/?modal=login'; });
    document.getElementById('phoneSignUp')?.addEventListener('click', ()=>{ window.location.href='/?modal=register'; });

    // ===== Delete account (Edge Function) =====
    const confirmDelete = document.getElementById('confirmDelete');
    const deleteAccount = document.getElementById('deleteAccount');
    confirmDelete.addEventListener('input', ()=>{
      deleteAccount.disabled = (confirmDelete.value.trim() !== 'DELETE MY ACCOUNT');
    });
    deleteAccount.addEventListener('click', async ()=>{
      if(deleteAccount.disabled) return;
      if(!confirm('This cannot be undone. Delete your account now?')) return;
      try{
        // TODO: Create an Edge Function named 'delete-user' that deletes auth user + rows
        const res = await fetch(`${SUPABASE_URL}/functions/v1/delete-user`, {
          method:'POST',
          headers:{ 'Authorization': `Bearer ${session?.access_token}`, 'Content-Type':'application/json' },
          body: JSON.stringify({ user_id:userId })
        });
        if(!res.ok){
          alert('Delete not available yet. Please ensure the delete-user Edge Function is deployed.');
          return;
        }
        await supabase.auth.signOut();
        window.location.replace('/');
      }catch(_e){
        alert('Delete failed. Please try again.');
      }
    });

    // ===== Language change =====
    langSelect.addEventListener('change', ()=>{
      applyI18n(currentLang());
      updateQR();
    });

    // Init
    applyI18n('en');
    await loadAll();

    // Keep session awareness
    supabase.auth.onAuthStateChange((_evt, s)=>{ if(!s) window.location.href='/?modal=login'; });
  </script>

  <!-- Service worker keep -->
  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/myqer_service_worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
