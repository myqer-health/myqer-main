<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyQER - Emergency Medical Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#c62828',
            critical: '#dc2626',
            ice: '#ea580c',
            identity: '#16a34a',
            vault: '#7c3aed'
          },
          fontFamily: {
            sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
          },
          backdropBlur: {
            xs: '2px'
          }
        }
      }
    }
  </script>
  <style>
    /* Premium glassmorphism cards */
    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 
        0 20px 25px -5px rgba(0, 0, 0, 0.08),
        0 10px 10px -5px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    .glass-card-inner {
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 0.75rem;
    }
    
    /* Accolade ribbon system - Safari/iPad optimized */
    .ribbon {
      position: relative;
      padding-top: 3rem;
    }
    
    .accolade {
      position: absolute;
      top: 1rem;
      left: 1.5rem;
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 1rem 0.375rem 0.75rem;
      border-radius: 1rem 0.25rem 0.25rem 1rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: white;
      z-index: 10;
      transition: all 0.2s ease;
      box-shadow: 
        0 2px 4px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.5),
        inset 0 -1px 0 rgba(0,0,0,0.1);
    }
    
    /* Safari-safe chevron using clip-path with fallback */
    .accolade::after {
      content: '';
      position: absolute;
      right: -0.5rem;
      top: 0;
      width: 1rem;
      height: 100%;
      background: inherit;
      clip-path: polygon(0 0, 50% 50%, 0 100%);
      filter: brightness(0.85);
    }
    
    /* Fallback for older browsers */
    @supports not (clip-path: polygon(0 0, 50% 50%, 0 100%)) {
      .accolade::after {
        width: 0;
        height: 0;
        border-left: 0.5rem solid;
        border-top: 1.125rem solid transparent;
        border-bottom: 1.125rem solid transparent;
        background: none;
      }
    }
    
    .accolade:hover {
      transform: translateY(-1px);
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.6),
        inset 0 -1px 0 rgba(0,0,0,0.15);
    }
    
    /* Subtle sheen effect */
    .accolade::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: -0.5rem;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    
    .accolade:hover::before {
      opacity: 1;
    }
    
    /* Accolade color variants */
    .accolade--critical {
      background-color: #dc2626;
    }
    .accolade--critical::after {
      border-left-color: #dc2626;
    }
    
    .accolade--ice {
      background-color: #ea580c;
    }
    .accolade--ice::after {
      border-left-color: #ea580c;
    }
    
    .accolade--identity {
      background-color: #16a34a;
    }
    .accolade--identity::after {
      border-left-color: #16a34a;
    }
    
    .accolade--vault {
      background-color: #7c3aed;
    }
    .accolade--vault::after {
      border-left-color: #7c3aed;
    }
    
    /* RTL support */
    [dir="rtl"] .accolade {
      left: auto;
      right: 1.5rem;
      padding: 0.375rem 0.75rem 0.375rem 1rem;
      border-radius: 0.25rem 1rem 1rem 0.25rem;
    }
    
    [dir="rtl"] .accolade::after {
      right: auto;
      left: -0.5rem;
      clip-path: polygon(100% 0, 50% 50%, 100% 100%);
    }
    
    @supports not (clip-path: polygon(100% 0, 50% 50%, 100% 100%)) {
      [dir="rtl"] .accolade::after {
        border-left: none;
        border-right: 0.5rem solid;
      }
      
      [dir="rtl"] .accolade--critical::after {
        border-right-color: #dc2626;
      }
      
      [dir="rtl"] .accolade--ice::after {
        border-right-color: #ea580c;
      }
      
      [dir="rtl"] .accolade--identity::after {
        border-right-color: #16a34a;
      }
      
      [dir="rtl"] .accolade--vault::after {
        border-right-color: #7c3aed;
      }
    }
    
    /* Premium button system */
    .btn-primary {
      background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
      color: white;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      transition: all 0.15s ease;
      box-shadow: 0 2px 4px rgba(198, 40, 40, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(198, 40, 40, 0.3);
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
    }
    
    .btn-primary:focus {
      outline: none;
      box-shadow: 
        0 4px 8px rgba(198, 40, 40, 0.3),
        0 0 0 3px rgba(198, 40, 40, 0.35);
    }
    
    .btn-outline {
      border: 1.5px solid #c62828;
      color: #c62828;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    
    .btn-outline:hover {
      background: rgba(198, 40, 40, 0.05);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(198, 40, 40, 0.15);
    }
    
    .btn-outline:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.35);
    }
    
    .btn-secondary {
      border: 1px solid rgb(203, 213, 225);
      color: rgb(71, 85, 105);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    
    .btn-secondary:hover {
      background: rgb(248, 250, 252);
      border-color: rgb(148, 163, 184);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .btn-secondary:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.35);
    }
    
    /* Enhanced input system */
    .input-field {
      border: 1.5px solid rgb(203, 213, 225);
      border-radius: 0.5rem;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      background: rgba(255, 255, 255, 0.9);
    }
    
    .input-field:focus {
      outline: none;
      border-color: #c62828;
      box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.15);
      background: white;
    }
    
    /* Premium toast system */
    .toast {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: 350px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast-success { 
      background: linear-gradient(135deg, rgba(5, 150, 105, 0.95), rgba(4, 120, 87, 0.95));
    }
    .toast-warning { 
      background: linear-gradient(135deg, rgba(217, 119, 6, 0.95), rgba(180, 83, 9, 0.95));
    }
    .toast-error { 
      background: linear-gradient(135deg, rgba(220, 38, 38, 0.95), rgba(185, 28, 28, 0.95));
    }
    
    /* Premium QR container with red glow */
    .qr-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1rem;
      padding: 1.25rem;
      box-shadow: 
        0 0 0 2px #c62828,
        0 0 20px rgba(198, 40, 40, 0.3),
        0 8px 16px rgba(198, 40, 40, 0.15);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    /* Enhanced legend dots */
    .legend-dot {
      width: 0.875rem;
      height: 0.875rem;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.625rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    /* Disabled tiles */
    .disabled-tile {
      opacity: 0.6;
      cursor: not-allowed;
      border-style: dashed;
      transition: all 0.15s ease;
    }
    
    .disabled-tile:hover {
      opacity: 0.7;
    }
    
    /* Enhanced status pills with raised border */
    .status-pill {
      border-radius: 9999px;
      border: 2px solid;
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.15s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .pill-green {
      background: linear-gradient(135deg, rgb(240, 253, 244), rgb(220, 252, 231));
      border-color: rgb(34, 197, 94);
      color: rgb(22, 163, 74);
    }
    
    .pill-yellow {
      background: linear-gradient(135deg, rgb(254, 252, 232), rgb(254, 240, 138));
      border-color: rgb(245, 158, 11);
      color: rgb(217, 119, 6);
    }
    
    .pill-red {
      background: linear-gradient(135deg, rgb(254, 242, 242), rgb(254, 226, 226));
      border-color: rgb(239, 68, 68);
      color: rgb(220, 38, 38);
    }
    
    .pill-black {
      background: linear-gradient(135deg, rgb(249, 250, 251), rgb(243, 244, 246));
      border-color: rgb(17, 24, 39);
      color: rgb(17, 24, 39);
    }
    
    /* Hover effects for interactive elements */
    .glass-card:hover {
      box-shadow: 
        0 25px 30px -5px rgba(0, 0, 0, 0.1),
        0 15px 15px -5px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <!-- Header -->
  <header class="glass-card border-b border-slate-200/50 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 bg-gradient-to-br from-brand to-red-700 rounded-xl flex items-center justify-center shadow-lg">
            <span class="text-white font-bold text-lg">Q</span>
          </div>
          <h1 class="text-xl font-extrabold text-slate-800">üè• MyQER Dashboard</h1>
        </div>
        <div class="flex items-center gap-4">
          <select id="lang" class="input-field text-sm">
            <option value="en">üá∫üá∏ English</option>
            <option value="es">üá™üá∏ Espa√±ol</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
            <option value="de">üá©üá™ Deutsch</option>
            <option value="it">üáÆüáπ Italiano</option>
            <option value="pt">üáµüáπ Portugu√™s</option>
            <option value="ro">üá∑üá¥ Rom√¢nƒÉ</option>
            <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
            <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
          </select>
          <span class="text-sm text-slate-600" id="userEmail">user@example.com</span>
          <button id="logoutBtn" class="btn-secondary">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading / Error -->
  <div id="loading" class="flex items-center justify-center min-h-[60vh]">
    <div class="text-center">
      <div class="animate-spin h-12 w-12 rounded-full border-b-2 border-brand mx-auto mb-4"></div>
      <p class="text-slate-500 font-medium">Loading your dashboard‚Ä¶</p>
    </div>
  </div>

  <div id="errorBox" class="hidden max-w-3xl mx-auto mt-8 glass-card rounded-xl p-6">
    <div class="text-red-600 font-bold mb-2">‚ö†Ô∏è Something went wrong</div>
    <div id="errorMsg" class="text-sm text-slate-600"></div>
  </div>

  <!-- Dashboard -->
  <main id="dash" class="hidden pt-8 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Main Content: Two-Row Layout -->
        <div class="lg:col-span-3">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
            
            <!-- 1. Identity ‚Äì Personal Information (Top Left) -->
            <section class="glass-card rounded-xl p-6 ribbon">
              <span class="accolade accolade--identity">Identity</span>
              <div class="glass-card-inner p-6">
                <h2 class="text-xl font-extrabold mb-2 text-slate-800" data-i18n="identityTitle">üë§ Personal Information</h2>
                <p class="text-sm text-slate-500 mb-6" data-i18n="identityHint">These details help responders confirm who you are.</p>

                <form id="profileForm" class="space-y-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label for="full_name" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="fullName">Full name</label>
                      <input id="full_name" name="full_name" class="input-field w-full" placeholder="John Doe">
                    </div>
                    <div>
                      <label for="date_of_birth" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="dob">Date of Birth</label>
                      <input id="date_of_birth" name="date_of_birth" type="date" class="input-field w-full">
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label for="country" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="country">Country</label>
                      <input id="country" name="country" class="input-field w-full" placeholder="United States">
                    </div>
                    <div>
                      <label for="national_id" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="nationalId">National ID (optional)</label>
                      <input id="national_id" name="national_id" class="input-field w-full" placeholder="123-45-6789">
                    </div>
                  </div>

                  <div class="flex items-center justify-between pt-4 border-t border-slate-200/60">
                    <div class="flex items-center gap-3">
                      <span class="text-sm text-slate-500" data-i18n="codeLabel">Your card code:</span>
                      <code id="codeText" class="px-3 py-1 rounded-lg bg-slate-100 text-sm font-mono font-bold text-slate-800">‚Äî</code>
                    </div>
                    <div class="flex gap-3">
                      <button type="button" id="genCode" class="btn-outline text-sm" data-i18n="genCode">Generate code</button>
                      <button type="submit" class="btn-primary text-sm" data-i18n="saveProfile">Save Profile</button>
                    </div>
                  </div>
                </form>
              </div>
            </section>

            <!-- 2. Critical ‚Äì Medical ‚Äì Health Details (Top Right) -->
            <section class="glass-card rounded-xl p-6 ribbon">
              <span class="accolade accolade--critical">Critical</span>
              <div class="glass-card-inner p-6">
                <h2 class="text-xl font-extrabold mb-2 text-slate-800" data-i18n="criticalTitle">ü©∫ Medical Details</h2>
                <p class="text-sm text-slate-500 mb-6" data-i18n="criticalHint">Keep this current. It appears on your emergency card.</p>

                <form id="healthForm" class="space-y-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label for="blood_type" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="bloodType">Blood type</label>
                      <select id="blood_type" name="blood_type" class="input-field w-full">
                        <option value="">‚Äî</option>
                        <option>A+</option><option>A-</option>
                        <option>B+</option><option>B-</option>
                        <option>AB+</option><option>AB-</option>
                        <option>O+</option><option>O-</option>
                      </select>
                    </div>
                    <div>
                      <label for="organ_donor" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="organDonor">Organ donor</label>
                      <select id="organ_donor" name="organ_donor" class="input-field w-full">
                        <option value="">‚Äî</option>
                        <option value="yes" data-i18n="yes">Yes</option>
                        <option value="no" data-i18n="no">No</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="allergies" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="allergies">Critical allergies</label>
                    <textarea id="allergies" name="allergies" rows="2" class="input-field w-full" placeholder="Penicillin, Nuts"></textarea>
                  </div>

                  <div>
                    <label for="conditions" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="conditions">Conditions</label>
                    <textarea id="conditions" name="conditions" rows="2" class="input-field w-full" placeholder="Diabetes, Asthma"></textarea>
                  </div>

                  <div>
                    <label for="meds" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="meds">Current medications</label>
                    <textarea id="meds" name="meds" rows="2" class="input-field w-full" placeholder="Metformin"></textarea>
                  </div>

                  <div>
                    <label for="life_support_pref" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="lifeSupport">Life support preference</label>
                    <select id="life_support_pref" name="life_support_pref" class="input-field w-full">
                      <option value="">‚Äî</option>
                      <option data-i18n="fullSupport" value="Full support">All resuscitation efforts (Full)</option>
                      <option data-i18n="comfortOnly" value="Comfort only">Comfort-focused care only</option>
                      <option data-i18n="dnr" value="DNR">Do not resuscitate (DNR)</option>
                    </select>
                    <p class="text-xs text-slate-400 mt-1" data-i18n="lifeSupportNote">Informational only. Clinicians must verify with official documents.</p>
                  </div>

                  <div class="flex justify-end pt-4 border-t border-slate-200/60">
                    <button type="submit" class="btn-primary" data-i18n="saveHealth">Save Health</button>
                  </div>
                </form>
              </div>
            </section>

            <!-- 3. Emergency Contacts (ICE) (Bottom Left) -->
            <section class="glass-card rounded-xl p-6 ribbon">
              <span class="accolade accolade--ice">ICE</span>
              <div class="glass-card-inner p-6">
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-xl font-extrabold text-slate-800" data-i18n="iceTitle">üìû Emergency Contacts</h2>
                  <button id="addIce" class="btn-outline text-sm" data-i18n="addContact">Add contact</button>
                </div>
                <p class="text-sm text-slate-500 mb-6" data-i18n="iceHint">Add up to 3 trusted contacts.</p>
                <div id="iceList" class="space-y-4">
                  <div class="text-slate-400 text-sm italic">No contacts yet.</div>
                </div>
              </div>
            </section>

            <!-- 4. Document Vault (Coming Soon) (Bottom Right) -->
            <section class="glass-card rounded-xl p-6 ribbon">
              <span class="accolade accolade--vault">Vault</span>
              <div class="glass-card-inner p-6">
                <h2 class="text-xl font-extrabold mb-2 text-slate-800" data-i18n="vaultTitle">üìÅ Document Vault</h2>
                <p class="text-sm text-slate-500 mb-6" data-i18n="vaultHint">Secure, encrypted storage for critical documents.</p>
                <div class="grid grid-cols-1 gap-3">
                  <div class="disabled-tile border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3" title="Coming soon">
                    <span class="legend-dot" style="background:#7c3aed"></span>
                    <div>
                      <div class="font-semibold text-slate-600 text-sm" data-i18n="dnr">DNR Orders</div>
                      <div class="text-xs text-slate-400">Coming soon</div>
                    </div>
                  </div>
                  <div class="disabled-tile border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3" title="Coming soon">
                    <span class="legend-dot" style="background:#7c3aed"></span>
                    <div>
                      <div class="font-semibold text-slate-600 text-sm" data-i18n="livingWill">Living Will</div>
                      <div class="text-xs text-slate-400">Coming soon</div>
                    </div>
                  </div>
                  <div class="disabled-tile border-2 border-slate-200 rounded-lg p-3 flex items-center gap-3" title="Coming soon">
                    <span class="legend-dot" style="background:#7c3aed"></span>
                    <div>
                      <div class="font-semibold text-slate-600 text-sm" data-i18n="insurance">Insurance Documents</div>
                      <div class="text-xs text-slate-400">Coming soon</div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <!-- Delete Account Section -->
          <section class="glass-card rounded-xl p-6 border-2 border-red-300/60 mt-8">
            <h2 class="text-xl font-extrabold text-red-700 mb-2" data-i18n="deleteTitle">‚ö†Ô∏è Delete account</h2>
            <p class="text-sm text-slate-500 mb-4" data-i18n="deleteWarning">Type <strong>DELETE MY ACCOUNT</strong> to enable. This is permanent.</p>
            <div class="flex flex-col sm:flex-row gap-3">
              <input id="deletePhrase" class="input-field flex-1" placeholder="DELETE MY ACCOUNT">
              <button id="deleteBtn" class="btn-primary bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled data-i18n="deleteBtn">Delete my account</button>
            </div>
            <p id="deleteNote" class="text-xs text-slate-400 mt-2" aria-live="polite"></p>
          </section>
        </div>

        <!-- Right Sidebar: Triage, QR, Legend -->
        <aside class="lg:col-span-1 space-y-6 lg:sticky lg:top-6 lg:self-start">

          <!-- Triage Status -->
          <section class="glass-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-extrabold text-slate-800" data-i18n="triageTitle">üö® Triage Status</h3>
              <span id="triagePill" class="status-pill pill-green">GREEN</span>
            </div>
            <p class="text-sm text-slate-500 mb-4" data-i18n="triageHint">Auto-computed from your data. You can override.</p>
            
            <select id="triageOverride" class="input-field w-full mb-4">
              <option value="">Auto (recommended)</option>
              <option value="green">GREEN - Standard</option>
              <option value="yellow">AMBER - Urgent</option>
              <option value="red">RED - Critical</option>
              <option value="black">BLACK - Comfort care</option>
            </select>
            
            <div class="flex gap-2">
              <button id="speak" class="btn-secondary flex-1 text-sm" data-i18n="speak">üîä Speak</button>
              <button id="stopSpeak" class="btn-secondary text-sm" data-i18n="stop">‚èπ</button>
            </div>
          </section>

          <!-- Emergency Card & QR -->
          <section class="glass-card rounded-xl p-6">
            <h3 class="text-lg font-extrabold mb-3 text-slate-800" data-i18n="cardTitle">üì± Emergency Card</h3>
            <p class="text-sm text-slate-500 mb-4" data-i18n="scanTip">Scan for emergency access</p>
            
            <div class="text-center mb-6">
              <div class="qr-container inline-block">
                <canvas id="qrCanvas" width="180" height="180"></canvas>
              </div>
              <div class="mt-3">
                <span class="text-sm text-slate-500">Code: </span>
                <code id="codeUnderQR" class="text-sm font-mono font-bold text-slate-800">‚Äî</code>
              </div>
              <div id="qrStatus" class="text-sm text-red-500 mt-1" aria-live="polite"></div>
            </div>
            
            <div class="space-y-3">
              <div>
                <label for="cardUrl" class="block text-sm font-medium text-slate-700 mb-1" data-i18n="cardLink">Card link</label>
                <div class="flex gap-2">
                  <input id="cardUrl" class="input-field flex-1 text-xs" readonly>
                  <button id="copyLink" class="btn-secondary text-sm" data-i18n="copy">Copy</button>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mt-4">
              <button id="dlPNG" class="btn-outline text-xs" data-i18n="png">PNG</button>
              <button id="dlSVG" class="btn-outline text-xs" data-i18n="svg">SVG</button>
              <button id="printCard" class="btn-outline text-xs" data-i18n="print">Print</button>
            </div>
          </section>

          <!-- Triage Legend -->
          <section class="glass-card rounded-xl p-6">
            <h3 class="text-lg font-extrabold mb-4 text-slate-800" data-i18n="legend">üéØ Triage Colors</h3>
            <div class="space-y-3">
              <div class="flex items-center">
                <span class="legend-dot" style="background:#16a34a"></span>
                <div>
                  <div class="font-semibold text-slate-700 text-sm">GREEN</div>
                  <div class="text-xs text-slate-400">Standard care</div>
                </div>
              </div>
              <div class="flex items-center">
                <span class="legend-dot" style="background:#f59e0b"></span>
                <div>
                  <div class="font-semibold text-slate-700 text-sm">AMBER</div>
                  <div class="text-xs text-slate-400">Urgent attention</div>
                </div>
              </div>
              <div class="flex items-center">
                <span class="legend-dot" style="background:#ef4444"></span>
                <div>
                  <div class="font-semibold text-slate-700 text-sm">RED</div>
                  <div class="text-xs text-slate-400">Critical/immediate</div>
                </div>
              </div>
              <div class="flex items-center">
                <span class="legend-dot" style="background:#111827"></span>
                <div>
                  <div class="font-semibold text-slate-700 text-sm">BLACK</div>
                  <div class="text-xs text-slate-400">Comfort care</div>
                </div>
              </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-slate-200/60">
              <p class="text-xs text-slate-400" data-i18n="infoOnly">Informational only. Clinicians must verify with official records.</p>
            </div>
          </section>

          <!-- Privacy Note -->
          <section class="glass-card rounded-xl p-4 bg-blue-50/70 border-blue-200/60">
            <p class="text-sm text-blue-800" data-i18n="privacyNote">üîí Your data stays on your device unless you share it. No ads, no trackers.</p>
            <p class="text-xs text-blue-600 mt-2" data-i18n="qrNote">Your QR code always opens your latest information.</p>
          </section>

        </aside>
      </div>
    </div>
  </main>

  <script type="module">
    // Service worker filename configuration
    const SW_FILENAME = 'sw.js';
    
    // Supabase configuration
    const SUPABASE_URL = "https://tgddpmxpbgrzrbzpomou.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM";
    
    // Initialize Supabase client
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    window.sb = createClient(SUPABASE_URL, SUPABASE_ANON);

    // Translations
    const t = {
      en: {
        identityTitle: "üë§ Personal Information",
        identityHint: "These details help responders confirm who you are.",
        fullName: "Full name",
        dob: "Date of Birth",
        country: "Country",
        nationalId: "National ID (optional)",
        codeLabel: "Your card code:",
        genCode: "Generate code",
        saveProfile: "Save Profile",
        criticalTitle: "ü©∫ Medical Details",
        criticalHint: "Keep this current. It appears on your emergency card.",
        bloodType: "Blood type",
        organDonor: "Organ donor",
        yes: "Yes",
        no: "No",
        allergies: "Critical allergies",
        conditions: "Conditions",
        meds: "Current medications",
        implants: "Implants / devices",
        lifeSupport: "Life support preference",
        lifeSupportNote: "Informational only. Clinicians must verify with official documents.",
        saveHealth: "Save Health",
        iceTitle: "üìû Emergency Contacts",
        iceHint: "Add up to 3 trusted contacts.",
        addContact: "Add contact",
        triageTitle: "üö® Triage Status",
        triageHint: "Auto-computed from your data. You can override.",
        speak: "üîä Speak",
        stop: "‚èπ Stop",
        cardTitle: "üì± Emergency Card",
        scanTip: "Scan for emergency access",
        cardLink: "Card link",
        copy: "Copy",
        png: "PNG",
        svg: "SVG",
        print: "Print",
        legend: "üéØ Triage Colors",
        infoOnly: "Informational only. Clinicians must verify with official records.",
        privacyNote: "üîí Your data stays on your device unless you share it. No ads, no trackers.",
        qrNote: "Your QR code always opens your latest information.",
        vaultTitle: "üìÅ Document Vault",
        vaultHint: "Secure, encrypted storage for critical documents.",
        dnr: "DNR Orders",
        livingWill: "Living Will",
        mpoa: "Medical Power of Attorney",
        insurance: "Insurance Documents",
        deleteTitle: "‚ö†Ô∏è Delete account",
        deleteWarning: "Type DELETE MY ACCOUNT to enable. This is permanent.",
        deleteBtn: "Delete my account",
        fullSupport: "All resuscitation efforts (Full)",
        comfortOnly: "Comfort-focused care only"
      }
    };

    // Mock data storage
    let profile = {
      id: 'user123',
      email: 'user@example.com',
      full_name: '',
      date_of_birth: '',
      country: '',
      national_id: '',
      code: null
    };

    let health = {
      blood_type: '',
      organ_donor: null,
      allergies: '',
      conditions: '',
      meds: '',
      implants: '',
      life_support_pref: ''
    };

    let ice = [];

    // Session and data loading functions
    async function ensureSession() {
      try {
        // Verify Supabase client is properly initialized
        if (!window.sb || typeof window.sb.auth.getSession !== 'function') {
          throw new Error('Supabase client not properly initialized');
        }
        
        const { data: { session }, error } = await window.sb.auth.getSession();
        if (error) throw error;
        if (!session) {
          // Redirect to login page
          window.location.replace('/');
          throw new Error('No active session found');
        }
        return session;
      } catch (error) {
        // Fallback for demo - in production this would redirect
        console.warn('Session check failed, using demo mode:', error.message);
        await new Promise(resolve => setTimeout(resolve, 800));
        if (!profile.email) {
          window.location.replace('/');
          throw new Error('No active session found');
        }
        return { user: { email: profile.email } };
      }
    }

    async function loadAll() {
      await new Promise(resolve => setTimeout(resolve, 600));
      
      if (!profile.full_name) {
        profile.full_name = 'John Doe';
        profile.country = 'United States';
        health.blood_type = 'O+';
        health.allergies = 'Penicillin';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      const loading = document.getElementById('loading');
      const dash = document.getElementById('dash');
      const errorBox = document.getElementById('errorBox');
      const errorMsg = document.getElementById('errorMsg');
      
      const langSel = document.getElementById('lang');
      langSel.addEventListener('change', applyI18n);
      
      // Init sequence
      (async () => {
        try {
          await ensureSession();
          await loadAll();
          
          document.getElementById('userEmail').textContent = profile.email;
          
          renderProfile(); 
          renderHealth(); 
          renderIce(); 
          renderQR(); 
          applyTriage();
          applyI18n();
          
          loading.classList.add('hidden');
          dash.classList.remove('hidden');
        } catch (e) {
          console.error(e);
          loading.classList.add('hidden');
          errorMsg.textContent = e.message || 'Unknown error';
          errorBox.classList.remove('hidden');
        }
      })();
    });

    // Internationalization
    function applyI18n() {
      const L = t.en;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (L[key]) el.textContent = L[key];
      });
    }

    // Render functions
    function renderProfile() {
      const f = document.getElementById('profileForm');
      f.full_name.value = profile.full_name || '';
      f.date_of_birth.value = profile.date_of_birth || '';
      f.country.value = profile.country || '';
      f.national_id.value = profile.national_id || '';
      document.getElementById('codeText').textContent = profile.code || '‚Äî';
      document.getElementById('codeUnderQR').textContent = profile.code || '‚Äî';
      
      const link = profile.code ? `${location.origin}/functions/v1/card?code=${encodeURIComponent(profile.code)}` : '';
      document.getElementById('cardUrl').value = link;
    }

    function renderHealth() {
      const f = document.getElementById('healthForm');
      f.blood_type.value = health.blood_type || '';
      f.organ_donor.value = health.organ_donor === true ? 'yes' : (health.organ_donor === false ? 'no' : '');
      f.allergies.value = health.allergies || '';
      f.conditions.value = health.conditions || '';
      f.meds.value = health.meds || '';
      f.implants.value = health.implants || '';
      f.life_support_pref.value = health.life_support_pref || '';
    }

    function renderIce() {
      const iceList = document.getElementById('iceList');
      if (!ice.length) {
        iceList.innerHTML = `<div class="text-slate-400 text-sm italic">No contacts yet.</div>`;
        return;
      }
      
      iceList.innerHTML = ice.map((c, i) => `
        <div class="glass-card rounded-lg p-4">
          <div class="grid grid-cols-1 gap-3">
            <input class="input-field w-full" placeholder="Name" value="${c.name || ''}" data-id="${i}" data-field="name">
            <input class="input-field w-full" placeholder="Relationship" value="${c.relation || ''}" data-id="${i}" data-field="relation">
            <div class="flex gap-2">
              <input class="input-field flex-1" placeholder="Phone" value="${c.phone || ''}" data-id="${i}" data-field="phone">
              <button class="btn-secondary px-3 py-2 text-sm hover:bg-red-50 hover:text-red-600" data-del="${i}">üóë</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function computeTriage() {
      const override = document.getElementById('triageOverride').value;
      if (override) return override;

      const hasDNR = (health.life_support_pref || '').toLowerCase().includes('dnr') || 
                     (health.life_support_pref || '').toLowerCase().includes('comfort');
      if (hasDNR) return 'black';

      const severe = (health.allergies || '').toLowerCase().includes('anaphyl') ||
                     (health.conditions || '').toLowerCase().includes('severe');
      if (severe) return 'red';

      const hasCond = !!(health.conditions || '').trim();
      if (hasCond) return 'yellow';

      return 'green';
    }

    function applyTriage() {
      const level = computeTriage();
      const pill = document.getElementById('triagePill');
      
      pill.className = 'status-pill';
      pill.classList.add(`pill-${level}`);
      pill.textContent = level === 'yellow' ? 'AMBER' : level.toUpperCase();
    }

    function renderQR() {
      if (!profile.code) {
        document.getElementById('qrStatus').textContent = 'No code yet';
        const ctx = document.getElementById('qrCanvas').getContext('2d');
        ctx.clearRect(0, 0, 180, 180);
        return;
      }
      
      const url = `${location.origin}/functions/v1/card?code=${encodeURIComponent(profile.code)}`;
      document.getElementById('qrStatus').textContent = '';
      QRCode.toCanvas(document.getElementById('qrCanvas'), url, { width: 180, margin: 2 }, err => {
        if (err) document.getElementById('qrStatus').textContent = 'QR error';
      });
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Event listeners
    document.getElementById('profileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      profile.full_name = fd.get('full_name') || '';
      profile.date_of_birth = fd.get('date_of_birth') || '';
      profile.country = fd.get('country') || '';
      profile.national_id = fd.get('national_id') || '';
      
      renderProfile();
      renderQR();
      showToast('Profile saved successfully', 'success');
    });

    document.getElementById('genCode').addEventListener('click', function() {
      if (profile.code) {
        showToast('Code already exists', 'warning');
        return;
      }
      
      profile.code = 'MYQER-' + Math.random().toString(36).slice(2, 9).toUpperCase();
      renderProfile();
      renderQR();
      showToast('Emergency code generated', 'success');
    });

    document.getElementById('healthForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      health.blood_type = fd.get('blood_type') || '';
      health.organ_donor = fd.get('organ_donor') === 'yes' ? true : (fd.get('organ_donor') === 'no' ? false : null);
      health.allergies = fd.get('allergies') || '';
      health.conditions = fd.get('conditions') || '';
      health.meds = fd.get('meds') || '';
      health.implants = fd.get('implants') || '';
      health.life_support_pref = fd.get('life_support_pref') || '';
      
      renderHealth();
      applyTriage();
      showToast('Health information saved', 'success');
    });

    document.getElementById('addIce').addEventListener('click', function() {
      if (ice.length >= 3) {
        showToast('Maximum 3 contacts allowed', 'warning');
        return;
      }
      
      ice.push({ name: '', relation: '', phone: '' });
      renderIce();
    });

    document.getElementById('iceList').addEventListener('input', function(e) {
      const id = e.target.dataset.id;
      const field = e.target.dataset.field;
      if (id !== undefined && field) {
        ice[parseInt(id)][field] = e.target.value;
      }
    });

    document.getElementById('iceList').addEventListener('click', function(e) {
      const del = e.target.dataset.del;
      if (del !== undefined) {
        if (confirm('Delete this contact?')) {
          ice.splice(parseInt(del), 1);
          renderIce();
          showToast('Contact removed', 'success');
        }
      }
    });

    document.getElementById('triageOverride').addEventListener('change', applyTriage);

    document.getElementById('speak').addEventListener('click', function() {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const text = `Emergency summary for ${profile.full_name || 'patient'}. Blood type: ${health.blood_type || 'unknown'}. Allergies: ${health.allergies || 'none listed'}. Conditions: ${health.conditions || 'none listed'}. Current medications: ${health.meds || 'none listed'}.`;
        const utterance = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(utterance);
      } else {
        showToast('Speech synthesis not supported', 'warning');
      }
    });

    document.getElementById('stopSpeak').addEventListener('click', function() {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
      }
    });

    document.getElementById('copyLink').addEventListener('click', async function() {
      const url = document.getElementById('cardUrl').value;
      if (url) {
        await navigator.clipboard.writeText(url);
        showToast('Link copied to clipboard', 'success');
      }
    });

    document.getElementById('dlPNG').addEventListener('click', function() {
      const canvas = document.getElementById('qrCanvas');
      const link = document.createElement('a');
      link.download = 'myqer-qr.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
      showToast('PNG downloaded', 'success');
    });

    document.getElementById('dlSVG').addEventListener('click', function() {
      if (!profile.code) {
        showToast('Generate a code first', 'warning');
        return;
      }
      
      const canvas = document.getElementById('qrCanvas');
      const dataURL = canvas.toDataURL('image/png');
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
        <foreignObject width="100%" height="100%">
          <div xmlns="http://www.w3.org/1999/xhtml" style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#fff">
            <img src="${dataURL}" style="width:100%;height:100%" />
          </div>
        </foreignObject>
      </svg>`;
      
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const link = document.createElement('a');
      link.download = 'myqer-qr.svg';
      link.href = URL.createObjectURL(blob);
      link.click();
      setTimeout(() => URL.revokeObjectURL(link.href), 1500);
      showToast('SVG downloaded', 'success');
    });

    document.getElementById('printCard').addEventListener('click', function() {
      if (!profile.code) {
        showToast('Generate a code first', 'warning');
        return;
      }
      
      const w = window.open('', '_blank', 'width=340,height=420');
      const code = profile.code || '';
      const img = document.getElementById('qrCanvas').toDataURL();
      const link = document.getElementById('cardUrl').value || '';
      
      w.document.write(`
        <html>
          <head>
            <title>Print Emergency QR Code</title>
            <style>
              body { 
                font-family: system-ui, -apple-system, sans-serif; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                height: 100vh; 
                margin: 0; 
                background: linear-gradient(to bottom right, #f8fafc, #f1f5f9);
              }
              .card {
                text-align: center;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(12px);
                padding: 24px;
                border-radius: 16px;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(148, 163, 184, 0.3);
              }
              .qr-img {
                width: 260px;
                height: 260px;
                border: 2px solid #c62828;
                border-radius: 12px;
                margin-bottom: 16px;
              }
              .code {
                font-family: monospace;
                font-size: 18px;
                font-weight: bold;
                margin: 12px 0;
                color: #1e293b;
              }
              .link {
                font-size: 12px;
                color: #64748b;
                word-break: break-all;
              }
            </style>
          </head>
          <body>
            <div class="card">
              <img src="${img}" class="qr-img" alt="Emergency QR Code"/>
              <div class="code">${code}</div>
              <div class="link">${link}</div>
            </div>
          </body>
        </html>
      `);
      
      w.document.close();
      w.focus();
      setTimeout(() => w.print(), 500);
    });

    document.getElementById('deletePhrase').addEventListener('input', function() {
      const btn = document.getElementById('deleteBtn');
      btn.disabled = this.value !== 'DELETE MY ACCOUNT';
    });

    document.getElementById('deleteBtn').addEventListener('click', async function() {
      if (!confirm('This will permanently delete your account and all data. This cannot be undone.')) return;
      
      this.disabled = true;
      document.getElementById('deleteNote').textContent = 'Processing deletion...';
      
      try {
        const { data: { session } } = await window.sb.auth.getSession();
        const accessToken = session?.access_token;
        
        if (!accessToken) {
          throw new Error('No valid session for deletion');
        }
        
        const response = await fetch(`${location.origin}/functions/v1/delete-account`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Delete service not available. Please contact support.');
          } else if (response.status === 401) {
            throw new Error('Session expired. Please log in again.');
          } else {
            throw new Error('Deletion request failed');
          }
        }
        
        document.getElementById('deleteNote').textContent = 'Account deleted successfully. Redirecting...';
        showToast('Account deleted successfully', 'success');
        
        setTimeout(async () => {
          await window.sb.auth.signOut();
          window.location.replace('/');
        }, 2000);
        
      } catch (error) {
        console.error('Delete account error:', error);
        document.getElementById('deleteNote').textContent = error.message || 'Deletion failed. Please try again or contact support.';
        this.disabled = false;
        showToast('Deletion failed', 'error');
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async function() {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await window.sb.auth.signOut();
          window.location.replace('/');
        } catch (error) {
          console.error('Logout error:', error);
          showToast('Logout failed', 'error');
        }
      }
    });

    // Service worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(`/${SW_FILENAME}`)
        .then(registration => console.log('SW registered:', registration))
        .catch(error => console.log('SW registration failed:', error));
    }
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97666745d3c47e34',t:'MTc1NjQxMTMxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
