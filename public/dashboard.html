<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MYQER™ Dashboard - Emergency Care</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --brand-red:#dc2626;--brand-red-dark:#b91c1c;--brand-red-light:#fecaca;
      --glass-bg:rgba(255,255,255,.85);--glass-border:rgba(255,255,255,.2);
      --shadow-light:0 4px 6px -1px rgba(0,0,0,.1);
      --shadow-medium:0 10px 15px -3px rgba(0,0,0,.1);
      --shadow-heavy:0 25px 50px -12px rgba(0,0,0,.25);
      --gradient-bg:linear-gradient(135deg,#F8FAFC 0%,#E2E8F0 50%,#CBD5E1 100%);
    }
    *{box-sizing:border-box}
    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:var(--gradient-bg);min-height:100vh;margin:0;padding:0;color:#1e293b;line-height:1.6
    }
    .glass-card{background:var(--glass-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:20px;border:1px solid var(--glass-border);box-shadow:var(--shadow-medium);transition:.3s;position:relative;overflow:hidden}
    .glass-card::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.8),transparent);z-index:1}
    .glass-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-heavy);border-color:rgba(255,255,255,.4)}
    .header-glass{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.2);box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .btn-tertiary{background:transparent;color:#6B7280;padding:10px 20px;border-radius:8px;font-weight:500;font-size:13px;transition:.2s;border:1px solid #E5E7EB;cursor:pointer}
    .btn-tertiary:hover{background:#F9FAFB;color:#374151}
    .disclaimer{background:linear-gradient(135deg,#FEF3C7,#FDE68A);border:2px solid #F59E0B;border-radius:16px;padding:20px;margin:24px 0}
    .brand-red{color:var(--brand-red)}
    .animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    /* RTL tweaks (Arabic) */
    html[dir="rtl"] body{direction:rtl}
    html[dir="rtl"] .text-left{text-align:right}
    html[dir="rtl"] .space-x-4 > * + *{margin-left:0;margin-right:1rem}
    html[dir="rtl"] .mr-2{margin-right:0;margin-left:.5rem}
    /* Toast (placeholder to match later) */
    .toast{position:fixed;top:24px;left:50%;transform:translateX(-50%) translateY(-100px);z-index:9999;padding:16px 32px;border-radius:16px;font-weight:600;font-size:14px;opacity:0;transition:.4s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.success{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(5,150,105,.9));color:#fff}
    .toast.warning{background:linear-gradient(135deg,rgba(245,158,11,.9),rgba(217,119,6,.9));color:#fff}
    .toast.error{background:linear-gradient(135deg,rgba(239,68,68,.9),rgba(220,38,38,.9));color:#fff}
    .toast.info{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(37,99,235,.9));color:#fff}
  </style>

  <script>
    // ---- Supabase config (same as your original) ----
    const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
    const ORIGIN = window.location.origin;
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- i18n dictionary (CHUNK 1 keys only: header + disclaimer) ----
    // We'll add more keys for each section in the next chunks.
    const i18n = {
      en: {
        online: "Online",
        logout: "Logout",
        worksOffline: 'Pronounced "my care" • Works offline',
        medDisclaimerTitle: "Medical Disclaimer",
        medDisclaimerBody:
          "This information is for emergency reference only and does not constitute medical advice. Healthcare professionals must independently verify all medical information and make their own clinical assessments. MYQER™ is not responsible for medical decisions made based on this data. Always consult with qualified healthcare providers for medical advice.",
      },
      es: {
        online: "En línea",
        logout: "Cerrar sesión",
        worksOffline: 'Se pronuncia "my care" • Funciona sin internet',
        medDisclaimerTitle: "Descargo de responsabilidad médica",
        medDisclaimerBody:
          "Esta información es solo de referencia para emergencias y no constituye consejo médico. Los profesionales deben verificar la información y realizar sus propias evaluaciones clínicas. MYQER™ no es responsable por decisiones médicas basadas en estos datos. Consulte siempre con profesionales de la salud.",
      },
      fr: {
        online: "En ligne",
        logout: "Déconnexion",
        worksOffline: 'Se prononce "my care" • Fonctionne hors ligne',
        medDisclaimerTitle: "Avertissement médical",
        medDisclaimerBody:
          "Ces informations sont destinées aux urgences et ne constituent pas un avis médical. Les professionnels doivent vérifier les données et effectuer leurs propres évaluations cliniques. MYQER™ n’est pas responsable des décisions médicales basées sur ces données. Consultez toujours des professionnels de santé.",
      },
      de: {
        online: "Online",
        logout: "Abmelden",
        worksOffline: 'Ausgesprochen „my care“ • Funktioniert offline',
        medDisclaimerTitle: "Medizinischer Haftungsausschluss",
        medDisclaimerBody:
          "Diese Informationen dienen nur als Notfallreferenz und stellen keine medizinische Beratung dar. Fachkräfte müssen Informationen verifizieren und eigenständig beurteilen. MYQER™ haftet nicht für medizinische Entscheidungen basierend auf diesen Daten. Wenden Sie sich stets an qualifizierte Ärzte.",
      },
      it: {
        online: "In linea",
        logout: "Disconnettersi",
        worksOffline: 'Si pronuncia "my care" • Funziona offline',
        medDisclaimerTitle: "Avvertenza medica",
        medDisclaimerBody:
          "Queste informazioni sono solo di riferimento in caso di emergenza e non costituiscono consulenza medica. I professionisti devono verificare i dati e fare le proprie valutazioni cliniche. MYQER™ non è responsabile delle decisioni mediche basate su questi dati. Consultare sempre personale sanitario qualificato.",
      },
      hi: {
        online: "ऑनलाइन",
        logout: "लॉग आउट",
        worksOffline: 'उच्चारण "माय केयर" • ऑफ़लाइन भी चलता है',
        medDisclaimerTitle: "चिकित्सा अस्वीकरण",
        medDisclaimerBody:
          "यह जानकारी केवल आपातकालीन संदर्भ के लिए है, चिकित्सीय सलाह नहीं। स्वास्थ्यकर्मी जानकारी सत्यापित कर अपनी नैदानिक ​​मूल्यांकन करें। MYQER™ इन डाटा पर आधारित चिकित्सा निर्णयों के लिए ज़िम्मेदार नहीं है। हमेशा योग्य चिकित्सकों से सलाह लें।",
      },
      ar: {
        online: "متصل",
        logout: "تسجيل الخروج",
        worksOffline: 'تُنطق "ماي كير" • يعمل دون إنترنت',
        medDisclaimerTitle: "إخلاء مسؤولية طبية",
        medDisclaimerBody:
          "هذه المعلومات للرجوع السريع في الطوارئ ولا تُعد نصيحة طبية. يجب على مقدمي الرعاية الصحية التحقق من المعلومات وإجراء تقييماتهم السريرية. لا تتحمل MYQER™ مسؤولية القرارات الطبية المبنية على هذه البيانات. استشر دائمًا مختصين مؤهلين.",
      },
      zh: {
        online: "在线",
        logout: "退出登录",
        worksOffline: '读作“my care” • 离线可用',
        medDisclaimerTitle: "医疗免责声明",
        medDisclaimerBody:
          "此信息仅供紧急情况下参考，不构成医疗建议。医护人员应独立核实并做出临床判断。MYQER™不对基于此数据做出的医疗决定负责。请始终咨询专业医生。",
      },
      hu: {
        online: "Elérhető",
        logout: "Kijelentkezés",
        worksOffline: 'Kiejtés: "my care" • Offline is működik',
        medDisclaimerTitle: "Orvosi nyilatkozat",
        medDisclaimerBody:
          "Az információ csak sürgősségi tájékoztatás, nem minősül orvosi tanácsnak. Az egészségügyi szakembereknek önállóan kell ellenőrizniük és értékelniük. A MYQER™ nem felel az ezen adatokon alapuló döntésekért. Mindig kérjen tanácsot szakembertől.",
      },
      ro: {
        online: "Online",
        logout: "Deconectare",
        worksOffline: 'Se pronunță „my care” • Funcționează offline',
        medDisclaimerTitle: "Declinare de responsabilitate medicală",
        medDisclaimerBody:
          "Informațiile sunt doar pentru referință în urgențe și nu reprezintă sfat medical. Profesioniștii trebuie să verifice datele și să își facă propria evaluare clinică. MYQER™ nu este responsabil pentru deciziile medicale bazate pe aceste date. Consultați întotdeauna personal medical calificat.",
      }
    };

    const RTL_LANGS = new Set(["ar"]);

    // Helper: set lang + dir on <html>
    function setLanguage(lang) {
      const html = document.documentElement;
      html.lang = lang;
      html.dir = RTL_LANGS.has(lang) ? "rtl" : "ltr";
    }

    // Translate text content & attributes (data-i18n, data-i18n-placeholder, data-i18n-aria)
    function applyTranslations(lang) {
      const dict = i18n[lang] || i18n.en;

      // Text nodes
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        if (dict[key] !== undefined) el.textContent = dict[key];
      });

      // Placeholders
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const key = el.getAttribute("data-i18n-placeholder");
        if (dict[key] !== undefined) el.setAttribute("placeholder", dict[key]);
      });

      // aria-labels
      document.querySelectorAll("[data-i18n-aria]").forEach(el=>{
        const key = el.getAttribute("data-i18n-aria");
        if (dict[key] !== undefined) el.setAttribute("aria-label", dict[key]);
      });

      // <option> dynamic labels (we’ll add per-section maps in their chunks)
      if (typeof translateDynamicOptions === "function") {
        translateDynamicOptions(lang);
      }
    }

    // Persist preference locally and in Supabase profile
    async function persistLanguage(lang) {
      try {
        localStorage.setItem("preferredLang", lang);
        if (window.sb && window.currentUser?.id) {
          await sb.from("profiles").update({ preferred_language: lang }).eq("id", currentUser.id);
        }
      } catch(e){ console.warn("Language persist failed:", e); }
    }

    // Initialize language on load
    async function initLanguage() {
      let lang = localStorage.getItem("preferredLang") || "en";

      // Try to pull from profile if available
      try {
        const { data:{ session } } = await sb.auth.getSession();
        if (session?.user?.id) {
          window.currentUser = session.user;
          const { data: profile } = await sb.from("profiles")
            .select("preferred_language").eq("id", session.user.id).single();
          if (profile?.preferred_language) lang = profile.preferred_language;
        }
      } catch(e){ /* ignore and use local */ }

      setLanguage(lang);
      applyTranslations(lang);

      const sel = document.getElementById("languageSelect");
      if (sel) sel.value = lang;

      // Keep status dot text updated
      const onlineSpan = document.querySelector('[data-i18n="online"]');
      if (onlineSpan) onlineSpan.textContent = (i18n[lang]||i18n.en).online;
    }

    // Public handler for <select>
    async function onLanguageChange(e){
      const lang = e.target.value;
      setLanguage(lang);
      applyTranslations(lang);
      await persistLanguage(lang);
    }

    // We’ll call initLanguage() after DOMContentLoaded
  </script>
</head>

<body>
  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header class="header-glass sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="text-3xl font-black text-slate-900">
            MYQ<span class="brand-red">ER</span><span class="text-lg">™</span>
          </div>
          <div class="hidden sm:block">
            <div class="text-xs text-gray-500" data-i18n="worksOffline">
              Pronounced "my care" • Works offline
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <div class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span data-i18n="online">Online</span>
            </div>
          </div>

          <select id="languageSelect" class="text-sm border border-gray-300 rounded-lg px-3 py-2 bg-white">
            <option value="en">🇺🇸 English</option>
            <option value="es">🇪🇸 Español</option>
            <option value="fr">🇫🇷 Français</option>
            <option value="de">🇩🇪 Deutsch</option>
            <option value="it">🇮🇹 Italiano</option>
            <option value="hi">🇮🇳 हिन्दी</option>
            <option value="ar">🇸🇦 العربية</option>
            <option value="zh">🇨🇳 中文</option>
            <option value="hu">🇭🇺 Magyar</option>
            <option value="ro">🇷🇴 Română</option>
          </select>

          <button id="logoutBtn" class="btn-tertiary" data-i18n="logout">
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Medical Disclaimer -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
    <div class="disclaimer">
      <div class="flex items-start space-x-3">
        <div class="flex-shrink-0">
          <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div>
          <div class="font-bold text-amber-800 text-lg mb-2" data-i18n="medDisclaimerTitle">
            Medical Disclaimer
          </div>
          <div class="text-sm text-amber-700 leading-relaxed" data-i18n="medDisclaimerBody">
            This information is for emergency reference only and does not constitute medical advice. Healthcare
            professionals must independently verify all medical information and make their own clinical assessments.
            MYQER™ is not responsible for medical decisions made based on this data. Always consult with qualified
            healthcare providers for medical advice.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Attach language change & initialize
    document.addEventListener("DOMContentLoaded", () => {
      const sel = document.getElementById("languageSelect");
      sel.addEventListener("change", onLanguageChange);
      initLanguage();
    });

    // Logout wiring (works with your Supabase session)
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const { data:{ session } } = await sb.auth.getSession();
        if (!session) { window.location.replace('index.html'); return; }
        window.currentUser = session.user;
      } catch(e){ window.location.replace('index.html'); }

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          if (confirm("Are you sure you want to logout?")) {
            try {
              await sb.auth.signOut();
              window.location.replace("index.html");
            } catch (err) {
              showToast("Logout failed", "error");
            }
          }
        });
      }
    });

    // Minimal toast (full version later in chunk that handles all messages)
    function showToast(msg,type="info"){
      const t=document.getElementById("toast");
      t.className="toast "+type; t.textContent=msg;
      requestAnimationFrame(()=>{ t.classList.add("show"); });
      setTimeout(()=> t.classList.remove("show"), 2200);
    }

    // Stub—will be expanded in later chunks for selects (relationships, life support, etc.)
    function translateDynamicOptions(lang){ /* filled per-section */ }
  </script>
  <!-- === Profile Completion (progress ring) === -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="glass-card p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-xl font-bold text-slate-900" data-i18n="profileCompletionTitle">Profile Completion</h2>
        <p class="text-sm text-gray-600" data-i18n="profileCompletionSub">Complete your profile to generate your emergency QR code</p>
      </div>
      <div class="flex items-center space-x-4">
        <svg class="progress-ring" width="60" height="60" viewBox="0 0 60 60" aria-hidden="true">
          <circle class="progress-ring-circle" cx="30" cy="30" r="28" stroke="#E5E7EB" stroke-width="4" fill="none"></circle>
          <circle id="progressCircle" class="progress-ring-progress" cx="30" cy="30" r="28" stroke="var(--brand-red)" stroke-width="4" fill="none" stroke-linecap="round" stroke-dasharray="0 188.5"></circle>
        </svg>
        <div class="text-right">
          <div id="progressPercent" class="text-2xl font-bold text-slate-900">0%</div>
          <div class="text-xs text-gray-500" data-i18n="completeLabel">Complete</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div class="flex items-center space-x-2" id="checkIdentity">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="identityCheck">Identity</span>
      </div>
      <div class="flex items-center space-x-2" id="checkHealth">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="healthCheck">Health Profile</span>
      </div>
      <div class="flex items-center space-x-2" id="checkContacts">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="iceCheck">ICE Contacts</span>
      </div>
      <div class="flex items-center space-x-2" id="checkCode">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="codeCheck">Emergency Code</span>
      </div>
    </div>
  </div>

  <!-- === Identity Card === -->
  <div class="glass-card p-8 mb-8">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-slate-900 mb-2" data-i18n="identityTitle">Identity Information</h2>
        <p class="text-gray-600" data-i18n="identitySub">These details help first responders confirm who you are and contact your emergency contacts.</p>
      </div>
      <div class="hidden md:block" aria-hidden="true">
        <svg class="w-12 h-12 text-green-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Full Name -->
      <div>
        <label class="form-label" data-i18n="fullNameLabel">Full Legal Name *</label>
        <input id="fullName" type="text" class="form-input" maxlength="100"
               data-i18n-placeholder="fullNamePh"
               placeholder="Enter your full legal name">
        <div class="text-xs text-gray-500 mt-1" data-i18n="fullNameHelp">As it appears on your ID</div>
      </div>

      <!-- Date of Birth -->
      <div>
        <label class="form-label" data-i18n="dobLabel">Date of Birth *</label>
        <input id="dateOfBirth" type="text" class="form-input"
               inputmode="numeric" pattern="\\d{2}/\\d{2}/\\d{4}"
               data-i18n-placeholder="dobPh"
               placeholder="DD/MM/YYYY">
        <div class="text-xs text-gray-500 mt-1" data-i18n="dobHelp">Format: DD/MM/YYYY</div>
      </div>

      <!-- Country -->
      <div>
        <label class="form-label" data-i18n="countryLabel">Country of Residence *</label>
        <select id="country" class="form-select" aria-label="Country"></select>
      </div>

      <!-- National Health ID -->
      <div class="md:col-span-2 lg:col-span-3">
        <label class="form-label" data-i18n="nhidLabel">National Health ID</label>
        <input id="nationalHealthId" type="text" class="form-input"
               data-i18n-placeholder="nhidPh"
               placeholder="NHS Number, SSN, etc.">
        <div class="text-xs text-gray-500 mt-1" data-i18n="nhidHelp">NHS Number, Social Security, etc.</div>
      </div>
    </div>

    <div class="flex items-center justify-center mt-8 pt-6 border-t border-gray-200">
      <div class="flex items-center space-x-2 text-sm text-gray-500">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <span data-i18n="autosaves">Auto-saves as you type</span>
      </div>
    </div>
  </div>
</main>

<script>
/* ---------- Chunk 2: Identity + Progress logic + i18n keys ---------- */

// Extend i18n dictionary with Identity/Progress keys
Object.assign(i18n.en, {
  profileCompletionTitle:"Profile Completion",
  profileCompletionSub:"Complete your profile to generate your emergency QR code",
  completeLabel:"Complete",
  identityCheck:"Identity",
  healthCheck:"Health Profile",
  iceCheck:"ICE Contacts",
  codeCheck:"Emergency Code",

  identityTitle:"Identity Information",
  identitySub:"These details help first responders confirm who you are and contact your emergency contacts.",
  fullNameLabel:"Full Legal Name *",
  fullNamePh:"Enter your full legal name",
  fullNameHelp:"As it appears on your ID",
  dobLabel:"Date of Birth *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"Format: DD/MM/YYYY",
  countryLabel:"Country of Residence *",
  nhidLabel:"National Health ID",
  nhidPh:"NHS Number, SSN, etc.",
  nhidHelp:"NHS Number, Social Security, etc.",
  autosaves:"Auto-saves as you type",
  toastSaved:"Saved",
  toastSaveError:"Failed to save",
});

Object.assign(i18n.es, {
  profileCompletionTitle:"Progreso del perfil",
  profileCompletionSub:"Complete su perfil para generar su código QR de emergencia",
  completeLabel:"Completado",
  identityCheck:"Identidad",
  healthCheck:"Perfil de salud",
  iceCheck:"Contactos ICE",
  codeCheck:"Código de emergencia",

  identityTitle:"Información de identidad",
  identitySub:"Estos datos ayudan a confirmar su identidad y contactar a sus personas de emergencia.",
  fullNameLabel:"Nombre legal completo *",
  fullNamePh:"Escriba su nombre legal completo",
  fullNameHelp:"Tal como aparece en su documento",
  dobLabel:"Fecha de nacimiento *",
  dobPh:"DD/MM/AAAA",
  dobHelp:"Formato: DD/MM/AAAA",
  countryLabel:"País de residencia *",
  nhidLabel:"Identificación sanitaria nacional",
  nhidPh:"N° de salud, SSN, etc.",
  nhidHelp:"NHS, Seguro Social, etc.",
  autosaves:"Se guarda automáticamente",
  toastSaved:"Guardado",
  toastSaveError:"Error al guardar",
});

Object.assign(i18n.fr, {
  profileCompletionTitle:"Achèvement du profil",
  profileCompletionSub:"Complétez votre profil pour générer votre QR d’urgence",
  completeLabel:"Terminé",
  identityCheck:"Identité",
  healthCheck:"Profil de santé",
  iceCheck:"Contacts ICE",
  codeCheck:"Code d’urgence",

  identityTitle:"Informations d’identité",
  identitySub:"Ces détails aident les secours à confirmer votre identité et à contacter vos proches.",
  fullNameLabel:"Nom légal complet *",
  fullNamePh:"Saisissez votre nom légal complet",
  fullNameHelp:"Tel qu’indiqué sur votre pièce d’identité",
  dobLabel:"Date de naissance *",
  dobPh:"JJ/MM/AAAA",
  dobHelp:"Format : JJ/MM/AAAA",
  countryLabel:"Pays de résidence *",
  nhidLabel:"Identifiant de santé national",
  nhidPh:"Numéro NHS, sécu, etc.",
  nhidHelp:"NHS, Sécurité sociale, etc.",
  autosaves:"Enregistrement automatique",
  toastSaved:"Enregistré",
  toastSaveError:"Échec de l’enregistrement",
});

Object.assign(i18n.de, {
  profileCompletionTitle:"Profilfortschritt",
  profileCompletionSub:"Profil ausfüllen, um den Notfall-QR-Code zu erhalten",
  completeLabel:"Vollständig",
  identityCheck:"Identität",
  healthCheck:"Gesundheitsprofil",
  iceCheck:"Notfallkontakte",
  codeCheck:"Notfallcode",

  identityTitle:"Identitätsdaten",
  identitySub:"Hilft Einsatzkräften, Ihre Identität zu bestätigen und Kontakte zu erreichen.",
  fullNameLabel:"Vollständiger Name *",
  fullNamePh:"Vollständigen amtlichen Namen eingeben",
  fullNameHelp:"Wie auf Ihrem Ausweis",
  dobLabel:"Geburtsdatum *",
  dobPh:"TT/MM/JJJJ",
  dobHelp:"Format: TT/MM/JJJJ",
  countryLabel:"Wohnsitzland *",
  nhidLabel:"Nationale Gesundheits-ID",
  nhidPh:"NHS-Nummer, SSN, etc.",
  nhidHelp:"NHS-Nummer, Sozialversicherung usw.",
  autosaves:"Speichert automatisch",
  toastSaved:"Gespeichert",
  toastSaveError:"Speichern fehlgeschlagen",
});

Object.assign(i18n.it, {
  profileCompletionTitle:"Completamento profilo",
  profileCompletionSub:"Completa il profilo per generare il QR d’emergenza",
  completeLabel:"Completato",
  identityCheck:"Identità",
  healthCheck:"Profilo sanitario",
  iceCheck:"Contatti ICE",
  codeCheck:"Codice d’emergenza",

  identityTitle:"Informazioni d’identità",
  identitySub:"Aiuta i soccorritori a confermare la tua identità e contattare i referenti.",
  fullNameLabel:"Nome legale completo *",
  fullNamePh:"Inserisci il tuo nome legale completo",
  fullNameHelp:"Come sul documento",
  dobLabel:"Data di nascita *",
  dobPh:"GG/MM/AAAA",
  dobHelp:"Formato: GG/MM/AAAA",
  countryLabel:"Paese di residenza *",
  nhidLabel:"ID sanitario nazionale",
  nhidPh:"N° sanitario, SSN, ecc.",
  nhidHelp:"NHS, Codice fiscale/SSN, ecc.",
  autosaves:"Salvataggio automatico",
  toastSaved:"Salvato",
  toastSaveError:"Errore di salvataggio",
});

Object.assign(i18n.hi, {
  profileCompletionTitle:"प्रोफ़ाइल पूर्णता",
  profileCompletionSub:"आपातकालीन QR बनाने के लिए प्रोफ़ाइल पूरी करें",
  completeLabel:"पूर्ण",
  identityCheck:"पहचान",
  healthCheck:"स्वास्थ्य प्रोफ़ाइल",
  iceCheck:"आपातकालीन संपर्क",
  codeCheck:"आपातकालीन कोड",

  identityTitle:"पहचान संबंधी जानकारी",
  identitySub:"आपकी पहचान की पुष्टि व संपर्क हेतु आवश्यक विवरण।",
  fullNameLabel:"पूरा वैध नाम *",
  fullNamePh:"अपना वैध पूरा नाम लिखें",
  fullNameHelp:"जैसा आपके ID पर है",
  dobLabel:"जन्म तिथि *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"प्रारूप: DD/MM/YYYY",
  countryLabel:"निवास देश *",
  nhidLabel:"राष्ट्रीय स्वास्थ्य ID",
  nhidPh:"NHS, SSN, आदि",
  nhidHelp:"NHS नंबर, सामाजिक सुरक्षा, आदि",
  autosaves:"टाइप करते ही सहेजता है",
  toastSaved:"सहेजा गया",
  toastSaveError:"सहेजने में विफल",
});

Object.assign(i18n.ar, {
  profileCompletionTitle:"إكمال الملف الشخصي",
  profileCompletionSub:"أكمل ملفك لإنشاء رمز الاستجابة للطوارئ",
  completeLabel:"مكتمل",
  identityCheck:"الهوية",
  healthCheck:"الملف الصحي",
  iceCheck:"جهات الطوارئ",
  codeCheck:"رمز الطوارئ",

  identityTitle:"معلومات الهوية",
  identitySub:"تساعد المستجيبين على تأكيد هويتك والتواصل مع جهاتك.",
  fullNameLabel:"الاسم القانوني الكامل *",
  fullNamePh:"أدخل اسمك القانوني الكامل",
  fullNameHelp:"كما في هويتك",
  dobLabel:"تاريخ الميلاد *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"الصيغة: DD/MM/YYYY",
  countryLabel:"بلد الإقامة *",
  nhidLabel:"معرّف الصحة الوطني",
  nhidPh:"رقم NHS أو ما يعادله",
  nhidHelp:"NHS، الضمان الاجتماعي... إلخ",
  autosaves:"يحفظ تلقائيًا",
  toastSaved:"تم الحفظ",
  toastSaveError:"فشل الحفظ",
});

Object.assign(i18n.zh, {
  profileCompletionTitle:"资料完成度",
  profileCompletionSub:"完成资料以生成应急二维码",
  completeLabel:"完成",
  identityCheck:"身份",
  healthCheck:"健康资料",
  iceCheck:"紧急联系人",
  codeCheck:"应急代码",

  identityTitle:"身份信息",
  identitySub:"帮助救援人员确认身份并联系紧急联系人。",
  fullNameLabel:"法定姓名 *",
  fullNamePh:"输入您的法定全名",
  fullNameHelp:"与证件一致",
  dobLabel:"出生日期 *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"格式：DD/MM/YYYY",
  countryLabel:"居住国家 *",
  nhidLabel:"国家健康ID",
  nhidPh:"NHS号、社保号等",
  nhidHelp:"NHS、社保号等",
  autosaves:"输入即自动保存",
  toastSaved:"已保存",
  toastSaveError:"保存失败",
});

Object.assign(i18n.hu, {
  profileCompletionTitle:"Profilkészültség",
  profileCompletionSub:"Töltsd ki a profilt a vész-QR kódhoz",
  completeLabel:"Kész",
  identityCheck:"Személyazonosság",
  healthCheck:"Egészségügyi profil",
  iceCheck:"Vészhelyzeti kontaktok",
  codeCheck:"Vész-kód",

  identityTitle:"Személyes adatok",
  identitySub:"Segít azonosítani és elérni a kapcsolattartókat.",
  fullNameLabel:"Teljes hivatalos név *",
  fullNamePh:"Add meg a hivatalos neved",
  fullNameHelp:"Személyi okmány szerint",
  dobLabel:"Születési dátum *",
  dobPh:"NN/HH/ÉÉÉÉ",
  dobHelp:"Formátum: NN/HH/ÉÉÉÉ",
  countryLabel:"Lakóhely szerinti ország *",
  nhidLabel:"Nemzeti egészségügyi azonosító",
  nhidPh:"NHS, TAJ stb.",
  nhidHelp:"NHS, társadalombiztosítás stb.",
  autosaves:"Automatikus mentés",
  toastSaved:"Mentve",
  toastSaveError:"Sikertelen mentés",
});

Object.assign(i18n.ro, {
  profileCompletionTitle:"Completare profil",
  profileCompletionSub:"Completează profilul pentru a genera codul QR de urgență",
  completeLabel:"Complet",
  identityCheck:"Identitate",
  healthCheck:"Profil medical",
  iceCheck:"Contacte ICE",
  codeCheck:"Cod de urgență",

  identityTitle:"Informații de identitate",
  identitySub:"Ajută salvatorii să îți confirme identitatea și să contacteze apropiații.",
  fullNameLabel:"Nume legal complet *",
  fullNamePh:"Introdu numele legal complet",
  fullNameHelp:"Ca pe actul de identitate",
  dobLabel:"Data nașterii *",
  dobPh:"ZZ/LL/AAAA",
  dobHelp:"Format: ZZ/LL/AAAA",
  countryLabel:"Țara de reședință *",
  nhidLabel:"ID național de sănătate",
  nhidPh:"Număr NHS, CNP, etc.",
  nhidHelp:"NHS, asigurări, etc.",
  autosaves:"Se salvează automat",
  toastSaved:"Salvat",
  toastSaveError:"Eroare la salvare",
});

// Basic country list (short, neutral). You can expand later.
const COUNTRIES = [
  {v:"", t:{en:"Select your country", es:"Seleccione su país", fr:"Sélectionnez votre pays", de:"Land wählen",
             it:"Seleziona il tuo paese", hi:"अपना देश चुनें", ar:"اختر بلدك", zh:"选择您的国家", hu:"Válassz országot", ro:"Selectează țara"}},
  {v:"US", t:{en:"🇺🇸 United States", es:"🇺🇸 Estados Unidos", fr:"🇺🇸 États-Unis", de:"🇺🇸 Vereinigte Staaten", it:"🇺🇸 Stati Uniti",
             hi:"🇺🇸 संयुक्त राज्य", ar:"🇺🇸 الولايات المتحدة", zh:"🇺🇸 美国", hu:"🇺🇸 Egyesült Államok", ro:"🇺🇸 Statele Unite"}},
  {v:"GB", t:{en:"🇬🇧 United Kingdom", es:"🇬🇧 Reino Unido", fr:"🇬🇧 Royaume-Uni", de:"🇬🇧 Vereinigtes Königreich", it:"🇬🇧 Regno Unito",
             hi:"🇬🇧 यूनाइटेड किंगडम", ar:"🇬🇧 المملكة المتحدة", zh:"🇬🇧 英国", hu:"🇬🇧 Egyesült Királyság", ro:"🇬🇧 Regatul Unit"}},
  {v:"CA", t:{en:"🇨🇦 Canada", es:"🇨🇦 Canadá", fr:"🇨🇦 Canada", de:"🇨🇦 Kanada", it:"🇨🇦 Canada", hi:"🇨🇦 कनाडा", ar:"🇨🇦 كندا", zh:"🇨🇦 加拿大", hu:"🇨🇦 Kanada", ro:"🇨🇦 Canada"}},
  {v:"DE", t:{en:"🇩🇪 Germany", es:"🇩🇪 Alemania", fr:"🇩🇪 Allemagne", de:"🇩🇪 Deutschland", it:"🇩🇪 Germania", hi:"🇩🇪 जर्मनी", ar:"🇩🇪 ألمانيا", zh:"🇩🇪 德国", hu:"🇩🇪 Németország", ro:"🇩🇪 Germania"}},
  {v:"FR", t:{en:"🇫🇷 France", es:"🇫🇷 Francia", fr:"🇫🇷 France", de:"🇫🇷 Frankreich", it:"🇫🇷 Francia", hi:"🇫🇷 फ़्रांस", ar:"🇫🇷 فرنسا", zh:"🇫🇷 法国", hu:"🇫🇷 Franciaország", ro:"🇫🇷 Franța"}},
];

// Fill & translate country select
function fillCountrySelect(lang){
  const sel=document.getElementById("country");
  if(!sel) return;
  sel.innerHTML = "";
  const l = i18n[lang] ? lang : "en";
  COUNTRIES.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o.v;
    opt.textContent=o.t[l];
    sel.appendChild(opt);
  });
}

// Hook into global translator
const _origTranslateDynamicOptions = translateDynamicOptions;
translateDynamicOptions = function(lang){
  fillCountrySelect(lang);
  if (typeof _origTranslateDynamicOptions === "function") _origTranslateDynamicOptions(lang);
};

// Identity: mask DOB as DD/MM/YYYY
(function setupDOBMask(){
  document.addEventListener("input", (e)=>{
    if(e.target && e.target.id==="dateOfBirth"){
      let v = e.target.value.replace(/\D/g,"").slice(0,8);
      if (v.length>=5) v = v.slice(0,2)+"/"+v.slice(2,4)+"/"+v.slice(4);
      else if (v.length>=3) v = v.slice(0,2)+"/"+v.slice(2);
      e.target.value = v;
    }
  });
})();

// Debounced saver
let saveTimer=null;
function debounceSave(fn, delay=600){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(fn, delay);
}

// Save Identity to Supabase
async function saveIdentity(){
  try{
    const full_name = (document.getElementById("fullName")?.value||"").trim();
    const date_of_birth = document.getElementById("dateOfBirth")?.value||"";
    const country = document.getElementById("country")?.value||"";
    const national_health_id = document.getElementById("nationalHealthId")?.value||"";

    if (!window.currentUser?.id) return;

    const payload = {
      id: currentUser.id,
      email: currentUser.email,
      full_name, date_of_birth, country, national_health_id
    };

    const { error } = await sb.from("profiles").upsert(payload);
    if (error) throw error;

    updateProfileProgress();
    showToast( (i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(err){
    console.error("saveIdentity", err);
    showToast( (i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

// Load Identity on start
async function loadIdentity(){
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if (!session) { window.location.replace("index.html"); return; }
    window.currentUser = session.user;

    const { data: profile, error } = await sb
      .from("profiles").select("*").eq("id", currentUser.id).single();

    if (!error && profile){
      document.getElementById("fullName").value = profile.full_name||"";
      document.getElementById("dateOfBirth").value = profile.date_of_birth||"";
      // country select will be filled after language init; set value after a tick:
      setTimeout(()=>{ const c=document.getElementById("country"); if(c) c.value = profile.country||""; }, 0);
      document.getElementById("nationalHealthId").value = profile.national_health_id||"";
    }
  }catch(e){
    console.warn("loadIdentity", e);
  }finally{
    updateProfileProgress();
  }
}

// Progress calculation (Identity part here; Health/ICE/Code will update later too)
function isIdentityComplete(){
  const name = (document.getElementById("fullName")?.value||"").trim();
  const dob = document.getElementById("dateOfBirth")?.value||"";
  const country = document.getElementById("country")?.value||"";
  return Boolean(name && dob && country);
}

function updateCheckIndicator(id, ok){
  const root=document.getElementById(id); if(!root) return;
  const dot=root.querySelector("div");
  const label=root.querySelector("span");
  if (ok){
    dot.className="w-4 h-4 rounded-full bg-green-500";
    label.className="text-green-700 font-medium";
  }else{
    dot.className="w-4 h-4 rounded-full bg-gray-300";
    label.className="text-gray-600";
  }
}

// Stubs that later chunks will update:
window.healthComplete = false;   // updated in Health chunk
window.iceComplete = false;      // updated in ICE chunk
window.codePresent  = false;     // updated in QR chunk

function updateProfileProgress(){
  const checks = {
    identity: isIdentityComplete(),
    health: window.healthComplete,
    contacts: window.iceComplete,
    code: window.codePresent
  };
  updateCheckIndicator("checkIdentity", checks.identity);
  updateCheckIndicator("checkHealth", checks.health);
  updateCheckIndicator("checkContacts", checks.contacts);
  updateCheckIndicator("checkCode", checks.code);

  const done = Object.values(checks).filter(Boolean).length;
  const pct = Math.round((done/4)*100);

  const circ = document.getElementById("progressCircle");
  const txt  = document.getElementById("progressPercent");
  const C = 2*Math.PI*28;
  if (circ) circ.setAttribute("stroke-dasharray", `${(pct/100)*C} ${C}`);
  if (txt)  txt.textContent = `${pct}%`;
}

// Wire inputs for autosave + progress
(function wireIdentityInputs(){
  const ids = ["fullName","dateOfBirth","country","nationalHealthId"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    ["input","change","blur"].forEach(evt=>{
      el.addEventListener(evt, ()=>debounceSave(()=>{ saveIdentity(); updateProfileProgress(); }, 700));
    });
  });
})();

// After DOM is ready: load identity (after language init filled selects)
document.addEventListener("DOMContentLoaded", async ()=>{
  // ensure language applied has filled country options
  const lang=document.documentElement.lang||"en";
  fillCountrySelect(lang);
  await loadIdentity();
  updateProfileProgress();
});
</script>
  <!-- === Health Profile Card === -->
<div class="glass-card p-8 mb-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2" data-i18n="healthTitle">Health Profile</h2>
      <p class="text-gray-600" data-i18n="healthSub">Critical medical information that appears on your emergency card. Keep this current and accurate.</p>
    </div>
    <div class="hidden md:block" aria-hidden="true">
      <svg class="w-12 h-12 text-red-500" fill="currentColor" viewBox="0 0 20 20">
        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
      </svg>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Blood Type -->
    <div>
      <label class="form-label" data-i18n="bloodTypeLabel">Blood Type</label>
      <select id="bloodType" class="form-select" aria-label="Blood type">
        <option value="" data-i18n="bloodUnknown">Unknown / Not tested</option>
        <option value="A+">A+ (A Positive)</option>
        <option value="A-">A- (A Negative)</option>
        <option value="B+">B+ (B Positive)</option>
        <option value="B-">B- (B Negative)</option>
        <option value="AB+">AB+ (AB Positive)</option>
        <option value="AB-">AB- (AB Negative)</option>
        <option value="O+">O+ (O Positive)</option>
        <option value="O-">O- (O Negative)</option>
      </select>
      <div class="text-xs text-gray-500 mt-1" data-i18n="bloodHelp">Critical for blood transfusions</div>
    </div>

    <!-- Organ Donor -->
    <div>
      <label class="form-label" data-i18n="donorLabel">Organ Donor Status</label>
      <select id="organDonor" class="form-select" aria-label="Organ donor status">
        <option value="" data-i18n="donorNotSpecified">Not specified</option>
        <option value="true" data-i18n="donorYes">✅ Yes - Registered organ donor</option>
        <option value="false" data-i18n="donorNo">❌ No - Not an organ donor</option>
      </select>
      <div class="text-xs text-gray-500 mt-1" data-i18n="donorHelp">Check your driver's license or ID</div>
    </div>

    <!-- Life Support Preference -->
    <div>
      <label class="form-label" data-i18n="lifeSupportLabel">Life Support Preference</label>
      <select id="lifeSupportPref" class="form-select" aria-label="Life support preference">
        <option value="Full" data-i18n="lifeFull">Full Life Support - Use all measures</option>
        <option value="Limited" data-i18n="lifeLimited">Limited Life Support - Basic care only</option>
        <option value="Comfort" data-i18n="lifeComfort">Comfort Care Only - Pain management</option>
        <option value="DNR" data-i18n="lifeDnr">Do Not Resuscitate (DNR)</option>
      </select>
      <div class="text-xs text-gray-500 mt-1" data-i18n="lifeHelp">Your preference for end-of-life care</div>
    </div>

    <!-- Allergies -->
    <div class="md:col-span-2 lg:col-span-3">
      <label class="form-label">⚠️ <span data-i18n="allergiesLabel">Critical Allergies</span></label>
      <input id="allergiesInput" type="text" class="form-input"
             data-i18n-placeholder="allergiesPh"
             placeholder="Type allergy and press Enter (e.g., Penicillin, Shellfish, Latex, Morphine)">
      <div id="allergiesPills" class="flex flex-wrap gap-2 mt-3"></div>
      <div class="text-xs text-gray-500 mt-2" data-i18n="allergiesHelp">
        Include all drug, food, and environmental allergies that could cause severe reactions.
      </div>
    </div>

    <!-- Conditions -->
    <div class="md:col-span-2 lg:col-span-3">
      <label class="form-label" data-i18n="conditionsLabel">Medical Conditions</label>
      <input id="conditionsInput" type="text" class="form-input"
             data-i18n-placeholder="conditionsPh"
             placeholder="Type condition and press Enter (e.g., Diabetes, Hypertension, Asthma, Epilepsy)">
      <div id="conditionsPills" class="flex flex-wrap gap-2 mt-3"></div>
      <div class="text-xs text-gray-500 mt-2" data-i18n="conditionsHelp">
        Include chronic conditions, mental health conditions, and any ongoing medical issues.
      </div>
    </div>

    <!-- Medications -->
    <div class="md:col-span-2 lg:col-span-3">
      <label class="form-label" data-i18n="medicationsLabel">Current Medications</label>
      <input id="medicationsInput" type="text" class="form-input"
             data-i18n-placeholder="medicationsPh"
             placeholder="Type medication and press Enter (e.g., Insulin, Metformin, Lisinopril)">
      <div id="medicationsPills" class="flex flex-wrap gap-2 mt-3"></div>
      <div class="text-xs text-gray-500 mt-2" data-i18n="medicationsHelp">
        Include prescription medications, over-the-counter medications, and supplements you take regularly.
      </div>
    </div>
  </div>

  <div class="mt-8 p-4 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-start space-x-3">
      <svg class="w-5 h-5 text-red-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
      </svg>
      <div>
        <div class="font-semibold text-red-800 text-sm" data-i18n="criticalNoticeTitle">Critical Information Notice</div>
        <div class="text-red-700 text-sm mt-1" data-i18n="criticalNoticeBody">
          This information will be visible to emergency responders. Only include information that is medically necessary for emergency treatment.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Chunk 3: Health Profile + Pills + Autosave + i18n ---------- */

Object.assign(i18n.en, {
  healthTitle:"Health Profile",
  healthSub:"Critical medical information that appears on your emergency card. Keep this current and accurate.",
  bloodTypeLabel:"Blood Type",
  bloodUnknown:"Unknown / Not tested",
  bloodHelp:"Critical for blood transfusions",
  donorLabel:"Organ Donor Status",
  donorNotSpecified:"Not specified",
  donorYes:"✅ Yes - Registered organ donor",
  donorNo:"❌ No - Not an organ donor",
  donorHelp:"Check your driver's license or ID",
  lifeSupportLabel:"Life Support Preference",
  lifeFull:"Full Life Support - Use all measures",
  lifeLimited:"Limited Life Support - Basic care only",
  lifeComfort:"Comfort Care Only - Pain management",
  lifeDnr:"Do Not Resuscitate (DNR)",
  lifeHelp:"Your preference for end-of-life care",
  allergiesLabel:"Critical Allergies",
  allergiesPh:"Type allergy and press Enter (e.g., Penicillin, Shellfish, Latex, Morphine)",
  allergiesHelp:"Include all drug, food, and environmental allergies that could cause severe reactions.",
  conditionsLabel:"Medical Conditions",
  conditionsPh:"Type condition and press Enter (e.g., Diabetes, Hypertension, Asthma, Epilepsy)",
  conditionsHelp:"Include chronic conditions, mental health conditions, and any ongoing medical issues.",
  medicationsLabel:"Current Medications",
  medicationsPh:"Type medication and press Enter (e.g., Insulin, Metformin, Lisinopril)",
  medicationsHelp:"Include prescription medications, over-the-counter medications, and supplements you take regularly.",
  criticalNoticeTitle:"Critical Information Notice",
  criticalNoticeBody:"This information will be visible to emergency responders. Only include information that is medically necessary for emergency treatment.",
  pillDuplicate:'"{X}" is already added',
  removedX:"Removed {X}",
});

Object.assign(i18n.es, {
  healthTitle:"Perfil de salud",
  healthSub:"Información médica crítica que aparece en su tarjeta de emergencia.",
  bloodTypeLabel:"Grupo sanguíneo",
  bloodUnknown:"Desconocido / No probado",
  bloodHelp:"Crítico para transfusiones",
  donorLabel:"Donante de órganos",
  donorNotSpecified:"No especificado",
  donorYes:"✅ Sí - Donante registrado",
  donorNo:"❌ No - No es donante",
  donorHelp:"Verifique su licencia o ID",
  lifeSupportLabel:"Preferencia de soporte vital",
  lifeFull:"Soporte total - Todas las medidas",
  lifeLimited:"Soporte limitado - Atención básica",
  lifeComfort:"Sólo confort - Control del dolor",
  lifeDnr:"No reanimar (DNR)",
  lifeHelp:"Su preferencia para cuidados al final de la vida",
  allergiesLabel:"Alergias críticas",
  allergiesPh:"Escriba alergia y presione Enter (p. ej., Penicilina, Mariscos, Látex, Morfina)",
  allergiesHelp:"Incluya fármacos, alimentos y ambientales severas.",
  conditionsLabel:"Enfermedades",
  conditionsPh:"Escriba enfermedad y presione Enter",
  conditionsHelp:"Incluya crónicas, salud mental y problemas activos.",
  medicationsLabel:"Medicaciones actuales",
  medicationsPh:"Escriba medicación y presione Enter",
  medicationsHelp:"Incluya recetados, OTC y suplementos.",
  criticalNoticeTitle:"Aviso de información crítica",
  criticalNoticeBody:"Visible para los socorristas. Incluya solo lo necesario para el tratamiento.",
  pillDuplicate:'"{X}" ya está agregado',
  removedX:"Se eliminó {X}",
});

Object.assign(i18n.fr, {
  healthTitle:"Profil de santé",
  healthSub:"Informations médicales critiques affichées sur votre carte d’urgence.",
  bloodTypeLabel:"Groupe sanguin",
  bloodUnknown:"Inconnu / Non testé",
  bloodHelp:"Critique pour les transfusions",
  donorLabel:"Statut de donneur",
  donorNotSpecified:"Non précisé",
  donorYes:"✅ Oui - Donneur enregistré",
  donorNo:"❌ Non - Pas donneur",
  donorHelp:"Vérifiez votre permis/ID",
  lifeSupportLabel:"Préférence de maintien en vie",
  lifeFull:"Maintien complet - Toutes mesures",
  lifeLimited:"Maintien limité - Soins de base",
  lifeComfort:"Soins de confort uniquement",
  lifeDnr:"Ne pas réanimer (DNR)",
  lifeHelp:"Votre préférence de fin de vie",
  allergiesLabel:"Allergies critiques",
  allergiesPh:"Saisir allergie puis Entrée",
  allergiesHelp:"Inclure médicaments, aliments, environnement.",
  conditionsLabel:"Affections médicales",
  conditionsPh:"Saisir affection puis Entrée",
  conditionsHelp:"Inclure chroniques, mentales et en cours.",
  medicationsLabel:"Médicaments actuels",
  medicationsPh:"Saisir médicament puis Entrée",
  medicationsHelp:"Inclure ordonnance, OTC, compléments.",
  criticalNoticeTitle:"Avis d’information critique",
  criticalNoticeBody:"Visible par les secours. Inclure l’essentiel médical.",
  pillDuplicate:'"{X}" est déjà ajouté',
  removedX:"{X} supprimé",
});

Object.assign(i18n.de, {
  healthTitle:"Gesundheitsprofil",
  healthSub:"Kritische medizinische Infos für Ihre Notfallkarte.",
  bloodTypeLabel:"Blutgruppe",
  bloodUnknown:"Unbekannt / Nicht getestet",
  bloodHelp:"Wichtig für Transfusionen",
  donorLabel:"Organspender-Status",
  donorNotSpecified:"Nicht angegeben",
  donorYes:"✅ Ja – Registrierter Spender",
  donorNo:"❌ Nein – Kein Spender",
  donorHelp:"Auf Ausweis/Führerschein prüfen",
  lifeSupportLabel:"Lebenserhaltungs-Präferenz",
  lifeFull:"Volle Maßnahmen",
  lifeLimited:"Begrenzte Maßnahmen",
  lifeComfort:"Nur Komfortpflege",
  lifeDnr:"Nicht reanimieren (DNR)",
  lifeHelp:"Präferenz für End-of-Life",
  allergiesLabel:"Kritische Allergien",
  allergiesPh:"Allergie tippen und Enter",
  allergiesHelp:"Arznei-, Nahrungs- und Umweltallergien.",
  conditionsLabel:"Erkrankungen",
  conditionsPh:"Erkrankung tippen und Enter",
  conditionsHelp:"Chronisch, psychisch, laufend.",
  medicationsLabel:"Aktuelle Medikamente",
  medicationsPh:"Medikament tippen und Enter",
  medicationsHelp:"Verschreibung, OTC, Supplemente.",
  criticalNoticeTitle:"Hinweis: kritische Daten",
  criticalNoticeBody:"Sichtbar für Rettungskräfte. Nur medizinisch Nötiges.",
  pillDuplicate:'"{X}" ist bereits hinzugefügt',
  removedX:"{X} entfernt",
});

Object.assign(i18n.it, {
  healthTitle:"Profilo sanitario",
  healthSub:"Informazioni mediche critiche sulla tua card d’emergenza.",
  bloodTypeLabel:"Gruppo sanguigno",
  bloodUnknown:"Sconosciuto / Non testato",
  bloodHelp:"Cruciale per trasfusioni",
  donorLabel:"Donazione organi",
  donorNotSpecified:"Non specificato",
  donorYes:"✅ Sì - Donatore registrato",
  donorNo:"❌ No - Non donatore",
  donorHelp:"Controlla patente/ID",
  lifeSupportLabel:"Preferenza supporto vitale",
  lifeFull:"Supporto completo",
  lifeLimited:"Supporto limitato",
  lifeComfort:"Solo cure di conforto",
  lifeDnr:"Non rianimare (DNR)",
  lifeHelp:"Preferenze di fine vita",
  allergiesLabel:"Allergie critiche",
  allergiesPh:"Scrivi allergia e Invio",
  allergiesHelp:"Farmaci, alimenti, ambientali.",
  conditionsLabel:"Patologie",
  conditionsPh:"Scrivi patologia e Invio",
  conditionsHelp:"Croniche, mentali, in corso.",
  medicationsLabel:"Farmaci in uso",
  medicationsPh:"Scrivi farmaco e Invio",
  medicationsHelp:"Ricetta, banco, integratori.",
  criticalNoticeTitle:"Avviso: informazioni critiche",
  criticalNoticeBody:"Visibile ai soccorritori. Inserire solo il necessario.",
  pillDuplicate:'"{X}" è già presente',
  removedX:"Rimosso {X}",
});

Object.assign(i18n.hi, {
  healthTitle:"स्वास्थ्य प्रोफ़ाइल",
  healthSub:"आपातकालीन कार्ड पर दिखने वाली महत्वपूर्ण जानकारी।",
  bloodTypeLabel:"रक्त समूह",
  bloodUnknown:"अज्ञात / परीक्षण नहीं",
  bloodHelp:"ट्रांसफ्यूज़न हेतु आवश्यक",
  donorLabel:"अंग दाता स्थिति",
  donorNotSpecified:"निर्दिष्ट नहीं",
  donorYes:"✅ हाँ - पंजीकृत दाता",
  donorNo:"❌ नहीं - दाता नहीं",
  donorHelp:"ड्राइविंग लाइसेंस/ID देखें",
  lifeSupportLabel:"जीवन रक्षक प्राथमिकता",
  lifeFull:"पूर्ण जीवन रक्षक",
  lifeLimited:"सीमित देखभाल",
  lifeComfort:"केवल आराम देखभाल",
  lifeDnr:"डीएनआर (पुनर्जीवन न करें)",
  lifeHelp:"अंतिम देखभाल प्राथमिकता",
  allergiesLabel:"संवेदी (क्रिटिकल) एलर्जी",
  allergiesPh:"एलर्जी लिखें और Enter दबाएँ",
  allergiesHelp:"दवा/भोजन/पर्यावरण एलर्जी शामिल करें।",
  conditionsLabel:"चिकित्सीय स्थितियाँ",
  conditionsPh:"स्थिति लिखें और Enter दबाएँ",
  conditionsHelp:"दीर्घकालिक, मानसिक, जारी समस्याएँ।",
  medicationsLabel:"वर्तमान दवाइयाँ",
  medicationsPh:"दवा लिखें और Enter दबाएँ",
  medicationsHelp:"प्रिस्क्रिप्शन, OTC, सप्लीमेंट।",
  criticalNoticeTitle:"महत्वपूर्ण सूचना",
  criticalNoticeBody:"यह जानकारी रेस्पॉन्डर्स को दिखेगी; केवल आवश्यक जानकारी दें।",
  pillDuplicate:'"{X}" पहले से जोड़ा गया है',
  removedX:"{X} हटाया गया",
});

Object.assign(i18n.ar, {
  healthTitle:"الملف الصحي",
  healthSub:"معلومات طبية حرجة تظهر في بطاقة الطوارئ.",
  bloodTypeLabel:"فصيلة الدم",
  bloodUnknown:"غير معروف / غير مختبر",
  bloodHelp:"مهم لعمليات نقل الدم",
  donorLabel:"حالة التبرع بالأعضاء",
  donorNotSpecified:"غير محدد",
  donorYes:"✅ نعم - متبرع مسجل",
  donorNo:"❌ لا - غير متبرع",
  donorHelp:"تحقق من رخصتك أو هويتك",
  lifeSupportLabel:"تفضيل دعم الحياة",
  lifeFull:"دعم كامل",
  lifeLimited:"دعم محدود",
  lifeComfort:"رعاية مريحة فقط",
  lifeDnr:"عدم الإنعاش (DNR)",
  lifeHelp:"تفضيل رعاية نهاية الحياة",
  allergiesLabel:"حساسيات حرجة",
  allergiesPh:"اكتب الحساسية واضغط إدخال",
  allergiesHelp:"أدوية، أطعمة وبيئية شديدة.",
  conditionsLabel:"حالات طبية",
  conditionsPh:"اكتب الحالة واضغط إدخال",
  conditionsHelp:"مزمنة ونفسية وجارية.",
  medicationsLabel:"الأدوية الحالية",
  medicationsPh:"اكتب الدواء واضغط إدخال",
  medicationsHelp:"وصفات، بدون وصفة، ومكملات.",
  criticalNoticeTitle:"تنبيه معلومات حرجة",
  criticalNoticeBody:"مرئية للمستجيبين. أدرج الضروري فقط للعلاج.",
  pillDuplicate:'"{X}" مُضافة مسبقًا',
  removedX:"تمت إزالة {X}",
});

Object.assign(i18n.zh, {
  healthTitle:"健康资料",
  healthSub:"将显示在应急卡上的关键信息。",
  bloodTypeLabel:"血型",
  bloodUnknown:"未知 / 未检测",
  bloodHelp:"输血关键",
  donorLabel:"器官捐献状态",
  donorNotSpecified:"未指定",
  donorYes:"✅ 是 - 登记捐献者",
  donorNo:"❌ 否 - 非捐献者",
  donorHelp:"查看驾照或证件",
  lifeSupportLabel:"生命维持偏好",
  lifeFull:"全力救治",
  lifeLimited:"有限救治",
  lifeComfort:"仅舒缓护理",
  lifeDnr:"不复苏（DNR）",
  lifeHelp:"临终关怀偏好",
  allergiesLabel:"重要过敏",
  allergiesPh:"输入过敏并按回车",
  allergiesHelp:"包括药物、食物与环境过敏。",
  conditionsLabel:"疾病情况",
  conditionsPh:"输入疾病并按回车",
  conditionsHelp:"包括慢性、精神及正在治疗的问题。",
  medicationsLabel:"当前用药",
  medicationsPh:"输入药物并按回车",
  medicationsHelp:"处方药、非处方及补充剂。",
  criticalNoticeTitle:"重要信息提示",
  criticalNoticeBody:"对救援人员可见，仅填写救治所需信息。",
  pillDuplicate:'"{X}" 已存在',
  removedX:"已移除 {X}",
});

Object.assign(i18n.hu, {
  healthTitle:"Egészségügyi profil",
  healthSub:"Kritikus információk a vész-kártyán.",
  bloodTypeLabel:"Vércsoport",
  bloodUnknown:"Ismeretlen / Nem tesztelt",
  bloodHelp:"Transzfúzióhoz fontos",
  donorLabel:"Szervdonor státusz",
  donorNotSpecified:"Nincs megadva",
  donorYes:"✅ Igen – regisztrált donor",
  donorNo:"❌ Nem – nem donor",
  donorHelp:"Jogsi/ID ellenőrzése",
  lifeSupportLabel:"Életjele-támogatás",
  lifeFull:"Teljes ellátás",
  lifeLimited:"Korlátozott ellátás",
  lifeComfort:"Csak komfort",
  lifeDnr:"Ne élesszék újra (DNR)",
  lifeHelp:"Végső ellátási preferencia",
  allergiesLabel:"Kritikus allergiák",
  allergiesPh:"Írj allergiát és Enter",
  allergiesHelp:"Gyógyszer-, étel-, környezeti.",
  conditionsLabel:"Betegségek",
  conditionsPh:"Írj betegséget és Enter",
  conditionsHelp:"Krónikus, mentális, fennálló.",
  medicationsLabel:"Gyógyszerek",
  medicationsPh:"Írj gyógyszert és Enter",
  medicationsHelp:"Vényköteles, OTC, kiegészítők.",
  criticalNoticeTitle:"Figyelem: kritikus adatok",
  criticalNoticeBody:"Mentők látják. Csak a szükségest add meg.",
  pillDuplicate:'" {X} " már hozzáadva',
  removedX:"Eltávolítva: {X}",
});

Object.assign(i18n.ro, {
  healthTitle:"Profil medical",
  healthSub:"Informații critice afișate pe cardul de urgență.",
  bloodTypeLabel:"Grupa sanguină",
  bloodUnknown:"Necunoscută / Netestat",
  bloodHelp:"Esential pentru transfuzie",
  donorLabel:"Donator de organe",
  donorNotSpecified:"Nespecificat",
  donorYes:"✅ Da - Donator înregistrat",
  donorNo:"❌ Nu - Nu este donator",
  donorHelp:"Verifică permisul/CI",
  lifeSupportLabel:"Preferință suport vital",
  lifeFull:"Suport total",
  lifeLimited:"Suport limitat",
  lifeComfort:"Doar confort",
  lifeDnr:"Nu resuscita (DNR)",
  lifeHelp:"Preferință pentru îngrijire la finalul vieții",
  allergiesLabel:"Alergii critice",
  allergiesPh:"Tastează alergia și Enter",
  allergiesHelp:"Include alergii la medicamente, alimente, mediu.",
  conditionsLabel:"Afectiuni medicale",
  conditionsPh:"Tastează afecțiunea și Enter",
  conditionsHelp:"Include cronice, mentale și în desfășurare.",
  medicationsLabel:"Medicație curentă",
  medicationsPh:"Tastează medicamentul și Enter",
  medicationsHelp:"Include rețetă, OTC și suplimente.",
  criticalNoticeTitle:"Atenție: informații critice",
  criticalNoticeBody:"Vizibile pentru salvatori. Include doar ce e necesar medical.",
  pillDuplicate:'„{X}” este deja adăugat',
  removedX:"S-a eliminat {X}",
});

// pills state (shared)
window.pillData = window.pillData || { allergies:[], conditions:[], medications:[] };

// add pill
function addPill(type, value){
  const v = value.trim();
  if(!v) return;
  if (pillData[type].some(x=>x.toLowerCase()===v.toLowerCase())){
    const t=(i18n[document.documentElement.lang]||i18n.en).pillDuplicate.replace("{X}", v);
    showToast(t, "warning"); return;
  }
  pillData[type].push(v);
  renderPills(type);
  debounceSave(saveHealth, 600);
  updateHealthCompletion();
}

function removePill(type, index){
  const removed = pillData[type].splice(index,1)[0];
  renderPills(type);
  debounceSave(saveHealth, 600);
  updateHealthCompletion();
  const t=(i18n[document.documentElement.lang]||i18n.en).removedX.replace("{X}", removed);
  showToast(t, "success");
}

function renderPills(type){
  const container = document.getElementById(type+"Pills");
  if(!container) return;
  container.innerHTML = pillData[type].map((txt, i)=>`
    <div class="pill">
      ${txt}
      <span class="pill-remove" role="button" aria-label="remove"
            onclick="removePill('${type}', ${i})">×</span>
    </div>
  `).join("");
}

// wire Enter on inputs
(function wirePillInputs(){
  ["allergies","conditions","medications"].forEach(type=>{
    const input = document.getElementById(type+"Input");
    if(!input) return;
    input.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        addPill(type, input.value);
        input.value="";
      }
    });
  });
})();

// save to Supabase (health_profiles)
async function saveHealth(){
  try{
    if(!currentUser?.id) return;
    const blood_type = document.getElementById("bloodType")?.value||"";
    const organDonorVal = document.getElementById("organDonor")?.value||"";
    const organ_donor = organDonorVal==="" ? null : (organDonorVal==="true");
    const life_support_pref = document.getElementById("lifeSupportPref")?.value||"Full";

    const payload = {
      user_id: currentUser.id,
      blood_type,
      organ_donor,
      life_support_pref,
      allergies: pillData.allergies.join(", "),
      conditions: pillData.conditions.join(", "),
      medications: pillData.medications.join(", ")
    };

    const { error } = await sb.from("health_profiles").upsert(payload);
    if (error) throw error;

    updateHealthCompletion();
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(err){
    console.error("saveHealth", err);
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

// load from Supabase
async function loadHealth(){
  try{
    if(!currentUser?.id) return;
    const { data, error } = await sb.from("health_profiles").select("*").eq("user_id", currentUser.id).single();
    if (error && error.code!=="PGRST116") throw error;
    if (data){
      document.getElementById("bloodType").value = data.blood_type||"";
      const donorSel=document.getElementById("organDonor");
      donorSel.value = (data.organ_donor===null||data.organ_donor===undefined) ? "" : String(!!data.organ_donor);
      document.getElementById("lifeSupportPref").value = data.life_support_pref||"Full";
      pillData.allergies = (data.allergies||"").split(",").map(s=>s.trim()).filter(Boolean);
      pillData.conditions= (data.conditions||"").split(",").map(s=>s.trim()).filter(Boolean);
      pillData.medications=(data.medications||"").split(",").map(s=>s.trim()).filter(Boolean);
      renderPills("allergies"); renderPills("conditions"); renderPills("medications");
    }
  }catch(e){
    console.warn("loadHealth", e);
  }finally{
    updateHealthCompletion();
  }
}

// health completion affects progress
function updateHealthCompletion(){
  const blood = document.getElementById("bloodType")?.value||"";
  const hasAll = pillData.allergies.length>0;
  const hasCond= pillData.conditions.length>0;
  window.healthComplete = Boolean(blood || hasAll || hasCond);
  updateCheckIndicator("checkHealth", window.healthComplete);
  updateProfileProgress();
}

// change listeners
["bloodType","organDonor","lifeSupportPref"].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  ["change","input","blur"].forEach(evt=>{
    el.addEventListener(evt, ()=>debounceSave(()=>{ saveHealth(); }, 500));
  });
});

// init after DOM ready (called after Identity already loaded)
document.addEventListener("DOMContentLoaded", async ()=>{
  await loadHealth();
  updateHealthCompletion();
});
</script>
  <!-- === Emergency Contacts (ICE) === -->
<div class="glass-card p-8 mb-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2" data-i18n="iceTitle">Emergency Contacts (ICE)</h2>
      <p class="text-gray-600" data-i18n="iceSub">Add up to 5 trusted people who can be reached in an emergency.</p>
    </div>
    <div class="hidden md:block" aria-hidden="true">
      <svg class="w-12 h-12 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
      </svg>
    </div>
  </div>

  <div id="iceContacts" class="space-y-6"></div>

  <div class="flex items-center justify-between mt-6 pt-6 border-t border-gray-200">
    <div class="text-sm text-gray-500">
      <span id="contactCount">0</span> <span data-i18n="iceOfFive">of 5 contacts added</span>
    </div>
    <button id="addIceBtn" class="btn-secondary">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path>
      </svg>
      <span data-i18n="iceAddBtn">Add Emergency Contact</span>
    </button>
  </div>
</div>

<!-- === Automated Triage === -->
<div class="glass-card p-6 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-slate-900" data-i18n="triageTitle">Automated Triage</h2>
    <svg class="w-8 h-8 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
    </svg>
  </div>

  <p class="text-sm text-gray-600 mb-6" data-i18n="triageSub">Auto-computed priority level based on your health profile.</p>

  <div class="text-center mb-6">
    <div id="triageStatus" class="triage-status triage-green" data-i18n="triageGreenAuto">GREEN - Standard (Auto)</div>
  </div>

  <div class="mb-6">
    <label class="form-label" data-i18n="triageOverrideLabel">Manual Override</label>
    <select id="triageOverride" class="form-select" aria-label="Triage override">
      <option value="" data-i18n="triageAuto">🤖 Auto (Recommended)</option>
      <option value="Green" data-i18n="triageGreen">🟢 Green - Standard Priority</option>
      <option value="Amber" data-i18n="triageAmber">🟡 Amber - Urgent Priority</option>
      <option value="Red" data-i18n="triageRed">🔴 Red - Immediate Priority</option>
      <option value="Black" data-i18n="triageBlack">⚫ Black - Comfort Care</option>
    </select>
    <div class="text-xs text-gray-500 mt-1" data-i18n="triageHint">Override only if you have specific medical directives.</div>
  </div>
</div>

<script>
/* ---------- Chunk 4: ICE Contacts + Triage (autosave + i18n) ---------- */

window.maxIce = 5;

// --- i18n additions (toasts + ICE + triage) ---
["en","es","fr","de","it","hi","ar","zh","hu","ro"].forEach(l=>{ i18n[l]=i18n[l]||{}; });
Object.assign(i18n.en,{
  toastSaved:"Saved",
  toastSaveError:"Save failed",
  iceTitle:"Emergency Contacts (ICE)",
  iceSub:"Add up to 5 trusted people who can be reached in an emergency.",
  iceOfFive:"of 5 contacts added",
  iceAddBtn:"Add Emergency Contact",
  iceName:"Full Name *",
  iceRel:"Relationship",
  icePhone:"Phone Number *",
  iceEmail:"Email (Optional)",
  iceNotes:"Notes (Optional)",
  iceRemove:"Remove Contact",
  relSpouse:"Spouse", relPartner:"Partner", relParent:"Parent", relChild:"Child", relSibling:"Sibling",
  relFriend:"Friend", relColleague:"Colleague", relDoctor:"Doctor", relLawyer:"Lawyer", relOther:"Other",
  triageTitle:"Automated Triage",
  triageSub:"Auto-computed priority level based on your health profile.",
  triageOverrideLabel:"Manual Override",
  triageAuto:"🤖 Auto (Recommended)",
  triageGreen:"🟢 Green - Standard Priority",
  triageAmber:"🟡 Amber - Urgent Priority",
  triageRed:"🔴 Red - Immediate Priority",
  triageBlack:"⚫ Black - Comfort Care",
  triageHint:"Override only if you have specific medical directives.",
  triageGreenAuto:"GREEN - Standard (Auto)",
  triageAmberAuto:"AMBER - Urgent (Auto)",
  triageRedAuto:"RED - Immediate (Auto)",
  triageBlackAuto:"BLACK - Comfort (Auto)"
});
Object.assign(i18n.es,{
  toastSaved:"Guardado", toastSaveError:"Error al guardar",
  iceTitle:"Contactos de emergencia (ICE)",
  iceSub:"Agregue hasta 5 personas de confianza.",
  iceOfFive:"de 5 contactos agregados",
  iceAddBtn:"Añadir contacto",
  iceName:"Nombre completo *", iceRel:"Relación", icePhone:"Teléfono *",
  iceEmail:"Correo (Opcional)", iceNotes:"Notas (Opcional)", iceRemove:"Eliminar",
  relSpouse:"Cónyuge", relPartner:"Pareja", relParent:"Padre/Madre", relChild:"Hijo/a", relSibling:"Hermano/a",
  relFriend:"Amigo/a", relColleague:"Colega", relDoctor:"Médico", relLawyer:"Abogado/a", relOther:"Otro",
  triageTitle:"Triaje automatizado",
  triageSub:"Nivel calculado según su perfil.",
  triageOverrideLabel:"Anulación manual",
  triageAuto:"🤖 Automático (Recomendado)",
  triageGreen:"🟢 Verde - Prioridad estándar",
  triageAmber:"🟡 Ámbar - Urgente",
  triageRed:"🔴 Rojo - Inmediata",
  triageBlack:"⚫ Negro - Confort",
  triageHint:"Use solo si tiene directivas médicas.",
  triageGreenAuto:"VERDE - Estándar (Auto)",
  triageAmberAuto:"ÁMBAR - Urgente (Auto)",
  triageRedAuto:"ROJO - Inmediata (Auto)",
  triageBlackAuto:"NEGRO - Confort (Auto)"
});
Object.assign(i18n.fr,{
  toastSaved:"Enregistré", toastSaveError:"Échec de l’enregistrement",
  iceTitle:"Contacts d’urgence (ICE)",
  iceSub:"Ajoutez jusqu’à 5 personnes de confiance.",
  iceOfFive:"sur 5 contacts ajoutés",
  iceAddBtn:"Ajouter un contact",
  iceName:"Nom complet *", iceRel:"Lien", icePhone:"Téléphone *",
  iceEmail:"E-mail (Optionnel)", iceNotes:"Notes (Optionnel)", iceRemove:"Supprimer",
  relSpouse:"Conjoint", relPartner:"Partenaire", relParent:"Parent", relChild:"Enfant", relSibling:"Frère/Sœur",
  relFriend:"Ami(e)", relColleague:"Collègue", relDoctor:"Médecin", relLawyer:"Avocat", relOther:"Autre",
  triageTitle:"Triage automatisé",
  triageSub:"Niveau calculé selon votre profil.",
  triageOverrideLabel:"Forcer manuellement",
  triageAuto:"🤖 Auto (Recommandé)",
  triageGreen:"🟢 Vert - Standard",
  triageAmber:"🟡 Ambre - Urgent",
  triageRed:"🔴 Rouge - Immédiat",
  triageBlack:"⚫ Noir - Confort",
  triageHint:"N’utiliser qu’avec directives médicales.",
  triageGreenAuto:"VERT - Standard (Auto)",
  triageAmberAuto:"AMBRE - Urgent (Auto)",
  triageRedAuto:"ROUGE - Immédiat (Auto)",
  triageBlackAuto:"NOIR - Confort (Auto)"
});
Object.assign(i18n.de,{
  toastSaved:"Gespeichert", toastSaveError:"Speichern fehlgeschlagen",
  iceTitle:"Notfallkontakte (ICE)",
  iceSub:"Fügen Sie bis zu 5 Vertrauenspersonen hinzu.",
  iceOfFive:"von 5 Kontakten",
  iceAddBtn:"Kontakt hinzufügen",
  iceName:"Vollständiger Name *", iceRel:"Beziehung", icePhone:"Telefon *",
  iceEmail:"E-Mail (Optional)", iceNotes:"Notizen (Optional)", iceRemove:"Entfernen",
  relSpouse:"Ehepartner", relPartner:"Partner", relParent:"Elternteil", relChild:"Kind", relSibling:"Geschwister",
  relFriend:"Freund", relColleague:"Kollege", relDoctor:"Arzt", relLawyer:"Anwalt", relOther:"Sonstiges",
  triageTitle:"Automatisches Triage",
  triageSub:"Stufe basierend auf Profil.",
  triageOverrideLabel:"Manuelle Überschreibung",
  triageAuto:"🤖 Auto (Empfohlen)",
  triageGreen:"🟢 Grün - Standard",
  triageAmber:"🟡 Gelb - Dringend",
  triageRed:"🔴 Rot - Sofort",
  triageBlack:"⚫ Schwarz - Komfort",
  triageHint:"Nur bei medizinischen Weisungen.",
  triageGreenAuto:"GRÜN - Standard (Auto)",
  triageAmberAuto:"GELB - Dringend (Auto)",
  triageRedAuto:"ROT - Sofort (Auto)",
  triageBlackAuto:"SCHWARZ - Komfort (Auto)"
});
Object.assign(i18n.it,{
  toastSaved:"Salvato", toastSaveError:"Salvataggio fallito",
  iceTitle:"Contatti di emergenza (ICE)",
  iceSub:"Aggiungi fino a 5 persone fidate.",
  iceOfFive:"di 5 contatti",
  iceAddBtn:"Aggiungi contatto",
  iceName:"Nome completo *", iceRel:"Relazione", icePhone:"Telefono *",
  iceEmail:"Email (Opzionale)", iceNotes:"Note (Opzionale)", iceRemove:"Rimuovi",
  relSpouse:"Coniuge", relPartner:"Partner", relParent:"Genitore", relChild:"Figlio/a", relSibling:"Fratello/Sorella",
  relFriend:"Amico", relColleague:"Collega", relDoctor:"Medico", relLawyer:"Avvocato", relOther:"Altro",
  triageTitle:"Triage automatico",
  triageSub:"Livello calcolato dal profilo.",
  triageOverrideLabel:"Forzatura manuale",
  triageAuto:"🤖 Auto (Consigliato)",
  triageGreen:"🟢 Verde - Standard",
  triageAmber:"🟡 Ambra - Urgente",
  triageRed:"🔴 Rosso - Immediato",
  triageBlack:"⚫ Nero - Comfort",
  triageHint:"Usare solo con direttive mediche.",
  triageGreenAuto:"VERDE - Standard (Auto)",
  triageAmberAuto:"AMBRA - Urgente (Auto)",
  triageRedAuto:"ROSSO - Immediato (Auto)",
  triageBlackAuto:"NERO - Comfort (Auto)"
});
Object.assign(i18n.hi,{
  toastSaved:"सहेजा गया", toastSaveError:"सहेजना विफल",
  iceTitle:"आपातकालीन संपर्क (ICE)",
  iceSub:"अधिकतम 5 विश्वसनीय लोग जोड़ें।",
  iceOfFive:"में से 5 संपर्क",
  iceAddBtn:"संपर्क जोड़ें",
  iceName:"पूरा नाम *", iceRel:"संबंध", icePhone:"फ़ोन *",
  iceEmail:"ईमेल (वैकल्पिक)", iceNotes:"नोट्स (वैकल्पिक)", iceRemove:"हटाएँ",
  relSpouse:"पत्नी/पति", relPartner:"साथी", relParent:"माता/पिता", relChild:"संतान", relSibling:"भाई/बहन",
  relFriend:"मित्र", relColleague:"सहकर्मी", relDoctor:"डॉक्टर", relLawyer:"वकील", relOther:"अन्य",
  triageTitle:"स्वचालित ट्रायाज",
  triageSub:"स्वास्थ्य प्रोफ़ाइल के आधार पर।",
  triageOverrideLabel:"मैनुअल ओवरराइड",
  triageAuto:"🤖 ऑटो (अनुशंसित)",
  triageGreen:"🟢 ग्रीन - मानक",
  triageAmber:"🟡 एम्बर - आपात",
  triageRed:"🔴 रेड - तात्कालिक",
  triageBlack:"⚫ ब्लैक - कंफर्ट",
  triageHint:"केवल चिकित्सकीय निर्देश पर बदलें।",
  triageGreenAuto:"ग्रीन - मानक (ऑटो)",
  triageAmberAuto:"एम्बर - आपात (ऑटो)",
  triageRedAuto:"रेड - तात्कालिक (ऑटो)",
  triageBlackAuto:"ब्लैक - कंफर्ट (ऑटो)"
});
Object.assign(i18n.ar,{
  toastSaved:"تم الحفظ", toastSaveError:"فشل الحفظ",
  iceTitle:"جهات اتصال الطوارئ (ICE)",
  iceSub:"أضف ما يصل إلى 5 أشخاص موثوقين.",
  iceOfFive:"من 5 جهات اتصال",
  iceAddBtn:"إضافة جهة اتصال",
  iceName:"الاسم الكامل *", iceRel:"العلاقة", icePhone:"الهاتف *",
  iceEmail:"البريد (اختياري)", iceNotes:"ملاحظات (اختياري)", iceRemove:"حذف",
  relSpouse:"زوج/زوجة", relPartner:"شريك", relParent:"أب/أم", relChild:"ابن/ابنة", relSibling:"أخ/أخت",
  relFriend:"صديق", relColleague:"زميل", relDoctor:"طبيب", relLawyer:"محام", relOther:"آخر",
  triageTitle:"فرز تلقائي",
  triageSub:"يُحسب من ملفك الصحي.",
  triageOverrideLabel:"تجاوز يدوي",
  triageAuto:"🤖 تلقائي (مُوصى به)",
  triageGreen:"🟢 أخضر - عادي",
  triageAmber:"🟡 كهرماني - عاجل",
  triageRed:"🔴 أحمر - فوري",
  triageBlack:"⚫ أسود - رعاية مريحة",
  triageHint:"استخدم فقط عند وجود تعليمات طبية.",
  triageGreenAuto:"أخضر - عادي (تلقائي)",
  triageAmberAuto:"كهرماني - عاجل (تلقائي)",
  triageRedAuto:"أحمر - فوري (تلقائي)",
  triageBlackAuto:"أسود - مريح (تلقائي)"
});
Object.assign(i18n.zh,{
  toastSaved:"已保存", toastSaveError:"保存失败",
  iceTitle:"紧急联络人 (ICE)",
  iceSub:"最多添加 5 位可信联系人。",
  iceOfFive:"/5 位联系人",
  iceAddBtn:"添加联系人",
  iceName:"全名 *", iceRel:"关系", icePhone:"电话 *",
  iceEmail:"邮箱（可选）", iceNotes:"备注（可选）", iceRemove:"删除",
  relSpouse:"配偶", relPartner:"伴侣", relParent:"父母", relChild:"子女", relSibling:"兄弟姐妹",
  relFriend:"朋友", relColleague:"同事", relDoctor:"医生", relLawyer:"律师", relOther:"其他",
  triageTitle:"自动分级",
  triageSub:"基于健康资料计算。",
  triageOverrideLabel:"手动覆盖",
  triageAuto:"🤖 自动（推荐）",
  triageGreen:"🟢 绿色 - 标准",
  triageAmber:"🟡 琥珀 - 紧急",
  triageRed:"🔴 红色 - 立即",
  triageBlack:"⚫ 黑色 - 舒缓",
  triageHint:"仅在有医疗指示时更改。",
  triageGreenAuto:"绿色 - 标准（自动）",
  triageAmberAuto:"琥珀 - 紧急（自动）",
  triageRedAuto:"红色 - 立即（自动）",
  triageBlackAuto:"黑色 - 舒缓（自动）"
});
Object.assign(i18n.hu,{
  toastSaved:"Mentve", toastSaveError:"Mentés sikertelen",
  iceTitle:"Vészhelyzeti kapcsolatok (ICE)",
  iceSub:"Legfeljebb 5 megbízható személy.",
  iceOfFive:"/5 kapcsolat",
  iceAddBtn:"Kapcsolat hozzáadása",
  iceName:"Teljes név *", iceRel:"Kapcsolat", icePhone:"Telefon *",
  iceEmail:"E-mail (Opcionális)", iceNotes:"Megjegyzés (Opcionális)", iceRemove:"Eltávolítás",
  relSpouse:"Házastárs", relPartner:"Élettárs", relParent:"Szülő", relChild:"Gyermek", relSibling:"Testvér",
  relFriend:"Barát", relColleague:"Kolléga", relDoctor:"Orvos", relLawyer:"Ügyvéd", relOther:"Egyéb",
  triageTitle:"Automatikus triázs",
  triageSub:"Profil alapján számítva.",
  triageOverrideLabel:"Kézi felülbírálat",
  triageAuto:"🤖 Auto (Ajánlott)",
  triageGreen:"🟢 Zöld - Standard",
  triageAmber:"🟡 Borostyán - Sürgős",
  triageRed:"🔴 Piros - Azonnali",
  triageBlack:"⚫ Fekete - Komfort",
  triageHint:"Csak orvosi utasítás esetén.",
  triageGreenAuto:"ZÖLD - Standard (Auto)",
  triageAmberAuto:"BOROSTYÁN - Sürgős (Auto)",
  triageRedAuto:"PIROS - Azonnali (Auto)",
  triageBlackAuto:"FEKETE - Komfort (Auto)"
});
Object.assign(i18n.ro,{
  toastSaved:"Salvat", toastSaveError:"Eroare la salvare",
  iceTitle:"Contacte de urgență (ICE)",
  iceSub:"Adaugă până la 5 persoane de încredere.",
  iceOfFive:"din 5 contacte",
  iceAddBtn:"Adaugă contact",
  iceName:"Nume complet *", iceRel:"Relație", icePhone:"Telefon *",
  iceEmail:"Email (Opțional)", iceNotes:"Note (Opțional)", iceRemove:"Șterge",
  relSpouse:"Soț/Soție", relPartner:"Partener", relParent:"Părinte", relChild:"Copil", relSibling:"Frate/Soră",
  relFriend:"Prieteni", relColleague:"Colega", relDoctor:"Medic", relLawyer:"Avocat", relOther:"Altul",
  triageTitle:"Triere automată",
  triageSub:"Nivel calculat din profil.",
  triageOverrideLabel:"Suprascriere manuală",
  triageAuto:"🤖 Auto (Recomandat)",
  triageGreen:"🟢 Verde - Standard",
  triageAmber:"🟡 Chihlimbar - Urgent",
  triageRed:"🔴 Roșu - Imediat",
  triageBlack:"⚫ Negru - Confort",
  triageHint:"Folosiți doar cu directive medicale.",
  triageGreenAuto:"VERDE - Standard (Auto)",
  triageAmberAuto:"CHIH - Urgent (Auto)",
  triageRedAuto:"ROȘU - Imediat (Auto)",
  triageBlackAuto:"NEGRU - Confort (Auto)"
});

// --- ICE rendering helpers ---
function iceRelOptions(selected=""){
  const t = i18n[document.documentElement.lang]||i18n.en;
  const opts = [
    ["", t.iceRel],
    ["Spouse", t.relSpouse],["Partner", t.relPartner],["Parent", t.relParent],["Child", t.relChild],
    ["Sibling", t.relSibling],["Friend", t.relFriend],["Colleague", t.relColleague],["Doctor", t.relDoctor],
    ["Lawyer", t.relLawyer],["Other", t.relOther]
  ];
  return opts.map(([v,l])=>`<option value="${v}" ${v===selected?"selected":""}>${l}</option>`).join("");
}

function contactCardTemplate(c){
  const t=i18n[document.documentElement.lang]||i18n.en;
  return `
  <div class="ice-contact-card" data-card data-sbid="${c.id||""}">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="form-label">${t.iceName}</label>
        <input type="text" class="form-input" data-field="name" placeholder="${t.iceName}" value="${c.name||""}">
      </div>
      <div>
        <label class="form-label">${t.iceRel}</label>
        <select class="form-select" data-field="relationship">${iceRelOptions(c.relationship||"")}</select>
      </div>
      <div>
        <label class="form-label">${t.icePhone}</label>
        <input type="tel" class="form-input" data-field="phone" placeholder="+1 (555) 123-4567" value="${c.phone||""}">
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="form-label">${t.iceEmail}</label>
        <input type="email" class="form-input" data-field="email" placeholder="contact@example.com" value="${c.email||""}">
      </div>
      <div>
        <label class="form-label">${t.iceNotes}</label>
        <input type="text" class="form-input" data-field="notes" placeholder="" value="${c.notes||""}">
      </div>
    </div>
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
      <button type="button" class="text-red-600 text-sm hover:text-red-800 font-medium" data-remove>
        <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7V4h6v3M4 7h16"></path>
        </svg>${t.iceRemove}
      </button>
      <div class="text-xs text-gray-500" data-i18n="autosaves">Auto-saves on change</div>
    </div>
  </div>`;
}

// --- ICE state + wiring ---
async function loadIceContacts(){
  try{
    const list = document.getElementById("iceContacts");
    list.innerHTML="";
    if(!currentUser?.id) return;
    const { data, error } = await sb.from("ice_contacts").select("*").eq("user_id", currentUser.id).order("created_at");
    if(error) throw error;
    (data||[]).forEach(row=>{
      list.insertAdjacentHTML("beforeend", contactCardTemplate(row));
    });
    wireIceCards();
    updateIceCount();
    updateProfileProgress();
  }catch(e){
    console.warn("loadIceContacts", e);
  }
}

function wireIceCards(){
  document.querySelectorAll('[data-card]').forEach(card=>{
    card.querySelectorAll('[data-field]').forEach(input=>{
      ["change","blur","input"].forEach(evt=>{
        input.addEventListener(evt, ()=>debounceSave(()=>saveIceCard(card), 600));
      });
    });
    card.querySelector('[data-remove]').addEventListener('click', ()=>removeIceCard(card));
  });
}

function updateIceCount(){
  const n = document.querySelectorAll('#iceContacts [data-card]').length;
  document.getElementById('contactCount').textContent = n;
  const btn = document.getElementById('addIceBtn');
  btn.disabled = n>=maxIce;
  btn.classList.toggle('opacity-50', n>=maxIce);
  window.iceComplete = n>0;
  updateCheckIndicator("checkContacts", window.iceComplete);
  updateProfileProgress();
}

document.getElementById('addIceBtn').addEventListener('click', ()=>{
  const n = document.querySelectorAll('#iceContacts [data-card]').length;
  if(n>=maxIce){ showToast(i18n[document.documentElement.lang]?.iceOfFive || i18n.en.iceOfFive, "warning"); return; }
  const list = document.getElementById("iceContacts");
  const tmp = { name:"", relationship:"", phone:"", email:"", notes:"" };
  list.insertAdjacentHTML("beforeend", contactCardTemplate(tmp));
  wireIceCards();
  updateIceCount();
});

async function saveIceCard(card){
  try{
    const payload = { user_id: currentUser.id };
    card.querySelectorAll('[data-field]').forEach(el=>{
      payload[el.dataset.field] = el.value.trim();
    });
    if(!payload.name || !payload.phone){ return; } // require basics

    const sbid = card.getAttribute('data-sbid');
    if(sbid){
      const { error } = await sb.from('ice_contacts').update(payload).eq('id', sbid).eq('user_id', currentUser.id);
      if(error) throw error;
    }else{
      const { data, error } = await sb.from('ice_contacts').insert(payload).select().single();
      if(error) throw error;
      card.setAttribute('data-sbid', data.id);
    }
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(e){
    console.error("saveIceCard", e);
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

async function removeIceCard(card){
  try{
    const sbid = card.getAttribute('data-sbid');
    if(sbid){
      const { error } = await sb.from('ice_contacts').delete().eq('id', sbid).eq('user_id', currentUser.id);
      if(error) throw error;
    }
  }catch(e){
    console.error("removeIceCard", e);
  }finally{
    card.remove();
    updateIceCount();
    debounceSave(()=>loadIceContacts(), 150);
  }
}

// --- TRIAGE calculation + persistence ---
function computeTriageAuto(){
  // Read from global pillData and life support
  const life = document.getElementById('lifeSupportPref')?.value || "Full";
  const conds = (pillData?.conditions||[]).join(" ").toLowerCase();
  const alls  = (pillData?.allergies||[]).join(" ").toLowerCase();

  if(life==="DNR") return "Black";

  const criticalAll = ["penicillin","morphine","codeine","fentanyl","midazolam","propofol","aspirin","ibuprofen","latex","shellfish","nut","peanut"];
  const highRisk = ["diabetes","heart","cardiac","stroke","seizure","epilep","asthma","copd","kidney","renal","liver","cancer"];

  const hasCritAll = criticalAll.some(k=>alls.includes(k));
  const hasHigh = highRisk.some(k=>conds.includes(k));
  if(hasCritAll || hasHigh || (pillData?.conditions||[]).length>3) return "Red";
  if((pillData?.allergies||[]).length>0 || (pillData?.conditions||[]).length>0 || (pillData?.medications||[]).length>2) return "Amber";
  return "Green";
}

function applyTriageBadge(level, auto=false){
  const el = document.getElementById('triageStatus');
  const t = i18n[document.documentElement.lang]||i18n.en;
  const map = {
    Green: {cls:"triage-status triage-green", text: auto?t.triageGreenAuto:t.triageGreen},
    Amber: {cls:"triage-status triage-amber", text: auto?t.triageAmberAuto:t.triageAmber},
    Red:   {cls:"triage-status triage-red",   text: auto?t.triageRedAuto:t.triageRed},
    Black: {cls:"triage-status triage-black", text: auto?t.triageBlackAuto:t.triageBlack}
  };
  el.className = map[level].cls;
  el.textContent = map[level].text;
}

async function saveTriageOverride(val){
  try{
    const { error } = await sb.from('profiles').update({ triage_override: val }).eq('id', currentUser.id);
    if(error) throw error;
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(e){
    console.error("saveTriageOverride", e);
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

function updateTriage(){
  const override = document.getElementById('triageOverride').value;
  if(override){
    applyTriageBadge(override, false);
  }else{
    const auto = computeTriageAuto();
    applyTriageBadge(auto, true);
  }
}

document.getElementById('triageOverride').addEventListener('change', async (e)=>{
  await saveTriageOverride(e.target.value||null);
  updateTriage();
});

// health changes should recalc triage
["bloodType","organDonor","lifeSupportPref"].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('change', ()=>{ if(!document.getElementById('triageOverride').value){ updateTriage(); }});
});

// Pills recalc hook (called after Chunk 3 adds/ removes)
window.updateTriageFromPills = ()=>{ if(!document.getElementById('triageOverride').value){ updateTriage(); }};

// Init after session + health loaded
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadIceContacts();
  // load triage override from profiles (if present)
  try{
    const { data, error } = await sb.from('profiles').select('triage_override').eq('id', currentUser.id).single();
    if(!error && data && data.triage_override){
      document.getElementById('triageOverride').value = data.triage_override || "";
    }
  }catch(e){}
  updateTriage();
});

// --- small utils used above (debounce, toasts assumed global) ---
window._debounceTimer = window._debounceTimer || {};
function debounceSave(fn, ms){
  const k = fn.name || "key"+Math.random();
  clearTimeout(_debounceTimer[k]); _debounceTimer[k]=setTimeout(fn, ms);
}
</script>
<!-- ======== CHUNK 5: QR CODE CARD (Persistent, i18n, Supabase-wired) ======== -->
<div class="glass-card p-6 animate-fade-in-up" id="qrCard">
  <div class="card-ribbon ribbon-qr"></div>
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-slate-900" data-i18n="qr.title">Generate QR Code</h2>
    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
      </path>
    </svg>
  </div>

  <div class="text-sm text-gray-600 mb-6">
    <p class="mb-2" data-i18n="qr.subtitle">One QR code for all your emergency information.</p>
    <div class="text-xs space-y-1">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span data-i18n="qr.offline">Works offline - no internet required</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
        <span data-i18n="qr.same">QR code stays the same, data updates automatically</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
        <span data-i18n="qr.scan">Scan with any phone camera or QR reader</span>
      </div>
    </div>
  </div>

  <div class="text-center mb-6">
    <div class="mb-4">
      <div class="text-2xl font-bold text-slate-900 mb-1">
        MYQ<span class="brand-red">ER</span><span class="text-lg">™</span>
      </div>
      <div class="text-xs text-gray-500" data-i18n="qr.cardTitle">Emergency Information Card</div>
    </div>

    <div id="qrContainer" class="qr-container">
      <div class="offline-badge" data-i18n="qr.badge">WORKS OFFLINE</div>
      <canvas id="qrCanvas" width="160" height="160" style="display:none;"></canvas>
      <div id="qrPlaceholder" class="qr-placeholder">
        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
          </path>
        </svg>
        <span data-i18n="qr.complete">Complete your profile to generate QR code</span>
      </div>
    </div>

    <div class="mt-4">
      <input type="text" id="cardLink"
        class="w-full text-xs text-center border border-gray-300 rounded-lg px-3 py-2 bg-gray-50"
        readonly placeholder="https://…">
      <button id="copyLinkBtn" class="text-xs text-blue-600 hover:text-blue-800 mt-2 font-medium">
        📋 <span data-i18n="qr.copy">Copy Shareable Link</span>
      </button>
    </div>
  </div>

  <div class="space-y-3">
    <button id="generateCodeBtn" class="btn-primary w-full">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4">
        </path>
      </svg>
      <span data-i18n="qr.generate">Generate Emergency Code</span>
    </button>

    <button id="viewCardBtn" class="btn-secondary w-full">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
      </svg>
      <span data-i18n="qr.view">View Emergency Card</span>
    </button>

    <div class="grid grid-cols-2 gap-3">
      <button id="exportPngBtn" class="btn-secondary text-sm">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
        <span data-i18n="qr.export">Export PNG</span>
      </button>
      <button id="printCardBtn" class="btn-secondary text-sm">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
          </path>
        </svg>
        <span data-i18n="qr.print">Print Card</span>
      </button>
    </div>
  </div>
</div>

<script>
/* ================== i18n (10 main languages) ================== */
const I18N = {
  en: { 'qr.title':'Generate QR Code','qr.subtitle':'One QR code for all your emergency information.',
        'qr.offline':'Works offline - no internet required','qr.same':'QR code stays the same, data updates automatically',
        'qr.scan':'Scan with any phone camera or QR reader','qr.cardTitle':'Emergency Information Card',
        'qr.badge':'WORKS OFFLINE','qr.complete':'Complete your profile to generate QR code',
        'qr.copy':'Copy Shareable Link','qr.generate':'Generate Emergency Code','qr.view':'View Emergency Card',
        'qr.export':'Export PNG','qr.print':'Print Card',
        'toast.needProfile':'Please complete your identity first (Name, DOB, Country).',
        'toast.hasCode':'Your emergency code already exists.','toast.codeCreated':'Emergency code generated.',
        'toast.error':'Something went wrong.','toast.noLink':'No link to copy. Generate your code first.',
        'toast.copied':'Link copied to clipboard.','toast.pngSaved':'QR code exported as PNG.',
        'toast.generateFirst':'Generate your QR code first.','toast.printOpen':'Opening print view…' },
  es: { 'qr.title':'Generar código QR','qr.subtitle':'Un solo código QR para toda tu información de emergencia.',
        'qr.offline':'Funciona sin internet','qr.same':'El QR no cambia; los datos se actualizan',
        'qr.scan':'Escanéalo con cualquier cámara','qr.cardTitle':'Tarjeta de Información de Emergencia',
        'qr.badge':'SIN INTERNET','qr.complete':'Completa tu perfil para generar el QR',
        'qr.copy':'Copiar enlace','qr.generate':'Generar código de emergencia','qr.view':'Ver tarjeta de emergencia',
        'qr.export':'Exportar PNG','qr.print':'Imprimir tarjeta',
        'toast.needProfile':'Completa tu identidad (Nombre, Fecha de nacimiento, País).',
        'toast.hasCode':'Ya tienes código.','toast.codeCreated':'Código generado.',
        'toast.error':'Ha ocurrido un error.','toast.noLink':'No hay enlace para copiar.',
        'toast.copied':'Enlace copiado.','toast.pngSaved':'QR exportado como PNG.',
        'toast.generateFirst':'Genera tu código primero.','toast.printOpen':'Abriendo vista de impresión…' },
  fr: { 'qr.title':'Générer un QR code','qr.subtitle':'Un QR unique pour toutes vos infos d’urgence.',
        'qr.offline':'Fonctionne hors ligne','qr.same':'Le QR reste identique; données mises à jour',
        'qr.scan':'Scannable par tout smartphone','qr.cardTitle':'Carte d’Information d’Urgence',
        'qr.badge':'HORS LIGNE','qr.complete':'Complétez votre profil pour générer le QR',
        'qr.copy':'Copier le lien','qr.generate':'Générer le code d’urgence','qr.view':'Voir la carte d’urgence',
        'qr.export':'Exporter PNG','qr.print':'Imprimer la carte',
        'toast.needProfile':'Complétez votre identité (Nom, Date de naissance, Pays).',
        'toast.hasCode':'Votre code existe déjà.','toast.codeCreated':'Code généré.',
        'toast.error':'Une erreur est survenue.','toast.noLink':'Aucun lien à copier.',
        'toast.copied':'Lien copié.','toast.pngSaved':'QR exporté en PNG.',
        'toast.generateFirst':'Générez d’abord votre code.','toast.printOpen':'Ouverture de l’impression…' },
  de: { 'qr.title':'QR-Code erzeugen','qr.subtitle':'Ein QR-Code für alle Notfalldaten.',
        'qr.offline':'Funktioniert offline','qr.same':'QR bleibt gleich; Daten aktualisieren sich',
        'qr.scan':'Mit jeder Kamera scannbar','qr.cardTitle':'Notfall-Informationskarte',
        'qr.badge':'OFFLINE','qr.complete':'Profil vervollständigen, um QR zu erzeugen',
        'qr.copy':'Link kopieren','qr.generate':'Notfallcode erzeugen','qr.view':'Notfallkarte anzeigen',
        'qr.export':'PNG exportieren','qr.print':'Karte drucken',
        'toast.needProfile':'Identität vervollständigen (Name, Geburtsdatum, Land).',
        'toast.hasCode':'Code existiert bereits.','toast.codeCreated':'Code erstellt.',
        'toast.error':'Etwas ist schiefgelaufen.','toast.noLink':'Kein Link zum Kopieren.',
        'toast.copied':'Link kopiert.','toast.pngSaved':'QR als PNG exportiert.',
        'toast.generateFirst':'Zuerst QR erzeugen.','toast.printOpen':'Druckansicht wird geöffnet…' },
  it: { 'qr.title':'Genera codice QR','qr.subtitle':'Un unico QR per tutte le info d’emergenza.',
        'qr.offline':'Funziona offline','qr.same':'Il QR non cambia; i dati sì',
        'qr.scan':'Scansionabile con qualsiasi telefono','qr.cardTitle':'Carta Informazioni d’Emergenza',
        'qr.badge':'OFFLINE','qr.complete':'Completa il profilo per generare il QR',
        'qr.copy':'Copia link','qr.generate':'Genera codice di emergenza','qr.view':'Vedi carta di emergenza',
        'qr.export':'Esporta PNG','qr.print':'Stampa carta',
        'toast.needProfile':'Completa identità (Nome, Data di nascita, Paese).',
        'toast.hasCode':'Codice già esistente.','toast.codeCreated':'Codice generato.',
        'toast.error':'Si è verificato un errore.','toast.noLink':'Nessun link da copiare.',
        'toast.copied':'Link copiato.','toast.pngSaved':'QR esportato in PNG.',
        'toast.generateFirst':'Genera prima il QR.','toast.printOpen':'Apertura stampa…' },
  hi: { 'qr.title':'QR कोड बनाएं','qr.subtitle':'आपकी आपातकालीन सूचना के लिए एक ही QR।',
        'qr.offline':'ऑफ़लाइन काम करता है','qr.same':'QR वही रहता है; डेटा अपडेट होता है',
        'qr.scan':'किसी भी फ़ोन कैमरे से स्कैन करें','qr.cardTitle':'आपातकालीन सूचना कार्ड',
        'qr.badge':'ऑफ़लाइन','qr.complete':'QR बनाने के लिए प्रोफ़ाइल पूरी करें',
        'qr.copy':'लिंक कॉपी करें','qr.generate':'इमरजेंसी कोड बनाएँ','qr.view':'इमरजेंसी कार्ड देखें',
        'qr.export':'PNG निर्यात करें','qr.print':'कार्ड प्रिंट करें',
        'toast.needProfile':'पहले पहचान पूरी करें (नाम, DOB, देश)।',
        'toast.hasCode':'कोड पहले से मौजूद है।','toast.codeCreated':'कोड बनाया गया।',
        'toast.error':'कुछ गलत हो गया।','toast.noLink':'कॉपी करने के लिए लिंक नहीं।',
        'toast.copied':'लिंक कॉपी हुआ।','toast.pngSaved':'QR PNG के रूप में सहेजा गया।',
        'toast.generateFirst':'पहले अपना QR बनाएं।','toast.printOpen':'प्रिंट दृश्य खोल रहा है…' },
  ar: { 'qr.title':'إنشاء رمز QR','qr.subtitle':'رمز QR واحد لكل معلومات الطوارئ.',
        'qr.offline':'يعمل دون إنترنت','qr.same':'الرمز لا يتغير والبيانات تتحدّث',
        'qr.scan':'يُمسح بأي كاميرا هاتف','qr.cardTitle':'بطاقة معلومات الطوارئ',
        'qr.badge':'دون إنترنت','qr.complete':'أكمل ملفك لإنشاء الرمز',
        'qr.copy':'نسخ الرابط','qr.generate':'إنشاء رمز الطوارئ','qr.view':'عرض بطاقة الطوارئ',
        'qr.export':'تصدير PNG','qr.print':'طباعة البطاقة',
        'toast.needProfile':'أكمل بيانات هويتك (الاسم، تاريخ الميلاد، الدولة).',
        'toast.hasCode':'لديك رمز بالفعل.','toast.codeCreated':'تم إنشاء الرمز.',
        'toast.error':'حدث خطأ.','toast.noLink':'لا يوجد رابط لنسخه.',
        'toast.copied':'تم نسخ الرابط.','toast.pngSaved':'تم تصدير QR كـ PNG.',
        'toast.generateFirst':'أنشئ الرمز أولاً.','toast.printOpen':'يتم فتح نافذة الطباعة…' },
  zh: { 'qr.title':'生成二维码','qr.subtitle':'一个二维码覆盖所有紧急信息。',
        'qr.offline':'离线可用','qr.same':'二维码不变；数据自动更新',
        'qr.scan':'任何手机相机可扫码','qr.cardTitle':'紧急信息卡',
        'qr.badge':'离线','qr.complete':'完善个人资料以生成二维码',
        'qr.copy':'复制分享链接','qr.generate':'生成紧急代码','qr.view':'查看紧急信息卡',
        'qr.export':'导出 PNG','qr.print':'打印卡片',
        'toast.needProfile':'请先完善身份信息（姓名、生日、国家）。',
        'toast.hasCode':'已存在紧急代码。','toast.codeCreated':'已生成代码。',
        'toast.error':'出错啦。','toast.noLink':'没有可复制的链接。',
        'toast.copied':'链接已复制。','toast.pngSaved':'已导出 PNG。',
        'toast.generateFirst':'请先生成二维码。','toast.printOpen':'正在打开打印视图…' },
  hu: { 'qr.title':'QR-kód generálása','qr.subtitle':'Egy QR-kód minden sürgősségi adathoz.',
        'qr.offline':'Internet nélkül is működik','qr.same':'A QR változatlan, az adatok frissülnek',
        'qr.scan':'Bármely telefonnal olvasható','qr.cardTitle':'Sürgősségi Információs Kártya',
        'qr.badge':'OFFLINE','qr.complete':'Töltse ki a profilt a QR-hez',
        'qr.copy':'Hivatkozás másolása','qr.generate':'Vészhelyzeti kód létrehozása','qr.view':'Kártya megnyitása',
        'qr.export':'PNG export','qr.print':'Kártya nyomtatása',
        'toast.needProfile':'Előbb egészítse ki az azonosítást (Név, Születési dátum, Ország).',
        'toast.hasCode':'A kód már létezik.','toast.codeCreated':'Kód létrehozva.',
        'toast.error':'Hiba történt.','toast.noLink':'Nincs másolható link.',
        'toast.copied':'Link másolva.','toast.pngSaved':'QR exportálva PNG-ként.',
        'toast.generateFirst':'Előbb generálja a QR-t.','toast.printOpen':'Nyomtatási nézet megnyitása…' },
  ro: { 'qr.title':'Generează cod QR','qr.subtitle':'Un singur QR pentru toate informațiile de urgență.',
        'qr.offline':'Funcționează offline','qr.same':'QR rămâne același; datele se actualizează',
        'qr.scan':'Scanabil cu orice telefon','qr.cardTitle':'Card de Informații de Urgență',
        'qr.badge':'OFFLINE','qr.complete':'Completează profilul pentru a genera QR',
        'qr.copy':'Copiază linkul','qr.generate':'Generează codul de urgență','qr.view':'Vezi cardul de urgență',
        'qr.export':'Exportă PNG','qr.print':'Printează cardul',
        'toast.needProfile':'Completează mai întâi identitatea (Nume, Data nașterii, Țara).',
        'toast.hasCode':'Codul există deja.','toast.codeCreated':'Cod generat.',
        'toast.error':'A apărut o eroare.','toast.noLink':'Nu există link de copiat.',
        'toast.copied':'Link copiat.','toast.pngSaved':'QR exportat PNG.',
        'toast.generateFirst':'Generează mai întâi QR-ul.','toast.printOpen':'Se deschide vizualizarea de tipărire…' }
};

function currentLang(){
  const sel = document.getElementById('languageSelect');
  const val = sel?.value || localStorage.getItem('lang') || 'en';
  return I18N[val] ? val : 'en';
}
function t(key){ const lang = currentLang(); return (I18N[lang] && I18N[lang][key]) || I18N.en[key] || key; }
function applyI18nForQr(){
  document.querySelectorAll('#qrCard [data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n'); el.textContent = t(k);
  });
}
document.getElementById('languageSelect')?.addEventListener('change', ()=>{
  localStorage.setItem('lang', document.getElementById('languageSelect').value);
  applyI18nForQr();
});

/* ================== QR persistence + Supabase wiring ================== */
const ORIGIN = window.location.origin;

async function ensureUserCodeOnce(){
  // 1) Try in-memory
  if (window.currentProfile?.code){
    afterCodeResolved(window.currentProfile.code, false);
    return;
  }
  // 2) Try DB
  try{
    const { data, error } = await window.sb.from('profiles').select('code').eq('id', currentUser.id).single();
    if (error && error.code !== 'PGRST116') { console.error(error); }
    if (data?.code){
      window.currentProfile = { ...(window.currentProfile||{}), code: data.code };
      afterCodeResolved(data.code, false);
      return;
    }
  }catch(e){ console.error(e); }
  // 3) No code yet -> wait for user to click Generate
  setGenerateEnabled(true);
}

function setGenerateEnabled(enabled){
  const btn = document.getElementById('generateCodeBtn');
  btn.disabled = !enabled;
  btn.style.opacity = enabled ? '1' : '0.6';
  btn.querySelector('[data-i18n="qr.generate"]').textContent = enabled ? t('qr.generate') : t('toast.hasCode');
}

function updateCardLink(code){
  const link = `${ORIGIN}/c/${code}`;
  const input = document.getElementById('cardLink');
  input.value = link;
}

function drawQr(code){
  const canvas = document.getElementById('qrCanvas');
  const placeholder = document.getElementById('qrPlaceholder');
  const url = `${ORIGIN}/c/${code}`;
  QRCode.toCanvas(canvas, url, { width:160, height:160, margin:3, color:{dark:'#000000', light:'#FFFFFF'}, errorCorrectionLevel:'M' },
    (err)=>{
      if(err){ console.error(err); placeholder.style.display='block'; canvas.style.display='none'; return; }
      placeholder.style.display='none'; canvas.style.display='block';
    }
  );
}

function afterCodeResolved(code, justCreated){
  localStorage.setItem('myqer_code', code);
  updateCardLink(code);
  drawQr(code);
  setGenerateEnabled(false);
  if (justCreated) showToast(t('toast.codeCreated'),'success');
}

/* ====== Button handlers ====== */
async function handleGenerate(){
  // basic identity completeness check (keep in sync with your other function)
  const fullName = document.getElementById('fullName')?.value?.trim();
  const dob = document.getElementById('dateOfBirth')?.value?.trim();
  const country = document.getElementById('country')?.value;
  if (!fullName || !dob || !country){ showToast(t('toast.needProfile'),'warning'); return; }

  // Double-check DB: if code exists, do not re-create (enforce single code)
  try{
    const { data: existing } = await window.sb.from('profiles').select('code').eq('id', currentUser.id).single();
    if (existing?.code){ setGenerateEnabled(false); afterCodeResolved(existing.code,false); return; }
  }catch(e){ /* ignore; proceed */ }

  // Generate short uppercase code; retry a few times if collision (belt & suspenders)
  let code;
  for (let i=0;i<5;i++){
    code = Math.random().toString(36).slice(2,8).toUpperCase();
    const { data: dup } = await window.sb.from('profiles').select('id').eq('code', code).maybeSingle?.() ?? {};
    if (!dup) break;
    code = null;
  }
  if (!code){ showToast(t('toast.error'),'error'); return; }

  // Save to profiles (upsert by id)
  try{
    const { error } = await window.sb.from('profiles').upsert({
      id: currentUser.id,
      email: currentUser.email,
      full_name: fullName,
      country: country,
      date_of_birth: dob,
      national_health_id: document.getElementById('nationalHealthId')?.value || '',
      code
    });
    if (error){ console.error(error); showToast(t('toast.error'),'error'); return; }
    window.currentProfile = { ...(window.currentProfile||{}), code };
    afterCodeResolved(code, true);
  }catch(err){ console.error(err); showToast(t('toast.error'),'error'); }
}

function handleCopy(){
  const v = document.getElementById('cardLink').value;
  if (!v){ showToast(t('toast.noLink'),'warning'); return; }
  navigator.clipboard.writeText(v).then(()=>showToast(t('toast.copied'),'success'))
    .catch(()=>showToast(t('toast.error'),'error'));
}

function handleView(){
  const code = window.currentProfile?.code;
  if (!code){ showToast(t('toast.generateFirst'),'warning'); return; }
  window.open(`${ORIGIN}/c/${code}`,'_blank');
}

function handleExportPng(){
  const canvas = document.getElementById('qrCanvas');
  if (canvas.style.display === 'none'){ showToast(t('toast.generateFirst'),'warning'); return; }
  const a = document.createElement('a');
  a.download = `MYQER-${window.currentProfile.code}-QR.png`;
  a.href = canvas.toDataURL('image/png');
  a.click();
  showToast(t('toast.pngSaved'),'success');
}

function handlePrint(){
  const code = window.currentProfile?.code;
  if (!code){ showToast(t('toast.generateFirst'),'warning'); return; }
  showToast(t('toast.printOpen'),'info');
  window.open(`${ORIGIN}/c/${code}?print=true`,'_blank');
}

/* ====== Wire up on load ====== */
(function initQrCard(){
  applyI18nForQr();
  document.getElementById('generateCodeBtn')?.addEventListener('click', handleGenerate);
  document.getElementById('copyLinkBtn')?.addEventListener('click', handleCopy);
  document.getElementById('viewCardBtn')?.addEventListener('click', handleView);
  document.getElementById('exportPngBtn')?.addEventListener('click', handleExportPng);
  document.getElementById('printCardBtn')?.addEventListener('click', handlePrint);
  ensureUserCodeOnce();
})();
</script>
<!-- ======== END CHUNK 5 ======== -->
  <!-- =========================================================
     CHUNK 6: Extras (Family/Vault/Analytics/Danger) + Help
               and a clean Footer (i18n-ready)
     Paste directly after Chunk 5’s QR card section
========================================================= -->

<!-- === Additional Features Grid === -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

  <!-- Family Hub (coming soon) -->
  <div class="glass-card p-6 animate-fade-in-up">
    <div class="card-ribbon ribbon-family"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-pink-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
      </svg>
      <h3 class="text-lg font-bold text-slate-900 mb-2" data-i18n="familyTitle">Family Hub</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="familySub">Manage emergency cards for kids and family members</p>
      <button class="btn-secondary w-full text-sm opacity-50 cursor-not-allowed" disabled data-i18n="comingSoon">Coming Soon</button>
    </div>
  </div>

  <!-- Documents Vault (coming soon) -->
  <div class="glass-card p-6 animate-fade-in-up">
    <div class="card-ribbon ribbon-vault"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
      </svg>
      <h3 class="text-lg font-bold text-slate-900 mb-2" data-i18n="vaultTitle">Documents Vault</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="vaultSub">Secure storage for medical documents and legal directives</p>
      <button class="btn-secondary w-full text-sm opacity-50 cursor-not-allowed" disabled data-i18n="comingSoon">Coming Soon</button>
    </div>
  </div>

  <!-- Analytics -->
  <div class="glass-card p-6 animate-fade-in-up">
    <div class="card-ribbon ribbon-analytics"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
        </path>
      </svg>
      <h3 class="text-lg font-bold text-slate-900 mb-2" data-i18n="analyticsTitle">Analytics</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="analyticsSub">Track QR code scans and access</p>
      <button class="btn-secondary w-full text-sm" id="viewStatsBtn" data-i18n="viewStats">View Stats</button>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="glass-card p-6 border-red-200 animate-fade-in-up">
    <div class="card-ribbon ribbon-danger"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-red-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path fill-rule="evenodd"
          d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
          clip-rule="evenodd"></path>
      </svg>
      <h3 class="text-lg font-bold text-red-600 mb-2" data-i18n="dangerTitle">Danger Zone</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="dangerSub">Permanently delete your account</p>
      <button id="deleteAccountBtn"
        class="w-full bg-transparent border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white px-4 py-2 rounded-lg font-semibold transition-all text-sm"
        data-i18n="deleteAccount">
        Delete Account
      </button>
    </div>
  </div>

</div>
<!-- /Additional Features Grid -->

<!-- === Help & Support === -->
<div class="glass-card p-8 mb-8 animate-fade-in-up">
  <div class="card-ribbon ribbon-silver"></div>
  <div class="text-center">
    <h2 class="text-2xl font-bold text-slate-900 mb-4" data-i18n="helpTitle">Need Help?</h2>
    <p class="text-gray-600 mb-6" data-i18n="helpSub">Our support team is here to help you get the most out of MYQER™</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- FAQ -->
      <div class="text-center">
        <svg class="w-8 h-8 mx-auto mb-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
          </path>
        </svg>
        <h3 class="font-semibold text-slate-900 mb-2" data-i18n="faqTitle">FAQ</h3>
        <p class="text-sm text-gray-600 mb-3" data-i18n="faqSub">Find answers to common questions</p>
        <button class="btn-tertiary" id="faqBtn" data-i18n="viewFAQ">View FAQ</button>
      </div>

      <!-- Live Chat -->
      <div class="text-center">
        <svg class="w-8 h-8 mx-auto mb-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
          </path>
        </svg>
        <h3 class="font-semibold text-slate-900 mb-2" data-i18n="chatTitle">Live Chat</h3>
        <p class="text-sm text-gray-600 mb-3" data-i18n="chatSub">Chat with our support team</p>
        <button class="btn-tertiary" id="chatBtn" data-i18n="startChat">Start Chat</button>
      </div>

      <!-- Email Support -->
      <div class="text-center">
        <svg class="w-8 h-8 mx-auto mb-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
          </path>
        </svg>
        <h3 class="font-semibold text-slate-900 mb-2" data-i18n="emailTitle">Email Support</h3>
        <p class="text-sm text-gray-600 mb-3" data-i18n="emailSub">Send us a detailed message</p>
        <button class="btn-tertiary" id="emailBtn" data-i18n="contactUs">Contact Us</button>
      </div>
    </div>
  </div>
</div>
<!-- /Help & Support -->

</main>
<!-- /Main content -->

<!-- === Clean Footer (no Product/Support columns) === -->
<footer class="bg-white border-t border-gray-100 mt-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="flex items-center justify-between flex-col md:flex-row gap-4">
      <div class="flex items-center gap-3">
        <div class="text-2xl font-black text-slate-900">
          MYQ<span class="brand-red">ER</span><span aria-hidden="true">™</span>
        </div>
        <div class="text-sm text-gray-600" data-i18n="footerTagline">
          Emergency response QR system. Your medical information, secure and accessible when it matters most.
        </div>
      </div>

      <div class="flex items-center space-x-4 text-sm text-gray-500">
        <span data-i18n="badgeEncrypted">🔒 Encrypted</span>
        <span data-i18n="badgeGlobal">🌍 Global</span>
        <span data-i18n="badgeOffline">📱 Offline Ready</span>
      </div>
    </div>

    <div class="border-t border-gray-200 mt-6 pt-6 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="text-sm text-gray-600" data-i18n="copyright">
        © 2025 MYQER™ — Emergency Response QR System · GDPR/HIPAA-minded
      </div>
      <div class="flex items-center gap-5">
        <!-- social icons (optional) -->
        <a aria-label="Twitter" href="#" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path
              d="M24 4.56c-.88.39-1.84.65-2.84.77 1.02-.61 1.8-1.58 2.17-2.73-.96.57-2.02.98-3.15 1.2A4.93 4.93 0 0016.62 3c-2.73 0-4.94 2.22-4.94 4.96 0 .39.04.77.12 1.13-4.1-.21-7.75-2.17-10.19-5.16-.43.75-.68 1.62-.68 2.55 0 1.76.89 3.3 2.22 4.21-.83-.02-1.61-.26-2.29-.64v.06c0 2.46 1.74 4.51 4.04 4.98-.42.12-.87.18-1.33.18-.33 0-.65-.03-.96-.09.65 2.05 2.54 3.55 4.78 3.59A9.9 9.9 0 010 19.54a13.96 13.96 0 007.55 2.22c9.06 0 14.02-7.52 14.02-14.04l-.02-.64A10.04 10.04 0 0024 4.56z" />
          </svg>
        </a>
        <a aria-label="LinkedIn" href="#" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path
              d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM.5 8h4V24h-4V8zm7.5 0h3.8v2.2h.05c.53-1 1.86-2.2 3.86-2.2 4.12 0 4.88 2.7 4.88 6.2V24h-4v-7.6c0-1.82-.04-4.16-2.54-4.16-2.54 0-2.93 1.98-2.93 4.02V24h-4V8z" />
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>
<!-- /Footer -->

<!-- NOTE: Do NOT add scripts here. Next chunk (7) contains all logic. -->
  <script>
/* =========================================================
   CHUNK 7 — LOGIC CORE (session, i18n, saves, ICE, QR, triage)
   - Keeps your design intact
   - Works with Supabase JS v2 (already loaded on page)
   - Includes the 10 main languages you requested
   ========================================================= */

/* ---------- CONFIG ---------- */
const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
const ORIGIN = window.location.origin;

/* ---------- GLOBALS ---------- */
window.sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;
let currentProfile = null;
let iceContactCount = 0;
let pillData = { allergies: [], conditions: [], medications: [] };
let saveTimeout = null;
let currentSpeech = null;

/* ---------- I18N BUNDLES (10 languages) ---------- */
const I18N = {
  en: {
    online: "Online", logout: "Logout", worksOffline: "Works offline",
    profileCompletionTitle: "Profile Completion", completeLabel: "Complete",
    identityCheck: "Identity", healthCheck: "Health Profile", iceCheck: "ICE Contacts", codeCheck: "Emergency Code",
    identityTitle: "Identity Information", identitySub: "These details help first responders confirm who you are and contact your emergency contacts.",
    fullName: "Full Legal Name", dob: "Date of Birth", country: "Country of Residence",
    nhsId: "National Health ID", autoSaves: "Auto-saves as you type",
    healthTitle: "Health Profile", healthSub: "Critical medical information that appears on your emergency card. Keep this current and accurate.",
    bloodTypeLabel: "Blood Type", bloodHelp: "Critical for blood transfusions",
    donorLabel: "Organ Donor Status", donorHelp: "Check your driver's license or ID",
    lifeSupportLabel: "Life Support Preference",
    allergiesLabel: "Critical Allergies ⚠️", allergiesHelp: "Include all drug allergies, food allergies, and environmental allergies that could cause severe reactions.",
    conditionsLabel: "Medical Conditions", conditionsHelp: "Include chronic conditions, mental health conditions, and any ongoing medical issues.",
    medsLabel: "Current Medications", medsHelp: "Include prescription medications, over-the-counter medications, and supplements you take regularly.",
    criticalNoticeTitle: "Critical Information Notice",
    criticalNoticeText: "This information will be visible to emergency responders. Only include details that are medically necessary for emergency treatment.",
    iceTitle: "Emergency Contacts (ICE)", iceSub: "Add up to 5 trusted people who can be reached in an emergency.",
    addIce: "Add Emergency Contact", iceCountOf: "of 5 contacts added", removeContact: "Remove Contact",
    triageTitle: "Automated Triage", triageSub: "Auto-computed priority based on your health profile.",
    triageOverrideLabel: "Manual Override",
    speak: "Speak Medical Summary", stopSpeak: "Stop Speaking",
    qrTitle: "Generate QR Code", qrSubA: "One QR code for all your emergency information.",
    qrHintOffline: "Works offline - no internet required",
    qrHintStatic: "QR code stays the same, data updates automatically",
    qrHintScan: "Scan with any phone camera or QR reader",
    copyLink: "Copy Shareable Link", viewCard: "View Emergency Card",
    exportPng: "Export PNG", printCard: "Print Card",
    analyticsTitle: "Analytics", analyticsSub: "Track QR code scans and access", totalScans: "Total Scans",
    last30Days: "Last 30 Days", today: "Today", refreshStats: "Refresh",
    toastSaved: "Saved", toastError: "Something went wrong", toastCopied: "Link copied",
    needIdentity: "Please complete your identity information first (Name, Date of Birth, Country)",
    codeExists: "You already have an emergency code", codeCreated: "Emergency code generated",
    noLink: "No link to copy - generate your emergency code first",
    maxContacts: "Maximum 5 contacts allowed", contactAdded: "Contact added", contactRemoved: "Contact removed",
    speechNotSupported: "Speech synthesis not supported in this browser",
  },
  es: { /* Español */
    online:"En línea", logout:"Cerrar sesión", worksOffline:"Funciona sin conexión",
    profileCompletionTitle:"Compleción del perfil", completeLabel:"Completado",
    identityCheck:"Identidad", healthCheck:"Perfil de salud", iceCheck:"Contactos ICE", codeCheck:"Código de emergencia",
    identityTitle:"Información de identidad", identitySub:"Estos datos ayudan a confirmar quién eres y contactar a tus contactos de emergencia.",
    fullName:"Nombre legal completo", dob:"Fecha de nacimiento", country:"País de residencia",
    nhsId:"ID de salud nacional", autoSaves:"Guarda automáticamente mientras escribes",
    healthTitle:"Perfil de salud", healthSub:"Información médica crítica que aparece en tu tarjeta de emergencia.",
    bloodTypeLabel:"Tipo de sangre", bloodHelp:"Crucial para transfusiones",
    donorLabel:"Donante de órganos", donorHelp:"Revisa tu licencia o identificación",
    lifeSupportLabel:"Preferencia de soporte vital",
    allergiesLabel:"Alergias críticas ⚠️", allergiesHelp:"Incluye todas las alergias a fármacos, alimentos y ambientales que puedan causar reacciones graves.",
    conditionsLabel:"Condiciones médicas", conditionsHelp:"Incluye crónicas, salud mental y problemas en curso.",
    medsLabel:"Medicamentos actuales", medsHelp:"Incluye de receta, venta libre y suplementos.",
    criticalNoticeTitle:"Aviso de información crítica",
    criticalNoticeText:"Visible para emergencistas. Solo información necesaria para el tratamiento.",
    iceTitle:"Contactos de emergencia (ICE)", iceSub:"Agrega hasta 5 personas de confianza.",
    addIce:"Agregar contacto de emergencia", iceCountOf:"de 5 contactos agregados", removeContact:"Eliminar contacto",
    triageTitle:"Triaje automatizado", triageSub:"Prioridad calculada automáticamente.",
    triageOverrideLabel:"Anulación manual",
    speak:"Leer resumen médico", stopSpeak:"Detener",
    qrTitle:"Generar código QR", qrSubA:"Un único código QR para toda tu información.",
    qrHintOffline:"Funciona sin internet",
    qrHintStatic:"El QR no cambia, los datos sí",
    qrHintScan:"Escanéalo con cualquier cámara",
    copyLink:"Copiar enlace", viewCard:"Ver tarjeta de emergencia",
    exportPng:"Exportar PNG", printCard:"Imprimir tarjeta",
    analyticsTitle:"Analítica", analyticsSub:"Seguimiento de escaneos del QR", totalScans:"Escaneos totales",
    last30Days:"Últimos 30 días", today:"Hoy", refreshStats:"Actualizar",
    toastSaved:"Guardado", toastError:"Ocurrió un error", toastCopied:"Enlace copiado",
    needIdentity:"Completa identidad primero (Nombre, Fecha de nacimiento, País)",
    codeExists:"Ya tienes un código", codeCreated:"Código generado",
    noLink:"No hay enlace para copiar",
    maxContacts:"Máximo 5 contactos", contactAdded:"Contacto agregado", contactRemoved:"Contacto eliminado",
    speechNotSupported:"El navegador no soporta voz",
  },
  fr: { online:"En ligne", logout:"Déconnexion", worksOffline:"Fonctionne hors ligne",
    profileCompletionTitle:"Complétion du profil", completeLabel:"Terminé",
    identityCheck:"Identité", healthCheck:"Profil santé", iceCheck:"Contacts ICE", codeCheck:"Code d'urgence",
    identityTitle:"Informations d’identité", identitySub:"Aide à confirmer votre identité et contacter vos proches.",
    fullName:"Nom légal complet", dob:"Date de naissance", country:"Pays de résidence",
    nhsId:"ID de santé national", autoSaves:"Enregistrement automatique",
    healthTitle:"Profil santé", healthSub:"Informations médicales critiques sur votre carte d’urgence.",
    bloodTypeLabel:"Groupe sanguin", bloodHelp:"Crucial pour les transfusions",
    donorLabel:"Don d’organes", donorHelp:"Vérifiez votre permis/ID",
    lifeSupportLabel:"Préférence de maintien en vie",
    allergiesLabel:"Allergies critiques ⚠️", allergiesHelp:"Inclure médicaments, aliments, environnement.",
    conditionsLabel:"Affections médicales", conditionsHelp:"Chroniques, mentales, en cours.",
    medsLabel:"Médicaments actuels", medsHelp:"Prescription, OTC, suppléments.",
    criticalNoticeTitle:"Avis d’information critique",
    criticalNoticeText:"Visible par les secours. Uniquement le nécessaire.",
    iceTitle:"Contacts d’urgence (ICE)", iceSub:"Ajoutez jusqu’à 5 personnes.",
    addIce:"Ajouter un contact", iceCountOf:"sur 5 contacts ajoutés", removeContact:"Supprimer",
    triageTitle:"Triage automatisé", triageSub:"Priorité calculée automatiquement.",
    triageOverrideLabel:"Forcer manuellement",
    speak:"Lire le résumé médical", stopSpeak:"Arrêter",
    qrTitle:"Générer un QR", qrSubA:"Un QR unique pour vos informations.",
    qrHintOffline:"Hors ligne", qrHintStatic:"QR constant, données mises à jour",
    qrHintScan:"Lisible par toute caméra",
    copyLink:"Copier le lien", viewCard:"Voir la carte",
    exportPng:"Exporter PNG", printCard:"Imprimer",
    analyticsTitle:"Statistiques", analyticsSub:"Suivi des scans", totalScans:"Total",
    last30Days:"30 derniers jours", today:"Aujourd’hui", refreshStats:"Rafraîchir",
    toastSaved:"Enregistré", toastError:"Erreur", toastCopied:"Lien copié",
    needIdentity:"Complétez d’abord l’identité (Nom, Date, Pays)",
    codeExists:"Vous avez déjà un code", codeCreated:"Code généré",
    noLink:"Aucun lien à copier", maxContacts:"5 contacts max",
    contactAdded:"Contact ajouté", contactRemoved:"Contact supprimé",
    speechNotSupported:"Synthèse vocale non supportée",
  },
  de: { online:"Online", logout:"Abmelden", worksOffline:"Offline nutzbar",
    profileCompletionTitle:"Profilabschluss", completeLabel:"Fertig",
    identityCheck:"Identität", healthCheck:"Gesundheitsprofil", iceCheck:"ICE-Kontakte", codeCheck:"Notfallcode",
    identityTitle:"Identitätsinformationen", identitySub:"Hilft Ersthelfern, Sie zu identifizieren und Kontakte zu erreichen.",
    fullName:"Vollständiger Name", dob:"Geburtsdatum", country:"Wohnsitzland",
    nhsId:"Gesundheits-ID", autoSaves:"Automatisch gespeichert",
    healthTitle:"Gesundheitsprofil", healthSub:"Kritische Infos für Ihre Notfallkarte.",
    bloodTypeLabel:"Blutgruppe", bloodHelp:"Wichtig für Transfusionen",
    donorLabel:"Organspenderstatus", donorHelp:"Ausweis prüfen",
    lifeSupportLabel:"Lebenserhaltende Maßnahmen",
    allergiesLabel:"Kritische Allergien ⚠️", allergiesHelp:"Alle schweren Allergien angeben.",
    conditionsLabel:"Erkrankungen", conditionsHelp:"Chronisch, psychisch, laufend.",
    medsLabel:"Medikamente", medsHelp:"Verschreibung, OTC, Supplemente.",
    criticalNoticeTitle:"Wichtiger Hinweis",
    criticalNoticeText:"Nur medizinisch notwendige Angaben.",
    iceTitle:"Notfallkontakte (ICE)", iceSub:"Bis zu 5 Vertrauenspersonen.",
    addIce:"Kontakt hinzufügen", iceCountOf:"von 5 Kontakten", removeContact:"Kontakt entfernen",
    triageTitle:"Automatisches Triage", triageSub:"Priorität automatisch berechnet.",
    triageOverrideLabel:"Manuell überschreiben",
    speak:"Medizinische Zusammenfassung vorlesen", stopSpeak:"Stopp",
    qrTitle:"QR-Code erzeugen", qrSubA:"Ein einziger QR für alles.",
    qrHintOffline:"Offline", qrHintStatic:"QR konstant, Daten aktuell",
    qrHintScan:"Mit jeder Kamera scannbar",
    copyLink:"Link kopieren", viewCard:"Notfallkarte anzeigen",
    exportPng:"PNG exportieren", printCard:"Karte drucken",
    analyticsTitle:"Analytik", analyticsSub:"Scans verfolgen", totalScans:"Gesamt",
    last30Days:"Letzte 30 Tage", today:"Heute", refreshStats:"Aktualisieren",
    toastSaved:"Gespeichert", toastError:"Fehler", toastCopied:"Link kopiert",
    needIdentity:"Erst Identität vervollständigen (Name, Datum, Land)",
    codeExists:"Code existiert bereits", codeCreated:"Code erstellt",
    noLink:"Kein Link zum Kopieren", maxContacts:"Max. 5 Kontakte",
    contactAdded:"Kontakt hinzugefügt", contactRemoved:"Kontakt entfernt",
    speechNotSupported:"Sprachausgabe nicht unterstützt",
  },
  it: { online:"Online", logout:"Esci", worksOffline:"Funziona offline",
    profileCompletionTitle:"Completamento profilo", completeLabel:"Completo",
    identityCheck:"Identità", healthCheck:"Profilo sanitario", iceCheck:"Contatti ICE", codeCheck:"Codice d’emergenza",
    identityTitle:"Informazioni di identità", identitySub:"Aiuta i soccorritori a identificarti e contattare i tuoi contatti.",
    fullName:"Nome completo", dob:"Data di nascita", country:"Paese di residenza",
    nhsId:"ID sanitario nazionale", autoSaves:"Salvataggio automatico",
    healthTitle:"Profilo sanitario", healthSub:"Informazioni critiche sulla tua carta d’emergenza.",
    bloodTypeLabel:"Gruppo sanguigno", bloodHelp:"Cruciale per trasfusioni",
    donorLabel:"Donatore di organi", donorHelp:"Controlla patente/ID",
    lifeSupportLabel:"Preferenza supporto vitale",
    allergiesLabel:"Allergie critiche ⚠️", allergiesHelp:"Farmaci, alimenti, ambientali.",
    conditionsLabel:"Condizioni mediche", conditionsHelp:"Croniche, mentali, in corso.",
    medsLabel:"Farmaci correnti", medsHelp:"Ricetta, OTC, integratori.",
    criticalNoticeTitle:"Avviso informazione critica",
    criticalNoticeText:"Visibile ai soccorritori. Solo necessario.",
    iceTitle:"Contatti d’emergenza (ICE)", iceSub:"Fino a 5 persone fidate.",
    addIce:"Aggiungi contatto", iceCountOf:"di 5 contatti", removeContact:"Rimuovi contatto",
    triageTitle:"Triage automatizzato", triageSub:"Priorità calcolata automaticamente.",
    triageOverrideLabel:"Forza manualmente",
    speak:"Leggi riepilogo medico", stopSpeak:"Ferma",
    qrTitle:"Genera QR", qrSubA:"Un unico QR per tutto.",
    qrHintOffline:"Offline", qrHintStatic:"QR fisso, dati aggiornati",
    qrHintScan:"Scansionabile con qualsiasi camera",
    copyLink:"Copia link", viewCard:"Vedi carta d’emergenza",
    exportPng:"Esporta PNG", printCard:"Stampa carta",
    analyticsTitle:"Analitica", analyticsSub:"Traccia scansioni", totalScans:"Totale",
    last30Days:"Ultimi 30 giorni", today:"Oggi", refreshStats:"Aggiorna",
    toastSaved:"Salvato", toastError:"Errore", toastCopied:"Link copiato",
    needIdentity:"Completa identità (Nome, Data, Paese)",
    codeExists:"Hai già un codice", codeCreated:"Codice generato",
    noLink:"Nessun link da copiare", maxContacts:"Massimo 5 contatti",
    contactAdded:"Contatto aggiunto", contactRemoved:"Contatto rimosso",
    speechNotSupported:"Sintesi vocale non supportata",
  },
  hi: { online:"ऑनलाइन", logout:"लॉगआउट", worksOffline:"ऑफ़लाइन काम करता है",
    profileCompletionTitle:"प्रोफ़ाइल पूर्णता", completeLabel:"पूर्ण",
    identityCheck:"पहचान", healthCheck:"स्वास्थ्य प्रोफ़ाइल", iceCheck:"ICE संपर्क", codeCheck:"आपातकाल कोड",
    identityTitle:"पहचान जानकारी", identitySub:"पहचान की पुष्टि और आपातकालीन संपर्कों के लिए।",
    fullName:"पूरा नाम", dob:"जन्म तिथि", country:"निवास देश",
    nhsId:"राष्ट्रीय स्वास्थ्य ID", autoSaves:"टाइप करते ही सहेजता है",
    healthTitle:"स्वास्थ्य प्रोफ़ाइल", healthSub:"आपकी आपातकालीन कार्ड पर दिखता है।",
    bloodTypeLabel:"ब्लड टाइप", bloodHelp:"ट्रांसफ़्यूजन हेतु",
    donorLabel:"अंग दाता स्थिति", donorHelp:"लाइसेंस/ID देखें",
    lifeSupportLabel:"लाइफ सपोर्ट प्राथमिकता",
    allergiesLabel:"गंभीर एलर्जी ⚠️", allergiesHelp:"दवा, भोजन, पर्यावरण।",
    conditionsLabel:"चिकित्सा स्थितियाँ", conditionsHelp:"क्रॉनिक, मानसिक, चल रही।",
    medsLabel:"वर्तमान दवाएँ", medsHelp:"प्रिस्क्रिप्शन, OTC, सप्लीमेंट।",
    criticalNoticeTitle:"महत्वपूर्ण सूचना",
    criticalNoticeText:"केवल उपचार हेतु आवश्यक जानकारी शामिल करें।",
    iceTitle:"आपातकालीन संपर्क (ICE)", iceSub:"5 तक विश्वसनीय लोग जोड़ें।",
    addIce:"संपर्क जोड़ें", iceCountOf:"में से 5 जोड़े गए", removeContact:"हटाएँ",
    triageTitle:"स्वचालित ट्रायाज", triageSub:"प्रोफ़ाइल के आधार पर।",
    triageOverrideLabel:"मैनुअल ओवरराइड",
    speak:"मेडिकल सारांश बोलें", stopSpeak:"रोकें",
    qrTitle:"QR कोड बनाएं", qrSubA:"एक ही QR सबके लिए।",
    qrHintOffline:"ऑफ़लाइन", qrHintStatic:"QR वही, डेटा नया",
    qrHintScan:"किसी भी कैमरे से स्कैन करें",
    copyLink:"लिंक कॉपी", viewCard:"कार्ड देखें",
    exportPng:"PNG निर्यात", printCard:"प्रिंट",
    analyticsTitle:"विश्लेषण", analyticsSub:"स्कैन ट्रैक करें", totalScans:"कुल",
    last30Days:"पिछले 30 दिन", today:"आज", refreshStats:"रिफ़्रेश",
    toastSaved:"सहेजा गया", toastError:"त्रुटि", toastCopied:"लिंक कॉपी हुआ",
    needIdentity:"पहले पहचान पूरी करें (नाम, जन्म तिथि, देश)",
    codeExists:"कोड पहले से मौजूद", codeCreated:"कोड बना",
    noLink:"कॉपी करने को लिंक नहीं", maxContacts:"अधिकतम 5 संपर्क",
    contactAdded:"संपर्क जोड़ा", contactRemoved:"संपर्क हटाया",
    speechNotSupported:"ब्राउज़र में वॉइस सपोर्ट नहीं",
  },
  ar: { online:"متصل", logout:"تسجيل الخروج", worksOffline:"يعمل دون اتصال",
    profileCompletionTitle:"إكمال الملف", completeLabel:"مكتمل",
    identityCheck:"الهوية", healthCheck:"الملف الصحي", iceCheck:"جهات الطوارئ", codeCheck:"رمز الطوارئ",
    identityTitle:"معلومات الهوية", identitySub:"تساعد المسعفين على التعرف عليك والتواصل مع جهاتك.",
    fullName:"الاسم القانوني الكامل", dob:"تاريخ الميلاد", country:"بلد الإقامة",
    nhsId:"معرّف الصحة الوطني", autoSaves:"حفظ تلقائي",
    healthTitle:"الملف الصحي", healthSub:"معلومات حرجة تظهر في بطاقة الطوارئ.",
    bloodTypeLabel:"فصيلة الدم", bloodHelp:"مهم لعمليات نقل الدم",
    donorLabel:"حالة التبرع بالأعضاء", donorHelp:"تحقق من الهوية/الرخصة",
    lifeSupportLabel:"تفضيل دعم الحياة",
    allergiesLabel:"حساسيات حرجة ⚠️", allergiesHelp:"أدوية، أطعمة، بيئة.",
    conditionsLabel:"حالات طبية", conditionsHelp:"مزمنة ونفسية وجارية.",
    medsLabel:"أدوية حالية", medsHelp:"روشتة وبدون وصفة ومكملات.",
    criticalNoticeTitle:"تنبيه معلومات حرجة",
    criticalNoticeText:"مرئية للمسعفين. أدرج الضروري فقط.",
    iceTitle:"جهات اتصال الطوارئ", iceSub:"أضف حتى 5 أشخاص موثوقين.",
    addIce:"إضافة جهة اتصال", iceCountOf:"من 5 تمت إضافتهم", removeContact:"إزالة",
    triageTitle:"فرز آلي", triageSub:"أولوية محسوبة تلقائيًا.",
    triageOverrideLabel:"تجاوز يدوي",
    speak:"قراءة الملخص الطبي", stopSpeak:"إيقاف",
    qrTitle:"إنشاء رمز QR", qrSubA:"رمز واحد لكل معلوماتك.",
    qrHintOffline:"يعمل دون إنترنت", qrHintStatic:"الرمز ثابت والبيانات تتحدّث",
    qrHintScan:"يمسح بأي كاميرا",
    copyLink:"نسخ الرابط", viewCard:"عرض بطاقة الطوارئ",
    exportPng:"تصدير PNG", printCard:"طباعة البطاقة",
    analyticsTitle:"التحليلات", analyticsSub:"تتبع عدد المسحات", totalScans:"الإجمالي",
    last30Days:"آخر 30 يومًا", today:"اليوم", refreshStats:"تحديث",
    toastSaved:"تم الحفظ", toastError:"حدث خطأ", toastCopied:"تم نسخ الرابط",
    needIdentity:"أكمل الهوية أولًا (الاسم، الميلاد، البلد)",
    codeExists:"لديك رمز بالفعل", codeCreated:"تم إنشاء الرمز",
    noLink:"لا يوجد رابط للنسخ", maxContacts:"الحد 5 جهات", contactAdded:"تمت الإضافة", contactRemoved:"تمت الإزالة",
    speechNotSupported:"لا يدعم المتصفح النطق",
  },
  zh: { online:"在线", logout:"登出", worksOffline:"离线可用",
    profileCompletionTitle:"资料完成度", completeLabel:"完成",
    identityCheck:"身份", healthCheck:"健康资料", iceCheck:"紧急联系人", codeCheck:"应急码",
    identityTitle:"身份信息", identitySub:"用于确认身份并联系紧急联系人。",
    fullName:"法定全名", dob:"出生日期", country:"居住国家",
    nhsId:"国家健康ID", autoSaves:"输入即自动保存",
    healthTitle:"健康资料", healthSub:"会显示在你的应急卡上。",
    bloodTypeLabel:"血型", bloodHelp:"输血关键",
    donorLabel:"器官捐献", donorHelp:"查看证件",
    lifeSupportLabel:"生命支持偏好",
    allergiesLabel:"严重过敏 ⚠️", allergiesHelp:"药物、食物、环境过敏。",
    conditionsLabel:"疾病状况", conditionsHelp:"慢性、精神及进行中问题。",
    medsLabel:"当前用药", medsHelp:"处方、非处方、补充剂。",
    criticalNoticeTitle:"重要提示",
    criticalNoticeText:"仅填写救治所需信息。",
    iceTitle:"紧急联系人 (ICE)", iceSub:"最多添加 5 位可信联系人。",
    addIce:"添加联系人", iceCountOf:"已添加（最多5）", removeContact:"移除",
    triageTitle:"自动分诊", triageSub:"基于健康资料自动计算。",
    triageOverrideLabel:"手动覆盖",
    speak:"朗读医学摘要", stopSpeak:"停止",
    qrTitle:"生成二维码", qrSubA:"一个二维码包含全部信息。",
    qrHintOffline:"离线可用", qrHintStatic:"码不变，数据更新",
    qrHintScan:"任意相机可扫码",
    copyLink:"复制链接", viewCard:"查看应急卡",
    exportPng:"导出 PNG", printCard:"打印",
    analyticsTitle:"分析", analyticsSub:"追踪扫码次数", totalScans:"总计",
    last30Days:"近30天", today:"今天", refreshStats:"刷新",
    toastSaved:"已保存", toastError:"出错了", toastCopied:"已复制",
    needIdentity:"请先完善身份信息（姓名/生日/国家）",
    codeExists:"你已有应急码", codeCreated:"已生成应急码",
    noLink:"没有可复制的链接", maxContacts:"最多 5 位联系人",
    contactAdded:"已添加联系人", contactRemoved:"已移除联系人",
    speechNotSupported:"浏览器不支持语音",
  },
  hu: { online:"Online", logout:"Kijelentkezés", worksOffline:"Offline is működik",
    profileCompletionTitle:"Profilkészültség", completeLabel:"Kész",
    identityCheck:"Személyazonosság", healthCheck:"Egészségügyi profil", iceCheck:"ICE kapcsolatok", codeCheck:"Vészhelyzeti kód",
    identityTitle:"Személyes adatok", identitySub:"Azonosításhoz és kapcsolattartáshoz.",
    fullName:"Teljes név", dob:"Születési dátum", country:"Lakóhely országa",
    nhsId:"Nemzeti egészségügyi azonosító", autoSaves:"Automatikus mentés gépelés közben",
    healthTitle:"Egészségügyi profil", healthSub:"A vészhelyzeti kártyán jelenik meg.",
    bloodTypeLabel:"Vércsoport", bloodHelp:"Transzfúzióhoz fontos",
    donorLabel:"Szervdonor", donorHelp:"Ellenőrizd az igazolványt",
    lifeSupportLabel:"Életjeleztetési preferencia",
    allergiesLabel:"Kritikus allergiák ⚠️", allergiesHelp:"Gyógyszer, étel, környezet.",
    conditionsLabel:"Betegségek", conditionsHelp:"Krónikus, mentális, folyamatban.",
    medsLabel:"Gyógyszerek", medsHelp:"Receptre/OTC/kiegészítők.",
    criticalNoticeTitle:"Fontos figyelmeztetés",
    criticalNoticeText:"Csak a szükséges orvosi adatok.",
    iceTitle:"Sürgősségi kapcsolatok (ICE)", iceSub:"Maximum 5 megbízható személy.",
    addIce:"Kapcsolat hozzáadása", iceCountOf:"az 5-ből", removeContact:"Eltávolítás",
    triageTitle:"Automatikus triázs", triageSub:"Profil alapján.",
    triageOverrideLabel:"Kézi felülbírálat",
    speak:"Orvosi összefoglaló felolvasása", stopSpeak:"Leállítás",
    qrTitle:"QR-kód generálása", qrSubA:"Egyetlen QR mindenhez.",
    qrHintOffline:"Offline", qrHintStatic:"QR állandó, adatok frissülnek",
    qrHintScan:"Bármely kamerával olvasható",
    copyLink:"Link másolása", viewCard:"Kártya megtekintése",
    exportPng:"PNG export", printCard:"Nyomtatás",
    analyticsTitle:"Analitika", analyticsSub:"Szkennelések követése", totalScans:"Összesen",
    last30Days:"Elmúlt 30 nap", today:"Ma", refreshStats:"Frissítés",
    toastSaved:"Mentve", toastError:"Hiba", toastCopied:"Link másolva",
    needIdentity:"Előbb töltsd ki az identitást (Név, Dátum, Ország)",
    codeExists:"Már van kódod", codeCreated:"Kód létrehozva",
    noLink:"Nincs link másolni", maxContacts:"Maximum 5 kontakt",
    contactAdded:"Kapcsolat hozzáadva", contactRemoved:"Kapcsolat eltávolítva",
    speechNotSupported:"A böngésző nem támogatja a beszédet",
  },
  ro: { online:"Online", logout:"Deconectare", worksOffline:"Funcționează offline",
    profileCompletionTitle:"Completare profil", completeLabel:"Complet",
    identityCheck:"Identitate", healthCheck:"Profil medical", iceCheck:"Contacte ICE", codeCheck:"Cod de urgență",
    identityTitle:"Informații de identitate", identitySub:"Ajută salvatorii să te identifice și să îți contacteze apropiații.",
    fullName:"Nume complet", dob:"Data nașterii", country:"Țara de reședință",
    nhsId:"ID sănătate", autoSaves:"Se salvează automat",
    healthTitle:"Profil medical", healthSub:"Apare pe cardul tău de urgență.",
    bloodTypeLabel:"Grupa sanguină", bloodHelp:"Esențial pentru transfuzii",
    donorLabel:"Donator de organe", donorHelp:"Verifică actul",
    lifeSupportLabel:"Preferință suport vital",
    allergiesLabel:"Alergii critice ⚠️", allergiesHelp:"Medicamente, alimentare, de mediu.",
    conditionsLabel:"Afectiuni medicale", conditionsHelp:"Cronice, mentale, curente.",
    medsLabel:"Medicație curentă", medsHelp:"Rețetă, OTC, suplimente.",
    criticalNoticeTitle:"Atenționare",
    criticalNoticeText:"Vizibilă salvatorilor. Doar ce e necesar.",
    iceTitle:"Contacte de urgență (ICE)", iceSub:"Până la 5 persoane de încredere.",
    addIce:"Adaugă contact", iceCountOf:"din 5 adăugate", removeContact:"Șterge",
    triageTitle:"Triaj automat", triageSub:"Prioritate calculată.",
    triageOverrideLabel:"Manual",
    speak:"Redă sumarul medical", stopSpeak:"Oprește",
    qrTitle:"Generează cod QR", qrSubA:"Un singur cod pentru tot.",
    qrHintOffline:"Offline", qrHintStatic:"Cod fix, date actualizate",
    qrHintScan:"Scanabil cu orice cameră",
    copyLink:"Copiază linkul", viewCard:"Vezi cardul",
    exportPng:"Export PNG", printCard:"Printează",
    analyticsTitle:"Analitice", analyticsSub:"Urmărește scanările", totalScans:"Total",
    last30Days:"Ultimele 30 zile", today:"Astăzi", refreshStats:"Reîmprospătează",
    toastSaved:"Salvat", toastError:"Eroare", toastCopied:"Link copiat",
    needIdentity:"Completează identitatea (Nume, Dată, Țară)",
    codeExists:"Ai deja un cod", codeCreated:"Cod generat",
    noLink:"Nu există link", maxContacts:"Maxim 5 contacte",
    contactAdded:"Contact adăugat", contactRemoved:"Contact șters",
    speechNotSupported:"Browserul nu suportă vorbire",
  }
};

/* ---------- I18N ENGINE ---------- */
function currentLang() {
  const sel = document.getElementById('languageSelect');
  return sel ? (sel.value || 'en') : 'en';
}
function t(key) {
  const lang = currentLang();
  return (I18N[lang] && I18N[lang][key]) || (I18N.en[key] || key);
}
function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (key) el.textContent = t(key);
  });
}
function applyRTL() {
  const rtlLangs = ['ar','he','fa','ur'];
  const lang = currentLang();
  const html = document.documentElement;
  if (rtlLangs.includes(lang)) {
    html.setAttribute('dir','rtl');
    html.setAttribute('lang', lang);
  } else {
    html.setAttribute('dir','ltr');
    html.setAttribute('lang', lang);
  }
}
function persistLang() {
  const sel = document.getElementById('languageSelect');
  if (!sel) return;
  const stored = localStorage.getItem('myqer_lang');
  if (stored && I18N[stored]) sel.value = stored;
  sel.addEventListener('change', ()=>{
    localStorage.setItem('myqer_lang', sel.value);
    applyRTL();
    applyTranslations();
  });
}

/* ---------- TOAST ---------- */
function showToast(message, type='info') {
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.className = `toast ${type}`;
  toast.textContent = message;
  requestAnimationFrame(()=> toast.classList.add('show'));
  setTimeout(()=> toast.classList.remove('show'), 2200);
}

/* ---------- SESSION ---------- */
async function checkSession() {
  const { data: { session }, error } = await sb.auth.getSession();
  if (error || !session) {
    location.replace('index.html');
    return;
  }
  currentUser = session.user;
}

/* ---------- LOAD USER DATA ---------- */
async function loadUserData() {
  // profiles
  const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (profile) {
    currentProfile = profile;
    // identity fields
    const fn = document.getElementById('fullName'); if (fn) fn.value = profile.full_name || '';
    const dob = document.getElementById('dateOfBirth'); if (dob) dob.value = profile.date_of_birth || '';
    const ctry = document.getElementById('country'); if (ctry) ctry.value = profile.country || '';
    const nhs = document.getElementById('nationalHealthId'); if (nhs) nhs.value = profile.national_health_id || '';
    // code + QR if exists
    if (profile.code) {
      updateCardLink(profile.code);
      generateQRCode(profile.code);
      // disable generate button so only one code per user
      const genBtn = document.getElementById('generateCodeBtn');
      if (genBtn) { genBtn.disabled = true; genBtn.classList.add('opacity-60','cursor-not-allowed'); }
    }
  }
  // health_profiles
  const { data: health } = await sb.from('health_profiles').select('*').eq('user_id', currentUser.id).single();
  if (health) {
    const bt = document.getElementById('bloodType'); if (bt) bt.value = health.blood_type || '';
    const od = document.getElementById('organDonor'); if (od) od.value = (health.organ_donor==null?'':String(!!health.organ_donor));
    const lsp = document.getElementById('lifeSupportPref'); if (lsp) lsp.value = health.life_support_pref || 'Full';
    if (health.allergies) pillData.allergies = health.allergies.split(',').map(s=>s.trim()).filter(Boolean);
    if (health.conditions) pillData.conditions = health.conditions.split(',').map(s=>s.trim()).filter(Boolean);
    if (health.medications) pillData.medications = health.medications.split(',').map(s=>s.trim()).filter(Boolean);
    renderPills('allergies'); renderPills('conditions'); renderPills('medications');
  }
  // ice_contacts
  const list = document.getElementById('iceContacts');
  if (list) list.innerHTML = '';
  const { data: contacts } = await sb.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at');
  iceContactCount = 0;
  if (contacts && contacts.length) {
    contacts.forEach(ct => createIceRowFromDB(ct));
  }
  updateContactCount();
  updateProfileProgress();
}

/* ---------- SAVE FUNCTIONS (debounced in UI) ---------- */
async function saveProfile() {
  if (!currentUser) return;
  const payload = {
    id: currentUser.id,
    email: currentUser.email,
    full_name: document.getElementById('fullName')?.value?.trim() || null,
    country: document.getElementById('country')?.value || null,
    date_of_birth: document.getElementById('dateOfBirth')?.value || null,
    national_health_id: document.getElementById('nationalHealthId')?.value || null
  };
  const { error } = await sb.from('profiles').upsert(payload);
  if (!error) showToast(t('toastSaved'), 'success'); else showToast(t('toastError'), 'error');
}
async function saveHealthProfile() {
  if (!currentUser) return;
  const payload = {
    user_id: currentUser.id,
    blood_type: document.getElementById('bloodType')?.value || null,
    organ_donor: (function(v){ if(v==='true') return true; if(v==='false') return false; return null; })(document.getElementById('organDonor')?.value || ''),
    life_support_pref: document.getElementById('lifeSupportPref')?.value || 'Full',
    allergies: pillData.allergies.join(', '),
    conditions: pillData.conditions.join(', '),
    medications: pillData.medications.join(', ')
  };
  const { error } = await sb.from('health_profiles').upsert(payload);
  if (!error) { showToast(t('toastSaved'), 'success'); updateTriageStatus(); }
  else showToast(t('toastError'),'error');
}
async function saveIceContacts() {
  if (!currentUser) return;
  const container = document.getElementById('iceContacts');
  const rows = [...container.querySelectorAll('.ice-contact-card')];
  const upserts = rows.map(card=>{
    const id = card.dataset.dbid || null;
    const name = card.querySelector('.contact-name')?.value?.trim() || null;
    const relation = card.querySelector('.contact-relation')?.value || null;
    const phone = card.querySelector('.contact-phone')?.value?.trim() || null;
    const email = card.querySelector('.contact-email')?.value?.trim() || null;
    const notes = card.querySelector('.contact-notes')?.value?.trim() || null;
    return { id: id?Number(id):undefined, user_id: currentUser.id, name, relationship: relation, phone, email, notes };
  });
  const { error } = await sb.from('ice_contacts').upsert(upserts).select();
  if (!error) showToast(t('toastSaved'),'success'); else showToast(t('toastError'),'error');
}

/* ---------- PILLS UI ---------- */
function renderPills(type) {
  const wrap = document.getElementById(`${type}Pills`);
  if (!wrap) return;
  wrap.innerHTML = pillData[type].map((v,i)=>`
    <div class="pill">${v}<span class="pill-remove" onclick="removePill('${type}',${i})">×</span></div>
  `).join('');
}
function addPill(type, value) {
  if (!value) return;
  if (pillData[type].includes(value)) return;
  pillData[type].push(value);
  renderPills(type); updateTriageStatus(); updateProfileProgress();
  clearTimeout(saveTimeout); saveTimeout = setTimeout(saveHealthProfile, 600);
}
function removePill(type, index) {
  pillData[type].splice(index,1);
  renderPills(type); updateTriageStatus(); updateProfileProgress();
  clearTimeout(saveTimeout); saveTimeout = setTimeout(saveHealthProfile, 600);
}

/* ---------- ICE UI ---------- */
function createIceRowFromDB(ct) {
  const container = document.getElementById('iceContacts');
  if (!container) return;
  const div = document.createElement('div');
  div.className = 'ice-contact-card';
  div.dataset.dbid = ct.id;
  div.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label class="form-label">Full Name *</label><input type="text" class="form-input contact-name" value="${ct.name||''}"></div>
      <div>
        <label class="form-label">Relationship</label>
        <select class="form-select contact-relation">
          <option value=""></option>
          ${['Spouse','Partner','Parent','Child','Sibling','Friend','Colleague','Doctor','Lawyer','Other']
            .map(opt=>`<option value="${opt}" ${ct.relationship===opt?'selected':''}>${opt}</option>`).join('')}
        </select>
      </div>
      <div><label class="form-label">Phone *</label><input type="tel" class="form-input contact-phone" value="${ct.phone||''}"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div><label class="form-label">Email</label><input type="email" class="form-input contact-email" value="${ct.email||''}"></div>
      <div><label class="form-label">Notes</label><input type="text" class="form-input contact-notes" value="${ct.notes||''}"></div>
    </div>
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
      <button class="text-red-600 text-sm hover:text-red-800 font-medium" onclick="removeIceContactRow(this)">${t('removeContact')}</button>
      <div class="text-xs text-gray-500">${t('autoSaves')}</div>
    </div>`;
  container.appendChild(div);
  iceContactCount++;
  div.querySelectorAll('input,select').forEach(inp=>{
    inp.addEventListener('change', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
    inp.addEventListener('blur', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
  });
}
function addIceContact() {
  if (iceContactCount>=5) { showToast(t('maxContacts'),'warning'); return; }
  const container = document.getElementById('iceContacts');
  const div = document.createElement('div');
  div.className = 'ice-contact-card';
  div.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label class="form-label">Full Name *</label><input type="text" class="form-input contact-name" placeholder="Jane Doe"></div>
      <div>
        <label class="form-label">Relationship</label>
        <select class="form-select contact-relation">
          <option value=""></option>
          ${['Spouse','Partner','Parent','Child','Sibling','Friend','Colleague','Doctor','Lawyer','Other']
            .map(opt=>`<option value="${opt}">${opt}</option>`).join('')}
        </select>
      </div>
      <div><label class="form-label">Phone *</label><input type="tel" class="form-input contact-phone" placeholder="+1 555 000 1111"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div><label class="form-label">Email</label><input type="email" class="form-input contact-email" placeholder="contact@example.com"></div>
      <div><label class="form-label">Notes</label><input type="text" class="form-input contact-notes" placeholder=""></div>
    </div>
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
      <button class="text-red-600 text-sm hover:text-red-800 font-medium" onclick="removeIceContactRow(this)">${t('removeContact')}</button>
      <div class="text-xs text-gray-500">${t('autoSaves')}</div>
    </div>`;
  container.appendChild(div);
  iceContactCount++;
  updateContactCount(); updateProfileProgress();
  div.querySelectorAll('input,select').forEach(inp=>{
    inp.addEventListener('change', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
    inp.addEventListener('blur', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
  });
  showToast(t('contactAdded'), 'success');
}
function removeIceContactRow(btn) {
  const card = btn.closest('.ice-contact-card');
  const dbid = card?.dataset?.dbid;
  card?.remove();
  iceContactCount = Math.max(0, iceContactCount-1);
  updateContactCount(); updateProfileProgress();
  if (dbid) { sb.from('ice_contacts').delete().eq('id', dbid); }
  clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,300);
  showToast(t('contactRemoved'),'success');
}
function updateContactCount() {
  const el = document.getElementById('contactCount');
  if (el) el.textContent = iceContactCount;
  const addBtn = document.getElementById('addIceContact');
  if (addBtn) addBtn.disabled = (iceContactCount>=5);
}

/* ---------- PROGRESS RING ---------- */
function updateProfileProgress() {
  const checks = {
    identity: checkIdentityComplete(),
    health: checkHealthComplete(),
    contacts: iceContactCount>0,
    code: !!(currentProfile && currentProfile.code)
  };
  const completed = Object.values(checks).filter(Boolean).length;
  const pct = Math.round((completed/4)*100);
  const circ = document.getElementById('progressCircle');
  const pctEl = document.getElementById('progressPercent');
  const C = 2*Math.PI*28;
  if (circ) circ.style.strokeDasharray = `${(pct/100)*C} ${C}`;
  if (pctEl) pctEl.textContent = `${pct}%`;
  updateCheckIndicator('checkIdentity', checks.identity);
  updateCheckIndicator('checkHealth', checks.health);
  updateCheckIndicator('checkContacts', checks.contacts);
  updateCheckIndicator('checkCode', checks.code);
}
function updateCheckIndicator(id, ok) {
  const el = document.getElementById(id);
  if (!el) return;
  const dot = el.querySelector('div');
  const label = el.querySelector('span');
  if (ok) { dot.className='w-4 h-4 rounded-full bg-green-500'; label.className='text-green-700 font-medium'; }
  else { dot.className='w-4 h-4 rounded-full bg-gray-300'; label.className='text-gray-600'; }
}
function checkIdentityComplete() {
  const name = document.getElementById('fullName')?.value?.trim();
  const dob = document.getElementById('dateOfBirth')?.value;
  const country = document.getElementById('country')?.value;
  return !!(name && dob && country);
}
function checkHealthComplete() {
  const bloodType = document.getElementById('bloodType')?.value;
  return !!(bloodType || pillData.allergies.length || pillData.conditions.length);
}

/* ---------- QR (single code per user) ---------- */
function updateCardLink(code) {
  const link = `${ORIGIN}/c/${code}`;
  const input = document.getElementById('cardLink');
  if (input) input.value = link;
}
function generateQRCode(code) {
  const canvas = document.getElementById('qrCanvas');
  const placeholder = document.getElementById('qrPlaceholder');
  const url = `${ORIGIN}/c/${code}`;
  QRCode.toCanvas(canvas, url, { width:160, height:160, margin:3, errorCorrectionLevel:'M' }, (err)=>{
    if (err) { placeholder.style.display='block'; canvas.style.display='none'; }
    else { placeholder.style.display='none'; canvas.style.display='block'; }
  });
}
async function generateEmergencyCode() {
  if (!checkIdentityComplete()) { showToast(t('needIdentity'),'warning'); return; }
  // Refetch profile to be sure
  const { data: p } = await sb.from('profiles').select('id,code').eq('id', currentUser.id).single();
  if (p && p.code) { showToast(t('codeExists'),'info'); return; }
  const code = Math.random().toString(36).slice(2,8).toUpperCase();
  const { error } = await sb.from('profiles').update({ code }).eq('id', currentUser.id);
  if (!error) {
    currentProfile = { ...(currentProfile||{}), code };
    updateCardLink(code); generateQRCode(code); updateProfileProgress();
    const genBtn = document.getElementById('generateCodeBtn');
    if (genBtn) { genBtn.disabled = true; genBtn.classList.add('opacity-60','cursor-not-allowed'); }
    showToast(t('codeCreated'),'success');
  } else showToast(t('toastError'),'error');
}

/* ---------- COPY / VIEW / EXPORT / PRINT ---------- */
function copyCardLink() {
  const v = document.getElementById('cardLink')?.value;
  if (!v) { showToast(t('noLink'),'warning'); return; }
  navigator.clipboard.writeText(v).then(()=> showToast(t('toastCopied'),'success'))
    .catch(()=> showToast(t('toastError'),'error'));
}
function viewEmergencyCard() {
  if (!currentProfile?.code) { showToast(t('codeExists'),'info'); return; }
  window.open(`${ORIGIN}/c/${currentProfile.code}`,'_blank');
}
function exportQR() {
  const canvas = document.getElementById('qrCanvas');
  if (!canvas || canvas.style.display==='none') return;
  const link = document.createElement('a');
  link.download = `MYQER-${currentProfile.code}-QR.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
}
function printEmergencyCard() {
  if (!currentProfile?.code) { showToast(t('needIdentity'),'warning'); return; }
  window.open(`${ORIGIN}/c/${currentProfile.code}?print=true`,'_blank');
}

<script>
/* ========= CHUNK 7: TRIAGE + SPEECH + ANALYTICS HOOKS ========= */

/* -------- i18n strings (triage + speech + QR actions) -------- */
const i18nExtra = {
  en: {
    triage_auto: "🤖 Auto (Recommended)",
    triage_green: "GREEN - Standard (Auto)",
    triage_amber: "AMBER - Urgent (Auto)",
    triage_red: "RED - Immediate (Auto)",
    triage_black: "BLACK - Comfort (Auto)",
    triage_green_m: "🟢 Green - Standard Priority",
    triage_amber_m: "🟡 Amber - Urgent Priority",
    triage_red_m: "🔴 Red - Immediate Priority",
    triage_black_m: "⚫ Black - Comfort Care",
    speak_summary: "🔊 Speak Medical Summary",
    stop_speaking: "⏹️ Stop Speaking",
    speech_started: "Speaking medical summary...",
    speech_stopped: "Speech stopped",
    speech_error: "Speech synthesis failed",
  },
  es: {
    triage_auto: "🤖 Auto (Recomendado)",
    triage_green: "VERDE - Estándar (Auto)",
    triage_amber: "ÁMBAR - Urgente (Auto)",
    triage_red: "ROJO - Inmediata (Auto)",
    triage_black: "NEGRO - Cuidados de confort (Auto)",
    triage_green_m: "🟢 Verde - Prioridad estándar",
    triage_amber_m: "🟡 Ámbar - Prioridad urgente",
    triage_red_m: "🔴 Rojo - Prioridad inmediata",
    triage_black_m: "⚫ Negro - Cuidados de confort",
    speak_summary: "🔊 Leer resumen médico",
    stop_speaking: "⛔ Detener lectura",
    speech_started: "Leyendo el resumen médico...",
    speech_stopped: "Lectura detenida",
    speech_error: "La síntesis de voz falló",
  },
  fr: {
    triage_auto: "🤖 Auto (Recommandé)",
    triage_green: "VERT - Standard (Auto)",
    triage_amber: "AMBRE - Urgent (Auto)",
    triage_red: "ROUGE - Immédiat (Auto)",
    triage_black: "NOIR - Soins de confort (Auto)",
    triage_green_m: "🟢 Vert - Priorité standard",
    triage_amber_m: "🟡 Ambre - Priorité urgente",
    triage_red_m: "🔴 Rouge - Priorité immédiate",
    triage_black_m: "⚫ Noir - Soins de confort",
    speak_summary: "🔊 Énoncer le résumé médical",
    stop_speaking: "⏹️ Arrêter",
    speech_started: "Énonciation du résumé médical...",
    speech_stopped: "Énonciation arrêtée",
    speech_error: "Échec de la synthèse vocale",
  },
  de: {
    triage_auto: "🤖 Auto (Empfohlen)",
    triage_green: "GRÜN - Standard (Auto)",
    triage_amber: "GELB - Dringend (Auto)",
    triage_red: "ROT - Sofort (Auto)",
    triage_black: "SCHWARZ - Komfortpflege (Auto)",
    triage_green_m: "🟢 Grün - Standard Priorität",
    triage_amber_m: "🟡 Gelb - Dringende Priorität",
    triage_red_m: "🔴 Rot - Sofortige Priorität",
    triage_black_m: "⚫ Schwarz - Komfortpflege",
    speak_summary: "🔊 Medizinische Zusammenfassung vorlesen",
    stop_speaking: "⏹️ Stoppen",
    speech_started: "Zusammenfassung wird gesprochen...",
    speech_stopped: "Sprachausgabe gestoppt",
    speech_error: "Sprachausgabe fehlgeschlagen",
  },
  it: {
    triage_auto: "🤖 Auto (Consigliato)",
    triage_green: "VERDE - Standard (Auto)",
    triage_amber: "AMBRA - Urgente (Auto)",
    triage_red: "ROSSO - Immediata (Auto)",
    triage_black: "NERO - Cure di conforto (Auto)",
    triage_green_m: "🟢 Verde - Priorità standard",
    triage_amber_m: "🟡 Ambra - Priorità urgente",
    triage_red_m: "🔴 Rosso - Priorità immediata",
    triage_black_m: "⚫ Nero - Cure di conforto",
    speak_summary: "🔊 Leggi riepilogo medico",
    stop_speaking: "⏹️ Interrompi",
    speech_started: "Lettura del riepilogo medico...",
    speech_stopped: "Lettura interrotta",
    speech_error: "Sintesi vocale non riuscita",
  },
  hi: {
    triage_auto: "🤖 ऑटो (अनुशंसित)",
    triage_green: "हरा - मानक (ऑटो)",
    triage_amber: "अम्बर - अर्जेंट (ऑटो)",
    triage_red: "लाल - तत्काल (ऑटो)",
    triage_black: "काला - आराम देखभाल (ऑटो)",
    triage_green_m: "🟢 हरा - मानक प्राथमिकता",
    triage_amber_m: "🟡 अंबर - अर्जेंट प्राथमिकता",
    triage_red_m: "🔴 लाल - तत्काल प्राथमिकता",
    triage_black_m: "⚫ काला - आराम देखभाल",
    speak_summary: "🔊 चिकित्सा सारांश बोलें",
    stop_speaking: "⏹️ रोकें",
    speech_started: "चिकित्सा सारांश बोला जा रहा है...",
    speech_stopped: "वाचन रोका गया",
    speech_error: "वाणी संश्लेषण विफल",
  },
  ar: {
    triage_auto: "🤖 تلقائي (موصى به)",
    triage_green: "أخضر - عادي (تلقائي)",
    triage_amber: "كهرماني - عاجل (تلقائي)",
    triage_red: "أحمر - فوري (تلقائي)",
    triage_black: "أسود - رعاية مريحة (تلقائي)",
    triage_green_m: "🟢 أخضر - أولوية عادية",
    triage_amber_m: "🟡 كهرماني - أولوية عاجلة",
    triage_red_m: "🔴 أحمر - أولوية فورية",
    triage_black_m: "⚫ أسود - رعاية مريحة",
    speak_summary: "🔊 نطق الملخص الطبي",
    stop_speaking: "⏹️ إيقاف",
    speech_started: "يتم نطق الملخص الطبي...",
    speech_stopped: "تم إيقاف النطق",
    speech_error: "فشل تركيب الصوت",
  },
  zh: {
    triage_auto: "🤖 自动（推荐）",
    triage_green: "绿色 - 标准（自动）",
    triage_amber: "琥珀 - 紧急（自动）",
    triage_red: "红色 - 立即（自动）",
    triage_black: "黑色 - 舒缓护理（自动）",
    triage_green_m: "🟢 绿色 - 标准优先级",
    triage_amber_m: "🟡 琥珀 - 紧急优先级",
    triage_red_m: "🔴 红色 - 立即优先级",
    triage_black_m: "⚫ 黑色 - 舒缓护理",
    speak_summary: "🔊 朗读医疗摘要",
    stop_speaking: "⏹️ 停止朗读",
    speech_started: "正在朗读医疗摘要…",
    speech_stopped: "已停止朗读",
    speech_error: "语音合成失败",
  },
  hu: {
    triage_auto: "🤖 Automatikus (Ajánlott)",
    triage_green: "ZÖLD - Normál (Auto)",
    triage_amber: "BOROSTYÁN - Sürgős (Auto)",
    triage_red: "PIROS - Azonnali (Auto)",
    triage_black: "FEKETE - Komfort ápolás (Auto)",
    triage_green_m: "🟢 Zöld - Normál prioritás",
    triage_amber_m: "🟡 Borostyán - Sürgős prioritás",
    triage_red_m: "🔴 Piros - Azonnali prioritás",
    triage_black_m: "⚫ Fekete - Komfort ápolás",
    speak_summary: "🔊 Orvosi összefoglaló felolvasása",
    stop_speaking: "⏹️ Leállítás",
    speech_started: "Orvosi összefoglaló felolvasása...",
    speech_stopped: "Felolvasás leállítva",
    speech_error: "A beszédszintézis nem sikerült",
  },
  ro: {
    triage_auto: "🤖 Auto (Recomandat)",
    triage_green: "VERDE - Standard (Auto)",
    triage_amber: "AMBRU - Urgent (Auto)",
    triage_red: "ROȘU - Imediat (Auto)",
    triage_black: "NEGRU - Îngrijire de confort (Auto)",
    triage_green_m: "🟢 Verde - Prioritate standard",
    triage_amber_m: "🟡 Ambru - Prioritate urgentă",
    triage_red_m: "🔴 Roșu - Prioritate imediată",
    triage_black_m: "⚫ Negru - Îngrijire de confort",
    speak_summary: "🔊 Redă rezumatul medical",
    stop_speaking: "⏹️ Oprește",
    speech_started: "Se redă rezumatul medical...",
    speech_stopped: "Redarea a fost oprită",
    speech_error: "Sintexa vocală a eșuat",
  },
};

// merge into global translations if present
window.__I18N__ = Object.assign({}, window.__I18N__ || {}, i18nExtra);

/* -------- Triage calculation (auto + manual override) -------- */
function updateTriageStatus() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  const statusElement = document.getElementById('triageStatus');
  const overrideSel = document.getElementById('triageOverride');
  if (!statusElement || !overrideSel) return;

  const override = overrideSel.value;

  const setStatus = (kind, textKey) => {
    const classMap = {
      Green: 'triage-green',
      Amber: 'triage-amber',
      Red: 'triage-red',
      Black: 'triage-black'
    };
    statusElement.className = `triage-status ${classMap[kind]}`;
    statusElement.textContent = t[textKey];
  };

  if (override) {
    const mapText = {
      Green: 'triage_green_m',
      Amber: 'triage_amber_m',
      Red: 'triage_red_m',
      Black: 'triage_black_m'
    };
    setStatus(override, mapText[override]);
    return;
  }

  // AUTO: derive from health profile pills + life support
  const lifeSupportPref = document.getElementById('lifeSupportPref')?.value || 'Full';

  const critAllergies = [
    'penicillin','morphine','codeine','fentanyl','midazolam','propofol',
    'aspirin','ibuprofen','latex','shellfish','nuts','peanuts'
  ];

  const highRiskConditions = [
    'diabetes','heart','cardiac','stroke','seizure','epilepsy',
    'asthma','copd','kidney','liver','cancer','pregnan','anticoag'
  ];

  const hasCriticalAllergy = (window.pillData?.allergies || [])
    .some(a => critAllergies.some(k => a.toLowerCase().includes(k)));

  const hasHighRiskCondition = (window.pillData?.conditions || [])
    .some(c => highRiskConditions.some(k => c.toLowerCase().includes(k)));

  let auto = 'Green';
  if (lifeSupportPref === 'DNR') auto = 'Black';
  else if (hasCriticalAllergy || hasHighRiskCondition || (window.pillData?.conditions || []).length > 3) auto = 'Red';
  else if ((window.pillData?.allergies || []).length > 0 || (window.pillData?.medications || []).length > 2) auto = 'Amber';

  const textKey = {
    Green: 'triage_green',
    Amber: 'triage_amber',
    Red: 'triage_red',
    Black: 'triage_black'
  }[auto];

  setStatus(auto, textKey);
}

/* -------- Speech summary (localized) -------- */
let currentSpeech = null;

function speakSummary() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  if (currentSpeech) {
    try { speechSynthesis.cancel(); } catch {}
    currentSpeech = null;
  }

  const fullName = document.getElementById('fullName')?.value || '';
  const bloodType = document.getElementById('bloodType')?.value || '';
  const allergies = (window.pillData?.allergies || []).join(', ');
  const conditions = (window.pillData?.conditions || []).join(', ');
  const meds = (window.pillData?.medications || []).join(', ');
  const lifePref = document.getElementById('lifeSupportPref')?.value || 'Full';

  // Simple multilingual summary (kept concise for the speaker)
  const summaries = {
    en: `Emergency summary for ${fullName || 'Unknown patient'}. Blood type ${bloodType || 'unknown'}. Allergies: ${allergies || 'none'}. Conditions: ${conditions || 'none'}. Medications: ${meds || 'none'}. Life support preference: ${lifePref}.`,
    es: `Resumen de emergencia para ${fullName || 'Paciente desconocido'}. Grupo sanguíneo ${bloodType || 'desconocido'}. Alergias: ${allergies || 'ninguna'}. Condiciones: ${conditions || 'ninguna'}. Medicación: ${meds || 'ninguna'}. Preferencia de soporte vital: ${lifePref}.`,
    fr: `Résumé d'urgence pour ${fullName || 'patient inconnu'}. Groupe sanguin ${bloodType || 'inconnu'}. Allergies: ${allergies || 'aucune'}. Pathologies: ${conditions || 'aucune'}. Médicaments: ${meds || 'aucun'}. Préférence d'assistance vitale: ${lifePref}.`,
    de: `Notfallzusammenfassung für ${fullName || 'unbekannten Patienten'}. Blutgruppe ${bloodType || 'unbekannt'}. Allergien: ${allergies || 'keine'}. Erkrankungen: ${conditions || 'keine'}. Medikamente: ${meds || 'keine'}. Lebenserhaltungspräferenz: ${lifePref}.`,
    it: `Riepilogo d'emergenza per ${fullName || 'paziente sconosciuto'}. Gruppo sanguigno ${bloodType || 'sconosciuto'}. Allergie: ${allergies || 'nessuna'}. Patologie: ${conditions || 'nessuna'}. Farmaci: ${meds || 'nessuno'}. Preferenza supporto vitale: ${lifePref}.`,
    hi: `${fullName || 'अज्ञात मरीज'} के लिए आपातकालीन सारांश। रक्त समूह ${bloodType || 'अज्ञात'}. एलर्जी: ${allergies || 'कोई नहीं'}. स्थितियां: ${conditions || 'कोई नहीं'}. दवाएं: ${meds || 'कोई नहीं'}. जीवन रक्षक वरीयता: ${lifePref}.`,
    ar: `ملخص طارئ لـ ${fullName || 'مريض غير معروف'}. فصيلة الدم ${bloodType || 'غير معروفة'}. الحساسية: ${allergies || 'لا يوجد'}. الحالات: ${conditions || 'لا توجد'}. الأدوية: ${meds || 'لا يوجد'}. تفضيل دعم الحياة: ${lifePref}.`,
    zh: `${fullName || '未知患者'} 的紧急摘要。血型 ${bloodType || '未知'}。过敏：${allergies || '无'}。病史：${conditions || '无'}。用药：${meds || '无'}。生命支持偏好：${lifePref}。`,
    hu: `Sürgősségi összefoglaló ${fullName || 'ismeretlen beteg'} számára. Vércsoport: ${bloodType || 'ismeretlen'}. Allergiák: ${allergies || 'nincs'}. Állapotok: ${conditions || 'nincs'}. Gyógyszerek: ${meds || 'nincs'}. Életjelek támogatási preferencia: ${lifePref}.`,
    ro: `Rezumat de urgență pentru ${fullName || 'pacient necunoscut'}. Grupă sanguină ${bloodType || 'necunoscută'}. Alergii: ${allergies || 'niciuna'}. Afecțiuni: ${conditions || 'niciuna'}. Medicație: ${meds || 'niciuna'}. Preferință suport vital: ${lifePref}.`,
  };

  const utterText = summaries[lang] || summaries['en'];

  if (!('speechSynthesis' in window)) {
    showToast(t.speech_error, 'error');
    return;
  }

  currentSpeech = new SpeechSynthesisUtterance(utterText);
  currentSpeech.lang = (lang === 'zh' ? 'zh-CN' :
                        lang === 'ar' ? 'ar-SA' :
                        lang === 'hi' ? 'hi-IN' :
                        lang === 'es' ? 'es-ES' :
                        lang === 'fr' ? 'fr-FR' :
                        lang === 'de' ? 'de-DE' :
                        lang === 'it' ? 'it-IT' :
                        lang === 'hu' ? 'hu-HU' :
                        lang === 'ro' ? 'ro-RO' : 'en-US');
  currentSpeech.rate = 0.95;

  currentSpeech.onstart = () => {
    const speakBtn = document.getElementById('speakSummaryBtn');
    const stopBtn = document.getElementById('stopSpeakingBtn');
    if (speakBtn && stopBtn) { speakBtn.style.display = 'none'; stopBtn.style.display = 'block'; }
    showToast(t.speech_started, 'info');
  };
  currentSpeech.onend = () => {
    const speakBtn = document.getElementById('speakSummaryBtn');
    const stopBtn = document.getElementById('stopSpeakingBtn');
    if (speakBtn && stopBtn) { speakBtn.style.display = 'block'; stopBtn.style.display = 'none'; }
    currentSpeech = null;
  };
  currentSpeech.onerror = () => {
    const speakBtn = document.getElementById('speakSummaryBtn');
    const stopBtn = document.getElementById('stopSpeakingBtn');
    if (speakBtn && stopBtn) { speakBtn.style.display = 'block'; stopBtn.style.display = 'none'; }
    currentSpeech = null;
    showToast(t.speech_error, 'error');
  };

  speechSynthesis.speak(currentSpeech);
}

function stopSpeaking() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  if (currentSpeech) {
    try { speechSynthesis.cancel(); } catch {}
    currentSpeech = null;
  }
  const speakBtn = document.getElementById('speakSummaryBtn');
  const stopBtn = document.getElementById('stopSpeakingBtn');
  if (speakBtn && stopBtn) { speakBtn.style.display = 'block'; stopBtn.style.display = 'none'; }
  showToast(t.speech_stopped, 'info');
}

/* -------- Analytics hooks (scan logging trigger) --------
   NOTE: the real increment of scans happens on the public card view (/c/:code).
   This hook ensures your dashboard UI can request current counts when needed.
*/
async function fetchScanStats() {
  if (!window.sb || !window.currentUser) return { total_scans: 0, last_scan_at: null };
  const { data, error } = await window.sb
    .from('scan_stats')
    .select('total_scans,last_scan_at')
    .eq('user_id', window.currentUser.id)
    .single();
  if (error) {
    console.warn('Scan stats error:', error);
    return { total_scans: 0, last_scan_at: null };
  }
  return data || { total_scans: 0, last_scan_at: null };
}

// optional: call to refresh analytics card if present
async function refreshAnalyticsCard() {
  const elCount = document.getElementById('scanCount');
  const elLast = document.getElementById('lastScanAt');
  if (!elCount && !elLast) return;
  const stats = await fetchScanStats();
  if (elCount) elCount.textContent = String(stats.total_scans || 0);
  if (elLast) elLast.textContent = stats.last_scan_at ? new Date(stats.last_scan_at).toLocaleString() : '—';
}

/* -------- Wire language changes to these controls -------- */
function applyTriageI18n() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  // Update manual override select labels if they exist
  const triageOverride = document.getElementById('triageOverride');
  if (triageOverride) {
    const map = {
      '': t.triage_auto,
      'Green': t.triage_green_m,
      'Amber': t.triage_amber_m,
      'Red': t.triage_red_m,
      'Black': t.triage_black_m
    };
    [...triageOverride.options].forEach(opt => {
      opt.textContent = map[opt.value] ?? opt.textContent;
    });
  }

  // Buttons
  const speakBtn = document.getElementById('speakSummaryBtn');
  const stopBtn = document.getElementById('stopSpeakingBtn');
  if (speakBtn) speakBtn.innerText = t.speak_summary;
  if (stopBtn) stopBtn.innerText = t.stop_speaking;

  // Recompute status text with new language
  updateTriageStatus();
}

/* -------- Init hooks (call these from your main init) -------- */
document.addEventListener('DOMContentLoaded', () => {
  // If your main init already sets listeners, these are idempotent:
  const triageSel = document.getElementById('triageOverride');
  if (triageSel) triageSel.addEventListener('change', updateTriageStatus);

  const speakBtn = document.getElementById('speakSummaryBtn');
  const stopBtn = document.getElementById('stopSpeakingBtn');
  if (speakBtn) speakBtn.addEventListener('click', speakSummary);
  if (stopBtn) stopBtn.addEventListener('click', stopSpeaking);

  const langSel = document.getElementById('languageSelect');
  if (langSel) langSel.addEventListener('change', applyTriageI18n);

  // First paint
  applyTriageI18n();
  refreshAnalyticsCard();
});
</script>
  <script>
/* =========================
   MYQER™ DASHBOARD – MASTER SCRIPT (Chunk 8)
   Wires up: session + logout, autosave (Identity/Health), ICE CRUD,
   single QR per user, i18n (10 languages), delete account, toasts, progress
   ========================= */

/* ---------- Guards & Globals ---------- */
(() => {
  // Require a Supabase client created earlier:
  if (!window.supabase || !window.sb) {
    console.error('Supabase client not found. Make sure window.sb = supabase.createClient(...) is defined in the head.');
    return;
  }

  const sb = window.sb;
  const ORIGIN = window.location.origin;

  // Global, single state container to avoid re-definitions across chunks
  const MYQER = (window.MYQER = window.MYQER || {});

  // UI refs helper
  const $ = (id) => document.getElementById(id);

  // Debounce helper
  const debounce = (fn, wait = 500) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  };

  /* ---------- Toasts ---------- */
  const toastEl = $('toast');
  function showToast(msg, type = 'info', ttl = 2200) {
    if (!toastEl) return;
    toastEl.className = `toast ${type}`;
    toastEl.textContent = msg;
    // force reflow to restart animation
    // eslint-disable-next-line no-unused-expressions
    toastEl.offsetHeight;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), ttl);
  }

  /* ---------- i18n (10 languages) ---------- */
  const LANG_KEY = 'myqer_lang';
  const languageSelect = $('languageSelect');

  // Only keys that are set programmatically (buttons, dynamic labels, placeholders, toasts)
  const i18n = {
    en: {
      logout: 'Logout',
      confirm_logout: 'Are you sure you want to logout?',
      saved: 'Saved',
      save_failed: 'Save failed',
      add_contact: 'Add Emergency Contact',
      remove_contact: 'Remove Contact',
      max_contacts: 'Maximum 5 contacts allowed',
      contact_added: 'Contact added',
      contact_removed: 'Contact removed',
      generate_code: 'Generate Emergency Code',
      code_exists: 'Your emergency code already exists',
      code_created: 'Emergency code generated',
      gen_needs_identity: 'Please complete your identity information first (Name, Date of Birth, Country)',
      copy_link: 'Copy Shareable Link',
      link_copied: 'Link copied to clipboard!',
      link_missing: 'No link to copy - generate your emergency code first',
      view_card: 'View Emergency Card',
      must_generate_first: 'Generate your emergency code first',
      export_png: 'Export PNG',
      exported_png: 'QR code exported as PNG',
      print_card: 'Print Card',
      speak_summary: '🔊 Speak Medical Summary',
      stop_speaking: '⏹️ Stop Speaking',
      speech_started: 'Speaking medical summary...',
      speech_stopped: 'Speech stopped',
      speech_error: 'Speech synthesis failed',
      speech_unsupported: 'Speech synthesis not supported in this browser',
      delete_account: 'Delete Account',
      delete_confirm: 'This will permanently delete your account and all related data. This cannot be undone. Continue?',
      delete_done: 'Account deleted',
      delete_failed: 'Delete failed',
      offline_badge: 'WORKS OFFLINE',
      qr_complete_profile: 'Complete your profile to generate QR code',
      // Form placeholders
      ph_full_name: 'Enter your full legal name',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: 'NHS Number, SSN, etc.',
      ph_allergy: 'Type allergy and press Enter',
      ph_condition: 'Type condition and press Enter',
      ph_medication: 'Type medication and press Enter',
      ph_contact_name: 'Enter full name',
      ph_contact_phone: '+1 (555) 123-4567',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: 'Additional information'
    },

    es: {
      logout: 'Cerrar sesión',
      confirm_logout: '¿Seguro que quieres cerrar sesión?',
      saved: 'Guardado',
      save_failed: 'Error al guardar',
      add_contact: 'Añadir contacto ICE',
      remove_contact: 'Eliminar contacto',
      max_contacts: 'Máximo 5 contactos',
      contact_added: 'Contacto añadido',
      contact_removed: 'Contacto eliminado',
      generate_code: 'Generar código de emergencia',
      code_exists: 'Tu código de emergencia ya existe',
      code_created: 'Código de emergencia generado',
      gen_needs_identity: 'Completa tu información de identidad primero (Nombre, Fecha de nacimiento, País)',
      copy_link: 'Copiar enlace compartible',
      link_copied: '¡Enlace copiado!',
      link_missing: 'No hay enlace: genera tu código primero',
      view_card: 'Ver tarjeta de emergencia',
      must_generate_first: 'Genera tu código de emergencia primero',
      export_png: 'Exportar PNG',
      exported_png: 'Código QR exportado como PNG',
      print_card: 'Imprimir tarjeta',
      speak_summary: '🔊 Reproducir resumen médico',
      stop_speaking: '⏹️ Detener',
      speech_started: 'Reproduciendo resumen médico...',
      speech_stopped: 'Reproducción detenida',
      speech_error: 'Error de síntesis de voz',
      speech_unsupported: 'Síntesis de voz no soportada',
      delete_account: 'Eliminar cuenta',
      delete_confirm: 'Esto eliminará tu cuenta y datos para siempre. ¿Continuar?',
      delete_done: 'Cuenta eliminada',
      delete_failed: 'Error al eliminar',
      offline_badge: 'FUNCIONA SIN INTERNET',
      qr_complete_profile: 'Completa tu perfil para generar el código QR',
      ph_full_name: 'Ingresa tu nombre legal completo',
      ph_dob: 'DD/MM/AAAA',
      ph_health_id: 'Nº de salud, SSN, etc.',
      ph_allergy: 'Escribe alergia y presiona Enter',
      ph_condition: 'Escribe condición y presiona Enter',
      ph_medication: 'Escribe medicación y presiona Enter',
      ph_contact_name: 'Nombre completo',
      ph_contact_phone: '+34 600 000 000',
      ph_contact_email: 'contacto@ejemplo.com',
      ph_contact_notes: 'Información adicional'
    },

    fr: {
      logout: 'Déconnexion',
      confirm_logout: 'Voulez-vous vraiment vous déconnecter ?',
      saved: 'Enregistré',
      save_failed: 'Échec de l’enregistrement',
      add_contact: 'Ajouter un contact ICE',
      remove_contact: 'Supprimer le contact',
      max_contacts: 'Maximum 5 contacts',
      contact_added: 'Contact ajouté',
      contact_removed: 'Contact supprimé',
      generate_code: 'Générer le code d’urgence',
      code_exists: 'Votre code d’urgence existe déjà',
      code_created: 'Code d’urgence généré',
      gen_needs_identity: 'Veuillez compléter votre identité (Nom, Date de naissance, Pays)',
      copy_link: 'Copier le lien partageable',
      link_copied: 'Lien copié !',
      link_missing: 'Aucun lien – générez d’abord votre code',
      view_card: 'Voir la carte d’urgence',
      must_generate_first: 'Générez d’abord votre code d’urgence',
      export_png: 'Exporter PNG',
      exported_png: 'QR exporté en PNG',
      print_card: 'Imprimer la carte',
      speak_summary: '🔊 Lire le résumé médical',
      stop_speaking: '⏹️ Arrêter',
      speech_started: 'Lecture du résumé médical…',
      speech_stopped: 'Lecture arrêtée',
      speech_error: 'Échec de synthèse vocale',
      speech_unsupported: 'Synthèse vocale non prise en charge',
      delete_account: 'Supprimer le compte',
      delete_confirm: 'Suppression définitive du compte et des données. Continuer ?',
      delete_done: 'Compte supprimé',
      delete_failed: 'Échec de la suppression',
      offline_badge: 'FONCTIONNE HORS-LIGNE',
      qr_complete_profile: 'Complétez votre profil pour générer le QR',
      ph_full_name: 'Entrez votre nom légal complet',
      ph_dob: 'JJ/MM/AAAA',
      ph_health_id: 'N° santé, SSN, etc.',
      ph_allergy: 'Tapez allergie et Entrée',
      ph_condition: 'Tapez condition et Entrée',
      ph_medication: 'Tapez médicament et Entrée',
      ph_contact_name: 'Nom complet',
      ph_contact_phone: '+33 6 00 00 00 00',
      ph_contact_email: 'contact@exemple.com',
      ph_contact_notes: 'Informations supplémentaires'
    },

    de: {
      logout: 'Abmelden',
      confirm_logout: 'Möchtest du dich wirklich abmelden?',
      saved: 'Gespeichert',
      save_failed: 'Speichern fehlgeschlagen',
      add_contact: 'ICE-Kontakt hinzufügen',
      remove_contact: 'Kontakt entfernen',
      max_contacts: 'Maximal 5 Kontakte',
      contact_added: 'Kontakt hinzugefügt',
      contact_removed: 'Kontakt entfernt',
      generate_code: 'Notfallcode erzeugen',
      code_exists: 'Dein Notfallcode existiert bereits',
      code_created: 'Notfallcode erstellt',
      gen_needs_identity: 'Bitte Identität ausfüllen (Name, Geburtsdatum, Land)',
      copy_link: 'Link kopieren',
      link_copied: 'Link kopiert!',
      link_missing: 'Kein Link – erst Code erzeugen',
      view_card: 'Notfallkarte ansehen',
      must_generate_first: 'Erzeuge zuerst deinen Code',
      export_png: 'PNG exportieren',
      exported_png: 'QR-Code als PNG exportiert',
      print_card: 'Karte drucken',
      speak_summary: '🔊 Medizinische Zusammenfassung sprechen',
      stop_speaking: '⏹️ Stoppen',
      speech_started: 'Zusammenfassung wird gesprochen…',
      speech_stopped: 'Ausgabe gestoppt',
      speech_error: 'Sprachausgabe fehlgeschlagen',
      speech_unsupported: 'Sprachausgabe nicht unterstützt',
      delete_account: 'Konto löschen',
      delete_confirm: 'Konto und Daten dauerhaft löschen. Fortfahren?',
      delete_done: 'Konto gelöscht',
      delete_failed: 'Löschen fehlgeschlagen',
      offline_badge: 'OFFLINE FUNKTIONSFÄHIG',
      qr_complete_profile: 'Profil vervollständigen, um QR zu erzeugen',
      ph_full_name: 'Vollständigen Namen eingeben',
      ph_dob: 'TT/MM/JJJJ',
      ph_health_id: 'Kranken-Nr., SSN, etc.',
      ph_allergy: 'Allergie eingeben und Enter',
      ph_condition: 'Krankheit eingeben und Enter',
      ph_medication: 'Medikament eingeben und Enter',
      ph_contact_name: 'Vollständiger Name',
      ph_contact_phone: '+49 160 000000',
      ph_contact_email: 'kontakt@beispiel.de',
      ph_contact_notes: 'Zusätzliche Informationen'
    },

    it: {
      logout: 'Esci',
      confirm_logout: 'Vuoi davvero uscire?',
      saved: 'Salvato',
      save_failed: 'Salvataggio non riuscito',
      add_contact: 'Aggiungi contatto ICE',
      remove_contact: 'Rimuovi contatto',
      max_contacts: 'Massimo 5 contatti',
      contact_added: 'Contatto aggiunto',
      contact_removed: 'Contatto rimosso',
      generate_code: 'Genera codice di emergenza',
      code_exists: 'Il tuo codice esiste già',
      code_created: 'Codice generato',
      gen_needs_identity: 'Completa identità (Nome, Data di nascita, Paese)',
      copy_link: 'Copia link condivisibile',
      link_copied: 'Link copiato!',
      link_missing: 'Nessun link – genera prima il codice',
      view_card: 'Vedi tessera di emergenza',
      must_generate_first: 'Genera prima il codice',
      export_png: 'Esporta PNG',
      exported_png: 'QR esportato come PNG',
      print_card: 'Stampa tessera',
      speak_summary: '🔊 Leggi riepilogo medico',
      stop_speaking: '⏹️ Stop',
      speech_started: 'Lettura in corso…',
      speech_stopped: 'Lettura interrotta',
      speech_error: 'Sintesi vocale fallita',
      speech_unsupported: 'Sintesi non supportata',
      delete_account: 'Elimina account',
      delete_confirm: 'Eliminazione definitiva. Continuare?',
      delete_done: 'Account eliminato',
      delete_failed: 'Eliminazione fallita',
      offline_badge: 'FUNZIONA OFFLINE',
      qr_complete_profile: 'Completa il profilo per generare il QR',
      ph_full_name: 'Inserisci nome legale completo',
      ph_dob: 'GG/MM/AAAA',
      ph_health_id: 'ID sanitario, SSN, ecc.',
      ph_allergy: 'Digita allergia e Invio',
      ph_condition: 'Digita condizione e Invio',
      ph_medication: 'Digita farmaco e Invio',
      ph_contact_name: 'Nome completo',
      ph_contact_phone: '+39 333 0000000',
      ph_contact_email: 'contatto@esempio.it',
      ph_contact_notes: 'Informazioni aggiuntive'
    },

    hi: {
      logout: 'लॉगआउट',
      confirm_logout: 'क्या आप वाकई लॉगआउट करना चाहते हैं?',
      saved: 'सहेजा गया',
      save_failed: 'सहेजना असफल',
      add_contact: 'ICE संपर्क जोड़ें',
      remove_contact: 'संपर्क हटाएँ',
      max_contacts: 'अधिकतम 5 संपर्क',
      contact_added: 'संपर्क जोड़ा गया',
      contact_removed: 'संपर्क हटाया गया',
      generate_code: 'इमरजेंसी कोड बनाएं',
      code_exists: 'आपका इमरजेंसी कोड पहले से मौजूद है',
      code_created: 'इमरजेंसी कोड बनाया गया',
      gen_needs_identity: 'पहले पहचान जानकारी भरें (नाम, जन्मतिथि, देश)',
      copy_link: 'शेयरेबल लिंक कॉपी करें',
      link_copied: 'लिंक कॉपी हुआ!',
      link_missing: 'कोई लिंक नहीं — पहले कोड बनाएं',
      view_card: 'इमरजेंसी कार्ड देखें',
      must_generate_first: 'पहले अपना कोड बनाएं',
      export_png: 'PNG निर्यात करें',
      exported_png: 'QR PNG के रूप में निर्यात हुआ',
      print_card: 'कार्ड प्रिंट करें',
      speak_summary: '🔊 मेडिकल सारांश सुनाएँ',
      stop_speaking: '⏹️ रोकें',
      speech_started: 'मेडिकल सारांश चला रहा है…',
      speech_stopped: 'रोक दिया गया',
      speech_error: 'वॉइस सिंथेसिस विफल',
      speech_unsupported: 'ब्राउज़र वॉइस सपोर्ट नहीं करता',
      delete_account: 'खाता हटाएँ',
      delete_confirm: 'खाता और सभी डेटा स्थायी रूप से हट जाएगा। जारी रखें?',
      delete_done: 'खाता हटाया गया',
      delete_failed: 'हटाना विफल',
      offline_badge: 'ऑफ़लाइन काम करता है',
      qr_complete_profile: 'QR बनाने के लिए प्रोफ़ाइल पूरी करें',
      ph_full_name: 'अपना पूरा कानूनी नाम दर्ज करें',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: 'स्वास्थ्य आईडी, SSN, आदि',
      ph_allergy: 'एलर्जी लिखें और एंटर दबाएँ',
      ph_condition: 'बीमारी लिखें और एंटर दबाएँ',
      ph_medication: 'दवा लिखें और एंटर दबाएँ',
      ph_contact_name: 'पूरा नाम',
      ph_contact_phone: '+91 90000 00000',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: 'अतिरिक्त जानकारी'
    },

    ar: {
      logout: 'تسجيل الخروج',
      confirm_logout: 'هل أنت متأكد أنك تريد تسجيل الخروج؟',
      saved: 'تم الحفظ',
      save_failed: 'فشل الحفظ',
      add_contact: 'إضافة جهة اتصال طوارئ',
      remove_contact: 'حذف جهة الاتصال',
      max_contacts: 'الحد الأقصى 5 جهات اتصال',
      contact_added: 'تمت إضافة جهة الاتصال',
      contact_removed: 'تم حذف جهة الاتصال',
      generate_code: 'إنشاء رمز الطوارئ',
      code_exists: 'رمز الطوارئ موجود بالفعل',
      code_created: 'تم إنشاء رمز الطوارئ',
      gen_needs_identity: 'أكمل بيانات الهوية أولًا (الاسم، تاريخ الميلاد، الدولة)',
      copy_link: 'نسخ الرابط القابل للمشاركة',
      link_copied: 'تم نسخ الرابط!',
      link_missing: 'لا يوجد رابط — أنشئ الرمز أولًا',
      view_card: 'عرض بطاقة الطوارئ',
      must_generate_first: 'أنشئ رمزك أولًا',
      export_png: 'تصدير PNG',
      exported_png: 'تم تصدير QR بصيغة PNG',
      print_card: 'طباعة البطاقة',
      speak_summary: '🔊 قراءة الملخص الطبي',
      stop_speaking: '⏹️ إيقاف',
      speech_started: 'جاري قراءة الملخص…',
      speech_stopped: 'تم الإيقاف',
      speech_error: 'فشل تحويل النص إلى كلام',
      speech_unsupported: 'المتصفح لا يدعم ميزة القراءة',
      delete_account: 'حذف الحساب',
      delete_confirm: 'سيتم حذف الحساب وجميع البيانات نهائيًا. متابعة؟',
      delete_done: 'تم حذف الحساب',
      delete_failed: 'فشل الحذف',
      offline_badge: 'يعمل دون إنترنت',
      qr_complete_profile: 'أكمل ملفك لإنشاء QR',
      ph_full_name: 'أدخل اسمك القانوني الكامل',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: 'رقم صحي، SSN، إلخ',
      ph_allergy: 'اكتب الحساسية واضغط Enter',
      ph_condition: 'اكتب الحالة واضغط Enter',
      ph_medication: 'اكتب الدواء واضغط Enter',
      ph_contact_name: 'الاسم الكامل',
      ph_contact_phone: '+966 500000000',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: 'معلومات إضافية'
    },

    zh: {
      logout: '登出',
      confirm_logout: '确定要登出吗？',
      saved: '已保存',
      save_failed: '保存失败',
      add_contact: '添加紧急联系人',
      remove_contact: '删除联系人',
      max_contacts: '最多 5 个联系人',
      contact_added: '已添加联系人',
      contact_removed: '已删除联系人',
      generate_code: '生成紧急代码',
      code_exists: '你的紧急代码已存在',
      code_created: '已生成紧急代码',
      gen_needs_identity: '请先完成身份信息（姓名、生日、国家）',
      copy_link: '复制分享链接',
      link_copied: '已复制链接！',
      link_missing: '没有链接——先生成代码',
      view_card: '查看急救卡',
      must_generate_first: '请先生成紧急代码',
      export_png: '导出 PNG',
      exported_png: '已导出 PNG',
      print_card: '打印急救卡',
      speak_summary: '🔊 播放医疗摘要',
      stop_speaking: '⏹️ 停止',
      speech_started: '正在播放医疗摘要…',
      speech_stopped: '已停止',
      speech_error: '语音合成失败',
      speech_unsupported: '浏览器不支持语音合成',
      delete_account: '删除账户',
      delete_confirm: '此操作将永久删除账户及数据。继续？',
      delete_done: '账户已删除',
      delete_failed: '删除失败',
      offline_badge: '离线可用',
      qr_complete_profile: '完成资料以生成二维码',
      ph_full_name: '输入法定全名',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: '医保号、SSN 等',
      ph_allergy: '输入过敏并回车',
      ph_condition: '输入病症并回车',
      ph_medication: '输入药物并回车',
      ph_contact_name: '联系人姓名',
      ph_contact_phone: '+86 130 0000 0000',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: '补充信息'
    },

    hu: {
      logout: 'Kijelentkezés',
      confirm_logout: 'Biztosan kijelentkezik?',
      saved: 'Mentve',
      save_failed: 'Sikertelen mentés',
      add_contact: 'ICE kapcsolat hozzáadása',
      remove_contact: 'Kapcsolat törlése',
      max_contacts: 'Legfeljebb 5 kapcsolat',
      contact_added: 'Kapcsolat hozzáadva',
      contact_removed: 'Kapcsolat törölve',
      generate_code: 'Vészhelyzeti kód létrehozása',
      code_exists: 'Már van vészhelyzeti kódod',
      code_created: 'Kód létrehozva',
      gen_needs_identity: 'Előbb töltsd ki az azonosítást (Név, Születési dátum, Ország)',
      copy_link: 'Megosztható hivatkozás másolása',
      link_copied: 'Hivatkozás másolva!',
      link_missing: 'Nincs hivatkozás – előbb generálj kódot',
      view_card: 'Vészhelyzeti kártya megnyitása',
      must_generate_first: 'Előbb generáld a kódot',
      export_png: 'PNG exportálása',
      exported_png: 'QR PNG-ként exportálva',
      print_card: 'Kártya nyomtatása',
      speak_summary: '🔊 Orvosi összegzés felolvasása',
      stop_speaking: '⏹️ Leállítás',
      speech_started: 'Összegzés felolvasása…',
      speech_stopped: 'Leállítva',
      speech_error: 'Beszédszintézis hiba',
      speech_unsupported: 'A böngésző nem támogatja',
      delete_account: 'Fiók törlése',
      delete_confirm: 'A fiók és adatok végleg törlődnek. Folytatja?',
      delete_done: 'Fiók törölve',
      delete_failed: 'Törlés sikertelen',
      offline_badge: 'OFFLINE IS MŰKÖDIK',
      qr_complete_profile: 'Töltsd ki a profilt a QR-hez',
      ph_full_name: 'Írd be a teljes nevet',
      ph_dob: 'NN/HH/ÉÉÉÉ',
      ph_health_id: 'Egészségügyi azonosító, SSN stb.',
      ph_allergy: 'Írj be allergiát és Enter',
      ph_condition: 'Írj be betegséget és Enter',
      ph_medication: 'Írj be gyógyszert és Enter',
      ph_contact_name: 'Teljes név',
      ph_contact_phone: '+36 30 000 0000',
      ph_contact_email: 'kapcsolat@pelda.hu',
      ph_contact_notes: 'Kiegészítő információ'
    },

    ro: {
      logout: 'Deconectare',
      confirm_logout: 'Sigur vrei să te deconectezi?',
      saved: 'Salvat',
      save_failed: 'Salvare eșuată',
      add_contact: 'Adaugă contact ICE',
      remove_contact: 'Șterge contact',
      max_contacts: 'Maximum 5 contacte',
      contact_added: 'Contact adăugat',
      contact_removed: 'Contact șters',
      generate_code: 'Generează cod de urgență',
      code_exists: 'Codul tău există deja',
      code_created: 'Cod generat',
      gen_needs_identity: 'Completează identitatea (Nume, Data nașterii, Țara)',
      copy_link: 'Copiază linkul',
      link_copied: 'Link copiat!',
      link_missing: 'Nu există link — generează codul',
      view_card: 'Vezi cardul de urgență',
      must_generate_first: 'Generează codul mai întâi',
      export_png: 'Export PNG',
      exported_png: 'QR exportat ca PNG',
      print_card: 'Printează cardul',
      speak_summary: '🔊 Redă sumarul medical',
      stop_speaking: '⏹️ Oprire',
      speech_started: 'Redare sumar medical…',
      speech_stopped: 'Redare oprită',
      speech_error: 'Eroare sinteză vocală',
      speech_unsupported: 'Browserul nu suportă sinteza vocală',
      delete_account: 'Șterge contul',
      delete_confirm: 'Contul și datele vor fi șterse definitiv. Continui?',
      delete_done: 'Cont șters',
      delete_failed: 'Ștergere eșuată',
      offline_badge: 'FUNCȚIONEAZĂ OFFLINE',
      qr_complete_profile: 'Completează profilul pentru a genera QR',
      ph_full_name: 'Introdu numele legal complet',
      ph_dob: 'ZZ/LL/AAAA',
      ph_health_id: 'ID sănătate, CNP etc.',
      ph_allergy: 'Tastează alergia și Enter',
      ph_condition: 'Tastează afecțiunea și Enter',
      ph_medication: 'Tastează medicația și Enter',
      ph_contact_name: 'Nume complet',
      ph_contact_phone: '+40 700 000 000',
      ph_contact_email: 'contact@exemplu.ro',
      ph_contact_notes: 'Informații suplimentare'
    }
  };

  // Helper: keep SVG, replace text in buttons safely
  function setBtnLabel(btn, text) {
    if (!btn) return;
    const svg = btn.querySelector('svg');
    btn.innerHTML = '';
    if (svg) btn.appendChild(svg);
    btn.appendChild(document.createTextNode(' ' + text));
  }

  function applyPlaceholders(lang) {
    const t = i18n[lang] || i18n.en;
    const setPH = (id, key) => {
      const el = $(id);
      if (el && t[key]) el.placeholder = t[key];
    };
    setPH('fullName', 'ph_full_name');
    setPH('dateOfBirth', 'ph_dob');
    setPH('nationalHealthId', 'ph_health_id');
    setPH('allergiesInput', 'ph_allergy');
    setPH('conditionsInput', 'ph_condition');
    setPH('medicationsInput', 'ph_medication');

    // ICE inputs are dynamic; when created we set PH from current lang (see createIceRow)
  }

  function applyButtonsText(lang) {
    const t = i18n[lang] || i18n.en;
    setBtnLabel($('logoutBtn'), t.logout);
    setBtnLabel($('generateCodeBtn'), t.generate_code);
    setBtnLabel($('viewCardBtn'), t.view_card);
    setBtnLabel($('exportPngBtn'), t.export_png);
    setBtnLabel($('printCardBtn'), t.print_card);
    setBtnLabel($('speakSummaryBtn'), t.speak_summary);
    setBtnLabel($('stopSpeakingBtn'), t.stop_speaking);
    setBtnLabel($('copyLinkBtn'), '📋 ' + t.copy_link);

    const addBtn = $('addIceContact');
    if (addBtn) {
      const svg = addBtn.querySelector('svg');
      addBtn.innerHTML = '';
      if (svg) addBtn.appendChild(svg);
      addBtn.appendChild(document.createTextNode(' ' + t.add_contact));
    }

    const offline = document.querySelector('.offline-badge');
    if (offline && t.offline_badge) offline.textContent = t.offline_badge;

    const qrPh = $('qrPlaceholder');
    if (qrPh && t.qr_complete_profile) {
      // Keep the SVG in placeholder
      const svg = qrPh.querySelector('svg');
      qrPh.innerHTML = '';
      if (svg) qrPh.appendChild(svg);
      const div = document.createElement('div');
      div.textContent = t.qr_complete_profile;
      qrPh.appendChild(div);
    }
  }

  function setLanguage(lang) {
    const code = i18n[lang] ? lang : 'en';
    localStorage.setItem(LANG_KEY, code);
    applyButtonsText(code);
    applyPlaceholders(code);
  }

  if (languageSelect) {
    const savedLang = localStorage.getItem(LANG_KEY) || languageSelect.value || 'en';
    languageSelect.value = savedLang;
    setLanguage(savedLang);
    languageSelect.addEventListener('change', () => {
      setLanguage(languageSelect.value);
    });
  }

  /* ---------- Session, Auth, Logout ---------- */
  let currentUser = null;
  let currentProfile = null;

  async function requireSession() {
    const { data, error } = await sb.auth.getSession();
    if (error || !data.session) {
      location.replace('index.html');
      return null;
    }
    currentUser = data.session.user;
    return currentUser;
  }

  async function signOut() {
    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (!confirm(t.confirm_logout)) return;
    await sb.auth.signOut().catch(() => {});
    location.replace('index.html');
  }

  if ($('logoutBtn')) $('logoutBtn').addEventListener('click', signOut);

  sb.auth.onAuthStateChange((event, session) => {
    if (!session) {
      location.replace('index.html');
    }
  });

  /* ---------- Profile & Health Autosave ---------- */
  const pillData = (MYQER.pillData = MYQER.pillData || {
    allergies: [],
    conditions: [],
    medications: []
  });

  // Read pills from DOM (in case loaded earlier)
  function readPillsFromDOM() {
    ['allergies', 'conditions', 'medications'].forEach((type) => {
      const wrap = $(`${type}Pills`);
      if (!wrap) return;
      const pills = Array.from(wrap.querySelectorAll('.pill')).map((p) =>
        p.childNodes[0]?.nodeValue?.trim() || ''
      );
      pillData[type] = pills.filter(Boolean);
    });
  }

  async function saveProfile() {
    if (!currentUser) return;
    const full_name = $('fullName')?.value?.trim() || null;
    const date_of_birth = $('dateOfBirth')?.value?.trim() || null;
    const country = $('country')?.value || null;
    const national_health_id = $('nationalHealthId')?.value?.trim() || null;

    const { error } = await sb
      .from('profiles')
      .upsert({
        id: currentUser.id,
        email: currentUser.email,
        full_name,
        date_of_birth,
        country,
        national_health_id,
        code: currentProfile?.code || null
      });

    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (error) {
      console.error(error);
      showToast(t.save_failed, 'error');
    } else {
      showToast(t.saved, 'success');
    }
  }

  const debouncedSaveProfile = debounce(saveProfile, 600);

  async function saveHealthProfile() {
    if (!currentUser) return;
    readPillsFromDOM();
    const blood_type = $('bloodType')?.value || null;
    const organDonorEl = $('organDonor');
    let organ_donor = null;
    if (organDonorEl && organDonorEl.value !== '') {
      organ_donor = organDonorEl.value === 'true';
    }
    const life_support_pref = $('lifeSupportPref')?.value || 'Full';

    // store pills as comma-separated strings
    const allergies = pillData.allergies.join(', ');
    const conditions = pillData.conditions.join(', ');
    const medications = pillData.medications.join(', ');

    // Upsert with user_id as PK or unique
    const { error } = await sb
      .from('health_profiles')
      .upsert({
        user_id: currentUser.id,
        blood_type,
        organ_donor,
        life_support_pref,
        allergies,
        conditions,
        medications
      });

    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (error) {
      console.error(error);
      showToast(t.save_failed, 'error');
    } else {
      showToast(t.saved, 'success');
    }
  }

  const debouncedSaveHealth = debounce(saveHealthProfile, 600);

  // Bind autosave fields
  [
    'fullName',
    'dateOfBirth',
    'country',
    'nationalHealthId',
    'bloodType',
    'organDonor',
    'lifeSupportPref'
  ].forEach((id) => {
    const el = $(id);
    if (!el) return;
    el.addEventListener('input', () => {
      debouncedSaveProfile();
      debouncedSaveHealth();
      updateProfileProgress();
    });
    el.addEventListener('change', () => {
      debouncedSaveProfile();
      debouncedSaveHealth();
      updateProfileProgress();
    });
  });

  // Enter-to-pill handlers
  [
    ['allergiesInput', 'allergies', 'ph_allergy'],
    ['conditionsInput', 'conditions', 'ph_condition'],
    ['medicationsInput', 'medications', 'ph_medication']
  ].forEach(([inputId, type]) => {
    const input = $(inputId);
    if (!input) return;
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim()) {
        e.preventDefault();
        addPill(type, input.value.trim());
        input.value = '';
        debouncedSaveHealth();
      }
    });
  });

  function renderPills(type) {
    const wrap = $(`${type}Pills`);
    if (!wrap) return;
    wrap.innerHTML = pillData[type]
      .map(
        (txt, i) => `
      <div class="pill">
        ${escapeHtml(txt)}
        <span class="pill-remove" data-type="${type}" data-index="${i}">×</span>
      </div>`
      )
      .join('');
    // Attach remove handlers
    wrap.querySelectorAll('.pill-remove').forEach((x) =>
      x.addEventListener('click', () => {
        const t = x.getAttribute('data-type');
        const idx = +x.getAttribute('data-index');
        pillData[t].splice(idx, 1);
        renderPills(t);
        debouncedSaveHealth();
        updateTriageStatus();
        updateProfileProgress();
        showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).saved, 'success');
      })
    );
  }

  function addPill(type, value) {
    if (!value) return;
    if (!pillData[type]) pillData[type] = [];
    if (pillData[type].includes(value)) return;
    pillData[type].push(value);
    renderPills(type);
    updateTriageStatus();
    updateProfileProgress();
  }

  // Escape HTML for pills
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
  }

  /* ---------- ICE Contacts CRUD ---------- */
  const MAX_CONTACTS = 5;
  let iceLoaded = false;

  function makeContactTemplate(contact = {}) {
    const lang = localStorage.getItem(LANG_KEY) || 'en';
    const t = i18n[lang] || i18n.en;
    return `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="form-label">Full Name *</label>
          <input type="text" class="form-input contact-name" placeholder="${t.ph_contact_name}" value="${contact.name ? escapeHtml(contact.name) : ''}">
        </div>
        <div>
          <label class="form-label">Relationship</label>
          <select class="form-select contact-relation">
            ${[
              '',
              'Spouse',
              'Partner',
              'Parent',
              'Child',
              'Sibling',
              'Friend',
              'Colleague',
              'Doctor',
              'Lawyer',
              'Other'
            ]
              .map(
                (opt) =>
                  `<option value="${opt}" ${contact.relationship === opt ? 'selected' : ''}>${opt || 'Select relationship'}</option>`
              )
              .join('')}
          </select>
        </div>
        <div>
          <label class="form-label">Phone Number *</label>
          <input type="tel" class="form-input contact-phone" placeholder="${t.ph_contact_phone}" value="${contact.phone ? escapeHtml(contact.phone) : ''}">
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="form-label">Email (Optional)</label>
          <input type="email" class="form-input contact-email" placeholder="${t.ph_contact_email}" value="${contact.email ? escapeHtml(contact.email) : ''}">
        </div>
        <div>
          <label class="form-label">Notes (Optional)</label>
          <input type="text" class="form-input contact-notes" placeholder="${t.ph_contact_notes}" value="${contact.notes ? escapeHtml(contact.notes) : ''}">
        </div>
      </div>
      <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
        <button class="text-red-600 text-sm hover:text-red-800 font-medium btn-remove-contact">
          <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          ${(i18n[lang] || i18n.en).remove_contact}
        </button>
        <div class="text-xs text-gray-500">Auto-saves on change</div>
      </div>
    `;
  }

  function updateContactCountUI() {
    const list = $('iceContacts');
    const cnt = list ? list.querySelectorAll('.ice-contact-card').length : 0;
    if ($('contactCount')) $('contactCount').textContent = cnt;
    const addBtn = $('addIceContact');
    const lang = localStorage.getItem(LANG_KEY) || 'en';
    const t = i18n[lang] || i18n.en;
    if (addBtn) {
      addBtn.disabled = cnt >= MAX_CONTACTS;
      const svg = addBtn.querySelector('svg');
      if (cnt >= MAX_CONTACTS) {
        addBtn.innerHTML = '';
        if (svg) addBtn.appendChild(svg);
        addBtn.appendChild(document.createTextNode(' ' + t.max_contacts));
      } else {
        addBtn.innerHTML = '';
        if (svg) addBtn.appendChild(svg);
        addBtn.appendChild(document.createTextNode(' ' + t.add_contact));
      }
    }
  }

  function bindIceRowEvents(card, idOrNull) {
    const inputs = card.querySelectorAll('input,select');
    inputs.forEach((el) => {
      el.addEventListener(
        'change',
        debounce(async () => {
          await saveSingleContact(card, idOrNull);
        }, 400)
      );
      el.addEventListener(
        'blur',
        debounce(async () => {
          await saveSingleContact(card, idOrNull);
        }, 400)
      );
    });

    const rm = card.querySelector('.btn-remove-contact');
    if (rm) {
      rm.addEventListener('click', async () => {
        if (!idOrNull) {
          // Unsaved row: just remove
          card.remove();
          updateContactCountUI();
          showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).contact_removed, 'success');
          return;
        }
        await sb.from('ice_contacts').delete().eq('id', idOrNull).eq('user_id', currentUser.id);
        card.remove();
        updateContactCountUI();
        updateProfileProgress();
        showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).contact_removed, 'success');
      });
    }
  }

  async function saveSingleContact(card, idOrNull) {
    const name = card.querySelector('.contact-name')?.value?.trim() || '';
    const relation = card.querySelector('.contact-relation')?.value || '';
    const phone = card.querySelector('.contact-phone')?.value?.trim() || '';
    const email = card.querySelector('.contact-email')?.value?.trim() || '';
    const notes = card.querySelector('.contact-notes')?.value?.trim() || '';

    // Require minimal fields
    if (!name || !phone) return;

    if (!idOrNull) {
      const { data, error } = await sb
        .from('ice_contacts')
        .insert([{ user_id: currentUser.id, name, relationship: relation, phone, email, notes }])
        .select()
        .single();
      if (!error && data) {
        // mark DOM with new id
        card.dataset.contactId = data.id;
        bindIceRowEvents(card, data.id); // re-bind with id
        updateContactCountUI();
        updateProfileProgress();
        showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).saved, 'success');
      }
      return;
    }

    const { error } = await sb
      .from('ice_contacts')
      .update({ name, relationship: relation, phone, email, notes })
      .eq('id', idOrNull)
      .eq('user_id', currentUser.id);

    if (error) {
      console.error(error);
      showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).save_failed, 'error');
    } else {
      showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).saved, 'success');
    }
  }

  function createIceRow(contact) {
    const list = $('iceContacts');
    if (!list) return null;
    const div = document.createElement('div');
    div.className = 'ice-contact-card';
    div.innerHTML = makeContactTemplate(contact);
    if (contact.id) div.dataset.contactId = contact.id;
    list.appendChild(div);
    bindIceRowEvents(div, contact.id || null);
    return div;
  }

  async function loadIceContacts() {
    if (!currentUser || iceLoaded) return;
    const { data, error } = await sb.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at');
    if (error) {
      console.error(error);
      return;
    }
    (data || []).forEach((c) => createIceRow(c));
    iceLoaded = true;
    updateContactCountUI();
    updateProfileProgress();
  }

  if ($('addIceContact')) {
    $('addIceContact').addEventListener('click', () => {
      const list = $('iceContacts');
      const countNow = list ? list.querySelectorAll('.ice-contact-card').length : 0;
      const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
      if (countNow >= MAX_CONTACTS) {
        showToast(t.max_contacts, 'warning');
        return;
      }
      createIceRow({});
      updateContactCountUI();
      showToast(t.contact_added, 'success');
    });
  }

  /* ---------- QR: Single, Persistent ---------- */
  async function ensureSingleCode() {
    // If already present in memory, do nothing
    if (currentProfile && currentProfile.code) return currentProfile.code;

      // Load from DB
    const { data, error } = await sb.from('profiles').select('code').eq('id', currentUser.id).single();
    if (!error && data && data.code) {
      currentProfile = { ...(currentProfile || {}), code: data.code };
      updateCardLink(data.code);
      generateQRCode();
      updateProfileProgress();
      return data.code;
    }
    return null;
  }

  function updateCardLink(code) {
    const link = `${ORIGIN}/c/${code}`;
    const linkBox = $('cardLink');
    if (linkBox) linkBox.value = link;
  }

  function generateQRCode() {
    const canvas = $('qrCanvas');
    const placeholder = $('qrPlaceholder');
    if (!currentProfile?.code || !canvas) return;
    const cardUrl = `${ORIGIN}/c/${currentProfile.code}`;
    window.QRCode.toCanvas(
      canvas,
      cardUrl,
      {
        width: 160,
        height: 160,
        margin: 3,
        color: { dark: '#000000', light: '#FFFFFF' },
        errorCorrectionLevel: 'M'
      },
      (err) => {
        if (err) {
          console.error(err);
          if (placeholder) {
            placeholder.style.display = 'block';
            canvas.style.display = 'none';
          }
        } else {
          if (placeholder) placeholder.style.display = 'none';
          canvas.style.display = 'block';
        }
      }
    );
  }

  function randomCode(n = 6) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let out = '';
    for (let i = 0; i < n; i++) out += chars[Math.floor(Math.random() * chars.length)];
    return out;
  }

  async function generateEmergencyCodeOnce() {
    const lang = localStorage.getItem(LANG_KEY) || 'en';
    const t = i18n[lang] || i18n.en;

    // Identity must be complete
    if (!checkIdentityComplete()) {
      showToast(t.gen_needs_identity, 'warning');
      return;
    }

    // Enforce one per user
    const existing = await ensureSingleCode();
    if (existing) {
      showToast(t.code_exists, 'info');
      return;
    }

    // Generate & ensure global uniqueness (simple retry)
    let code = randomCode(6);
    for (let tries = 0; tries < 5; tries++) {
      const { data: found, error: e } = await sb.from('profiles').select('id').eq('code', code).maybeSingle?.() ?? {};
      if (!e && !found) break;
      code = randomCode(6);
    }

    const { error } = await sb
      .from('profiles')
      .upsert({
        id: currentUser.id,
        email: currentUser.email,
        full_name: $('fullName')?.value?.trim() || null,
        date_of_birth: $('dateOfBirth')?.value?.trim() || null,
        country: $('country')?.value || null,
        national_health_id: $('nationalHealthId')?.value?.trim() || null,
        code
      })
      .select()
      .single();

    if (error) {
      console.error(error);
      showToast(t.save_failed, 'error');
      return;
    }

    currentProfile = { ...(currentProfile || {}), code };
    updateCardLink(code);
    generateQRCode();
    updateProfileProgress();
    showToast(t.code_created, 'success');
  }

  if ($('generateCodeBtn')) $('generateCodeBtn').addEventListener('click', generateEmergencyCodeOnce);

  // Share link / copy
  if ($('copyLinkBtn')) {
    $('copyLinkBtn').addEventListener('click', async () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      const box = $('cardLink');
      if (!box?.value) {
        showToast(t.link_missing, 'warning');
        return;
      }
      try {
        await navigator.clipboard.writeText(box.value);
        showToast(t.link_copied, 'success');
      } catch {
        showToast(t.save_failed, 'error');
      }
    });
  }

  if ($('viewCardBtn')) {
    $('viewCardBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (!currentProfile?.code) {
        showToast(t.must_generate_first, 'warning');
        return;
      }
      const cardUrl = `${ORIGIN}/c/${currentProfile.code}`;
      window.open(cardUrl, '_blank');
    });
  }

  if ($('exportPngBtn')) {
    $('exportPngBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      const canvas = $('qrCanvas');
      if (!currentProfile?.code || !canvas || canvas.style.display === 'none') {
        showToast(t.must_generate_first, 'warning');
        return;
      }
      const link = document.createElement('a');
      link.download = `MYQER-${currentProfile.code}-QR.png`;
      link.href = canvas.toDataURL();
      link.click();
      showToast(t.exported_png, 'success');
    });
  }

  if ($('printCardBtn')) {
    $('printCardBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (!currentProfile?.code) {
        showToast(t.must_generate_first, 'warning');
        return;
      }
      const cardUrl = `${ORIGIN}/c/${currentProfile.code}?print=true`;
      window.open(cardUrl, '_blank');
    });
  }

  /* ---------- Triage + Progress ---------- */
  function updateCheckIndicator(elementId, isComplete) {
    const element = $(elementId);
    if (!element) return;
    const circle = element.querySelector('div');
    const text = element.querySelector('span');
    if (isComplete) {
      if (circle) circle.className = 'w-4 h-4 rounded-full bg-green-500';
      if (text) text.className = 'text-green-700 font-medium';
    } else {
      if (circle) circle.className = 'w-4 h-4 rounded-full bg-gray-300';
      if (text) text.className = 'text-gray-600';
    }
  }

  function checkIdentityComplete() {
    const fullName = $('fullName')?.value?.trim();
    const dateOfBirth = $('dateOfBirth')?.value?.trim();
    const country = $('country')?.value;
    return !!(fullName && dateOfBirth && country);
  }

  function checkHealthComplete() {
    const bloodType = $('bloodType')?.value;
    const hasAllergies = (window.MYQER?.pillData?.allergies || []).length > 0;
    const hasConditions = (window.MYQER?.pillData?.conditions || []).length > 0;
    return !!(bloodType || hasAllergies || hasConditions);
  }

  function updateProfileProgress() {
    const checks = {
      identity: checkIdentityComplete(),
      health: checkHealthComplete(),
      contacts: ($('iceContacts')?.querySelectorAll('.ice-contact-card').length || 0) > 0,
      code: !!(currentProfile && currentProfile.code)
    };

    const completedCount = Object.values(checks).filter(Boolean).length;
    const percentage = Math.round((completedCount / 4) * 100);

    const progressCircle = $('progressCircle');
    const progressPercent = $('progressPercent');

    if (progressCircle && progressPercent) {
      const circumference = 2 * Math.PI * 28;
      const strokeDasharray = (percentage / 100) * circumference;
      progressCircle.style.strokeDasharray = `${strokeDasharray} ${circumference}`;
      progressPercent.textContent = `${percentage}%`;
    }

    updateCheckIndicator('checkIdentity', checks.identity);
    updateCheckIndicator('checkHealth', checks.health);
    updateCheckIndicator('checkContacts', checks.contacts);
    updateCheckIndicator('checkCode', checks.code);

    // Auto render QR if fully complete & code exists
    if (percentage === 100 && currentProfile?.code) {
      generateQRCode();
    }
  }

  function updateTriageStatus() {
    const statusElement = $('triageStatus');
    const overrideSel = $('triageOverride');
    if (!statusElement || !overrideSel) return;

    const override = overrideSel.value;

    if (override) {
      const map = {
        Green: { class: 'triage-green', text: 'GREEN - Standard Priority' },
        Amber: { class: 'triage-amber', text: 'AMBER - Urgent Priority' },
        Red: { class: 'triage-red', text: 'RED - Immediate Priority' },
        Black: { class: 'triage-black', text: 'BLACK - Comfort Care' }
      };
      const s = map[override] || map.Green;
      statusElement.className = `triage-status ${s.class}`;
      statusElement.textContent = s.text;
      return;
    }

    // Auto
    const pillData = window.MYQER?.pillData || { allergies: [], conditions: [], medications: [] };
    const lifeSupportPref = $('lifeSupportPref')?.value;
    const criticalAllergies = [
      'penicillin','morphine','codeine','fentanyl','midazolam','propofol',
      'aspirin','ibuprofen','latex','shellfish','nuts','peanuts'
    ];
    const hasCriticalAllergy = pillData.allergies.some((a) =>
      criticalAllergies.some((c) => a.toLowerCase().includes(c))
    );
    const highRiskConditions = [
      'diabetes','heart','cardiac','stroke','seizure','epilepsy',
      'asthma','copd','kidney','liver','cancer'
    ];
    const hasHighRisk = pillData.conditions.some((c) =>
      highRiskConditions.some((r) => c.toLowerCase().includes(r))
    );

    let label = 'GREEN - Standard (Auto)';
    let cls = 'triage-green';
    if (lifeSupportPref === 'DNR') {
      label = 'BLACK - Comfort (Auto)';
      cls = 'triage-black';
    } else if (hasCriticalAllergy || hasHighRisk || pillData.conditions.length > 3) {
      label = 'RED - Immediate (Auto)';
      cls = 'triage-red';
    } else if (pillData.allergies.length > 0 || pillData.conditions.length > 0 || pillData.medications.length > 2) {
      label = 'AMBER - Urgent (Auto)';
      cls = 'triage-amber';
    }
    statusElement.className = `triage-status ${cls}`;
    statusElement.textContent = label;
  }

  if ($('triageOverride')) $('triageOverride').addEventListener('change', updateTriageStatus);

  // Speech
  let currentSpeech = null;
  if ($('speakSummaryBtn')) {
    $('speakSummaryBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (currentSpeech) speechSynthesis.cancel();

      const fullName = $('fullName')?.value || 'Unknown patient';
      const bloodType = $('bloodType')?.value || 'Unknown blood type';
      const pd = window.MYQER?.pillData || { allergies: [], conditions: [], medications: [] };
      const allergies = pd.allergies.length ? pd.allergies.join(', ') : 'No known allergies';
      const conditions = pd.conditions.length ? pd.conditions.join(', ') : 'No known medical conditions';
      const medications = pd.medications.length ? pd.medications.join(', ') : 'No current medications';
      const lifeSupportPref = $('lifeSupportPref')?.value || 'Full life support';

      const summary = `Emergency medical summary for ${fullName}. Blood type: ${bloodType}. Allergies: ${allergies}. Medical conditions: ${conditions}. Current medications: ${medications}. Life support preference: ${lifeSupportPref}.`;

      if ('speechSynthesis' in window) {
        currentSpeech = new SpeechSynthesisUtterance(summary);
        currentSpeech.lang = 'en-US';
        currentSpeech.rate = 0.9;
        currentSpeech.pitch = 1.0;
        currentSpeech.volume = 1.0;

        currentSpeech.onstart = () => {
          $('speakSummaryBtn').style.display = 'none';
          $('stopSpeakingBtn').style.display = 'block';
        };
        currentSpeech.onend = () => {
          $('speakSummaryBtn').style.display = 'block';
          $('stopSpeakingBtn').style.display = 'none';
          currentSpeech = null;
        };
        currentSpeech.onerror = () => {
          $('speakSummaryBtn').style.display = 'block';
          $('stopSpeakingBtn').style.display = 'none';
          currentSpeech = null;
          showToast(t.speech_error, 'error');
        };

        speechSynthesis.speak(currentSpeech);
        showToast(t.speech_started, 'info');
      } else {
        showToast(t.speech_unsupported, 'error');
      }
    });
  }

  if ($('stopSpeakingBtn')) {
    $('stopSpeakingBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (currentSpeech) {
        speechSynthesis.cancel();
        $('speakSummaryBtn').style.display = 'block';
        $('stopSpeakingBtn').style.display = 'none';
        currentSpeech = null;
        showToast(t.speech_stopped, 'info');
      }
    });
  }

  /* ---------- Delete Account (cascade) ---------- */
  if ($('deleteAccountBtn')) {
    $('deleteAccountBtn').addEventListener('click', async () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (!confirm(t.delete_confirm)) return;

      try {
        await sb.from('ice_contacts').delete().eq('user_id', currentUser.id);
        await sb.from('health_profiles').delete().eq('user_id', currentUser.id);
        // Optional: if you track scans
        // await sb.from('scan_logs').delete().eq('user_id', currentUser.id);
        await sb.from('profiles').delete().eq('id', currentUser.id);

        await sb.auth.signOut();
        showToast(t.delete_done, 'success');
        setTimeout(() => location.replace('index.html'), 700);
      } catch (e) {
        console.error(e);
        showToast(t.delete_failed, 'error');
      }
    });
  }

  /* ---------- Load initial data & boot ---------- */
  async function loadProfileAndHealth() {
    const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).maybeSingle?.() ?? {};
    if (profile) {
      currentProfile = profile;
      if ($('fullName')) $('fullName').value = profile.full_name || '';
      if ($('dateOfBirth')) $('dateOfBirth').value = profile.date_of_birth || '';
      if ($('country')) $('country').value = profile.country || '';
      if ($('nationalHealthId')) $('nationalHealthId').value = profile.national_health_id || '';
      if (profile.code) {
        updateCardLink(profile.code);
        generateQRCode();
      }
    }

    const { data: health } = await sb.from('health_profiles').select('*').eq('user_id', currentUser.id).maybeSingle?.() ?? {};
    if (health) {
      if ($('bloodType')) $('bloodType').value = health.blood_type || '';
      if ($('organDonor')) $('organDonor').value = health.organ_donor === null ? '' : String(!!health.organ_donor);
      if ($('lifeSupportPref')) $('lifeSupportPref').value = health.life_support_pref || 'Full';

      const pd = (window.MYQER.pillData = window.MYQER.pillData || { allergies: [], conditions: [], medications: [] });
      pd.allergies = (health.allergies || '').split(',').map((s) => s.trim()).filter(Boolean);
      pd.conditions = (health.conditions || '').split(',').map((s) => s.trim()).filter(Boolean);
      pd.medications = (health.medications || '').split(',').map((s) => s.trim()).filter(Boolean);

      renderPills('allergies');
      renderPills('conditions');
      renderPills('medications');
    }

    updateTriageStatus();
  }

  function bindLanguageOnBoot() {
    const lang = localStorage.getItem(LANG_KEY) || ($('languageSelect') ? $('languageSelect').value : 'en') || 'en';
    setLanguage(lang);
  }

  // Session gate + boot
  async function requireSession() {
    const { data, error } = await sb.auth.getSession();
    if (error || !data.session) {
      location.replace('index.html');
      return null;
    }
    currentUser = data.session.user;
    return currentUser;
  }

  // Logout
  async function signOut() {
    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (!confirm(t.confirm_logout)) return;
    await sb.auth.signOut().catch(() => {});
    location.replace('index.html');
  }
  if ($('logoutBtn')) $('logoutBtn').addEventListener('click', signOut);

  // Auth change guard
  sb.auth.onAuthStateChange((event, session) => {
    if (!session) location.replace('index.html');
  });

  document.addEventListener('DOMContentLoaded', async () => {
    const user = await requireSession();
    if (!user) return;

    bindLanguageOnBoot();
    await loadProfileAndHealth();
    await loadIceContacts();
    await ensureSingleCode();
    updateProfileProgress();
  });
})();
  
