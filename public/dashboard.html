<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MYQER‚Ñ¢ ‚Äì Emergency Dashboard</title>

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','system-ui','-apple-system','Segoe UI','sans-serif'] },
          colors: {
            brand: '#0f172a',
            identity: '#16a34a',
            critical: '#dc2626',
            triage: '#64748b',
            ice: '#ea580c',
            vault: '#7c3aed',
            qr: '#f59e0b'
          },
          boxShadow: {
            glass: '0 20px 50px rgba(16,24,40,.08), 0 8px 16px rgba(16,24,40,.04)'
          }
        }
      }
    }
  </script>

  <style>
    :root{--ring:rgba(220,38,38,.15)}
    *{font-family:Inter,system-ui,-apple-system,Segoe UI,sans-serif}
    body{background:linear-gradient(135deg,#f8fafc,#eef2f7)}
    .card{background:rgba(255,255,255,.92);backdrop-filter:blur(18px);border:1px solid rgba(148,163,184,.25);border-radius:24px;box-shadow:var(--glass,0 20px 50px rgba(16,24,40,.08));padding:28px}
    .ribbon{height:6px;border-radius:20px 20px 0 0;margin:-28px -28px 20px}
    .r-identity{background:#16a34a}.r-critical{background:#dc2626}.r-ice{background:#ea580c}.r-triage{background:#64748b}.r-vault{background:#7c3aed}.r-qr{background:#f59e0b}.r-danger{background:#dc2626}
    .label{font-size:.8rem;font-weight:800;letter-spacing:.06em;color:#475569;text-transform:uppercase;margin-bottom:.4rem}
    .input{border:1.5px solid #e2e8f0;border-radius:.6rem;padding:.7rem .85rem;background:#fff;transition:box-shadow .2s,border-color .2s;width:100%}
    .input:focus{outline:none;border-color:#dc2626;box-shadow:0 0 0 3px var(--ring)}
    .btn{border-radius:.65rem;padding:.7rem 1rem;font-weight:700;transition:transform .15s,box-shadow .15s}
    .btn-primary{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;box-shadow:0 6px 16px rgba(220,38,38,.28)}
    .btn-primary:hover{transform:translateY(-1px)}
    .btn-muted{background:#fff;border:1.5px solid #e2e8f0;color:#334155}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
    .pill{display:inline-block;border-radius:9999px;padding:.35rem .9rem;font-weight:800;border:2px solid}
    .pill-green{background:#ecfdf5;border-color:#10b981;color:#047857}
    .pill-amber{background:#fffbeb;border-color:#f59e0b;color:#b45309}
    .pill-red{background:#fef2f2;border-color:#ef4444;color:#b91c1c}
    .pill-black{background:#f3f4f6;border-color:#111827;color:#111827}
    .qr-wrap{width:216px;height:216px;border-radius:1rem;border:2px solid #e5e7eb;background:#fff;display:grid;place-items:center;box-shadow:0 0 0 2px #f59e0b22,0 12px 24px rgba(0,0,0,.06)}
    .qr-placeholder{width:184px;height:184px;border:2px dashed #cbd5e1;border-radius:.75rem;display:grid;place-items:center;color:#64748b}
    .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:12px;color:#fff;font-weight:700;transform:translateX(120%);transition:transform .3s;z-index:1000}
    .toast.show{transform:translateX(0)}.t-ok{background:linear-gradient(135deg,#16a34a,#15803d)}.t-warn{background:linear-gradient(135deg,#f59e0b,#d97706)}.t-err{background:linear-gradient(135deg,#ef4444,#b91c1c)}
    .toggle{width:46px;height:26px;border-radius:9999px;position:relative;background:#cbd5e1;cursor:pointer}
    .toggle.active{background:#22c55e}.toggle::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:9999px;transition:transform .2s}.toggle.active::after{transform:translateX(20px)}
    .print-card{max-width:380px;margin:0 auto;border:3px solid #dc2626;border-radius:16px;padding:26px;text-align:center}
    @media print{body *{visibility:hidden}.print-card,.print-card *{visibility:visible}.print-card{position:absolute;inset:0;margin:auto}}
  </style>
</head>
<body class="min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-5 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="text-2xl font-extrabold text-slate-900 tracking-tight">
          MYQ<span class="text-red-600">ER</span><span class="text-xs align-top text-slate-400 font-black">‚Ñ¢</span>
        </div>
        <div class="text-slate-700 font-semibold">Emergency Dashboard</div>
        <div class="text-slate-500 text-sm">pronounced: ‚Äú<em>my care</em>‚Äù</div>
      </div>

      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <span class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow" id="statusDot"></span>
          <span class="text-sm text-slate-600" id="statusText">Online</span>
        </div>

        <select id="languageSelect" class="input text-sm !py-1.5 !px-2 w-auto">
          <option value="en">üá∫üá∏ English</option>
          <option value="es">üá™üá∏ Espa√±ol</option>
          <option value="fr">üá´üá∑ Fran√ßais</option>
          <option value="de">üá©üá™ Deutsch</option>
          <option value="it">üáÆüáπ Italiano</option>
          <option value="pt">üáµüáπ Portugu√™s</option>
          <option value="ro">üá∑üá¥ Rom√¢nƒÉ</option>
          <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
          <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
        </select>

        <div class="hidden sm:flex flex-col items-end">
          <div class="text-sm text-slate-700 font-medium" id="userEmail">Loading‚Ä¶</div>
          <div class="flex items-center gap-2 text-xs text-slate-500">
            <span>Remember me</span>
            <div id="rememberToggle" class="toggle active"></div>
          </div>
        </div>

        <button id="logoutBtn" class="btn btn-muted">üö™ Logout</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-5 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- LEFT: content -->
    <div class="lg:col-span-2 space-y-8">

      <!-- Identity -->
      <section class="card">
        <div class="ribbon r-identity"></div>
        <div class="flex items-start justify-between mb-4">
          <div>
            <h2 class="text-xl font-extrabold text-slate-900">Identity Profile</h2>
            <p class="text-sm text-slate-500">Used across global systems to confirm who you are.</p>
          </div>
          <div id="identitySaved" class="text-emerald-600 text-xs font-bold opacity-0 transition">‚úì Saved</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="label">Full Name</label>
            <input id="fullName" class="input" placeholder="Jane Appleseed">
          </div>
          <div>
            <label class="label">Date of Birth</label>
            <input id="dob" type="date" class="input">
          </div>

          <div>
            <label class="label">Country</label>
            <select id="country" class="input">
              <option value="">Select country</option>
              <option>United Kingdom</option>
              <option>United States</option>
              <option>Canada</option>
              <option>Australia</option>
              <option>Germany</option>
              <option>France</option>
              <option>Italy</option>
              <option>Spain</option>
              <option>Ireland</option>
              <option>Netherlands</option>
              <option>Sweden</option>
              <option>Norway</option>
              <option>Denmark</option>
              <option>Finland</option>
              <option>Poland</option>
              <option>Portugal</option>
              <option>Romania</option>
              <option>Switzerland</option>
              <option>Greece</option>
              <option>Japan</option>
              <option>South Korea</option>
              <option>Singapore</option>
              <option>India</option>
              <option>United Arab Emirates</option>
              <option>South Africa</option>
              <option>New Zealand</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div>
            <label class="label">Health ID (optional)</label>
            <input id="healthId" class="input" placeholder="NHS, EHIC, national health number">
            <p class="text-xs text-slate-500 mt-1">Do not enter passport/ID. Examples: NHS (UK), CHI (Scotland), HCN (CA).</p>
          </div>
        </div>

        <div class="flex justify-end mt-6">
          <button id="saveIdentityBtn" class="btn btn-primary">Save Identity</button>
        </div>
        <p class="text-sm text-slate-500 mt-3">Responders use this to confirm you and contact providers.</p>
      </section>

      <!-- Critical Medical -->
      <section class="card">
        <div class="ribbon r-critical"></div>
        <div class="flex items-start justify-between mb-4">
          <div>
            <h2 class="text-xl font-extrabold text-slate-900">Critical Medical Info</h2>
            <p class="text-sm text-slate-500">Patient-provided; clinicians must verify.</p>
          </div>
          <div id="criticalSaved" class="text-emerald-600 text-xs font-bold opacity-0 transition">‚úì Saved</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="label">Blood Type</label>
            <select id="bloodType" class="input">
              <option value="">‚Äî</option>
              <option>A+</option><option>A-</option>
              <option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option>
              <option>O+</option><option>O-</option>
            </select>
          </div>
          <div>
            <label class="label">Organ Donor</label>
            <select id="organDonor" class="input">
              <option value="">‚Äî</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
              <option value="Unknown">Unknown</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="label">Allergies</label>
            <textarea id="allergies" rows="2" class="input resize-none" placeholder="Penicillin, Midazolam, Peanuts"></textarea>
          </div>

          <div class="md:col-span-2">
            <label class="label">Medical Conditions</label>
            <textarea id="conditions" rows="2" class="input resize-none" placeholder="Diabetes, Hypertension, Asthma"></textarea>
          </div>

          <div class="md:col-span-2">
            <label class="label">Current Medications</label>
            <textarea id="medications" rows="2" class="input resize-none" placeholder="Name and dose"></textarea>
          </div>

          <div class="md:col-span-2">
            <label class="label">Resuscitation Preference</label>
            <select id="lifeSupportPref" class="input">
              <option value="">‚Äî</option>
              <option value="Full Life Support ‚Äî all resuscitation">Full Life Support ‚Äî CPR, ventilation, meds</option>
              <option value="Comfort Care Only">Comfort Care Only ‚Äî no life-prolonging measures</option>
              <option value="DNR">Do Not Resuscitate (DNR)</option>
            </select>
            <p class="text-xs text-slate-500 mt-1">Guidance only ‚Äî confirm with official records.</p>
          </div>
        </div>

        <div class="flex justify-end mt-6">
          <button id="saveCriticalBtn" class="btn btn-primary">Save Critical Info</button>
        </div>
      </section>

      <!-- ICE -->
      <section class="card">
        <div class="ribbon r-ice"></div>
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-extrabold text-slate-900">In Case of Emergency (ICE)</h2>
          <button id="addIceBtn" class="btn btn-muted text-sm">Add ICE Contact</button>
        </div>
        <p class="text-sm text-slate-500 mb-4">Tap-to-call helps responders connect instantly. (Max 3)</p>

        <div id="iceList" class="space-y-4">
          <!-- contacts rendered here -->
        </div>

        <div class="flex justify-between items-center mt-4">
          <span id="iceCounter" class="text-sm text-slate-500">0/3 contacts</span>
          <span id="iceSaved" class="text-emerald-600 text-xs font-bold opacity-0 transition">‚úì Saved</span>
        </div>
      </section>

      <!-- Danger Zone -->
      <section class="card">
        <div class="ribbon r-danger"></div>
        <h2 class="text-red-600 font-extrabold text-lg mb-3">‚ö†Ô∏è Danger Zone</h2>
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-sm text-red-700 mb-4">
          This action is permanent. All your data, QR codes and ICE contacts will be deleted.
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <input id="deleteConfirm" class="input" placeholder="Type DELETE MY ACCOUNT">
          <button id="deleteBtn" class="btn btn-danger" disabled>Delete Account Forever</button>
        </div>
      </section> 

    </div>
        <!-- RIGHT: sidebar -->
    <aside class="space-y-8">

      <!-- Triage -->
      <section class="card">
        <div class="ribbon r-triage"></div>
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-extrabold text-slate-900">Triage Assessment</h3>
          <span id="triagePill" class="pill pill-green">GREEN</span>
        </div>
        <p id="triageDesc" class="text-sm text-slate-500 mb-4">Standard emergency protocols apply.</p>

        <label class="label">Override (Optional)</label>
        <select id="triageOverride" class="input mb-3">
          <option value="">Auto (Recommended)</option>
          <option value="green">GREEN ‚Äî Standard</option>
          <option value="yellow">AMBER ‚Äî Urgent</option>
          <option value="red">RED ‚Äî Emergency</option>
          <option value="black">BLACK ‚Äî Comfort care</option>
        </select>
        <div class="grid grid-cols-2 gap-2">
          <button id="speakBtn" class="btn btn-muted">üîä Speak</button>
          <button id="stopSpeakBtn" class="btn btn-muted">‚èπ Stop</button>
        </div>
      </section>

      <!-- QR & Tags -->
      <section class="card">
        <div class="ribbon r-qr"></div>
        <h3 class="text-lg font-extrabold text-slate-900 mb-2">QR Code & Tags</h3>
        <p class="text-sm text-slate-500 mb-4">Text-first (works offline) + link (for future online view).</p>

        <div class="flex flex-col items-center mb-3">
          <div class="qr-wrap">
            <div id="qrPlaceholder" class="qr-placeholder">
              <div class="text-center text-xs">
                <div class="text-2xl">üì±</div>
                Complete profile then generate
              </div>
            </div>
            <canvas id="qrCanvas" width="184" height="184" class="hidden"></canvas>
          </div>
          <div class="mt-2 text-sm text-slate-600">
            Status: <span id="qrStatus" class="font-semibold text-emerald-600">Active</span>
          </div>
        </div>

        <div id="generateWrap" class="mb-3 hidden">
          <button id="generateBtn" class="btn btn-primary w-full">üéØ Generate Emergency Code</button>
        </div>

        <label class="label">QR Payload</label>
        <textarea id="qrPayload" class="input text-xs h-28 bg-slate-50" readonly placeholder="Generate code to view payload"></textarea>

        <div class="flex items-center justify-between mt-3 text-sm">
          <div class="flex items-center gap-2">
            <span>Offline mode</span>
            <div id="offlineToggle" class="toggle active"></div>
          </div>
          <div class="text-slate-500">One scan shows essentials in big text.</div>
        </div>

        <div class="grid grid-cols-4 gap-2 mt-3">
          <button id="copyBtn" class="btn btn-muted text-xs">üìã Copy</button>
          <button id="dl1024" class="btn btn-muted text-xs">üì• 1024px</button>
          <button id="dl512" class="btn btn-muted text-xs">üì• 512px</button>
          <button id="printBtn" class="btn btn-muted text-xs">üñ®Ô∏è Print</button>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="rotateBtn" class="btn btn-muted text-xs">üîÑ Rotate</button>
          <button id="revokeBtn" class="btn btn-danger text-xs">üö´ Revoke</button>
        </div>
      </section>

      <!-- Vault (coming soon) -->
      <section class="card">
        <div class="ribbon r-vault"></div>
        <h3 class="text-lg font-extrabold text-slate-900 mb-2">Vault (Documents)</h3>
        <p class="text-sm text-slate-500 mb-4">Secure storage ‚Äî coming soon.</p>
        <div class="grid gap-2">
          <div class="p-3 rounded-lg border border-slate-200 bg-slate-50/70 opacity-60">üßæ DNR Directive</div>
          <div class="p-3 rounded-lg border border-slate-200 bg-slate-50/70 opacity-60">üìÑ Living Will</div>
          <div class="p-3 rounded-lg border border-slate-200 bg-slate-50/70 opacity-60">üè• Insurance Cards</div>
          <div class="p-3 rounded-lg border border-slate-200 bg-slate-50/70 opacity-60">üîí Secure Document Storage</div>
        </div>
      </section>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="border-t border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-7xl mx-auto px-5 py-8 grid md:grid-cols-3 gap-6 text-sm text-slate-600">
      <div><h4 class="font-bold text-slate-900 mb-2">Privacy & Security</h4>Your data is encrypted and stored securely.</div>
      <div><h4 class="font-bold text-slate-900 mb-2">Medical Disclaimer</h4>Informational only. Responders must verify.</div>
      <div><h4 class="font-bold text-slate-900 mb-2">Support</h4>Help 24/7 for your emergency codes.</div>
    </div>
  </footer>

  <!-- Print layout -->
  <div id="printArea" class="print-card hidden">
    <h1 class="text-3xl font-black text-red-600 mb-1">MYQER</h1>
    <p class="text-slate-600 mb-4">Emergency Medical Card</p>
    <div id="printQR" class="mx-auto mb-3"></div>
    <div id="printCode" class="font-mono text-sm text-slate-700"></div>
    <p class="text-xs text-slate-500 mt-2">Hybrid QR: essentials offline + link for full details.</p>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>
  <script>
/* ---------- Supabase ---------- */
const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: true, storage: localStorage }
});

/* ---------- State ---------- */
let currentUser = null;
let rememberMe = true;
let offlineMode = true;
let currentCode = null;
let currentPayload = '';
let rotateDeg = 0;

/* Simple i18n placeholders (expand later if needed) */
const i18n = {
  en: { online:'Online', offline:'No signal', saved:'Saved', warnFill:'Please fill Name, DOB, Country' },
  ar: { online:'ŸÖÿ™ÿµŸÑ', offline:'ŸÑÿß ÿ•ÿ¥ÿßÿ±ÿ©', saved:'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏', warnFill:'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ Ÿàÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ ŸàÿßŸÑÿØŸàŸÑÿ©' }
};
let lang = localStorage.getItem('myqer_lang') || 'en';

/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
const showToast = (msg, type='ok') => {
  const el = $('#toast'); el.className = `toast ${type==='ok'?'t-ok':type==='warn'?'t-warn':'t-err'} show`; el.textContent = msg;
  setTimeout(()=>el.classList.remove('show'), 2200);
};
const showSaved = id => { const el = $(id); if(!el) return; el.style.opacity=1; setTimeout(()=>el.style.opacity=0,1200); };

/* ---------- Session ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  // Remember-me toggle
  rememberMe = localStorage.getItem('myqer_remember_me') !== 'false';
  if(!rememberMe) $('#rememberToggle').classList.remove('active');
  $('#rememberToggle').addEventListener('click', () => {
    rememberMe = !rememberMe;
    localStorage.setItem('myqer_remember_me', String(rememberMe));
    $('#rememberToggle').classList.toggle('active', rememberMe);
  });

  // Language select
  $('#languageSelect').value = lang;
  $('#languageSelect').addEventListener('change', () => {
    lang = $('#languageSelect').value; localStorage.setItem('myqer_lang', lang);
    document.documentElement.dir = (lang==='ar')?'rtl':'ltr';
    $('#statusText').textContent = i18n[lang]?.online || i18n.en.online;
  });
  document.documentElement.dir = (lang==='ar')?'rtl':'ltr';

  // Logout
  $('#logoutBtn').addEventListener('click', async () => {
    try { await sb.auth.signOut(); location.replace('/'); } 
    catch(e){ showToast('Logout failed','err'); }
  });

  // Inputs autosave
  ['fullName','dob','country','healthId'].forEach(id => $(`#${id}`).addEventListener('input', debounce(saveIdentity, 500)));
  ['bloodType','organDonor','allergies','conditions','medications','lifeSupportPref'].forEach(id => $(`#${id}`).addEventListener('input', debounce(saveCritical, 500)));
  $('#triageOverride').addEventListener('change', () => { saveCritical(); updateTriage(); renderQR(); });

  // Buttons
  $('#saveIdentityBtn').addEventListener('click', saveIdentity);
  $('#saveCriticalBtn').addEventListener('click', saveCritical);
  $('#addIceBtn').addEventListener('click', addIce);
  $('#deleteBtn').addEventListener('click', confirmDelete);
  $('#generateBtn').addEventListener('click', generateCode);
  $('#copyBtn').addEventListener('click', () => { navigator.clipboard.writeText(currentPayload).then(()=>showToast('Copied')); });
  $('#dl1024').addEventListener('click', () => downloadQR(1024));
  $('#dl512').addEventListener('click', () => downloadQR(512));
  $('#printBtn').addEventListener('click', printCard);
  $('#rotateBtn').addEventListener('click', () => { rotateDeg=(rotateDeg+90)%360; $('#qrCanvas').style.transform=`rotate(${rotateDeg}deg)`; });
  $('#revokeBtn').addEventListener('click', () => { currentCode=null; updateQRState(false); showToast('Code revoked','warn'); saveIdentity(); });

  // Offline toggle
  $('#offlineToggle').addEventListener('click', () => { offlineMode=!offlineMode; $('#offlineToggle').classList.toggle('active', offlineMode); renderQR(); });

  // Speak
  $('#speakBtn').addEventListener('click', speakSummary);
  $('#stopSpeakBtn').addEventListener('click', () => speechSynthesis.cancel());

  // Load session + data
  await checkSession();
  window.addEventListener('beforeunload', async () => { if(!rememberMe) await sb.auth.signOut({ scope:'local' }); });
});

/* ---------- Debounce ---------- */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }}

/* ---------- Check session & load ---------- */
async function checkSession(){
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ location.replace('/'); return; }
    currentUser = session.user;
    $('#userEmail').textContent = currentUser.email || '‚Äî';
    $('#statusText').textContent = i18n[lang]?.online || i18n.en.online;
    await loadAll();
  }catch(e){ console.error(e); location.replace('/'); }
}

/* ---------- Load all ---------- */
async function loadAll(){
  try{
    // Profile
    const { data:profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    if(profile){
      $('#fullName').value = profile.full_name || '';
      $('#dob').value = profile.dob || profile.date_of_birth || '';
      $('#country').value = profile.country || '';
      $('#healthId').value = profile.health_id || '';
      currentCode = profile.code || null;
    }
    // Health
    const { data:hp } = await sb.from('health_profiles').select('*').eq('user_id', currentUser.id).single();
    if(hp){
      $('#bloodType').value = hp.blood_type || '';
      $('#organDonor').value = hp.organ_donor || '';
      $('#allergies').value = hp.allergies || '';
      $('#conditions').value = hp.conditions || '';
      $('#medications').value = hp.meds || '';
      $('#lifeSupportPref').value = hp.life_support_pref || '';
      $('#triageOverride').value = hp.triage_override || '';
    }
    // ICE
    const { data:ice } = await sb.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at');
    renderICE(ice || []);

    // UI
    updateTriage();
    updateQRState(Boolean(currentCode));
    renderQR();
    updateGenerateVisibility();
  }catch(e){ console.error('Load error',e); showToast('Failed to load data','warn'); }
}

/* ---------- Identity save ---------- */
async function saveIdentity(){
  try{
    const up = {
      id: currentUser.id,
      full_name: $('#fullName').value.trim(),
      dob: $('#dob').value || null,
      country: $('#country').value || null,
      health_id: $('#healthId').value || null,
      code: currentCode || null,
      updated_at: new Date().toISOString()
    };
    await sb.from('profiles').upsert(up);
    showSaved('#identitySaved');
    updateGenerateVisibility();
    if(currentCode) renderQR();
  }catch(e){ console.error(e); showToast('Save failed','err'); }
}

/* ---------- Critical save ---------- */
async function saveCritical(){
  try{
    const up = {
      user_id: currentUser.id,
      blood_type: $('#bloodType').value || null,
      organ_donor: $('#organDonor').value || null,
      allergies: $('#allergies').value || null,
      conditions: $('#conditions').value || null,
      meds: $('#medications').value || null,
      life_support_pref: $('#lifeSupportPref').value || null,
      triage_override: $('#triageOverride').value || null
    };
    await sb.from('health_profiles').upsert(up);
    showSaved('#criticalSaved');
    updateTriage();
    if(currentCode) render
