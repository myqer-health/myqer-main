<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYQER — Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QR library (UMD; loads before app code so window.QRCode exists) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root{
      --brand:#c62828;        /* MYQER red */
      --ink:#0f172a;          /* slate-900 */
      --muted:#64748b;        /* slate-500 */
      --ring:rgba(198,40,40,.14);
      --stroke:rgba(15,23,42,.08);
      --shadow:0 18px 42px rgba(2,8,23,.12), 0 2px 6px rgba(2,8,23,.06);
      --rad:16px;
    }
    body{background:linear-gradient(135deg,#f8fafc 0%,#eef2f7 100%);color:var(--ink)}
    .glass{background:rgba(255,255,255,.7);backdrop-filter:blur(14px);border:1px solid var(--stroke)}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:var(--rad);box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:12px;font-weight:700}
    .btn-red{background:var(--brand);color:#fff}.btn-red:hover{filter:brightness(1.03)}
    .btn-outline{border:1px solid var(--brand);color:var(--brand);background:#fff}
    .kicker{font-size:.8rem;color:var(--muted)}
    .pill{border-radius:999px;border:1px solid var(--stroke);background:#fff;padding:.35rem .7rem;font-size:.8rem}
    .legend-dot{width:.65rem;height:.65rem;border-radius:999px;display:inline-block;margin-right:.4rem}
    .qr-ring{box-shadow:0 0 0 2px var(--brand), 0 8px 20px var(--ring);border-radius:14px}
    .disabled{opacity:.55;cursor:not-allowed}

    /* ribbons */
    .ribbon{position:relative;padding-top:14px}
    .ribbon::before{content:attr(data-title);position:absolute;top:0;left:-1px;
      font-weight:800;font-size:.78rem;letter-spacing:.02em;color:#fff;
      padding:.28rem .6rem;border-top-left-radius:10px;border-bottom-right-radius:10px}
    .r-green::before{background:#16a34a}
    .r-orange::before{background:#ea580c}
    .r-red::before{background:#dc2626}
    .r-purple::before{background:#7c3aed}
  </style>
</head>
<body class="min-h-screen">

  <!-- Top bar -->
  <header class="glass sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="h-16 flex items-center justify-between gap-3">
        <a href="/" class="flex items-center gap-2 font-extrabold text-xl">
          MYQ<span class="text-[var(--brand)]">ER</span><sup class="text-xs ml-0.5">™</sup>
        </a>
        <div class="hidden sm:block text-sm text-slate-600">
          <strong>MYQER</strong> <span class="italic">(pronounced “my care”)</span>
        </div>
        <div class="flex items-center gap-3">
          <select id="lang" class="border rounded-md px-3 py-1 text-sm">
            <option value="en">🇺🇸 EN</option>
            <option value="fr">🇫🇷 FR</option>
            <option value="es">🇪🇸 ES</option>
            <option value="de">🇩🇪 DE</option>
            <option value="it">🇮🇹 IT</option>
            <option value="pt">🇵🇹 PT</option>
            <option value="ro">🇷🇴 RO</option>
            <option value="ar">🇸🇦 AR</option>
            <option value="hi">🇮🇳 HI</option>
            <option value="zh">🇨🇳 中文</option>
          </select>
          <button id="logoutBtn" class="btn btn-outline px-4 py-2 text-sm">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading / Error -->
  <div id="loading" class="flex items-center justify-center min-h-[40vh]">
    <div class="text-center">
      <div class="animate-spin h-10 w-10 rounded-full border-b-2 border-[var(--brand)] mx-auto mb-3"></div>
      <p class="text-[var(--muted)]">Loading your dashboard…</p>
    </div>
  </div>

  <div id="errorBox" class="hidden max-w-3xl mx-auto mt-8 card p-5">
    <div class="text-red-600 font-bold mb-1">Something went wrong</div>
    <div id="errorMsg" class="text-sm text-slate-600"></div>
  </div>

  <!-- Main -->
  <main id="dash" class="hidden pt-6 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- LEFT/CENTER -->
      <div class="lg:col-span-2 space-y-8">

        <!-- Identity -->
        <section class="card p-6 ribbon r-green" data-title="Identity">
          <h2 class="text-xl font-extrabold mb-1">Identity — Personal Information</h2>
          <p class="kicker mb-5">These details help responders confirm who you are.</p>

          <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Full name</label>
              <input name="full_name" class="w-full mt-1 border rounded-md px-3 py-2" autocomplete="name">
            </div>
            <div>
              <label class="text-sm font-medium">Date of Birth</label>
              <input name="date_of_birth" type="date" class="w-full mt-1 border rounded-md px-3 py-2">
            </div>
            <div>
              <label class="text-sm font-medium">Country</label>
              <input name="country" class="w-full mt-1 border rounded-md px-3 py-2" autocomplete="country-name">
            </div>
            <div>
              <label class="text-sm font-medium">Health ID (e.g., NHS)</label>
              <input name="health_id" class="w-full mt-1 border rounded-md px-3 py-2" autocomplete="off" placeholder="e.g., NHS number">
            </div>

            <div class="md:col-span-2 flex items-center justify-between">
              <div>
                <span class="kicker">Your card code:</span>
                <code id="codeText" class="ml-2 px-2 py-1 rounded bg-slate-100 text-[.85rem]">—</code>
              </div>
              <div class="flex gap-2">
                <button type="button" id="genCode" class="btn px-3 py-2 border">Generate code</button>
                <button class="btn btn-red px-4 py-2">Save Profile</button>
              </div>
            </div>
          </form>
        </section>

        <!-- Health -->
        <section class="card p-6 ribbon r-red" data-title="Critical">
          <h2 class="text-xl font-extrabold mb-1">CRITICAL — Emergency Priority</h2>
          <p class="kicker mb-5">Keep this current. It appears on your emergency card.</p>

          <form id="healthForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Blood type</label>
              <select name="blood_type" class="w-full mt-1 border rounded-md px-3 py-2">
                <option value="">—</option>
                <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">Organ donor</label>
              <select name="organ_donor" class="w-full mt-1 border rounded-md px-3 py-2">
                <option value="">—</option>
                <option value="yes">Yes</option><option value="no">No</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-medium">Critical allergies</label>
              <input name="allergies" class="w-full mt-1 border rounded-md px-3 py-2" placeholder="Penicillin, Nuts">
            </div>
            <div class="md:col-span-2">
              <label class="text-sm font-medium">Conditions</label>
              <input name="conditions" class="w-full mt-1 border rounded-md px-3 py-2" placeholder="Diabetes, Asthma">
            </div>
            <div class="md:col-span-2">
              <label class="text-sm font-medium">Current medications</label>
              <input name="meds" class="w-full mt-1 border rounded-md px-3 py-2" placeholder="Metformin">
            </div>
            <div class="md:col-span-2">
              <label class="text-sm font-medium">Implants / devices</label>
              <input name="implants" class="w-full mt-1 border rounded-md px-3 py-2" placeholder="Pacemaker, Insulin pump">
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-medium">Life support & DNR preference (informational)</label>
              <select name="life_support_pref" class="w-full mt-1 border rounded-md px-3 py-2">
                <option value="">—</option>
                <option value="Full">All resuscitation efforts (Full)</option>
                <option value="Comfort only">Comfort-focused care only</option>
                <option value="DNR">Do not resuscitate (DNR)</option>
              </select>
              <p class="kicker mt-1">These preferences are informational only. Clinicians must confirm with official documents.</p>
            </div>

            <div>
              <label class="text-sm font-medium">Burial preference</label>
              <select name="burial_pref" class="w-full mt-1 border rounded-md px-3 py-2">
                <option value="">—</option>
                <option>Cremation</option><option>Burial</option><option>Don’t know</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">Religious / Cultural preference</label>
              <select name="religion_pref" class="w-full mt-1 border rounded-md px-3 py-2">
                <option value="">None</option>
                <option>Christian</option><option>Muslim</option><option>Jewish</option>
                <option>Hindu</option><option>Buddhist</option><option>Sikh</option>
                <option>Other</option>
              </select>
            </div>

            <div class="md:col-span-2 flex justify-end">
              <button class="btn btn-red px-4 py-2">Save Health</button>
            </div>
          </form>
        </section>

        <!-- ICE -->
        <section class="card p-6 ribbon r-orange" data-title="ICE">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-extrabold">Emergency Contacts (ICE)</h2>
            <button id="addIce" class="btn btn-outline px-3 py-2 text-sm">Add contact</button>
          </div>
          <p class="kicker mb-4">Add up to 3 trusted contacts.</p>
          <div id="iceList" class="space-y-3"></div>
        </section>

        <!-- Document Vault (placeholder) -->
        <section class="card p-6 ribbon r-purple" data-title="Document Vault">
          <h2 class="text-xl font-extrabold mb-1">Document Vault (Coming Soon)</h2>
          <p class="kicker">Secure, client-side encrypted storage for DNR orders, Living Will, MPOA, insurance docs.</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-3">
            <div class="border rounded-lg p-4 text-slate-500">DNR Orders</div>
            <div class="border rounded-lg p-4 text-slate-500">Living Will</div>
            <div class="border rounded-lg p-4 text-slate-500">Medical Power of Attorney</div>
            <div class="border rounded-lg p-4 text-slate-500">Insurance Documents</div>
          </div>
        </section>

      </div>

      <!-- RIGHT -->
      <aside class="space-y-8">

        <!-- Triage -->
        <section class="card p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-extrabold">Emergency Triage Status</h3>
            <span id="triagePill" class="pill">—</span>
          </div>
          <p class="kicker mb-4">Auto-computed from your data. You can override.</p>
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="text-sm font-medium">Manual override</label>
              <select id="triageOverride" class="w-full mt-1 border rounded-md px-3 py-2">
                <option value="">Auto</option>
                <option value="green">Green</option>
                <option value="amber">Amber</option>
                <option value="red">Red</option>
                <option value="black">Black</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button id="speak" class="btn btn-outline px-3 py-2 text-sm">🔈 Speak summary</button>
              <button id="stopSpeak" class="btn px-3 py-2 border text-sm">Stop</button>
            </div>
          </div>
        </section>

        <!-- QR -->
        <section class="card p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-extrabold">Emergency Card & QR</h3>
            <span class="kicker" id="qrStatus"></span>
          </div>

          <div class="flex items-center justify-center">
            <div class="qr-ring bg-white p-3 rounded-xl relative">
              <canvas id="qrCanvas" width="220" height="220"></canvas>
              <!-- center badge -->
              <div id="qrBadge" class="pointer-events-none absolute inset-0 flex items-center justify-center">
                <div class="rounded-full bg-white/90 border border-slate-200 px-2 py-0.5 text-[11px] font-extrabold tracking-wide">
                  MYQ<span class="text-[var(--brand)]">ER</span>
                </div>
              </div>
            </div>
          </div>

          <div class="text-center mt-2">
            <div class="text-xs text-slate-500 mb-1">Scan for emergency access</div>
            <div class="font-mono text-sm" id="codeUnderQR">—</div>
          </div>

          <div class="mt-3">
            <label class="text-sm font-medium">Card link</label>
            <div class="flex gap-2 mt-1">
              <input id="cardUrl" class="border rounded-md px-3 py-2 flex-1" readonly>
              <button id="copyLink" class="btn btn-outline px-3 py-2 text-sm">Copy</button>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2 mt-3">
            <button id="dlPNG" class="btn px-2 py-2 border text-sm">PNG</button>
            <button id="dlSVG" class="btn px-2 py-2 border text-sm">SVG</button>
            <button id="printQR" class="btn px-2 py-2 border text-sm">Print</button>
          </div>
        </section>

        <!-- Legend -->
        <section class="card p-6">
          <h3 class="text-lg font-extrabold mb-2">Triage colours</h3>
          <ul class="space-y-1 text-sm">
            <li><span class="legend-dot" style="background:#16a34a"></span><strong>Green</strong> — mild allergies, no major conditions.</li>
            <li><span class="legend-dot" style="background:#f59e0b"></span><strong>Amber</strong> — stable chronic conditions.</li>
            <li><span class="legend-dot" style="background:#ef4444"></span><strong>Red</strong> — severe allergies / life-threatening conditions.</li>
            <li><span class="legend-dot" style="background:#111827"></span><strong>Black</strong> — DNR / Comfort care set.</li>
          </ul>
          <div class="mt-4 text-xs text-slate-500 space-y-2">
            <p><strong>Info only:</strong> This card supports care; clinicians must verify with official records.</p>
            <p><strong>Privacy:</strong> Your data stays on your device unless you share it. No ads, no trackers.</p>
            <p>Your QR code stays the same — it always opens your latest information.</p>
          </div>
        </section>

      </aside>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-10 pb-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 text-center text-sm text-slate-500">
      © 2025 MYQER — My QR for Emergency Response · GDPR/HIPAA-minded ·
      <a class="underline" href="/privacy.html">Privacy</a> ·
      <a class="underline" href="/terms.html">Terms</a>
    </div>
  </footer>

  <!-- App (single module so load order is guaranteed) -->
  <script type="module">
    /************ Supabase init (your credentials) ************/
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';

    // One global client
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.sb = sb;

    /************ DOM refs ************/
    const loading = document.getElementById('loading');
    const dash = document.getElementById('dash');
    const errorBox = document.getElementById('errorBox');
    const errorMsg = document.getElementById('errorMsg');
    const langSel = document.getElementById('lang');
    const profileForm = document.getElementById('profileForm');
    const healthForm  = document.getElementById('healthForm');
    const iceList     = document.getElementById('iceList');
    const codeText    = document.getElementById('codeText');
    const codeUnderQR = document.getElementById('codeUnderQR');
    const cardUrlEl   = document.getElementById('cardUrl');
    const qrStatus    = document.getElementById('qrStatus');
    const triagePill  = document.getElementById('triagePill');
    const triageOverride = document.getElementById('triageOverride');

    /************ Tiny helpers ************/
    const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
    const debouncers = {};
    const debounce = (key,fn,ms=450)=>{ clearTimeout(debouncers[key]); debouncers[key]=setTimeout(fn,ms); };
    function toast(msg,type='ok'){
      const el = document.createElement('div');
      el.className = `fixed top-4 right-4 z-[1000] px-4 py-2 rounded-md text-white shadow ${type==='ok'?'bg-emerald-600':type==='warn'?'bg-amber-600':'bg-red-600'}`;
      el.textContent = msg; document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2000);
    }

    /************ i18n (minimal) ************/
    const T = {
      en:{saveProfile:'Save Profile',saveHealth:'Save Health',copied:'Copied',qrNoLib:'QR library not loaded',qrNoCode:'No code yet'},
      fr:{saveProfile:'Enregistrer',saveHealth:'Enregistrer santé',copied:'Copié',qrNoLib:'Librairie QR non chargée',qrNoCode:'Pas de code'},
      es:{saveProfile:'Guardar perfil',saveHealth:'Guardar salud',copied:'Copiado',qrNoLib:'Biblioteca QR no cargada',qrNoCode:'Sin código'}
    };
    function t(key){ const L=T[langSel.value]||T.en; return L[key]||key; }
    function applyI18n(){ /* (labels are mostly static English for launch) */ }
    langSel.addEventListener('change',()=>{ localStorage.setItem('myqer_lang',langSel.value); applyI18n(); updateVoiceLocale(); });

    /************ Voice (gentle female) ************/
    let voiceLang='en-US', preferredVoice=null;
    function updateVoiceLocale(){
      const map={en:'en-US',fr:'fr-FR',es:'es-ES',de:'de-DE',it:'it-IT',pt:'pt-PT',ro:'ro-RO',ar:'ar-SA',hi:'hi-IN',zh:'zh-CN'};
      voiceLang=map[langSel.value]||'en-US';
      const all=window.speechSynthesis?.getVoices?.()||[];
      // pick a female voice if possible
      preferredVoice = all.find(v=>v.lang.startsWith(voiceLang.slice(0,2)) && /female|siri|victoria|samantha/i.test(v.name))
                    || all.find(v=>v.lang.startsWith(voiceLang.slice(0,2)))
                    || all[0] || null;
    }
    if ('speechSynthesis' in window) { window.speechSynthesis.onvoiceschanged=updateVoiceLocale; }
    function buildSummary(profile,health){
      const n=profile.full_name||'';
      const bt=health.blood_type||'—';
      const a=(health.allergies||'').trim()||'No critical allergies listed';
      const c=(health.conditions||'').trim()||'No conditions listed';
      const m=(health.meds||'').trim()||'No medications listed';
      return `${n}. Blood type ${bt}. Allergies: ${a}. Conditions: ${c}. Medications: ${m}.`;
    }
    document.getElementById('speak').addEventListener('click',()=>{
      try{ speechSynthesis.cancel(); }catch(_){}
      const u=new SpeechSynthesisUtterance(buildSummary(profile,health));
      u.lang=voiceLang; if(preferredVoice) u.voice=preferredVoice; u.pitch=1.05; u.rate=0.98;
      speechSynthesis.speak(u);
    });
    document.getElementById('stopSpeak').addEventListener('click',()=>{ try{speechSynthesis.cancel();}catch(_){}});

    /************ State ************/
    let session,user,profile={},health={},ice=[];

    /************ Auth & load ************/
    async function ensureSession(){
      const { data:{session:s}, error } = await sb.auth.getSession();
      if (error) throw error;
      if (!s){ window.location.replace('/'); return false; }
      session=s; user=s.user; return true;
    }

    async function loadAll(){
      // Profile
      let { data:p, error:pe } = await sb.from('profiles').select('*').eq('id', user.id).single();
      if (pe && pe.code==='PGRST116'){ // not found -> create skeleton
        const skeleton={ id:user.id, email:user.email, code:null };
        const { data:created } = await sb.from('profiles').insert(skeleton).select().single();
        p=created;
      } else if (pe) throw pe;
      profile = p||{};

      // Health
      let { data:h, error:he } = await sb.from('health_profiles').select('*').eq('user_id', user.id).single();
      if (he && he.code==='PGRST116'){ h={}; }
      else if (he) throw he;
      health = h||{};

      // ICE
      const { data:ic, error:ie } = await sb.from('ice_contacts').select('*').eq('user_id', user.id).order('created_at');
      if (ie) throw ie;
      ice = ic||[];
    }

    /************ Renderers ************/
    function renderProfile(){
      const f=profileForm;
      f.full_name.value=profile.full_name||'';
      f.date_of_birth.value=profile.date_of_birth||'';
      f.country.value=profile.country||'';
      f.health_id.value=profile.health_id||'';
      codeText.textContent=profile.code||'—';
      const link = profile.code ? `${location.origin}/c/${encodeURIComponent(profile.code)}` : '';
      cardUrlEl.value = link;
      codeUnderQR.textContent = profile.code || '—';
    }
    function renderHealth(){
      const f=healthForm;
      f.blood_type.value=health.blood_type||'';
      f.organ_donor.value=(health.organ_donor===true||health.organ_donor==='yes')?'yes':(health.organ_donor==='no'?'no':'');
      f.allergies.value=health.allergies||'';
      f.conditions.value=health.conditions||'';
      f.meds.value=health.meds||'';
      f.implants.value=health.implants||'';
      f.life_support_pref.value=health.life_support_pref||'';
      f.burial_pref.value=health.burial_pref||'';
      f.religion_pref.value=health.religion_pref||'';
    }
    function renderIce(){
      if(!ice.length){ iceList.innerHTML='<div class="text-slate-500 text-sm">No contacts yet.</div>'; return; }
      iceList.innerHTML = ice.map(c=>`
        <div class="border rounded-lg p-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
            <input class="border rounded-md px-3 py-2" placeholder="Name" value="${c.name||''}" data-id="${c.id}" data-field="name">
            <input class="border rounded-md px-3 py-2" placeholder="Relationship" value="${c.relation||''}" data-id="${c.id}" data-field="relation">
            <div class="flex gap-2">
              <input class="border rounded-md px-3 py-2 flex-1" placeholder="Phone" value="${c.phone||''}" data-id="${c.id}" data-field="phone">
              <button class="btn px-3 py-2 border text-sm" data-del="${c.id}">🗑</button>
            </div>
          </div>
        </div>`).join('');
    }

    function computeTriage(){
      const ov=triageOverride.value; if(ov) return ov;
      const pref=(health.life_support_pref||'').toLowerCase();
      if(pref.includes('dnr')||pref.includes('comfort')) return 'black';
      const severe=(health.allergies||'').toLowerCase().includes('anaphyl')||(health.conditions||'').toLowerCase().includes('severe');
      if(severe) return 'red';
      if((health.conditions||'').trim()) return 'amber';
      return 'green';
    }
    function applyTriage(){
      const map={green:['GREEN','#16a34a'],amber:['AMBER','#f59e0b'],red:['RED','#ef4444'],black:['BLACK','#111827']};
      const [txt,col]=map[computeTriage()];
      triagePill.style.border='1px solid '+col+'55'; triagePill.style.color=col; triagePill.textContent=txt+(txt==='GREEN'?' — Standard':'');
    }

    function renderQR(){
      const QR=window.QRCode;
      if(!QR){ qrStatus.textContent=t('qrNoLib'); return; }
      if(!profile.code){
        qrStatus.textContent=t('qrNoCode');
        const ctx=document.getElementById('qrCanvas').getContext('2d'); ctx.clearRect(0,0,220,220);
        return;
      }
      const url = `${location.origin}/c/${encodeURIComponent(profile.code)}`;
      qrStatus.textContent='';
      QR.toCanvas(document.getElementById('qrCanvas'), url, { width:220, margin:2, color:{dark:"#111827", light:"#ffffff"} }, err=>{
        if(err) qrStatus.textContent='QR error';
        // subtle brand label under QR
        const ctx=document.getElementById('qrCanvas').getContext('2d');
        ctx.fillStyle='#ffffff'; ctx.fillRect(0,200,220,20);
        ctx.fillStyle='#111827'; ctx.font='bold 11px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.fillText('MYQ',8,214); ctx.fillStyle='#c62828'; ctx.fillText('ER',36,214);
      });
      cardUrlEl.value=url;
      codeUnderQR.textContent=profile.code;
    }

    /************ Saves (with autosave) ************/
    profileForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      await saveProfile();
    });
    async function saveProfile(){
      const fd=new FormData(profileForm);
      const data={
        id:user.id, email:user.email,
        full_name:fd.get('full_name')||null,
        date_of_birth:fd.get('date_of_birth')||null,
        country:fd.get('country')||null,
        health_id:fd.get('health_id')||null,
        code:profile.code||null
      };
      const { error } = await sb.from('profiles').upsert(data);
      if(error){ toast(error.message,'err'); return; }
      profile={...profile,...data}; renderProfile(); renderQR(); toast(t('saveProfile'),'ok');
    }
    // autosave profile
    profileForm.addEventListener('input', ()=>debounce('profile',saveProfile,900));

    document.getElementById('genCode').addEventListener('click', async ()=>{
      if(profile.code){ toast('Code already exists','warn'); return; }
      const newCode='MYQER-'+Math.random().toString(36).slice(2,9).toUpperCase();
      const { error } = await sb.from('profiles').update({ code:newCode }).eq('id',user.id);
      if(error){ toast(error.message,'err'); return; }
      profile.code=newCode; renderProfile(); renderQR(); toast('Code generated','ok');
    });

    healthForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); await saveHealth();
    });
    async function saveHealth(){
      const fd=new FormData(healthForm);
      const data={
        user_id:user.id,
        blood_type:fd.get('blood_type')||null,
        organ_donor:fd.get('organ_donor')==='yes'?true:fd.get('organ_donor')==='no'?false:null,
        allergies:fd.get('allergies')||null,
        conditions:fd.get('conditions')||null,
        meds:fd.get('meds')||null,
        implants:fd.get('implants')||null,
        life_support_pref:fd.get('life_support_pref')||null,
        burial_pref:fd.get('burial_pref')||null,
        religion_pref:fd.get('religion_pref')||null
      };
      const { error } = await sb.from('health_profiles').upsert(data);
      if(error){ toast(error.message,'err'); return; }
      health={...health,...data}; applyTriage(); toast(t('saveHealth'),'ok');
    }
    // autosave health
    healthForm.addEventListener('input', ()=>debounce('health',saveHealth,900));
    healthForm.addEventListener('change', ()=>debounce('health',saveHealth,600));

    // ICE add/update/delete
    document.getElementById('addIce').addEventListener('click', async ()=>{
      if(ice.length>=3){ toast('Maximum 3 contacts','warn'); return; }
      const { data,row, error } = await sb.from('ice_contacts').insert({user_id:user.id,name:'',relation:'',phone:''}).select().single();
      if(error){ toast(error.message,'err'); return; }
      ice.push(data); renderIce();
    });
    iceList.addEventListener('input',(e)=>{
      const id=e.target.dataset.id, field=e.target.dataset.field; if(!id||!field) return;
      const val=e.target.value;
      debounce('ice:'+id+':'+field, async ()=>{
        const { error } = await sb.from('ice_contacts').update({ [field]:val }).eq('id',id);
        if(error) toast('Update failed','err');
      },500);
      const row=ice.find(x=>String(x.id)===String(id)); if(row) row[field]=val;
    });
    iceList.addEventListener('click', async (e)=>{
      const id=e.target.dataset.del; if(!id) return;
      if(!confirm('Delete this contact?')) return;
      const { error } = await sb.from('ice_contacts').delete().eq('id',id);
      if(error){ toast(error.message,'err'); return; }
      ice=ice.filter(x=>String(x.id)!==String(id)); renderIce();
    });

    /************ QR actions ************/
    document.getElementById('copyLink').addEventListener('click', async ()=>{
      if(cardUrlEl.value){ await navigator.clipboard.writeText(cardUrlEl.value); toast(t('copied'),'ok'); }
    });
    document.getElementById('dlPNG').addEventListener('click', ()=>{
      if(!profile.code) return;
      const a=document.createElement('a'); a.download='myqer-qr.png';
      a.href=document.getElementById('qrCanvas').toDataURL('image/png'); a.click();
    });
    document.getElementById('dlSVG').addEventListener('click', ()=>{
      if(!profile.code) return;
      const png=document.getElementById('qrCanvas').toDataURL();
      const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="#fff"/><image href="${png}" x="0" y="0" height="512" width="512"/></svg>`;
      const blob=new Blob([svg],{type:'image/svg+xml'}); const a=document.createElement('a');
      a.download='myqer-qr.svg'; a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
    });
    document.getElementById('printQR').addEventListener('click', ()=>{
      if(!profile.code) return;
      const img=document.getElementById('qrCanvas').toDataURL();
      const link=cardUrlEl.value||''; const code=profile.code||'';
      const w=window.open('','_blank','width=360,height=520');
      w.document.write(`<html><head><title>Print Emergency Card</title>
      <style>body{font-family:system-ui;margin:0} .wrap{display:flex;align-items:center;justify-content:center;height:100vh}</style>
      </head><body><div class="wrap"><div style="text-align:center">
        <img src="${img}" style="width:280px;height:280px;border:2px solid #c62828;border-radius:12px"/><br/>
        <div style="margin-top:8px;font-family:monospace">${code}</div>
        <div style="font-size:12px;color:#475569">${link}</div>
      </div></div></body></html>`); w.document.close(); w.print();
    });

    /************ Logout ************/
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      try{ await sb.auth.signOut(); }catch(e){ console.error(e); }
      location.replace('/');
    });

    /************ Boot ************/
    (async ()=>{
      try{
        // restore language
        const saved=localStorage.getItem('myqer_lang'); if(saved) langSel.value=saved;
        applyI18n(); updateVoiceLocale();

        const ok=await ensureSession(); if(!ok) return;
        await loadAll();
        renderProfile(); renderHealth(); renderIce(); renderQR(); applyTriage();

        loading.classList.add('hidden'); dash.classList.remove('hidden');
      }catch(e){
        console.error(e);
        loading.classList.add('hidden');
        errorMsg.textContent = e.message || 'Unknown error';
        errorBox.classList.remove('hidden');
      }
    })();

    triageOverride.addEventListener('change', applyTriage);
  </script>

  <!-- Service worker (kept) -->
  <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }
  </script>
</body>
</html>
