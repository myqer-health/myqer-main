<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MYQERâ„¢ Dashboard - Emergency Care</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --brand-red:#dc2626;--brand-red-dark:#b91c1c;--brand-red-light:#fecaca;
      --glass-bg:rgba(255,255,255,.85);--glass-border:rgba(255,255,255,.2);
      --shadow-light:0 4px 6px -1px rgba(0,0,0,.1);
      --shadow-medium:0 10px 15px -3px rgba(0,0,0,.1);
      --shadow-heavy:0 25px 50px -12px rgba(0,0,0,.25);
      --gradient-bg:linear-gradient(135deg,#F8FAFC 0%,#E2E8F0 50%,#CBD5E1 100%);
    }
    *{box-sizing:border-box}
    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:var(--gradient-bg);min-height:100vh;margin:0;padding:0;color:#1e293b;line-height:1.6
    }
    .glass-card{background:var(--glass-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:20px;border:1px solid var(--glass-border);box-shadow:var(--shadow-medium);transition:.3s;position:relative;overflow:hidden}
    .glass-card::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.8),transparent);z-index:1}
    .glass-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-heavy);border-color:rgba(255,255,255,.4)}
    .header-glass{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.2);box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .btn-tertiary{background:transparent;color:#6B7280;padding:10px 20px;border-radius:8px;font-weight:500;font-size:13px;transition:.2s;border:1px solid #E5E7EB;cursor:pointer}
    .btn-tertiary:hover{background:#F9FAFB;color:#374151}
    .disclaimer{background:linear-gradient(135deg,#FEF3C7,#FDE68A);border:2px solid #F59E0B;border-radius:16px;padding:20px;margin:24px 0}
    .brand-red{color:var(--brand-red)}
    .animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    /* RTL tweaks (Arabic) */
    html[dir="rtl"] body{direction:rtl}
    html[dir="rtl"] .text-left{text-align:right}
    html[dir="rtl"] .space-x-4 > * + *{margin-left:0;margin-right:1rem}
    html[dir="rtl"] .mr-2{margin-right:0;margin-left:.5rem}
    /* Toast (placeholder to match later) */
    .toast{position:fixed;top:24px;left:50%;transform:translateX(-50%) translateY(-100px);z-index:9999;padding:16px 32px;border-radius:16px;font-weight:600;font-size:14px;opacity:0;transition:.4s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.success{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(5,150,105,.9));color:#fff}
    .toast.warning{background:linear-gradient(135deg,rgba(245,158,11,.9),rgba(217,119,6,.9));color:#fff}
    .toast.error{background:linear-gradient(135deg,rgba(239,68,68,.9),rgba(220,38,38,.9));color:#fff}
    .toast.info{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(37,99,235,.9));color:#fff}
  </style>

  <script>
    // ---- Supabase config (same as your original) ----
    const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
    const ORIGIN = window.location.origin;
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- i18n dictionary (CHUNK 1 keys only: header + disclaimer) ----
    // We'll add more keys for each section in the next chunks.
    const i18n = {
      en: {
        online: "Online",
        logout: "Logout",
        worksOffline: 'Pronounced "my care" â€¢ Works offline',
        medDisclaimerTitle: "Medical Disclaimer",
        medDisclaimerBody:
          "This information is for emergency reference only and does not constitute medical advice. Healthcare professionals must independently verify all medical information and make their own clinical assessments. MYQERâ„¢ is not responsible for medical decisions made based on this data. Always consult with qualified healthcare providers for medical advice.",
      },
      es: {
        online: "En lÃ­nea",
        logout: "Cerrar sesiÃ³n",
        worksOffline: 'Se pronuncia "my care" â€¢ Funciona sin internet',
        medDisclaimerTitle: "Descargo de responsabilidad mÃ©dica",
        medDisclaimerBody:
          "Esta informaciÃ³n es solo de referencia para emergencias y no constituye consejo mÃ©dico. Los profesionales deben verificar la informaciÃ³n y realizar sus propias evaluaciones clÃ­nicas. MYQERâ„¢ no es responsable por decisiones mÃ©dicas basadas en estos datos. Consulte siempre con profesionales de la salud.",
      },
      fr: {
        online: "En ligne",
        logout: "DÃ©connexion",
        worksOffline: 'Se prononce "my care" â€¢ Fonctionne hors ligne',
        medDisclaimerTitle: "Avertissement mÃ©dical",
        medDisclaimerBody:
          "Ces informations sont destinÃ©es aux urgences et ne constituent pas un avis mÃ©dical. Les professionnels doivent vÃ©rifier les donnÃ©es et effectuer leurs propres Ã©valuations cliniques. MYQERâ„¢ nâ€™est pas responsable des dÃ©cisions mÃ©dicales basÃ©es sur ces donnÃ©es. Consultez toujours des professionnels de santÃ©.",
      },
      de: {
        online: "Online",
        logout: "Abmelden",
        worksOffline: 'Ausgesprochen â€my careâ€œ â€¢ Funktioniert offline',
        medDisclaimerTitle: "Medizinischer Haftungsausschluss",
        medDisclaimerBody:
          "Diese Informationen dienen nur als Notfallreferenz und stellen keine medizinische Beratung dar. FachkrÃ¤fte mÃ¼ssen Informationen verifizieren und eigenstÃ¤ndig beurteilen. MYQERâ„¢ haftet nicht fÃ¼r medizinische Entscheidungen basierend auf diesen Daten. Wenden Sie sich stets an qualifizierte Ã„rzte.",
      },
      it: {
        online: "In linea",
        logout: "Disconnettersi",
        worksOffline: 'Si pronuncia "my care" â€¢ Funziona offline',
        medDisclaimerTitle: "Avvertenza medica",
        medDisclaimerBody:
          "Queste informazioni sono solo di riferimento in caso di emergenza e non costituiscono consulenza medica. I professionisti devono verificare i dati e fare le proprie valutazioni cliniche. MYQERâ„¢ non Ã¨ responsabile delle decisioni mediche basate su questi dati. Consultare sempre personale sanitario qualificato.",
      },
      hi: {
        online: "à¤‘à¤¨à¤²à¤¾à¤‡à¤¨",
        logout: "à¤²à¥‰à¤— à¤†à¤‰à¤Ÿ",
        worksOffline: 'à¤‰à¤šà¥à¤šà¤¾à¤°à¤£ "à¤®à¤¾à¤¯ à¤•à¥‡à¤¯à¤°" â€¢ à¤‘à¤«à¤¼à¤²à¤¾à¤‡à¤¨ à¤­à¥€ à¤šà¤²à¤¤à¤¾ à¤¹à¥ˆ',
        medDisclaimerTitle: "à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤…à¤¸à¥à¤µà¥€à¤•à¤°à¤£",
        medDisclaimerBody:
          "à¤¯à¤¹ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤•à¥‡à¤µà¤² à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤¦à¤°à¥à¤­ à¤•à¥‡ à¤²à¤¿à¤ à¤¹à¥ˆ, à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¥€à¤¯ à¤¸à¤²à¤¾à¤¹ à¤¨à¤¹à¥€à¤‚à¥¤ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯à¤•à¤°à¥à¤®à¥€ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¸à¤¤à¥à¤¯à¤¾à¤ªà¤¿à¤¤ à¤•à¤° à¤…à¤ªà¤¨à¥€ à¤¨à¥ˆà¤¦à¤¾à¤¨à¤¿à¤• â€‹â€‹à¤®à¥‚à¤²à¥à¤¯à¤¾à¤‚à¤•à¤¨ à¤•à¤°à¥‡à¤‚à¥¤ MYQERâ„¢ à¤‡à¤¨ à¤¡à¤¾à¤Ÿà¤¾ à¤ªà¤° à¤†à¤§à¤¾à¤°à¤¿à¤¤ à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¨à¤¿à¤°à¥à¤£à¤¯à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤œà¤¼à¤¿à¤®à¥à¤®à¥‡à¤¦à¤¾à¤° à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¥¤ à¤¹à¤®à¥‡à¤¶à¤¾ à¤¯à¥‹à¤—à¥à¤¯ à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤•à¥‹à¤‚ à¤¸à¥‡ à¤¸à¤²à¤¾à¤¹ à¤²à¥‡à¤‚à¥¤",
      },
      ar: {
        online: "Ù…ØªØµÙ„",
        logout: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
        worksOffline: 'ØªÙÙ†Ø·Ù‚ "Ù…Ø§ÙŠ ÙƒÙŠØ±" â€¢ ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª',
        medDisclaimerTitle: "Ø¥Ø®Ù„Ø§Ø¡ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø·Ø¨ÙŠØ©",
        medDisclaimerBody:
          "Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆÙ„Ø§ ØªÙØ¹Ø¯ Ù†ØµÙŠØ­Ø© Ø·Ø¨ÙŠØ©. ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ¥Ø¬Ø±Ø§Ø¡ ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙ‡Ù… Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ©. Ù„Ø§ ØªØªØ­Ù…Ù„ MYQERâ„¢ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ø³ØªØ´Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù…Ø®ØªØµÙŠÙ† Ù…Ø¤Ù‡Ù„ÙŠÙ†.",
      },
      zh: {
        online: "åœ¨çº¿",
        logout: "é€€å‡ºç™»å½•",
        worksOffline: 'è¯»ä½œâ€œmy careâ€ â€¢ ç¦»çº¿å¯ç”¨',
        medDisclaimerTitle: "åŒ»ç–—å…è´£å£°æ˜",
        medDisclaimerBody:
          "æ­¤ä¿¡æ¯ä»…ä¾›ç´§æ€¥æƒ…å†µä¸‹å‚è€ƒï¼Œä¸æ„æˆåŒ»ç–—å»ºè®®ã€‚åŒ»æŠ¤äººå‘˜åº”ç‹¬ç«‹æ ¸å®å¹¶åšå‡ºä¸´åºŠåˆ¤æ–­ã€‚MYQERâ„¢ä¸å¯¹åŸºäºæ­¤æ•°æ®åšå‡ºçš„åŒ»ç–—å†³å®šè´Ÿè´£ã€‚è¯·å§‹ç»ˆå’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚",
      },
      hu: {
        online: "ElÃ©rhetÅ‘",
        logout: "KijelentkezÃ©s",
        worksOffline: 'KiejtÃ©s: "my care" â€¢ Offline is mÅ±kÃ¶dik',
        medDisclaimerTitle: "Orvosi nyilatkozat",
        medDisclaimerBody:
          "Az informÃ¡ciÃ³ csak sÃ¼rgÅ‘ssÃ©gi tÃ¡jÃ©koztatÃ¡s, nem minÅ‘sÃ¼l orvosi tanÃ¡csnak. Az egÃ©szsÃ©gÃ¼gyi szakembereknek Ã¶nÃ¡llÃ³an kell ellenÅ‘rizniÃ¼k Ã©s Ã©rtÃ©kelniÃ¼k. A MYQERâ„¢ nem felel az ezen adatokon alapulÃ³ dÃ¶ntÃ©sekÃ©rt. Mindig kÃ©rjen tanÃ¡csot szakembertÅ‘l.",
      },
      ro: {
        online: "Online",
        logout: "Deconectare",
        worksOffline: 'Se pronunÈ›Äƒ â€my careâ€ â€¢ FuncÈ›ioneazÄƒ offline',
        medDisclaimerTitle: "Declinare de responsabilitate medicalÄƒ",
        medDisclaimerBody:
          "InformaÈ›iile sunt doar pentru referinÈ›Äƒ Ã®n urgenÈ›e È™i nu reprezintÄƒ sfat medical. ProfesioniÈ™tii trebuie sÄƒ verifice datele È™i sÄƒ Ã®È™i facÄƒ propria evaluare clinicÄƒ. MYQERâ„¢ nu este responsabil pentru deciziile medicale bazate pe aceste date. ConsultaÈ›i Ã®ntotdeauna personal medical calificat.",
      }
    };

    const RTL_LANGS = new Set(["ar"]);

    // Helper: set lang + dir on <html>
    function setLanguage(lang) {
      const html = document.documentElement;
      html.lang = lang;
      html.dir = RTL_LANGS.has(lang) ? "rtl" : "ltr";
    }

    // Translate text content & attributes (data-i18n, data-i18n-placeholder, data-i18n-aria)
    function applyTranslations(lang) {
      const dict = i18n[lang] || i18n.en;

      // Text nodes
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        if (dict[key] !== undefined) el.textContent = dict[key];
      });

      // Placeholders
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const key = el.getAttribute("data-i18n-placeholder");
        if (dict[key] !== undefined) el.setAttribute("placeholder", dict[key]);
      });

      // aria-labels
      document.querySelectorAll("[data-i18n-aria]").forEach(el=>{
        const key = el.getAttribute("data-i18n-aria");
        if (dict[key] !== undefined) el.setAttribute("aria-label", dict[key]);
      });

      // <option> dynamic labels (weâ€™ll add per-section maps in their chunks)
      if (typeof translateDynamicOptions === "function") {
        translateDynamicOptions(lang);
      }
    }

    // Persist preference locally and in Supabase profile
    async function persistLanguage(lang) {
      try {
        localStorage.setItem("preferredLang", lang);
        if (window.sb && window.currentUser?.id) {
          await sb.from("profiles").update({ preferred_language: lang }).eq("id", currentUser.id);
        }
      } catch(e){ console.warn("Language persist failed:", e); }
    }

    // Initialize language on load
    async function initLanguage() {
      let lang = localStorage.getItem("preferredLang") || "en";

      // Try to pull from profile if available
      try {
        const { data:{ session } } = await sb.auth.getSession();
        if (session?.user?.id) {
          window.currentUser = session.user;
          const { data: profile } = await sb.from("profiles")
            .select("preferred_language").eq("id", session.user.id).single();
          if (profile?.preferred_language) lang = profile.preferred_language;
        }
      } catch(e){ /* ignore and use local */ }

      setLanguage(lang);
      applyTranslations(lang);

      const sel = document.getElementById("languageSelect");
      if (sel) sel.value = lang;

      // Keep status dot text updated
      const onlineSpan = document.querySelector('[data-i18n="online"]');
      if (onlineSpan) onlineSpan.textContent = (i18n[lang]||i18n.en).online;
    }

    // Public handler for <select>
    async function onLanguageChange(e){
      const lang = e.target.value;
      setLanguage(lang);
      applyTranslations(lang);
      await persistLanguage(lang);
    }

    // Weâ€™ll call initLanguage() after DOMContentLoaded
  </script>
</head>

<body>
  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header class="header-glass sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="text-3xl font-black text-slate-900">
            MYQ<span class="brand-red">ER</span><span class="text-lg">â„¢</span>
          </div>
          <div class="hidden sm:block">
            <div class="text-xs text-gray-500" data-i18n="worksOffline">
              Pronounced "my care" â€¢ Works offline
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <div class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span data-i18n="online">Online</span>
            </div>
          </div>

          <select id="languageSelect" class="text-sm border border-gray-300 rounded-lg px-3 py-2 bg-white">
            <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
            <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
            <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
            <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
            <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
            <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
            <option value="hu">ğŸ‡­ğŸ‡º Magyar</option>
            <option value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</option>
          </select>

          <button id="logoutBtn" class="btn-tertiary" data-i18n="logout">
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Medical Disclaimer -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
    <div class="disclaimer">
      <div class="flex items-start space-x-3">
        <div class="flex-shrink-0">
          <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div>
          <div class="font-bold text-amber-800 text-lg mb-2" data-i18n="medDisclaimerTitle">
            Medical Disclaimer
          </div>
          <div class="text-sm text-amber-700 leading-relaxed" data-i18n="medDisclaimerBody">
            This information is for emergency reference only and does not constitute medical advice. Healthcare
            professionals must independently verify all medical information and make their own clinical assessments.
            MYQERâ„¢ is not responsible for medical decisions made based on this data. Always consult with qualified
            healthcare providers for medical advice.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Attach language change & initialize
    document.addEventListener("DOMContentLoaded", () => {
      const sel = document.getElementById("languageSelect");
      sel.addEventListener("change", onLanguageChange);
      initLanguage();
    });

    // Logout wiring (works with your Supabase session)
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const { data:{ session } } = await sb.auth.getSession();
        if (!session) { window.location.replace('index.html'); return; }
        window.currentUser = session.user;
      } catch(e){ window.location.replace('index.html'); }

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          if (confirm("Are you sure you want to logout?")) {
            try {
              await sb.auth.signOut();
              window.location.replace("index.html");
            } catch (err) {
              showToast("Logout failed", "error");
            }
          }
        });
      }
    });

    // Minimal toast (full version later in chunk that handles all messages)
    function showToast(msg,type="info"){
      const t=document.getElementById("toast");
      t.className="toast "+type; t.textContent=msg;
      requestAnimationFrame(()=>{ t.classList.add("show"); });
      setTimeout(()=> t.classList.remove("show"), 2200);
    }

    // Stubâ€”will be expanded in later chunks for selects (relationships, life support, etc.)
    function translateDynamicOptions(lang){ /* filled per-section */ }
  </script>
  <!-- === Profile Completion (progress ring) === -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="glass-card p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-xl font-bold text-slate-900" data-i18n="profileCompletionTitle">Profile Completion</h2>
        <p class="text-sm text-gray-600" data-i18n="profileCompletionSub">Complete your profile to generate your emergency QR code</p>
      </div>
      <div class="flex items-center space-x-4">
        <svg class="progress-ring" width="60" height="60" viewBox="0 0 60 60" aria-hidden="true">
          <circle class="progress-ring-circle" cx="30" cy="30" r="28" stroke="#E5E7EB" stroke-width="4" fill="none"></circle>
          <circle id="progressCircle" class="progress-ring-progress" cx="30" cy="30" r="28" stroke="var(--brand-red)" stroke-width="4" fill="none" stroke-linecap="round" stroke-dasharray="0 188.5"></circle>
        </svg>
        <div class="text-right">
          <div id="progressPercent" class="text-2xl font-bold text-slate-900">0%</div>
          <div class="text-xs text-gray-500" data-i18n="completeLabel">Complete</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div class="flex items-center space-x-2" id="checkIdentity">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="identityCheck">Identity</span>
      </div>
      <div class="flex items-center space-x-2" id="checkHealth">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="healthCheck">Health Profile</span>
      </div>
      <div class="flex items-center space-x-2" id="checkContacts">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="iceCheck">ICE Contacts</span>
      </div>
      <div class="flex items-center space-x-2" id="checkCode">
        <div class="w-4 h-4 rounded-full bg-gray-300"></div>
        <span class="text-gray-600" data-i18n="codeCheck">Emergency Code</span>
      </div>
    </div>
  </div>

  <!-- === Identity Card === -->
  <div class="glass-card p-8 mb-8">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-slate-900 mb-2" data-i18n="identityTitle">Identity Information</h2>
        <p class="text-gray-600" data-i18n="identitySub">These details help first responders confirm who you are and contact your emergency contacts.</p>
      </div>
      <div class="hidden md:block" aria-hidden="true">
        <svg class="w-12 h-12 text-green-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Full Name -->
      <div>
        <label class="form-label" data-i18n="fullNameLabel">Full Legal Name *</label>
        <input id="fullName" type="text" class="form-input" maxlength="100"
               data-i18n-placeholder="fullNamePh"
               placeholder="Enter your full legal name">
        <div class="text-xs text-gray-500 mt-1" data-i18n="fullNameHelp">As it appears on your ID</div>
      </div>

      <!-- Date of Birth -->
      <div>
        <label class="form-label" data-i18n="dobLabel">Date of Birth *</label>
        <input id="dateOfBirth" type="text" class="form-input"
               inputmode="numeric" pattern="\\d{2}/\\d{2}/\\d{4}"
               data-i18n-placeholder="dobPh"
               placeholder="DD/MM/YYYY">
        <div class="text-xs text-gray-500 mt-1" data-i18n="dobHelp">Format: DD/MM/YYYY</div>
      </div>

      <!-- Country -->
      <div>
        <label class="form-label" data-i18n="countryLabel">Country of Residence *</label>
        <select id="country" class="form-select" aria-label="Country"></select>
      </div>

      <!-- National Health ID -->
      <div class="md:col-span-2 lg:col-span-3">
        <label class="form-label" data-i18n="nhidLabel">National Health ID</label>
        <input id="nationalHealthId" type="text" class="form-input"
               data-i18n-placeholder="nhidPh"
               placeholder="NHS Number, SSN, etc.">
        <div class="text-xs text-gray-500 mt-1" data-i18n="nhidHelp">NHS Number, Social Security, etc.</div>
      </div>
    </div>

    <div class="flex items-center justify-center mt-8 pt-6 border-t border-gray-200">
      <div class="flex items-center space-x-2 text-sm text-gray-500">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <span data-i18n="autosaves">Auto-saves as you type</span>
      </div>
    </div>
  </div>
</main>

<script>
/* ---------- Chunk 2: Identity + Progress logic + i18n keys ---------- */

// Extend i18n dictionary with Identity/Progress keys
Object.assign(i18n.en, {
  profileCompletionTitle:"Profile Completion",
  profileCompletionSub:"Complete your profile to generate your emergency QR code",
  completeLabel:"Complete",
  identityCheck:"Identity",
  healthCheck:"Health Profile",
  iceCheck:"ICE Contacts",
  codeCheck:"Emergency Code",

  identityTitle:"Identity Information",
  identitySub:"These details help first responders confirm who you are and contact your emergency contacts.",
  fullNameLabel:"Full Legal Name *",
  fullNamePh:"Enter your full legal name",
  fullNameHelp:"As it appears on your ID",
  dobLabel:"Date of Birth *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"Format: DD/MM/YYYY",
  countryLabel:"Country of Residence *",
  nhidLabel:"National Health ID",
  nhidPh:"NHS Number, SSN, etc.",
  nhidHelp:"NHS Number, Social Security, etc.",
  autosaves:"Auto-saves as you type",
  toastSaved:"Saved",
  toastSaveError:"Failed to save",
});

Object.assign(i18n.es, {
  profileCompletionTitle:"Progreso del perfil",
  profileCompletionSub:"Complete su perfil para generar su cÃ³digo QR de emergencia",
  completeLabel:"Completado",
  identityCheck:"Identidad",
  healthCheck:"Perfil de salud",
  iceCheck:"Contactos ICE",
  codeCheck:"CÃ³digo de emergencia",

  identityTitle:"InformaciÃ³n de identidad",
  identitySub:"Estos datos ayudan a confirmar su identidad y contactar a sus personas de emergencia.",
  fullNameLabel:"Nombre legal completo *",
  fullNamePh:"Escriba su nombre legal completo",
  fullNameHelp:"Tal como aparece en su documento",
  dobLabel:"Fecha de nacimiento *",
  dobPh:"DD/MM/AAAA",
  dobHelp:"Formato: DD/MM/AAAA",
  countryLabel:"PaÃ­s de residencia *",
  nhidLabel:"IdentificaciÃ³n sanitaria nacional",
  nhidPh:"NÂ° de salud, SSN, etc.",
  nhidHelp:"NHS, Seguro Social, etc.",
  autosaves:"Se guarda automÃ¡ticamente",
  toastSaved:"Guardado",
  toastSaveError:"Error al guardar",
});

Object.assign(i18n.fr, {
  profileCompletionTitle:"AchÃ¨vement du profil",
  profileCompletionSub:"ComplÃ©tez votre profil pour gÃ©nÃ©rer votre QR dâ€™urgence",
  completeLabel:"TerminÃ©",
  identityCheck:"IdentitÃ©",
  healthCheck:"Profil de santÃ©",
  iceCheck:"Contacts ICE",
  codeCheck:"Code dâ€™urgence",

  identityTitle:"Informations dâ€™identitÃ©",
  identitySub:"Ces dÃ©tails aident les secours Ã  confirmer votre identitÃ© et Ã  contacter vos proches.",
  fullNameLabel:"Nom lÃ©gal complet *",
  fullNamePh:"Saisissez votre nom lÃ©gal complet",
  fullNameHelp:"Tel quâ€™indiquÃ© sur votre piÃ¨ce dâ€™identitÃ©",
  dobLabel:"Date de naissance *",
  dobPh:"JJ/MM/AAAA",
  dobHelp:"Format : JJ/MM/AAAA",
  countryLabel:"Pays de rÃ©sidence *",
  nhidLabel:"Identifiant de santÃ© national",
  nhidPh:"NumÃ©ro NHS, sÃ©cu, etc.",
  nhidHelp:"NHS, SÃ©curitÃ© sociale, etc.",
  autosaves:"Enregistrement automatique",
  toastSaved:"EnregistrÃ©",
  toastSaveError:"Ã‰chec de lâ€™enregistrement",
});

Object.assign(i18n.de, {
  profileCompletionTitle:"Profilfortschritt",
  profileCompletionSub:"Profil ausfÃ¼llen, um den Notfall-QR-Code zu erhalten",
  completeLabel:"VollstÃ¤ndig",
  identityCheck:"IdentitÃ¤t",
  healthCheck:"Gesundheitsprofil",
  iceCheck:"Notfallkontakte",
  codeCheck:"Notfallcode",

  identityTitle:"IdentitÃ¤tsdaten",
  identitySub:"Hilft EinsatzkrÃ¤ften, Ihre IdentitÃ¤t zu bestÃ¤tigen und Kontakte zu erreichen.",
  fullNameLabel:"VollstÃ¤ndiger Name *",
  fullNamePh:"VollstÃ¤ndigen amtlichen Namen eingeben",
  fullNameHelp:"Wie auf Ihrem Ausweis",
  dobLabel:"Geburtsdatum *",
  dobPh:"TT/MM/JJJJ",
  dobHelp:"Format: TT/MM/JJJJ",
  countryLabel:"Wohnsitzland *",
  nhidLabel:"Nationale Gesundheits-ID",
  nhidPh:"NHS-Nummer, SSN, etc.",
  nhidHelp:"NHS-Nummer, Sozialversicherung usw.",
  autosaves:"Speichert automatisch",
  toastSaved:"Gespeichert",
  toastSaveError:"Speichern fehlgeschlagen",
});

Object.assign(i18n.it, {
  profileCompletionTitle:"Completamento profilo",
  profileCompletionSub:"Completa il profilo per generare il QR dâ€™emergenza",
  completeLabel:"Completato",
  identityCheck:"IdentitÃ ",
  healthCheck:"Profilo sanitario",
  iceCheck:"Contatti ICE",
  codeCheck:"Codice dâ€™emergenza",

  identityTitle:"Informazioni dâ€™identitÃ ",
  identitySub:"Aiuta i soccorritori a confermare la tua identitÃ  e contattare i referenti.",
  fullNameLabel:"Nome legale completo *",
  fullNamePh:"Inserisci il tuo nome legale completo",
  fullNameHelp:"Come sul documento",
  dobLabel:"Data di nascita *",
  dobPh:"GG/MM/AAAA",
  dobHelp:"Formato: GG/MM/AAAA",
  countryLabel:"Paese di residenza *",
  nhidLabel:"ID sanitario nazionale",
  nhidPh:"NÂ° sanitario, SSN, ecc.",
  nhidHelp:"NHS, Codice fiscale/SSN, ecc.",
  autosaves:"Salvataggio automatico",
  toastSaved:"Salvato",
  toastSaveError:"Errore di salvataggio",
});

Object.assign(i18n.hi, {
  profileCompletionTitle:"à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤ªà¥‚à¤°à¥à¤£à¤¤à¤¾",
  profileCompletionSub:"à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ QR à¤¬à¤¨à¤¾à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤ªà¥‚à¤°à¥€ à¤•à¤°à¥‡à¤‚",
  completeLabel:"à¤ªà¥‚à¤°à¥à¤£",
  identityCheck:"à¤ªà¤¹à¤šà¤¾à¤¨",
  healthCheck:"à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤²",
  iceCheck:"à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤•",
  codeCheck:"à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤•à¥‹à¤¡",

  identityTitle:"à¤ªà¤¹à¤šà¤¾à¤¨ à¤¸à¤‚à¤¬à¤‚à¤§à¥€ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€",
  identitySub:"à¤†à¤ªà¤•à¥€ à¤ªà¤¹à¤šà¤¾à¤¨ à¤•à¥€ à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤µ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¹à¥‡à¤¤à¥ à¤†à¤µà¤¶à¥à¤¯à¤• à¤µà¤¿à¤µà¤°à¤£à¥¤",
  fullNameLabel:"à¤ªà¥‚à¤°à¤¾ à¤µà¥ˆà¤§ à¤¨à¤¾à¤® *",
  fullNamePh:"à¤…à¤ªà¤¨à¤¾ à¤µà¥ˆà¤§ à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤® à¤²à¤¿à¤–à¥‡à¤‚",
  fullNameHelp:"à¤œà¥ˆà¤¸à¤¾ à¤†à¤ªà¤•à¥‡ ID à¤ªà¤° à¤¹à¥ˆ",
  dobLabel:"à¤œà¤¨à¥à¤® à¤¤à¤¿à¤¥à¤¿ *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"à¤ªà¥à¤°à¤¾à¤°à¥‚à¤ª: DD/MM/YYYY",
  countryLabel:"à¤¨à¤¿à¤µà¤¾à¤¸ à¤¦à¥‡à¤¶ *",
  nhidLabel:"à¤°à¤¾à¤·à¥à¤Ÿà¥à¤°à¥€à¤¯ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ ID",
  nhidPh:"NHS, SSN, à¤†à¤¦à¤¿",
  nhidHelp:"NHS à¤¨à¤‚à¤¬à¤°, à¤¸à¤¾à¤®à¤¾à¤œà¤¿à¤• à¤¸à¥à¤°à¤•à¥à¤·à¤¾, à¤†à¤¦à¤¿",
  autosaves:"à¤Ÿà¤¾à¤‡à¤ª à¤•à¤°à¤¤à¥‡ à¤¹à¥€ à¤¸à¤¹à¥‡à¤œà¤¤à¤¾ à¤¹à¥ˆ",
  toastSaved:"à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾",
  toastSaveError:"à¤¸à¤¹à¥‡à¤œà¤¨à¥‡ à¤®à¥‡à¤‚ à¤µà¤¿à¤«à¤²",
});

Object.assign(i18n.ar, {
  profileCompletionTitle:"Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
  profileCompletionSub:"Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦",
  completeLabel:"Ù…ÙƒØªÙ…Ù„",
  identityCheck:"Ø§Ù„Ù‡ÙˆÙŠØ©",
  healthCheck:"Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ",
  iceCheck:"Ø¬Ù‡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",
  codeCheck:"Ø±Ù…Ø² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",

  identityTitle:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ©",
  identitySub:"ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ¬ÙŠØ¨ÙŠÙ† Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ù‡ÙˆÙŠØªÙƒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¬Ù‡Ø§ØªÙƒ.",
  fullNameLabel:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ *",
  fullNamePh:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„",
  fullNameHelp:"ÙƒÙ…Ø§ ÙÙŠ Ù‡ÙˆÙŠØªÙƒ",
  dobLabel:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"Ø§Ù„ØµÙŠØºØ©: DD/MM/YYYY",
  countryLabel:"Ø¨Ù„Ø¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© *",
  nhidLabel:"Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ØµØ­Ø© Ø§Ù„ÙˆØ·Ù†ÙŠ",
  nhidPh:"Ø±Ù‚Ù… NHS Ø£Ùˆ Ù…Ø§ ÙŠØ¹Ø§Ø¯Ù„Ù‡",
  nhidHelp:"NHSØŒ Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ... Ø¥Ù„Ø®",
  autosaves:"ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§",
  toastSaved:"ØªÙ… Ø§Ù„Ø­ÙØ¸",
  toastSaveError:"ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",
});

Object.assign(i18n.zh, {
  profileCompletionTitle:"èµ„æ–™å®Œæˆåº¦",
  profileCompletionSub:"å®Œæˆèµ„æ–™ä»¥ç”Ÿæˆåº”æ€¥äºŒç»´ç ",
  completeLabel:"å®Œæˆ",
  identityCheck:"èº«ä»½",
  healthCheck:"å¥åº·èµ„æ–™",
  iceCheck:"ç´§æ€¥è”ç³»äºº",
  codeCheck:"åº”æ€¥ä»£ç ",

  identityTitle:"èº«ä»½ä¿¡æ¯",
  identitySub:"å¸®åŠ©æ•‘æ´äººå‘˜ç¡®è®¤èº«ä»½å¹¶è”ç³»ç´§æ€¥è”ç³»äººã€‚",
  fullNameLabel:"æ³•å®šå§“å *",
  fullNamePh:"è¾“å…¥æ‚¨çš„æ³•å®šå…¨å",
  fullNameHelp:"ä¸è¯ä»¶ä¸€è‡´",
  dobLabel:"å‡ºç”Ÿæ—¥æœŸ *",
  dobPh:"DD/MM/YYYY",
  dobHelp:"æ ¼å¼ï¼šDD/MM/YYYY",
  countryLabel:"å±…ä½å›½å®¶ *",
  nhidLabel:"å›½å®¶å¥åº·ID",
  nhidPh:"NHSå·ã€ç¤¾ä¿å·ç­‰",
  nhidHelp:"NHSã€ç¤¾ä¿å·ç­‰",
  autosaves:"è¾“å…¥å³è‡ªåŠ¨ä¿å­˜",
  toastSaved:"å·²ä¿å­˜",
  toastSaveError:"ä¿å­˜å¤±è´¥",
});

Object.assign(i18n.hu, {
  profileCompletionTitle:"ProfilkÃ©szÃ¼ltsÃ©g",
  profileCompletionSub:"TÃ¶ltsd ki a profilt a vÃ©sz-QR kÃ³dhoz",
  completeLabel:"KÃ©sz",
  identityCheck:"SzemÃ©lyazonossÃ¡g",
  healthCheck:"EgÃ©szsÃ©gÃ¼gyi profil",
  iceCheck:"VÃ©szhelyzeti kontaktok",
  codeCheck:"VÃ©sz-kÃ³d",

  identityTitle:"SzemÃ©lyes adatok",
  identitySub:"SegÃ­t azonosÃ­tani Ã©s elÃ©rni a kapcsolattartÃ³kat.",
  fullNameLabel:"Teljes hivatalos nÃ©v *",
  fullNamePh:"Add meg a hivatalos neved",
  fullNameHelp:"SzemÃ©lyi okmÃ¡ny szerint",
  dobLabel:"SzÃ¼letÃ©si dÃ¡tum *",
  dobPh:"NN/HH/Ã‰Ã‰Ã‰Ã‰",
  dobHelp:"FormÃ¡tum: NN/HH/Ã‰Ã‰Ã‰Ã‰",
  countryLabel:"LakÃ³hely szerinti orszÃ¡g *",
  nhidLabel:"Nemzeti egÃ©szsÃ©gÃ¼gyi azonosÃ­tÃ³",
  nhidPh:"NHS, TAJ stb.",
  nhidHelp:"NHS, tÃ¡rsadalombiztosÃ­tÃ¡s stb.",
  autosaves:"Automatikus mentÃ©s",
  toastSaved:"Mentve",
  toastSaveError:"Sikertelen mentÃ©s",
});

Object.assign(i18n.ro, {
  profileCompletionTitle:"Completare profil",
  profileCompletionSub:"CompleteazÄƒ profilul pentru a genera codul QR de urgenÈ›Äƒ",
  completeLabel:"Complet",
  identityCheck:"Identitate",
  healthCheck:"Profil medical",
  iceCheck:"Contacte ICE",
  codeCheck:"Cod de urgenÈ›Äƒ",

  identityTitle:"InformaÈ›ii de identitate",
  identitySub:"AjutÄƒ salvatorii sÄƒ Ã®È›i confirme identitatea È™i sÄƒ contacteze apropiaÈ›ii.",
  fullNameLabel:"Nume legal complet *",
  fullNamePh:"Introdu numele legal complet",
  fullNameHelp:"Ca pe actul de identitate",
  dobLabel:"Data naÈ™terii *",
  dobPh:"ZZ/LL/AAAA",
  dobHelp:"Format: ZZ/LL/AAAA",
  countryLabel:"Èšara de reÈ™edinÈ›Äƒ *",
  nhidLabel:"ID naÈ›ional de sÄƒnÄƒtate",
  nhidPh:"NumÄƒr NHS, CNP, etc.",
  nhidHelp:"NHS, asigurÄƒri, etc.",
  autosaves:"Se salveazÄƒ automat",
  toastSaved:"Salvat",
  toastSaveError:"Eroare la salvare",
});

// Basic country list (short, neutral). You can expand later.
const COUNTRIES = [
  {v:"", t:{en:"Select your country", es:"Seleccione su paÃ­s", fr:"SÃ©lectionnez votre pays", de:"Land wÃ¤hlen",
             it:"Seleziona il tuo paese", hi:"à¤…à¤ªà¤¨à¤¾ à¤¦à¥‡à¤¶ à¤šà¥à¤¨à¥‡à¤‚", ar:"Ø§Ø®ØªØ± Ø¨Ù„Ø¯Ùƒ", zh:"é€‰æ‹©æ‚¨çš„å›½å®¶", hu:"VÃ¡lassz orszÃ¡got", ro:"SelecteazÄƒ È›ara"}},
  {v:"US", t:{en:"ğŸ‡ºğŸ‡¸ United States", es:"ğŸ‡ºğŸ‡¸ Estados Unidos", fr:"ğŸ‡ºğŸ‡¸ Ã‰tats-Unis", de:"ğŸ‡ºğŸ‡¸ Vereinigte Staaten", it:"ğŸ‡ºğŸ‡¸ Stati Uniti",
             hi:"ğŸ‡ºğŸ‡¸ à¤¸à¤‚à¤¯à¥à¤•à¥à¤¤ à¤°à¤¾à¤œà¥à¤¯", ar:"ğŸ‡ºğŸ‡¸ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©", zh:"ğŸ‡ºğŸ‡¸ ç¾å›½", hu:"ğŸ‡ºğŸ‡¸ EgyesÃ¼lt Ãllamok", ro:"ğŸ‡ºğŸ‡¸ Statele Unite"}},
  {v:"GB", t:{en:"ğŸ‡¬ğŸ‡§ United Kingdom", es:"ğŸ‡¬ğŸ‡§ Reino Unido", fr:"ğŸ‡¬ğŸ‡§ Royaume-Uni", de:"ğŸ‡¬ğŸ‡§ Vereinigtes KÃ¶nigreich", it:"ğŸ‡¬ğŸ‡§ Regno Unito",
             hi:"ğŸ‡¬ğŸ‡§ à¤¯à¥‚à¤¨à¤¾à¤‡à¤Ÿà¥‡à¤¡ à¤•à¤¿à¤‚à¤—à¤¡à¤®", ar:"ğŸ‡¬ğŸ‡§ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©", zh:"ğŸ‡¬ğŸ‡§ è‹±å›½", hu:"ğŸ‡¬ğŸ‡§ EgyesÃ¼lt KirÃ¡lysÃ¡g", ro:"ğŸ‡¬ğŸ‡§ Regatul Unit"}},
  {v:"CA", t:{en:"ğŸ‡¨ğŸ‡¦ Canada", es:"ğŸ‡¨ğŸ‡¦ CanadÃ¡", fr:"ğŸ‡¨ğŸ‡¦ Canada", de:"ğŸ‡¨ğŸ‡¦ Kanada", it:"ğŸ‡¨ğŸ‡¦ Canada", hi:"ğŸ‡¨ğŸ‡¦ à¤•à¤¨à¤¾à¤¡à¤¾", ar:"ğŸ‡¨ğŸ‡¦ ÙƒÙ†Ø¯Ø§", zh:"ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§", hu:"ğŸ‡¨ğŸ‡¦ Kanada", ro:"ğŸ‡¨ğŸ‡¦ Canada"}},
  {v:"DE", t:{en:"ğŸ‡©ğŸ‡ª Germany", es:"ğŸ‡©ğŸ‡ª Alemania", fr:"ğŸ‡©ğŸ‡ª Allemagne", de:"ğŸ‡©ğŸ‡ª Deutschland", it:"ğŸ‡©ğŸ‡ª Germania", hi:"ğŸ‡©ğŸ‡ª à¤œà¤°à¥à¤®à¤¨à¥€", ar:"ğŸ‡©ğŸ‡ª Ø£Ù„Ù…Ø§Ù†ÙŠØ§", zh:"ğŸ‡©ğŸ‡ª å¾·å›½", hu:"ğŸ‡©ğŸ‡ª NÃ©metorszÃ¡g", ro:"ğŸ‡©ğŸ‡ª Germania"}},
  {v:"FR", t:{en:"ğŸ‡«ğŸ‡· France", es:"ğŸ‡«ğŸ‡· Francia", fr:"ğŸ‡«ğŸ‡· France", de:"ğŸ‡«ğŸ‡· Frankreich", it:"ğŸ‡«ğŸ‡· Francia", hi:"ğŸ‡«ğŸ‡· à¤«à¤¼à¥à¤°à¤¾à¤‚à¤¸", ar:"ğŸ‡«ğŸ‡· ÙØ±Ù†Ø³Ø§", zh:"ğŸ‡«ğŸ‡· æ³•å›½", hu:"ğŸ‡«ğŸ‡· FranciaorszÃ¡g", ro:"ğŸ‡«ğŸ‡· FranÈ›a"}},
];

// Fill & translate country select
function fillCountrySelect(lang){
  const sel=document.getElementById("country");
  if(!sel) return;
  sel.innerHTML = "";
  const l = i18n[lang] ? lang : "en";
  COUNTRIES.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o.v;
    opt.textContent=o.t[l];
    sel.appendChild(opt);
  });
}

// Hook into global translator
const _origTranslateDynamicOptions = translateDynamicOptions;
translateDynamicOptions = function(lang){
  fillCountrySelect(lang);
  if (typeof _origTranslateDynamicOptions === "function") _origTranslateDynamicOptions(lang);
};

// Identity: mask DOB as DD/MM/YYYY
(function setupDOBMask(){
  document.addEventListener("input", (e)=>{
    if(e.target && e.target.id==="dateOfBirth"){
      let v = e.target.value.replace(/\D/g,"").slice(0,8);
      if (v.length>=5) v = v.slice(0,2)+"/"+v.slice(2,4)+"/"+v.slice(4);
      else if (v.length>=3) v = v.slice(0,2)+"/"+v.slice(2);
      e.target.value = v;
    }
  });
})();

// Debounced saver
let saveTimer=null;
function debounceSave(fn, delay=600){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(fn, delay);
}

// Save Identity to Supabase
async function saveIdentity(){
  try{
    const full_name = (document.getElementById("fullName")?.value||"").trim();
    const date_of_birth = document.getElementById("dateOfBirth")?.value||"";
    const country = document.getElementById("country")?.value||"";
    const national_health_id = document.getElementById("nationalHealthId")?.value||"";

    if (!window.currentUser?.id) return;

    const payload = {
      id: currentUser.id,
      email: currentUser.email,
      full_name, date_of_birth, country, national_health_id
    };

    const { error } = await sb.from("profiles").upsert(payload);
    if (error) throw error;

    updateProfileProgress();
    showToast( (i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(err){
    console.error("saveIdentity", err);
    showToast( (i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

// Load Identity on start
async function loadIdentity(){
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if (!session) { window.location.replace("index.html"); return; }
    window.currentUser = session.user;

    const { data: profile, error } = await sb
      .from("profiles").select("*").eq("id", currentUser.id).single();

    if (!error && profile){
      document.getElementById("fullName").value = profile.full_name||"";
      document.getElementById("dateOfBirth").value = profile.date_of_birth||"";
      // country select will be filled after language init; set value after a tick:
      setTimeout(()=>{ const c=document.getElementById("country"); if(c) c.value = profile.country||""; }, 0);
      document.getElementById("nationalHealthId").value = profile.national_health_id||"";
    }
  }catch(e){
    console.warn("loadIdentity", e);
  }finally{
    updateProfileProgress();
  }
}

// Progress calculation (Identity part here; Health/ICE/Code will update later too)
function isIdentityComplete(){
  const name = (document.getElementById("fullName")?.value||"").trim();
  const dob = document.getElementById("dateOfBirth")?.value||"";
  const country = document.getElementById("country")?.value||"";
  return Boolean(name && dob && country);
}

function updateCheckIndicator(id, ok){
  const root=document.getElementById(id); if(!root) return;
  const dot=root.querySelector("div");
  const label=root.querySelector("span");
  if (ok){
    dot.className="w-4 h-4 rounded-full bg-green-500";
    label.className="text-green-700 font-medium";
  }else{
    dot.className="w-4 h-4 rounded-full bg-gray-300";
    label.className="text-gray-600";
  }
}

// Stubs that later chunks will update:
window.healthComplete = false;   // updated in Health chunk
window.iceComplete = false;      // updated in ICE chunk
window.codePresent  = false;     // updated in QR chunk

function updateProfileProgress(){
  const checks = {
    identity: isIdentityComplete(),
    health: window.healthComplete,
    contacts: window.iceComplete,
    code: window.codePresent
  };
  updateCheckIndicator("checkIdentity", checks.identity);
  updateCheckIndicator("checkHealth", checks.health);
  updateCheckIndicator("checkContacts", checks.contacts);
  updateCheckIndicator("checkCode", checks.code);

  const done = Object.values(checks).filter(Boolean).length;
  const pct = Math.round((done/4)*100);

  const circ = document.getElementById("progressCircle");
  const txt  = document.getElementById("progressPercent");
  const C = 2*Math.PI*28;
  if (circ) circ.setAttribute("stroke-dasharray", `${(pct/100)*C} ${C}`);
  if (txt)  txt.textContent = `${pct}%`;
}

// Wire inputs for autosave + progress
(function wireIdentityInputs(){
  const ids = ["fullName","dateOfBirth","country","nationalHealthId"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    ["input","change","blur"].forEach(evt=>{
      el.addEventListener(evt, ()=>debounceSave(()=>{ saveIdentity(); updateProfileProgress(); }, 700));
    });
  });
})();

// After DOM is ready: load identity (after language init filled selects)
document.addEventListener("DOMContentLoaded", async ()=>{
  // ensure language applied has filled country options
  const lang=document.documentElement.lang||"en";
  fillCountrySelect(lang);
  await loadIdentity();
  updateProfileProgress();
});
</script>
  <!-- === Health Profile Card === -->
<div class="glass-card p-8 mb-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2" data-i18n="healthTitle">Health Profile</h2>
      <p class="text-gray-600" data-i18n="healthSub">Critical medical information that appears on your emergency card. Keep this current and accurate.</p>
    </div>
    <div class="hidden md:block" aria-hidden="true">
      <svg class="w-12 h-12 text-red-500" fill="currentColor" viewBox="0 0 20 20">
        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
      </svg>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Blood Type -->
    <div>
      <label class="form-label" data-i18n="bloodTypeLabel">Blood Type</label>
      <select id="bloodType" class="form-select" aria-label="Blood type">
        <option value="" data-i18n="bloodUnknown">Unknown / Not tested</option>
        <option value="A+">A+ (A Positive)</option>
        <option value="A-">A- (A Negative)</option>
        <option value="B+">B+ (B Positive)</option>
        <option value="B-">B- (B Negative)</option>
        <option value="AB+">AB+ (AB Positive)</option>
        <option value="AB-">AB- (AB Negative)</option>
        <option value="O+">O+ (O Positive)</option>
        <option value="O-">O- (O Negative)</option>
      </select>
      <div class="text-xs text-gray-500 mt-1" data-i18n="bloodHelp">Critical for blood transfusions</div>
    </div>

    <!-- Organ Donor -->
    <div>
      <label class="form-label" data-i18n="donorLabel">Organ Donor Status</label>
      <select id="organDonor" class="form-select" aria-label="Organ donor status">
        <option value="" data-i18n="donorNotSpecified">Not specified</option>
        <option value="true" data-i18n="donorYes">âœ… Yes - Registered organ donor</option>
        <option value="false" data-i18n="donorNo">âŒ No - Not an organ donor</option>
      </select>
      <div class="text-xs text-gray-500 mt-1" data-i18n="donorHelp">Check your driver's license or ID</div>
    </div>

    <!-- Life Support Preference -->
    <div>
      <label class="form-label" data-i18n="lifeSupportLabel">Life Support Preference</label>
      <select id="lifeSupportPref" class="form-select" aria-label="Life support preference">
        <option value="Full" data-i18n="lifeFull">Full Life Support - Use all measures</option>
        <option value="Limited" data-i18n="lifeLimited">Limited Life Support - Basic care only</option>
        <option value="Comfort" data-i18n="lifeComfort">Comfort Care Only - Pain management</option>
        <option value="DNR" data-i18n="lifeDnr">Do Not Resuscitate (DNR)</option>
      </select>
      <div class="text-xs text-gray-500 mt-1" data-i18n="lifeHelp">Your preference for end-of-life care</div>
    </div>

    <!-- Allergies -->
    <div class="md:col-span-2 lg:col-span-3">
      <label class="form-label">âš ï¸ <span data-i18n="allergiesLabel">Critical Allergies</span></label>
      <input id="allergiesInput" type="text" class="form-input"
             data-i18n-placeholder="allergiesPh"
             placeholder="Type allergy and press Enter (e.g., Penicillin, Shellfish, Latex, Morphine)">
      <div id="allergiesPills" class="flex flex-wrap gap-2 mt-3"></div>
      <div class="text-xs text-gray-500 mt-2" data-i18n="allergiesHelp">
        Include all drug, food, and environmental allergies that could cause severe reactions.
      </div>
    </div>

    <!-- Conditions -->
    <div class="md:col-span-2 lg:col-span-3">
      <label class="form-label" data-i18n="conditionsLabel">Medical Conditions</label>
      <input id="conditionsInput" type="text" class="form-input"
             data-i18n-placeholder="conditionsPh"
             placeholder="Type condition and press Enter (e.g., Diabetes, Hypertension, Asthma, Epilepsy)">
      <div id="conditionsPills" class="flex flex-wrap gap-2 mt-3"></div>
      <div class="text-xs text-gray-500 mt-2" data-i18n="conditionsHelp">
        Include chronic conditions, mental health conditions, and any ongoing medical issues.
      </div>
    </div>

    <!-- Medications -->
    <div class="md:col-span-2 lg:col-span-3">
      <label class="form-label" data-i18n="medicationsLabel">Current Medications</label>
      <input id="medicationsInput" type="text" class="form-input"
             data-i18n-placeholder="medicationsPh"
             placeholder="Type medication and press Enter (e.g., Insulin, Metformin, Lisinopril)">
      <div id="medicationsPills" class="flex flex-wrap gap-2 mt-3"></div>
      <div class="text-xs text-gray-500 mt-2" data-i18n="medicationsHelp">
        Include prescription medications, over-the-counter medications, and supplements you take regularly.
      </div>
    </div>
  </div>

  <div class="mt-8 p-4 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-start space-x-3">
      <svg class="w-5 h-5 text-red-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
      </svg>
      <div>
        <div class="font-semibold text-red-800 text-sm" data-i18n="criticalNoticeTitle">Critical Information Notice</div>
        <div class="text-red-700 text-sm mt-1" data-i18n="criticalNoticeBody">
          This information will be visible to emergency responders. Only include information that is medically necessary for emergency treatment.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Chunk 3: Health Profile + Pills + Autosave + i18n ---------- */

Object.assign(i18n.en, {
  healthTitle:"Health Profile",
  healthSub:"Critical medical information that appears on your emergency card. Keep this current and accurate.",
  bloodTypeLabel:"Blood Type",
  bloodUnknown:"Unknown / Not tested",
  bloodHelp:"Critical for blood transfusions",
  donorLabel:"Organ Donor Status",
  donorNotSpecified:"Not specified",
  donorYes:"âœ… Yes - Registered organ donor",
  donorNo:"âŒ No - Not an organ donor",
  donorHelp:"Check your driver's license or ID",
  lifeSupportLabel:"Life Support Preference",
  lifeFull:"Full Life Support - Use all measures",
  lifeLimited:"Limited Life Support - Basic care only",
  lifeComfort:"Comfort Care Only - Pain management",
  lifeDnr:"Do Not Resuscitate (DNR)",
  lifeHelp:"Your preference for end-of-life care",
  allergiesLabel:"Critical Allergies",
  allergiesPh:"Type allergy and press Enter (e.g., Penicillin, Shellfish, Latex, Morphine)",
  allergiesHelp:"Include all drug, food, and environmental allergies that could cause severe reactions.",
  conditionsLabel:"Medical Conditions",
  conditionsPh:"Type condition and press Enter (e.g., Diabetes, Hypertension, Asthma, Epilepsy)",
  conditionsHelp:"Include chronic conditions, mental health conditions, and any ongoing medical issues.",
  medicationsLabel:"Current Medications",
  medicationsPh:"Type medication and press Enter (e.g., Insulin, Metformin, Lisinopril)",
  medicationsHelp:"Include prescription medications, over-the-counter medications, and supplements you take regularly.",
  criticalNoticeTitle:"Critical Information Notice",
  criticalNoticeBody:"This information will be visible to emergency responders. Only include information that is medically necessary for emergency treatment.",
  pillDuplicate:'"{X}" is already added',
  removedX:"Removed {X}",
});

Object.assign(i18n.es, {
  healthTitle:"Perfil de salud",
  healthSub:"InformaciÃ³n mÃ©dica crÃ­tica que aparece en su tarjeta de emergencia.",
  bloodTypeLabel:"Grupo sanguÃ­neo",
  bloodUnknown:"Desconocido / No probado",
  bloodHelp:"CrÃ­tico para transfusiones",
  donorLabel:"Donante de Ã³rganos",
  donorNotSpecified:"No especificado",
  donorYes:"âœ… SÃ­ - Donante registrado",
  donorNo:"âŒ No - No es donante",
  donorHelp:"Verifique su licencia o ID",
  lifeSupportLabel:"Preferencia de soporte vital",
  lifeFull:"Soporte total - Todas las medidas",
  lifeLimited:"Soporte limitado - AtenciÃ³n bÃ¡sica",
  lifeComfort:"SÃ³lo confort - Control del dolor",
  lifeDnr:"No reanimar (DNR)",
  lifeHelp:"Su preferencia para cuidados al final de la vida",
  allergiesLabel:"Alergias crÃ­ticas",
  allergiesPh:"Escriba alergia y presione Enter (p. ej., Penicilina, Mariscos, LÃ¡tex, Morfina)",
  allergiesHelp:"Incluya fÃ¡rmacos, alimentos y ambientales severas.",
  conditionsLabel:"Enfermedades",
  conditionsPh:"Escriba enfermedad y presione Enter",
  conditionsHelp:"Incluya crÃ³nicas, salud mental y problemas activos.",
  medicationsLabel:"Medicaciones actuales",
  medicationsPh:"Escriba medicaciÃ³n y presione Enter",
  medicationsHelp:"Incluya recetados, OTC y suplementos.",
  criticalNoticeTitle:"Aviso de informaciÃ³n crÃ­tica",
  criticalNoticeBody:"Visible para los socorristas. Incluya solo lo necesario para el tratamiento.",
  pillDuplicate:'"{X}" ya estÃ¡ agregado',
  removedX:"Se eliminÃ³ {X}",
});

Object.assign(i18n.fr, {
  healthTitle:"Profil de santÃ©",
  healthSub:"Informations mÃ©dicales critiques affichÃ©es sur votre carte dâ€™urgence.",
  bloodTypeLabel:"Groupe sanguin",
  bloodUnknown:"Inconnu / Non testÃ©",
  bloodHelp:"Critique pour les transfusions",
  donorLabel:"Statut de donneur",
  donorNotSpecified:"Non prÃ©cisÃ©",
  donorYes:"âœ… Oui - Donneur enregistrÃ©",
  donorNo:"âŒ Non - Pas donneur",
  donorHelp:"VÃ©rifiez votre permis/ID",
  lifeSupportLabel:"PrÃ©fÃ©rence de maintien en vie",
  lifeFull:"Maintien complet - Toutes mesures",
  lifeLimited:"Maintien limitÃ© - Soins de base",
  lifeComfort:"Soins de confort uniquement",
  lifeDnr:"Ne pas rÃ©animer (DNR)",
  lifeHelp:"Votre prÃ©fÃ©rence de fin de vie",
  allergiesLabel:"Allergies critiques",
  allergiesPh:"Saisir allergie puis EntrÃ©e",
  allergiesHelp:"Inclure mÃ©dicaments, aliments, environnement.",
  conditionsLabel:"Affections mÃ©dicales",
  conditionsPh:"Saisir affection puis EntrÃ©e",
  conditionsHelp:"Inclure chroniques, mentales et en cours.",
  medicationsLabel:"MÃ©dicaments actuels",
  medicationsPh:"Saisir mÃ©dicament puis EntrÃ©e",
  medicationsHelp:"Inclure ordonnance, OTC, complÃ©ments.",
  criticalNoticeTitle:"Avis dâ€™information critique",
  criticalNoticeBody:"Visible par les secours. Inclure lâ€™essentiel mÃ©dical.",
  pillDuplicate:'"{X}" est dÃ©jÃ  ajoutÃ©',
  removedX:"{X} supprimÃ©",
});

Object.assign(i18n.de, {
  healthTitle:"Gesundheitsprofil",
  healthSub:"Kritische medizinische Infos fÃ¼r Ihre Notfallkarte.",
  bloodTypeLabel:"Blutgruppe",
  bloodUnknown:"Unbekannt / Nicht getestet",
  bloodHelp:"Wichtig fÃ¼r Transfusionen",
  donorLabel:"Organspender-Status",
  donorNotSpecified:"Nicht angegeben",
  donorYes:"âœ… Ja â€“ Registrierter Spender",
  donorNo:"âŒ Nein â€“ Kein Spender",
  donorHelp:"Auf Ausweis/FÃ¼hrerschein prÃ¼fen",
  lifeSupportLabel:"Lebenserhaltungs-PrÃ¤ferenz",
  lifeFull:"Volle MaÃŸnahmen",
  lifeLimited:"Begrenzte MaÃŸnahmen",
  lifeComfort:"Nur Komfortpflege",
  lifeDnr:"Nicht reanimieren (DNR)",
  lifeHelp:"PrÃ¤ferenz fÃ¼r End-of-Life",
  allergiesLabel:"Kritische Allergien",
  allergiesPh:"Allergie tippen und Enter",
  allergiesHelp:"Arznei-, Nahrungs- und Umweltallergien.",
  conditionsLabel:"Erkrankungen",
  conditionsPh:"Erkrankung tippen und Enter",
  conditionsHelp:"Chronisch, psychisch, laufend.",
  medicationsLabel:"Aktuelle Medikamente",
  medicationsPh:"Medikament tippen und Enter",
  medicationsHelp:"Verschreibung, OTC, Supplemente.",
  criticalNoticeTitle:"Hinweis: kritische Daten",
  criticalNoticeBody:"Sichtbar fÃ¼r RettungskrÃ¤fte. Nur medizinisch NÃ¶tiges.",
  pillDuplicate:'"{X}" ist bereits hinzugefÃ¼gt',
  removedX:"{X} entfernt",
});

Object.assign(i18n.it, {
  healthTitle:"Profilo sanitario",
  healthSub:"Informazioni mediche critiche sulla tua card dâ€™emergenza.",
  bloodTypeLabel:"Gruppo sanguigno",
  bloodUnknown:"Sconosciuto / Non testato",
  bloodHelp:"Cruciale per trasfusioni",
  donorLabel:"Donazione organi",
  donorNotSpecified:"Non specificato",
  donorYes:"âœ… SÃ¬ - Donatore registrato",
  donorNo:"âŒ No - Non donatore",
  donorHelp:"Controlla patente/ID",
  lifeSupportLabel:"Preferenza supporto vitale",
  lifeFull:"Supporto completo",
  lifeLimited:"Supporto limitato",
  lifeComfort:"Solo cure di conforto",
  lifeDnr:"Non rianimare (DNR)",
  lifeHelp:"Preferenze di fine vita",
  allergiesLabel:"Allergie critiche",
  allergiesPh:"Scrivi allergia e Invio",
  allergiesHelp:"Farmaci, alimenti, ambientali.",
  conditionsLabel:"Patologie",
  conditionsPh:"Scrivi patologia e Invio",
  conditionsHelp:"Croniche, mentali, in corso.",
  medicationsLabel:"Farmaci in uso",
  medicationsPh:"Scrivi farmaco e Invio",
  medicationsHelp:"Ricetta, banco, integratori.",
  criticalNoticeTitle:"Avviso: informazioni critiche",
  criticalNoticeBody:"Visibile ai soccorritori. Inserire solo il necessario.",
  pillDuplicate:'"{X}" Ã¨ giÃ  presente',
  removedX:"Rimosso {X}",
});

Object.assign(i18n.hi, {
  healthTitle:"à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤²",
  healthSub:"à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤•à¤¾à¤°à¥à¤¡ à¤ªà¤° à¤¦à¤¿à¤–à¤¨à¥‡ à¤µà¤¾à¤²à¥€ à¤®à¤¹à¤¤à¥à¤µà¤ªà¥‚à¤°à¥à¤£ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€à¥¤",
  bloodTypeLabel:"à¤°à¤•à¥à¤¤ à¤¸à¤®à¥‚à¤¹",
  bloodUnknown:"à¤…à¤œà¥à¤à¤¾à¤¤ / à¤ªà¤°à¥€à¤•à¥à¤·à¤£ à¤¨à¤¹à¥€à¤‚",
  bloodHelp:"à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤«à¥à¤¯à¥‚à¤œà¤¼à¤¨ à¤¹à¥‡à¤¤à¥ à¤†à¤µà¤¶à¥à¤¯à¤•",
  donorLabel:"à¤…à¤‚à¤— à¤¦à¤¾à¤¤à¤¾ à¤¸à¥à¤¥à¤¿à¤¤à¤¿",
  donorNotSpecified:"à¤¨à¤¿à¤°à¥à¤¦à¤¿à¤·à¥à¤Ÿ à¤¨à¤¹à¥€à¤‚",
  donorYes:"âœ… à¤¹à¤¾à¤ - à¤ªà¤‚à¤œà¥€à¤•à¥ƒà¤¤ à¤¦à¤¾à¤¤à¤¾",
  donorNo:"âŒ à¤¨à¤¹à¥€à¤‚ - à¤¦à¤¾à¤¤à¤¾ à¤¨à¤¹à¥€à¤‚",
  donorHelp:"à¤¡à¥à¤°à¤¾à¤‡à¤µà¤¿à¤‚à¤— à¤²à¤¾à¤‡à¤¸à¥‡à¤‚à¤¸/ID à¤¦à¥‡à¤–à¥‡à¤‚",
  lifeSupportLabel:"à¤œà¥€à¤µà¤¨ à¤°à¤•à¥à¤·à¤• à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾",
  lifeFull:"à¤ªà¥‚à¤°à¥à¤£ à¤œà¥€à¤µà¤¨ à¤°à¤•à¥à¤·à¤•",
  lifeLimited:"à¤¸à¥€à¤®à¤¿à¤¤ à¤¦à¥‡à¤–à¤­à¤¾à¤²",
  lifeComfort:"à¤•à¥‡à¤µà¤² à¤†à¤°à¤¾à¤® à¤¦à¥‡à¤–à¤­à¤¾à¤²",
  lifeDnr:"à¤¡à¥€à¤à¤¨à¤†à¤° (à¤ªà¥à¤¨à¤°à¥à¤œà¥€à¤µà¤¨ à¤¨ à¤•à¤°à¥‡à¤‚)",
  lifeHelp:"à¤…à¤‚à¤¤à¤¿à¤® à¤¦à¥‡à¤–à¤­à¤¾à¤² à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾",
  allergiesLabel:"à¤¸à¤‚à¤µà¥‡à¤¦à¥€ (à¤•à¥à¤°à¤¿à¤Ÿà¤¿à¤•à¤²) à¤à¤²à¤°à¥à¤œà¥€",
  allergiesPh:"à¤à¤²à¤°à¥à¤œà¥€ à¤²à¤¿à¤–à¥‡à¤‚ à¤”à¤° Enter à¤¦à¤¬à¤¾à¤à¤",
  allergiesHelp:"à¤¦à¤µà¤¾/à¤­à¥‹à¤œà¤¨/à¤ªà¤°à¥à¤¯à¤¾à¤µà¤°à¤£ à¤à¤²à¤°à¥à¤œà¥€ à¤¶à¤¾à¤®à¤¿à¤² à¤•à¤°à¥‡à¤‚à¥¤",
  conditionsLabel:"à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¥€à¤¯ à¤¸à¥à¤¥à¤¿à¤¤à¤¿à¤¯à¤¾à¤",
  conditionsPh:"à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤²à¤¿à¤–à¥‡à¤‚ à¤”à¤° Enter à¤¦à¤¬à¤¾à¤à¤",
  conditionsHelp:"à¤¦à¥€à¤°à¥à¤˜à¤•à¤¾à¤²à¤¿à¤•, à¤®à¤¾à¤¨à¤¸à¤¿à¤•, à¤œà¤¾à¤°à¥€ à¤¸à¤®à¤¸à¥à¤¯à¤¾à¤à¤à¥¤",
  medicationsLabel:"à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤¦à¤µà¤¾à¤‡à¤¯à¤¾à¤",
  medicationsPh:"à¤¦à¤µà¤¾ à¤²à¤¿à¤–à¥‡à¤‚ à¤”à¤° Enter à¤¦à¤¬à¤¾à¤à¤",
  medicationsHelp:"à¤ªà¥à¤°à¤¿à¤¸à¥à¤•à¥à¤°à¤¿à¤ªà¥à¤¶à¤¨, OTC, à¤¸à¤ªà¥à¤²à¥€à¤®à¥‡à¤‚à¤Ÿà¥¤",
  criticalNoticeTitle:"à¤®à¤¹à¤¤à¥à¤µà¤ªà¥‚à¤°à¥à¤£ à¤¸à¥‚à¤šà¤¨à¤¾",
  criticalNoticeBody:"à¤¯à¤¹ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤°à¥‡à¤¸à¥à¤ªà¥‰à¤¨à¥à¤¡à¤°à¥à¤¸ à¤•à¥‹ à¤¦à¤¿à¤–à¥‡à¤—à¥€; à¤•à¥‡à¤µà¤² à¤†à¤µà¤¶à¥à¤¯à¤• à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¦à¥‡à¤‚à¥¤",
  pillDuplicate:'"{X}" à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤œà¥‹à¤¡à¤¼à¤¾ à¤—à¤¯à¤¾ à¤¹à¥ˆ',
  removedX:"{X} à¤¹à¤Ÿà¤¾à¤¯à¤¾ à¤—à¤¯à¤¾",
});

Object.assign(i18n.ar, {
  healthTitle:"Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ",
  healthSub:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø·Ø¨ÙŠØ© Ø­Ø±Ø¬Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
  bloodTypeLabel:"ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…",
  bloodUnknown:"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ / ØºÙŠØ± Ù…Ø®ØªØ¨Ø±",
  bloodHelp:"Ù…Ù‡Ù… Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù…",
  donorLabel:"Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡",
  donorNotSpecified:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
  donorYes:"âœ… Ù†Ø¹Ù… - Ù…ØªØ¨Ø±Ø¹ Ù…Ø³Ø¬Ù„",
  donorNo:"âŒ Ù„Ø§ - ØºÙŠØ± Ù…ØªØ¨Ø±Ø¹",
  donorHelp:"ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø®ØµØªÙƒ Ø£Ùˆ Ù‡ÙˆÙŠØªÙƒ",
  lifeSupportLabel:"ØªÙØ¶ÙŠÙ„ Ø¯Ø¹Ù… Ø§Ù„Ø­ÙŠØ§Ø©",
  lifeFull:"Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„",
  lifeLimited:"Ø¯Ø¹Ù… Ù…Ø­Ø¯ÙˆØ¯",
  lifeComfort:"Ø±Ø¹Ø§ÙŠØ© Ù…Ø±ÙŠØ­Ø© ÙÙ‚Ø·",
  lifeDnr:"Ø¹Ø¯Ù… Ø§Ù„Ø¥Ù†Ø¹Ø§Ø´ (DNR)",
  lifeHelp:"ØªÙØ¶ÙŠÙ„ Ø±Ø¹Ø§ÙŠØ© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­ÙŠØ§Ø©",
  allergiesLabel:"Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø­Ø±Ø¬Ø©",
  allergiesPh:"Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ø¶ØºØ· Ø¥Ø¯Ø®Ø§Ù„",
  allergiesHelp:"Ø£Ø¯ÙˆÙŠØ©ØŒ Ø£Ø·Ø¹Ù…Ø© ÙˆØ¨ÙŠØ¦ÙŠØ© Ø´Ø¯ÙŠØ¯Ø©.",
  conditionsLabel:"Ø­Ø§Ù„Ø§Øª Ø·Ø¨ÙŠØ©",
  conditionsPh:"Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ø¶ØºØ· Ø¥Ø¯Ø®Ø§Ù„",
  conditionsHelp:"Ù…Ø²Ù…Ù†Ø© ÙˆÙ†ÙØ³ÙŠØ© ÙˆØ¬Ø§Ø±ÙŠØ©.",
  medicationsLabel:"Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
  medicationsPh:"Ø§ÙƒØªØ¨ Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ§Ø¶ØºØ· Ø¥Ø¯Ø®Ø§Ù„",
  medicationsHelp:"ÙˆØµÙØ§ØªØŒ Ø¨Ø¯ÙˆÙ† ÙˆØµÙØ©ØŒ ÙˆÙ…ÙƒÙ…Ù„Ø§Øª.",
  criticalNoticeTitle:"ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø±Ø¬Ø©",
  criticalNoticeBody:"Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ù…Ø³ØªØ¬ÙŠØ¨ÙŠÙ†. Ø£Ø¯Ø±Ø¬ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ ÙÙ‚Ø· Ù„Ù„Ø¹Ù„Ø§Ø¬.",
  pillDuplicate:'"{X}" Ù…ÙØ¶Ø§ÙØ© Ù…Ø³Ø¨Ù‚Ù‹Ø§',
  removedX:"ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© {X}",
});

Object.assign(i18n.zh, {
  healthTitle:"å¥åº·èµ„æ–™",
  healthSub:"å°†æ˜¾ç¤ºåœ¨åº”æ€¥å¡ä¸Šçš„å…³é”®ä¿¡æ¯ã€‚",
  bloodTypeLabel:"è¡€å‹",
  bloodUnknown:"æœªçŸ¥ / æœªæ£€æµ‹",
  bloodHelp:"è¾“è¡€å…³é”®",
  donorLabel:"å™¨å®˜æçŒ®çŠ¶æ€",
  donorNotSpecified:"æœªæŒ‡å®š",
  donorYes:"âœ… æ˜¯ - ç™»è®°æçŒ®è€…",
  donorNo:"âŒ å¦ - éæçŒ®è€…",
  donorHelp:"æŸ¥çœ‹é©¾ç…§æˆ–è¯ä»¶",
  lifeSupportLabel:"ç”Ÿå‘½ç»´æŒåå¥½",
  lifeFull:"å…¨åŠ›æ•‘æ²»",
  lifeLimited:"æœ‰é™æ•‘æ²»",
  lifeComfort:"ä»…èˆ’ç¼“æŠ¤ç†",
  lifeDnr:"ä¸å¤è‹ï¼ˆDNRï¼‰",
  lifeHelp:"ä¸´ç»ˆå…³æ€€åå¥½",
  allergiesLabel:"é‡è¦è¿‡æ•",
  allergiesPh:"è¾“å…¥è¿‡æ•å¹¶æŒ‰å›è½¦",
  allergiesHelp:"åŒ…æ‹¬è¯ç‰©ã€é£Ÿç‰©ä¸ç¯å¢ƒè¿‡æ•ã€‚",
  conditionsLabel:"ç–¾ç—…æƒ…å†µ",
  conditionsPh:"è¾“å…¥ç–¾ç—…å¹¶æŒ‰å›è½¦",
  conditionsHelp:"åŒ…æ‹¬æ…¢æ€§ã€ç²¾ç¥åŠæ­£åœ¨æ²»ç–—çš„é—®é¢˜ã€‚",
  medicationsLabel:"å½“å‰ç”¨è¯",
  medicationsPh:"è¾“å…¥è¯ç‰©å¹¶æŒ‰å›è½¦",
  medicationsHelp:"å¤„æ–¹è¯ã€éå¤„æ–¹åŠè¡¥å……å‰‚ã€‚",
  criticalNoticeTitle:"é‡è¦ä¿¡æ¯æç¤º",
  criticalNoticeBody:"å¯¹æ•‘æ´äººå‘˜å¯è§ï¼Œä»…å¡«å†™æ•‘æ²»æ‰€éœ€ä¿¡æ¯ã€‚",
  pillDuplicate:'"{X}" å·²å­˜åœ¨',
  removedX:"å·²ç§»é™¤ {X}",
});

Object.assign(i18n.hu, {
  healthTitle:"EgÃ©szsÃ©gÃ¼gyi profil",
  healthSub:"Kritikus informÃ¡ciÃ³k a vÃ©sz-kÃ¡rtyÃ¡n.",
  bloodTypeLabel:"VÃ©rcsoport",
  bloodUnknown:"Ismeretlen / Nem tesztelt",
  bloodHelp:"TranszfÃºziÃ³hoz fontos",
  donorLabel:"Szervdonor stÃ¡tusz",
  donorNotSpecified:"Nincs megadva",
  donorYes:"âœ… Igen â€“ regisztrÃ¡lt donor",
  donorNo:"âŒ Nem â€“ nem donor",
  donorHelp:"Jogsi/ID ellenÅ‘rzÃ©se",
  lifeSupportLabel:"Ã‰letjele-tÃ¡mogatÃ¡s",
  lifeFull:"Teljes ellÃ¡tÃ¡s",
  lifeLimited:"KorlÃ¡tozott ellÃ¡tÃ¡s",
  lifeComfort:"Csak komfort",
  lifeDnr:"Ne Ã©lesszÃ©k Ãºjra (DNR)",
  lifeHelp:"VÃ©gsÅ‘ ellÃ¡tÃ¡si preferencia",
  allergiesLabel:"Kritikus allergiÃ¡k",
  allergiesPh:"Ãrj allergiÃ¡t Ã©s Enter",
  allergiesHelp:"GyÃ³gyszer-, Ã©tel-, kÃ¶rnyezeti.",
  conditionsLabel:"BetegsÃ©gek",
  conditionsPh:"Ãrj betegsÃ©get Ã©s Enter",
  conditionsHelp:"KrÃ³nikus, mentÃ¡lis, fennÃ¡llÃ³.",
  medicationsLabel:"GyÃ³gyszerek",
  medicationsPh:"Ãrj gyÃ³gyszert Ã©s Enter",
  medicationsHelp:"VÃ©nykÃ¶teles, OTC, kiegÃ©szÃ­tÅ‘k.",
  criticalNoticeTitle:"Figyelem: kritikus adatok",
  criticalNoticeBody:"MentÅ‘k lÃ¡tjÃ¡k. Csak a szÃ¼ksÃ©gest add meg.",
  pillDuplicate:'" {X} " mÃ¡r hozzÃ¡adva',
  removedX:"EltÃ¡volÃ­tva: {X}",
});

Object.assign(i18n.ro, {
  healthTitle:"Profil medical",
  healthSub:"InformaÈ›ii critice afiÈ™ate pe cardul de urgenÈ›Äƒ.",
  bloodTypeLabel:"Grupa sanguinÄƒ",
  bloodUnknown:"NecunoscutÄƒ / Netestat",
  bloodHelp:"Esential pentru transfuzie",
  donorLabel:"Donator de organe",
  donorNotSpecified:"Nespecificat",
  donorYes:"âœ… Da - Donator Ã®nregistrat",
  donorNo:"âŒ Nu - Nu este donator",
  donorHelp:"VerificÄƒ permisul/CI",
  lifeSupportLabel:"PreferinÈ›Äƒ suport vital",
  lifeFull:"Suport total",
  lifeLimited:"Suport limitat",
  lifeComfort:"Doar confort",
  lifeDnr:"Nu resuscita (DNR)",
  lifeHelp:"PreferinÈ›Äƒ pentru Ã®ngrijire la finalul vieÈ›ii",
  allergiesLabel:"Alergii critice",
  allergiesPh:"TasteazÄƒ alergia È™i Enter",
  allergiesHelp:"Include alergii la medicamente, alimente, mediu.",
  conditionsLabel:"Afectiuni medicale",
  conditionsPh:"TasteazÄƒ afecÈ›iunea È™i Enter",
  conditionsHelp:"Include cronice, mentale È™i Ã®n desfÄƒÈ™urare.",
  medicationsLabel:"MedicaÈ›ie curentÄƒ",
  medicationsPh:"TasteazÄƒ medicamentul È™i Enter",
  medicationsHelp:"Include reÈ›etÄƒ, OTC È™i suplimente.",
  criticalNoticeTitle:"AtenÈ›ie: informaÈ›ii critice",
  criticalNoticeBody:"Vizibile pentru salvatori. Include doar ce e necesar medical.",
  pillDuplicate:'â€{X}â€ este deja adÄƒugat',
  removedX:"S-a eliminat {X}",
});

// pills state (shared)
window.pillData = window.pillData || { allergies:[], conditions:[], medications:[] };

// add pill
function addPill(type, value){
  const v = value.trim();
  if(!v) return;
  if (pillData[type].some(x=>x.toLowerCase()===v.toLowerCase())){
    const t=(i18n[document.documentElement.lang]||i18n.en).pillDuplicate.replace("{X}", v);
    showToast(t, "warning"); return;
  }
  pillData[type].push(v);
  renderPills(type);
  debounceSave(saveHealth, 600);
  updateHealthCompletion();
}

function removePill(type, index){
  const removed = pillData[type].splice(index,1)[0];
  renderPills(type);
  debounceSave(saveHealth, 600);
  updateHealthCompletion();
  const t=(i18n[document.documentElement.lang]||i18n.en).removedX.replace("{X}", removed);
  showToast(t, "success");
}

function renderPills(type){
  const container = document.getElementById(type+"Pills");
  if(!container) return;
  container.innerHTML = pillData[type].map((txt, i)=>`
    <div class="pill">
      ${txt}
      <span class="pill-remove" role="button" aria-label="remove"
            onclick="removePill('${type}', ${i})">Ã—</span>
    </div>
  `).join("");
}

// wire Enter on inputs
(function wirePillInputs(){
  ["allergies","conditions","medications"].forEach(type=>{
    const input = document.getElementById(type+"Input");
    if(!input) return;
    input.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        addPill(type, input.value);
        input.value="";
      }
    });
  });
})();

// save to Supabase (health_profiles)
async function saveHealth(){
  try{
    if(!currentUser?.id) return;
    const blood_type = document.getElementById("bloodType")?.value||"";
    const organDonorVal = document.getElementById("organDonor")?.value||"";
    const organ_donor = organDonorVal==="" ? null : (organDonorVal==="true");
    const life_support_pref = document.getElementById("lifeSupportPref")?.value||"Full";

    const payload = {
      user_id: currentUser.id,
      blood_type,
      organ_donor,
      life_support_pref,
      allergies: pillData.allergies.join(", "),
      conditions: pillData.conditions.join(", "),
      medications: pillData.medications.join(", ")
    };

    const { error } = await sb.from("health_profiles").upsert(payload);
    if (error) throw error;

    updateHealthCompletion();
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(err){
    console.error("saveHealth", err);
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

// load from Supabase
async function loadHealth(){
  try{
    if(!currentUser?.id) return;
    const { data, error } = await sb.from("health_profiles").select("*").eq("user_id", currentUser.id).single();
    if (error && error.code!=="PGRST116") throw error;
    if (data){
      document.getElementById("bloodType").value = data.blood_type||"";
      const donorSel=document.getElementById("organDonor");
      donorSel.value = (data.organ_donor===null||data.organ_donor===undefined) ? "" : String(!!data.organ_donor);
      document.getElementById("lifeSupportPref").value = data.life_support_pref||"Full";
      pillData.allergies = (data.allergies||"").split(",").map(s=>s.trim()).filter(Boolean);
      pillData.conditions= (data.conditions||"").split(",").map(s=>s.trim()).filter(Boolean);
      pillData.medications=(data.medications||"").split(",").map(s=>s.trim()).filter(Boolean);
      renderPills("allergies"); renderPills("conditions"); renderPills("medications");
    }
  }catch(e){
    console.warn("loadHealth", e);
  }finally{
    updateHealthCompletion();
  }
}

// health completion affects progress
function updateHealthCompletion(){
  const blood = document.getElementById("bloodType")?.value||"";
  const hasAll = pillData.allergies.length>0;
  const hasCond= pillData.conditions.length>0;
  window.healthComplete = Boolean(blood || hasAll || hasCond);
  updateCheckIndicator("checkHealth", window.healthComplete);
  updateProfileProgress();
}

// change listeners
["bloodType","organDonor","lifeSupportPref"].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  ["change","input","blur"].forEach(evt=>{
    el.addEventListener(evt, ()=>debounceSave(()=>{ saveHealth(); }, 500));
  });
});

// init after DOM ready (called after Identity already loaded)
document.addEventListener("DOMContentLoaded", async ()=>{
  await loadHealth();
  updateHealthCompletion();
});
</script>
  <!-- === Emergency Contacts (ICE) === -->
<div class="glass-card p-8 mb-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2" data-i18n="iceTitle">Emergency Contacts (ICE)</h2>
      <p class="text-gray-600" data-i18n="iceSub">Add up to 5 trusted people who can be reached in an emergency.</p>
    </div>
    <div class="hidden md:block" aria-hidden="true">
      <svg class="w-12 h-12 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
      </svg>
    </div>
  </div>

  <div id="iceContacts" class="space-y-6"></div>

  <div class="flex items-center justify-between mt-6 pt-6 border-t border-gray-200">
    <div class="text-sm text-gray-500">
      <span id="contactCount">0</span> <span data-i18n="iceOfFive">of 5 contacts added</span>
    </div>
    <button id="addIceBtn" class="btn-secondary">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path>
      </svg>
      <span data-i18n="iceAddBtn">Add Emergency Contact</span>
    </button>
  </div>
</div>

<!-- === Automated Triage === -->
<div class="glass-card p-6 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-slate-900" data-i18n="triageTitle">Automated Triage</h2>
    <svg class="w-8 h-8 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
    </svg>
  </div>

  <p class="text-sm text-gray-600 mb-6" data-i18n="triageSub">Auto-computed priority level based on your health profile.</p>

  <div class="text-center mb-6">
    <div id="triageStatus" class="triage-status triage-green" data-i18n="triageGreenAuto">GREEN - Standard (Auto)</div>
  </div>

  <div class="mb-6">
    <label class="form-label" data-i18n="triageOverrideLabel">Manual Override</label>
    <select id="triageOverride" class="form-select" aria-label="Triage override">
      <option value="" data-i18n="triageAuto">ğŸ¤– Auto (Recommended)</option>
      <option value="Green" data-i18n="triageGreen">ğŸŸ¢ Green - Standard Priority</option>
      <option value="Amber" data-i18n="triageAmber">ğŸŸ¡ Amber - Urgent Priority</option>
      <option value="Red" data-i18n="triageRed">ğŸ”´ Red - Immediate Priority</option>
      <option value="Black" data-i18n="triageBlack">âš« Black - Comfort Care</option>
    </select>
    <div class="text-xs text-gray-500 mt-1" data-i18n="triageHint">Override only if you have specific medical directives.</div>
  </div>
</div>

<script>
/* ---------- Chunk 4: ICE Contacts + Triage (autosave + i18n) ---------- */

window.maxIce = 5;

// --- i18n additions (toasts + ICE + triage) ---
["en","es","fr","de","it","hi","ar","zh","hu","ro"].forEach(l=>{ i18n[l]=i18n[l]||{}; });
Object.assign(i18n.en,{
  toastSaved:"Saved",
  toastSaveError:"Save failed",
  iceTitle:"Emergency Contacts (ICE)",
  iceSub:"Add up to 5 trusted people who can be reached in an emergency.",
  iceOfFive:"of 5 contacts added",
  iceAddBtn:"Add Emergency Contact",
  iceName:"Full Name *",
  iceRel:"Relationship",
  icePhone:"Phone Number *",
  iceEmail:"Email (Optional)",
  iceNotes:"Notes (Optional)",
  iceRemove:"Remove Contact",
  relSpouse:"Spouse", relPartner:"Partner", relParent:"Parent", relChild:"Child", relSibling:"Sibling",
  relFriend:"Friend", relColleague:"Colleague", relDoctor:"Doctor", relLawyer:"Lawyer", relOther:"Other",
  triageTitle:"Automated Triage",
  triageSub:"Auto-computed priority level based on your health profile.",
  triageOverrideLabel:"Manual Override",
  triageAuto:"ğŸ¤– Auto (Recommended)",
  triageGreen:"ğŸŸ¢ Green - Standard Priority",
  triageAmber:"ğŸŸ¡ Amber - Urgent Priority",
  triageRed:"ğŸ”´ Red - Immediate Priority",
  triageBlack:"âš« Black - Comfort Care",
  triageHint:"Override only if you have specific medical directives.",
  triageGreenAuto:"GREEN - Standard (Auto)",
  triageAmberAuto:"AMBER - Urgent (Auto)",
  triageRedAuto:"RED - Immediate (Auto)",
  triageBlackAuto:"BLACK - Comfort (Auto)"
});
Object.assign(i18n.es,{
  toastSaved:"Guardado", toastSaveError:"Error al guardar",
  iceTitle:"Contactos de emergencia (ICE)",
  iceSub:"Agregue hasta 5 personas de confianza.",
  iceOfFive:"de 5 contactos agregados",
  iceAddBtn:"AÃ±adir contacto",
  iceName:"Nombre completo *", iceRel:"RelaciÃ³n", icePhone:"TelÃ©fono *",
  iceEmail:"Correo (Opcional)", iceNotes:"Notas (Opcional)", iceRemove:"Eliminar",
  relSpouse:"CÃ³nyuge", relPartner:"Pareja", relParent:"Padre/Madre", relChild:"Hijo/a", relSibling:"Hermano/a",
  relFriend:"Amigo/a", relColleague:"Colega", relDoctor:"MÃ©dico", relLawyer:"Abogado/a", relOther:"Otro",
  triageTitle:"Triaje automatizado",
  triageSub:"Nivel calculado segÃºn su perfil.",
  triageOverrideLabel:"AnulaciÃ³n manual",
  triageAuto:"ğŸ¤– AutomÃ¡tico (Recomendado)",
  triageGreen:"ğŸŸ¢ Verde - Prioridad estÃ¡ndar",
  triageAmber:"ğŸŸ¡ Ãmbar - Urgente",
  triageRed:"ğŸ”´ Rojo - Inmediata",
  triageBlack:"âš« Negro - Confort",
  triageHint:"Use solo si tiene directivas mÃ©dicas.",
  triageGreenAuto:"VERDE - EstÃ¡ndar (Auto)",
  triageAmberAuto:"ÃMBAR - Urgente (Auto)",
  triageRedAuto:"ROJO - Inmediata (Auto)",
  triageBlackAuto:"NEGRO - Confort (Auto)"
});
Object.assign(i18n.fr,{
  toastSaved:"EnregistrÃ©", toastSaveError:"Ã‰chec de lâ€™enregistrement",
  iceTitle:"Contacts dâ€™urgence (ICE)",
  iceSub:"Ajoutez jusquâ€™Ã  5 personnes de confiance.",
  iceOfFive:"sur 5 contacts ajoutÃ©s",
  iceAddBtn:"Ajouter un contact",
  iceName:"Nom complet *", iceRel:"Lien", icePhone:"TÃ©lÃ©phone *",
  iceEmail:"E-mail (Optionnel)", iceNotes:"Notes (Optionnel)", iceRemove:"Supprimer",
  relSpouse:"Conjoint", relPartner:"Partenaire", relParent:"Parent", relChild:"Enfant", relSibling:"FrÃ¨re/SÅ“ur",
  relFriend:"Ami(e)", relColleague:"CollÃ¨gue", relDoctor:"MÃ©decin", relLawyer:"Avocat", relOther:"Autre",
  triageTitle:"Triage automatisÃ©",
  triageSub:"Niveau calculÃ© selon votre profil.",
  triageOverrideLabel:"Forcer manuellement",
  triageAuto:"ğŸ¤– Auto (RecommandÃ©)",
  triageGreen:"ğŸŸ¢ Vert - Standard",
  triageAmber:"ğŸŸ¡ Ambre - Urgent",
  triageRed:"ğŸ”´ Rouge - ImmÃ©diat",
  triageBlack:"âš« Noir - Confort",
  triageHint:"Nâ€™utiliser quâ€™avec directives mÃ©dicales.",
  triageGreenAuto:"VERT - Standard (Auto)",
  triageAmberAuto:"AMBRE - Urgent (Auto)",
  triageRedAuto:"ROUGE - ImmÃ©diat (Auto)",
  triageBlackAuto:"NOIR - Confort (Auto)"
});
Object.assign(i18n.de,{
  toastSaved:"Gespeichert", toastSaveError:"Speichern fehlgeschlagen",
  iceTitle:"Notfallkontakte (ICE)",
  iceSub:"FÃ¼gen Sie bis zu 5 Vertrauenspersonen hinzu.",
  iceOfFive:"von 5 Kontakten",
  iceAddBtn:"Kontakt hinzufÃ¼gen",
  iceName:"VollstÃ¤ndiger Name *", iceRel:"Beziehung", icePhone:"Telefon *",
  iceEmail:"E-Mail (Optional)", iceNotes:"Notizen (Optional)", iceRemove:"Entfernen",
  relSpouse:"Ehepartner", relPartner:"Partner", relParent:"Elternteil", relChild:"Kind", relSibling:"Geschwister",
  relFriend:"Freund", relColleague:"Kollege", relDoctor:"Arzt", relLawyer:"Anwalt", relOther:"Sonstiges",
  triageTitle:"Automatisches Triage",
  triageSub:"Stufe basierend auf Profil.",
  triageOverrideLabel:"Manuelle Ãœberschreibung",
  triageAuto:"ğŸ¤– Auto (Empfohlen)",
  triageGreen:"ğŸŸ¢ GrÃ¼n - Standard",
  triageAmber:"ğŸŸ¡ Gelb - Dringend",
  triageRed:"ğŸ”´ Rot - Sofort",
  triageBlack:"âš« Schwarz - Komfort",
  triageHint:"Nur bei medizinischen Weisungen.",
  triageGreenAuto:"GRÃœN - Standard (Auto)",
  triageAmberAuto:"GELB - Dringend (Auto)",
  triageRedAuto:"ROT - Sofort (Auto)",
  triageBlackAuto:"SCHWARZ - Komfort (Auto)"
});
Object.assign(i18n.it,{
  toastSaved:"Salvato", toastSaveError:"Salvataggio fallito",
  iceTitle:"Contatti di emergenza (ICE)",
  iceSub:"Aggiungi fino a 5 persone fidate.",
  iceOfFive:"di 5 contatti",
  iceAddBtn:"Aggiungi contatto",
  iceName:"Nome completo *", iceRel:"Relazione", icePhone:"Telefono *",
  iceEmail:"Email (Opzionale)", iceNotes:"Note (Opzionale)", iceRemove:"Rimuovi",
  relSpouse:"Coniuge", relPartner:"Partner", relParent:"Genitore", relChild:"Figlio/a", relSibling:"Fratello/Sorella",
  relFriend:"Amico", relColleague:"Collega", relDoctor:"Medico", relLawyer:"Avvocato", relOther:"Altro",
  triageTitle:"Triage automatico",
  triageSub:"Livello calcolato dal profilo.",
  triageOverrideLabel:"Forzatura manuale",
  triageAuto:"ğŸ¤– Auto (Consigliato)",
  triageGreen:"ğŸŸ¢ Verde - Standard",
  triageAmber:"ğŸŸ¡ Ambra - Urgente",
  triageRed:"ğŸ”´ Rosso - Immediato",
  triageBlack:"âš« Nero - Comfort",
  triageHint:"Usare solo con direttive mediche.",
  triageGreenAuto:"VERDE - Standard (Auto)",
  triageAmberAuto:"AMBRA - Urgente (Auto)",
  triageRedAuto:"ROSSO - Immediato (Auto)",
  triageBlackAuto:"NERO - Comfort (Auto)"
});
Object.assign(i18n.hi,{
  toastSaved:"à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾", toastSaveError:"à¤¸à¤¹à¥‡à¤œà¤¨à¤¾ à¤µà¤¿à¤«à¤²",
  iceTitle:"à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤• (ICE)",
  iceSub:"à¤…à¤§à¤¿à¤•à¤¤à¤® 5 à¤µà¤¿à¤¶à¥à¤µà¤¸à¤¨à¥€à¤¯ à¤²à¥‹à¤— à¤œà¥‹à¤¡à¤¼à¥‡à¤‚à¥¤",
  iceOfFive:"à¤®à¥‡à¤‚ à¤¸à¥‡ 5 à¤¸à¤‚à¤ªà¤°à¥à¤•",
  iceAddBtn:"à¤¸à¤‚à¤ªà¤°à¥à¤• à¤œà¥‹à¤¡à¤¼à¥‡à¤‚",
  iceName:"à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤® *", iceRel:"à¤¸à¤‚à¤¬à¤‚à¤§", icePhone:"à¤«à¤¼à¥‹à¤¨ *",
  iceEmail:"à¤ˆà¤®à¥‡à¤² (à¤µà¥ˆà¤•à¤²à¥à¤ªà¤¿à¤•)", iceNotes:"à¤¨à¥‹à¤Ÿà¥à¤¸ (à¤µà¥ˆà¤•à¤²à¥à¤ªà¤¿à¤•)", iceRemove:"à¤¹à¤Ÿà¤¾à¤à¤",
  relSpouse:"à¤ªà¤¤à¥à¤¨à¥€/à¤ªà¤¤à¤¿", relPartner:"à¤¸à¤¾à¤¥à¥€", relParent:"à¤®à¤¾à¤¤à¤¾/à¤ªà¤¿à¤¤à¤¾", relChild:"à¤¸à¤‚à¤¤à¤¾à¤¨", relSibling:"à¤­à¤¾à¤ˆ/à¤¬à¤¹à¤¨",
  relFriend:"à¤®à¤¿à¤¤à¥à¤°", relColleague:"à¤¸à¤¹à¤•à¤°à¥à¤®à¥€", relDoctor:"à¤¡à¥‰à¤•à¥à¤Ÿà¤°", relLawyer:"à¤µà¤•à¥€à¤²", relOther:"à¤…à¤¨à¥à¤¯",
  triageTitle:"à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤Ÿà¥à¤°à¤¾à¤¯à¤¾à¤œ",
  triageSub:"à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤•à¥‡ à¤†à¤§à¤¾à¤° à¤ªà¤°à¥¤",
  triageOverrideLabel:"à¤®à¥ˆà¤¨à¥à¤…à¤² à¤“à¤µà¤°à¤°à¤¾à¤‡à¤¡",
  triageAuto:"ğŸ¤– à¤‘à¤Ÿà¥‹ (à¤…à¤¨à¥à¤¶à¤‚à¤¸à¤¿à¤¤)",
  triageGreen:"ğŸŸ¢ à¤—à¥à¤°à¥€à¤¨ - à¤®à¤¾à¤¨à¤•",
  triageAmber:"ğŸŸ¡ à¤à¤®à¥à¤¬à¤° - à¤†à¤ªà¤¾à¤¤",
  triageRed:"ğŸ”´ à¤°à¥‡à¤¡ - à¤¤à¤¾à¤¤à¥à¤•à¤¾à¤²à¤¿à¤•",
  triageBlack:"âš« à¤¬à¥à¤²à¥ˆà¤• - à¤•à¤‚à¤«à¤°à¥à¤Ÿ",
  triageHint:"à¤•à¥‡à¤µà¤² à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤•à¥€à¤¯ à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶ à¤ªà¤° à¤¬à¤¦à¤²à¥‡à¤‚à¥¤",
  triageGreenAuto:"à¤—à¥à¤°à¥€à¤¨ - à¤®à¤¾à¤¨à¤• (à¤‘à¤Ÿà¥‹)",
  triageAmberAuto:"à¤à¤®à¥à¤¬à¤° - à¤†à¤ªà¤¾à¤¤ (à¤‘à¤Ÿà¥‹)",
  triageRedAuto:"à¤°à¥‡à¤¡ - à¤¤à¤¾à¤¤à¥à¤•à¤¾à¤²à¤¿à¤• (à¤‘à¤Ÿà¥‹)",
  triageBlackAuto:"à¤¬à¥à¤²à¥ˆà¤• - à¤•à¤‚à¤«à¤°à¥à¤Ÿ (à¤‘à¤Ÿà¥‹)"
});
Object.assign(i18n.ar,{
  toastSaved:"ØªÙ… Ø§Ù„Ø­ÙØ¸", toastSaveError:"ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",
  iceTitle:"Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (ICE)",
  iceSub:"Ø£Ø¶Ù Ù…Ø§ ÙŠØµÙ„ Ø¥Ù„Ù‰ 5 Ø£Ø´Ø®Ø§Øµ Ù…ÙˆØ«ÙˆÙ‚ÙŠÙ†.",
  iceOfFive:"Ù…Ù† 5 Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„",
  iceAddBtn:"Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„",
  iceName:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *", iceRel:"Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©", icePhone:"Ø§Ù„Ù‡Ø§ØªÙ *",
  iceEmail:"Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", iceNotes:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", iceRemove:"Ø­Ø°Ù",
  relSpouse:"Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø©", relPartner:"Ø´Ø±ÙŠÙƒ", relParent:"Ø£Ø¨/Ø£Ù…", relChild:"Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©", relSibling:"Ø£Ø®/Ø£Ø®Øª",
  relFriend:"ØµØ¯ÙŠÙ‚", relColleague:"Ø²Ù…ÙŠÙ„", relDoctor:"Ø·Ø¨ÙŠØ¨", relLawyer:"Ù…Ø­Ø§Ù…", relOther:"Ø¢Ø®Ø±",
  triageTitle:"ÙØ±Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠ",
  triageSub:"ÙŠÙØ­Ø³Ø¨ Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„ØµØ­ÙŠ.",
  triageOverrideLabel:"ØªØ¬Ø§ÙˆØ² ÙŠØ¯ÙˆÙŠ",
  triageAuto:"ğŸ¤– ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…ÙÙˆØµÙ‰ Ø¨Ù‡)",
  triageGreen:"ğŸŸ¢ Ø£Ø®Ø¶Ø± - Ø¹Ø§Ø¯ÙŠ",
  triageAmber:"ğŸŸ¡ ÙƒÙ‡Ø±Ù…Ø§Ù†ÙŠ - Ø¹Ø§Ø¬Ù„",
  triageRed:"ğŸ”´ Ø£Ø­Ù…Ø± - ÙÙˆØ±ÙŠ",
  triageBlack:"âš« Ø£Ø³ÙˆØ¯ - Ø±Ø¹Ø§ÙŠØ© Ù…Ø±ÙŠØ­Ø©",
  triageHint:"Ø§Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø·Ø¨ÙŠØ©.",
  triageGreenAuto:"Ø£Ø®Ø¶Ø± - Ø¹Ø§Ø¯ÙŠ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
  triageAmberAuto:"ÙƒÙ‡Ø±Ù…Ø§Ù†ÙŠ - Ø¹Ø§Ø¬Ù„ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
  triageRedAuto:"Ø£Ø­Ù…Ø± - ÙÙˆØ±ÙŠ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
  triageBlackAuto:"Ø£Ø³ÙˆØ¯ - Ù…Ø±ÙŠØ­ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)"
});
Object.assign(i18n.zh,{
  toastSaved:"å·²ä¿å­˜", toastSaveError:"ä¿å­˜å¤±è´¥",
  iceTitle:"ç´§æ€¥è”ç»œäºº (ICE)",
  iceSub:"æœ€å¤šæ·»åŠ  5 ä½å¯ä¿¡è”ç³»äººã€‚",
  iceOfFive:"/5 ä½è”ç³»äºº",
  iceAddBtn:"æ·»åŠ è”ç³»äºº",
  iceName:"å…¨å *", iceRel:"å…³ç³»", icePhone:"ç”µè¯ *",
  iceEmail:"é‚®ç®±ï¼ˆå¯é€‰ï¼‰", iceNotes:"å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰", iceRemove:"åˆ é™¤",
  relSpouse:"é…å¶", relPartner:"ä¼´ä¾£", relParent:"çˆ¶æ¯", relChild:"å­å¥³", relSibling:"å…„å¼Ÿå§å¦¹",
  relFriend:"æœ‹å‹", relColleague:"åŒäº‹", relDoctor:"åŒ»ç”Ÿ", relLawyer:"å¾‹å¸ˆ", relOther:"å…¶ä»–",
  triageTitle:"è‡ªåŠ¨åˆ†çº§",
  triageSub:"åŸºäºå¥åº·èµ„æ–™è®¡ç®—ã€‚",
  triageOverrideLabel:"æ‰‹åŠ¨è¦†ç›–",
  triageAuto:"ğŸ¤– è‡ªåŠ¨ï¼ˆæ¨èï¼‰",
  triageGreen:"ğŸŸ¢ ç»¿è‰² - æ ‡å‡†",
  triageAmber:"ğŸŸ¡ ç¥ç€ - ç´§æ€¥",
  triageRed:"ğŸ”´ çº¢è‰² - ç«‹å³",
  triageBlack:"âš« é»‘è‰² - èˆ’ç¼“",
  triageHint:"ä»…åœ¨æœ‰åŒ»ç–—æŒ‡ç¤ºæ—¶æ›´æ”¹ã€‚",
  triageGreenAuto:"ç»¿è‰² - æ ‡å‡†ï¼ˆè‡ªåŠ¨ï¼‰",
  triageAmberAuto:"ç¥ç€ - ç´§æ€¥ï¼ˆè‡ªåŠ¨ï¼‰",
  triageRedAuto:"çº¢è‰² - ç«‹å³ï¼ˆè‡ªåŠ¨ï¼‰",
  triageBlackAuto:"é»‘è‰² - èˆ’ç¼“ï¼ˆè‡ªåŠ¨ï¼‰"
});
Object.assign(i18n.hu,{
  toastSaved:"Mentve", toastSaveError:"MentÃ©s sikertelen",
  iceTitle:"VÃ©szhelyzeti kapcsolatok (ICE)",
  iceSub:"Legfeljebb 5 megbÃ­zhatÃ³ szemÃ©ly.",
  iceOfFive:"/5 kapcsolat",
  iceAddBtn:"Kapcsolat hozzÃ¡adÃ¡sa",
  iceName:"Teljes nÃ©v *", iceRel:"Kapcsolat", icePhone:"Telefon *",
  iceEmail:"E-mail (OpcionÃ¡lis)", iceNotes:"MegjegyzÃ©s (OpcionÃ¡lis)", iceRemove:"EltÃ¡volÃ­tÃ¡s",
  relSpouse:"HÃ¡zastÃ¡rs", relPartner:"Ã‰lettÃ¡rs", relParent:"SzÃ¼lÅ‘", relChild:"Gyermek", relSibling:"TestvÃ©r",
  relFriend:"BarÃ¡t", relColleague:"KollÃ©ga", relDoctor:"Orvos", relLawyer:"ÃœgyvÃ©d", relOther:"EgyÃ©b",
  triageTitle:"Automatikus triÃ¡zs",
  triageSub:"Profil alapjÃ¡n szÃ¡mÃ­tva.",
  triageOverrideLabel:"KÃ©zi felÃ¼lbÃ­rÃ¡lat",
  triageAuto:"ğŸ¤– Auto (AjÃ¡nlott)",
  triageGreen:"ğŸŸ¢ ZÃ¶ld - Standard",
  triageAmber:"ğŸŸ¡ BorostyÃ¡n - SÃ¼rgÅ‘s",
  triageRed:"ğŸ”´ Piros - Azonnali",
  triageBlack:"âš« Fekete - Komfort",
  triageHint:"Csak orvosi utasÃ­tÃ¡s esetÃ©n.",
  triageGreenAuto:"ZÃ–LD - Standard (Auto)",
  triageAmberAuto:"BOROSTYÃN - SÃ¼rgÅ‘s (Auto)",
  triageRedAuto:"PIROS - Azonnali (Auto)",
  triageBlackAuto:"FEKETE - Komfort (Auto)"
});
Object.assign(i18n.ro,{
  toastSaved:"Salvat", toastSaveError:"Eroare la salvare",
  iceTitle:"Contacte de urgenÈ›Äƒ (ICE)",
  iceSub:"AdaugÄƒ pÃ¢nÄƒ la 5 persoane de Ã®ncredere.",
  iceOfFive:"din 5 contacte",
  iceAddBtn:"AdaugÄƒ contact",
  iceName:"Nume complet *", iceRel:"RelaÈ›ie", icePhone:"Telefon *",
  iceEmail:"Email (OpÈ›ional)", iceNotes:"Note (OpÈ›ional)", iceRemove:"È˜terge",
  relSpouse:"SoÈ›/SoÈ›ie", relPartner:"Partener", relParent:"PÄƒrinte", relChild:"Copil", relSibling:"Frate/SorÄƒ",
  relFriend:"Prieteni", relColleague:"Colega", relDoctor:"Medic", relLawyer:"Avocat", relOther:"Altul",
  triageTitle:"Triere automatÄƒ",
  triageSub:"Nivel calculat din profil.",
  triageOverrideLabel:"Suprascriere manualÄƒ",
  triageAuto:"ğŸ¤– Auto (Recomandat)",
  triageGreen:"ğŸŸ¢ Verde - Standard",
  triageAmber:"ğŸŸ¡ Chihlimbar - Urgent",
  triageRed:"ğŸ”´ RoÈ™u - Imediat",
  triageBlack:"âš« Negru - Confort",
  triageHint:"FolosiÈ›i doar cu directive medicale.",
  triageGreenAuto:"VERDE - Standard (Auto)",
  triageAmberAuto:"CHIH - Urgent (Auto)",
  triageRedAuto:"ROÈ˜U - Imediat (Auto)",
  triageBlackAuto:"NEGRU - Confort (Auto)"
});

// --- ICE rendering helpers ---
function iceRelOptions(selected=""){
  const t = i18n[document.documentElement.lang]||i18n.en;
  const opts = [
    ["", t.iceRel],
    ["Spouse", t.relSpouse],["Partner", t.relPartner],["Parent", t.relParent],["Child", t.relChild],
    ["Sibling", t.relSibling],["Friend", t.relFriend],["Colleague", t.relColleague],["Doctor", t.relDoctor],
    ["Lawyer", t.relLawyer],["Other", t.relOther]
  ];
  return opts.map(([v,l])=>`<option value="${v}" ${v===selected?"selected":""}>${l}</option>`).join("");
}

function contactCardTemplate(c){
  const t=i18n[document.documentElement.lang]||i18n.en;
  return `
  <div class="ice-contact-card" data-card data-sbid="${c.id||""}">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="form-label">${t.iceName}</label>
        <input type="text" class="form-input" data-field="name" placeholder="${t.iceName}" value="${c.name||""}">
      </div>
      <div>
        <label class="form-label">${t.iceRel}</label>
        <select class="form-select" data-field="relationship">${iceRelOptions(c.relationship||"")}</select>
      </div>
      <div>
        <label class="form-label">${t.icePhone}</label>
        <input type="tel" class="form-input" data-field="phone" placeholder="+1 (555) 123-4567" value="${c.phone||""}">
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="form-label">${t.iceEmail}</label>
        <input type="email" class="form-input" data-field="email" placeholder="contact@example.com" value="${c.email||""}">
      </div>
      <div>
        <label class="form-label">${t.iceNotes}</label>
        <input type="text" class="form-input" data-field="notes" placeholder="" value="${c.notes||""}">
      </div>
    </div>
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
      <button type="button" class="text-red-600 text-sm hover:text-red-800 font-medium" data-remove>
        <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7V4h6v3M4 7h16"></path>
        </svg>${t.iceRemove}
      </button>
      <div class="text-xs text-gray-500" data-i18n="autosaves">Auto-saves on change</div>
    </div>
  </div>`;
}

// --- ICE state + wiring ---
async function loadIceContacts(){
  try{
    const list = document.getElementById("iceContacts");
    list.innerHTML="";
    if(!currentUser?.id) return;
    const { data, error } = await sb.from("ice_contacts").select("*").eq("user_id", currentUser.id).order("created_at");
    if(error) throw error;
    (data||[]).forEach(row=>{
      list.insertAdjacentHTML("beforeend", contactCardTemplate(row));
    });
    wireIceCards();
    updateIceCount();
    updateProfileProgress();
  }catch(e){
    console.warn("loadIceContacts", e);
  }
}

function wireIceCards(){
  document.querySelectorAll('[data-card]').forEach(card=>{
    card.querySelectorAll('[data-field]').forEach(input=>{
      ["change","blur","input"].forEach(evt=>{
        input.addEventListener(evt, ()=>debounceSave(()=>saveIceCard(card), 600));
      });
    });
    card.querySelector('[data-remove]').addEventListener('click', ()=>removeIceCard(card));
  });
}

function updateIceCount(){
  const n = document.querySelectorAll('#iceContacts [data-card]').length;
  document.getElementById('contactCount').textContent = n;
  const btn = document.getElementById('addIceBtn');
  btn.disabled = n>=maxIce;
  btn.classList.toggle('opacity-50', n>=maxIce);
  window.iceComplete = n>0;
  updateCheckIndicator("checkContacts", window.iceComplete);
  updateProfileProgress();
}

document.getElementById('addIceBtn').addEventListener('click', ()=>{
  const n = document.querySelectorAll('#iceContacts [data-card]').length;
  if(n>=maxIce){ showToast(i18n[document.documentElement.lang]?.iceOfFive || i18n.en.iceOfFive, "warning"); return; }
  const list = document.getElementById("iceContacts");
  const tmp = { name:"", relationship:"", phone:"", email:"", notes:"" };
  list.insertAdjacentHTML("beforeend", contactCardTemplate(tmp));
  wireIceCards();
  updateIceCount();
});

async function saveIceCard(card){
  try{
    const payload = { user_id: currentUser.id };
    card.querySelectorAll('[data-field]').forEach(el=>{
      payload[el.dataset.field] = el.value.trim();
    });
    if(!payload.name || !payload.phone){ return; } // require basics

    const sbid = card.getAttribute('data-sbid');
    if(sbid){
      const { error } = await sb.from('ice_contacts').update(payload).eq('id', sbid).eq('user_id', currentUser.id);
      if(error) throw error;
    }else{
      const { data, error } = await sb.from('ice_contacts').insert(payload).select().single();
      if(error) throw error;
      card.setAttribute('data-sbid', data.id);
    }
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(e){
    console.error("saveIceCard", e);
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

async function removeIceCard(card){
  try{
    const sbid = card.getAttribute('data-sbid');
    if(sbid){
      const { error } = await sb.from('ice_contacts').delete().eq('id', sbid).eq('user_id', currentUser.id);
      if(error) throw error;
    }
  }catch(e){
    console.error("removeIceCard", e);
  }finally{
    card.remove();
    updateIceCount();
    debounceSave(()=>loadIceContacts(), 150);
  }
}

// --- TRIAGE calculation + persistence ---
function computeTriageAuto(){
  // Read from global pillData and life support
  const life = document.getElementById('lifeSupportPref')?.value || "Full";
  const conds = (pillData?.conditions||[]).join(" ").toLowerCase();
  const alls  = (pillData?.allergies||[]).join(" ").toLowerCase();

  if(life==="DNR") return "Black";

  const criticalAll = ["penicillin","morphine","codeine","fentanyl","midazolam","propofol","aspirin","ibuprofen","latex","shellfish","nut","peanut"];
  const highRisk = ["diabetes","heart","cardiac","stroke","seizure","epilep","asthma","copd","kidney","renal","liver","cancer"];

  const hasCritAll = criticalAll.some(k=>alls.includes(k));
  const hasHigh = highRisk.some(k=>conds.includes(k));
  if(hasCritAll || hasHigh || (pillData?.conditions||[]).length>3) return "Red";
  if((pillData?.allergies||[]).length>0 || (pillData?.conditions||[]).length>0 || (pillData?.medications||[]).length>2) return "Amber";
  return "Green";
}

function applyTriageBadge(level, auto=false){
  const el = document.getElementById('triageStatus');
  const t = i18n[document.documentElement.lang]||i18n.en;
  const map = {
    Green: {cls:"triage-status triage-green", text: auto?t.triageGreenAuto:t.triageGreen},
    Amber: {cls:"triage-status triage-amber", text: auto?t.triageAmberAuto:t.triageAmber},
    Red:   {cls:"triage-status triage-red",   text: auto?t.triageRedAuto:t.triageRed},
    Black: {cls:"triage-status triage-black", text: auto?t.triageBlackAuto:t.triageBlack}
  };
  el.className = map[level].cls;
  el.textContent = map[level].text;
}

async function saveTriageOverride(val){
  try{
    const { error } = await sb.from('profiles').update({ triage_override: val }).eq('id', currentUser.id);
    if(error) throw error;
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaved, "success");
  }catch(e){
    console.error("saveTriageOverride", e);
    showToast((i18n[document.documentElement.lang]||i18n.en).toastSaveError, "error");
  }
}

function updateTriage(){
  const override = document.getElementById('triageOverride').value;
  if(override){
    applyTriageBadge(override, false);
  }else{
    const auto = computeTriageAuto();
    applyTriageBadge(auto, true);
  }
}

document.getElementById('triageOverride').addEventListener('change', async (e)=>{
  await saveTriageOverride(e.target.value||null);
  updateTriage();
});

// health changes should recalc triage
["bloodType","organDonor","lifeSupportPref"].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('change', ()=>{ if(!document.getElementById('triageOverride').value){ updateTriage(); }});
});

// Pills recalc hook (called after Chunk 3 adds/ removes)
window.updateTriageFromPills = ()=>{ if(!document.getElementById('triageOverride').value){ updateTriage(); }};

// Init after session + health loaded
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadIceContacts();
  // load triage override from profiles (if present)
  try{
    const { data, error } = await sb.from('profiles').select('triage_override').eq('id', currentUser.id).single();
    if(!error && data && data.triage_override){
      document.getElementById('triageOverride').value = data.triage_override || "";
    }
  }catch(e){}
  updateTriage();
});

// --- small utils used above (debounce, toasts assumed global) ---
window._debounceTimer = window._debounceTimer || {};
function debounceSave(fn, ms){
  const k = fn.name || "key"+Math.random();
  clearTimeout(_debounceTimer[k]); _debounceTimer[k]=setTimeout(fn, ms);
}
</script>
<!-- ======== CHUNK 5: QR CODE CARD (Persistent, i18n, Supabase-wired) ======== -->
<div class="glass-card p-6 animate-fade-in-up" id="qrCard">
  <div class="card-ribbon ribbon-qr"></div>
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-slate-900" data-i18n="qr.title">Generate QR Code</h2>
    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
      </path>
    </svg>
  </div>

  <div class="text-sm text-gray-600 mb-6">
    <p class="mb-2" data-i18n="qr.subtitle">One QR code for all your emergency information.</p>
    <div class="text-xs space-y-1">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
        <span data-i18n="qr.offline">Works offline - no internet required</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
        <span data-i18n="qr.same">QR code stays the same, data updates automatically</span>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
        <span data-i18n="qr.scan">Scan with any phone camera or QR reader</span>
      </div>
    </div>
  </div>

  <div class="text-center mb-6">
    <div class="mb-4">
      <div class="text-2xl font-bold text-slate-900 mb-1">
        MYQ<span class="brand-red">ER</span><span class="text-lg">â„¢</span>
      </div>
      <div class="text-xs text-gray-500" data-i18n="qr.cardTitle">Emergency Information Card</div>
    </div>

    <div id="qrContainer" class="qr-container">
      <div class="offline-badge" data-i18n="qr.badge">WORKS OFFLINE</div>
      <canvas id="qrCanvas" width="160" height="160" style="display:none;"></canvas>
      <div id="qrPlaceholder" class="qr-placeholder">
        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
          </path>
        </svg>
        <span data-i18n="qr.complete">Complete your profile to generate QR code</span>
      </div>
    </div>

    <div class="mt-4">
      <input type="text" id="cardLink"
        class="w-full text-xs text-center border border-gray-300 rounded-lg px-3 py-2 bg-gray-50"
        readonly placeholder="https://â€¦">
      <button id="copyLinkBtn" class="text-xs text-blue-600 hover:text-blue-800 mt-2 font-medium">
        ğŸ“‹ <span data-i18n="qr.copy">Copy Shareable Link</span>
      </button>
    </div>
  </div>

  <div class="space-y-3">
    <button id="generateCodeBtn" class="btn-primary w-full">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4">
        </path>
      </svg>
      <span data-i18n="qr.generate">Generate Emergency Code</span>
    </button>

    <button id="viewCardBtn" class="btn-secondary w-full">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
      </svg>
      <span data-i18n="qr.view">View Emergency Card</span>
    </button>

    <div class="grid grid-cols-2 gap-3">
      <button id="exportPngBtn" class="btn-secondary text-sm">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
        <span data-i18n="qr.export">Export PNG</span>
      </button>
      <button id="printCardBtn" class="btn-secondary text-sm">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
          </path>
        </svg>
        <span data-i18n="qr.print">Print Card</span>
      </button>
    </div>
  </div>
</div>

<script>
/* ================== i18n (10 main languages) ================== */
const I18N = {
  en: { 'qr.title':'Generate QR Code','qr.subtitle':'One QR code for all your emergency information.',
        'qr.offline':'Works offline - no internet required','qr.same':'QR code stays the same, data updates automatically',
        'qr.scan':'Scan with any phone camera or QR reader','qr.cardTitle':'Emergency Information Card',
        'qr.badge':'WORKS OFFLINE','qr.complete':'Complete your profile to generate QR code',
        'qr.copy':'Copy Shareable Link','qr.generate':'Generate Emergency Code','qr.view':'View Emergency Card',
        'qr.export':'Export PNG','qr.print':'Print Card',
        'toast.needProfile':'Please complete your identity first (Name, DOB, Country).',
        'toast.hasCode':'Your emergency code already exists.','toast.codeCreated':'Emergency code generated.',
        'toast.error':'Something went wrong.','toast.noLink':'No link to copy. Generate your code first.',
        'toast.copied':'Link copied to clipboard.','toast.pngSaved':'QR code exported as PNG.',
        'toast.generateFirst':'Generate your QR code first.','toast.printOpen':'Opening print viewâ€¦' },
  es: { 'qr.title':'Generar cÃ³digo QR','qr.subtitle':'Un solo cÃ³digo QR para toda tu informaciÃ³n de emergencia.',
        'qr.offline':'Funciona sin internet','qr.same':'El QR no cambia; los datos se actualizan',
        'qr.scan':'EscanÃ©alo con cualquier cÃ¡mara','qr.cardTitle':'Tarjeta de InformaciÃ³n de Emergencia',
        'qr.badge':'SIN INTERNET','qr.complete':'Completa tu perfil para generar el QR',
        'qr.copy':'Copiar enlace','qr.generate':'Generar cÃ³digo de emergencia','qr.view':'Ver tarjeta de emergencia',
        'qr.export':'Exportar PNG','qr.print':'Imprimir tarjeta',
        'toast.needProfile':'Completa tu identidad (Nombre, Fecha de nacimiento, PaÃ­s).',
        'toast.hasCode':'Ya tienes cÃ³digo.','toast.codeCreated':'CÃ³digo generado.',
        'toast.error':'Ha ocurrido un error.','toast.noLink':'No hay enlace para copiar.',
        'toast.copied':'Enlace copiado.','toast.pngSaved':'QR exportado como PNG.',
        'toast.generateFirst':'Genera tu cÃ³digo primero.','toast.printOpen':'Abriendo vista de impresiÃ³nâ€¦' },
  fr: { 'qr.title':'GÃ©nÃ©rer un QR code','qr.subtitle':'Un QR unique pour toutes vos infos dâ€™urgence.',
        'qr.offline':'Fonctionne hors ligne','qr.same':'Le QR reste identique; donnÃ©es mises Ã  jour',
        'qr.scan':'Scannable par tout smartphone','qr.cardTitle':'Carte dâ€™Information dâ€™Urgence',
        'qr.badge':'HORS LIGNE','qr.complete':'ComplÃ©tez votre profil pour gÃ©nÃ©rer le QR',
        'qr.copy':'Copier le lien','qr.generate':'GÃ©nÃ©rer le code dâ€™urgence','qr.view':'Voir la carte dâ€™urgence',
        'qr.export':'Exporter PNG','qr.print':'Imprimer la carte',
        'toast.needProfile':'ComplÃ©tez votre identitÃ© (Nom, Date de naissance, Pays).',
        'toast.hasCode':'Votre code existe dÃ©jÃ .','toast.codeCreated':'Code gÃ©nÃ©rÃ©.',
        'toast.error':'Une erreur est survenue.','toast.noLink':'Aucun lien Ã  copier.',
        'toast.copied':'Lien copiÃ©.','toast.pngSaved':'QR exportÃ© en PNG.',
        'toast.generateFirst':'GÃ©nÃ©rez dâ€™abord votre code.','toast.printOpen':'Ouverture de lâ€™impressionâ€¦' },
  de: { 'qr.title':'QR-Code erzeugen','qr.subtitle':'Ein QR-Code fÃ¼r alle Notfalldaten.',
        'qr.offline':'Funktioniert offline','qr.same':'QR bleibt gleich; Daten aktualisieren sich',
        'qr.scan':'Mit jeder Kamera scannbar','qr.cardTitle':'Notfall-Informationskarte',
        'qr.badge':'OFFLINE','qr.complete':'Profil vervollstÃ¤ndigen, um QR zu erzeugen',
        'qr.copy':'Link kopieren','qr.generate':'Notfallcode erzeugen','qr.view':'Notfallkarte anzeigen',
        'qr.export':'PNG exportieren','qr.print':'Karte drucken',
        'toast.needProfile':'IdentitÃ¤t vervollstÃ¤ndigen (Name, Geburtsdatum, Land).',
        'toast.hasCode':'Code existiert bereits.','toast.codeCreated':'Code erstellt.',
        'toast.error':'Etwas ist schiefgelaufen.','toast.noLink':'Kein Link zum Kopieren.',
        'toast.copied':'Link kopiert.','toast.pngSaved':'QR als PNG exportiert.',
        'toast.generateFirst':'Zuerst QR erzeugen.','toast.printOpen':'Druckansicht wird geÃ¶ffnetâ€¦' },
  it: { 'qr.title':'Genera codice QR','qr.subtitle':'Un unico QR per tutte le info dâ€™emergenza.',
        'qr.offline':'Funziona offline','qr.same':'Il QR non cambia; i dati sÃ¬',
        'qr.scan':'Scansionabile con qualsiasi telefono','qr.cardTitle':'Carta Informazioni dâ€™Emergenza',
        'qr.badge':'OFFLINE','qr.complete':'Completa il profilo per generare il QR',
        'qr.copy':'Copia link','qr.generate':'Genera codice di emergenza','qr.view':'Vedi carta di emergenza',
        'qr.export':'Esporta PNG','qr.print':'Stampa carta',
        'toast.needProfile':'Completa identitÃ  (Nome, Data di nascita, Paese).',
        'toast.hasCode':'Codice giÃ  esistente.','toast.codeCreated':'Codice generato.',
        'toast.error':'Si Ã¨ verificato un errore.','toast.noLink':'Nessun link da copiare.',
        'toast.copied':'Link copiato.','toast.pngSaved':'QR esportato in PNG.',
        'toast.generateFirst':'Genera prima il QR.','toast.printOpen':'Apertura stampaâ€¦' },
  hi: { 'qr.title':'QR à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤à¤‚','qr.subtitle':'à¤†à¤ªà¤•à¥€ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¥‚à¤šà¤¨à¤¾ à¤•à¥‡ à¤²à¤¿à¤ à¤à¤• à¤¹à¥€ QRà¥¤',
        'qr.offline':'à¤‘à¤«à¤¼à¤²à¤¾à¤‡à¤¨ à¤•à¤¾à¤® à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆ','qr.same':'QR à¤µà¤¹à¥€ à¤°à¤¹à¤¤à¤¾ à¤¹à¥ˆ; à¤¡à¥‡à¤Ÿà¤¾ à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆ',
        'qr.scan':'à¤•à¤¿à¤¸à¥€ à¤­à¥€ à¤«à¤¼à¥‹à¤¨ à¤•à¥ˆà¤®à¤°à¥‡ à¤¸à¥‡ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚','qr.cardTitle':'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¥‚à¤šà¤¨à¤¾ à¤•à¤¾à¤°à¥à¤¡',
        'qr.badge':'à¤‘à¤«à¤¼à¤²à¤¾à¤‡à¤¨','qr.complete':'QR à¤¬à¤¨à¤¾à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤ªà¥‚à¤°à¥€ à¤•à¤°à¥‡à¤‚',
        'qr.copy':'à¤²à¤¿à¤‚à¤• à¤•à¥‰à¤ªà¥€ à¤•à¤°à¥‡à¤‚','qr.generate':'à¤‡à¤®à¤°à¤œà¥‡à¤‚à¤¸à¥€ à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤à¤','qr.view':'à¤‡à¤®à¤°à¤œà¥‡à¤‚à¤¸à¥€ à¤•à¤¾à¤°à¥à¤¡ à¤¦à¥‡à¤–à¥‡à¤‚',
        'qr.export':'PNG à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ à¤•à¤°à¥‡à¤‚','qr.print':'à¤•à¤¾à¤°à¥à¤¡ à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤•à¤°à¥‡à¤‚',
        'toast.needProfile':'à¤ªà¤¹à¤²à¥‡ à¤ªà¤¹à¤šà¤¾à¤¨ à¤ªà¥‚à¤°à¥€ à¤•à¤°à¥‡à¤‚ (à¤¨à¤¾à¤®, DOB, à¤¦à¥‡à¤¶)à¥¤',
        'toast.hasCode':'à¤•à¥‹à¤¡ à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤®à¥Œà¤œà¥‚à¤¦ à¤¹à¥ˆà¥¤','toast.codeCreated':'à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤¯à¤¾ à¤—à¤¯à¤¾à¥¤',
        'toast.error':'à¤•à¥à¤› à¤—à¤²à¤¤ à¤¹à¥‹ à¤—à¤¯à¤¾à¥¤','toast.noLink':'à¤•à¥‰à¤ªà¥€ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤²à¤¿à¤‚à¤• à¤¨à¤¹à¥€à¤‚à¥¤',
        'toast.copied':'à¤²à¤¿à¤‚à¤• à¤•à¥‰à¤ªà¥€ à¤¹à¥à¤†à¥¤','toast.pngSaved':'QR PNG à¤•à¥‡ à¤°à¥‚à¤ª à¤®à¥‡à¤‚ à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾à¥¤',
        'toast.generateFirst':'à¤ªà¤¹à¤²à¥‡ à¤…à¤ªà¤¨à¤¾ QR à¤¬à¤¨à¤¾à¤à¤‚à¥¤','toast.printOpen':'à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤¦à¥ƒà¤¶à¥à¤¯ à¤–à¥‹à¤² à¤°à¤¹à¤¾ à¤¹à¥ˆâ€¦' },
  ar: { 'qr.title':'Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR','qr.subtitle':'Ø±Ù…Ø² QR ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.',
        'qr.offline':'ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª','qr.same':'Ø§Ù„Ø±Ù…Ø² Ù„Ø§ ÙŠØªØºÙŠØ± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ­Ø¯Ù‘Ø«',
        'qr.scan':'ÙŠÙÙ…Ø³Ø­ Ø¨Ø£ÙŠ ÙƒØ§Ù…ÙŠØ±Ø§ Ù‡Ø§ØªÙ','qr.cardTitle':'Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
        'qr.badge':'Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª','qr.complete':'Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø²',
        'qr.copy':'Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·','qr.generate':'Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦','qr.view':'Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
        'qr.export':'ØªØµØ¯ÙŠØ± PNG','qr.print':'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
        'toast.needProfile':'Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡ÙˆÙŠØªÙƒ (Ø§Ù„Ø§Ø³Ù…ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ØŒ Ø§Ù„Ø¯ÙˆÙ„Ø©).',
        'toast.hasCode':'Ù„Ø¯ÙŠÙƒ Ø±Ù…Ø² Ø¨Ø§Ù„ÙØ¹Ù„.','toast.codeCreated':'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø².',
        'toast.error':'Ø­Ø¯Ø« Ø®Ø·Ø£.','toast.noLink':'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù†Ø³Ø®Ù‡.',
        'toast.copied':'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.','toast.pngSaved':'ØªÙ… ØªØµØ¯ÙŠØ± QR ÙƒÙ€ PNG.',
        'toast.generateFirst':'Ø£Ù†Ø´Ø¦ Ø§Ù„Ø±Ù…Ø² Ø£ÙˆÙ„Ø§Ù‹.','toast.printOpen':'ÙŠØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©â€¦' },
  zh: { 'qr.title':'ç”ŸæˆäºŒç»´ç ','qr.subtitle':'ä¸€ä¸ªäºŒç»´ç è¦†ç›–æ‰€æœ‰ç´§æ€¥ä¿¡æ¯ã€‚',
        'qr.offline':'ç¦»çº¿å¯ç”¨','qr.same':'äºŒç»´ç ä¸å˜ï¼›æ•°æ®è‡ªåŠ¨æ›´æ–°',
        'qr.scan':'ä»»ä½•æ‰‹æœºç›¸æœºå¯æ‰«ç ','qr.cardTitle':'ç´§æ€¥ä¿¡æ¯å¡',
        'qr.badge':'ç¦»çº¿','qr.complete':'å®Œå–„ä¸ªäººèµ„æ–™ä»¥ç”ŸæˆäºŒç»´ç ',
        'qr.copy':'å¤åˆ¶åˆ†äº«é“¾æ¥','qr.generate':'ç”Ÿæˆç´§æ€¥ä»£ç ','qr.view':'æŸ¥çœ‹ç´§æ€¥ä¿¡æ¯å¡',
        'qr.export':'å¯¼å‡º PNG','qr.print':'æ‰“å°å¡ç‰‡',
        'toast.needProfile':'è¯·å…ˆå®Œå–„èº«ä»½ä¿¡æ¯ï¼ˆå§“åã€ç”Ÿæ—¥ã€å›½å®¶ï¼‰ã€‚',
        'toast.hasCode':'å·²å­˜åœ¨ç´§æ€¥ä»£ç ã€‚','toast.codeCreated':'å·²ç”Ÿæˆä»£ç ã€‚',
        'toast.error':'å‡ºé”™å•¦ã€‚','toast.noLink':'æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥ã€‚',
        'toast.copied':'é“¾æ¥å·²å¤åˆ¶ã€‚','toast.pngSaved':'å·²å¯¼å‡º PNGã€‚',
        'toast.generateFirst':'è¯·å…ˆç”ŸæˆäºŒç»´ç ã€‚','toast.printOpen':'æ­£åœ¨æ‰“å¼€æ‰“å°è§†å›¾â€¦' },
  hu: { 'qr.title':'QR-kÃ³d generÃ¡lÃ¡sa','qr.subtitle':'Egy QR-kÃ³d minden sÃ¼rgÅ‘ssÃ©gi adathoz.',
        'qr.offline':'Internet nÃ©lkÃ¼l is mÅ±kÃ¶dik','qr.same':'A QR vÃ¡ltozatlan, az adatok frissÃ¼lnek',
        'qr.scan':'BÃ¡rmely telefonnal olvashatÃ³','qr.cardTitle':'SÃ¼rgÅ‘ssÃ©gi InformÃ¡ciÃ³s KÃ¡rtya',
        'qr.badge':'OFFLINE','qr.complete':'TÃ¶ltse ki a profilt a QR-hez',
        'qr.copy':'HivatkozÃ¡s mÃ¡solÃ¡sa','qr.generate':'VÃ©szhelyzeti kÃ³d lÃ©trehozÃ¡sa','qr.view':'KÃ¡rtya megnyitÃ¡sa',
        'qr.export':'PNG export','qr.print':'KÃ¡rtya nyomtatÃ¡sa',
        'toast.needProfile':'ElÅ‘bb egÃ©szÃ­tse ki az azonosÃ­tÃ¡st (NÃ©v, SzÃ¼letÃ©si dÃ¡tum, OrszÃ¡g).',
        'toast.hasCode':'A kÃ³d mÃ¡r lÃ©tezik.','toast.codeCreated':'KÃ³d lÃ©trehozva.',
        'toast.error':'Hiba tÃ¶rtÃ©nt.','toast.noLink':'Nincs mÃ¡solhatÃ³ link.',
        'toast.copied':'Link mÃ¡solva.','toast.pngSaved':'QR exportÃ¡lva PNG-kÃ©nt.',
        'toast.generateFirst':'ElÅ‘bb generÃ¡lja a QR-t.','toast.printOpen':'NyomtatÃ¡si nÃ©zet megnyitÃ¡saâ€¦' },
  ro: { 'qr.title':'GenereazÄƒ cod QR','qr.subtitle':'Un singur QR pentru toate informaÈ›iile de urgenÈ›Äƒ.',
        'qr.offline':'FuncÈ›ioneazÄƒ offline','qr.same':'QR rÄƒmÃ¢ne acelaÈ™i; datele se actualizeazÄƒ',
        'qr.scan':'Scanabil cu orice telefon','qr.cardTitle':'Card de InformaÈ›ii de UrgenÈ›Äƒ',
        'qr.badge':'OFFLINE','qr.complete':'CompleteazÄƒ profilul pentru a genera QR',
        'qr.copy':'CopiazÄƒ linkul','qr.generate':'GenereazÄƒ codul de urgenÈ›Äƒ','qr.view':'Vezi cardul de urgenÈ›Äƒ',
        'qr.export':'ExportÄƒ PNG','qr.print':'PrinteazÄƒ cardul',
        'toast.needProfile':'CompleteazÄƒ mai Ã®ntÃ¢i identitatea (Nume, Data naÈ™terii, Èšara).',
        'toast.hasCode':'Codul existÄƒ deja.','toast.codeCreated':'Cod generat.',
        'toast.error':'A apÄƒrut o eroare.','toast.noLink':'Nu existÄƒ link de copiat.',
        'toast.copied':'Link copiat.','toast.pngSaved':'QR exportat PNG.',
        'toast.generateFirst':'GenereazÄƒ mai Ã®ntÃ¢i QR-ul.','toast.printOpen':'Se deschide vizualizarea de tipÄƒrireâ€¦' }
};

function currentLang(){
  const sel = document.getElementById('languageSelect');
  const val = sel?.value || localStorage.getItem('lang') || 'en';
  return I18N[val] ? val : 'en';
}
function t(key){ const lang = currentLang(); return (I18N[lang] && I18N[lang][key]) || I18N.en[key] || key; }
function applyI18nForQr(){
  document.querySelectorAll('#qrCard [data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n'); el.textContent = t(k);
  });
}
document.getElementById('languageSelect')?.addEventListener('change', ()=>{
  localStorage.setItem('lang', document.getElementById('languageSelect').value);
  applyI18nForQr();
});

/* ================== QR persistence + Supabase wiring ================== */
const ORIGIN = window.location.origin;

async function ensureUserCodeOnce(){
  // 1) Try in-memory
  if (window.currentProfile?.code){
    afterCodeResolved(window.currentProfile.code, false);
    return;
  }
  // 2) Try DB
  try{
    const { data, error } = await window.sb.from('profiles').select('code').eq('id', currentUser.id).single();
    if (error && error.code !== 'PGRST116') { console.error(error); }
    if (data?.code){
      window.currentProfile = { ...(window.currentProfile||{}), code: data.code };
      afterCodeResolved(data.code, false);
      return;
    }
  }catch(e){ console.error(e); }
  // 3) No code yet -> wait for user to click Generate
  setGenerateEnabled(true);
}

function setGenerateEnabled(enabled){
  const btn = document.getElementById('generateCodeBtn');
  btn.disabled = !enabled;
  btn.style.opacity = enabled ? '1' : '0.6';
  btn.querySelector('[data-i18n="qr.generate"]').textContent = enabled ? t('qr.generate') : t('toast.hasCode');
}

function updateCardLink(code){
  const link = `${ORIGIN}/c/${code}`;
  const input = document.getElementById('cardLink');
  input.value = link;
}

function drawQr(code){
  const canvas = document.getElementById('qrCanvas');
  const placeholder = document.getElementById('qrPlaceholder');
  const url = `${ORIGIN}/c/${code}`;
  QRCode.toCanvas(canvas, url, { width:160, height:160, margin:3, color:{dark:'#000000', light:'#FFFFFF'}, errorCorrectionLevel:'M' },
    (err)=>{
      if(err){ console.error(err); placeholder.style.display='block'; canvas.style.display='none'; return; }
      placeholder.style.display='none'; canvas.style.display='block';
    }
  );
}

function afterCodeResolved(code, justCreated){
  localStorage.setItem('myqer_code', code);
  updateCardLink(code);
  drawQr(code);
  setGenerateEnabled(false);
  if (justCreated) showToast(t('toast.codeCreated'),'success');
}

/* ====== Button handlers ====== */
async function handleGenerate(){
  // basic identity completeness check (keep in sync with your other function)
  const fullName = document.getElementById('fullName')?.value?.trim();
  const dob = document.getElementById('dateOfBirth')?.value?.trim();
  const country = document.getElementById('country')?.value;
  if (!fullName || !dob || !country){ showToast(t('toast.needProfile'),'warning'); return; }

  // Double-check DB: if code exists, do not re-create (enforce single code)
  try{
    const { data: existing } = await window.sb.from('profiles').select('code').eq('id', currentUser.id).single();
    if (existing?.code){ setGenerateEnabled(false); afterCodeResolved(existing.code,false); return; }
  }catch(e){ /* ignore; proceed */ }

  // Generate short uppercase code; retry a few times if collision (belt & suspenders)
  let code;
  for (let i=0;i<5;i++){
    code = Math.random().toString(36).slice(2,8).toUpperCase();
    const { data: dup } = await window.sb.from('profiles').select('id').eq('code', code).maybeSingle?.() ?? {};
    if (!dup) break;
    code = null;
  }
  if (!code){ showToast(t('toast.error'),'error'); return; }

  // Save to profiles (upsert by id)
  try{
    const { error } = await window.sb.from('profiles').upsert({
      id: currentUser.id,
      email: currentUser.email,
      full_name: fullName,
      country: country,
      date_of_birth: dob,
      national_health_id: document.getElementById('nationalHealthId')?.value || '',
      code
    });
    if (error){ console.error(error); showToast(t('toast.error'),'error'); return; }
    window.currentProfile = { ...(window.currentProfile||{}), code };
    afterCodeResolved(code, true);
  }catch(err){ console.error(err); showToast(t('toast.error'),'error'); }
}

function handleCopy(){
  const v = document.getElementById('cardLink').value;
  if (!v){ showToast(t('toast.noLink'),'warning'); return; }
  navigator.clipboard.writeText(v).then(()=>showToast(t('toast.copied'),'success'))
    .catch(()=>showToast(t('toast.error'),'error'));
}

function handleView(){
  const code = window.currentProfile?.code;
  if (!code){ showToast(t('toast.generateFirst'),'warning'); return; }
  window.open(`${ORIGIN}/c/${code}`,'_blank');
}

function handleExportPng(){
  const canvas = document.getElementById('qrCanvas');
  if (canvas.style.display === 'none'){ showToast(t('toast.generateFirst'),'warning'); return; }
  const a = document.createElement('a');
  a.download = `MYQER-${window.currentProfile.code}-QR.png`;
  a.href = canvas.toDataURL('image/png');
  a.click();
  showToast(t('toast.pngSaved'),'success');
}

function handlePrint(){
  const code = window.currentProfile?.code;
  if (!code){ showToast(t('toast.generateFirst'),'warning'); return; }
  showToast(t('toast.printOpen'),'info');
  window.open(`${ORIGIN}/c/${code}?print=true`,'_blank');
}

/* ====== Wire up on load ====== */
(function initQrCard(){
  applyI18nForQr();
  document.getElementById('generateCodeBtn')?.addEventListener('click', handleGenerate);
  document.getElementById('copyLinkBtn')?.addEventListener('click', handleCopy);
  document.getElementById('viewCardBtn')?.addEventListener('click', handleView);
  document.getElementById('exportPngBtn')?.addEventListener('click', handleExportPng);
  document.getElementById('printCardBtn')?.addEventListener('click', handlePrint);
  ensureUserCodeOnce();
})();
</script>
<!-- ======== END CHUNK 5 ======== -->
  <!-- =========================================================
     CHUNK 6: Extras (Family/Vault/Analytics/Danger) + Help
               and a clean Footer (i18n-ready)
     Paste directly after Chunk 5â€™s QR card section
========================================================= -->

<!-- === Additional Features Grid === -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

  <!-- Family Hub (coming soon) -->
  <div class="glass-card p-6 animate-fade-in-up">
    <div class="card-ribbon ribbon-family"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-pink-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
      </svg>
      <h3 class="text-lg font-bold text-slate-900 mb-2" data-i18n="familyTitle">Family Hub</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="familySub">Manage emergency cards for kids and family members</p>
      <button class="btn-secondary w-full text-sm opacity-50 cursor-not-allowed" disabled data-i18n="comingSoon">Coming Soon</button>
    </div>
  </div>

  <!-- Documents Vault (coming soon) -->
  <div class="glass-card p-6 animate-fade-in-up">
    <div class="card-ribbon ribbon-vault"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
      </svg>
      <h3 class="text-lg font-bold text-slate-900 mb-2" data-i18n="vaultTitle">Documents Vault</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="vaultSub">Secure storage for medical documents and legal directives</p>
      <button class="btn-secondary w-full text-sm opacity-50 cursor-not-allowed" disabled data-i18n="comingSoon">Coming Soon</button>
    </div>
  </div>

  <!-- Analytics -->
  <div class="glass-card p-6 animate-fade-in-up">
    <div class="card-ribbon ribbon-analytics"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
        </path>
      </svg>
      <h3 class="text-lg font-bold text-slate-900 mb-2" data-i18n="analyticsTitle">Analytics</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="analyticsSub">Track QR code scans and access</p>
      <button class="btn-secondary w-full text-sm" id="viewStatsBtn" data-i18n="viewStats">View Stats</button>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="glass-card p-6 border-red-200 animate-fade-in-up">
    <div class="card-ribbon ribbon-danger"></div>
    <div class="text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-red-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path fill-rule="evenodd"
          d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
          clip-rule="evenodd"></path>
      </svg>
      <h3 class="text-lg font-bold text-red-600 mb-2" data-i18n="dangerTitle">Danger Zone</h3>
      <p class="text-sm text-gray-600 mb-4" data-i18n="dangerSub">Permanently delete your account</p>
      <button id="deleteAccountBtn"
        class="w-full bg-transparent border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white px-4 py-2 rounded-lg font-semibold transition-all text-sm"
        data-i18n="deleteAccount">
        Delete Account
      </button>
    </div>
  </div>

</div>
<!-- /Additional Features Grid -->

<!-- === Help & Support === -->
<div class="glass-card p-8 mb-8 animate-fade-in-up">
  <div class="card-ribbon ribbon-silver"></div>
  <div class="text-center">
    <h2 class="text-2xl font-bold text-slate-900 mb-4" data-i18n="helpTitle">Need Help?</h2>
    <p class="text-gray-600 mb-6" data-i18n="helpSub">Our support team is here to help you get the most out of MYQERâ„¢</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- FAQ -->
      <div class="text-center">
        <svg class="w-8 h-8 mx-auto mb-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
          </path>
        </svg>
        <h3 class="font-semibold text-slate-900 mb-2" data-i18n="faqTitle">FAQ</h3>
        <p class="text-sm text-gray-600 mb-3" data-i18n="faqSub">Find answers to common questions</p>
        <button class="btn-tertiary" id="faqBtn" data-i18n="viewFAQ">View FAQ</button>
      </div>

      <!-- Live Chat -->
      <div class="text-center">
        <svg class="w-8 h-8 mx-auto mb-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
          </path>
        </svg>
        <h3 class="font-semibold text-slate-900 mb-2" data-i18n="chatTitle">Live Chat</h3>
        <p class="text-sm text-gray-600 mb-3" data-i18n="chatSub">Chat with our support team</p>
        <button class="btn-tertiary" id="chatBtn" data-i18n="startChat">Start Chat</button>
      </div>

      <!-- Email Support -->
      <div class="text-center">
        <svg class="w-8 h-8 mx-auto mb-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
          </path>
        </svg>
        <h3 class="font-semibold text-slate-900 mb-2" data-i18n="emailTitle">Email Support</h3>
        <p class="text-sm text-gray-600 mb-3" data-i18n="emailSub">Send us a detailed message</p>
        <button class="btn-tertiary" id="emailBtn" data-i18n="contactUs">Contact Us</button>
      </div>
    </div>
  </div>
</div>
<!-- /Help & Support -->

</main>
<!-- /Main content -->

<!-- === Clean Footer (no Product/Support columns) === -->
<footer class="bg-white border-t border-gray-100 mt-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="flex items-center justify-between flex-col md:flex-row gap-4">
      <div class="flex items-center gap-3">
        <div class="text-2xl font-black text-slate-900">
          MYQ<span class="brand-red">ER</span><span aria-hidden="true">â„¢</span>
        </div>
        <div class="text-sm text-gray-600" data-i18n="footerTagline">
          Emergency response QR system. Your medical information, secure and accessible when it matters most.
        </div>
      </div>

      <div class="flex items-center space-x-4 text-sm text-gray-500">
        <span data-i18n="badgeEncrypted">ğŸ”’ Encrypted</span>
        <span data-i18n="badgeGlobal">ğŸŒ Global</span>
        <span data-i18n="badgeOffline">ğŸ“± Offline Ready</span>
      </div>
    </div>

    <div class="border-t border-gray-200 mt-6 pt-6 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="text-sm text-gray-600" data-i18n="copyright">
        Â© 2025 MYQERâ„¢ â€” Emergency Response QR System Â· GDPR/HIPAA-minded
      </div>
      <div class="flex items-center gap-5">
        <!-- social icons (optional) -->
        <a aria-label="Twitter" href="#" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path
              d="M24 4.56c-.88.39-1.84.65-2.84.77 1.02-.61 1.8-1.58 2.17-2.73-.96.57-2.02.98-3.15 1.2A4.93 4.93 0 0016.62 3c-2.73 0-4.94 2.22-4.94 4.96 0 .39.04.77.12 1.13-4.1-.21-7.75-2.17-10.19-5.16-.43.75-.68 1.62-.68 2.55 0 1.76.89 3.3 2.22 4.21-.83-.02-1.61-.26-2.29-.64v.06c0 2.46 1.74 4.51 4.04 4.98-.42.12-.87.18-1.33.18-.33 0-.65-.03-.96-.09.65 2.05 2.54 3.55 4.78 3.59A9.9 9.9 0 010 19.54a13.96 13.96 0 007.55 2.22c9.06 0 14.02-7.52 14.02-14.04l-.02-.64A10.04 10.04 0 0024 4.56z" />
          </svg>
        </a>
        <a aria-label="LinkedIn" href="#" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path
              d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM.5 8h4V24h-4V8zm7.5 0h3.8v2.2h.05c.53-1 1.86-2.2 3.86-2.2 4.12 0 4.88 2.7 4.88 6.2V24h-4v-7.6c0-1.82-.04-4.16-2.54-4.16-2.54 0-2.93 1.98-2.93 4.02V24h-4V8z" />
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>
<!-- /Footer -->

<!-- NOTE: Do NOT add scripts here. Next chunk (7) contains all logic. -->
  <script>
/* =========================================================
   CHUNK 7 â€” LOGIC CORE (session, i18n, saves, ICE, QR, triage)
   - Keeps your design intact
   - Works with Supabase JS v2 (already loaded on page)
   - Includes the 10 main languages you requested
   ========================================================= */

/* ---------- CONFIG ---------- */
const SUPABASE_URL = 'https://tgddpmxpbgrzrbzpomou.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnZGRwbXhwYmdyenJienBvbW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDgxMTMsImV4cCI6MjA3MTYyNDExM30.uXntx0rZISv927MQAG1LgGKA-lA08hSkzXMre7Bk2QM';
const ORIGIN = window.location.origin;

/* ---------- GLOBALS ---------- */
window.sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;
let currentProfile = null;
let iceContactCount = 0;
let pillData = { allergies: [], conditions: [], medications: [] };
let saveTimeout = null;
let currentSpeech = null;

/* ---------- I18N BUNDLES (10 languages) ---------- */
const I18N = {
  en: {
    online: "Online", logout: "Logout", worksOffline: "Works offline",
    profileCompletionTitle: "Profile Completion", completeLabel: "Complete",
    identityCheck: "Identity", healthCheck: "Health Profile", iceCheck: "ICE Contacts", codeCheck: "Emergency Code",
    identityTitle: "Identity Information", identitySub: "These details help first responders confirm who you are and contact your emergency contacts.",
    fullName: "Full Legal Name", dob: "Date of Birth", country: "Country of Residence",
    nhsId: "National Health ID", autoSaves: "Auto-saves as you type",
    healthTitle: "Health Profile", healthSub: "Critical medical information that appears on your emergency card. Keep this current and accurate.",
    bloodTypeLabel: "Blood Type", bloodHelp: "Critical for blood transfusions",
    donorLabel: "Organ Donor Status", donorHelp: "Check your driver's license or ID",
    lifeSupportLabel: "Life Support Preference",
    allergiesLabel: "Critical Allergies âš ï¸", allergiesHelp: "Include all drug allergies, food allergies, and environmental allergies that could cause severe reactions.",
    conditionsLabel: "Medical Conditions", conditionsHelp: "Include chronic conditions, mental health conditions, and any ongoing medical issues.",
    medsLabel: "Current Medications", medsHelp: "Include prescription medications, over-the-counter medications, and supplements you take regularly.",
    criticalNoticeTitle: "Critical Information Notice",
    criticalNoticeText: "This information will be visible to emergency responders. Only include details that are medically necessary for emergency treatment.",
    iceTitle: "Emergency Contacts (ICE)", iceSub: "Add up to 5 trusted people who can be reached in an emergency.",
    addIce: "Add Emergency Contact", iceCountOf: "of 5 contacts added", removeContact: "Remove Contact",
    triageTitle: "Automated Triage", triageSub: "Auto-computed priority based on your health profile.",
    triageOverrideLabel: "Manual Override",
    speak: "Speak Medical Summary", stopSpeak: "Stop Speaking",
    qrTitle: "Generate QR Code", qrSubA: "One QR code for all your emergency information.",
    qrHintOffline: "Works offline - no internet required",
    qrHintStatic: "QR code stays the same, data updates automatically",
    qrHintScan: "Scan with any phone camera or QR reader",
    copyLink: "Copy Shareable Link", viewCard: "View Emergency Card",
    exportPng: "Export PNG", printCard: "Print Card",
    analyticsTitle: "Analytics", analyticsSub: "Track QR code scans and access", totalScans: "Total Scans",
    last30Days: "Last 30 Days", today: "Today", refreshStats: "Refresh",
    toastSaved: "Saved", toastError: "Something went wrong", toastCopied: "Link copied",
    needIdentity: "Please complete your identity information first (Name, Date of Birth, Country)",
    codeExists: "You already have an emergency code", codeCreated: "Emergency code generated",
    noLink: "No link to copy - generate your emergency code first",
    maxContacts: "Maximum 5 contacts allowed", contactAdded: "Contact added", contactRemoved: "Contact removed",
    speechNotSupported: "Speech synthesis not supported in this browser",
  },
  es: { /* EspaÃ±ol */
    online:"En lÃ­nea", logout:"Cerrar sesiÃ³n", worksOffline:"Funciona sin conexiÃ³n",
    profileCompletionTitle:"CompleciÃ³n del perfil", completeLabel:"Completado",
    identityCheck:"Identidad", healthCheck:"Perfil de salud", iceCheck:"Contactos ICE", codeCheck:"CÃ³digo de emergencia",
    identityTitle:"InformaciÃ³n de identidad", identitySub:"Estos datos ayudan a confirmar quiÃ©n eres y contactar a tus contactos de emergencia.",
    fullName:"Nombre legal completo", dob:"Fecha de nacimiento", country:"PaÃ­s de residencia",
    nhsId:"ID de salud nacional", autoSaves:"Guarda automÃ¡ticamente mientras escribes",
    healthTitle:"Perfil de salud", healthSub:"InformaciÃ³n mÃ©dica crÃ­tica que aparece en tu tarjeta de emergencia.",
    bloodTypeLabel:"Tipo de sangre", bloodHelp:"Crucial para transfusiones",
    donorLabel:"Donante de Ã³rganos", donorHelp:"Revisa tu licencia o identificaciÃ³n",
    lifeSupportLabel:"Preferencia de soporte vital",
    allergiesLabel:"Alergias crÃ­ticas âš ï¸", allergiesHelp:"Incluye todas las alergias a fÃ¡rmacos, alimentos y ambientales que puedan causar reacciones graves.",
    conditionsLabel:"Condiciones mÃ©dicas", conditionsHelp:"Incluye crÃ³nicas, salud mental y problemas en curso.",
    medsLabel:"Medicamentos actuales", medsHelp:"Incluye de receta, venta libre y suplementos.",
    criticalNoticeTitle:"Aviso de informaciÃ³n crÃ­tica",
    criticalNoticeText:"Visible para emergencistas. Solo informaciÃ³n necesaria para el tratamiento.",
    iceTitle:"Contactos de emergencia (ICE)", iceSub:"Agrega hasta 5 personas de confianza.",
    addIce:"Agregar contacto de emergencia", iceCountOf:"de 5 contactos agregados", removeContact:"Eliminar contacto",
    triageTitle:"Triaje automatizado", triageSub:"Prioridad calculada automÃ¡ticamente.",
    triageOverrideLabel:"AnulaciÃ³n manual",
    speak:"Leer resumen mÃ©dico", stopSpeak:"Detener",
    qrTitle:"Generar cÃ³digo QR", qrSubA:"Un Ãºnico cÃ³digo QR para toda tu informaciÃ³n.",
    qrHintOffline:"Funciona sin internet",
    qrHintStatic:"El QR no cambia, los datos sÃ­",
    qrHintScan:"EscanÃ©alo con cualquier cÃ¡mara",
    copyLink:"Copiar enlace", viewCard:"Ver tarjeta de emergencia",
    exportPng:"Exportar PNG", printCard:"Imprimir tarjeta",
    analyticsTitle:"AnalÃ­tica", analyticsSub:"Seguimiento de escaneos del QR", totalScans:"Escaneos totales",
    last30Days:"Ãšltimos 30 dÃ­as", today:"Hoy", refreshStats:"Actualizar",
    toastSaved:"Guardado", toastError:"OcurriÃ³ un error", toastCopied:"Enlace copiado",
    needIdentity:"Completa identidad primero (Nombre, Fecha de nacimiento, PaÃ­s)",
    codeExists:"Ya tienes un cÃ³digo", codeCreated:"CÃ³digo generado",
    noLink:"No hay enlace para copiar",
    maxContacts:"MÃ¡ximo 5 contactos", contactAdded:"Contacto agregado", contactRemoved:"Contacto eliminado",
    speechNotSupported:"El navegador no soporta voz",
  },
  fr: { online:"En ligne", logout:"DÃ©connexion", worksOffline:"Fonctionne hors ligne",
    profileCompletionTitle:"ComplÃ©tion du profil", completeLabel:"TerminÃ©",
    identityCheck:"IdentitÃ©", healthCheck:"Profil santÃ©", iceCheck:"Contacts ICE", codeCheck:"Code d'urgence",
    identityTitle:"Informations dâ€™identitÃ©", identitySub:"Aide Ã  confirmer votre identitÃ© et contacter vos proches.",
    fullName:"Nom lÃ©gal complet", dob:"Date de naissance", country:"Pays de rÃ©sidence",
    nhsId:"ID de santÃ© national", autoSaves:"Enregistrement automatique",
    healthTitle:"Profil santÃ©", healthSub:"Informations mÃ©dicales critiques sur votre carte dâ€™urgence.",
    bloodTypeLabel:"Groupe sanguin", bloodHelp:"Crucial pour les transfusions",
    donorLabel:"Don dâ€™organes", donorHelp:"VÃ©rifiez votre permis/ID",
    lifeSupportLabel:"PrÃ©fÃ©rence de maintien en vie",
    allergiesLabel:"Allergies critiques âš ï¸", allergiesHelp:"Inclure mÃ©dicaments, aliments, environnement.",
    conditionsLabel:"Affections mÃ©dicales", conditionsHelp:"Chroniques, mentales, en cours.",
    medsLabel:"MÃ©dicaments actuels", medsHelp:"Prescription, OTC, supplÃ©ments.",
    criticalNoticeTitle:"Avis dâ€™information critique",
    criticalNoticeText:"Visible par les secours. Uniquement le nÃ©cessaire.",
    iceTitle:"Contacts dâ€™urgence (ICE)", iceSub:"Ajoutez jusquâ€™Ã  5 personnes.",
    addIce:"Ajouter un contact", iceCountOf:"sur 5 contacts ajoutÃ©s", removeContact:"Supprimer",
    triageTitle:"Triage automatisÃ©", triageSub:"PrioritÃ© calculÃ©e automatiquement.",
    triageOverrideLabel:"Forcer manuellement",
    speak:"Lire le rÃ©sumÃ© mÃ©dical", stopSpeak:"ArrÃªter",
    qrTitle:"GÃ©nÃ©rer un QR", qrSubA:"Un QR unique pour vos informations.",
    qrHintOffline:"Hors ligne", qrHintStatic:"QR constant, donnÃ©es mises Ã  jour",
    qrHintScan:"Lisible par toute camÃ©ra",
    copyLink:"Copier le lien", viewCard:"Voir la carte",
    exportPng:"Exporter PNG", printCard:"Imprimer",
    analyticsTitle:"Statistiques", analyticsSub:"Suivi des scans", totalScans:"Total",
    last30Days:"30 derniers jours", today:"Aujourdâ€™hui", refreshStats:"RafraÃ®chir",
    toastSaved:"EnregistrÃ©", toastError:"Erreur", toastCopied:"Lien copiÃ©",
    needIdentity:"ComplÃ©tez dâ€™abord lâ€™identitÃ© (Nom, Date, Pays)",
    codeExists:"Vous avez dÃ©jÃ  un code", codeCreated:"Code gÃ©nÃ©rÃ©",
    noLink:"Aucun lien Ã  copier", maxContacts:"5 contacts max",
    contactAdded:"Contact ajoutÃ©", contactRemoved:"Contact supprimÃ©",
    speechNotSupported:"SynthÃ¨se vocale non supportÃ©e",
  },
  de: { online:"Online", logout:"Abmelden", worksOffline:"Offline nutzbar",
    profileCompletionTitle:"Profilabschluss", completeLabel:"Fertig",
    identityCheck:"IdentitÃ¤t", healthCheck:"Gesundheitsprofil", iceCheck:"ICE-Kontakte", codeCheck:"Notfallcode",
    identityTitle:"IdentitÃ¤tsinformationen", identitySub:"Hilft Ersthelfern, Sie zu identifizieren und Kontakte zu erreichen.",
    fullName:"VollstÃ¤ndiger Name", dob:"Geburtsdatum", country:"Wohnsitzland",
    nhsId:"Gesundheits-ID", autoSaves:"Automatisch gespeichert",
    healthTitle:"Gesundheitsprofil", healthSub:"Kritische Infos fÃ¼r Ihre Notfallkarte.",
    bloodTypeLabel:"Blutgruppe", bloodHelp:"Wichtig fÃ¼r Transfusionen",
    donorLabel:"Organspenderstatus", donorHelp:"Ausweis prÃ¼fen",
    lifeSupportLabel:"Lebenserhaltende MaÃŸnahmen",
    allergiesLabel:"Kritische Allergien âš ï¸", allergiesHelp:"Alle schweren Allergien angeben.",
    conditionsLabel:"Erkrankungen", conditionsHelp:"Chronisch, psychisch, laufend.",
    medsLabel:"Medikamente", medsHelp:"Verschreibung, OTC, Supplemente.",
    criticalNoticeTitle:"Wichtiger Hinweis",
    criticalNoticeText:"Nur medizinisch notwendige Angaben.",
    iceTitle:"Notfallkontakte (ICE)", iceSub:"Bis zu 5 Vertrauenspersonen.",
    addIce:"Kontakt hinzufÃ¼gen", iceCountOf:"von 5 Kontakten", removeContact:"Kontakt entfernen",
    triageTitle:"Automatisches Triage", triageSub:"PrioritÃ¤t automatisch berechnet.",
    triageOverrideLabel:"Manuell Ã¼berschreiben",
    speak:"Medizinische Zusammenfassung vorlesen", stopSpeak:"Stopp",
    qrTitle:"QR-Code erzeugen", qrSubA:"Ein einziger QR fÃ¼r alles.",
    qrHintOffline:"Offline", qrHintStatic:"QR konstant, Daten aktuell",
    qrHintScan:"Mit jeder Kamera scannbar",
    copyLink:"Link kopieren", viewCard:"Notfallkarte anzeigen",
    exportPng:"PNG exportieren", printCard:"Karte drucken",
    analyticsTitle:"Analytik", analyticsSub:"Scans verfolgen", totalScans:"Gesamt",
    last30Days:"Letzte 30 Tage", today:"Heute", refreshStats:"Aktualisieren",
    toastSaved:"Gespeichert", toastError:"Fehler", toastCopied:"Link kopiert",
    needIdentity:"Erst IdentitÃ¤t vervollstÃ¤ndigen (Name, Datum, Land)",
    codeExists:"Code existiert bereits", codeCreated:"Code erstellt",
    noLink:"Kein Link zum Kopieren", maxContacts:"Max. 5 Kontakte",
    contactAdded:"Kontakt hinzugefÃ¼gt", contactRemoved:"Kontakt entfernt",
    speechNotSupported:"Sprachausgabe nicht unterstÃ¼tzt",
  },
  it: { online:"Online", logout:"Esci", worksOffline:"Funziona offline",
    profileCompletionTitle:"Completamento profilo", completeLabel:"Completo",
    identityCheck:"IdentitÃ ", healthCheck:"Profilo sanitario", iceCheck:"Contatti ICE", codeCheck:"Codice dâ€™emergenza",
    identityTitle:"Informazioni di identitÃ ", identitySub:"Aiuta i soccorritori a identificarti e contattare i tuoi contatti.",
    fullName:"Nome completo", dob:"Data di nascita", country:"Paese di residenza",
    nhsId:"ID sanitario nazionale", autoSaves:"Salvataggio automatico",
    healthTitle:"Profilo sanitario", healthSub:"Informazioni critiche sulla tua carta dâ€™emergenza.",
    bloodTypeLabel:"Gruppo sanguigno", bloodHelp:"Cruciale per trasfusioni",
    donorLabel:"Donatore di organi", donorHelp:"Controlla patente/ID",
    lifeSupportLabel:"Preferenza supporto vitale",
    allergiesLabel:"Allergie critiche âš ï¸", allergiesHelp:"Farmaci, alimenti, ambientali.",
    conditionsLabel:"Condizioni mediche", conditionsHelp:"Croniche, mentali, in corso.",
    medsLabel:"Farmaci correnti", medsHelp:"Ricetta, OTC, integratori.",
    criticalNoticeTitle:"Avviso informazione critica",
    criticalNoticeText:"Visibile ai soccorritori. Solo necessario.",
    iceTitle:"Contatti dâ€™emergenza (ICE)", iceSub:"Fino a 5 persone fidate.",
    addIce:"Aggiungi contatto", iceCountOf:"di 5 contatti", removeContact:"Rimuovi contatto",
    triageTitle:"Triage automatizzato", triageSub:"PrioritÃ  calcolata automaticamente.",
    triageOverrideLabel:"Forza manualmente",
    speak:"Leggi riepilogo medico", stopSpeak:"Ferma",
    qrTitle:"Genera QR", qrSubA:"Un unico QR per tutto.",
    qrHintOffline:"Offline", qrHintStatic:"QR fisso, dati aggiornati",
    qrHintScan:"Scansionabile con qualsiasi camera",
    copyLink:"Copia link", viewCard:"Vedi carta dâ€™emergenza",
    exportPng:"Esporta PNG", printCard:"Stampa carta",
    analyticsTitle:"Analitica", analyticsSub:"Traccia scansioni", totalScans:"Totale",
    last30Days:"Ultimi 30 giorni", today:"Oggi", refreshStats:"Aggiorna",
    toastSaved:"Salvato", toastError:"Errore", toastCopied:"Link copiato",
    needIdentity:"Completa identitÃ  (Nome, Data, Paese)",
    codeExists:"Hai giÃ  un codice", codeCreated:"Codice generato",
    noLink:"Nessun link da copiare", maxContacts:"Massimo 5 contatti",
    contactAdded:"Contatto aggiunto", contactRemoved:"Contatto rimosso",
    speechNotSupported:"Sintesi vocale non supportata",
  },
  hi: { online:"à¤‘à¤¨à¤²à¤¾à¤‡à¤¨", logout:"à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ", worksOffline:"à¤‘à¤«à¤¼à¤²à¤¾à¤‡à¤¨ à¤•à¤¾à¤® à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆ",
    profileCompletionTitle:"à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤ªà¥‚à¤°à¥à¤£à¤¤à¤¾", completeLabel:"à¤ªà¥‚à¤°à¥à¤£",
    identityCheck:"à¤ªà¤¹à¤šà¤¾à¤¨", healthCheck:"à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤²", iceCheck:"ICE à¤¸à¤‚à¤ªà¤°à¥à¤•", codeCheck:"à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤² à¤•à¥‹à¤¡",
    identityTitle:"à¤ªà¤¹à¤šà¤¾à¤¨ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€", identitySub:"à¤ªà¤¹à¤šà¤¾à¤¨ à¤•à¥€ à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤”à¤° à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤•à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤à¥¤",
    fullName:"à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®", dob:"à¤œà¤¨à¥à¤® à¤¤à¤¿à¤¥à¤¿", country:"à¤¨à¤¿à¤µà¤¾à¤¸ à¤¦à¥‡à¤¶",
    nhsId:"à¤°à¤¾à¤·à¥à¤Ÿà¥à¤°à¥€à¤¯ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ ID", autoSaves:"à¤Ÿà¤¾à¤‡à¤ª à¤•à¤°à¤¤à¥‡ à¤¹à¥€ à¤¸à¤¹à¥‡à¤œà¤¤à¤¾ à¤¹à¥ˆ",
    healthTitle:"à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤²", healthSub:"à¤†à¤ªà¤•à¥€ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤•à¤¾à¤°à¥à¤¡ à¤ªà¤° à¤¦à¤¿à¤–à¤¤à¤¾ à¤¹à¥ˆà¥¤",
    bloodTypeLabel:"à¤¬à¥à¤²à¤¡ à¤Ÿà¤¾à¤‡à¤ª", bloodHelp:"à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤«à¤¼à¥à¤¯à¥‚à¤œà¤¨ à¤¹à¥‡à¤¤à¥",
    donorLabel:"à¤…à¤‚à¤— à¤¦à¤¾à¤¤à¤¾ à¤¸à¥à¤¥à¤¿à¤¤à¤¿", donorHelp:"à¤²à¤¾à¤‡à¤¸à¥‡à¤‚à¤¸/ID à¤¦à¥‡à¤–à¥‡à¤‚",
    lifeSupportLabel:"à¤²à¤¾à¤‡à¤« à¤¸à¤ªà¥‹à¤°à¥à¤Ÿ à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾",
    allergiesLabel:"à¤—à¤‚à¤­à¥€à¤° à¤à¤²à¤°à¥à¤œà¥€ âš ï¸", allergiesHelp:"à¤¦à¤µà¤¾, à¤­à¥‹à¤œà¤¨, à¤ªà¤°à¥à¤¯à¤¾à¤µà¤°à¤£à¥¤",
    conditionsLabel:"à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¸à¥à¤¥à¤¿à¤¤à¤¿à¤¯à¤¾à¤", conditionsHelp:"à¤•à¥à¤°à¥‰à¤¨à¤¿à¤•, à¤®à¤¾à¤¨à¤¸à¤¿à¤•, à¤šà¤² à¤°à¤¹à¥€à¥¤",
    medsLabel:"à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤¦à¤µà¤¾à¤à¤", medsHelp:"à¤ªà¥à¤°à¤¿à¤¸à¥à¤•à¥à¤°à¤¿à¤ªà¥à¤¶à¤¨, OTC, à¤¸à¤ªà¥à¤²à¥€à¤®à¥‡à¤‚à¤Ÿà¥¤",
    criticalNoticeTitle:"à¤®à¤¹à¤¤à¥à¤µà¤ªà¥‚à¤°à¥à¤£ à¤¸à¥‚à¤šà¤¨à¤¾",
    criticalNoticeText:"à¤•à¥‡à¤µà¤² à¤‰à¤ªà¤šà¤¾à¤° à¤¹à¥‡à¤¤à¥ à¤†à¤µà¤¶à¥à¤¯à¤• à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¶à¤¾à¤®à¤¿à¤² à¤•à¤°à¥‡à¤‚à¥¤",
    iceTitle:"à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤‚à¤ªà¤°à¥à¤• (ICE)", iceSub:"5 à¤¤à¤• à¤µà¤¿à¤¶à¥à¤µà¤¸à¤¨à¥€à¤¯ à¤²à¥‹à¤— à¤œà¥‹à¤¡à¤¼à¥‡à¤‚à¥¤",
    addIce:"à¤¸à¤‚à¤ªà¤°à¥à¤• à¤œà¥‹à¤¡à¤¼à¥‡à¤‚", iceCountOf:"à¤®à¥‡à¤‚ à¤¸à¥‡ 5 à¤œà¥‹à¤¡à¤¼à¥‡ à¤—à¤", removeContact:"à¤¹à¤Ÿà¤¾à¤à¤",
    triageTitle:"à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤Ÿà¥à¤°à¤¾à¤¯à¤¾à¤œ", triageSub:"à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤•à¥‡ à¤†à¤§à¤¾à¤° à¤ªà¤°à¥¤",
    triageOverrideLabel:"à¤®à¥ˆà¤¨à¥à¤…à¤² à¤“à¤µà¤°à¤°à¤¾à¤‡à¤¡",
    speak:"à¤®à¥‡à¤¡à¤¿à¤•à¤² à¤¸à¤¾à¤°à¤¾à¤‚à¤¶ à¤¬à¥‹à¤²à¥‡à¤‚", stopSpeak:"à¤°à¥‹à¤•à¥‡à¤‚",
    qrTitle:"QR à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤à¤‚", qrSubA:"à¤à¤• à¤¹à¥€ QR à¤¸à¤¬à¤•à¥‡ à¤²à¤¿à¤à¥¤",
    qrHintOffline:"à¤‘à¤«à¤¼à¤²à¤¾à¤‡à¤¨", qrHintStatic:"QR à¤µà¤¹à¥€, à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤¯à¤¾",
    qrHintScan:"à¤•à¤¿à¤¸à¥€ à¤­à¥€ à¤•à¥ˆà¤®à¤°à¥‡ à¤¸à¥‡ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚",
    copyLink:"à¤²à¤¿à¤‚à¤• à¤•à¥‰à¤ªà¥€", viewCard:"à¤•à¤¾à¤°à¥à¤¡ à¤¦à¥‡à¤–à¥‡à¤‚",
    exportPng:"PNG à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤", printCard:"à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ",
    analyticsTitle:"à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£", analyticsSub:"à¤¸à¥à¤•à¥ˆà¤¨ à¤Ÿà¥à¤°à¥ˆà¤• à¤•à¤°à¥‡à¤‚", totalScans:"à¤•à¥à¤²",
    last30Days:"à¤ªà¤¿à¤›à¤²à¥‡ 30 à¤¦à¤¿à¤¨", today:"à¤†à¤œ", refreshStats:"à¤°à¤¿à¤«à¤¼à¥à¤°à¥‡à¤¶",
    toastSaved:"à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾", toastError:"à¤¤à¥à¤°à¥à¤Ÿà¤¿", toastCopied:"à¤²à¤¿à¤‚à¤• à¤•à¥‰à¤ªà¥€ à¤¹à¥à¤†",
    needIdentity:"à¤ªà¤¹à¤²à¥‡ à¤ªà¤¹à¤šà¤¾à¤¨ à¤ªà¥‚à¤°à¥€ à¤•à¤°à¥‡à¤‚ (à¤¨à¤¾à¤®, à¤œà¤¨à¥à¤® à¤¤à¤¿à¤¥à¤¿, à¤¦à¥‡à¤¶)",
    codeExists:"à¤•à¥‹à¤¡ à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤®à¥Œà¤œà¥‚à¤¦", codeCreated:"à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾",
    noLink:"à¤•à¥‰à¤ªà¥€ à¤•à¤°à¤¨à¥‡ à¤•à¥‹ à¤²à¤¿à¤‚à¤• à¤¨à¤¹à¥€à¤‚", maxContacts:"à¤…à¤§à¤¿à¤•à¤¤à¤® 5 à¤¸à¤‚à¤ªà¤°à¥à¤•",
    contactAdded:"à¤¸à¤‚à¤ªà¤°à¥à¤• à¤œà¥‹à¤¡à¤¼à¤¾", contactRemoved:"à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¹à¤Ÿà¤¾à¤¯à¤¾",
    speechNotSupported:"à¤¬à¥à¤°à¤¾à¤‰à¤œà¤¼à¤° à¤®à¥‡à¤‚ à¤µà¥‰à¤‡à¤¸ à¤¸à¤ªà¥‹à¤°à¥à¤Ÿ à¤¨à¤¹à¥€à¤‚",
  },
  ar: { online:"Ù…ØªØµÙ„", logout:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", worksOffline:"ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„",
    profileCompletionTitle:"Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù", completeLabel:"Ù…ÙƒØªÙ…Ù„",
    identityCheck:"Ø§Ù„Ù‡ÙˆÙŠØ©", healthCheck:"Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ", iceCheck:"Ø¬Ù‡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦", codeCheck:"Ø±Ù…Ø² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",
    identityTitle:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ©", identitySub:"ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø¹ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙƒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¬Ù‡Ø§ØªÙƒ.",
    fullName:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„", dob:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯", country:"Ø¨Ù„Ø¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©",
    nhsId:"Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ØµØ­Ø© Ø§Ù„ÙˆØ·Ù†ÙŠ", autoSaves:"Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ",
    healthTitle:"Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ", healthSub:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø±Ø¬Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
    bloodTypeLabel:"ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…", bloodHelp:"Ù…Ù‡Ù… Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù…",
    donorLabel:"Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡", donorHelp:"ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø±Ø®ØµØ©",
    lifeSupportLabel:"ØªÙØ¶ÙŠÙ„ Ø¯Ø¹Ù… Ø§Ù„Ø­ÙŠØ§Ø©",
    allergiesLabel:"Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø­Ø±Ø¬Ø© âš ï¸", allergiesHelp:"Ø£Ø¯ÙˆÙŠØ©ØŒ Ø£Ø·Ø¹Ù…Ø©ØŒ Ø¨ÙŠØ¦Ø©.",
    conditionsLabel:"Ø­Ø§Ù„Ø§Øª Ø·Ø¨ÙŠØ©", conditionsHelp:"Ù…Ø²Ù…Ù†Ø© ÙˆÙ†ÙØ³ÙŠØ© ÙˆØ¬Ø§Ø±ÙŠØ©.",
    medsLabel:"Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©", medsHelp:"Ø±ÙˆØ´ØªØ© ÙˆØ¨Ø¯ÙˆÙ† ÙˆØµÙØ© ÙˆÙ…ÙƒÙ…Ù„Ø§Øª.",
    criticalNoticeTitle:"ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø±Ø¬Ø©",
    criticalNoticeText:"Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ù…Ø³Ø¹ÙÙŠÙ†. Ø£Ø¯Ø±Ø¬ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ ÙÙ‚Ø·.",
    iceTitle:"Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦", iceSub:"Ø£Ø¶Ù Ø­ØªÙ‰ 5 Ø£Ø´Ø®Ø§Øµ Ù…ÙˆØ«ÙˆÙ‚ÙŠÙ†.",
    addIce:"Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„", iceCountOf:"Ù…Ù† 5 ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ù…", removeContact:"Ø¥Ø²Ø§Ù„Ø©",
    triageTitle:"ÙØ±Ø² Ø¢Ù„ÙŠ", triageSub:"Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.",
    triageOverrideLabel:"ØªØ¬Ø§ÙˆØ² ÙŠØ¯ÙˆÙŠ",
    speak:"Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ø¨ÙŠ", stopSpeak:"Ø¥ÙŠÙ‚Ø§Ù",
    qrTitle:"Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR", qrSubA:"Ø±Ù…Ø² ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ.",
    qrHintOffline:"ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª", qrHintStatic:"Ø§Ù„Ø±Ù…Ø² Ø«Ø§Ø¨Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ­Ø¯Ù‘Ø«",
    qrHintScan:"ÙŠÙ…Ø³Ø­ Ø¨Ø£ÙŠ ÙƒØ§Ù…ÙŠØ±Ø§",
    copyLink:"Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·", viewCard:"Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",
    exportPng:"ØªØµØ¯ÙŠØ± PNG", printCard:"Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©",
    analyticsTitle:"Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª", analyticsSub:"ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø­Ø§Øª", totalScans:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
    last30Days:"Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ù‹Ø§", today:"Ø§Ù„ÙŠÙˆÙ…", refreshStats:"ØªØ­Ø¯ÙŠØ«",
    toastSaved:"ØªÙ… Ø§Ù„Ø­ÙØ¸", toastError:"Ø­Ø¯Ø« Ø®Ø·Ø£", toastCopied:"ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·",
    needIdentity:"Ø£ÙƒÙ…Ù„ Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆÙ„Ù‹Ø§ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ØŒ Ø§Ù„Ø¨Ù„Ø¯)",
    codeExists:"Ù„Ø¯ÙŠÙƒ Ø±Ù…Ø² Ø¨Ø§Ù„ÙØ¹Ù„", codeCreated:"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø²",
    noLink:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„Ù†Ø³Ø®", maxContacts:"Ø§Ù„Ø­Ø¯ 5 Ø¬Ù‡Ø§Øª", contactAdded:"ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©", contactRemoved:"ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø©",
    speechNotSupported:"Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù†Ø·Ù‚",
  },
  zh: { online:"åœ¨çº¿", logout:"ç™»å‡º", worksOffline:"ç¦»çº¿å¯ç”¨",
    profileCompletionTitle:"èµ„æ–™å®Œæˆåº¦", completeLabel:"å®Œæˆ",
    identityCheck:"èº«ä»½", healthCheck:"å¥åº·èµ„æ–™", iceCheck:"ç´§æ€¥è”ç³»äºº", codeCheck:"åº”æ€¥ç ",
    identityTitle:"èº«ä»½ä¿¡æ¯", identitySub:"ç”¨äºç¡®è®¤èº«ä»½å¹¶è”ç³»ç´§æ€¥è”ç³»äººã€‚",
    fullName:"æ³•å®šå…¨å", dob:"å‡ºç”Ÿæ—¥æœŸ", country:"å±…ä½å›½å®¶",
    nhsId:"å›½å®¶å¥åº·ID", autoSaves:"è¾“å…¥å³è‡ªåŠ¨ä¿å­˜",
    healthTitle:"å¥åº·èµ„æ–™", healthSub:"ä¼šæ˜¾ç¤ºåœ¨ä½ çš„åº”æ€¥å¡ä¸Šã€‚",
    bloodTypeLabel:"è¡€å‹", bloodHelp:"è¾“è¡€å…³é”®",
    donorLabel:"å™¨å®˜æçŒ®", donorHelp:"æŸ¥çœ‹è¯ä»¶",
    lifeSupportLabel:"ç”Ÿå‘½æ”¯æŒåå¥½",
    allergiesLabel:"ä¸¥é‡è¿‡æ• âš ï¸", allergiesHelp:"è¯ç‰©ã€é£Ÿç‰©ã€ç¯å¢ƒè¿‡æ•ã€‚",
    conditionsLabel:"ç–¾ç—…çŠ¶å†µ", conditionsHelp:"æ…¢æ€§ã€ç²¾ç¥åŠè¿›è¡Œä¸­é—®é¢˜ã€‚",
    medsLabel:"å½“å‰ç”¨è¯", medsHelp:"å¤„æ–¹ã€éå¤„æ–¹ã€è¡¥å……å‰‚ã€‚",
    criticalNoticeTitle:"é‡è¦æç¤º",
    criticalNoticeText:"ä»…å¡«å†™æ•‘æ²»æ‰€éœ€ä¿¡æ¯ã€‚",
    iceTitle:"ç´§æ€¥è”ç³»äºº (ICE)", iceSub:"æœ€å¤šæ·»åŠ  5 ä½å¯ä¿¡è”ç³»äººã€‚",
    addIce:"æ·»åŠ è”ç³»äºº", iceCountOf:"å·²æ·»åŠ ï¼ˆæœ€å¤š5ï¼‰", removeContact:"ç§»é™¤",
    triageTitle:"è‡ªåŠ¨åˆ†è¯Š", triageSub:"åŸºäºå¥åº·èµ„æ–™è‡ªåŠ¨è®¡ç®—ã€‚",
    triageOverrideLabel:"æ‰‹åŠ¨è¦†ç›–",
    speak:"æœ—è¯»åŒ»å­¦æ‘˜è¦", stopSpeak:"åœæ­¢",
    qrTitle:"ç”ŸæˆäºŒç»´ç ", qrSubA:"ä¸€ä¸ªäºŒç»´ç åŒ…å«å…¨éƒ¨ä¿¡æ¯ã€‚",
    qrHintOffline:"ç¦»çº¿å¯ç”¨", qrHintStatic:"ç ä¸å˜ï¼Œæ•°æ®æ›´æ–°",
    qrHintScan:"ä»»æ„ç›¸æœºå¯æ‰«ç ",
    copyLink:"å¤åˆ¶é“¾æ¥", viewCard:"æŸ¥çœ‹åº”æ€¥å¡",
    exportPng:"å¯¼å‡º PNG", printCard:"æ‰“å°",
    analyticsTitle:"åˆ†æ", analyticsSub:"è¿½è¸ªæ‰«ç æ¬¡æ•°", totalScans:"æ€»è®¡",
    last30Days:"è¿‘30å¤©", today:"ä»Šå¤©", refreshStats:"åˆ·æ–°",
    toastSaved:"å·²ä¿å­˜", toastError:"å‡ºé”™äº†", toastCopied:"å·²å¤åˆ¶",
    needIdentity:"è¯·å…ˆå®Œå–„èº«ä»½ä¿¡æ¯ï¼ˆå§“å/ç”Ÿæ—¥/å›½å®¶ï¼‰",
    codeExists:"ä½ å·²æœ‰åº”æ€¥ç ", codeCreated:"å·²ç”Ÿæˆåº”æ€¥ç ",
    noLink:"æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥", maxContacts:"æœ€å¤š 5 ä½è”ç³»äºº",
    contactAdded:"å·²æ·»åŠ è”ç³»äºº", contactRemoved:"å·²ç§»é™¤è”ç³»äºº",
    speechNotSupported:"æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³",
  },
  hu: { online:"Online", logout:"KijelentkezÃ©s", worksOffline:"Offline is mÅ±kÃ¶dik",
    profileCompletionTitle:"ProfilkÃ©szÃ¼ltsÃ©g", completeLabel:"KÃ©sz",
    identityCheck:"SzemÃ©lyazonossÃ¡g", healthCheck:"EgÃ©szsÃ©gÃ¼gyi profil", iceCheck:"ICE kapcsolatok", codeCheck:"VÃ©szhelyzeti kÃ³d",
    identityTitle:"SzemÃ©lyes adatok", identitySub:"AzonosÃ­tÃ¡shoz Ã©s kapcsolattartÃ¡shoz.",
    fullName:"Teljes nÃ©v", dob:"SzÃ¼letÃ©si dÃ¡tum", country:"LakÃ³hely orszÃ¡ga",
    nhsId:"Nemzeti egÃ©szsÃ©gÃ¼gyi azonosÃ­tÃ³", autoSaves:"Automatikus mentÃ©s gÃ©pelÃ©s kÃ¶zben",
    healthTitle:"EgÃ©szsÃ©gÃ¼gyi profil", healthSub:"A vÃ©szhelyzeti kÃ¡rtyÃ¡n jelenik meg.",
    bloodTypeLabel:"VÃ©rcsoport", bloodHelp:"TranszfÃºziÃ³hoz fontos",
    donorLabel:"Szervdonor", donorHelp:"EllenÅ‘rizd az igazolvÃ¡nyt",
    lifeSupportLabel:"Ã‰letjeleztetÃ©si preferencia",
    allergiesLabel:"Kritikus allergiÃ¡k âš ï¸", allergiesHelp:"GyÃ³gyszer, Ã©tel, kÃ¶rnyezet.",
    conditionsLabel:"BetegsÃ©gek", conditionsHelp:"KrÃ³nikus, mentÃ¡lis, folyamatban.",
    medsLabel:"GyÃ³gyszerek", medsHelp:"Receptre/OTC/kiegÃ©szÃ­tÅ‘k.",
    criticalNoticeTitle:"Fontos figyelmeztetÃ©s",
    criticalNoticeText:"Csak a szÃ¼ksÃ©ges orvosi adatok.",
    iceTitle:"SÃ¼rgÅ‘ssÃ©gi kapcsolatok (ICE)", iceSub:"Maximum 5 megbÃ­zhatÃ³ szemÃ©ly.",
    addIce:"Kapcsolat hozzÃ¡adÃ¡sa", iceCountOf:"az 5-bÅ‘l", removeContact:"EltÃ¡volÃ­tÃ¡s",
    triageTitle:"Automatikus triÃ¡zs", triageSub:"Profil alapjÃ¡n.",
    triageOverrideLabel:"KÃ©zi felÃ¼lbÃ­rÃ¡lat",
    speak:"Orvosi Ã¶sszefoglalÃ³ felolvasÃ¡sa", stopSpeak:"LeÃ¡llÃ­tÃ¡s",
    qrTitle:"QR-kÃ³d generÃ¡lÃ¡sa", qrSubA:"Egyetlen QR mindenhez.",
    qrHintOffline:"Offline", qrHintStatic:"QR Ã¡llandÃ³, adatok frissÃ¼lnek",
    qrHintScan:"BÃ¡rmely kamerÃ¡val olvashatÃ³",
    copyLink:"Link mÃ¡solÃ¡sa", viewCard:"KÃ¡rtya megtekintÃ©se",
    exportPng:"PNG export", printCard:"NyomtatÃ¡s",
    analyticsTitle:"Analitika", analyticsSub:"SzkennelÃ©sek kÃ¶vetÃ©se", totalScans:"Ã–sszesen",
    last30Days:"ElmÃºlt 30 nap", today:"Ma", refreshStats:"FrissÃ­tÃ©s",
    toastSaved:"Mentve", toastError:"Hiba", toastCopied:"Link mÃ¡solva",
    needIdentity:"ElÅ‘bb tÃ¶ltsd ki az identitÃ¡st (NÃ©v, DÃ¡tum, OrszÃ¡g)",
    codeExists:"MÃ¡r van kÃ³dod", codeCreated:"KÃ³d lÃ©trehozva",
    noLink:"Nincs link mÃ¡solni", maxContacts:"Maximum 5 kontakt",
    contactAdded:"Kapcsolat hozzÃ¡adva", contactRemoved:"Kapcsolat eltÃ¡volÃ­tva",
    speechNotSupported:"A bÃ¶ngÃ©szÅ‘ nem tÃ¡mogatja a beszÃ©det",
  },
  ro: { online:"Online", logout:"Deconectare", worksOffline:"FuncÈ›ioneazÄƒ offline",
    profileCompletionTitle:"Completare profil", completeLabel:"Complet",
    identityCheck:"Identitate", healthCheck:"Profil medical", iceCheck:"Contacte ICE", codeCheck:"Cod de urgenÈ›Äƒ",
    identityTitle:"InformaÈ›ii de identitate", identitySub:"AjutÄƒ salvatorii sÄƒ te identifice È™i sÄƒ Ã®È›i contacteze apropiaÈ›ii.",
    fullName:"Nume complet", dob:"Data naÈ™terii", country:"Èšara de reÈ™edinÈ›Äƒ",
    nhsId:"ID sÄƒnÄƒtate", autoSaves:"Se salveazÄƒ automat",
    healthTitle:"Profil medical", healthSub:"Apare pe cardul tÄƒu de urgenÈ›Äƒ.",
    bloodTypeLabel:"Grupa sanguinÄƒ", bloodHelp:"EsenÈ›ial pentru transfuzii",
    donorLabel:"Donator de organe", donorHelp:"VerificÄƒ actul",
    lifeSupportLabel:"PreferinÈ›Äƒ suport vital",
    allergiesLabel:"Alergii critice âš ï¸", allergiesHelp:"Medicamente, alimentare, de mediu.",
    conditionsLabel:"Afectiuni medicale", conditionsHelp:"Cronice, mentale, curente.",
    medsLabel:"MedicaÈ›ie curentÄƒ", medsHelp:"ReÈ›etÄƒ, OTC, suplimente.",
    criticalNoticeTitle:"AtenÈ›ionare",
    criticalNoticeText:"VizibilÄƒ salvatorilor. Doar ce e necesar.",
    iceTitle:"Contacte de urgenÈ›Äƒ (ICE)", iceSub:"PÃ¢nÄƒ la 5 persoane de Ã®ncredere.",
    addIce:"AdaugÄƒ contact", iceCountOf:"din 5 adÄƒugate", removeContact:"È˜terge",
    triageTitle:"Triaj automat", triageSub:"Prioritate calculatÄƒ.",
    triageOverrideLabel:"Manual",
    speak:"RedÄƒ sumarul medical", stopSpeak:"OpreÈ™te",
    qrTitle:"GenereazÄƒ cod QR", qrSubA:"Un singur cod pentru tot.",
    qrHintOffline:"Offline", qrHintStatic:"Cod fix, date actualizate",
    qrHintScan:"Scanabil cu orice camerÄƒ",
    copyLink:"CopiazÄƒ linkul", viewCard:"Vezi cardul",
    exportPng:"Export PNG", printCard:"PrinteazÄƒ",
    analyticsTitle:"Analitice", analyticsSub:"UrmÄƒreÈ™te scanÄƒrile", totalScans:"Total",
    last30Days:"Ultimele 30 zile", today:"AstÄƒzi", refreshStats:"ReÃ®mprospÄƒteazÄƒ",
    toastSaved:"Salvat", toastError:"Eroare", toastCopied:"Link copiat",
    needIdentity:"CompleteazÄƒ identitatea (Nume, DatÄƒ, ÈšarÄƒ)",
    codeExists:"Ai deja un cod", codeCreated:"Cod generat",
    noLink:"Nu existÄƒ link", maxContacts:"Maxim 5 contacte",
    contactAdded:"Contact adÄƒugat", contactRemoved:"Contact È™ters",
    speechNotSupported:"Browserul nu suportÄƒ vorbire",
  }
};

/* ---------- I18N ENGINE ---------- */
function currentLang() {
  const sel = document.getElementById('languageSelect');
  return sel ? (sel.value || 'en') : 'en';
}
function t(key) {
  const lang = currentLang();
  return (I18N[lang] && I18N[lang][key]) || (I18N.en[key] || key);
}
function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (key) el.textContent = t(key);
  });
}
function applyRTL() {
  const rtlLangs = ['ar','he','fa','ur'];
  const lang = currentLang();
  const html = document.documentElement;
  if (rtlLangs.includes(lang)) {
    html.setAttribute('dir','rtl');
    html.setAttribute('lang', lang);
  } else {
    html.setAttribute('dir','ltr');
    html.setAttribute('lang', lang);
  }
}
function persistLang() {
  const sel = document.getElementById('languageSelect');
  if (!sel) return;
  const stored = localStorage.getItem('myqer_lang');
  if (stored && I18N[stored]) sel.value = stored;
  sel.addEventListener('change', ()=>{
    localStorage.setItem('myqer_lang', sel.value);
    applyRTL();
    applyTranslations();
  });
}

/* ---------- TOAST ---------- */
function showToast(message, type='info') {
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.className = `toast ${type}`;
  toast.textContent = message;
  requestAnimationFrame(()=> toast.classList.add('show'));
  setTimeout(()=> toast.classList.remove('show'), 2200);
}

/* ---------- SESSION ---------- */
async function checkSession() {
  const { data: { session }, error } = await sb.auth.getSession();
  if (error || !session) {
    location.replace('index.html');
    return;
  }
  currentUser = session.user;
}

/* ---------- LOAD USER DATA ---------- */
async function loadUserData() {
  // profiles
  const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (profile) {
    currentProfile = profile;
    // identity fields
    const fn = document.getElementById('fullName'); if (fn) fn.value = profile.full_name || '';
    const dob = document.getElementById('dateOfBirth'); if (dob) dob.value = profile.date_of_birth || '';
    const ctry = document.getElementById('country'); if (ctry) ctry.value = profile.country || '';
    const nhs = document.getElementById('nationalHealthId'); if (nhs) nhs.value = profile.national_health_id || '';
    // code + QR if exists
    if (profile.code) {
      updateCardLink(profile.code);
      generateQRCode(profile.code);
      // disable generate button so only one code per user
      const genBtn = document.getElementById('generateCodeBtn');
      if (genBtn) { genBtn.disabled = true; genBtn.classList.add('opacity-60','cursor-not-allowed'); }
    }
  }
  // health_profiles
  const { data: health } = await sb.from('health_profiles').select('*').eq('user_id', currentUser.id).single();
  if (health) {
    const bt = document.getElementById('bloodType'); if (bt) bt.value = health.blood_type || '';
    const od = document.getElementById('organDonor'); if (od) od.value = (health.organ_donor==null?'':String(!!health.organ_donor));
    const lsp = document.getElementById('lifeSupportPref'); if (lsp) lsp.value = health.life_support_pref || 'Full';
    if (health.allergies) pillData.allergies = health.allergies.split(',').map(s=>s.trim()).filter(Boolean);
    if (health.conditions) pillData.conditions = health.conditions.split(',').map(s=>s.trim()).filter(Boolean);
    if (health.medications) pillData.medications = health.medications.split(',').map(s=>s.trim()).filter(Boolean);
    renderPills('allergies'); renderPills('conditions'); renderPills('medications');
  }
  // ice_contacts
  const list = document.getElementById('iceContacts');
  if (list) list.innerHTML = '';
  const { data: contacts } = await sb.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at');
  iceContactCount = 0;
  if (contacts && contacts.length) {
    contacts.forEach(ct => createIceRowFromDB(ct));
  }
  updateContactCount();
  updateProfileProgress();
}

/* ---------- SAVE FUNCTIONS (debounced in UI) ---------- */
async function saveProfile() {
  if (!currentUser) return;
  const payload = {
    id: currentUser.id,
    email: currentUser.email,
    full_name: document.getElementById('fullName')?.value?.trim() || null,
    country: document.getElementById('country')?.value || null,
    date_of_birth: document.getElementById('dateOfBirth')?.value || null,
    national_health_id: document.getElementById('nationalHealthId')?.value || null
  };
  const { error } = await sb.from('profiles').upsert(payload);
  if (!error) showToast(t('toastSaved'), 'success'); else showToast(t('toastError'), 'error');
}
async function saveHealthProfile() {
  if (!currentUser) return;
  const payload = {
    user_id: currentUser.id,
    blood_type: document.getElementById('bloodType')?.value || null,
    organ_donor: (function(v){ if(v==='true') return true; if(v==='false') return false; return null; })(document.getElementById('organDonor')?.value || ''),
    life_support_pref: document.getElementById('lifeSupportPref')?.value || 'Full',
    allergies: pillData.allergies.join(', '),
    conditions: pillData.conditions.join(', '),
    medications: pillData.medications.join(', ')
  };
  const { error } = await sb.from('health_profiles').upsert(payload);
  if (!error) { showToast(t('toastSaved'), 'success'); updateTriageStatus(); }
  else showToast(t('toastError'),'error');
}
async function saveIceContacts() {
  if (!currentUser) return;
  const container = document.getElementById('iceContacts');
  const rows = [...container.querySelectorAll('.ice-contact-card')];
  const upserts = rows.map(card=>{
    const id = card.dataset.dbid || null;
    const name = card.querySelector('.contact-name')?.value?.trim() || null;
    const relation = card.querySelector('.contact-relation')?.value || null;
    const phone = card.querySelector('.contact-phone')?.value?.trim() || null;
    const email = card.querySelector('.contact-email')?.value?.trim() || null;
    const notes = card.querySelector('.contact-notes')?.value?.trim() || null;
    return { id: id?Number(id):undefined, user_id: currentUser.id, name, relationship: relation, phone, email, notes };
  });
  const { error } = await sb.from('ice_contacts').upsert(upserts).select();
  if (!error) showToast(t('toastSaved'),'success'); else showToast(t('toastError'),'error');
}

/* ---------- PILLS UI ---------- */
function renderPills(type) {
  const wrap = document.getElementById(`${type}Pills`);
  if (!wrap) return;
  wrap.innerHTML = pillData[type].map((v,i)=>`
    <div class="pill">${v}<span class="pill-remove" onclick="removePill('${type}',${i})">Ã—</span></div>
  `).join('');
}
function addPill(type, value) {
  if (!value) return;
  if (pillData[type].includes(value)) return;
  pillData[type].push(value);
  renderPills(type); updateTriageStatus(); updateProfileProgress();
  clearTimeout(saveTimeout); saveTimeout = setTimeout(saveHealthProfile, 600);
}
function removePill(type, index) {
  pillData[type].splice(index,1);
  renderPills(type); updateTriageStatus(); updateProfileProgress();
  clearTimeout(saveTimeout); saveTimeout = setTimeout(saveHealthProfile, 600);
}

/* ---------- ICE UI ---------- */
function createIceRowFromDB(ct) {
  const container = document.getElementById('iceContacts');
  if (!container) return;
  const div = document.createElement('div');
  div.className = 'ice-contact-card';
  div.dataset.dbid = ct.id;
  div.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label class="form-label">Full Name *</label><input type="text" class="form-input contact-name" value="${ct.name||''}"></div>
      <div>
        <label class="form-label">Relationship</label>
        <select class="form-select contact-relation">
          <option value=""></option>
          ${['Spouse','Partner','Parent','Child','Sibling','Friend','Colleague','Doctor','Lawyer','Other']
            .map(opt=>`<option value="${opt}" ${ct.relationship===opt?'selected':''}>${opt}</option>`).join('')}
        </select>
      </div>
      <div><label class="form-label">Phone *</label><input type="tel" class="form-input contact-phone" value="${ct.phone||''}"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div><label class="form-label">Email</label><input type="email" class="form-input contact-email" value="${ct.email||''}"></div>
      <div><label class="form-label">Notes</label><input type="text" class="form-input contact-notes" value="${ct.notes||''}"></div>
    </div>
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
      <button class="text-red-600 text-sm hover:text-red-800 font-medium" onclick="removeIceContactRow(this)">${t('removeContact')}</button>
      <div class="text-xs text-gray-500">${t('autoSaves')}</div>
    </div>`;
  container.appendChild(div);
  iceContactCount++;
  div.querySelectorAll('input,select').forEach(inp=>{
    inp.addEventListener('change', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
    inp.addEventListener('blur', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
  });
}
function addIceContact() {
  if (iceContactCount>=5) { showToast(t('maxContacts'),'warning'); return; }
  const container = document.getElementById('iceContacts');
  const div = document.createElement('div');
  div.className = 'ice-contact-card';
  div.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label class="form-label">Full Name *</label><input type="text" class="form-input contact-name" placeholder="Jane Doe"></div>
      <div>
        <label class="form-label">Relationship</label>
        <select class="form-select contact-relation">
          <option value=""></option>
          ${['Spouse','Partner','Parent','Child','Sibling','Friend','Colleague','Doctor','Lawyer','Other']
            .map(opt=>`<option value="${opt}">${opt}</option>`).join('')}
        </select>
      </div>
      <div><label class="form-label">Phone *</label><input type="tel" class="form-input contact-phone" placeholder="+1 555 000 1111"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div><label class="form-label">Email</label><input type="email" class="form-input contact-email" placeholder="contact@example.com"></div>
      <div><label class="form-label">Notes</label><input type="text" class="form-input contact-notes" placeholder=""></div>
    </div>
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
      <button class="text-red-600 text-sm hover:text-red-800 font-medium" onclick="removeIceContactRow(this)">${t('removeContact')}</button>
      <div class="text-xs text-gray-500">${t('autoSaves')}</div>
    </div>`;
  container.appendChild(div);
  iceContactCount++;
  updateContactCount(); updateProfileProgress();
  div.querySelectorAll('input,select').forEach(inp=>{
    inp.addEventListener('change', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
    inp.addEventListener('blur', ()=> { clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,400); });
  });
  showToast(t('contactAdded'), 'success');
}
function removeIceContactRow(btn) {
  const card = btn.closest('.ice-contact-card');
  const dbid = card?.dataset?.dbid;
  card?.remove();
  iceContactCount = Math.max(0, iceContactCount-1);
  updateContactCount(); updateProfileProgress();
  if (dbid) { sb.from('ice_contacts').delete().eq('id', dbid); }
  clearTimeout(saveTimeout); saveTimeout=setTimeout(saveIceContacts,300);
  showToast(t('contactRemoved'),'success');
}
function updateContactCount() {
  const el = document.getElementById('contactCount');
  if (el) el.textContent = iceContactCount;
  const addBtn = document.getElementById('addIceContact');
  if (addBtn) addBtn.disabled = (iceContactCount>=5);
}

/* ---------- PROGRESS RING ---------- */
function updateProfileProgress() {
  const checks = {
    identity: checkIdentityComplete(),
    health: checkHealthComplete(),
    contacts: iceContactCount>0,
    code: !!(currentProfile && currentProfile.code)
  };
  const completed = Object.values(checks).filter(Boolean).length;
  const pct = Math.round((completed/4)*100);
  const circ = document.getElementById('progressCircle');
  const pctEl = document.getElementById('progressPercent');
  const C = 2*Math.PI*28;
  if (circ) circ.style.strokeDasharray = `${(pct/100)*C} ${C}`;
  if (pctEl) pctEl.textContent = `${pct}%`;
  updateCheckIndicator('checkIdentity', checks.identity);
  updateCheckIndicator('checkHealth', checks.health);
  updateCheckIndicator('checkContacts', checks.contacts);
  updateCheckIndicator('checkCode', checks.code);
}
function updateCheckIndicator(id, ok) {
  const el = document.getElementById(id);
  if (!el) return;
  const dot = el.querySelector('div');
  const label = el.querySelector('span');
  if (ok) { dot.className='w-4 h-4 rounded-full bg-green-500'; label.className='text-green-700 font-medium'; }
  else { dot.className='w-4 h-4 rounded-full bg-gray-300'; label.className='text-gray-600'; }
}
function checkIdentityComplete() {
  const name = document.getElementById('fullName')?.value?.trim();
  const dob = document.getElementById('dateOfBirth')?.value;
  const country = document.getElementById('country')?.value;
  return !!(name && dob && country);
}
function checkHealthComplete() {
  const bloodType = document.getElementById('bloodType')?.value;
  return !!(bloodType || pillData.allergies.length || pillData.conditions.length);
}

/* ---------- QR (single code per user) ---------- */
function updateCardLink(code) {
  const link = `${ORIGIN}/c/${code}`;
  const input = document.getElementById('cardLink');
  if (input) input.value = link;
}
function generateQRCode(code) {
  const canvas = document.getElementById('qrCanvas');
  const placeholder = document.getElementById('qrPlaceholder');
  const url = `${ORIGIN}/c/${code}`;
  QRCode.toCanvas(canvas, url, { width:160, height:160, margin:3, errorCorrectionLevel:'M' }, (err)=>{
    if (err) { placeholder.style.display='block'; canvas.style.display='none'; }
    else { placeholder.style.display='none'; canvas.style.display='block'; }
  });
}
async function generateEmergencyCode() {
  if (!checkIdentityComplete()) { showToast(t('needIdentity'),'warning'); return; }
  // Refetch profile to be sure
  const { data: p } = await sb.from('profiles').select('id,code').eq('id', currentUser.id).single();
  if (p && p.code) { showToast(t('codeExists'),'info'); return; }
  const code = Math.random().toString(36).slice(2,8).toUpperCase();
  const { error } = await sb.from('profiles').update({ code }).eq('id', currentUser.id);
  if (!error) {
    currentProfile = { ...(currentProfile||{}), code };
    updateCardLink(code); generateQRCode(code); updateProfileProgress();
    const genBtn = document.getElementById('generateCodeBtn');
    if (genBtn) { genBtn.disabled = true; genBtn.classList.add('opacity-60','cursor-not-allowed'); }
    showToast(t('codeCreated'),'success');
  } else showToast(t('toastError'),'error');
}

/* ---------- COPY / VIEW / EXPORT / PRINT ---------- */
function copyCardLink() {
  const v = document.getElementById('cardLink')?.value;
  if (!v) { showToast(t('noLink'),'warning'); return; }
  navigator.clipboard.writeText(v).then(()=> showToast(t('toastCopied'),'success'))
    .catch(()=> showToast(t('toastError'),'error'));
}
function viewEmergencyCard() {
  if (!currentProfile?.code) { showToast(t('codeExists'),'info'); return; }
  window.open(`${ORIGIN}/c/${currentProfile.code}`,'_blank');
}
function exportQR() {
  const canvas = document.getElementById('qrCanvas');
  if (!canvas || canvas.style.display==='none') return;
  const link = document.createElement('a');
  link.download = `MYQER-${currentProfile.code}-QR.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
}
function printEmergencyCard() {
  if (!currentProfile?.code) { showToast(t('needIdentity'),'warning'); return; }
  window.open(`${ORIGIN}/c/${currentProfile.code}?print=true`,'_blank');
}

<script>
/* ========= CHUNK 7: TRIAGE + SPEECH + ANALYTICS HOOKS ========= */

/* -------- i18n strings (triage + speech + QR actions) -------- */
const i18nExtra = {
  en: {
    triage_auto: "ğŸ¤– Auto (Recommended)",
    triage_green: "GREEN - Standard (Auto)",
    triage_amber: "AMBER - Urgent (Auto)",
    triage_red: "RED - Immediate (Auto)",
    triage_black: "BLACK - Comfort (Auto)",
    triage_green_m: "ğŸŸ¢ Green - Standard Priority",
    triage_amber_m: "ğŸŸ¡ Amber - Urgent Priority",
    triage_red_m: "ğŸ”´ Red - Immediate Priority",
    triage_black_m: "âš« Black - Comfort Care",
    speak_summary: "ğŸ”Š Speak Medical Summary",
    stop_speaking: "â¹ï¸ Stop Speaking",
    speech_started: "Speaking medical summary...",
    speech_stopped: "Speech stopped",
    speech_error: "Speech synthesis failed",
  },
  es: {
    triage_auto: "ğŸ¤– Auto (Recomendado)",
    triage_green: "VERDE - EstÃ¡ndar (Auto)",
    triage_amber: "ÃMBAR - Urgente (Auto)",
    triage_red: "ROJO - Inmediata (Auto)",
    triage_black: "NEGRO - Cuidados de confort (Auto)",
    triage_green_m: "ğŸŸ¢ Verde - Prioridad estÃ¡ndar",
    triage_amber_m: "ğŸŸ¡ Ãmbar - Prioridad urgente",
    triage_red_m: "ğŸ”´ Rojo - Prioridad inmediata",
    triage_black_m: "âš« Negro - Cuidados de confort",
    speak_summary: "ğŸ”Š Leer resumen mÃ©dico",
    stop_speaking: "â›” Detener lectura",
    speech_started: "Leyendo el resumen mÃ©dico...",
    speech_stopped: "Lectura detenida",
    speech_error: "La sÃ­ntesis de voz fallÃ³",
  },
  fr: {
    triage_auto: "ğŸ¤– Auto (RecommandÃ©)",
    triage_green: "VERT - Standard (Auto)",
    triage_amber: "AMBRE - Urgent (Auto)",
    triage_red: "ROUGE - ImmÃ©diat (Auto)",
    triage_black: "NOIR - Soins de confort (Auto)",
    triage_green_m: "ğŸŸ¢ Vert - PrioritÃ© standard",
    triage_amber_m: "ğŸŸ¡ Ambre - PrioritÃ© urgente",
    triage_red_m: "ğŸ”´ Rouge - PrioritÃ© immÃ©diate",
    triage_black_m: "âš« Noir - Soins de confort",
    speak_summary: "ğŸ”Š Ã‰noncer le rÃ©sumÃ© mÃ©dical",
    stop_speaking: "â¹ï¸ ArrÃªter",
    speech_started: "Ã‰nonciation du rÃ©sumÃ© mÃ©dical...",
    speech_stopped: "Ã‰nonciation arrÃªtÃ©e",
    speech_error: "Ã‰chec de la synthÃ¨se vocale",
  },
  de: {
    triage_auto: "ğŸ¤– Auto (Empfohlen)",
    triage_green: "GRÃœN - Standard (Auto)",
    triage_amber: "GELB - Dringend (Auto)",
    triage_red: "ROT - Sofort (Auto)",
    triage_black: "SCHWARZ - Komfortpflege (Auto)",
    triage_green_m: "ğŸŸ¢ GrÃ¼n - Standard PrioritÃ¤t",
    triage_amber_m: "ğŸŸ¡ Gelb - Dringende PrioritÃ¤t",
    triage_red_m: "ğŸ”´ Rot - Sofortige PrioritÃ¤t",
    triage_black_m: "âš« Schwarz - Komfortpflege",
    speak_summary: "ğŸ”Š Medizinische Zusammenfassung vorlesen",
    stop_speaking: "â¹ï¸ Stoppen",
    speech_started: "Zusammenfassung wird gesprochen...",
    speech_stopped: "Sprachausgabe gestoppt",
    speech_error: "Sprachausgabe fehlgeschlagen",
  },
  it: {
    triage_auto: "ğŸ¤– Auto (Consigliato)",
    triage_green: "VERDE - Standard (Auto)",
    triage_amber: "AMBRA - Urgente (Auto)",
    triage_red: "ROSSO - Immediata (Auto)",
    triage_black: "NERO - Cure di conforto (Auto)",
    triage_green_m: "ğŸŸ¢ Verde - PrioritÃ  standard",
    triage_amber_m: "ğŸŸ¡ Ambra - PrioritÃ  urgente",
    triage_red_m: "ğŸ”´ Rosso - PrioritÃ  immediata",
    triage_black_m: "âš« Nero - Cure di conforto",
    speak_summary: "ğŸ”Š Leggi riepilogo medico",
    stop_speaking: "â¹ï¸ Interrompi",
    speech_started: "Lettura del riepilogo medico...",
    speech_stopped: "Lettura interrotta",
    speech_error: "Sintesi vocale non riuscita",
  },
  hi: {
    triage_auto: "ğŸ¤– à¤‘à¤Ÿà¥‹ (à¤…à¤¨à¥à¤¶à¤‚à¤¸à¤¿à¤¤)",
    triage_green: "à¤¹à¤°à¤¾ - à¤®à¤¾à¤¨à¤• (à¤‘à¤Ÿà¥‹)",
    triage_amber: "à¤…à¤®à¥à¤¬à¤° - à¤…à¤°à¥à¤œà¥‡à¤‚à¤Ÿ (à¤‘à¤Ÿà¥‹)",
    triage_red: "à¤²à¤¾à¤² - à¤¤à¤¤à¥à¤•à¤¾à¤² (à¤‘à¤Ÿà¥‹)",
    triage_black: "à¤•à¤¾à¤²à¤¾ - à¤†à¤°à¤¾à¤® à¤¦à¥‡à¤–à¤­à¤¾à¤² (à¤‘à¤Ÿà¥‹)",
    triage_green_m: "ğŸŸ¢ à¤¹à¤°à¤¾ - à¤®à¤¾à¤¨à¤• à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾",
    triage_amber_m: "ğŸŸ¡ à¤…à¤‚à¤¬à¤° - à¤…à¤°à¥à¤œà¥‡à¤‚à¤Ÿ à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾",
    triage_red_m: "ğŸ”´ à¤²à¤¾à¤² - à¤¤à¤¤à¥à¤•à¤¾à¤² à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾",
    triage_black_m: "âš« à¤•à¤¾à¤²à¤¾ - à¤†à¤°à¤¾à¤® à¤¦à¥‡à¤–à¤­à¤¾à¤²",
    speak_summary: "ğŸ”Š à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¸à¤¾à¤°à¤¾à¤‚à¤¶ à¤¬à¥‹à¤²à¥‡à¤‚",
    stop_speaking: "â¹ï¸ à¤°à¥‹à¤•à¥‡à¤‚",
    speech_started: "à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¸à¤¾à¤°à¤¾à¤‚à¤¶ à¤¬à¥‹à¤²à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    speech_stopped: "à¤µà¤¾à¤šà¤¨ à¤°à¥‹à¤•à¤¾ à¤—à¤¯à¤¾",
    speech_error: "à¤µà¤¾à¤£à¥€ à¤¸à¤‚à¤¶à¥à¤²à¥‡à¤·à¤£ à¤µà¤¿à¤«à¤²",
  },
  ar: {
    triage_auto: "ğŸ¤– ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…ÙˆØµÙ‰ Ø¨Ù‡)",
    triage_green: "Ø£Ø®Ø¶Ø± - Ø¹Ø§Ø¯ÙŠ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
    triage_amber: "ÙƒÙ‡Ø±Ù…Ø§Ù†ÙŠ - Ø¹Ø§Ø¬Ù„ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
    triage_red: "Ø£Ø­Ù…Ø± - ÙÙˆØ±ÙŠ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
    triage_black: "Ø£Ø³ÙˆØ¯ - Ø±Ø¹Ø§ÙŠØ© Ù…Ø±ÙŠØ­Ø© (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
    triage_green_m: "ğŸŸ¢ Ø£Ø®Ø¶Ø± - Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ø¯ÙŠØ©",
    triage_amber_m: "ğŸŸ¡ ÙƒÙ‡Ø±Ù…Ø§Ù†ÙŠ - Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ø¬Ù„Ø©",
    triage_red_m: "ğŸ”´ Ø£Ø­Ù…Ø± - Ø£ÙˆÙ„ÙˆÙŠØ© ÙÙˆØ±ÙŠØ©",
    triage_black_m: "âš« Ø£Ø³ÙˆØ¯ - Ø±Ø¹Ø§ÙŠØ© Ù…Ø±ÙŠØ­Ø©",
    speak_summary: "ğŸ”Š Ù†Ø·Ù‚ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ø¨ÙŠ",
    stop_speaking: "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù",
    speech_started: "ÙŠØªÙ… Ù†Ø·Ù‚ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ø¨ÙŠ...",
    speech_stopped: "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø·Ù‚",
    speech_error: "ÙØ´Ù„ ØªØ±ÙƒÙŠØ¨ Ø§Ù„ØµÙˆØª",
  },
  zh: {
    triage_auto: "ğŸ¤– è‡ªåŠ¨ï¼ˆæ¨èï¼‰",
    triage_green: "ç»¿è‰² - æ ‡å‡†ï¼ˆè‡ªåŠ¨ï¼‰",
    triage_amber: "ç¥ç€ - ç´§æ€¥ï¼ˆè‡ªåŠ¨ï¼‰",
    triage_red: "çº¢è‰² - ç«‹å³ï¼ˆè‡ªåŠ¨ï¼‰",
    triage_black: "é»‘è‰² - èˆ’ç¼“æŠ¤ç†ï¼ˆè‡ªåŠ¨ï¼‰",
    triage_green_m: "ğŸŸ¢ ç»¿è‰² - æ ‡å‡†ä¼˜å…ˆçº§",
    triage_amber_m: "ğŸŸ¡ ç¥ç€ - ç´§æ€¥ä¼˜å…ˆçº§",
    triage_red_m: "ğŸ”´ çº¢è‰² - ç«‹å³ä¼˜å…ˆçº§",
    triage_black_m: "âš« é»‘è‰² - èˆ’ç¼“æŠ¤ç†",
    speak_summary: "ğŸ”Š æœ—è¯»åŒ»ç–—æ‘˜è¦",
    stop_speaking: "â¹ï¸ åœæ­¢æœ—è¯»",
    speech_started: "æ­£åœ¨æœ—è¯»åŒ»ç–—æ‘˜è¦â€¦",
    speech_stopped: "å·²åœæ­¢æœ—è¯»",
    speech_error: "è¯­éŸ³åˆæˆå¤±è´¥",
  },
  hu: {
    triage_auto: "ğŸ¤– Automatikus (AjÃ¡nlott)",
    triage_green: "ZÃ–LD - NormÃ¡l (Auto)",
    triage_amber: "BOROSTYÃN - SÃ¼rgÅ‘s (Auto)",
    triage_red: "PIROS - Azonnali (Auto)",
    triage_black: "FEKETE - Komfort Ã¡polÃ¡s (Auto)",
    triage_green_m: "ğŸŸ¢ ZÃ¶ld - NormÃ¡l prioritÃ¡s",
    triage_amber_m: "ğŸŸ¡ BorostyÃ¡n - SÃ¼rgÅ‘s prioritÃ¡s",
    triage_red_m: "ğŸ”´ Piros - Azonnali prioritÃ¡s",
    triage_black_m: "âš« Fekete - Komfort Ã¡polÃ¡s",
    speak_summary: "ğŸ”Š Orvosi Ã¶sszefoglalÃ³ felolvasÃ¡sa",
    stop_speaking: "â¹ï¸ LeÃ¡llÃ­tÃ¡s",
    speech_started: "Orvosi Ã¶sszefoglalÃ³ felolvasÃ¡sa...",
    speech_stopped: "FelolvasÃ¡s leÃ¡llÃ­tva",
    speech_error: "A beszÃ©dszintÃ©zis nem sikerÃ¼lt",
  },
  ro: {
    triage_auto: "ğŸ¤– Auto (Recomandat)",
    triage_green: "VERDE - Standard (Auto)",
    triage_amber: "AMBRU - Urgent (Auto)",
    triage_red: "ROÈ˜U - Imediat (Auto)",
    triage_black: "NEGRU - Ãngrijire de confort (Auto)",
    triage_green_m: "ğŸŸ¢ Verde - Prioritate standard",
    triage_amber_m: "ğŸŸ¡ Ambru - Prioritate urgentÄƒ",
    triage_red_m: "ğŸ”´ RoÈ™u - Prioritate imediatÄƒ",
    triage_black_m: "âš« Negru - Ãngrijire de confort",
    speak_summary: "ğŸ”Š RedÄƒ rezumatul medical",
    stop_speaking: "â¹ï¸ OpreÈ™te",
    speech_started: "Se redÄƒ rezumatul medical...",
    speech_stopped: "Redarea a fost opritÄƒ",
    speech_error: "Sintexa vocalÄƒ a eÈ™uat",
  },
};

// merge into global translations if present
window.__I18N__ = Object.assign({}, window.__I18N__ || {}, i18nExtra);

/* -------- Triage calculation (auto + manual override) -------- */
function updateTriageStatus() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  const statusElement = document.getElementById('triageStatus');
  const overrideSel = document.getElementById('triageOverride');
  if (!statusElement || !overrideSel) return;

  const override = overrideSel.value;

  const setStatus = (kind, textKey) => {
    const classMap = {
      Green: 'triage-green',
      Amber: 'triage-amber',
      Red: 'triage-red',
      Black: 'triage-black'
    };
    statusElement.className = `triage-status ${classMap[kind]}`;
    statusElement.textContent = t[textKey];
  };

  if (override) {
    const mapText = {
      Green: 'triage_green_m',
      Amber: 'triage_amber_m',
      Red: 'triage_red_m',
      Black: 'triage_black_m'
    };
    setStatus(override, mapText[override]);
    return;
  }

  // AUTO: derive from health profile pills + life support
  const lifeSupportPref = document.getElementById('lifeSupportPref')?.value || 'Full';

  const critAllergies = [
    'penicillin','morphine','codeine','fentanyl','midazolam','propofol',
    'aspirin','ibuprofen','latex','shellfish','nuts','peanuts'
  ];

  const highRiskConditions = [
    'diabetes','heart','cardiac','stroke','seizure','epilepsy',
    'asthma','copd','kidney','liver','cancer','pregnan','anticoag'
  ];

  const hasCriticalAllergy = (window.pillData?.allergies || [])
    .some(a => critAllergies.some(k => a.toLowerCase().includes(k)));

  const hasHighRiskCondition = (window.pillData?.conditions || [])
    .some(c => highRiskConditions.some(k => c.toLowerCase().includes(k)));

  let auto = 'Green';
  if (lifeSupportPref === 'DNR') auto = 'Black';
  else if (hasCriticalAllergy || hasHighRiskCondition || (window.pillData?.conditions || []).length > 3) auto = 'Red';
  else if ((window.pillData?.allergies || []).length > 0 || (window.pillData?.medications || []).length > 2) auto = 'Amber';

  const textKey = {
    Green: 'triage_green',
    Amber: 'triage_amber',
    Red: 'triage_red',
    Black: 'triage_black'
  }[auto];

  setStatus(auto, textKey);
}

/* -------- Speech summary (localized) -------- */
let currentSpeech = null;

function speakSummary() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  if (currentSpeech) {
    try { speechSynthesis.cancel(); } catch {}
    currentSpeech = null;
  }

  const fullName = document.getElementById('fullName')?.value || '';
  const bloodType = document.getElementById('bloodType')?.value || '';
  const allergies = (window.pillData?.allergies || []).join(', ');
  const conditions = (window.pillData?.conditions || []).join(', ');
  const meds = (window.pillData?.medications || []).join(', ');
  const lifePref = document.getElementById('lifeSupportPref')?.value || 'Full';

  // Simple multilingual summary (kept concise for the speaker)
  const summaries = {
    en: `Emergency summary for ${fullName || 'Unknown patient'}. Blood type ${bloodType || 'unknown'}. Allergies: ${allergies || 'none'}. Conditions: ${conditions || 'none'}. Medications: ${meds || 'none'}. Life support preference: ${lifePref}.`,
    es: `Resumen de emergencia para ${fullName || 'Paciente desconocido'}. Grupo sanguÃ­neo ${bloodType || 'desconocido'}. Alergias: ${allergies || 'ninguna'}. Condiciones: ${conditions || 'ninguna'}. MedicaciÃ³n: ${meds || 'ninguna'}. Preferencia de soporte vital: ${lifePref}.`,
    fr: `RÃ©sumÃ© d'urgence pour ${fullName || 'patient inconnu'}. Groupe sanguin ${bloodType || 'inconnu'}. Allergies: ${allergies || 'aucune'}. Pathologies: ${conditions || 'aucune'}. MÃ©dicaments: ${meds || 'aucun'}. PrÃ©fÃ©rence d'assistance vitale: ${lifePref}.`,
    de: `Notfallzusammenfassung fÃ¼r ${fullName || 'unbekannten Patienten'}. Blutgruppe ${bloodType || 'unbekannt'}. Allergien: ${allergies || 'keine'}. Erkrankungen: ${conditions || 'keine'}. Medikamente: ${meds || 'keine'}. LebenserhaltungsprÃ¤ferenz: ${lifePref}.`,
    it: `Riepilogo d'emergenza per ${fullName || 'paziente sconosciuto'}. Gruppo sanguigno ${bloodType || 'sconosciuto'}. Allergie: ${allergies || 'nessuna'}. Patologie: ${conditions || 'nessuna'}. Farmaci: ${meds || 'nessuno'}. Preferenza supporto vitale: ${lifePref}.`,
    hi: `${fullName || 'à¤…à¤œà¥à¤à¤¾à¤¤ à¤®à¤°à¥€à¤œ'} à¤•à¥‡ à¤²à¤¿à¤ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤¾à¤°à¤¾à¤‚à¤¶à¥¤ à¤°à¤•à¥à¤¤ à¤¸à¤®à¥‚à¤¹ ${bloodType || 'à¤…à¤œà¥à¤à¤¾à¤¤'}. à¤à¤²à¤°à¥à¤œà¥€: ${allergies || 'à¤•à¥‹à¤ˆ à¤¨à¤¹à¥€à¤‚'}. à¤¸à¥à¤¥à¤¿à¤¤à¤¿à¤¯à¤¾à¤‚: ${conditions || 'à¤•à¥‹à¤ˆ à¤¨à¤¹à¥€à¤‚'}. à¤¦à¤µà¤¾à¤à¤‚: ${meds || 'à¤•à¥‹à¤ˆ à¤¨à¤¹à¥€à¤‚'}. à¤œà¥€à¤µà¤¨ à¤°à¤•à¥à¤·à¤• à¤µà¤°à¥€à¤¯à¤¤à¤¾: ${lifePref}.`,
    ar: `Ù…Ù„Ø®Øµ Ø·Ø§Ø±Ø¦ Ù„Ù€ ${fullName || 'Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}. ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù… ${bloodType || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'}. Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©: ${allergies || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}. Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${conditions || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}. Ø§Ù„Ø£Ø¯ÙˆÙŠØ©: ${meds || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}. ØªÙØ¶ÙŠÙ„ Ø¯Ø¹Ù… Ø§Ù„Ø­ÙŠØ§Ø©: ${lifePref}.`,
    zh: `${fullName || 'æœªçŸ¥æ‚£è€…'} çš„ç´§æ€¥æ‘˜è¦ã€‚è¡€å‹ ${bloodType || 'æœªçŸ¥'}ã€‚è¿‡æ•ï¼š${allergies || 'æ— '}ã€‚ç—…å²ï¼š${conditions || 'æ— '}ã€‚ç”¨è¯ï¼š${meds || 'æ— '}ã€‚ç”Ÿå‘½æ”¯æŒåå¥½ï¼š${lifePref}ã€‚`,
    hu: `SÃ¼rgÅ‘ssÃ©gi Ã¶sszefoglalÃ³ ${fullName || 'ismeretlen beteg'} szÃ¡mÃ¡ra. VÃ©rcsoport: ${bloodType || 'ismeretlen'}. AllergiÃ¡k: ${allergies || 'nincs'}. Ãllapotok: ${conditions || 'nincs'}. GyÃ³gyszerek: ${meds || 'nincs'}. Ã‰letjelek tÃ¡mogatÃ¡si preferencia: ${lifePref}.`,
    ro: `Rezumat de urgenÈ›Äƒ pentru ${fullName || 'pacient necunoscut'}. GrupÄƒ sanguinÄƒ ${bloodType || 'necunoscutÄƒ'}. Alergii: ${allergies || 'niciuna'}. AfecÈ›iuni: ${conditions || 'niciuna'}. MedicaÈ›ie: ${meds || 'niciuna'}. PreferinÈ›Äƒ suport vital: ${lifePref}.`,
  };

  const utterText = summaries[lang] || summaries['en'];

  if (!('speechSynthesis' in window)) {
    showToast(t.speech_error, 'error');
    return;
  }

  currentSpeech = new SpeechSynthesisUtterance(utterText);
  currentSpeech.lang = (lang === 'zh' ? 'zh-CN' :
                        lang === 'ar' ? 'ar-SA' :
                        lang === 'hi' ? 'hi-IN' :
                        lang === 'es' ? 'es-ES' :
                        lang === 'fr' ? 'fr-FR' :
                        lang === 'de' ? 'de-DE' :
                        lang === 'it' ? 'it-IT' :
                        lang === 'hu' ? 'hu-HU' :
                        lang === 'ro' ? 'ro-RO' : 'en-US');
  currentSpeech.rate = 0.95;

  currentSpeech.onstart = () => {
    const speakBtn = document.getElementById('speakSummaryBtn');
    const stopBtn = document.getElementById('stopSpeakingBtn');
    if (speakBtn && stopBtn) { speakBtn.style.display = 'none'; stopBtn.style.display = 'block'; }
    showToast(t.speech_started, 'info');
  };
  currentSpeech.onend = () => {
    const speakBtn = document.getElementById('speakSummaryBtn');
    const stopBtn = document.getElementById('stopSpeakingBtn');
    if (speakBtn && stopBtn) { speakBtn.style.display = 'block'; stopBtn.style.display = 'none'; }
    currentSpeech = null;
  };
  currentSpeech.onerror = () => {
    const speakBtn = document.getElementById('speakSummaryBtn');
    const stopBtn = document.getElementById('stopSpeakingBtn');
    if (speakBtn && stopBtn) { speakBtn.style.display = 'block'; stopBtn.style.display = 'none'; }
    currentSpeech = null;
    showToast(t.speech_error, 'error');
  };

  speechSynthesis.speak(currentSpeech);
}

function stopSpeaking() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  if (currentSpeech) {
    try { speechSynthesis.cancel(); } catch {}
    currentSpeech = null;
  }
  const speakBtn = document.getElementById('speakSummaryBtn');
  const stopBtn = document.getElementById('stopSpeakingBtn');
  if (speakBtn && stopBtn) { speakBtn.style.display = 'block'; stopBtn.style.display = 'none'; }
  showToast(t.speech_stopped, 'info');
}

/* -------- Analytics hooks (scan logging trigger) --------
   NOTE: the real increment of scans happens on the public card view (/c/:code).
   This hook ensures your dashboard UI can request current counts when needed.
*/
async function fetchScanStats() {
  if (!window.sb || !window.currentUser) return { total_scans: 0, last_scan_at: null };
  const { data, error } = await window.sb
    .from('scan_stats')
    .select('total_scans,last_scan_at')
    .eq('user_id', window.currentUser.id)
    .single();
  if (error) {
    console.warn('Scan stats error:', error);
    return { total_scans: 0, last_scan_at: null };
  }
  return data || { total_scans: 0, last_scan_at: null };
}

// optional: call to refresh analytics card if present
async function refreshAnalyticsCard() {
  const elCount = document.getElementById('scanCount');
  const elLast = document.getElementById('lastScanAt');
  if (!elCount && !elLast) return;
  const stats = await fetchScanStats();
  if (elCount) elCount.textContent = String(stats.total_scans || 0);
  if (elLast) elLast.textContent = stats.last_scan_at ? new Date(stats.last_scan_at).toLocaleString() : 'â€”';
}

/* -------- Wire language changes to these controls -------- */
function applyTriageI18n() {
  const lang = (document.getElementById('languageSelect')?.value || 'en').toLowerCase();
  const t = (window.__I18N__ && window.__I18N__[lang]) || window.__I18N__['en'];

  // Update manual override select labels if they exist
  const triageOverride = document.getElementById('triageOverride');
  if (triageOverride) {
    const map = {
      '': t.triage_auto,
      'Green': t.triage_green_m,
      'Amber': t.triage_amber_m,
      'Red': t.triage_red_m,
      'Black': t.triage_black_m
    };
    [...triageOverride.options].forEach(opt => {
      opt.textContent = map[opt.value] ?? opt.textContent;
    });
  }

  // Buttons
  const speakBtn = document.getElementById('speakSummaryBtn');
  const stopBtn = document.getElementById('stopSpeakingBtn');
  if (speakBtn) speakBtn.innerText = t.speak_summary;
  if (stopBtn) stopBtn.innerText = t.stop_speaking;

  // Recompute status text with new language
  updateTriageStatus();
}

/* -------- Init hooks (call these from your main init) -------- */
document.addEventListener('DOMContentLoaded', () => {
  // If your main init already sets listeners, these are idempotent:
  const triageSel = document.getElementById('triageOverride');
  if (triageSel) triageSel.addEventListener('change', updateTriageStatus);

  const speakBtn = document.getElementById('speakSummaryBtn');
  const stopBtn = document.getElementById('stopSpeakingBtn');
  if (speakBtn) speakBtn.addEventListener('click', speakSummary);
  if (stopBtn) stopBtn.addEventListener('click', stopSpeaking);

  const langSel = document.getElementById('languageSelect');
  if (langSel) langSel.addEventListener('change', applyTriageI18n);

  // First paint
  applyTriageI18n();
  refreshAnalyticsCard();
});
</script>
  <script>
/* =========================
   MYQERâ„¢ DASHBOARD â€“ MASTER SCRIPT (Chunk 8)
   Wires up: session + logout, autosave (Identity/Health), ICE CRUD,
   single QR per user, i18n (10 languages), delete account, toasts, progress
   ========================= */

/* ---------- Guards & Globals ---------- */
(() => {
  // Require a Supabase client created earlier:
  if (!window.supabase || !window.sb) {
    console.error('Supabase client not found. Make sure window.sb = supabase.createClient(...) is defined in the head.');
    return;
  }

  const sb = window.sb;
  const ORIGIN = window.location.origin;

  // Global, single state container to avoid re-definitions across chunks
  const MYQER = (window.MYQER = window.MYQER || {});

  // UI refs helper
  const $ = (id) => document.getElementById(id);

  // Debounce helper
  const debounce = (fn, wait = 500) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  };

  /* ---------- Toasts ---------- */
  const toastEl = $('toast');
  function showToast(msg, type = 'info', ttl = 2200) {
    if (!toastEl) return;
    toastEl.className = `toast ${type}`;
    toastEl.textContent = msg;
    // force reflow to restart animation
    // eslint-disable-next-line no-unused-expressions
    toastEl.offsetHeight;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), ttl);
  }

  /* ---------- i18n (10 languages) ---------- */
  const LANG_KEY = 'myqer_lang';
  const languageSelect = $('languageSelect');

  // Only keys that are set programmatically (buttons, dynamic labels, placeholders, toasts)
  const i18n = {
    en: {
      logout: 'Logout',
      confirm_logout: 'Are you sure you want to logout?',
      saved: 'Saved',
      save_failed: 'Save failed',
      add_contact: 'Add Emergency Contact',
      remove_contact: 'Remove Contact',
      max_contacts: 'Maximum 5 contacts allowed',
      contact_added: 'Contact added',
      contact_removed: 'Contact removed',
      generate_code: 'Generate Emergency Code',
      code_exists: 'Your emergency code already exists',
      code_created: 'Emergency code generated',
      gen_needs_identity: 'Please complete your identity information first (Name, Date of Birth, Country)',
      copy_link: 'Copy Shareable Link',
      link_copied: 'Link copied to clipboard!',
      link_missing: 'No link to copy - generate your emergency code first',
      view_card: 'View Emergency Card',
      must_generate_first: 'Generate your emergency code first',
      export_png: 'Export PNG',
      exported_png: 'QR code exported as PNG',
      print_card: 'Print Card',
      speak_summary: 'ğŸ”Š Speak Medical Summary',
      stop_speaking: 'â¹ï¸ Stop Speaking',
      speech_started: 'Speaking medical summary...',
      speech_stopped: 'Speech stopped',
      speech_error: 'Speech synthesis failed',
      speech_unsupported: 'Speech synthesis not supported in this browser',
      delete_account: 'Delete Account',
      delete_confirm: 'This will permanently delete your account and all related data. This cannot be undone. Continue?',
      delete_done: 'Account deleted',
      delete_failed: 'Delete failed',
      offline_badge: 'WORKS OFFLINE',
      qr_complete_profile: 'Complete your profile to generate QR code',
      // Form placeholders
      ph_full_name: 'Enter your full legal name',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: 'NHS Number, SSN, etc.',
      ph_allergy: 'Type allergy and press Enter',
      ph_condition: 'Type condition and press Enter',
      ph_medication: 'Type medication and press Enter',
      ph_contact_name: 'Enter full name',
      ph_contact_phone: '+1 (555) 123-4567',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: 'Additional information'
    },

    es: {
      logout: 'Cerrar sesiÃ³n',
      confirm_logout: 'Â¿Seguro que quieres cerrar sesiÃ³n?',
      saved: 'Guardado',
      save_failed: 'Error al guardar',
      add_contact: 'AÃ±adir contacto ICE',
      remove_contact: 'Eliminar contacto',
      max_contacts: 'MÃ¡ximo 5 contactos',
      contact_added: 'Contacto aÃ±adido',
      contact_removed: 'Contacto eliminado',
      generate_code: 'Generar cÃ³digo de emergencia',
      code_exists: 'Tu cÃ³digo de emergencia ya existe',
      code_created: 'CÃ³digo de emergencia generado',
      gen_needs_identity: 'Completa tu informaciÃ³n de identidad primero (Nombre, Fecha de nacimiento, PaÃ­s)',
      copy_link: 'Copiar enlace compartible',
      link_copied: 'Â¡Enlace copiado!',
      link_missing: 'No hay enlace: genera tu cÃ³digo primero',
      view_card: 'Ver tarjeta de emergencia',
      must_generate_first: 'Genera tu cÃ³digo de emergencia primero',
      export_png: 'Exportar PNG',
      exported_png: 'CÃ³digo QR exportado como PNG',
      print_card: 'Imprimir tarjeta',
      speak_summary: 'ğŸ”Š Reproducir resumen mÃ©dico',
      stop_speaking: 'â¹ï¸ Detener',
      speech_started: 'Reproduciendo resumen mÃ©dico...',
      speech_stopped: 'ReproducciÃ³n detenida',
      speech_error: 'Error de sÃ­ntesis de voz',
      speech_unsupported: 'SÃ­ntesis de voz no soportada',
      delete_account: 'Eliminar cuenta',
      delete_confirm: 'Esto eliminarÃ¡ tu cuenta y datos para siempre. Â¿Continuar?',
      delete_done: 'Cuenta eliminada',
      delete_failed: 'Error al eliminar',
      offline_badge: 'FUNCIONA SIN INTERNET',
      qr_complete_profile: 'Completa tu perfil para generar el cÃ³digo QR',
      ph_full_name: 'Ingresa tu nombre legal completo',
      ph_dob: 'DD/MM/AAAA',
      ph_health_id: 'NÂº de salud, SSN, etc.',
      ph_allergy: 'Escribe alergia y presiona Enter',
      ph_condition: 'Escribe condiciÃ³n y presiona Enter',
      ph_medication: 'Escribe medicaciÃ³n y presiona Enter',
      ph_contact_name: 'Nombre completo',
      ph_contact_phone: '+34 600 000 000',
      ph_contact_email: 'contacto@ejemplo.com',
      ph_contact_notes: 'InformaciÃ³n adicional'
    },

    fr: {
      logout: 'DÃ©connexion',
      confirm_logout: 'Voulez-vous vraiment vous dÃ©connecter ?',
      saved: 'EnregistrÃ©',
      save_failed: 'Ã‰chec de lâ€™enregistrement',
      add_contact: 'Ajouter un contact ICE',
      remove_contact: 'Supprimer le contact',
      max_contacts: 'Maximum 5 contacts',
      contact_added: 'Contact ajoutÃ©',
      contact_removed: 'Contact supprimÃ©',
      generate_code: 'GÃ©nÃ©rer le code dâ€™urgence',
      code_exists: 'Votre code dâ€™urgence existe dÃ©jÃ ',
      code_created: 'Code dâ€™urgence gÃ©nÃ©rÃ©',
      gen_needs_identity: 'Veuillez complÃ©ter votre identitÃ© (Nom, Date de naissance, Pays)',
      copy_link: 'Copier le lien partageable',
      link_copied: 'Lien copiÃ© !',
      link_missing: 'Aucun lien â€“ gÃ©nÃ©rez dâ€™abord votre code',
      view_card: 'Voir la carte dâ€™urgence',
      must_generate_first: 'GÃ©nÃ©rez dâ€™abord votre code dâ€™urgence',
      export_png: 'Exporter PNG',
      exported_png: 'QR exportÃ© en PNG',
      print_card: 'Imprimer la carte',
      speak_summary: 'ğŸ”Š Lire le rÃ©sumÃ© mÃ©dical',
      stop_speaking: 'â¹ï¸ ArrÃªter',
      speech_started: 'Lecture du rÃ©sumÃ© mÃ©dicalâ€¦',
      speech_stopped: 'Lecture arrÃªtÃ©e',
      speech_error: 'Ã‰chec de synthÃ¨se vocale',
      speech_unsupported: 'SynthÃ¨se vocale non prise en charge',
      delete_account: 'Supprimer le compte',
      delete_confirm: 'Suppression dÃ©finitive du compte et des donnÃ©es. Continuer ?',
      delete_done: 'Compte supprimÃ©',
      delete_failed: 'Ã‰chec de la suppression',
      offline_badge: 'FONCTIONNE HORS-LIGNE',
      qr_complete_profile: 'ComplÃ©tez votre profil pour gÃ©nÃ©rer le QR',
      ph_full_name: 'Entrez votre nom lÃ©gal complet',
      ph_dob: 'JJ/MM/AAAA',
      ph_health_id: 'NÂ° santÃ©, SSN, etc.',
      ph_allergy: 'Tapez allergie et EntrÃ©e',
      ph_condition: 'Tapez condition et EntrÃ©e',
      ph_medication: 'Tapez mÃ©dicament et EntrÃ©e',
      ph_contact_name: 'Nom complet',
      ph_contact_phone: '+33 6 00 00 00 00',
      ph_contact_email: 'contact@exemple.com',
      ph_contact_notes: 'Informations supplÃ©mentaires'
    },

    de: {
      logout: 'Abmelden',
      confirm_logout: 'MÃ¶chtest du dich wirklich abmelden?',
      saved: 'Gespeichert',
      save_failed: 'Speichern fehlgeschlagen',
      add_contact: 'ICE-Kontakt hinzufÃ¼gen',
      remove_contact: 'Kontakt entfernen',
      max_contacts: 'Maximal 5 Kontakte',
      contact_added: 'Kontakt hinzugefÃ¼gt',
      contact_removed: 'Kontakt entfernt',
      generate_code: 'Notfallcode erzeugen',
      code_exists: 'Dein Notfallcode existiert bereits',
      code_created: 'Notfallcode erstellt',
      gen_needs_identity: 'Bitte IdentitÃ¤t ausfÃ¼llen (Name, Geburtsdatum, Land)',
      copy_link: 'Link kopieren',
      link_copied: 'Link kopiert!',
      link_missing: 'Kein Link â€“ erst Code erzeugen',
      view_card: 'Notfallkarte ansehen',
      must_generate_first: 'Erzeuge zuerst deinen Code',
      export_png: 'PNG exportieren',
      exported_png: 'QR-Code als PNG exportiert',
      print_card: 'Karte drucken',
      speak_summary: 'ğŸ”Š Medizinische Zusammenfassung sprechen',
      stop_speaking: 'â¹ï¸ Stoppen',
      speech_started: 'Zusammenfassung wird gesprochenâ€¦',
      speech_stopped: 'Ausgabe gestoppt',
      speech_error: 'Sprachausgabe fehlgeschlagen',
      speech_unsupported: 'Sprachausgabe nicht unterstÃ¼tzt',
      delete_account: 'Konto lÃ¶schen',
      delete_confirm: 'Konto und Daten dauerhaft lÃ¶schen. Fortfahren?',
      delete_done: 'Konto gelÃ¶scht',
      delete_failed: 'LÃ¶schen fehlgeschlagen',
      offline_badge: 'OFFLINE FUNKTIONSFÃ„HIG',
      qr_complete_profile: 'Profil vervollstÃ¤ndigen, um QR zu erzeugen',
      ph_full_name: 'VollstÃ¤ndigen Namen eingeben',
      ph_dob: 'TT/MM/JJJJ',
      ph_health_id: 'Kranken-Nr., SSN, etc.',
      ph_allergy: 'Allergie eingeben und Enter',
      ph_condition: 'Krankheit eingeben und Enter',
      ph_medication: 'Medikament eingeben und Enter',
      ph_contact_name: 'VollstÃ¤ndiger Name',
      ph_contact_phone: '+49 160 000000',
      ph_contact_email: 'kontakt@beispiel.de',
      ph_contact_notes: 'ZusÃ¤tzliche Informationen'
    },

    it: {
      logout: 'Esci',
      confirm_logout: 'Vuoi davvero uscire?',
      saved: 'Salvato',
      save_failed: 'Salvataggio non riuscito',
      add_contact: 'Aggiungi contatto ICE',
      remove_contact: 'Rimuovi contatto',
      max_contacts: 'Massimo 5 contatti',
      contact_added: 'Contatto aggiunto',
      contact_removed: 'Contatto rimosso',
      generate_code: 'Genera codice di emergenza',
      code_exists: 'Il tuo codice esiste giÃ ',
      code_created: 'Codice generato',
      gen_needs_identity: 'Completa identitÃ  (Nome, Data di nascita, Paese)',
      copy_link: 'Copia link condivisibile',
      link_copied: 'Link copiato!',
      link_missing: 'Nessun link â€“ genera prima il codice',
      view_card: 'Vedi tessera di emergenza',
      must_generate_first: 'Genera prima il codice',
      export_png: 'Esporta PNG',
      exported_png: 'QR esportato come PNG',
      print_card: 'Stampa tessera',
      speak_summary: 'ğŸ”Š Leggi riepilogo medico',
      stop_speaking: 'â¹ï¸ Stop',
      speech_started: 'Lettura in corsoâ€¦',
      speech_stopped: 'Lettura interrotta',
      speech_error: 'Sintesi vocale fallita',
      speech_unsupported: 'Sintesi non supportata',
      delete_account: 'Elimina account',
      delete_confirm: 'Eliminazione definitiva. Continuare?',
      delete_done: 'Account eliminato',
      delete_failed: 'Eliminazione fallita',
      offline_badge: 'FUNZIONA OFFLINE',
      qr_complete_profile: 'Completa il profilo per generare il QR',
      ph_full_name: 'Inserisci nome legale completo',
      ph_dob: 'GG/MM/AAAA',
      ph_health_id: 'ID sanitario, SSN, ecc.',
      ph_allergy: 'Digita allergia e Invio',
      ph_condition: 'Digita condizione e Invio',
      ph_medication: 'Digita farmaco e Invio',
      ph_contact_name: 'Nome completo',
      ph_contact_phone: '+39 333 0000000',
      ph_contact_email: 'contatto@esempio.it',
      ph_contact_notes: 'Informazioni aggiuntive'
    },

    hi: {
      logout: 'à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ',
      confirm_logout: 'à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤µà¤¾à¤•à¤ˆ à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ à¤•à¤°à¤¨à¤¾ à¤šà¤¾à¤¹à¤¤à¥‡ à¤¹à¥ˆà¤‚?',
      saved: 'à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾',
      save_failed: 'à¤¸à¤¹à¥‡à¤œà¤¨à¤¾ à¤…à¤¸à¤«à¤²',
      add_contact: 'ICE à¤¸à¤‚à¤ªà¤°à¥à¤• à¤œà¥‹à¤¡à¤¼à¥‡à¤‚',
      remove_contact: 'à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¹à¤Ÿà¤¾à¤à¤',
      max_contacts: 'à¤…à¤§à¤¿à¤•à¤¤à¤® 5 à¤¸à¤‚à¤ªà¤°à¥à¤•',
      contact_added: 'à¤¸à¤‚à¤ªà¤°à¥à¤• à¤œà¥‹à¤¡à¤¼à¤¾ à¤—à¤¯à¤¾',
      contact_removed: 'à¤¸à¤‚à¤ªà¤°à¥à¤• à¤¹à¤Ÿà¤¾à¤¯à¤¾ à¤—à¤¯à¤¾',
      generate_code: 'à¤‡à¤®à¤°à¤œà¥‡à¤‚à¤¸à¥€ à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤à¤‚',
      code_exists: 'à¤†à¤ªà¤•à¤¾ à¤‡à¤®à¤°à¤œà¥‡à¤‚à¤¸à¥€ à¤•à¥‹à¤¡ à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤®à¥Œà¤œà¥‚à¤¦ à¤¹à¥ˆ',
      code_created: 'à¤‡à¤®à¤°à¤œà¥‡à¤‚à¤¸à¥€ à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤¯à¤¾ à¤—à¤¯à¤¾',
      gen_needs_identity: 'à¤ªà¤¹à¤²à¥‡ à¤ªà¤¹à¤šà¤¾à¤¨ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤­à¤°à¥‡à¤‚ (à¤¨à¤¾à¤®, à¤œà¤¨à¥à¤®à¤¤à¤¿à¤¥à¤¿, à¤¦à¥‡à¤¶)',
      copy_link: 'à¤¶à¥‡à¤¯à¤°à¥‡à¤¬à¤² à¤²à¤¿à¤‚à¤• à¤•à¥‰à¤ªà¥€ à¤•à¤°à¥‡à¤‚',
      link_copied: 'à¤²à¤¿à¤‚à¤• à¤•à¥‰à¤ªà¥€ à¤¹à¥à¤†!',
      link_missing: 'à¤•à¥‹à¤ˆ à¤²à¤¿à¤‚à¤• à¤¨à¤¹à¥€à¤‚ â€” à¤ªà¤¹à¤²à¥‡ à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤à¤‚',
      view_card: 'à¤‡à¤®à¤°à¤œà¥‡à¤‚à¤¸à¥€ à¤•à¤¾à¤°à¥à¤¡ à¤¦à¥‡à¤–à¥‡à¤‚',
      must_generate_first: 'à¤ªà¤¹à¤²à¥‡ à¤…à¤ªà¤¨à¤¾ à¤•à¥‹à¤¡ à¤¬à¤¨à¤¾à¤à¤‚',
      export_png: 'PNG à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ à¤•à¤°à¥‡à¤‚',
      exported_png: 'QR PNG à¤•à¥‡ à¤°à¥‚à¤ª à¤®à¥‡à¤‚ à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ à¤¹à¥à¤†',
      print_card: 'à¤•à¤¾à¤°à¥à¤¡ à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤•à¤°à¥‡à¤‚',
      speak_summary: 'ğŸ”Š à¤®à¥‡à¤¡à¤¿à¤•à¤² à¤¸à¤¾à¤°à¤¾à¤‚à¤¶ à¤¸à¥à¤¨à¤¾à¤à¤',
      stop_speaking: 'â¹ï¸ à¤°à¥‹à¤•à¥‡à¤‚',
      speech_started: 'à¤®à¥‡à¤¡à¤¿à¤•à¤² à¤¸à¤¾à¤°à¤¾à¤‚à¤¶ à¤šà¤²à¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆâ€¦',
      speech_stopped: 'à¤°à¥‹à¤• à¤¦à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾',
      speech_error: 'à¤µà¥‰à¤‡à¤¸ à¤¸à¤¿à¤‚à¤¥à¥‡à¤¸à¤¿à¤¸ à¤µà¤¿à¤«à¤²',
      speech_unsupported: 'à¤¬à¥à¤°à¤¾à¤‰à¤œà¤¼à¤° à¤µà¥‰à¤‡à¤¸ à¤¸à¤ªà¥‹à¤°à¥à¤Ÿ à¤¨à¤¹à¥€à¤‚ à¤•à¤°à¤¤à¤¾',
      delete_account: 'à¤–à¤¾à¤¤à¤¾ à¤¹à¤Ÿà¤¾à¤à¤',
      delete_confirm: 'à¤–à¤¾à¤¤à¤¾ à¤”à¤° à¤¸à¤­à¥€ à¤¡à¥‡à¤Ÿà¤¾ à¤¸à¥à¤¥à¤¾à¤¯à¥€ à¤°à¥‚à¤ª à¤¸à¥‡ à¤¹à¤Ÿ à¤œà¤¾à¤à¤—à¤¾à¥¤ à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚?',
      delete_done: 'à¤–à¤¾à¤¤à¤¾ à¤¹à¤Ÿà¤¾à¤¯à¤¾ à¤—à¤¯à¤¾',
      delete_failed: 'à¤¹à¤Ÿà¤¾à¤¨à¤¾ à¤µà¤¿à¤«à¤²',
      offline_badge: 'à¤‘à¤«à¤¼à¤²à¤¾à¤‡à¤¨ à¤•à¤¾à¤® à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆ',
      qr_complete_profile: 'QR à¤¬à¤¨à¤¾à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤² à¤ªà¥‚à¤°à¥€ à¤•à¤°à¥‡à¤‚',
      ph_full_name: 'à¤…à¤ªà¤¨à¤¾ à¤ªà¥‚à¤°à¤¾ à¤•à¤¾à¤¨à¥‚à¤¨à¥€ à¤¨à¤¾à¤® à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: 'à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤†à¤ˆà¤¡à¥€, SSN, à¤†à¤¦à¤¿',
      ph_allergy: 'à¤à¤²à¤°à¥à¤œà¥€ à¤²à¤¿à¤–à¥‡à¤‚ à¤”à¤° à¤à¤‚à¤Ÿà¤° à¤¦à¤¬à¤¾à¤à¤',
      ph_condition: 'à¤¬à¥€à¤®à¤¾à¤°à¥€ à¤²à¤¿à¤–à¥‡à¤‚ à¤”à¤° à¤à¤‚à¤Ÿà¤° à¤¦à¤¬à¤¾à¤à¤',
      ph_medication: 'à¤¦à¤µà¤¾ à¤²à¤¿à¤–à¥‡à¤‚ à¤”à¤° à¤à¤‚à¤Ÿà¤° à¤¦à¤¬à¤¾à¤à¤',
      ph_contact_name: 'à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®',
      ph_contact_phone: '+91 90000 00000',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: 'à¤…à¤¤à¤¿à¤°à¤¿à¤•à¥à¤¤ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€'
    },

    ar: {
      logout: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
      confirm_logout: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
      saved: 'ØªÙ… Ø§Ù„Ø­ÙØ¸',
      save_failed: 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸',
      add_contact: 'Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ø·ÙˆØ§Ø±Ø¦',
      remove_contact: 'Ø­Ø°Ù Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
      max_contacts: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„',
      contact_added: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
      contact_removed: 'ØªÙ… Ø­Ø°Ù Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
      generate_code: 'Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
      code_exists: 'Ø±Ù…Ø² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„',
      code_created: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
      gen_needs_identity: 'Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆÙ„Ù‹Ø§ (Ø§Ù„Ø§Ø³Ù…ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ØŒ Ø§Ù„Ø¯ÙˆÙ„Ø©)',
      copy_link: 'Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©',
      link_copied: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!',
      link_missing: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· â€” Ø£Ù†Ø´Ø¦ Ø§Ù„Ø±Ù…Ø² Ø£ÙˆÙ„Ù‹Ø§',
      view_card: 'Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
      must_generate_first: 'Ø£Ù†Ø´Ø¦ Ø±Ù…Ø²Ùƒ Ø£ÙˆÙ„Ù‹Ø§',
      export_png: 'ØªØµØ¯ÙŠØ± PNG',
      exported_png: 'ØªÙ… ØªØµØ¯ÙŠØ± QR Ø¨ØµÙŠØºØ© PNG',
      print_card: 'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
      speak_summary: 'ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ø¨ÙŠ',
      stop_speaking: 'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù',
      speech_started: 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ø®Øµâ€¦',
      speech_stopped: 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù',
      speech_error: 'ÙØ´Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…',
      speech_unsupported: 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ÙŠØ²Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',
      delete_account: 'Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨',
      delete_confirm: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
      delete_done: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨',
      delete_failed: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù',
      offline_badge: 'ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª',
      qr_complete_profile: 'Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ QR',
      ph_full_name: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: 'Ø±Ù‚Ù… ØµØ­ÙŠØŒ SSNØŒ Ø¥Ù„Ø®',
      ph_allergy: 'Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ø¶ØºØ· Enter',
      ph_condition: 'Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ø¶ØºØ· Enter',
      ph_medication: 'Ø§ÙƒØªØ¨ Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ§Ø¶ØºØ· Enter',
      ph_contact_name: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„',
      ph_contact_phone: '+966 500000000',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©'
    },

    zh: {
      logout: 'ç™»å‡º',
      confirm_logout: 'ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ',
      saved: 'å·²ä¿å­˜',
      save_failed: 'ä¿å­˜å¤±è´¥',
      add_contact: 'æ·»åŠ ç´§æ€¥è”ç³»äºº',
      remove_contact: 'åˆ é™¤è”ç³»äºº',
      max_contacts: 'æœ€å¤š 5 ä¸ªè”ç³»äºº',
      contact_added: 'å·²æ·»åŠ è”ç³»äºº',
      contact_removed: 'å·²åˆ é™¤è”ç³»äºº',
      generate_code: 'ç”Ÿæˆç´§æ€¥ä»£ç ',
      code_exists: 'ä½ çš„ç´§æ€¥ä»£ç å·²å­˜åœ¨',
      code_created: 'å·²ç”Ÿæˆç´§æ€¥ä»£ç ',
      gen_needs_identity: 'è¯·å…ˆå®Œæˆèº«ä»½ä¿¡æ¯ï¼ˆå§“åã€ç”Ÿæ—¥ã€å›½å®¶ï¼‰',
      copy_link: 'å¤åˆ¶åˆ†äº«é“¾æ¥',
      link_copied: 'å·²å¤åˆ¶é“¾æ¥ï¼',
      link_missing: 'æ²¡æœ‰é“¾æ¥â€”â€”å…ˆç”Ÿæˆä»£ç ',
      view_card: 'æŸ¥çœ‹æ€¥æ•‘å¡',
      must_generate_first: 'è¯·å…ˆç”Ÿæˆç´§æ€¥ä»£ç ',
      export_png: 'å¯¼å‡º PNG',
      exported_png: 'å·²å¯¼å‡º PNG',
      print_card: 'æ‰“å°æ€¥æ•‘å¡',
      speak_summary: 'ğŸ”Š æ’­æ”¾åŒ»ç–—æ‘˜è¦',
      stop_speaking: 'â¹ï¸ åœæ­¢',
      speech_started: 'æ­£åœ¨æ’­æ”¾åŒ»ç–—æ‘˜è¦â€¦',
      speech_stopped: 'å·²åœæ­¢',
      speech_error: 'è¯­éŸ³åˆæˆå¤±è´¥',
      speech_unsupported: 'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ',
      delete_account: 'åˆ é™¤è´¦æˆ·',
      delete_confirm: 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è´¦æˆ·åŠæ•°æ®ã€‚ç»§ç»­ï¼Ÿ',
      delete_done: 'è´¦æˆ·å·²åˆ é™¤',
      delete_failed: 'åˆ é™¤å¤±è´¥',
      offline_badge: 'ç¦»çº¿å¯ç”¨',
      qr_complete_profile: 'å®Œæˆèµ„æ–™ä»¥ç”ŸæˆäºŒç»´ç ',
      ph_full_name: 'è¾“å…¥æ³•å®šå…¨å',
      ph_dob: 'DD/MM/YYYY',
      ph_health_id: 'åŒ»ä¿å·ã€SSN ç­‰',
      ph_allergy: 'è¾“å…¥è¿‡æ•å¹¶å›è½¦',
      ph_condition: 'è¾“å…¥ç—…ç—‡å¹¶å›è½¦',
      ph_medication: 'è¾“å…¥è¯ç‰©å¹¶å›è½¦',
      ph_contact_name: 'è”ç³»äººå§“å',
      ph_contact_phone: '+86 130 0000 0000',
      ph_contact_email: 'contact@example.com',
      ph_contact_notes: 'è¡¥å……ä¿¡æ¯'
    },

    hu: {
      logout: 'KijelentkezÃ©s',
      confirm_logout: 'Biztosan kijelentkezik?',
      saved: 'Mentve',
      save_failed: 'Sikertelen mentÃ©s',
      add_contact: 'ICE kapcsolat hozzÃ¡adÃ¡sa',
      remove_contact: 'Kapcsolat tÃ¶rlÃ©se',
      max_contacts: 'Legfeljebb 5 kapcsolat',
      contact_added: 'Kapcsolat hozzÃ¡adva',
      contact_removed: 'Kapcsolat tÃ¶rÃ¶lve',
      generate_code: 'VÃ©szhelyzeti kÃ³d lÃ©trehozÃ¡sa',
      code_exists: 'MÃ¡r van vÃ©szhelyzeti kÃ³dod',
      code_created: 'KÃ³d lÃ©trehozva',
      gen_needs_identity: 'ElÅ‘bb tÃ¶ltsd ki az azonosÃ­tÃ¡st (NÃ©v, SzÃ¼letÃ©si dÃ¡tum, OrszÃ¡g)',
      copy_link: 'MegoszthatÃ³ hivatkozÃ¡s mÃ¡solÃ¡sa',
      link_copied: 'HivatkozÃ¡s mÃ¡solva!',
      link_missing: 'Nincs hivatkozÃ¡s â€“ elÅ‘bb generÃ¡lj kÃ³dot',
      view_card: 'VÃ©szhelyzeti kÃ¡rtya megnyitÃ¡sa',
      must_generate_first: 'ElÅ‘bb generÃ¡ld a kÃ³dot',
      export_png: 'PNG exportÃ¡lÃ¡sa',
      exported_png: 'QR PNG-kÃ©nt exportÃ¡lva',
      print_card: 'KÃ¡rtya nyomtatÃ¡sa',
      speak_summary: 'ğŸ”Š Orvosi Ã¶sszegzÃ©s felolvasÃ¡sa',
      stop_speaking: 'â¹ï¸ LeÃ¡llÃ­tÃ¡s',
      speech_started: 'Ã–sszegzÃ©s felolvasÃ¡saâ€¦',
      speech_stopped: 'LeÃ¡llÃ­tva',
      speech_error: 'BeszÃ©dszintÃ©zis hiba',
      speech_unsupported: 'A bÃ¶ngÃ©szÅ‘ nem tÃ¡mogatja',
      delete_account: 'FiÃ³k tÃ¶rlÃ©se',
      delete_confirm: 'A fiÃ³k Ã©s adatok vÃ©gleg tÃ¶rlÅ‘dnek. Folytatja?',
      delete_done: 'FiÃ³k tÃ¶rÃ¶lve',
      delete_failed: 'TÃ¶rlÃ©s sikertelen',
      offline_badge: 'OFFLINE IS MÅ°KÃ–DIK',
      qr_complete_profile: 'TÃ¶ltsd ki a profilt a QR-hez',
      ph_full_name: 'Ãrd be a teljes nevet',
      ph_dob: 'NN/HH/Ã‰Ã‰Ã‰Ã‰',
      ph_health_id: 'EgÃ©szsÃ©gÃ¼gyi azonosÃ­tÃ³, SSN stb.',
      ph_allergy: 'Ãrj be allergiÃ¡t Ã©s Enter',
      ph_condition: 'Ãrj be betegsÃ©get Ã©s Enter',
      ph_medication: 'Ãrj be gyÃ³gyszert Ã©s Enter',
      ph_contact_name: 'Teljes nÃ©v',
      ph_contact_phone: '+36 30 000 0000',
      ph_contact_email: 'kapcsolat@pelda.hu',
      ph_contact_notes: 'KiegÃ©szÃ­tÅ‘ informÃ¡ciÃ³'
    },

    ro: {
      logout: 'Deconectare',
      confirm_logout: 'Sigur vrei sÄƒ te deconectezi?',
      saved: 'Salvat',
      save_failed: 'Salvare eÈ™uatÄƒ',
      add_contact: 'AdaugÄƒ contact ICE',
      remove_contact: 'È˜terge contact',
      max_contacts: 'Maximum 5 contacte',
      contact_added: 'Contact adÄƒugat',
      contact_removed: 'Contact È™ters',
      generate_code: 'GenereazÄƒ cod de urgenÈ›Äƒ',
      code_exists: 'Codul tÄƒu existÄƒ deja',
      code_created: 'Cod generat',
      gen_needs_identity: 'CompleteazÄƒ identitatea (Nume, Data naÈ™terii, Èšara)',
      copy_link: 'CopiazÄƒ linkul',
      link_copied: 'Link copiat!',
      link_missing: 'Nu existÄƒ link â€” genereazÄƒ codul',
      view_card: 'Vezi cardul de urgenÈ›Äƒ',
      must_generate_first: 'GenereazÄƒ codul mai Ã®ntÃ¢i',
      export_png: 'Export PNG',
      exported_png: 'QR exportat ca PNG',
      print_card: 'PrinteazÄƒ cardul',
      speak_summary: 'ğŸ”Š RedÄƒ sumarul medical',
      stop_speaking: 'â¹ï¸ Oprire',
      speech_started: 'Redare sumar medicalâ€¦',
      speech_stopped: 'Redare opritÄƒ',
      speech_error: 'Eroare sintezÄƒ vocalÄƒ',
      speech_unsupported: 'Browserul nu suportÄƒ sinteza vocalÄƒ',
      delete_account: 'È˜terge contul',
      delete_confirm: 'Contul È™i datele vor fi È™terse definitiv. Continui?',
      delete_done: 'Cont È™ters',
      delete_failed: 'È˜tergere eÈ™uatÄƒ',
      offline_badge: 'FUNCÈšIONEAZÄ‚ OFFLINE',
      qr_complete_profile: 'CompleteazÄƒ profilul pentru a genera QR',
      ph_full_name: 'Introdu numele legal complet',
      ph_dob: 'ZZ/LL/AAAA',
      ph_health_id: 'ID sÄƒnÄƒtate, CNP etc.',
      ph_allergy: 'TasteazÄƒ alergia È™i Enter',
      ph_condition: 'TasteazÄƒ afecÈ›iunea È™i Enter',
      ph_medication: 'TasteazÄƒ medicaÈ›ia È™i Enter',
      ph_contact_name: 'Nume complet',
      ph_contact_phone: '+40 700 000 000',
      ph_contact_email: 'contact@exemplu.ro',
      ph_contact_notes: 'InformaÈ›ii suplimentare'
    }
  };

  // Helper: keep SVG, replace text in buttons safely
  function setBtnLabel(btn, text) {
    if (!btn) return;
    const svg = btn.querySelector('svg');
    btn.innerHTML = '';
    if (svg) btn.appendChild(svg);
    btn.appendChild(document.createTextNode(' ' + text));
  }

  function applyPlaceholders(lang) {
    const t = i18n[lang] || i18n.en;
    const setPH = (id, key) => {
      const el = $(id);
      if (el && t[key]) el.placeholder = t[key];
    };
    setPH('fullName', 'ph_full_name');
    setPH('dateOfBirth', 'ph_dob');
    setPH('nationalHealthId', 'ph_health_id');
    setPH('allergiesInput', 'ph_allergy');
    setPH('conditionsInput', 'ph_condition');
    setPH('medicationsInput', 'ph_medication');

    // ICE inputs are dynamic; when created we set PH from current lang (see createIceRow)
  }

  function applyButtonsText(lang) {
    const t = i18n[lang] || i18n.en;
    setBtnLabel($('logoutBtn'), t.logout);
    setBtnLabel($('generateCodeBtn'), t.generate_code);
    setBtnLabel($('viewCardBtn'), t.view_card);
    setBtnLabel($('exportPngBtn'), t.export_png);
    setBtnLabel($('printCardBtn'), t.print_card);
    setBtnLabel($('speakSummaryBtn'), t.speak_summary);
    setBtnLabel($('stopSpeakingBtn'), t.stop_speaking);
    setBtnLabel($('copyLinkBtn'), 'ğŸ“‹ ' + t.copy_link);

    const addBtn = $('addIceContact');
    if (addBtn) {
      const svg = addBtn.querySelector('svg');
      addBtn.innerHTML = '';
      if (svg) addBtn.appendChild(svg);
      addBtn.appendChild(document.createTextNode(' ' + t.add_contact));
    }

    const offline = document.querySelector('.offline-badge');
    if (offline && t.offline_badge) offline.textContent = t.offline_badge;

    const qrPh = $('qrPlaceholder');
    if (qrPh && t.qr_complete_profile) {
      // Keep the SVG in placeholder
      const svg = qrPh.querySelector('svg');
      qrPh.innerHTML = '';
      if (svg) qrPh.appendChild(svg);
      const div = document.createElement('div');
      div.textContent = t.qr_complete_profile;
      qrPh.appendChild(div);
    }
  }

  function setLanguage(lang) {
    const code = i18n[lang] ? lang : 'en';
    localStorage.setItem(LANG_KEY, code);
    applyButtonsText(code);
    applyPlaceholders(code);
  }

  if (languageSelect) {
    const savedLang = localStorage.getItem(LANG_KEY) || languageSelect.value || 'en';
    languageSelect.value = savedLang;
    setLanguage(savedLang);
    languageSelect.addEventListener('change', () => {
      setLanguage(languageSelect.value);
    });
  }

  /* ---------- Session, Auth, Logout ---------- */
  let currentUser = null;
  let currentProfile = null;

  async function requireSession() {
    const { data, error } = await sb.auth.getSession();
    if (error || !data.session) {
      location.replace('index.html');
      return null;
    }
    currentUser = data.session.user;
    return currentUser;
  }

  async function signOut() {
    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (!confirm(t.confirm_logout)) return;
    await sb.auth.signOut().catch(() => {});
    location.replace('index.html');
  }

  if ($('logoutBtn')) $('logoutBtn').addEventListener('click', signOut);

  sb.auth.onAuthStateChange((event, session) => {
    if (!session) {
      location.replace('index.html');
    }
  });

  /* ---------- Profile & Health Autosave ---------- */
  const pillData = (MYQER.pillData = MYQER.pillData || {
    allergies: [],
    conditions: [],
    medications: []
  });

  // Read pills from DOM (in case loaded earlier)
  function readPillsFromDOM() {
    ['allergies', 'conditions', 'medications'].forEach((type) => {
      const wrap = $(`${type}Pills`);
      if (!wrap) return;
      const pills = Array.from(wrap.querySelectorAll('.pill')).map((p) =>
        p.childNodes[0]?.nodeValue?.trim() || ''
      );
      pillData[type] = pills.filter(Boolean);
    });
  }

  async function saveProfile() {
    if (!currentUser) return;
    const full_name = $('fullName')?.value?.trim() || null;
    const date_of_birth = $('dateOfBirth')?.value?.trim() || null;
    const country = $('country')?.value || null;
    const national_health_id = $('nationalHealthId')?.value?.trim() || null;

    const { error } = await sb
      .from('profiles')
      .upsert({
        id: currentUser.id,
        email: currentUser.email,
        full_name,
        date_of_birth,
        country,
        national_health_id,
        code: currentProfile?.code || null
      });

    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (error) {
      console.error(error);
      showToast(t.save_failed, 'error');
    } else {
      showToast(t.saved, 'success');
    }
  }

  const debouncedSaveProfile = debounce(saveProfile, 600);

  async function saveHealthProfile() {
    if (!currentUser) return;
    readPillsFromDOM();
    const blood_type = $('bloodType')?.value || null;
    const organDonorEl = $('organDonor');
    let organ_donor = null;
    if (organDonorEl && organDonorEl.value !== '') {
      organ_donor = organDonorEl.value === 'true';
    }
    const life_support_pref = $('lifeSupportPref')?.value || 'Full';

    // store pills as comma-separated strings
    const allergies = pillData.allergies.join(', ');
    const conditions = pillData.conditions.join(', ');
    const medications = pillData.medications.join(', ');

    // Upsert with user_id as PK or unique
    const { error } = await sb
      .from('health_profiles')
      .upsert({
        user_id: currentUser.id,
        blood_type,
        organ_donor,
        life_support_pref,
        allergies,
        conditions,
        medications
      });

    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (error) {
      console.error(error);
      showToast(t.save_failed, 'error');
    } else {
      showToast(t.saved, 'success');
    }
  }

  const debouncedSaveHealth = debounce(saveHealthProfile, 600);

  // Bind autosave fields
  [
    'fullName',
    'dateOfBirth',
    'country',
    'nationalHealthId',
    'bloodType',
    'organDonor',
    'lifeSupportPref'
  ].forEach((id) => {
    const el = $(id);
    if (!el) return;
    el.addEventListener('input', () => {
      debouncedSaveProfile();
      debouncedSaveHealth();
      updateProfileProgress();
    });
    el.addEventListener('change', () => {
      debouncedSaveProfile();
      debouncedSaveHealth();
      updateProfileProgress();
    });
  });

  // Enter-to-pill handlers
  [
    ['allergiesInput', 'allergies', 'ph_allergy'],
    ['conditionsInput', 'conditions', 'ph_condition'],
    ['medicationsInput', 'medications', 'ph_medication']
  ].forEach(([inputId, type]) => {
    const input = $(inputId);
    if (!input) return;
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim()) {
        e.preventDefault();
        addPill(type, input.value.trim());
        input.value = '';
        debouncedSaveHealth();
      }
    });
  });

  function renderPills(type) {
    const wrap = $(`${type}Pills`);
    if (!wrap) return;
    wrap.innerHTML = pillData[type]
      .map(
        (txt, i) => `
      <div class="pill">
        ${escapeHtml(txt)}
        <span class="pill-remove" data-type="${type}" data-index="${i}">Ã—</span>
      </div>`
      )
      .join('');
    // Attach remove handlers
    wrap.querySelectorAll('.pill-remove').forEach((x) =>
      x.addEventListener('click', () => {
        const t = x.getAttribute('data-type');
        const idx = +x.getAttribute('data-index');
        pillData[t].splice(idx, 1);
        renderPills(t);
        debouncedSaveHealth();
        updateTriageStatus();
        updateProfileProgress();
        showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).saved, 'success');
      })
    );
  }

  function addPill(type, value) {
    if (!value) return;
    if (!pillData[type]) pillData[type] = [];
    if (pillData[type].includes(value)) return;
    pillData[type].push(value);
    renderPills(type);
    updateTriageStatus();
    updateProfileProgress();
  }

  // Escape HTML for pills
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
  }

  /* ---------- ICE Contacts CRUD ---------- */
  const MAX_CONTACTS = 5;
  let iceLoaded = false;

  function makeContactTemplate(contact = {}) {
    const lang = localStorage.getItem(LANG_KEY) || 'en';
    const t = i18n[lang] || i18n.en;
    return `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="form-label">Full Name *</label>
          <input type="text" class="form-input contact-name" placeholder="${t.ph_contact_name}" value="${contact.name ? escapeHtml(contact.name) : ''}">
        </div>
        <div>
          <label class="form-label">Relationship</label>
          <select class="form-select contact-relation">
            ${[
              '',
              'Spouse',
              'Partner',
              'Parent',
              'Child',
              'Sibling',
              'Friend',
              'Colleague',
              'Doctor',
              'Lawyer',
              'Other'
            ]
              .map(
                (opt) =>
                  `<option value="${opt}" ${contact.relationship === opt ? 'selected' : ''}>${opt || 'Select relationship'}</option>`
              )
              .join('')}
          </select>
        </div>
        <div>
          <label class="form-label">Phone Number *</label>
          <input type="tel" class="form-input contact-phone" placeholder="${t.ph_contact_phone}" value="${contact.phone ? escapeHtml(contact.phone) : ''}">
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="form-label">Email (Optional)</label>
          <input type="email" class="form-input contact-email" placeholder="${t.ph_contact_email}" value="${contact.email ? escapeHtml(contact.email) : ''}">
        </div>
        <div>
          <label class="form-label">Notes (Optional)</label>
          <input type="text" class="form-input contact-notes" placeholder="${t.ph_contact_notes}" value="${contact.notes ? escapeHtml(contact.notes) : ''}">
        </div>
      </div>
      <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
        <button class="text-red-600 text-sm hover:text-red-800 font-medium btn-remove-contact">
          <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          ${(i18n[lang] || i18n.en).remove_contact}
        </button>
        <div class="text-xs text-gray-500">Auto-saves on change</div>
      </div>
    `;
  }

  function updateContactCountUI() {
    const list = $('iceContacts');
    const cnt = list ? list.querySelectorAll('.ice-contact-card').length : 0;
    if ($('contactCount')) $('contactCount').textContent = cnt;
    const addBtn = $('addIceContact');
    const lang = localStorage.getItem(LANG_KEY) || 'en';
    const t = i18n[lang] || i18n.en;
    if (addBtn) {
      addBtn.disabled = cnt >= MAX_CONTACTS;
      const svg = addBtn.querySelector('svg');
      if (cnt >= MAX_CONTACTS) {
        addBtn.innerHTML = '';
        if (svg) addBtn.appendChild(svg);
        addBtn.appendChild(document.createTextNode(' ' + t.max_contacts));
      } else {
        addBtn.innerHTML = '';
        if (svg) addBtn.appendChild(svg);
        addBtn.appendChild(document.createTextNode(' ' + t.add_contact));
      }
    }
  }

  function bindIceRowEvents(card, idOrNull) {
    const inputs = card.querySelectorAll('input,select');
    inputs.forEach((el) => {
      el.addEventListener(
        'change',
        debounce(async () => {
          await saveSingleContact(card, idOrNull);
        }, 400)
      );
      el.addEventListener(
        'blur',
        debounce(async () => {
          await saveSingleContact(card, idOrNull);
        }, 400)
      );
    });

    const rm = card.querySelector('.btn-remove-contact');
    if (rm) {
      rm.addEventListener('click', async () => {
        if (!idOrNull) {
          // Unsaved row: just remove
          card.remove();
          updateContactCountUI();
          showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).contact_removed, 'success');
          return;
        }
        await sb.from('ice_contacts').delete().eq('id', idOrNull).eq('user_id', currentUser.id);
        card.remove();
        updateContactCountUI();
        updateProfileProgress();
        showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).contact_removed, 'success');
      });
    }
  }

  async function saveSingleContact(card, idOrNull) {
    const name = card.querySelector('.contact-name')?.value?.trim() || '';
    const relation = card.querySelector('.contact-relation')?.value || '';
    const phone = card.querySelector('.contact-phone')?.value?.trim() || '';
    const email = card.querySelector('.contact-email')?.value?.trim() || '';
    const notes = card.querySelector('.contact-notes')?.value?.trim() || '';

    // Require minimal fields
    if (!name || !phone) return;

    if (!idOrNull) {
      const { data, error } = await sb
        .from('ice_contacts')
        .insert([{ user_id: currentUser.id, name, relationship: relation, phone, email, notes }])
        .select()
        .single();
      if (!error && data) {
        // mark DOM with new id
        card.dataset.contactId = data.id;
        bindIceRowEvents(card, data.id); // re-bind with id
        updateContactCountUI();
        updateProfileProgress();
        showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).saved, 'success');
      }
      return;
    }

    const { error } = await sb
      .from('ice_contacts')
      .update({ name, relationship: relation, phone, email, notes })
      .eq('id', idOrNull)
      .eq('user_id', currentUser.id);

    if (error) {
      console.error(error);
      showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).save_failed, 'error');
    } else {
      showToast((i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en).saved, 'success');
    }
  }

  function createIceRow(contact) {
    const list = $('iceContacts');
    if (!list) return null;
    const div = document.createElement('div');
    div.className = 'ice-contact-card';
    div.innerHTML = makeContactTemplate(contact);
    if (contact.id) div.dataset.contactId = contact.id;
    list.appendChild(div);
    bindIceRowEvents(div, contact.id || null);
    return div;
  }

  async function loadIceContacts() {
    if (!currentUser || iceLoaded) return;
    const { data, error } = await sb.from('ice_contacts').select('*').eq('user_id', currentUser.id).order('created_at');
    if (error) {
      console.error(error);
      return;
    }
    (data || []).forEach((c) => createIceRow(c));
    iceLoaded = true;
    updateContactCountUI();
    updateProfileProgress();
  }

  if ($('addIceContact')) {
    $('addIceContact').addEventListener('click', () => {
      const list = $('iceContacts');
      const countNow = list ? list.querySelectorAll('.ice-contact-card').length : 0;
      const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
      if (countNow >= MAX_CONTACTS) {
        showToast(t.max_contacts, 'warning');
        return;
      }
      createIceRow({});
      updateContactCountUI();
      showToast(t.contact_added, 'success');
    });
  }

  /* ---------- QR: Single, Persistent ---------- */
  async function ensureSingleCode() {
    // If already present in memory, do nothing
    if (currentProfile && currentProfile.code) return currentProfile.code;

      // Load from DB
    const { data, error } = await sb.from('profiles').select('code').eq('id', currentUser.id).single();
    if (!error && data && data.code) {
      currentProfile = { ...(currentProfile || {}), code: data.code };
      updateCardLink(data.code);
      generateQRCode();
      updateProfileProgress();
      return data.code;
    }
    return null;
  }

  function updateCardLink(code) {
    const link = `${ORIGIN}/c/${code}`;
    const linkBox = $('cardLink');
    if (linkBox) linkBox.value = link;
  }

  function generateQRCode() {
    const canvas = $('qrCanvas');
    const placeholder = $('qrPlaceholder');
    if (!currentProfile?.code || !canvas) return;
    const cardUrl = `${ORIGIN}/c/${currentProfile.code}`;
    window.QRCode.toCanvas(
      canvas,
      cardUrl,
      {
        width: 160,
        height: 160,
        margin: 3,
        color: { dark: '#000000', light: '#FFFFFF' },
        errorCorrectionLevel: 'M'
      },
      (err) => {
        if (err) {
          console.error(err);
          if (placeholder) {
            placeholder.style.display = 'block';
            canvas.style.display = 'none';
          }
        } else {
          if (placeholder) placeholder.style.display = 'none';
          canvas.style.display = 'block';
        }
      }
    );
  }

  function randomCode(n = 6) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let out = '';
    for (let i = 0; i < n; i++) out += chars[Math.floor(Math.random() * chars.length)];
    return out;
  }

  async function generateEmergencyCodeOnce() {
    const lang = localStorage.getItem(LANG_KEY) || 'en';
    const t = i18n[lang] || i18n.en;

    // Identity must be complete
    if (!checkIdentityComplete()) {
      showToast(t.gen_needs_identity, 'warning');
      return;
    }

    // Enforce one per user
    const existing = await ensureSingleCode();
    if (existing) {
      showToast(t.code_exists, 'info');
      return;
    }

    // Generate & ensure global uniqueness (simple retry)
    let code = randomCode(6);
    for (let tries = 0; tries < 5; tries++) {
      const { data: found, error: e } = await sb.from('profiles').select('id').eq('code', code).maybeSingle?.() ?? {};
      if (!e && !found) break;
      code = randomCode(6);
    }

    const { error } = await sb
      .from('profiles')
      .upsert({
        id: currentUser.id,
        email: currentUser.email,
        full_name: $('fullName')?.value?.trim() || null,
        date_of_birth: $('dateOfBirth')?.value?.trim() || null,
        country: $('country')?.value || null,
        national_health_id: $('nationalHealthId')?.value?.trim() || null,
        code
      })
      .select()
      .single();

    if (error) {
      console.error(error);
      showToast(t.save_failed, 'error');
      return;
    }

    currentProfile = { ...(currentProfile || {}), code };
    updateCardLink(code);
    generateQRCode();
    updateProfileProgress();
    showToast(t.code_created, 'success');
  }

  if ($('generateCodeBtn')) $('generateCodeBtn').addEventListener('click', generateEmergencyCodeOnce);

  // Share link / copy
  if ($('copyLinkBtn')) {
    $('copyLinkBtn').addEventListener('click', async () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      const box = $('cardLink');
      if (!box?.value) {
        showToast(t.link_missing, 'warning');
        return;
      }
      try {
        await navigator.clipboard.writeText(box.value);
        showToast(t.link_copied, 'success');
      } catch {
        showToast(t.save_failed, 'error');
      }
    });
  }

  if ($('viewCardBtn')) {
    $('viewCardBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (!currentProfile?.code) {
        showToast(t.must_generate_first, 'warning');
        return;
      }
      const cardUrl = `${ORIGIN}/c/${currentProfile.code}`;
      window.open(cardUrl, '_blank');
    });
  }

  if ($('exportPngBtn')) {
    $('exportPngBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      const canvas = $('qrCanvas');
      if (!currentProfile?.code || !canvas || canvas.style.display === 'none') {
        showToast(t.must_generate_first, 'warning');
        return;
      }
      const link = document.createElement('a');
      link.download = `MYQER-${currentProfile.code}-QR.png`;
      link.href = canvas.toDataURL();
      link.click();
      showToast(t.exported_png, 'success');
    });
  }

  if ($('printCardBtn')) {
    $('printCardBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (!currentProfile?.code) {
        showToast(t.must_generate_first, 'warning');
        return;
      }
      const cardUrl = `${ORIGIN}/c/${currentProfile.code}?print=true`;
      window.open(cardUrl, '_blank');
    });
  }

  /* ---------- Triage + Progress ---------- */
  function updateCheckIndicator(elementId, isComplete) {
    const element = $(elementId);
    if (!element) return;
    const circle = element.querySelector('div');
    const text = element.querySelector('span');
    if (isComplete) {
      if (circle) circle.className = 'w-4 h-4 rounded-full bg-green-500';
      if (text) text.className = 'text-green-700 font-medium';
    } else {
      if (circle) circle.className = 'w-4 h-4 rounded-full bg-gray-300';
      if (text) text.className = 'text-gray-600';
    }
  }

  function checkIdentityComplete() {
    const fullName = $('fullName')?.value?.trim();
    const dateOfBirth = $('dateOfBirth')?.value?.trim();
    const country = $('country')?.value;
    return !!(fullName && dateOfBirth && country);
  }

  function checkHealthComplete() {
    const bloodType = $('bloodType')?.value;
    const hasAllergies = (window.MYQER?.pillData?.allergies || []).length > 0;
    const hasConditions = (window.MYQER?.pillData?.conditions || []).length > 0;
    return !!(bloodType || hasAllergies || hasConditions);
  }

  function updateProfileProgress() {
    const checks = {
      identity: checkIdentityComplete(),
      health: checkHealthComplete(),
      contacts: ($('iceContacts')?.querySelectorAll('.ice-contact-card').length || 0) > 0,
      code: !!(currentProfile && currentProfile.code)
    };

    const completedCount = Object.values(checks).filter(Boolean).length;
    const percentage = Math.round((completedCount / 4) * 100);

    const progressCircle = $('progressCircle');
    const progressPercent = $('progressPercent');

    if (progressCircle && progressPercent) {
      const circumference = 2 * Math.PI * 28;
      const strokeDasharray = (percentage / 100) * circumference;
      progressCircle.style.strokeDasharray = `${strokeDasharray} ${circumference}`;
      progressPercent.textContent = `${percentage}%`;
    }

    updateCheckIndicator('checkIdentity', checks.identity);
    updateCheckIndicator('checkHealth', checks.health);
    updateCheckIndicator('checkContacts', checks.contacts);
    updateCheckIndicator('checkCode', checks.code);

    // Auto render QR if fully complete & code exists
    if (percentage === 100 && currentProfile?.code) {
      generateQRCode();
    }
  }

  function updateTriageStatus() {
    const statusElement = $('triageStatus');
    const overrideSel = $('triageOverride');
    if (!statusElement || !overrideSel) return;

    const override = overrideSel.value;

    if (override) {
      const map = {
        Green: { class: 'triage-green', text: 'GREEN - Standard Priority' },
        Amber: { class: 'triage-amber', text: 'AMBER - Urgent Priority' },
        Red: { class: 'triage-red', text: 'RED - Immediate Priority' },
        Black: { class: 'triage-black', text: 'BLACK - Comfort Care' }
      };
      const s = map[override] || map.Green;
      statusElement.className = `triage-status ${s.class}`;
      statusElement.textContent = s.text;
      return;
    }

    // Auto
    const pillData = window.MYQER?.pillData || { allergies: [], conditions: [], medications: [] };
    const lifeSupportPref = $('lifeSupportPref')?.value;
    const criticalAllergies = [
      'penicillin','morphine','codeine','fentanyl','midazolam','propofol',
      'aspirin','ibuprofen','latex','shellfish','nuts','peanuts'
    ];
    const hasCriticalAllergy = pillData.allergies.some((a) =>
      criticalAllergies.some((c) => a.toLowerCase().includes(c))
    );
    const highRiskConditions = [
      'diabetes','heart','cardiac','stroke','seizure','epilepsy',
      'asthma','copd','kidney','liver','cancer'
    ];
    const hasHighRisk = pillData.conditions.some((c) =>
      highRiskConditions.some((r) => c.toLowerCase().includes(r))
    );

    let label = 'GREEN - Standard (Auto)';
    let cls = 'triage-green';
    if (lifeSupportPref === 'DNR') {
      label = 'BLACK - Comfort (Auto)';
      cls = 'triage-black';
    } else if (hasCriticalAllergy || hasHighRisk || pillData.conditions.length > 3) {
      label = 'RED - Immediate (Auto)';
      cls = 'triage-red';
    } else if (pillData.allergies.length > 0 || pillData.conditions.length > 0 || pillData.medications.length > 2) {
      label = 'AMBER - Urgent (Auto)';
      cls = 'triage-amber';
    }
    statusElement.className = `triage-status ${cls}`;
    statusElement.textContent = label;
  }

  if ($('triageOverride')) $('triageOverride').addEventListener('change', updateTriageStatus);

  // Speech
  let currentSpeech = null;
  if ($('speakSummaryBtn')) {
    $('speakSummaryBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (currentSpeech) speechSynthesis.cancel();

      const fullName = $('fullName')?.value || 'Unknown patient';
      const bloodType = $('bloodType')?.value || 'Unknown blood type';
      const pd = window.MYQER?.pillData || { allergies: [], conditions: [], medications: [] };
      const allergies = pd.allergies.length ? pd.allergies.join(', ') : 'No known allergies';
      const conditions = pd.conditions.length ? pd.conditions.join(', ') : 'No known medical conditions';
      const medications = pd.medications.length ? pd.medications.join(', ') : 'No current medications';
      const lifeSupportPref = $('lifeSupportPref')?.value || 'Full life support';

      const summary = `Emergency medical summary for ${fullName}. Blood type: ${bloodType}. Allergies: ${allergies}. Medical conditions: ${conditions}. Current medications: ${medications}. Life support preference: ${lifeSupportPref}.`;

      if ('speechSynthesis' in window) {
        currentSpeech = new SpeechSynthesisUtterance(summary);
        currentSpeech.lang = 'en-US';
        currentSpeech.rate = 0.9;
        currentSpeech.pitch = 1.0;
        currentSpeech.volume = 1.0;

        currentSpeech.onstart = () => {
          $('speakSummaryBtn').style.display = 'none';
          $('stopSpeakingBtn').style.display = 'block';
        };
        currentSpeech.onend = () => {
          $('speakSummaryBtn').style.display = 'block';
          $('stopSpeakingBtn').style.display = 'none';
          currentSpeech = null;
        };
        currentSpeech.onerror = () => {
          $('speakSummaryBtn').style.display = 'block';
          $('stopSpeakingBtn').style.display = 'none';
          currentSpeech = null;
          showToast(t.speech_error, 'error');
        };

        speechSynthesis.speak(currentSpeech);
        showToast(t.speech_started, 'info');
      } else {
        showToast(t.speech_unsupported, 'error');
      }
    });
  }

  if ($('stopSpeakingBtn')) {
    $('stopSpeakingBtn').addEventListener('click', () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (currentSpeech) {
        speechSynthesis.cancel();
        $('speakSummaryBtn').style.display = 'block';
        $('stopSpeakingBtn').style.display = 'none';
        currentSpeech = null;
        showToast(t.speech_stopped, 'info');
      }
    });
  }

  /* ---------- Delete Account (cascade) ---------- */
  if ($('deleteAccountBtn')) {
    $('deleteAccountBtn').addEventListener('click', async () => {
      const lang = localStorage.getItem(LANG_KEY) || 'en';
      const t = i18n[lang] || i18n.en;
      if (!confirm(t.delete_confirm)) return;

      try {
        await sb.from('ice_contacts').delete().eq('user_id', currentUser.id);
        await sb.from('health_profiles').delete().eq('user_id', currentUser.id);
        // Optional: if you track scans
        // await sb.from('scan_logs').delete().eq('user_id', currentUser.id);
        await sb.from('profiles').delete().eq('id', currentUser.id);

        await sb.auth.signOut();
        showToast(t.delete_done, 'success');
        setTimeout(() => location.replace('index.html'), 700);
      } catch (e) {
        console.error(e);
        showToast(t.delete_failed, 'error');
      }
    });
  }

  /* ---------- Load initial data & boot ---------- */
  async function loadProfileAndHealth() {
    const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).maybeSingle?.() ?? {};
    if (profile) {
      currentProfile = profile;
      if ($('fullName')) $('fullName').value = profile.full_name || '';
      if ($('dateOfBirth')) $('dateOfBirth').value = profile.date_of_birth || '';
      if ($('country')) $('country').value = profile.country || '';
      if ($('nationalHealthId')) $('nationalHealthId').value = profile.national_health_id || '';
      if (profile.code) {
        updateCardLink(profile.code);
        generateQRCode();
      }
    }

    const { data: health } = await sb.from('health_profiles').select('*').eq('user_id', currentUser.id).maybeSingle?.() ?? {};
    if (health) {
      if ($('bloodType')) $('bloodType').value = health.blood_type || '';
      if ($('organDonor')) $('organDonor').value = health.organ_donor === null ? '' : String(!!health.organ_donor);
      if ($('lifeSupportPref')) $('lifeSupportPref').value = health.life_support_pref || 'Full';

      const pd = (window.MYQER.pillData = window.MYQER.pillData || { allergies: [], conditions: [], medications: [] });
      pd.allergies = (health.allergies || '').split(',').map((s) => s.trim()).filter(Boolean);
      pd.conditions = (health.conditions || '').split(',').map((s) => s.trim()).filter(Boolean);
      pd.medications = (health.medications || '').split(',').map((s) => s.trim()).filter(Boolean);

      renderPills('allergies');
      renderPills('conditions');
      renderPills('medications');
    }

    updateTriageStatus();
  }

  function bindLanguageOnBoot() {
    const lang = localStorage.getItem(LANG_KEY) || ($('languageSelect') ? $('languageSelect').value : 'en') || 'en';
    setLanguage(lang);
  }

  // Session gate + boot
  async function requireSession() {
    const { data, error } = await sb.auth.getSession();
    if (error || !data.session) {
      location.replace('index.html');
      return null;
    }
    currentUser = data.session.user;
    return currentUser;
  }

  // Logout
  async function signOut() {
    const t = i18n[localStorage.getItem(LANG_KEY) || 'en'] || i18n.en;
    if (!confirm(t.confirm_logout)) return;
    await sb.auth.signOut().catch(() => {});
    location.replace('index.html');
  }
  if ($('logoutBtn')) $('logoutBtn').addEventListener('click', signOut);

  // Auth change guard
  sb.auth.onAuthStateChange((event, session) => {
    if (!session) location.replace('index.html');
  });

  document.addEventListener('DOMContentLoaded', async () => {
    const user = await requireSession();
    if (!user) return;

    bindLanguageOnBoot();
    await loadProfileAndHealth();
    await loadIceContacts();
    await ensureSingleCode();
    updateProfileProgress();
  });
})();
  
