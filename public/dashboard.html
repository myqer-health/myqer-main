<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYQER Dashboard - Emergency Medical Information System</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::before,
        *::after {
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #1e293b;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* CSS Custom Properties */
        :root {
            --primary-red: #dc2626;
            --primary-red-hover: #b91c1c;
            --primary-red-light: #fecaca;
            --success-green: #059669;
            --success-green-hover: #047857;
            --success-green-light: #a7f3d0;
            --warning-amber: #d97706;
            --warning-amber-hover: #b45309;
            --warning-amber-light: #fde68a;
            --info-blue: #2563eb;
            --info-blue-hover: #1d4ed8;
            --info-blue-light: #bfdbfe;
            --ink-dark: #0f172a;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --white: #ffffff;
            --background-primary: #ffffff;
            --background-secondary: #f8fafc;
            --background-tertiary: #f1f5f9;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-dark: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 24px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --spacing-3xl: 64px;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.2s ease-out;
            --transition-slow: 0.3s ease-out;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --ink-dark: #f8fafc;
                --slate-900: #f8fafc;
                --slate-800: #f1f5f9;
                --slate-700: #e2e8f0;
                --slate-600: #cbd5e1;
                --slate-500: #94a3b8;
                --slate-400: #64748b;
                --slate-300: #475569;
                --slate-200: #334155;
                --slate-100: #1e293b;
                --slate-50: #0f172a;
                --background-primary: #0f172a;
                --background-secondary: #1e293b;
                --background-tertiary: #334155;
                --border-light: #334155;
                --border-medium: #475569;
                --border-dark: #64748b;
                --glass-bg: rgba(15, 23, 42, 0.85);
                --glass-border: rgba(255, 255, 255, 0.1);
            }
            
            body {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
                color: var(--slate-100);
            }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity var(--transition-slow), visibility var(--transition-slow);
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            background: var(--white);
            border-radius: var(--radius-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 900;
            color: var(--primary-red);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-2xl);
            animation: pulse 2s infinite;
        }

        .loading-text {
            color: var(--white);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 400;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: var(--spacing-lg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-lg) var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: var(--spacing-lg);
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 900;
            font-size: 20px;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-normal);
        }

        .logo-icon:hover {
            transform: scale(1.05);
        }

        .logo-text {
            font-size: 28px;
            font-weight: 900;
            color: var(--ink-dark);
            letter-spacing: -0.5px;
        }

        .logo-subtitle {
            font-size: 12px;
            color: var(--slate-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: -4px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 14px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-email {
            font-size: 14px;
            font-weight: 500;
            color: var(--slate-700);
        }

        .user-status {
            font-size: 12px;
            color: var(--success-green);
            font-weight: 500;
        }

        /* Language Selector */
        .language-selector {
            position: relative;
        }

        .language-btn {
            background: var(--white);
            border: 1px solid var(--border-light);
            color: var(--slate-700);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 100px;
        }

        .language-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            box-shadow: var(--shadow-sm);
        }

        .language-dropdown {
            position: absolute;
            top: calc(100% + var(--spacing-sm));
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            min-width: 220px;
            max-height: 320px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-normal);
        }

        .language-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .language-option {
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .language-option:hover {
            background-color: var(--slate-50);
        }

        .language-option.active {
            background-color: var(--primary-red);
            color: var(--white);
        }

        .language-option:first-child {
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .language-option:last-child {
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        /* Logout Button */
        .logout-btn {
            background: none;
            border: 1px solid var(--border-light);
            color: var(--slate-600);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logout-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            background: var(--primary-red-light);
        }

        /* Offline Banner */
        .offline-banner {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
            color: var(--white);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
            display: none;
            align-items: center;
            gap: var(--spacing-md);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            animation: slideDown 0.3s ease-out;
        }

        .offline-banner.show {
            display: flex;
        }

        .offline-icon {
            font-size: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Styles */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: var(--radius-2xl) 0 0 var(--radius-2xl);
        }

        .card.identity::before {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
        }

        .card.critical::before {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
        }

        .card.ice::before {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
        }

        .card.emergency::before {
            background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));
        }

        .card.delete {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.03), rgba(239, 68, 68, 0.03));
            border: 2px solid rgba(220, 38, 38, 0.1);
        }

        .card.delete::before {
            background: linear-gradient(135deg, var(--primary-red), #ef4444);
        }

        /* Card Header */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-2xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .card-title-section {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .card-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--ink-dark);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            letter-spacing: -0.5px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--slate-500);
            font-weight: 500;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--white);
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        /* Triage System */
        .triage-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .triage-pill {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-2xl);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .triage-pill:hover {
            transform: scale(1.05);
        }

        .triage-green {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
            color: var(--white);
        }

        .triage-amber {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
            color: var(--white);
        }

        .triage-red {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            color: var(--white);
        }

        .triage-black {
            background: linear-gradient(135deg, #374151, #1f2937);
            color: var(--white);
        }

        .triage-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-label-required::after {
            content: '*';
            color: var(--primary-red);
            font-weight: 700;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 400;
            background: var(--white);
            transition: all var(--transition-normal);
            font-family: inherit;
            color: var(--slate-700);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            background: var(--white);
        }

        .form-input:invalid,
        .form-select:invalid,
        .form-textarea:invalid {
            border-color: var(--primary-red);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right var(--spacing-md) center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: var(--spacing-2xl);
        }

        .form-help {
            font-size: 12px;
            color: var(--slate-500);
            font-style: italic;
        }

        .form-error {
            font-size: 12px;
            color: var(--primary-red);
            font-weight: 500;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) 0;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-red);
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--slate-700);
            cursor: pointer;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: none;
            text-decoration: none;
            font-family: inherit;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary-red);
            border: 2px solid var(--primary-red);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--primary-red);
            color: var(--white);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--primary-red), #ef4444);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-ghost {
            background: transparent;
            color: var(--slate-600);
            border: 1px solid var(--border-light);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--slate-50);
            border-color: var(--slate-300);
        }

        .btn-sm {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 12px;
        }

        .btn-lg {
            padding: var(--spacing-lg) var(--spacing-xl);
            font-size: 16px;
        }

        /* ICE Contacts */
        .ice-contacts-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .ice-contact {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            transition: all var(--transition-normal);
            position: relative;
        }

        .ice-contact:hover {
            border-color: var(--warning-amber);
            box-shadow: var(--shadow-md);
        }

        .ice-contact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
        }

        .ice-contact-title {
            font-weight: 700;
            font-size: 18px;
            color: var(--ink-dark);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .ice-contact-number {
            background: var(--warning-amber);
            color: var(--white);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .ice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }

        .no-contacts {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--slate-500);
            font-style: italic;
            background: var(--slate-50);
            border-radius: var(--radius-xl);
            border: 2px dashed var(--border-medium);
        }

        .no-contacts-icon {
            font-size: 48px;
            color: var(--slate-400);
            margin-bottom: var(--spacing-md);
        }

        /* QR Code Section */
        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xl);
            text-align: center;
        }

        .qr-box {
            width: 280px;
            height: 280px;
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-xl);
            border: 3px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .qr-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--primary-red), var(--warning-amber), var(--success-green), var(--info-blue));
            border-radius: var(--radius-xl);
            z-index: -1;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .qr-code-text {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--ink-dark);
            letter-spacing: 3px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .qr-label {
            font-size: 14px;
            color: var(--primary-red);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: var(--spacing-sm);
        }

        .qr-url-section {
            width: 100%;
            max-width: 600px;
        }

        .url-group {
            display: flex;
            gap: var(--spacing-md);
            width: 100%;
        }

        .url-input {
            flex: 1;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 14px;
            background: var(--slate-50);
            border: 2px solid var(--border-light);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            color: var(--slate-700);
        }

        .qr-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Delete Section */
        .delete-section {
            text-align: center;
            padding: var(--spacing-3xl);
        }

        .delete-title {
            font-size: 32px;
            font-weight: 900;
            color: var(--primary-red);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .delete-warning {
            color: var(--slate-600);
            margin-bottom: var(--spacing-2xl);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            font-size: 16px;
            line-height: 1.6;
        }

        .confirm-input {
            max-width: 400px;
            margin: 0 auto var(--spacing-xl);
            text-align: center;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-radius: var(--radius-lg);
            color: var(--white);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform var(--transition-slow);
            box-shadow: var(--shadow-2xl);
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));
        }

        .toast.error {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
        }

        .toast.info {
            background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 18px;
            margin-left: auto;
            padding: var(--spacing-xs);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-slow);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-3xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-2xl);
            transform: scale(0.9);
            transition: transform var(--transition-slow);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-red);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .modal-text {
            color: var(--slate-600);
            margin-bottom: var(--spacing-2xl);
            font-size: 16px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Footer */
        .footer {
            margin-top: var(--spacing-3xl);
            padding: var(--spacing-3xl) 0;
            border-top: 2px solid var(--border-light);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }

        .footer-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .footer-logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 800;
            font-size: 14px;
        }

        .footer-logo-text {
            font-size: 18px;
            font-weight: 800;
            color: var(--ink-dark);
        }

        .footer-links {
            display: flex;
            gap: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--slate-500);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color var(--transition-normal);
        }

        .footer-link:hover {
            color: var(--primary-red);
        }

        .footer-copyright {
            color: var(--slate-400);
            font-size: 12px;
            text-align: center;
            width: 100%;
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-light);
        }

        /* Saving Indicator */
        .saving-indicator {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-700);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all var(--transition-slow);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
        }

        .saving-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .saving-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-container {
                padding: var(--spacing-md);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .ice-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-actions {
                justify-content: space-between;
            }
            
            .card {
                padding: var(--spacing-lg);
            }
            
            .card-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-lg);
            }
            
            .card-actions {
                justify-content: stretch;
            }
            
            .card-actions .btn {
                flex: 1;
            }
            
            .qr-actions {
                flex-direction: column;
            }
            
            .url-group {
                flex-direction: column;
            }
            
            .triage-container {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-md);
            }
            
            .modal-content {
                margin: var(--spacing-lg);
                width: auto;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            
            .footer-links {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: var(--spacing-sm);
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .qr-box {
                width: 240px;
                height: 240px;
            }
            
            .qr-code-text {
                font-size: 20px;
                letter-spacing: 1px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-sm {
            gap: var(--spacing-sm);
        }

        .gap-md {
            gap: var(--spacing-md);
        }

        .gap-lg {
            gap: var(--spacing-lg);
        }

        .mt-sm {
            margin-top: var(--spacing-sm);
        }

        .mt-md {
            margin-top: var(--spacing-md);
        }

        .mt-lg {
            margin-top: var(--spacing-lg);
        }

        .mb-sm {
            margin-bottom: var(--spacing-sm);
        }

        .mb-md {
            margin-bottom: var(--spacing-md);
        }

        .mb-lg {
            margin-bottom: var(--spacing-lg);
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .header,
            .footer,
            .btn,
            .modal,
            .toast,
            .saving-indicator,
            .offline-banner {
                display: none !important;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .qr-box {
                border: 2px solid #000;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --border-light: #000000;
                --border-medium: #000000;
                --border-dark: #000000;
            }
            
            .card {
                border: 2px solid #000000;
            }
            
            .btn {
                border: 2px solid #000000;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">M</div>
        <div class="loading-text">MYQER Dashboard</div>
        <div class="loading-subtext">Loading your emergency medical information...</div>
        <div class="spinner"></div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="main-container hidden">
        <!-- Offline Banner -->
        <div id="offlineBanner" class="offline-banner">
            <i class="fas fa-wifi-slash offline-icon"></i>
            <span data-i18n="offline_mode">You're offline. Changes will sync when connection is restored.</span>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <div class="logo-text">MYQER</div>
                        <div class="logo-subtitle">Emergency Medical System</div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <div class="user-email" id="userEmail">user@example.com</div>
                            <div class="user-status" data-i18n="online_status">Online</div>
                        </div>
                    </div>
                    
                    <div class="language-selector">
                        <button class="language-btn" onclick="toggleLanguageDropdown()">
                            <span id="currentLanguage">üá∫üá∏ EN</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="languageDropdown" class="language-dropdown">
                            <div class="language-option active" onclick="changeLanguage('en')">üá∫üá∏ English</div>
                            <div class="language-option" onclick="changeLanguage('es')">üá™üá∏ Espa√±ol</div>
                            <div class="language-option" onclick="changeLanguage('fr')">üá´üá∑ Fran√ßais</div>
                            <div class="language-option" onclick="changeLanguage('de')">üá©üá™ Deutsch</div>
                            <div class="language-option" onclick="changeLanguage('it')">üáÆüáπ Italiano</div>
                            <div class="language-option" onclick="changeLanguage('pt')">üáµüáπ Portugu√™s</div>
                            <div class="language-option" onclick="changeLanguage('ro')">üá∑üá¥ Rom√¢nƒÉ</div>
                            <div class="language-option" onclick="changeLanguage('ar')">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                            <div class="language-option" onclick="changeLanguage('hi')">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                            <div class="language-option" onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</div>
                        </div>
                    </div>
                    
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-i18n="logout">Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Identity Card -->
        <div class="card identity fade-in">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--success-green), var(--success-green-hover));">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <span data-i18n="identity_title">Identity ‚Äî Personal Information</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="identity_subtitle">Your basic personal and identification details</p>
                </div>
                <div class="card-actions">
                    <button class="btn btn-success" onclick="saveProfile()">
                        <i class="fas fa-save"></i>
                        <span data-i18n="save">Save</span>
                    </button>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label form-label-required" data-i18n="full_name">Full Name</label>
                    <input type="text" id="fullName" class="form-input" placeholder="Enter your full legal name" required>
                    <div class="form-help" data-i18n="full_name_help">Enter your complete legal name as it appears on official documents</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="date_of_birth">Date of Birth</label>
                    <input type="date" id="dob" class="form-input">
                    <div class="form-help" data-i18n="dob_help">Used for age verification in medical emergencies</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="country">Country</label>
                    <select id="country" class="form-select">
                        <option value="">Select Country</option>
                        <option value="United States">üá∫üá∏ United States</option>
                        <option value="Canada">üá®üá¶ Canada</option>
                        <option value="United Kingdom">üá¨üáß United Kingdom</option>
                        <option value="Germany">üá©üá™ Germany</option>
                        <option value="France">üá´üá∑ France</option>
                        <option value="Spain">üá™üá∏ Spain</option>
                        <option value="Italy">üáÆüáπ Italy</option>
                        <option value="Australia">üá¶üá∫ Australia</option>
                        <option value="Japan">üáØüáµ Japan</option>
                        <option value="China">üá®üá≥ China</option>
                        <option value="India">üáÆüá≥ India</option>
                        <option value="Brazil">üáßüá∑ Brazil</option>
                        <option value="Mexico">üá≤üáΩ Mexico</option>
                        <option value="Argentina">üá¶üá∑ Argentina</option>
                        <option value="South Africa">üáøüá¶ South Africa</option>
                        <option value="Nigeria">üá≥üá¨ Nigeria</option>
                        <option value="Egypt">üá™üá¨ Egypt</option>
                        <option value="Russia">üá∑üá∫ Russia</option>
                        <option value="Turkey">üáπüá∑ Turkey</option>
                        <option value="Saudi Arabia">üá∏üá¶ Saudi Arabia</option>
                    </select>
                    <div class="form-help" data-i18n="country_help">Helps emergency responders understand local medical systems</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="health_id">National/Health ID (Optional)</label>
                    <input type="text" id="healthId" class="form-input" placeholder="e.g., SSN, NHS Number, Health Card">
                    <div class="form-help" data-i18n="health_id_help">National health identifier for faster medical record access</div>
                </div>
            </div>
        </div>

        <!-- Critical Medical Information Card -->
        <div class="card critical slide-up">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--primary-red), var(--primary-red-hover));">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <span data-i18n="critical_title">CRITICAL ‚Äî Medical & Health Details</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="critical_subtitle">Life-saving medical information for emergency responders</p>
                </div>
                
                <div class="card-actions">
                    <div class="triage-container">
                        <select id="triageOverride" class="form-select" style="width: auto; min-width: 140px;" onchange="updateTriage()">
                            <option value="auto" data-i18n="auto">Auto</option>
                            <option value="green" data-i18n="green">Green</option>
                            <option value="amber" data-i18n="amber">Amber</option>
                            <option value="red" data-i18n="red">Red</option>
                            <option value="black" data-i18n="black">Black</option>
                        </select>
                        
                        <div id="triagePill" class="triage-pill triage-green">
                            <div class="triage-indicator"></div>
                            <span data-i18n="green">Green</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning" onclick="saveHealth()">
                        <i class="fas fa-save"></i>
                        <span data-i18n="save">Save</span>
                    </button>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" data-i18n="blood_type">Blood Type</label>
                    <select id="bloodType" class="form-select" onchange="updateTriage()">
                        <option value="">Select Blood Type</option>
                        <option value="A+">ü©∏ A+ (A Positive)</option>
                        <option value="A-">ü©∏ A- (A Negative)</option>
                        <option value="B+">ü©∏ B+ (B Positive)</option>
                        <option value="B-">ü©∏ B- (B Negative)</option>
                        <option value="AB+">ü©∏ AB+ (AB Positive)</option>
                        <option value="AB-">ü©∏ AB- (AB Negative)</option>
                        <option value="O+">ü©∏ O+ (O Positive)</option>
                        <option value="O-">ü©∏ O- (O Negative)</option>
                    </select>
                    <div class="form-help" data-i18n="blood_type_help">Critical for blood transfusions and medical procedures</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="allergies">Critical Allergies</label>
                    <input type="text" id="allergies" class="form-input" placeholder="e.g., Penicillin, Nuts, Shellfish, Latex" onchange="updateTriage()">
                    <div class="form-help" data-i18n="allergies_help">List all known allergies that could cause severe reactions</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="conditions">Medical Conditions</label>
                    <textarea id="conditions" class="form-textarea" placeholder="List any chronic conditions, diseases, or ongoing medical issues (e.g., Diabetes, Hypertension, Epilepsy)" onchange="updateTriage()"></textarea>
                    <div class="form-help" data-i18n="conditions_help">Include chronic diseases, mental health conditions, and ongoing treatments</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="medications">Current Medications</label>
                    <textarea id="medications" class="form-textarea" placeholder="List all current medications with dosages (e.g., Metformin 500mg twice daily, Lisinopril 10mg once daily)" onchange="updateTriage()"></textarea>
                    <div class="form-help" data-i18n="medications_help">Include prescription drugs, over-the-counter medications, and supplements</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="implants">Implants/Medical Devices</label>
                    <input type="text" id="implants" class="form-input" placeholder="e.g., Pacemaker, Hip replacement, Insulin pump, Cochlear implant" onchange="updateTriage()">
                    <div class="form-help" data-i18n="implants_help">Medical devices that could affect treatment or require special consideration</div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="organDonor" class="checkbox">
                        <label for="organDonor" class="checkbox-label" data-i18n="organ_donor">I am an organ donor</label>
                    </div>
                    <div class="form-help" data-i18n="organ_donor_help">Indicates your consent for organ donation in case of brain death</div>
                </div>
            </div>
        </div>

        <!-- Emergency Contacts (ICE) Card -->
        <div class="card ice bounce-in">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--warning-amber), var(--warning-amber-hover));">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <span data-i18n="ice_title">Emergency Contacts (ICE)</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="ice_subtitle">People to contact in case of emergency (maximum 3 contacts)</p>
                </div>
                
                <div class="card-actions">
                    <button class="btn btn-secondary" onclick="addContact()" id="addContactBtn">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="add_contact">Add Contact</span>
                    </button>
                    <button class="btn btn-warning" onclick="saveICE()">
                        <i class="fas fa-save"></i>
                        <span data-i18n="save_all">Save All</span>
                    </button>
                </div>
            </div>
            
            <div id="iceContacts" class="ice-contacts-container">
                <div class="no-contacts">
                    <div class="no-contacts-icon">
                        <i class="fas fa-address-book"></i>
                    </div>
                    <div data-i18n="no_contacts">No emergency contacts added yet. Click "Add Contact" to get started.</div>
                </div>
            </div>
        </div>

        <!-- Emergency Card & QR Code -->
        <div class="card emergency fade-in">
            <div class="card-header">
                <div class="card-title-section">
                    <h2 class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--info-blue), var(--info-blue-hover));">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <span data-i18n="qr_title">Emergency Card & QR Code</span>
                    </h2>
                    <p class="card-subtitle" data-i18n="qr_subtitle">Your unique emergency medical information access code</p>
                </div>
            </div>
            
            <div class="qr-container">
                <div class="qr-box">
                    <div id="qrcode"></div>
                </div>
                
                <div class="qr-code-text" id="qrCodeText">MQ7X9K</div>
                <div class="qr-label">MYQER‚Ñ¢ EMERGENCY ACCESS</div>
                
                <div class="qr-url-section">
                    <div class="url-group">
                        <input type="text" id="cardUrl" class="url-input" readonly value="https://www.myqer.com/c/MQ7X9K">
                        <button class="btn btn-secondary" onclick="copyUrl()">
                            <i class="fas fa-copy"></i>
                            <span data-i18n="copy">Copy</span>
                        </button>
                        <button class="btn btn-secondary" onclick="openUrl()">
                            <i class="fas fa-external-link-alt"></i>
                            <span data-i18n="open">Open</span>
                        </button>
                    </div>
                </div>
                
                <div class="qr-actions">
                    <button class="btn btn-ghost" onclick="downloadQR('png')">
                        <i class="fas fa-download"></i>
                        <span data-i18n="download_png">Download PNG</span>
                    </button>
                    <button class="btn btn-ghost" onclick="downloadQR('svg')">
                        <i class="fas fa-download"></i>
                        <span data-i18n="download_svg">Download SVG</span>
                    </button>
                    <button class="btn btn-ghost" onclick="printQR()">
                        <i class="fas fa-print"></i>
                        <span data-i18n="print">Print Card</span>
                    </button>
                    <button class="btn btn-primary" onclick="generateQRCode()">
                        <i class="fas fa-sync-alt"></i>
                        <span data-i18n="regenerate">Regenerate</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Account Card -->
        <div class="card delete slide-up">
            <div class="delete-section">
                <h2 class="delete-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span data-i18n="delete_title">Delete Account</span>
                </h2>
                <p class="delete-warning" data-i18n="delete_warning">
                    This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers. Your emergency contacts will no longer be able to access your medical information.
                </p>
                <div class="form-group">
                    <label class="form-label" data-i18n="delete_confirm_label">Type "DELETE MY ACCOUNT" to confirm:</label>
                    <input type="text" id="deleteConfirm" class="form-input confirm-input" placeholder="DELETE MY ACCOUNT">
                </div>
                <button class="btn btn-danger btn-lg" onclick="deleteAccount()">
                    <i class="fas fa-trash-alt"></i>
                    <span data-i18n="delete_account">Delete My Account Permanently</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-logo">
                    <div class="footer-logo-icon">M</div>
                    <div class="footer-logo-text">MYQER</div>
                </div>
                
                <div class="footer-links">
                    <a href="#" class="footer-link" data-i18n="privacy_policy">Privacy Policy</a>
                    <a href="#" class="footer-link" data-i18n="terms_of_service">Terms of Service</a>
                    <a href="#" class="footer-link" data-i18n="support">Support</a>
                    <a href="#" class="footer-link" data-i18n="about">About MYQER</a>
                </div>
                
                <div class="footer-copyright" data-i18n="copyright">
                    ¬© 2024 MYQER. All rights reserved. Saving lives through technology.
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-icon"></div>
        <div class="toast-message"></div>
        <button class="toast-close" onclick="hideToast()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Saving Indicator -->
    <div id="savingIndicator" class="saving-indicator">
        <div class="saving-spinner"></div>
        <span data-i18n="saving">Saving...</span>
    </div>

    <!-- Session Expiry Modal -->
    <div id="idleModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">
                <i class="fas fa-clock"></i>
                <span data-i18n="session_expiring">Session Expiring</span>
            </h3>
            <p class="modal-text">
                <span data-i18n="session_expire_text">Your session will expire in</span> 
                <strong><span id="countdown">60</span></strong> 
                <span data-i18n="seconds">seconds due to inactivity.</span>
            </p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="resetIdleTimer()">
                    <i class="fas fa-refresh"></i>
                    <span data-i18n="stay_logged_in">Stay Logged In</span>
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="logout">Logout</span>
                </button>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================
   MYQER Dashboard ‚Äî Logic
   ========================= */

/** -------- Supabase -------- **/
const SUPABASE_URL  = "https://dmntmhkncldgynufajei.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbnRtaGtuY2xkZ3ludWZhamVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzQ2MzUsImV4cCI6MjA3MjQxMDYzNX0.6DzOSb0xu5bp4g2wKy3SNtEEuSQavs_ohscyawvPmrY";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { storage: window.localStorage, persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/** -------- State -------- **/
let session = null;
let uid = null;
let debounceTimers = {};
let errorToastLockedUntil = 0;
let autoToastLockedUntil = 0;
let iceContacts = []; // {id, name, relation, phone}
let userCode = null;
let currentLanguage = "en";
let isGeneratingQR = false;

/** -------- i18n (10 langs) -------- **/
const T = {
  en: { // English
    offline_mode: "You're offline. Changes will sync when connection is restored.",
    online_status: "Online",
    logout: "Logout",
    identity_title: "Identity ‚Äî Personal Information",
    identity_subtitle: "Your basic personal and identification details",
    save: "Save",
    full_name: "Full Name",
    full_name_help: "Enter your complete legal name as it appears on official documents",
    date_of_birth: "Date of Birth",
    dob_help: "Used for age verification in medical emergencies",
    country: "Country",
    country_help: "Helps emergency responders understand local medical systems",
    health_id: "National/Health ID (Optional)",
    health_id_help: "National health identifier for faster medical record access",
    critical_title: "CRITICAL ‚Äî Medical & Health Details",
    critical_subtitle: "Life-saving medical information for emergency responders",
    auto: "Auto", green: "Green", amber: "Amber", red: "Red", black: "Black",
    blood_type: "Blood Type",
    blood_type_help: "Critical for blood transfusions and medical procedures",
    allergies: "Critical Allergies",
    allergies_help: "List all known allergies that could cause severe reactions",
    conditions: "Medical Conditions",
    conditions_help: "Include chronic diseases, mental health conditions, and ongoing treatments",
    medications: "Current Medications",
    medications_help: "Include prescription drugs, over-the-counter medications, and supplements",
    implants: "Implants/Medical Devices",
    implants_help: "Medical devices that could affect treatment or require special consideration",
    organ_donor: "I am an organ donor",
    organ_donor_help: "Indicates your consent for organ donation in case of brain death",
    ice_title: "Emergency Contacts (ICE)",
    ice_subtitle: "People to contact in case of emergency (maximum 3 contacts)",
    add_contact: "Add Contact",
    save_all: "Save All",
    qr_title: "Emergency Card & QR Code",
    qr_subtitle: "Your unique emergency medical information access code",
    copy: "Copy", open: "Open",
    download_png: "Download PNG", download_svg: "Download SVG", print: "Print Card", regenerate: "Regenerate",
    delete_title: "Delete Account",
    delete_warning: "This action cannot be undone. All your emergency medical data, QR codes, and profile information will be permanently deleted from our servers. Your emergency contacts will no longer be able to access your medical information.",
    delete_confirm_label: "Type \"DELETE MY ACCOUNT\" to confirm:",
    delete_account: "Delete My Account Permanently",
    privacy_policy: "Privacy Policy", terms_of_service: "Terms of Service", support: "Support", about: "About MYQER",
    saving: "Saving...", session_expiring: "Session Expiring", session_expire_text: "Your session will expire in", seconds: "seconds due to inactivity.", stay_logged_in: "Stay Logged In",
    contact_name: "Name", contact_relationship: "Relationship", contact_phone: "Phone", remove: "Remove",
    no_contacts: "No emergency contacts added yet. Click \"Add Contact\" to get started.",
    profile_saved: "Profile saved successfully", health_saved: "Health data saved successfully", ice_saved: "Emergency contacts saved successfully",
    auto_saved: "Changes saved automatically",
    url_copied: "URL copied to clipboard", qr_downloaded: "QR code downloaded successfully", account_deleted: "Account deleted successfully",
    save_error: "Failed to save data", network_error: "Network error. Please check your connection.", validation_error: "Please fill in all required fields", max_contacts: "Maximum 3 emergency contacts allowed", confirm_delete: "Please type \"DELETE MY ACCOUNT\" exactly to confirm",
    qr_ready: "QRs are up to date", qr_fail: "Failed to generate QR code",
    schema_warn: "Some data could not be loaded (missing table/column). Functionality continues.",
    live_qr_label: "MYQER‚Ñ¢ EMERGENCY ACCESS",
    offline_qr_label: "Offline Text QR",
    offline_qr_downloaded: "Offline QR PNG downloaded",
    logout_ok: "Signed out"
  },
  es: { // Spanish
    offline_mode: "Est√°s desconectado. Los cambios se sincronizar√°n cuando vuelva la conexi√≥n.",
    online_status: "En l√≠nea", logout: "Cerrar sesi√≥n",
    identity_title: "Identidad ‚Äî Informaci√≥n Personal", identity_subtitle: "Tus datos personales e identificativos",
    save: "Guardar", full_name: "Nombre completo", full_name_help: "Escribe tu nombre legal tal como aparece en documentos oficiales",
    date_of_birth: "Fecha de nacimiento", dob_help: "Usado para verificar la edad en emergencias",
    country: "Pa√≠s", country_help: "Ayuda a entender los sistemas m√©dicos locales",
    health_id: "ID nacional/salud (opcional)", health_id_help: "Identificador de salud para un acceso r√°pido",
    critical_title: "CR√çTICO ‚Äî Datos M√©dicos y de Salud", critical_subtitle: "Informaci√≥n vital para emergencias",
    auto: "Auto", green: "Verde", amber: "√Åmbar", red: "Rojo", black: "Negro",
    blood_type: "Tipo de sangre", blood_type_help: "Crucial para transfusiones y procedimientos",
    allergies: "Alergias cr√≠ticas", allergies_help: "Enumera alergias que puedan causar reacciones graves",
    conditions: "Condiciones m√©dicas", conditions_help: "Incluye enfermedades cr√≥nicas y tratamientos",
    medications: "Medicamentos", medications_help: "Incluye recetados, OTC y suplementos",
    implants: "Implantes/Dispositivos", implants_help: "Dispositivos que afectan el tratamiento",
    organ_donor: "Soy donante de √≥rganos", organ_donor_help: "Indica consentimiento para donar √≥rganos",
    ice_title: "Contactos de emergencia (ICE)", ice_subtitle: "Personas a contactar (m√°ximo 3)",
    add_contact: "A√±adir contacto", save_all: "Guardar todo",
    qr_title: "Tarjeta de emergencia y QR", qr_subtitle: "Tu c√≥digo √∫nico de acceso m√©dico",
    copy: "Copiar", open: "Abrir", download_png: "Descargar PNG", download_svg: "Descargar SVG", print: "Imprimir tarjeta", regenerate: "Regenerar",
    delete_title: "Eliminar cuenta", delete_warning: "Esta acci√≥n es irreversible...",
    delete_confirm_label: "Escribe \"DELETE MY ACCOUNT\" para confirmar:", delete_account: "Eliminar mi cuenta permanentemente",
    privacy_policy: "Privacidad", terms_of_service: "T√©rminos", support: "Soporte", about: "Acerca de MYQER",
    saving: "Guardando...", session_expiring: "Sesi√≥n por expirar", session_expire_text: "Tu sesi√≥n expirar√° en", seconds: "segundos por inactividad.", stay_logged_in: "Mantener sesi√≥n",
    contact_name: "Nombre", contact_relationship: "Relaci√≥n", contact_phone: "Tel√©fono", remove: "Eliminar",
    no_contacts: "Sin contactos a√∫n. Haz clic en \"A√±adir contacto\".",
    profile_saved: "Perfil guardado", health_saved: "Salud guardada", ice_saved: "Contactos guardados",
    auto_saved: "Cambios guardados autom√°ticamente",
    url_copied: "URL copiada", qr_downloaded: "QR descargado", account_deleted: "Cuenta eliminada",
    save_error: "Error al guardar", network_error: "Error de red", validation_error: "Completa los campos requeridos", max_contacts: "M√°ximo 3 contactos", confirm_delete: "Escribe exactamente \"DELETE MY ACCOUNT\"",
    qr_ready: "QRs actualizados", qr_fail: "No se pudo generar el QR",
    schema_warn: "No se pudo cargar parte de los datos. Continuamos.",
    live_qr_label: "ACCESO DE EMERGENCIA MYQER‚Ñ¢",
    offline_qr_label: "QR de texto sin conexi√≥n",
    offline_qr_downloaded: "QR sin conexi√≥n descargado",
    logout_ok: "Sesi√≥n cerrada"
  },
  fr: { /* concise FR */ ...baseLang("fr") },
  de: { ...baseLang("de") },
  it: { ...baseLang("it") },
  pt: { ...baseLang("pt") },
  ro: { ...baseLang("ro") },
  ar: { ...baseLang("ar", {rtl:true}) },
  hi: { ...baseLang("hi") },
  zh: { ...baseLang("zh") }
};

// Tiny helper to keep this block compact (basic fallbacks for non-en/es)
function baseLang(code, extra={}) {
  // For brevity, we mirror EN keys; you can refine text later.
  return Object.assign({}, T.en, { /* placeholder localized strings */ }, extra);
}

/** -------- Utilities -------- **/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function nowSec(){ return Math.floor(Date.now()/1000); }
function toastRateLimited(type, msg, lockSec=5){
  const t = nowSec();
  const lock = (type==="error") ? errorToastLockedUntil : autoToastLockedUntil;
  if (t < lock) return;
  showToast(msg, type);
  if (type==="error") errorToastLockedUntil = t + lockSec;
  else autoToastLockedUntil = t + 5;
}
function textBytes(s){ return new TextEncoder().encode(s).length; }
function onLine(){ return navigator.onLine; }

function showToast(message, type="info"){
  const toast = $("#toast");
  toast.className = `toast ${type} show`;
  toast.querySelector(".toast-message").textContent = message;
  const icon = {success:"fas fa-check-circle",error:"fas fa-exclamation-circle",warning:"fas fa-exclamation-triangle",info:"fas fa-info-circle"}[type] || "fas fa-info-circle";
  toast.querySelector(".toast-icon").className = `toast-icon ${icon}`;
  setTimeout(hideToast, 4200);
}
function hideToast(){ $("#toast").classList.remove("show"); }
function showSaving(){ $("#savingIndicator").classList.add("show"); }
function hideSaving(){ $("#savingIndicator").classList.remove("show"); }

/** -------- Online/Offline Banner -------- **/
function setupOnlineBanner(){
  const banner = $("#offlineBanner");
  const statusEl = document.querySelector('[data-i18n="online_status"]');
  function update(){
    if (onLine()) {
      banner.classList.remove("show");
      if (statusEl) statusEl.textContent = tr("online_status");
    } else {
      banner.classList.add("show");
      if (statusEl) statusEl.textContent = "Offline";
    }
  }
  window.addEventListener("online", update);
  window.addEventListener("offline", update);
  update();
}

/** -------- i18n Apply -------- **/
function tr(key){ return (T[currentLanguage] && T[currentLanguage][key]) || (T.en[key] || key); }
function applyTranslations(){
  $$("[data-i18n]").forEach(el=>{
    const k = el.getAttribute("data-i18n");
    const txt = tr(k);
    if (txt) el.textContent = txt;
  });
  // refresh ICE labels and buttons
  renderICE();
}
function setLanguage(lang){
  currentLanguage = T[lang] ? lang : "en";
  localStorage.setItem("myqer_language", currentLanguage);
  const flags = {en:"üá∫üá∏ EN", es:"üá™üá∏ ES", fr:"üá´üá∑ FR", de:"üá©üá™ DE", it:"üáÆüáπ IT", pt:"üáµüáπ PT", ro:"üá∑üá¥ RO", ar:"üá∏üá¶ AR", hi:"üáÆüá≥ HI", zh:"üá®üá≥ ZH"};
  $("#currentLanguage").textContent = flags[currentLanguage] || "EN";
  // activate item
  $$("#languageDropdown .language-option").forEach(n=>n.classList.remove("active"));
  const opt = Array.from($$("#languageDropdown .language-option")).find(n=>n.textContent.toLowerCase().includes((currentLanguage==="en"?"English":currentLanguage)));
  if (opt) opt.classList.add("active");
  applyTranslations();
}
function toggleLanguageDropdown(){
  $("#languageDropdown").classList.toggle("show");
  document.addEventListener("click", function onDoc(e){
    if (!e.target.closest(".language-selector")) {
      $("#languageDropdown").classList.remove("show");
      document.removeEventListener("click", onDoc);
    }
  });
}
window.toggleLanguageDropdown = toggleLanguageDropdown;
window.changeLanguage = setLanguage;

/** -------- Auth -------- **/
async function requireSession(){
  const { data: { session: s }, error } = await sb.auth.getSession();
  if (error) console.warn(error);
  if (!s || !s.user) {
    // redirect to login with next
    window.location.replace("/login.html?next=/dashboard.html");
    throw new Error("No session");
  }
  session = s;
  uid = s.user.id;
  // header info
  const email = s.user.email || "user";
  $("#userEmail").textContent = email;
  $("#userAvatar").textContent = (email[0]||"U").toUpperCase();
}

/** -------- Country select (keep as-is, native search ok) -------- **/

/** -------- LocalStorage Mirror Helpers -------- **/
const LS_PROFILE = "myqer_profile";
const LS_HEALTH  = "myqer_health";
const LS_ICE     = "myqer_ice";
const LS_CODE    = "myqer_shortcode";

function getProfileFromUI(){
  return {
    full_name: $("#fullName").value.trim() || null,
    dob: $("#dob").value || null,
    country: $("#country").value || null,
    health_id: $("#healthId").value.trim() || null
  };
}
function setProfileToUI(p){
  $("#fullName").value = p?.full_name || "";
  $("#dob").value = p?.dob || "";
  $("#country").value = p?.country || "";
  $("#healthId").value = p?.health_id || "";
}
function getHealthFromUI(){
  return {
    blood_type: $("#bloodType").value || null,
    allergies: $("#allergies").value.trim() || null,
    organ_donor: $("#organDonor").checked,
    conditions: $("#conditions").value.trim() || null,
    medications: $("#medications").value.trim() || null,
    implants: $("#implants").value.trim() || null,
    triage_override: $("#triageOverride").value || "auto"
  };
}
function setHealthToUI(h){
  $("#bloodType").value = h?.blood_type || "";
  $("#allergies").value = h?.allergies || "";
  $("#conditions").value = h?.conditions || "";
  $("#medications").value = h?.medications || "";
  $("#implants").value = h?.implants || "";
  $("#organDonor").checked = !!h?.organ_donor;
  $("#triageOverride").value = h?.triage_override || "auto";
}

function saveLS(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadLS(key){
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch { return null; }
}

/** -------- Short Code (immutable once set) -------- **/
const CODE_CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // no I/O/0/1
function newShortCode(){
  let s=""; for (let i=0;i<8;i++) s += CODE_CHARS[Math.floor(Math.random()*CODE_CHARS.length)];
  return (s.slice(0,4)+"-"+s.slice(4)).toUpperCase();
}
async function ensureShortCode(){
  // prefer local cached
  let code = localStorage.getItem(LS_CODE);
  if (code && code.length===9) { userCode = code; return code; }
  // Try fetch profile.code
  try {
    const { data, error } = await sb.from("profiles").select("code").eq("id", uid).maybeSingle();
    if (!error && data && data.code) {
      userCode = data.code.toUpperCase();
      localStorage.setItem(LS_CODE, userCode);
      return userCode;
    }
  } catch (e) {}
  // Create and try to set if null on server
  code = newShortCode();
  userCode = code;
  localStorage.setItem(LS_CODE, code);
  try {
    const { error } = await sb.from("profiles")
      .update({ code })
      .eq("id", uid)
      .is("code", null);
    // If unique/immutable fails, read back again
    if (error) {
      const { data } = await sb.from("profiles").select("code").eq("id", uid).maybeSingle();
      if (data?.code) {
        userCode = data.code.toUpperCase();
        localStorage.setItem(LS_CODE, userCode);
      }
    }
  } catch(e){}
  return userCode;
}

/** -------- QR: Live + Offline Text -------- **/
async function renderLiveQR(){
  if (!userCode) return;
  const url = `https://www.myqer.com/c/${userCode}`;
  const box = $("#qrcode");
  box.innerHTML = "";
  try {
    await QRCode.toCanvas(box, url, { width: 240, margin: 1, errorCorrectionLevel: "M", color:{dark:"#0f172a", light:"#ffffff"} });
  } catch(e){
    console.error(e);
    toastRateLimited("error", tr("qr_fail"));
  }
  $("#qrCodeText").textContent = userCode;
  $("#cardUrl").value = url;
}

function offlinePayloadLines(profile, health, iceList){
  const name = profile?.full_name || "";
  const dob  = profile?.dob || "";
  const bt   = health?.blood_type || "";
  const allergies = health?.allergies?.trim() || "None reported";
  const conditions = health?.conditions?.trim() || "";
  const meds = health?.medications?.trim() || "";
  const implants = health?.implants?.trim() || "";
  const donor = health?.organ_donor ? "Yes" : "No";
  const url = `https://www.myqer.com/c/${userCode}`;

  const iceLines = [];
  for (let i=0;i<3;i++){
    const c = iceList[i];
    const nm = c?.name ? c.name : "";
    const ph = c?.phone ? c.phone : "";
    iceLines.push(`ICE${i+1}: ${nm}${(nm && ph)?" ‚Äî ":""}${ph}`);
  }

  const lines = [
    "MYQER‚Ñ¢ EMERGENCY CARD",
    `Code: ${userCode}`,
    `Name: ${name}`,
    `DOB: ${dob}`,
    `Blood: ${bt}`,
    `Allergies: ${allergies || "None reported"}`,
    `Conditions: ${conditions}`,
    `Meds: ${meds}`,
    `Implants: ${implants}`,
    `Donor: ${donor}`,
    iceLines[0],
    iceLines[1],
    iceLines[2],
    `URL: ${url}`
  ];
  return lines;
}

function shrinkText(txt, caps){ if (!txt) return ""; if (txt.length<=caps) return txt; return txt.slice(0, caps-1) + "‚Ä¶"; }

function compactOfflinePayload(profile, health, iceList){
  let L = offlinePayloadLines(profile, health, iceList);
  function asText(arr){ return arr.join("\n").trim(); }
  // Budget
  let payload = asText(L);
  let level = "M";
  const budgetM = 900, budgetL = 1100;
  const tryCompaction = () => {
    const b = textBytes(payload);
    if (b <= budgetM) { level="M"; return true; }
    if (b <= budgetL) { level="L"; return true; }
    return false;
  };
  if (tryCompaction()) return { text: payload, ecLevel: level };

  // Step 1: Trim whitespace (already trimmed)
  // Step 2: Shrink long fields
  const idx = {
    Allergies: L.findIndex(s=>s.startsWith("Allergies: ")),
    Conditions: L.findIndex(s=>s.startsWith("Conditions: ")),
    Meds: L.findIndex(s=>s.startsWith("Meds: ")),
    Implants: L.findIndex(s=>s.startsWith("Implants: "))
  };
  const shrinkPlan = [
    ["Allergies", [220,160,120]],
    ["Conditions", [300,180,120]],
    ["Meds", [300,180,120]],
    ["Implants", [220,160,120]]
  ];
  for (const [key, capsList] of shrinkPlan){
    const i = idx[key];
    if (i>=0){
      const base = L[i].split(": ")[0] + ": ";
      let value = L[i].slice(base.length);
      for (const cap of capsList){
        value = shrinkText(value, cap);
        L[i] = base + value;
        payload = asText(L);
        if (tryCompaction()) return { text: payload, ecLevel: level };
      }
    }
  }
  // Step 3: Drop fields in order
  const dropOrder = ["Implants", "Meds", "Conditions", "ICE3", "ICE2", "ICE1"];
  for (const what of dropOrder){
    if (what.startsWith("ICE")){
      const n = Number(what.slice(3));
      const idxICE = L.findIndex(s=>s.startsWith(`ICE${n}:`));
      if (idxICE>=0){ L.splice(idxICE,1); }
    } else {
      const i = L.findIndex(s=>s.startsWith(`${what}:`));
      if (i>=0){ L.splice(i,1); }
    }
    payload = asText(L);
    if (tryCompaction()) return { text: payload, ecLevel: level };
  }
  // Step 4: Shorten URL domain
  const urlIdx = L.findIndex(s=>s.startsWith("URL: "));
  if (urlIdx>=0) L[urlIdx] = L[urlIdx].replace("https://www.myqer.com", "myqer.com");
  payload = asText(L);
  if (tryCompaction()) return { text: payload, ecLevel: level };

  // Final minimal set
  const minimal = [];
  const pull = (prefix, fallback="")=>{
    const i = L.findIndex(s=>s.startsWith(prefix));
    return i>=0 ? L[i] : (fallback?`${prefix}${fallback}`:null);
  };
  const M = [
    "MYQER‚Ñ¢ EMERGENCY CARD",
    pull("Code: "),
    pull("Name: "),
    pull("DOB: "),
    pull("Blood: "),
    pull("Allergies: "),
    pull("Donor: "),
    pull("ICE1: ", " "),
    pull("URL: ")
  ].filter(Boolean);
  payload = asText(M);
  level="L";
  return { text: payload, ecLevel: level };
}

async function renderOfflineQR(){
  // Create container dynamically under the live QR section if not present
  let wrap = document.getElementById("offlineQRwrap");
  if (!wrap){
    const qc = document.querySelector(".qr-container");
    wrap = document.createElement("div");
    wrap.id = "offlineQRwrap";
    wrap.style.marginTop = "16px";
    wrap.style.display = "flex";
    wrap.style.flexDirection = "column";
    wrap.style.alignItems = "center";
    wrap.innerHTML = `
      <div id="offlineQRbox" class="qr-box" style="margin-top:8px;">
        <div id="offlineQR"></div>
      </div>
      <div class="qr-label" style="margin-top:8px;">${tr("offline_qr_label")}</div>
    `;
    qc.appendChild(wrap);
  }
  const profile = getProfileFromUI();
  const health = getHealthFromUI();
  const { text, ecLevel } = compactOfflinePayload(profile, health, iceContacts);
  const node = $("#offlineQR");
  node.innerHTML = "";
  await QRCode.toCanvas(node, text, { width: 240, margin: 1, errorCorrectionLevel: ecLevel, color:{dark:"#0f172a", light:"#ffffff"} });
  $("#qrStatus")?.remove(); // compatibility if existed
}

async function refreshQRCodes(){
  await renderLiveQR();
  await renderOfflineQR();
  toastRateLimited("success", tr("qr_ready"));
}

/** -------- Triage -------- **/
const TRIAGE_WEIGHTS = [
  {kw: ["anaphylaxis","epi pen","epipen","epinephrine"], pts: 3},
  {kw: ["cardiac arrest","vfib","vtach","myocardial infarction","heart attack","mi"], pts: 4},
  {kw: ["stroke","cva"], pts: 3},
  {kw: ["severe asthma","status asthmaticus","respiratory failure","copd exacerbation"], pts: 3},
  {kw: ["transplant","immunosuppression"], pts: 3},
  {kw: ["warfarin","anticoagulant","apixaban","rivaroxaban","clopidogrel"], pts: 2},
  {kw: ["pacemaker","icd","defibrillator"], pts: 2}
];
function triageScore(){
  const t = [$("#allergies").value, $("#conditions").value, $("#medications").value].join(" ").toLowerCase();
  let score = 0;
  TRIAGE_WEIGHTS.forEach(rule=>{
    if (rule.kw.some(k=>t.includes(k))) score += rule.pts;
  });
  return score;
}
function updateTriage(){
  const override = $("#triageOverride").value;
  const pill = $("#triagePill");
  const label = pill.querySelector("span");
  if (override !== "auto"){
    pill.className = `triage-pill triage-${override}`;
    label.textContent = tr(override);
    return;
  }
  const s = triageScore();
  let color = "green";
  if (s >= 6) color = "red";
  else if (s >= 3) color = "amber";
  pill.className = `triage-pill triage-${color}`;
  label.textContent = tr(color);
}
window.updateTriage = updateTriage;

/** -------- ICE Contacts UI -------- **/
function renderICE(){
  const container = $("#iceContacts");
  if (!iceContacts.length){
    container.innerHTML = `
      <div class="no-contacts">
        <div class="no-contacts-icon"><i class="fas fa-address-book"></i></div>
        <div data-i18n="no_contacts">${tr("no_contacts")}</div>
      </div>`;
    updateAddContactBtn();
    return;
  }
  container.innerHTML = iceContacts.map((c,i)=>`
    <div class="ice-contact">
      <div class="ice-contact-header">
        <h4 class="ice-contact-title">
          <div class="ice-contact-number">${i+1}</div>
          ${tr("ice_title")} #${i+1}
        </h4>
        <button class="btn btn-danger btn-sm" onclick="removeContact('${c.id}')">
          <i class="fas fa-trash"></i><span data-i18n="remove">${tr("remove")}</span>
        </button>
      </div>
      <div class="ice-grid">
        <div class="form-group">
          <label class="form-label" data-i18n="contact_name">${tr("contact_name")}</label>
          <input type="text" class="form-input" value="${c.name||""}" placeholder="Full name"
            onchange="updateContact('${c.id}','name',this.value)">
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="contact_relationship">${tr("contact_relationship")}</label>
          <input type="text" class="form-input" value="${c.relation||""}" placeholder="e.g., Spouse"
            onchange="updateContact('${c.id}','relation',this.value)">
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="contact_phone">${tr("contact_phone")}</label>
          <input type="tel" class="form-input" value="${c.phone||""}" placeholder="+1 555 123 4567"
            onchange="updateContact('${c.id}','phone',this.value)">
        </div>
      </div>
    </div>
  `).join("");
  updateAddContactBtn();
}
function addContact(){
  if (iceContacts.length >= 3) { toastRateLimited("error", tr("max_contacts")); return; }
  iceContacts.push({ id: String(Date.now()), name:"", relation:"", phone:"" });
  renderICE();
  saveLS(LS_ICE, iceContacts);
}
function removeContact(id){
  iceContacts = iceContacts.filter(x=>x.id!==id);
  renderICE();
  saveLS(LS_ICE, iceContacts);
}
function updateContact(id, field, value){
  const c = iceContacts.find(x=>x.id===id);
  if (c){ c[field] = value; saveLS(LS_ICE, iceContacts); }
}
function updateAddContactBtn(){
  const btn = $("#addContactBtn");
  if (!btn) return;
  if (iceContacts.length >= 3) {
    btn.disabled = true; btn.innerHTML = `<i class="fas fa-ban"></i> <span>${tr("max_contacts")}</span>`;
  } else {
    btn.disabled = false; btn.innerHTML = `<i class="fas fa-plus"></i> <span data-i18n="add_contact">${tr("add_contact")}</span>`;
  }
}
window.addContact = addContact;
window.removeContact = removeContact;
window.updateContact = updateContact;

/** -------- Clipboard / Open / Download / Print -------- **/
async function copyUrl(){
  const url = $("#cardUrl").value;
  try {
    if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(url);
    else { const i=$("#cardUrl"); i.select(); document.execCommand("copy"); }
    showToast(tr("url_copied"), "success");
  } catch(e){ toastRateLimited("error", tr("network_error")); }
}
function openUrl(){ window.open($("#cardUrl").value, "_blank"); }
async function downloadQR(fmt){
  // Download OFFLINE QR PNG as requested spec
  const canvas = $("#offlineQR canvas") || $("#qrcode canvas");
  if (!canvas){ toastRateLimited("error", tr("qr_fail")); return; }
  if (fmt==="png"){
    const link = document.createElement("a");
    link.download = `myqer-${userCode||"card"}-offline.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
    showToast(tr("offline_qr_downloaded"), "success");
  } else if (fmt==="svg"){
    // Build SVG from offline payload
    const profile = getProfileFromUI(), health = getHealthFromUI();
    const { text, ecLevel } = compactOfflinePayload(profile, health, iceContacts);
    const svg = await QRCode.toString(text, { type:"svg", errorCorrectionLevel: ecLevel });
    const url = URL.createObjectURL(new Blob([svg], {type:"image/svg+xml"}));
    const a = document.createElement("a");
    a.href = url; a.download = `myqer-${userCode||"card"}-offline.svg`; a.click();
    URL.revokeObjectURL(url);
    showToast(tr("qr_downloaded"), "success");
  }
}
function printQR(){
  // Print Live QR with some details
  const canvas = $("#qrcode canvas");
  if (!canvas){ toastRateLimited("error", tr("qr_fail")); return; }
  const code = userCode || $("#qrCodeText").textContent;
  const url = $("#cardUrl").value;
  const win = window.open("", "_blank");
  win.document.write(`
  <!doctype html><html><head><title>MYQER Emergency Card - ${code}</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;text-align:center;padding:40px;background:#fff}
    .card{border:3px solid #dc2626;border-radius:20px;padding:40px;max-width:520px;margin:0 auto;background:#fff}
    .logo{font-size:32px;font-weight:900;color:#dc2626;margin-bottom:20px;letter-spacing:2px}
    .code{font-family:Monaco,monospace;font-size:24px;font-weight:900;margin:20px 0;letter-spacing:3px}
    .url{font-size:14px;color:#444;word-break:break-all;margin-top:10px;font-family:Monaco,monospace}
    .qr{margin:24px 0}
    .lbl{font-size:12px;color:#dc2626;font-weight:700;letter-spacing:2px;text-transform:uppercase}
  </style></head><body>
  <div class="card">
    <div class="logo">MYQER‚Ñ¢ EMERGENCY CARD</div>
    <div class="lbl">${tr("live_qr_label")}</div>
    <div class="qr"><img src="${canvas.toDataURL("image/png")}" style="width:250px;height:250px;border:2px solid #eee;border-radius:12px"/></div>
    <div class="code">${code}</div>
    <div class="url">${url}</div>
  </div></body></html>`);
  win.document.close(); win.print();
}
window.copyUrl = copyUrl;
window.openUrl = openUrl;
window.downloadQR = downloadQR;
window.printQR = printQR;

/** -------- Autosave (debounced 600ms) -------- **/
function debounce(fn, key, wait=600){
  return function(...args){
    clearTimeout(debounceTimers[key]);
    debounceTimers[key] = setTimeout(()=>fn.apply(this,args), wait);
  };
}
const autosaveProfile = debounce(async ()=>{
  await saveProfile(true);
}, "profile", 600);
const autosaveHealth = debounce(async ()=>{
  await saveHealth(true);
}, "health", 600);

/** -------- Save / Upserts -------- **/
async function saveProfile(isAuto=false){
  const p = getProfileFromUI();
  if (!p.full_name){ if (!isAuto) showToast(tr("validation_error"), "error"); return; }
  try {
    showSaving();
    // local mirror
    saveLS(LS_PROFILE, p);
    // server upsert
    const up = { id: uid, full_name: p.full_name, dob: p.dob, country: p.country, health_id: p.health_id };
    const { error } = await sb.from("profiles").upsert(up, { onConflict: "id" });
    if (error) { console.warn(error); toastRateLimited("error", tr("schema_warn")); }
    await ensureShortCode(); // make sure code exists
    await refreshQRCodes();
    hideSaving();
    if (isAuto) toastRateLimited("success", tr("auto_saved"));
    else showToast(tr("profile_saved"), "success");
  } catch(e){
    console.error(e);
    hideSaving();
    if (isAuto) toastRateLimited("error", tr("save_error"));
    else showToast(tr("save_error"), "error");
  }
}
async function saveHealth(isAuto=false){
  const h = getHealthFromUI();
  try {
    showSaving();
    saveLS(LS_HEALTH, h);
    const up = { user_id: uid, blood_type:h.blood_type, allergies:h.allergies, organ_donor:h.organ_donor, conditions:h.conditions, medications:h.medications, implants:h.implants, triage_override:h.triage_override };
    const { error } = await sb.from("health_data").upsert(up, { onConflict: "user_id" });
    if (error) { console.warn(error); toastRateLimited("error", tr("schema_warn")); }
    updateTriage();
    await refreshQRCodes();
    hideSaving();
    if (isAuto) toastRateLimited("success", tr("auto_saved"));
    else showToast(tr("health_saved"), "success");
  } catch(e){
    console.error(e);
    hideSaving();
    if (isAuto) toastRateLimited("error", tr("save_error"));
    else showToast(tr("save_error"), "error");
  }
}
async function saveICE(){
  try {
    showSaving();
    saveLS(LS_ICE, iceContacts);
    // Upsert up to 3 rows with composite key (user_id, contact_order)
    const rows = iceContacts.slice(0,3).map((c,idx)=>({ user_id: uid, contact_order: idx, name: (c.name||null), relation: (c.relation||null), phone: (c.phone||null) }));
    // We will replace: easiest is delete then upsert rows present to avoid ghosts
    const { error: delErr } = await sb.from("ice_contacts").delete().eq("user_id", uid);
    if (delErr) console.warn(delErr);
    if (rows.length){
      const { error: upErr } = await sb.from("ice_contacts").upsert(rows, { onConflict: "user_id,contact_order" });
      if (upErr) console.warn(upErr);
    }
    await refreshQRCodes();
    hideSaving();
    showToast(tr("ice_saved"), "success");
  } catch(e){
    console.error(e);
    hideSaving();
    showToast(tr("save_error"), "error");
  }
}
window.saveProfile = ()=>saveProfile(false);
window.saveHealth = ()=>saveHealth(false);
window.saveICE = saveICE;

/** -------- Load flow -------- **/
async function loadFromLocalFirst(){
  const p = loadLS(LS_PROFILE); if (p) setProfileToUI(p);
  const h = loadLS(LS_HEALTH);  if (h) setHealthToUI(h);
  const ic = loadLS(LS_ICE);    if (ic) iceContacts = ic;
  else iceContacts = [];
  renderICE();
  updateTriage();
  // code
  const c = localStorage.getItem(LS_CODE); if (c) userCode = c;
  await renderLiveQR();
  await renderOfflineQR();
}

async function fetchServerData(){
  try{
    // profiles
    const { data: prof, error: e1 } = await sb.from("profiles").select("full_name,dob,country,health_id,code").eq("id", uid).maybeSingle();
    if (!e1 && prof){
      setProfileToUI(prof);
      if (prof.code){ userCode = prof.code.toUpperCase(); localStorage.setItem(LS_CODE, userCode); }
      saveLS(LS_PROFILE, getProfileFromUI());
    } else if (e1) console.warn(e1);
  }catch(e){ console.warn(e); }
  try{
    // health
    const { data: h, error: e2 } = await sb.from("health_data").select("blood_type,allergies,organ_donor,conditions,medications,implants,triage_override").eq("user_id", uid).maybeSingle();
    if (!e2 && h){ setHealthToUI(h); saveLS(LS_HEALTH, h); }
    else if (e2) console.warn(e2);
  }catch(e){ console.warn(e); }
  try{
    // ice
    const { data: rows, error: e3 } = await sb.from("ice_contacts").select("contact_order,name,relation,phone").eq("user_id", uid).order("contact_order", {ascending:true});
    if (!e3 && rows){ iceContacts = rows.map(r=>({ id: String(Date.now())+"-"+r.contact_order, name:r.name, relation:r.relation, phone:r.phone })); saveLS(LS_ICE, iceContacts); }
    else if (e3) console.warn(e3);
  }catch(e){ console.warn(e); }
  // ensure code
  await ensureShortCode();
  setCardUrl();
  renderICE();
  updateTriage();
  await refreshQRCodes();
}
function setCardUrl(){
  if (userCode){ $("#qrCodeText").textContent = userCode; $("#cardUrl").value = `https://www.myqer.com/c/${userCode}`; }
}

/** -------- Idle Modal -------- **/
function setupIdleTimer(){
  const IDLE_MS = 30*60*1000, WARN_MS = 60*1000;
  let idleTimer, warnTimer, cdTimer, secs=60;
  function reset(){
    clearTimeout(idleTimer); clearTimeout(warnTimer); clearInterval(cdTimer);
    $("#idleModal").classList.remove("show");
    idleTimer = setTimeout(()=>{
      $("#idleModal").classList.add("show");
      secs=60; $("#countdown").textContent = secs;
      cdTimer = setInterval(()=>{ secs--; $("#countdown").textContent = secs; if (secs<=0){ logout(); } }, 1000);
      warnTimer = setTimeout(()=>logout(), WARN_MS);
    }, IDLE_MS - WARN_MS);
  }
  window.resetIdleTimer = reset;
  ["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach(ev=>document.addEventListener(ev, reset, true));
  reset();
}

/** -------- Logout / Delete -------- **/
async function logout(){
  try{
    await sb.auth.signOut();
  }catch(e){}
  try{
    localStorage.clear(); sessionStorage.clear();
  }catch(e){}
  showToast(tr("logout_ok"), "success");
  window.location.replace("/");
}
window.logout = logout;

async function deleteAccount(){
  const confirmText = $("#deleteConfirm").value;
  if (confirmText !== "DELETE MY ACCOUNT"){ showToast(tr("confirm_delete"), "error"); return; }
  try{
    showSaving();
    // delete children first
    await sb.from("ice_contacts").delete().eq("user_id", uid);
    await sb.from("health_data").delete().eq("user_id", uid);
    await sb.from("profiles").delete().eq("id", uid);
    await sb.auth.signOut();
    localStorage.clear(); sessionStorage.clear();
    showToast(tr("account_deleted"), "success");
    setTimeout(()=>window.location.replace("/"), 900);
  } catch(e){
    console.error(e);
    showToast(tr("save_error"), "error");
  } finally { hideSaving(); }
}
window.deleteAccount = deleteAccount;

/** -------- Events / Wiring -------- **/
function setupInputs(){
  // Autosave
  ["fullName","dob","country","healthId"].forEach(id=>{
    const el = document.getElementById(id); if (!el) return;
    el.addEventListener("input", ()=> autosaveProfile());
  });
  ["bloodType","allergies","conditions","medications","implants","triageOverride"].forEach(id=>{
    const el = document.getElementById(id); if (!el) return;
    el.addEventListener("input", ()=> autosaveHealth());
    el.addEventListener("change", updateTriage);
  });
  $("#organDonor")?.addEventListener("change", ()=> autosaveHealth());
  // Keyboard shortcuts
  document.addEventListener("keydown", e=>{
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){ e.preventDefault(); saveProfile(false); }
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="q"){ e.preventDefault(); refreshQRCodes(); }
  });
}

/** -------- Init -------- **/
async function init(){
  const loader = $("#loadingScreen");
  const main = $("#dashboard");
  // language
  const savedLang = localStorage.getItem("myqer_language");
  setLanguage(savedLang || (navigator.language||"en").slice(0,2));
  applyTranslations();
  setupOnlineBanner();
  setupInputs();
  try{
    await requireSession();
  } catch { // redirect already handled
    return;
  }
  // Load flow: local first, then server (server wins)
  await loadFromLocalFirst();
  await fetchServerData();

  // Show UI
  setTimeout(()=>{
    loader.classList.add("hidden");
    main.classList.remove("hidden");
  }, 300);

  setupIdleTimer();

  // Wire buttons already in HTML
  window.generateQRCode = async ()=>{ // keep button but do NOT change code (immutable); just re-render
    await refreshQRCodes();
  };

  // Initial QR render done
}

/** -------- Expose save buttons to HTML (already hooked via onclick) -------- **/
window.saveProfile = ()=>saveProfile(false);
window.saveHealth  = ()=>saveHealth(false);
window.saveICE     = saveICE;

/** -------- Start -------- **/
document.addEventListener("DOMContentLoaded", init);
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b0788e409fef1b',t:'MTc1NzE4Nzk3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
