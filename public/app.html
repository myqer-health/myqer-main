<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER â€” Dashboard</title>

  <!-- PWA -->
  <link rel="manifest" href="/myqer_manifest.json" />
  <meta name="theme-color" content="#c62828" />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/images/icon-192.png" />
  <link rel="apple-touch-icon" href="/images/icon-192.png" />

  <!-- Dashboard stylesheet -->
  <link rel="stylesheet" href="/styles/app.css" />
</head>
<body class="app-page">
  <header class="app-header" role="banner">
    <a class="brand" href="/" aria-label="MYQER Home">
      <span>MYQ</span><span class="er">ER</span><sup>â„¢</sup>
    </a>

    <div class="header-actions">
      <label for="langSel" class="visually-hidden">Language</label>
      <select id="langSel" data-lang-picker class="pill" aria-label="Language"></select>
      <button id="logout" class="pill ghost">Logout</button>
    </div>
  </header>

  <main class="app-wrap" role="main">
    <!-- Personal Info -->
    <section class="card section" aria-labelledby="personalSection">
      <div class="card-head">
        <h2 id="personalSection">Personal info</h2>
        <div class="triage">
          <span class="label">Triage</span>
          <span id="triageBadge" class="badge" data-color="green">Green</span>
        </div>
      </div>

      <div class="field">
        <label for="full_name">Full name</label>
        <input id="full_name" autocomplete="name" />
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="dob">Date of birth</label>
          <input id="dob" type="date" />
        </div>
        <div class="field">
          <label for="country">Country</label>
          <input id="country" autocomplete="country-name" />
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="blood_type">Blood type</label>
          <select id="blood_type">
            <option value=""></option><option>A+</option><option>A-</option><option>B+</option><option>B-</option>
            <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
          </select>
        </div>
        <div class="field">
          <label for="national_id">Health/National ID (optional)</label>
          <input id="national_id" />
        </div>
      </div>

      <div class="grid-2">
        <label class="check">
          <input id="organ_donor" type="checkbox" />
          <span>Organ donor</span>
        </label>

        <div class="field">
          <label for="life_support_preference">Life support preference</label>
          <input id="life_support_preference" placeholder="DNR / Full / Limited" />
        </div>
      </div>

      <div class="field">
        <label for="triage_override">Manual triage override</label>
        <select id="triage_override">
          <option value="">â€”</option>
          <option value="green">Green</option>
          <option value="yellow">Yellow</option>
          <option value="red">Red</option>
          <option value="black">Black</option>
        </select>
      </div>
    </section>

    <!-- Health -->
    <section class="card section" aria-labelledby="healthSection">
      <div class="card-head">
        <h2 id="healthSection">Health profile</h2>
      </div>

      <div class="field critical">
        <label for="allergies">Allergies</label>
        <textarea id="allergies" rows="2" placeholder="commaâ€‘separated"></textarea>
      </div>

      <div class="field warning">
        <label for="conditions">Conditions</label>
        <textarea id="conditions" rows="2" placeholder="commaâ€‘separated"></textarea>
      </div>

      <div class="field">
        <label for="medications">Medications</label>
        <textarea id="medications" rows="2" placeholder="commaâ€‘separated"></textarea>
      </div>

      <div class="field">
        <label for="implants">Implants / devices</label>
        <input id="implants" placeholder="e.g., pacemaker, insulin pump" />
      </div>

      <div class="field">
        <label for="notes">Clinical notes</label>
        <textarea id="notes" rows="3" placeholder="short, plain language notes"></textarea>
      </div>
    </section>

    <!-- ICE -->
    <section class="card section" aria-labelledby="iceSection">
      <div class="card-head">
        <h2 id="iceSection">ICE contacts</h2>
        <small class="muted">Up to 3 contacts</small>
      </div>

      <div id="iceList" class="ice-list"></div>

      <button id="addIce" class="btn primary" type="button">Add contact</button>

      <!-- âœ¨ Template used by the UI helper below (no backend required) -->
      <template id="iceRowTpl">
        <div class="ice-row" data-demo="true">
          <input class="ice-name" placeholder="Name" />
          <input class="ice-rel"  placeholder="Relationship" />
          <input class="ice-phone" placeholder="Phone" inputmode="tel" />
          <button class="del" type="button" aria-label="Remove contact">âœ•</button>
        </div>
      </template>
    </section>

    <!-- QR -->
    <section class="card section" aria-labelledby="qrSection">
      <div class="card-head">
        <h2 id="qrSection">QR Emergency Card</h2>
      </div>

      <div id="qr" class="qr-box">
        <!-- QR renders here -->
      </div>

      <div class="row">
        <button id="btnRegenQR" class="btn primary" type="button">Generate / Regenerate QR</button>
        <a id="cardLink" class="btn ghost" href="#" target="_blank" rel="noopener">Open public card</a>
      </div>

      <p class="tiny muted">Your card and voice can be cached to this device for offline access.</p>
    </section>

    <!-- Backend Hooks (dev tools) -->
    <section class="card section" aria-labelledby="backendSection">
      <div class="card-head">
        <h2 id="backendSection">Backend actions</h2>
      </div>

      <div class="row wrap">
        <button id="btnBuildVoice" class="btn" type="button">Build Voice (TTS)</button>
        <button id="btnPreviewResponder" class="btn" type="button">Preview Responder JSON</button>
      </div>

      <div id="voiceWrap"></div>
      <pre id="previewOut" class="code-box" aria-live="polite"></pre>
    </section>
  </main>

  <footer class="app-footer">
    <ul class="badges">
      <li>GDPR</li><li>HIPAAâ€‘ready</li><li>Zero tracking</li><li>Onâ€‘device privacy</li>
    </ul>
    <p>Â© 2025 MYQER â€” Emergency Response QR</p>
  </footer>

  <!-- Scripts: your existing logic -->
  <script type="module" src="/scripts/config.js"></script>
  <script type="module" src="/scripts/app.js"></script>
  <script type="module" src="/scripts/backend_hooks.js"></script>

  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/myqer_service_worker.js');
    }
  </script>

  <!-- ðŸ”¸ UIâ€‘only helper for ICE list (runs only when list is empty).
       This is safe alongside your future Supabase logic. -->
  <script>
    (function () {
      const list = document.getElementById('iceList');
      const addBtn = document.getElementById('addIce');
      const tpl = document.getElementById('iceRowTpl');

      if (!list || !addBtn || !tpl) return;

      function countRows(){ return list.querySelectorAll('.ice-row').length; }
      function updateAddState(){ addBtn.disabled = countRows() >= 3; }

      function wireRow(row){
        const del = row.querySelector('.del');
        del?.addEventListener('click', () => {
          row.remove();
          updateAddState();
        });
      }

      // Only run this demo helper if the list is empty after the page loads.
      // (Prevents clashing with your real Supabase render later.)
      if (countRows() === 0) {
        addBtn.addEventListener('click', () => {
          if (countRows() >= 3) return;
          const node = tpl.content.firstElementChild.cloneNode(true);
          list.appendChild(node);
          wireRow(node);
          updateAddState();
        });
        updateAddState();
      }
    })();
  </script>

  <!-- Logout (unchanged logic) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/scripts/config.js';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    document.getElementById('logout')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.replace('/login.html');
    });
  </script>
</body>
</html>
