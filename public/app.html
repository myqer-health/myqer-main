<!doctype html>
<html lang="en">
<head>
  <style>
  html.auth-checking body { visibility:hidden }
  html.auth-ready body { visibility:visible }
</style>
<script>
  document.documentElement.classList.add('auth-checking');
  // quick pre-check: if there is clearly no Supabase token, bounce before paint
  (function () {
    var key = 'sb-tgddpmxpbgrzrbzpomou-auth-token'; // ← your project ref
    if (!localStorage.getItem(key)) {
      var returnTo = encodeURIComponent('/app.html');
      location.replace('/login.html?redirect=' + returnTo);
    }
  })();
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYQER — Dashboard</title>
<!-- No‑flash auth guard -->
  /* Hide the whole page until we confirm auth */
  html.auth-checking body { visibility: hidden; }
  html.auth-ready body   { visibility: visible; }
  <link rel="stylesheet" href="/styles/app.css" />
</head>
<body class="app-page">

  <!-- ===== Header ===== -->
  <header class="app-header" role="banner">
    <a class="brand" href="/" aria-label="MYQER Home">
      <span>MYQ</span><span class="er">ER</span><sup>™</sup>
    </a>

    <div class="header-actions">
      <label for="langSel" class="tiny" style="color:#6b7280">Language</label>
      <select id="langSel" data-lang-picker class="pill" aria-label="Language"></select>
      <button id="logout" class="pill">Logout</button>
    </div>
  </header>

  <!-- ===== Content grid ===== -->
  <main class="app-wrap" role="main">

    <!-- Personal info -->
    <section class="card" aria-labelledby="secPersonal">
      <h2 id="secPersonal">Personal info</h2>

      <div class="triage" aria-live="polite" style="margin-bottom:8px">
        <span class="label">Triage</span>
        <span id="triageBadge" class="badge" data-color="green">Green</span>
      </div>

      <div class="field">
        <label for="full_name">Full name</label>
        <input id="full_name" autocomplete="name" />
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="dob">Date of birth</label>
          <input id="dob" type="date" />
        </div>
        <div class="field">
          <label for="country">Country</label>
          <input id="country" autocomplete="country-name" />
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="blood_type">Blood type</label>
          <select id="blood_type" class="field">
            <option value=""></option><option>A+</option><option>A-</option>
            <option>B+</option><option>B-</option><option>AB+</option>
            <option>AB-</option><option>O+</option><option>O-</option>
          </select>
        </div>
        <div class="field">
          <label for="national_id">Health/National ID (optional)</label>
          <input id="national_id" />
        </div>
      </div>

      <div class="check">
        <input id="organ_donor" type="checkbox" />
        <label for="organ_donor" style="margin:0">Organ donor</label>
      </div>

      <div class="field">
        <label for="life_support_preference">Life support preference</label>
        <input id="life_support_preference" placeholder="DNR / Full / Limited" />
      </div>

      <div class="field">
        <label for="triage_override">Manual triage override</label>
        <select id="triage_override" class="field">
          <option value="">—</option>
          <option value="red">Red</option>
          <option value="amber">Amber</option>
          <option value="green">Green</option>
          <option value="blue">Blue</option>
        </select>
      </div>
    </section>

    <!-- Health profile -->
    <section class="card" aria-labelledby="secHealth">
      <h2 id="secHealth">Health profile</h2>

      <div class="field critical">
        <label for="allergies">Allergies</label>
        <textarea id="allergies" rows="2" placeholder="comma-separated"></textarea>
      </div>

      <div class="field critical">
        <label for="conditions">Conditions</label>
        <textarea id="conditions" rows="2" placeholder="comma-separated"></textarea>
      </div>

      <div class="field critical">
        <label for="medications">Medications</label>
        <textarea id="medications" rows="2" placeholder="comma-separated"></textarea>
      </div>

      <div class="field">
        <label for="implants">Implants / devices</label>
        <textarea id="implants" rows="2" placeholder="e.g. pacemaker, insulin pump"></textarea>
      </div>

      <div class="field">
        <label for="notes">Clinical notes</label>
        <textarea id="notes" rows="3" placeholder="e.g. needs interpreter, has service dog"></textarea>
      </div>
    </section>

    <!-- ICE contacts -->
    <section class="card" aria-labelledby="secICE">
      <h2 id="secICE">ICE Contacts</h2>

      <div id="iceList" class="ice-list"><!-- rows injected by JS --></div>

      <button id="addIce" class="btn primary" type="button">Add contact</button>
      <p class="tiny muted" style="margin-top:6px">Add up to 3 contacts (Name, relationship, phone).</p>
    </section>

    <!-- Preferences / reference-only -->
    <section class="card" aria-labelledby="secPrefs">
      <h2 id="secPrefs">Critical preferences</h2>

      <div class="grid-2">
        <div class="field">
          <label for="pref_care">Care preference (reference only)</label>
          <select id="pref_care" class="field">
            <option value=""></option>
            <option value="full">All resuscitation efforts (Full)</option>
            <option value="dnr">Do not resuscitate (DNR)</option>
            <option value="comfort">Comfort‑focused care only</option>
          </select>
        </div>
        <div class="field">
          <label for="pref_burial">Cremation / Burial (optional)</label>
          <select id="pref_burial" class="field">
            <option value=""></option>
            <option value="cremation">Cremation</option>
            <option value="burial">Burial</option>
          </select>
        </div>
      </div>

      <p class="tiny muted" style="margin-top:6px">
        These preferences are informational only. Clinicians must confirm with official medical documents.
      </p>
    </section>

    <!-- QR & offline -->
    <section class="card" aria-labelledby="secQR">
      <h2 id="secQR">QR Emergency Card</h2>

      <div id="qr" class="qr-box"><!-- QR injected here --></div>

      <div class="row wrap">
        <a id="cardLink" class="btn" href="#" target="_blank" rel="noopener">Open read‑only card</a>
        <button id="btnRegenQR" class="btn">Regenerate QR</button>
      </div>

      <p class="tiny muted" style="margin-top:8px">
        Works offline: your emergency card is cached on this device.
      </p>
    </section>

    <!-- Backend / dev tools (optional, IDs preserved) -->
    <section class="card" aria-labelledby="secBackend">
      <h2 id="secBackend">Backend Actions</h2>
      <div id="voiceWrap"></div>

      <div class="row wrap" style="margin-bottom:8px">
        <button id="btnBuildVoice" class="btn">Build Voice (TTS)</button>
        <button id="btnPreviewResponder" class="btn">Preview Responder JSON</button>
      </div>

      <pre id="previewOut" class="code-box" aria-live="polite"></pre>
    </section>

  </main>

  <footer class="app-footer" role="contentinfo">
    <ul class="badges">
      <li>GDPR Compliant</li>
      <li>HIPAA Ready</li>
      <li>Zero Tracking</li>
      <li>On‑Device Privacy</li>
    </ul>
    <div class="tiny muted">© 2025 MYQER — My QR for Emergency Response</div>
  </footer>

  <!-- ===== Scripts ===== -->
  <script>
    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/myqer_service_worker.js');
    }
  </script>

  <!-- App modules -->
  <script type="module" src="/scripts/config.js"></script>
  <script type="module" src="/scripts/app.js"></script>
  <script type="module" src="/scripts/backend_hooks.js"></script>
  <script type="module">
  import { requireAuth, signOutToLogin, supabase, q } from '/scripts/auth.js';

  // Gate the page
  const session = await requireAuth();

  // Wire Logout (top-right)
  const btn = document.getElementById('logout');
  if (btn) btn.addEventListener('click', signOutToLogin);

  // (Optional) use the authed user id/email anywhere you need:
  const user = session.user;
  // e.g., q('#full_name').value = user.user_metadata?.full_name || '';
</script>

  <!-- Lightweight logout (Supabase) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/scripts/config.js';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const btn = document.getElementById('logout');
    if (btn) btn.addEventListener('click', async () => {
      try { await supabase.auth.signOut(); } catch(e) {}
      location.replace('/login.html');
    });
  </script>
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/scripts/config.js';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 1) Hard gate before rendering anything sensitive
  const { data: { session } } = await supabase.auth.getSession();
  const returnTo = encodeURIComponent('/app.html');
  if (!session) {
    location.replace(`/login.html?redirect=${returnTo}`);
  }

  // 2) If the user logs out in another tab, kick them back to login
  supabase.auth.onAuthStateChange((_event, sess) => {
    if (!sess) location.replace(`/login.html?redirect=${returnTo}`);
  });

  // 3) Optional: wire the “Logout” button if present
  const logoutBtn = document.getElementById('logout');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.replace(`/login.html?redirect=${returnTo}`);
    });
  }
</script>
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from '/scripts/config.js';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const returnTo = encodeURIComponent('/app.html');

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) { location.replace(`/login.html?redirect=${returnTo}`); }
  else {
    document.documentElement.classList.remove('auth-checking');
    document.documentElement.classList.add('auth-ready');
  }

  supabase.auth.onAuthStateChange((_e, sess)=>{
    if (!sess) location.replace(`/login.html?redirect=${returnTo}`);
  });

  document.getElementById('logout')?.addEventListener('click', async ()=>{
    await supabase.auth.signOut();
    location.replace(`/login.html?redirect=${returnTo}`);
  });
</script>
</body>
</html>
